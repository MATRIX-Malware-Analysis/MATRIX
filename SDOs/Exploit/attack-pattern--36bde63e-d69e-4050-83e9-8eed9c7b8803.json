{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--36bde63e-d69e-4050-83e9-8eed9c7b8803",
    "created": "2024-08-14T16:28:47.722887Z",
    "modified": "2024-08-14T16:28:47.72289Z",
    "name": "Ruby on Rails XML Processor YAML Deserialization Scanner",
    "description": " This module attempts to identify Ruby on Rails instances vulnerable to an arbitrary object instantiation flaw in the XML request processor. ",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/auxiliary/scanner/http/rails_xml_yaml_scanner.rb",
            "external_id": "rails_xml_yaml_scanner.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2013-0156"
        },
        {
            "source_name": "reference",
            "url": "https://www.rapid7.com/blog/post/2013/01/09/serialization-mischief-in-ruby-land-cve-2013-0156/"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Auxiliary\n  include Msf::Exploit::Remote::HttpClient\n  include Msf::Auxiliary::Scanner\n\n  def initialize(info={})\n    super(update_info(info,\n      'Name'        => 'Ruby on Rails XML Processor YAML Deserialization Scanner',\n      'Description' => %q{\n        This module attempts to identify Ruby on Rails instances vulnerable to\n        an arbitrary object instantiation flaw in the XML request processor.\n      },\n      'Author'      => [\n          'hdm', # author\n          'jjarmoc' # improvements\n          ],\n      'License'     => MSF_LICENSE,\n      'References'  =>\n        [\n          ['CVE', '2013-0156'],\n          ['URL', 'https://www.rapid7.com/blog/post/2013/01/09/serialization-mischief-in-ruby-land-cve-2013-0156/']\n        ]\n    ))\n\n    register_options([\n      OptString.new('URIPATH', [true, \"The URI to test\", \"/\"]),\n      OptEnum.new('HTTP_METHOD', [true, 'HTTP Method', 'POST', ['GET', 'POST', 'PUT'] ]),\n    ])\n  end\n\n  def send_probe(ptype, pdata)\n    odata = %Q^<?xml version=\"1.0\" encoding=\"UTF-8\"?>\\n<probe type=\"#{ptype}\"><![CDATA[\\n#{pdata}\\n]]></probe>^\n    res = send_request_cgi({\n      'uri'    => datastore['URIPATH'] || \"/\",\n      'method' => datastore['HTTP_METHOD'],\n      'ctype'  => 'application/xml',\n      'data'   => odata\n    }, 25)\n  end\n\n  def run_host(ip)\n\n    res1 = send_probe(\"string\", \"hello\")\n\n    unless res1\n      vprint_status(\"#{rhost}:#{rport} No reply to the initial XML request\")\n      return\n    end\n\n    if res1.code.to_s =~ /^[5]/\n      vprint_status(\"#{rhost}:#{rport} The server replied with #{res1.code} for our initial XML request, double check URIPATH\")\n      return\n    end\n\n    res2 = send_probe(\"yaml\", \"--- !ruby/object:Time {}\\n\")\n\n    unless res2\n      vprint_status(\"#{rhost}:#{rport} No reply to the initial YAML probe\")\n      return\n    end\n\n    res3 = send_probe(\"yaml\", \"--- !ruby/object:\\x00\")\n\n    unless res3\n      vprint_status(\"#{rhost}:#{rport} No reply to the second YAML probe\")\n      return\n    end\n\n    vprint_status(\"Probe response codes: #{res1.code} / #{res2.code} / #{res3.code}\")\n\n\n    if (res2.code == res1.code) and (res3.code != res2.code) and (res3.code != 200)\n      print_good(\"#{rhost}:#{rport} is likely vulnerable due to a #{res3.code} reply for invalid YAML\")\n      report_vuln({\n        :host\t=> rhost,\n        :port\t=> rport,\n        :proto  => 'tcp',\n        :name\t=> self.name,\n        :info\t=> \"Module triggered a #{res3.code} reply\",\n        :refs   => self.references\n      })\n    else\n      vprint_status(\"#{rhost}:#{rport} is not likely to be vulnerable or URIPATH & HTTP_METHOD must be set\")\n    end\n  end\nend\n"
}