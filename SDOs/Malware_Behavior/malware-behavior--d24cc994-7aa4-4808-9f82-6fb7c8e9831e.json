{
    "type": "malware-behavior",
    "spec_version": "2.1",
    "id": "malware-behavior--d24cc994-7aa4-4808-9f82-6fb7c8e9831e",
    "created": "2024-08-13T14:46:37.053656Z",
    "modified": "2024-08-13T14:46:48.574299Z",
    "name": "Windows Credential Manager: ",
    "description": "Adversaries may acquire credentials from the Windows Credential Manager. The Credential Manager stores credentials for signing into websites, applications, and/or devices that request authentication through NTLM or Kerberos in Credential Lockers (previously known as Windows Vaults).[1][2]The Windows Credential Manager separates website credentials from application or network credentials in two lockers. As part of Credentials from Web Browsers, Internet Explorer and Microsoft Edge website credentials are managed by the Credential Manager and are stored in the Web Credentials locker. Application and network credentials are stored in the Windows Credentials locker.Credential Lockers store credentials in encrypted .vcrd files, located under %Systemdrive%\\Users\\\\[Username]\\AppData\\Local\\Microsoft\\\\[Vault/Credentials]\\. The encryption key can be found in a file named Policy.vpol, typically located in the same folder as the credentials.[3][4]Adversaries may list credentials managed by the Windows Credential Manager through several mechanisms. vaultcmd.exe is a native Windows executable that can be used to enumerate credentials stored in the Credential Locker through a command-line interface. Adversaries may also gather credentials by directly reading files located inside of the Credential Lockers. Windows APIs, such as CredEnumerateA, may also be absued to list credentials managed by the Credential Manager.[5][6]Adversaries may also obtain credentials from credential backups. Credential backups and restorations may be performed by running rundll32.exe keymgr.dll KRShowKeyMgr then selecting the 'Back up...' button on the 'Stored User Names and Passwords' GUI.Password recovery tools may also obtain plain text passwords from the Credential Manager.[4]",
    "object_marking_refs": [
        "marking-definition--613f2e26-407d-48c7-9eca-b8e91df99dc9"
    ],
    "external_references": [
        {
            "source_name": "MITRE ATT&CK",
            "url": "https://attack.mitre.org/techniques/T1555/004",
            "external_id": "T1555/004"
        }
    ],
    "x_mitre_capa_rules": [
        {
            "rule": {
                "features": [
                    {
                        "or": [
                            {
                                "string": ".vcrd"
                            },
                            {
                                "string": "*.vcrd"
                            },
                            {
                                "string": "Policy.vpol"
                            },
                            {
                                "string": "/AppData\\\\Local\\\\Microsoft\\\\(Vault|Credentials)/"
                            },
                            {
                                "api": "CredEnumerate"
                            },
                            {
                                "and": [
                                    {
                                        "optional": [
                                            {
                                                "match": "host-interaction/process/create"
                                            }
                                        ]
                                    },
                                    {
                                        "or": [
                                            {
                                                "string": "/vaultcmd(\\.exe)?/"
                                            },
                                            {
                                                "substring": "/listcreds:"
                                            },
                                            {
                                                "substring": "\"Windows Credentials\""
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    }
                ],
                "meta": {
                    "att&ck": [
                        "Credential Access::Credentials from Password Stores::Windows Credential Manager [T1555.004]"
                    ],
                    "authors": [
                        "moritz.raabe@mandiant.com"
                    ],
                    "examples": [
                        "c56af5561e3f20bed435fb4355cffc29:0x411A41"
                    ],
                    "name": "acquire credentials from Windows Credential Manager",
                    "namespace": "collection",
                    "scopes": {
                        "dynamic": "thread",
                        "static": "function"
                    }
                }
            }
        }
    ],
    "x_mitre_detection_rules": [
        {
            "author": "Nasreddine Bencherchali (Nextron Systems)",
            "date": "2022/10/17",
            "description": "Detects file access requests to the Windows Credential History File by an uncommon application.\nThis can be a sign of credential stealing. Example case would be usage of mimikatz \"dpapi::credhist\" function\n",
            "detection": {
                "condition": "selection and not 1 of filter_main_*",
                "filter_main_explorer": {
                    "Image|endswith": ":\\Windows\\explorer.exe"
                },
                "filter_main_system_folders": {
                    "Image|contains": [
                        ":\\Program Files\\",
                        ":\\Program Files (x86)\\",
                        ":\\Windows\\system32\\",
                        ":\\Windows\\SysWOW64\\"
                    ]
                },
                "selection": {
                    "FileName|endswith": "\\Microsoft\\Protect\\CREDHIST"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "7a2a22ea-a203-4cd3-9abf-20eb1c5c6cd2",
            "level": "medium",
            "logsource": {
                "category": "file_access",
                "definition": "Requirements: Microsoft-Windows-Kernel-File ETW provider",
                "product": "windows"
            },
            "modified": "2023/12/18",
            "references": [
                "https://tools.thehacker.recipes/mimikatz/modules/dpapi/credhist",
                "https://www.passcape.com/windows_password_recovery_dpapi_credhist"
            ],
            "status": "experimental",
            "tags": [
                "attack.credential_access",
                "attack.t1555.004"
            ],
            "title": "Access To Windows Credential History File By Uncommon Application"
        },
        {
            "author": "Nasreddine Bencherchali (Nextron Systems)",
            "date": "2022/10/17",
            "description": "Detects file access requests to the the Windows Data Protection API Master keys by an uncommon application.\nThis can be a sign of credential stealing. Example case would be usage of mimikatz \"dpapi::masterkey\" function\n",
            "detection": {
                "condition": "selection and not 1 of filter_*",
                "filter_system_folders": {
                    "Image|contains": [
                        ":\\Program Files\\",
                        ":\\Program Files (x86)\\",
                        ":\\Windows\\system32\\",
                        ":\\Windows\\SysWOW64\\"
                    ]
                },
                "selection": {
                    "FileName|contains": [
                        "\\Microsoft\\Protect\\S-1-5-18\\",
                        "\\Microsoft\\Protect\\S-1-5-21-"
                    ]
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "46612ae6-86be-4802-bc07-39b59feb1309",
            "level": "medium",
            "logsource": {
                "category": "file_access",
                "definition": "Requirements: Microsoft-Windows-Kernel-File ETW provider",
                "product": "windows"
            },
            "modified": "2023/12/18",
            "references": [
                "http://blog.harmj0y.net/redteaming/operational-guidance-for-offensive-user-dpapi-abuse/",
                "https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords"
            ],
            "status": "experimental",
            "tags": [
                "attack.credential_access",
                "attack.t1555.004"
            ],
            "title": "Access To Windows DPAPI Master Keys By Uncommon Application"
        },
        {
            "author": "Florian Roth (Nextron Systems)",
            "date": "2022/04/21",
            "description": "Detects the invocation of the Stored User Names and Passwords dialogue (Key Manager)",
            "detection": {
                "condition": "all of selection_*",
                "selection_cli": {
                    "CommandLine|contains|all": [
                        "keymgr",
                        "KRShowKeyMgr"
                    ]
                },
                "selection_img": [
                    {
                        "Image|endswith": "\\rundll32.exe"
                    },
                    {
                        "OriginalFileName": "RUNDLL32.EXE"
                    }
                ]
            },
            "falsepositives": [
                "Administrative activity"
            ],
            "id": "a4694263-59a8-4608-a3a0-6f8d3a51664c",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/02/09",
            "references": [
                "https://twitter.com/NinjaParanoid/status/1516442028963659777"
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1555.004"
            ],
            "title": "Suspicious Key Manager Access"
        },
        {
            "author": "frack113",
            "date": "2022/04/08",
            "description": "List credentials currently stored in Windows Credential Manager via the native Windows utility vaultcmd.exe",
            "detection": {
                "condition": "all of selection*",
                "selection_cli": {
                    "CommandLine|contains": "/listcreds:"
                },
                "selection_img": [
                    {
                        "Image|endswith": "\\VaultCmd.exe"
                    },
                    {
                        "OriginalFileName": "VAULTCMD.EXE"
                    }
                ]
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "58f50261-c53b-4c88-bd12-1d71f12eda4c",
            "level": "medium",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2022/05/13",
            "references": [
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1555.004/T1555.004.md#atomic-test-1---access-saved-credentials-via-vaultcmd"
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1555.004"
            ],
            "title": "Windows Credential Manager Access via VaultCmd"
        }
    ]
}