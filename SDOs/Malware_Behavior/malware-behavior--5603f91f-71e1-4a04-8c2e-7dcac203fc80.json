{
    "type": "malware-behavior",
    "spec_version": "2.1",
    "id": "malware-behavior--5603f91f-71e1-4a04-8c2e-7dcac203fc80",
    "created": "2024-08-13T14:46:36.908651Z",
    "modified": "2024-08-13T14:46:48.383989Z",
    "name": "Subvert Trust Controls: Mark-of-the-Web Bypass",
    "description": "Adversaries may abuse specific file formats to subvert Mark-of-the-Web (MOTW) controls. In Windows, when files are downloaded from the Internet, they are tagged with a hidden NTFS Alternate Data Stream (ADS) named Zone.Identifier with a specific value known as the MOTW.[1] Files that are tagged with MOTW are protected and cannot perform certain actions. For example, starting in MS Office 10, if a MS Office file has the MOTW, it will open in Protected View. Executables tagged with the MOTW will be processed by Windows Defender SmartScreen that compares files with an allowlist of well-known executables. If the file is not known/trusted, SmartScreen will prevent the execution and warn the user not to run it.[2][3][4]Adversaries may abuse container files such as compressed/archive (.arj, .gzip) and/or disk image (.iso, .vhd) file formats to deliver malicious payloads that may not be tagged with MOTW. Container files downloaded from the Internet will be marked with MOTW but the files within may not inherit the MOTW after the container files are extracted and/or mounted. MOTW is a NTFS feature and many container files do not support NTFS alternative data streams. After a container file is extracted and/or mounted, the files contained within them may be treated as local files on disk and run without protections.[2][3]",
    "object_marking_refs": [
        "marking-definition--613f2e26-407d-48c7-9eca-b8e91df99dc9"
    ],
    "external_references": [
        {
            "source_name": "MITRE ATT&CK",
            "url": "https://attack.mitre.org/techniques/T1553/005",
            "external_id": "T1553/005"
        }
    ],
    "x_mitre_capa_rules": [
        {
            "rule": {
                "features": [
                    {
                        "and": [
                            {
                                "api": "DeleteFile"
                            },
                            {
                                "or": [
                                    {
                                        "description": "NTFS ADS name recognized by Windows Defender SmartScreen",
                                        "string": ":Zone.Identifier"
                                    },
                                    {
                                        "description": "NTFS ADS name recognized by Windows Defender SmartScreen",
                                        "string": "%s:Zone.Identifier"
                                    }
                                ]
                            }
                        ]
                    }
                ],
                "meta": {
                    "att&ck": [
                        "Defense Evasion::Subvert Trust Controls::Mark-of-the-Web Bypass [T1553.005]"
                    ],
                    "authors": [
                        "william.ballenthin@mandiant.com"
                    ],
                    "examples": [
                        "48c7ad2d9d482cb11898f2719638ceed:0x405B10"
                    ],
                    "name": "bypass Mark of the Web",
                    "namespace": "host-interaction/file-system",
                    "scopes": {
                        "dynamic": "thread",
                        "static": "function"
                    }
                }
            }
        }
    ],
    "x_mitre_detection_rules": [
        {
            "author": "frack113",
            "date": "2022/02/01",
            "description": "Adversaries may abuse container files such as disk image (.iso, .vhd) file formats to deliver malicious payloads that may not be tagged with MOTW.",
            "detection": {
                "condition": "selection",
                "selection": {
                    "ScriptBlockText|contains|all": [
                        "Mount-DiskImage ",
                        "-ImagePath "
                    ]
                }
            },
            "falsepositives": [
                "Legitimate PowerShell scripts"
            ],
            "id": "29e1c216-6408-489d-8a06-ee9d151ef819",
            "level": "low",
            "logsource": {
                "category": "ps_script",
                "definition": "Requirements: Script Block Logging must be enabled",
                "product": "windows"
            },
            "references": [
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1553.005/T1553.005.md#atomic-test-1---mount-iso-image",
                "https://learn.microsoft.com/en-us/powershell/module/storage/mount-diskimage?view=windowsserver2022-ps"
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.t1553.005"
            ],
            "title": "Suspicious Mount-DiskImage"
        },
        {
            "author": "frack113",
            "date": "2022/02/01",
            "description": "Remove the Zone.Identifier alternate data stream which identifies the file as downloaded from the internet.",
            "detection": {
                "condition": "selection",
                "selection": {
                    "ScriptBlockText|contains|all": [
                        "Unblock-File ",
                        "-Path "
                    ]
                }
            },
            "falsepositives": [
                "Legitimate PowerShell scripts"
            ],
            "id": "5947497f-1aa4-41dd-9693-c9848d58727d",
            "level": "medium",
            "logsource": {
                "category": "ps_script",
                "definition": "Requirements: Script Block Logging must be enabled",
                "product": "windows"
            },
            "references": [
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1553.005/T1553.005.md#atomic-test-3---remove-the-zoneidentifier-alternate-data-stream",
                "https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/unblock-file?view=powershell-7.2"
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.t1553.005"
            ],
            "title": "Suspicious Unblock-File"
        },
        {
            "author": "frack113",
            "date": "2022/02/01",
            "description": "Adversaries may abuse container files such as disk image (.iso, .vhd) file formats to deliver malicious payloads that may not be tagged with MOTW.",
            "detection": {
                "condition": "selection",
                "selection": {
                    "ScriptBlockText|contains|all": [
                        "Mount-DiskImage ",
                        "-ImagePath ",
                        "Get-Volume",
                        ".DriveLetter",
                        "invoke-item ",
                        "):\\"
                    ]
                }
            },
            "falsepositives": [
                "Legitimate PowerShell scripts"
            ],
            "id": "902cedee-0398-4e3a-8183-6f3a89773a96",
            "level": "medium",
            "logsource": {
                "category": "ps_script",
                "definition": "Requirements: Script Block Logging must be enabled",
                "product": "windows"
            },
            "references": [
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1553.005/T1553.005.md#atomic-test-2---mount-an-iso-image-and-run-executable-from-the-iso",
                "https://learn.microsoft.com/en-us/powershell/module/storage/mount-diskimage?view=windowsserver2022-ps"
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.t1553.005"
            ],
            "title": "Suspicious Invoke-Item From Mount-DiskImage"
        }
    ]
}