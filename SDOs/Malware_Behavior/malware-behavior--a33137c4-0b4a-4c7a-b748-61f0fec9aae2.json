{
    "type": "malware-behavior",
    "spec_version": "2.1",
    "id": "malware-behavior--a33137c4-0b4a-4c7a-b748-61f0fec9aae2",
    "created": "2024-08-13T14:46:36.684307Z",
    "modified": "2024-08-13T14:46:48.409643Z",
    "name": "System Service Discovery",
    "description": "Adversaries may try to gather information about registered local system services. Adversaries may obtain information about services using tools as well as OS utility commands such as sc query, tasklist /svc, systemctl --type=service, and net start.Adversaries may use the information from System Service Discovery during automated discovery to shape follow-on behaviors, including whether or not the adversary fully infects the target and/or attempts specific actions.",
    "object_marking_refs": [
        "marking-definition--613f2e26-407d-48c7-9eca-b8e91df99dc9"
    ],
    "external_references": [
        {
            "source_name": "MITRE ATT&CK",
            "url": "https://attack.mitre.org/techniques/T1007",
            "external_id": "T1007"
        },
        {
            "source_name": "CAPEC 574",
            "external_id": "malware-behavior--d8f50c4b-d1e7-4bbf-b321-251275c04edc"
        },
        {
            "source_name": "mitre-attack",
            "url": "https://attack.mitre.org/techniques/T1007",
            "external_id": "T1007"
        }
    ],
    "x_mitre_capa_rules": [
        {
            "rule": {
                "features": [
                    {
                        "or": [
                            {
                                "api": "advapi32.QueryServiceStatusEx"
                            },
                            {
                                "api": "advapi32.QueryServiceStatus"
                            }
                        ]
                    }
                ],
                "meta": {
                    "att&ck": [
                        "Discovery::System Service Discovery [T1007]"
                    ],
                    "authors": [
                        "michael.hunhoff@mandiant.com"
                    ],
                    "examples": [
                        "9DC209F66DA77858E362E624D0BE86B3:0x403C70"
                    ],
                    "name": "query service status",
                    "namespace": "host-interaction/service",
                    "scopes": {
                        "dynamic": "call",
                        "static": "function"
                    }
                }
            }
        },
        {
            "rule": {
                "features": [
                    {
                        "or": [
                            {
                                "api": "advapi32.QueryServiceConfigA"
                            },
                            {
                                "api": "advapi32.QueryServiceConfig2A"
                            }
                        ]
                    }
                ],
                "meta": {
                    "att&ck": [
                        "Discovery::System Service Discovery [T1007]"
                    ],
                    "authors": [
                        "@mr-tz"
                    ],
                    "examples": [
                        "Practical Malware Analysis Lab 17-02.dll_:0x1000bf52"
                    ],
                    "name": "query service configuration",
                    "namespace": "host-interaction/service",
                    "scopes": {
                        "dynamic": "call",
                        "static": "function"
                    }
                }
            }
        },
        {
            "rule": {
                "features": [
                    {
                        "or": [
                            {
                                "api": "advapi32.EnumServicesStatus"
                            },
                            {
                                "api": "advapi32.EnumServicesStatusEx"
                            },
                            {
                                "api": "advapi32.EnumDependentServices"
                            }
                        ]
                    }
                ],
                "meta": {
                    "att&ck": [
                        "Discovery::System Service Discovery [T1007]"
                    ],
                    "authors": [
                        "moritz.raabe@mandiant.com",
                        "michael.hunhoff@mandiant.com"
                    ],
                    "examples": [
                        "Practical Malware Analysis Lab 05-01.dll_:0x1000B823"
                    ],
                    "name": "enumerate services",
                    "namespace": "host-interaction/service/list",
                    "scopes": {
                        "dynamic": "call",
                        "static": "function"
                    }
                }
            }
        }
    ],
    "x_mitre_detection_rules": [
        {
            "author": "Timur Zinniatullin, oscd.community",
            "date": "2019/10/21",
            "description": "Detects the usage of \"reg.exe\" in order to query reconnaissance information from the registry. Adversaries may interact with the Windows registry to gather information about credentials, the system, configuration, and installed software.",
            "detection": {
                "condition": "all of selection_*",
                "selection_flag": {
                    "CommandLine|contains": "query"
                },
                "selection_img": [
                    {
                        "Image|endswith": "\\reg.exe"
                    },
                    {
                        "OriginalFileName": "reg.exe"
                    }
                ],
                "selection_key": {
                    "CommandLine|contains": [
                        "currentVersion\\windows",
                        "winlogon\\",
                        "currentVersion\\shellServiceObjectDelayLoad",
                        "currentVersion\\run",
                        "currentVersion\\policies\\explorer\\run",
                        "currentcontrolset\\services"
                    ]
                }
            },
            "falsepositives": [
                "Discord"
            ],
            "id": "970007b7-ce32-49d0-a4a4-fbef016950bd",
            "level": "medium",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/02/05",
            "references": [
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1012/T1012.md"
            ],
            "status": "test",
            "tags": [
                "attack.discovery",
                "attack.t1012",
                "attack.t1007"
            ],
            "title": "Potential Configuration And Service Reconnaissance Via Reg.EXE"
        },
        {
            "author": "Florian Roth (Nextron Systems), Nasreddine Bencherchali",
            "date": "2022/10/10",
            "description": "Detects suspicious use of PCHunter, a tool like Process Hacker to view and manipulate processes, kernel options and other low level stuff",
            "detection": {
                "condition": "1 of selection_*",
                "selection_hash_values": [
                    {
                        "md5": [
                            "228dd0c2e6287547e26ffbd973a40f14",
                            "987b65cd9b9f4e9a1afd8f8b48cf64a7"
                        ]
                    },
                    {
                        "sha1": [
                            "5f1cbc3d99558307bc1250d084fa968521482025",
                            "3fb89787cb97d902780da080545584d97fb1c2eb"
                        ]
                    },
                    {
                        "sha256": [
                            "2b214bddaab130c274de6204af6dba5aeec7433da99aa950022fa306421a6d32",
                            "55f041bf4e78e9bfa6d4ee68be40e496ce3a1353e1ca4306598589e19802522c"
                        ]
                    },
                    {
                        "Imphash": [
                            "444d210cea1ff8112f256a4997eed7ff",
                            "0479f44df47cfa2ef1ccc4416a538663"
                        ]
                    }
                ],
                "selection_hashes": {
                    "Hashes|contains": [
                        "SHA1=5F1CBC3D99558307BC1250D084FA968521482025",
                        "MD5=987B65CD9B9F4E9A1AFD8F8B48CF64A7",
                        "SHA256=2B214BDDAAB130C274DE6204AF6DBA5AEEC7433DA99AA950022FA306421A6D32",
                        "IMPHASH=444D210CEA1FF8112F256A4997EED7FF",
                        "SHA1=3FB89787CB97D902780DA080545584D97FB1C2EB",
                        "MD5=228DD0C2E6287547E26FFBD973A40F14",
                        "SHA256=55F041BF4E78E9BFA6D4EE68BE40E496CE3A1353E1CA4306598589E19802522C",
                        "IMPHASH=0479F44DF47CFA2EF1CCC4416A538663"
                    ]
                },
                "selection_image": {
                    "Image|endswith": [
                        "\\PCHunter64.exe",
                        "\\PCHunter32.exe"
                    ]
                },
                "selection_pe": [
                    {
                        "OriginalFileName": "PCHunter.exe"
                    },
                    {
                        "Description": "Epoolsoft Windows Information View Tools"
                    }
                ]
            },
            "falsepositives": [
                "Unlikely"
            ],
            "id": "fca949cc-79ca-446e-8064-01aa7e52ece5",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/02/13",
            "references": [
                "http://www.xuetr.com/",
                "https://www.crowdstrike.com/blog/falcon-overwatch-report-finds-increase-in-ecrime/",
                "https://www.hexacorn.com/blog/2018/04/20/kernel-hacking-tool-you-might-have-never-heard-of-xuetr-pchunter/"
            ],
            "status": "test",
            "tags": [
                "attack.execution",
                "attack.discovery",
                "attack.t1082",
                "attack.t1057",
                "attack.t1012",
                "attack.t1083",
                "attack.t1007"
            ],
            "title": "HackTool - PCHunter Execution"
        },
        {
            "author": "Nasreddine Bencherchali (Nextron Systems), Cedric Maurugeon",
            "date": "2023/09/04",
            "description": "Detects execution of the \"esxcli\" command with the \"storage\" flag in order to retrieve information about the storage status and other related information. Seen used by malware such as DarkSide and LockBit.",
            "detection": {
                "condition": "all of selection_*",
                "selection_cli": {
                    "CommandLine|contains": [
                        " get",
                        " list"
                    ]
                },
                "selection_img": {
                    "CommandLine|contains": "storage",
                    "Image|endswith": "/esxcli"
                }
            },
            "falsepositives": [
                "Legitimate administration activities"
            ],
            "id": "f41dada5-3f56-4232-8503-3fb7f9cf2d60",
            "level": "medium",
            "logsource": {
                "category": "process_creation",
                "product": "linux"
            },
            "references": [
                "https://www.trendmicro.com/en_us/research/21/e/darkside-linux-vms-targeted.html",
                "https://www.trendmicro.com/en_us/research/22/a/analysis-and-Impact-of-lockbit-ransomwares-first-linux-and-vmware-esxi-variant.html",
                "https://developer.vmware.com/docs/11743/esxi-7-0-esxcli-command-reference/namespace/esxcli_storage.html"
            ],
            "status": "test",
            "tags": [
                "attack.discovery",
                "attack.t1033",
                "attack.t1007"
            ],
            "title": "ESXi Storage Information Discovery Via ESXCLI"
        },
        {
            "author": "Cedric Maurugeon",
            "date": "2023/09/04",
            "description": "Detects execution of the \"esxcli\" command with the \"network\" flag in order to retrieve information about the network configuration.",
            "detection": {
                "condition": "all of selection_*",
                "selection_cli": {
                    "CommandLine|contains": [
                        " get",
                        " list"
                    ]
                },
                "selection_img": {
                    "CommandLine|contains": "network",
                    "Image|endswith": "/esxcli"
                }
            },
            "falsepositives": [
                "Legitimate administration activities"
            ],
            "id": "33e814e0-1f00-4e43-9c34-31fb7ae2b174",
            "level": "medium",
            "logsource": {
                "category": "process_creation",
                "product": "linux"
            },
            "references": [
                "https://www.crowdstrike.com/blog/hypervisor-jackpotting-ecrime-actors-increase-targeting-of-esxi-servers/",
                "https://developer.vmware.com/docs/11743/esxi-7-0-esxcli-command-reference/namespace/esxcli_network.html"
            ],
            "status": "test",
            "tags": [
                "attack.discovery",
                "attack.t1033",
                "attack.t1007"
            ],
            "title": "ESXi Network Configuration Discovery Via ESXCLI"
        },
        {
            "author": "Joseliyo Sanchez, @Joseliyo_Jstnk",
            "date": "2023/06/02",
            "description": "Detects usage of crontab to list the tasks of the user",
            "detection": {
                "condition": "selection",
                "selection": {
                    "CommandLine|contains": " -l",
                    "Image|endswith": "/crontab"
                }
            },
            "falsepositives": [
                "Legitimate use of crontab"
            ],
            "id": "403ed92c-b7ec-4edd-9947-5b535ee12d46",
            "level": "low",
            "logsource": {
                "category": "process_creation",
                "product": "linux"
            },
            "references": [
                "https://blogs.jpcert.or.jp/en/2023/05/gobrat.html",
                "https://jstnk9.github.io/jstnk9/research/GobRAT-Malware/",
                "https://www.virustotal.com/gui/file/60bcd645450e4c846238cf0e7226dc40c84c96eba99f6b2cffcd0ab4a391c8b3/detection",
                "https://www.virustotal.com/gui/file/3e44c807a25a56f4068b5b8186eee5002eed6f26d665a8b791c472ad154585d1/detection"
            ],
            "status": "test",
            "tags": [
                "attack.discovery",
                "attack.t1007"
            ],
            "title": "Crontab Enumeration"
        },
        {
            "author": "Nasreddine Bencherchali (Nextron Systems), Cedric Maurugeon",
            "date": "2023/09/04",
            "description": "Detects execution of the \"esxcli\" command with the \"vsan\" flag in order to retrieve information about virtual storage. Seen used by malware such as DarkSide.",
            "detection": {
                "condition": "all of selection_*",
                "selection_cli": {
                    "CommandLine|contains": [
                        " get",
                        " list"
                    ]
                },
                "selection_img": {
                    "CommandLine|contains": "vsan",
                    "Image|endswith": "/esxcli"
                }
            },
            "falsepositives": [
                "Legitimate administration activities"
            ],
            "id": "d54c2f06-aca9-4e2b-81c9-5317858f4b79",
            "level": "medium",
            "logsource": {
                "category": "process_creation",
                "product": "linux"
            },
            "references": [
                "https://www.trendmicro.com/en_us/research/21/e/darkside-linux-vms-targeted.html",
                "https://www.trendmicro.com/en_us/research/22/a/analysis-and-Impact-of-lockbit-ransomwares-first-linux-and-vmware-esxi-variant.html",
                "https://developer.vmware.com/docs/11743/esxi-7-0-esxcli-command-reference/namespace/esxcli_vsan.html"
            ],
            "status": "test",
            "tags": [
                "attack.discovery",
                "attack.t1033",
                "attack.t1007"
            ],
            "title": "ESXi VSAN Information Discovery Via ESXCLI"
        },
        {
            "author": "Cedric Maurugeon",
            "date": "2023/09/04",
            "description": "Detects execution of the \"esxcli\" command with the \"system\" flag in order to retrieve information about the different component of the system. Such as accounts, modules, NTP, etc.",
            "detection": {
                "condition": "all of selection_*",
                "selection_cli": {
                    "CommandLine|contains": [
                        " get",
                        " list"
                    ]
                },
                "selection_img": {
                    "CommandLine|contains": "system",
                    "Image|endswith": "/esxcli"
                }
            },
            "falsepositives": [
                "Legitimate administration activities"
            ],
            "id": "e80273e1-9faf-40bc-bd85-dbaff104c4e9",
            "level": "medium",
            "logsource": {
                "category": "process_creation",
                "product": "linux"
            },
            "references": [
                "https://www.crowdstrike.com/blog/hypervisor-jackpotting-ecrime-actors-increase-targeting-of-esxi-servers/",
                "https://developer.vmware.com/docs/11743/esxi-7-0-esxcli-command-reference/namespace/esxcli_system.html"
            ],
            "status": "test",
            "tags": [
                "attack.discovery",
                "attack.t1033",
                "attack.t1007"
            ],
            "title": "ESXi System Information Discovery Via ESXCLI"
        },
        {
            "author": "Cedric Maurugeon",
            "date": "2023/09/04",
            "description": "Detects execution of the \"esxcli\" command with the \"vm\" flag in order to retrieve information about the installed VMs.",
            "detection": {
                "condition": "selection",
                "selection": {
                    "CommandLine|contains": "vm process",
                    "Image|endswith": "/esxcli",
                    "CommandLine|endswith": " list"
                }
            },
            "falsepositives": [
                "Legitimate administration activities"
            ],
            "id": "5f1573a7-363b-4114-9208-ad7a61de46eb",
            "level": "medium",
            "logsource": {
                "category": "process_creation",
                "product": "linux"
            },
            "references": [
                "https://www.crowdstrike.com/blog/hypervisor-jackpotting-ecrime-actors-increase-targeting-of-esxi-servers/",
                "https://developer.vmware.com/docs/11743/esxi-7-0-esxcli-command-reference/namespace/esxcli_vm.html",
                "https://www.secuinfra.com/en/techtalk/hide-your-hypervisor-analysis-of-esxiargs-ransomware/",
                "https://www.trendmicro.com/en_us/research/22/e/new-linux-based-ransomware-cheerscrypt-targets-exsi-devices.html"
            ],
            "status": "test",
            "tags": [
                "attack.discovery",
                "attack.t1033",
                "attack.t1007"
            ],
            "title": "ESXi VM List Discovery Via ESXCLI"
        }
    ],
    "x_mitre_platforms": [
        "Windows",
        "macOS",
        "Linux"
    ],
    "x_mitre_domains": [
        "enterprise-attack"
    ],
    "x_mitre_contributors": [
        "Harshal Tupsamudre, Qualys"
    ],
    "kill_chain_phases": [
        {
            "kill_chain_name": "mitre-attack",
            "phase_name": "discovery"
        }
    ],
    "x_mitre_detection": "System and network discovery techniques normally occur throughout an operation as an adversary learns the environment. Data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities, such as Lateral Movement, based on the information obtained.\n\nMonitor processes and command-line arguments for actions that could be taken to gather system information related to services. Remote access tools with built-in features may interact directly with the Windows API to gather information. Information may also be acquired through Windows system management tools such as [Windows Management Instrumentation](https://attack.mitre.org/techniques/T1047) and [PowerShell](https://attack.mitre.org/techniques/T1059/001).",
    "x_mitre_is_subtechnique": false,
    "x_mitre_version": "1.5",
    "x_mitre_modified_by_ref": "identity--c78cb6e5-0c4b-4611-8297-d1b8b55e40b5",
    "x_mitre_data_sources": [
        "Command: Command Execution",
        "Process: Process Creation",
        "Process: OS API Execution"
    ],
    "x_mitre_permissions_required": []
}