{
    "type": "malware-behavior",
    "spec_version": "2.1",
    "id": "malware-behavior--a72943dd-d4d1-478a-a32b-e7384bb49b77",
    "created": "2024-08-13T14:46:37.061322Z",
    "modified": "2024-08-13T14:46:45.759991Z",
    "name": "OS Credential Dumping: NTDS",
    "description": "Adversaries may attempt to access or create a copy of the Active Directory domain database in order to steal credential information, as well as obtain other information about domain members such as devices, users, and access rights. By default, the NTDS file (NTDS.dit) is located in %SystemRoot%\\NTDS\\Ntds.dit of a domain controller.[1]In addition to looking for NTDS files on active Domain Controllers, adversaries may search for backups that contain the same or similar information.[2]The following tools and techniques can be used to enumerate the NTDS file and the contents of the entire Active Directory hashes.Volume Shadow Copysecretsdump.pyUsing the in-built Windows tool, ntdsutil.exeInvoke-NinjaCopy",
    "object_marking_refs": [
        "marking-definition--613f2e26-407d-48c7-9eca-b8e91df99dc9"
    ],
    "external_references": [
        {
            "source_name": "MITRE ATT&CK",
            "url": "https://attack.mitre.org/techniques/T1003/003",
            "external_id": "T1003/003"
        }
    ],
    "x_mitre_detection_rules": [
        {
            "author": "@neu5ron, Teymur Kheirkhabarov, oscd.community",
            "date": "2020/04/02",
            "description": "Transferring files with well-known filenames (sensitive files with credential data) using network shares",
            "detection": {
                "condition": "selection",
                "selection": {
                    "name": [
                        "\\mimidrv",
                        "\\lsass",
                        "\\windows\\minidump\\",
                        "\\hiberfil",
                        "\\sqldmpr",
                        "\\sam",
                        "\\ntds.dit",
                        "\\security"
                    ]
                }
            },
            "falsepositives": [
                "Transferring sensitive files for legitimate administration work by legitimate administrator"
            ],
            "id": "2e69f167-47b5-4ae7-a390-47764529eff5",
            "level": "medium",
            "logsource": {
                "product": "zeek",
                "service": "smb_files"
            },
            "modified": "2021/11/27",
            "references": [
                "https://www.slideshare.net/heirhabarov/hunting-for-credentials-dumping-in-windows-environment"
            ],
            "related": [
                {
                    "id": "910ab938-668b-401b-b08c-b596e80fdca5",
                    "type": "similar"
                }
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1003.002",
                "attack.t1003.001",
                "attack.t1003.003"
            ],
            "title": "Transferring Files with Credential Data via Network Shares - Zeek"
        },
        {
            "author": "Samir Bousseaden, @neu5ron",
            "date": "2020/03/19",
            "description": "Detect AD credential dumping using impacket secretdump HKTL. Based on the SIGMA rules/windows/builtin/win_impacket_secretdump.yml",
            "detection": {
                "condition": "selection",
                "selection": {
                    "name|contains": "SYSTEM32\\",
                    "name|endswith": ".tmp",
                    "path|contains|all": [
                        "\\",
                        "ADMIN$"
                    ]
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "92dae1ed-1c9d-4eff-a567-33acbd95b00e",
            "level": "high",
            "logsource": {
                "product": "zeek",
                "service": "smb_files"
            },
            "modified": "2021/11/27",
            "references": [
                "https://blog.menasec.net/2019/02/threat-huting-10-impacketsecretdump.html"
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1003.002",
                "attack.t1003.004",
                "attack.t1003.003"
            ],
            "title": "Possible Impacket SecretDump Remote Activity - Zeek"
        },
        {
            "author": "Florian Roth (Nextron Systems)",
            "date": "2022/03/11",
            "description": "Detects creation of a file named \"ntds.dit\" (Active Directory Database) by an uncommon parent process or directory",
            "detection": {
                "condition": "selection_file and 1 of selection_process_*",
                "selection_file": {
                    "TargetFilename|endswith": "\\ntds.dit"
                },
                "selection_process_parent": {
                    "ParentImage|endswith": [
                        "\\cscript.exe",
                        "\\httpd.exe",
                        "\\nginx.exe",
                        "\\php-cgi.exe",
                        "\\powershell.exe",
                        "\\pwsh.exe",
                        "\\w3wp.exe",
                        "\\wscript.exe"
                    ]
                },
                "selection_process_parent_path": {
                    "ParentImage|contains": [
                        "\\apache",
                        "\\tomcat",
                        "\\AppData\\",
                        "\\Temp\\",
                        "\\Public\\",
                        "\\PerfLogs\\"
                    ]
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "4e7050dd-e548-483f-b7d6-527ab4fa784d",
            "level": "high",
            "logsource": {
                "category": "file_event",
                "definition": "Requirements: The \"ParentImage\" field is not available by default on EID 11 of Sysmon logs. To be able to use this rule to the full extent you need to enrich the log with additional ParentImage data",
                "product": "windows"
            },
            "modified": "2023/01/05",
            "references": [
                "https://www.ired.team/offensive-security/credential-access-and-credential-dumping/ntds.dit-enumeration",
                "https://www.n00py.io/2022/03/manipulating-user-passwords-without-mimikatz/",
                "https://pentestlab.blog/tag/ntds-dit/",
                "https://github.com/samratashok/nishang/blob/414ee1104526d7057f9adaeee196d91ae447283e/Gather/Copy-VSS.ps1"
            ],
            "related": [
                {
                    "id": "11b1ed55-154d-4e82-8ad7-83739298f720",
                    "type": "similar"
                }
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1003.003"
            ],
            "title": "NTDS.DIT Creation By Uncommon Parent Process"
        },
        {
            "id": "11b1ed55-154d-4e82-8ad7-83739298f720",
            "author": "Florian Roth (Nextron Systems), Nasreddine Bencherchali (Nextron Systems)",
            "date": "2022/01/11",
            "description": "Detects creation of a file named \"ntds.dit\" (Active Directory Database) by an uncommon process or a process located in a suspicious directory",
            "detection": {
                "condition": "selection_ntds and 1 of selection_process_*",
                "selection_ntds": {
                    "TargetFilename|endswith": "\\ntds.dit"
                },
                "selection_process_img": {
                    "Image|endswith": [
                        "\\cmd.exe",
                        "\\cscript.exe",
                        "\\mshta.exe",
                        "\\powershell.exe",
                        "\\pwsh.exe",
                        "\\regsvr32.exe",
                        "\\rundll32.exe",
                        "\\wscript.exe",
                        "\\wsl.exe",
                        "\\wt.exe"
                    ]
                },
                "selection_process_paths": {
                    "Image|contains": [
                        "\\AppData\\",
                        "\\Temp\\",
                        "\\Public\\",
                        "\\PerfLogs\\"
                    ]
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "level": "high",
            "logsource": {
                "category": "file_event",
                "product": "windows"
            },
            "modified": "2022/07/14",
            "references": [
                "https://stealthbits.com/blog/extracting-password-hashes-from-the-ntds-dit-file/",
                "https://adsecurity.org/?p=2398"
            ],
            "related": [
                {
                    "type": "similar",
                    "id": "4e7050dd-e548-483f-b7d6-527ab4fa784d"
                }
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1003.002",
                "attack.t1003.003"
            ],
            "title": "NTDS.DIT Creation By Uncommon Process"
        },
        {
            "author": "Teymur Kheirkhabarov, oscd.community",
            "date": "2019/11/01",
            "description": "Files with well-known filenames (parts of credential dump software or files produced by them) creation",
            "detection": {
                "condition": "selection",
                "selection": [
                    {
                        "TargetFilename|contains": [
                            "\\fgdump-log",
                            "\\kirbi",
                            "\\pwdump",
                            "\\pwhashes",
                            "\\wce_ccache",
                            "\\wce_krbtkts"
                        ]
                    },
                    {
                        "TargetFilename|endswith": [
                            "\\cachedump.exe",
                            "\\cachedump64.exe",
                            "\\DumpExt.dll",
                            "\\DumpSvc.exe",
                            "\\Dumpy.exe",
                            "\\fgexec.exe",
                            "\\lsremora.dll",
                            "\\lsremora64.dll",
                            "\\NTDS.out",
                            "\\procdump64.exe",
                            "\\pstgdump.exe",
                            "\\pwdump.exe",
                            "\\SAM.out",
                            "\\SECURITY.out",
                            "\\servpw.exe",
                            "\\servpw64.exe",
                            "\\SYSTEM.out",
                            "\\test.pwd",
                            "\\wceaux.dll"
                        ]
                    }
                ]
            },
            "falsepositives": [
                "Legitimate Administrator using tool for password recovery"
            ],
            "id": "8fbf3271-1ef6-4e94-8210-03c2317947f6",
            "level": "high",
            "logsource": {
                "category": "file_event",
                "product": "windows"
            },
            "modified": "2022/09/21",
            "references": [
                "https://www.slideshare.net/heirhabarov/hunting-for-credentials-dumping-in-windows-environment"
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1003.001",
                "attack.t1003.002",
                "attack.t1003.003",
                "attack.t1003.004",
                "attack.t1003.005"
            ],
            "title": "Cred Dump Tools Dropped Files"
        },
        {
            "author": "Florian Roth (Nextron Systems)",
            "date": "2022/03/11",
            "description": "Detects creation of files with specific name patterns seen used in various tools that export the NTDS.DIT for exfiltration.",
            "detection": {
                "condition": "selection",
                "selection": {
                    "TargetFilename|endswith": [
                        "\\All.cab",
                        ".ntds.cleartext"
                    ]
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "3a8da4e0-36c1-40d2-8b29-b3e890d5172a",
            "level": "high",
            "logsource": {
                "category": "file_event",
                "product": "windows"
            },
            "modified": "2023/05/05",
            "references": [
                "https://github.com/rapid7/metasploit-framework/blob/eb6535009f5fdafa954525687f09294918b5398d/modules/post/windows/gather/ntds_grabber.rb",
                "https://github.com/rapid7/metasploit-framework/blob/eb6535009f5fdafa954525687f09294918b5398d/data/post/powershell/NTDSgrab.ps1",
                "https://github.com/SecureAuthCorp/impacket/blob/7d2991d78836b376452ca58b3d14daa61b67cb40/impacket/examples/secretsdump.py#L2405"
            ],
            "status": "test",
            "title": "NTDS Exfiltration Filename Patterns",
            "tags": [
                "attack.credential_access",
                "attack.t1003.003"
            ]
        },
        {
            "author": "Nasreddine Bencherchali (Nextron Systems)",
            "date": "2023/05/05",
            "description": "Detects creation of a file named \"ntds.dit\" (Active Directory Database)",
            "detection": {
                "condition": "selection",
                "selection": {
                    "TargetFilename|endswith": "ntds.dit"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "0b8baa3f-575c-46ee-8715-d6f28cc7d33c",
            "level": "low",
            "logsource": {
                "category": "file_event",
                "product": "windows"
            },
            "references": [
                "Internal Research"
            ],
            "title": "NTDS.DIT Created",
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1003.003"
            ]
        },
        {
            "author": "Nasreddine Bencherchali (Nextron Systems)",
            "date": "2023/03/14",
            "description": "Detects the execution of Sysinternals ADExplorer with the \"-snapshot\" flag in order to save a local copy of the active directory database to a suspicious directory.",
            "detection": {
                "condition": "all of selection_*",
                "selection_flag": {
                    "CommandLine|contains": "snapshot"
                },
                "selection_img": [
                    {
                        "Image|endswith": "\\ADExplorer.exe"
                    },
                    {
                        "OriginalFileName": "AdExp"
                    }
                ],
                "selection_paths": {
                    "CommandLine|contains": [
                        "\\Downloads\\",
                        "\\Users\\Public\\",
                        "\\AppData\\",
                        "\\Windows\\Temp\\"
                    ]
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "ef61af62-bc74-4f58-b49b-626448227652",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "references": [
                "https://www.documentcloud.org/documents/5743766-Global-Threat-Report-2019.html"
            ],
            "related": [
                {
                    "id": "9212f354-7775-4e28-9c9f-8f0a4544e664",
                    "type": "derived"
                }
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1552.001",
                "attack.t1003.003"
            ],
            "title": "Suspicious Active Directory Database Snapshot Via ADExplorer"
        },
        {
            "author": "Teymur Kheirkhabarov, oscd.community",
            "date": "2019/10/22",
            "description": "Shadow Copies storage symbolic link creation using operating systems utilities",
            "detection": {
                "condition": "selection",
                "selection": {
                    "CommandLine|contains|all": [
                        "mklink",
                        "HarddiskVolumeShadowCopy"
                    ]
                }
            },
            "falsepositives": [
                "Legitimate administrator working with shadow copies, access for backup purposes"
            ],
            "id": "40b19fa6-d835-400c-b301-41f3a2baacaf",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/03/06",
            "references": [
                "https://www.slideshare.net/heirhabarov/hunting-for-credentials-dumping-in-windows-environment"
            ],
            "status": "stable",
            "title": "VolumeShadowCopy Symlink Creation Via Mklink",
            "tags": [
                "attack.credential_access",
                "attack.t1003.002",
                "attack.t1003.003"
            ]
        },
        {
            "author": "Nasreddine Bencherchali (Nextron Systems)",
            "date": "2022/09/14",
            "description": "Detects execution of ntdsutil.exe to perform different actions such as restoring snapshots...etc.",
            "detection": {
                "condition": "all of selection_*",
                "selection_cli": [
                    {
                        "CommandLine|contains|all": [
                            "snapshot",
                            "mount "
                        ]
                    },
                    {
                        "CommandLine|contains|all": [
                            "ac",
                            " i",
                            " ntds"
                        ]
                    }
                ],
                "selection_img": [
                    {
                        "Image|endswith": "\\ntdsutil.exe"
                    },
                    {
                        "OriginalFileName": "ntdsutil.exe"
                    }
                ]
            },
            "falsepositives": [
                "Legitimate usage to restore snapshots",
                "Legitimate admin activity"
            ],
            "id": "a58353df-af43-4753-bad0-cd83ef35eef5",
            "level": "medium",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "references": [
                "https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc731620(v=ws.11)",
                "https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/espionage-asia-governments"
            ],
            "related": [
                {
                    "id": "2afafd61-6aae-4df4-baed-139fa1f4c345",
                    "type": "derived"
                }
            ],
            "status": "test",
            "title": "Suspicious Usage Of Active Directory Diagnostic Tool (ntdsutil.exe)",
            "tags": [
                "attack.credential_access",
                "attack.t1003.003"
            ]
        },
        {
            "id": "9212f354-7775-4e28-9c9f-8f0a4544e664",
            "author": "Nasreddine Bencherchali (Nextron Systems)",
            "date": "2023/03/14",
            "description": "Detects the execution of Sysinternals ADExplorer with the \"-snapshot\" flag in order to save a local copy of the active directory database.",
            "detection": {
                "condition": "all of selection_*",
                "selection_cli": {
                    "CommandLine|contains": "snapshot"
                },
                "selection_img": [
                    {
                        "Image|endswith": "\\ADExplorer.exe"
                    },
                    {
                        "OriginalFileName": "AdExp"
                    }
                ]
            },
            "falsepositives": [
                "Unknown"
            ],
            "level": "medium",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "references": [
                "https://www.documentcloud.org/documents/5743766-Global-Threat-Report-2019.html"
            ],
            "related": [
                {
                    "type": "derived",
                    "id": "ef61af62-bc74-4f58-b49b-626448227652"
                }
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1552.001",
                "attack.t1003.003"
            ],
            "title": "Active Directory Database Snapshot Via ADExplorer"
        },
        {
            "author": "Florian Roth (Nextron Systems)",
            "date": "2022/03/11",
            "description": "Detects suspicious process patterns used in NTDS.DIT exfiltration",
            "detection": {
                "condition": "1 of selection* or all of set1*",
                "selection_oneliner_1": {
                    "CommandLine|contains|all": [
                        "ac i ntds",
                        "create full"
                    ]
                },
                "selection_onliner_2": {
                    "CommandLine|contains|all": [
                        "/c copy ",
                        "\\windows\\ntds\\ntds.dit"
                    ]
                },
                "selection_onliner_3": {
                    "CommandLine|contains|all": [
                        "activate instance ntds",
                        "create full"
                    ]
                },
                "selection_powershell": {
                    "CommandLine|contains|all": [
                        "powershell",
                        "ntds.dit"
                    ]
                },
                "selection_tool": [
                    {
                        "Image|endswith": [
                            "\\NTDSDump.exe",
                            "\\NTDSDumpEx.exe"
                        ]
                    },
                    {
                        "CommandLine|contains|all": [
                            "ntds.dit",
                            "system.hiv"
                        ]
                    },
                    {
                        "CommandLine|contains": "NTDSgrab.ps1"
                    }
                ],
                "set1_selection_image_folder": [
                    {
                        "ParentImage|contains": [
                            "\\apache",
                            "\\tomcat",
                            "\\AppData\\",
                            "\\Temp\\",
                            "\\Public\\",
                            "\\PerfLogs\\"
                        ]
                    },
                    {
                        "Image|contains": [
                            "\\apache",
                            "\\tomcat",
                            "\\AppData\\",
                            "\\Temp\\",
                            "\\Public\\",
                            "\\PerfLogs\\"
                        ]
                    }
                ],
                "set1_selection_ntds_dit": {
                    "CommandLine|contains": "ntds.dit"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "8bc64091-6875-4881-aaf9-7bd25b5dda08",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2022/11/10",
            "references": [
                "https://www.ired.team/offensive-security/credential-access-and-credential-dumping/ntds.dit-enumeration",
                "https://www.n00py.io/2022/03/manipulating-user-passwords-without-mimikatz/",
                "https://pentestlab.blog/tag/ntds-dit/",
                "https://github.com/samratashok/nishang/blob/414ee1104526d7057f9adaeee196d91ae447283e/Gather/Copy-VSS.ps1",
                "https://github.com/zcgonvh/NTDSDumpEx",
                "https://github.com/rapid7/metasploit-framework/blob/d297adcebb5c1df6fe30b12ca79b161deb71571c/data/post/powershell/NTDSgrab.ps1",
                "https://blog.talosintelligence.com/2022/08/recent-cyber-attack.html?m=1"
            ],
            "status": "test",
            "title": "Suspicious Process Patterns NTDS.DIT Exfil",
            "tags": [
                "attack.credential_access",
                "attack.t1003.003"
            ]
        },
        {
            "author": "sam0x90",
            "date": "2021/08/06",
            "description": "Conti recommendation to its affiliates to use esentutl to access NTDS dumped file. Trickbot also uses this utilities to get MSEdge info via its module pwgrab.",
            "detection": {
                "condition": "selection",
                "selection": {
                    "CommandLine|contains|all": [
                        "esentutl",
                        " /p"
                    ]
                }
            },
            "falsepositives": [
                "To be determined"
            ],
            "fields": [
                "User",
                "CommandLine",
                "ParentCommandLine",
                "CurrentDirectory"
            ],
            "id": "7df1713a-1a5b-4a4b-a071-dc83b144a101",
            "level": "medium",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2022/10/09",
            "references": [
                "https://twitter.com/vxunderground/status/1423336151860002816",
                "https://attack.mitre.org/software/S0404/",
                "https://thedfirreport.com/2021/08/01/bazarcall-to-conti-ransomware-via-trickbot-and-cobalt-strike/"
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1003",
                "attack.t1003.003"
            ],
            "title": "Esentutl Gather Credentials"
        },
        {
            "author": "Furkan Caliskan (@caliskanfurkan_)",
            "date": "2020/07/04",
            "description": "Detects the use of Ditsnap tool, an inspection tool for Active Directory database, ntds.dit.",
            "detection": {
                "condition": "selection",
                "selection": [
                    {
                        "Image|endswith": "\\ditsnap.exe"
                    },
                    {
                        "CommandLine|contains": "ditsnap.exe"
                    }
                ]
            },
            "falsepositives": [
                "Legitimate admin usage"
            ],
            "id": "d3b70aad-097e-409c-9df2-450f80dc476b",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/02/21",
            "references": [
                "https://thedfirreport.com/2020/06/21/snatch-ransomware/",
                "https://web.archive.org/web/20201124182207/https://github.com/yosqueoy/ditsnap"
            ],
            "status": "test",
            "title": "PUA - DIT Snapshot Viewer",
            "tags": [
                "attack.credential_access",
                "attack.t1003.003"
            ]
        },
        {
            "author": "Nasreddine Bencherchali (Nextron Systems), frack113",
            "date": "2024/05/10",
            "description": "Detects the dump of highly sensitive files such as \"NTDS.DIT\" and \"SECURITY\" hive.\nAttackers can leverage the \"wbadmin\" utility in order to dump sensitive files that might contain credential or sensitive information.\n",
            "detection": {
                "condition": "all of selection_*",
                "selection_backup": {
                    "CommandLine|contains": [
                        "start",
                        "backup"
                    ]
                },
                "selection_img": [
                    {
                        "Image|endswith": "\\wbadmin.exe"
                    },
                    {
                        "OriginalFileName": "WBADMIN.EXE"
                    }
                ],
                "selection_path": {
                    "CommandLine|contains": [
                        "\\config\\SAM",
                        "\\config\\SECURITY",
                        "\\config\\SYSTEM",
                        "\\Windows\\NTDS\\NTDS.dit"
                    ]
                }
            },
            "falsepositives": [
                "Legitimate backup operation by authorized administrators. Matches must be investigated and allowed on a case by case basis."
            ],
            "id": "8b93a509-1cb8-42e1-97aa-ee24224cdc15",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "references": [
                "https://github.com/LOLBAS-Project/LOLBAS/blob/2cc01b01132b5c304027a658c698ae09dd6a92bf/yml/OSBinaries/Wbadmin.yml",
                "https://lolbas-project.github.io/lolbas/Binaries/Wbadmin/",
                "https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/wbadmin-start-recovery",
                "https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/wbadmin-start-backup"
            ],
            "status": "experimental",
            "title": "Sensitive File Dump Via Wbadmin.EXE",
            "tags": [
                "attack.credential_access",
                "attack.t1003.003"
            ]
        },
        {
            "author": "Teymur Kheirkhabarov, Daniil Yugoslavskiy, oscd.community",
            "date": "2019/10/22",
            "description": "Shadow Copies creation using operating systems utilities, possible credential access",
            "detection": {
                "condition": "all of selection_*",
                "selection_cli": {
                    "CommandLine|contains|all": [
                        "shadow",
                        "create"
                    ]
                },
                "selection_img": [
                    {
                        "Image|endswith": [
                            "\\powershell.exe",
                            "\\pwsh.exe",
                            "\\wmic.exe",
                            "\\vssadmin.exe"
                        ]
                    },
                    {
                        "OriginalFileName": [
                            "PowerShell.EXE",
                            "pwsh.dll",
                            "wmic.exe",
                            "VSSADMIN.EXE"
                        ]
                    }
                ]
            },
            "falsepositives": [
                "Legitimate administrator working with shadow copies, access for backup purposes"
            ],
            "id": "b17ea6f7-6e90-447e-a799-e6c0a493d6ce",
            "level": "medium",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2022/11/10",
            "references": [
                "https://www.slideshare.net/heirhabarov/hunting-for-credentials-dumping-in-windows-environment",
                "https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/tutorial-for-ntds-goodness-vssadmin-wmis-ntdsdit-system/"
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1003",
                "attack.t1003.002",
                "attack.t1003.003"
            ],
            "title": "Shadow Copies Creation Using Operating Systems Utilities"
        },
        {
            "author": "Nasreddine Bencherchali (Nextron Systems), frack113",
            "date": "2024/05/10",
            "description": "Detects the dump of highly sensitive files such as \"NTDS.DIT\" and \"SECURITY\" hive.\nAttackers can leverage the \"wbadmin\" utility in order to dump sensitive files that might contain credential or sensitive information.\n",
            "detection": {
                "condition": "all of selection_*",
                "selection_backup": {
                    "CommandLine|contains": [
                        "\\config\\SAM",
                        "\\config\\SECURITY",
                        "\\config\\SYSTEM",
                        "\\Windows\\NTDS\\NTDS.dit"
                    ],
                    "CommandLine|contains|all": [
                        " recovery",
                        "recoveryTarget",
                        "itemtype:File"
                    ]
                },
                "selection_img": [
                    {
                        "Image|endswith": "\\wbadmin.exe"
                    },
                    {
                        "OriginalFileName": "WBADMIN.EXE"
                    }
                ]
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "84972c80-251c-4c3a-9079-4f00aad93938",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "references": [
                "https://github.com/LOLBAS-Project/LOLBAS/blob/2cc01b01132b5c304027a658c698ae09dd6a92bf/yml/OSBinaries/Wbadmin.yml",
                "https://lolbas-project.github.io/lolbas/Binaries/Wbadmin/",
                "https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/wbadmin-start-recovery",
                "https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/wbadmin-start-backup"
            ],
            "related": [
                {
                    "id": "6fe4aa1e-0531-4510-8be2-782154b73b48",
                    "type": "derived"
                }
            ],
            "status": "experimental",
            "title": "Sensitive File Recovery From Backup Via Wbadmin.EXE",
            "tags": [
                "attack.credential_access",
                "attack.t1003.003"
            ]
        },
        {
            "id": "2afafd61-6aae-4df4-baed-139fa1f4c345",
            "author": "Thomas Patzke",
            "date": "2019/01/16",
            "description": "Detects execution of ntdsutil.exe, which can be used for various attacks against the NTDS database (NTDS.DIT)",
            "detection": {
                "condition": "selection",
                "selection": {
                    "Image|endswith": "\\ntdsutil.exe"
                }
            },
            "falsepositives": [
                "NTDS maintenance"
            ],
            "level": "medium",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2022/03/11",
            "references": [
                "https://jpcertcc.github.io/ToolAnalysisResultSheet/details/ntdsutil.htm"
            ],
            "status": "test",
            "title": "Invocation of Active Directory Diagnostic Tool (ntdsutil.exe)",
            "tags": [
                "attack.credential_access",
                "attack.t1003.003"
            ]
        },
        {
            "author": "Teymur Kheirkhabarov, Daniil Yugoslavskiy, oscd.community",
            "date": "2019/10/22",
            "description": "Files with well-known filenames (sensitive files with credential data) copying",
            "detection": {
                "condition": "all of selection_esent_* or selection_susp_paths",
                "selection_esent_cli": {
                    "CommandLine|contains|windash": [
                        "vss",
                        " /m ",
                        " /y "
                    ]
                },
                "selection_esent_img": [
                    {
                        "Image|endswith": "\\esentutl.exe"
                    },
                    {
                        "OriginalFileName": "\\esentutl.exe"
                    }
                ],
                "selection_susp_paths": {
                    "CommandLine|contains": [
                        "\\config\\RegBack\\sam",
                        "\\config\\RegBack\\security",
                        "\\config\\RegBack\\system",
                        "\\config\\sam",
                        "\\config\\security",
                        "\\config\\system ",
                        "\\repair\\sam",
                        "\\repair\\security",
                        "\\repair\\system",
                        "\\windows\\ntds\\ntds.dit"
                    ]
                }
            },
            "falsepositives": [
                "Copying sensitive files for legitimate use (eg. backup) or forensic investigation by legitimate incident responder or forensic investigator."
            ],
            "id": "e7be6119-fc37-43f0-ad4f-1f3f99be2f9f",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2024/06/04",
            "references": [
                "https://room362.com/post/2013/2013-06-10-volume-shadow-copy-ntdsdit-domain-hashes-remotely-part-1/",
                "https://www.slideshare.net/heirhabarov/hunting-for-credentials-dumping-in-windows-environment",
                "https://dfironthemountain.wordpress.com/2018/12/06/locked-file-access-using-esentutl-exe/",
                "https://github.com/LOLBAS-Project/LOLBAS/blob/2cc01b01132b5c304027a658c698ae09dd6a92bf/yml/OSBinaries/Esentutl.yml"
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1003.002",
                "attack.t1003.003",
                "car.2013-07-001",
                "attack.s0404"
            ],
            "title": "Copying Sensitive Files with Credential Data"
        },
        {
            "author": "Nasreddine Bencherchali (Nextron Systems)",
            "date": "2022/08/14",
            "description": "Detects potential abuse of ntdsutil to dump ntds.dit database",
            "detection": {
                "condition": "selection",
                "selection": {
                    "Data|contains": "ntds.dit",
                    "EventID": [
                        216,
                        325,
                        326,
                        327
                    ],
                    "Provider_Name": "ESENT"
                }
            },
            "falsepositives": [
                "Legitimate backup operation/creating shadow copies"
            ],
            "id": "e6e88853-5f20-4c4a-8d26-cd469fd8d31f",
            "level": "medium",
            "logsource": {
                "service": "application",
                "product": "windows"
            },
            "references": [
                "https://twitter.com/mgreen27/status/1558223256704122882",
                "https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/jj574207(v=ws.11)"
            ],
            "title": "Ntdsutil Abuse",
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1003.003"
            ]
        },
        {
            "id": "910ab938-668b-401b-b08c-b596e80fdca5",
            "author": "Teymur Kheirkhabarov, oscd.community",
            "date": "2019/10/22",
            "description": "Transferring files with well-known filenames (sensitive files with credential data) using network shares",
            "detection": {
                "condition": "selection",
                "selection": {
                    "EventID": 5145,
                    "RelativeTargetName|contains": [
                        "\\mimidrv",
                        "\\lsass",
                        "\\windows\\minidump\\",
                        "\\hiberfil",
                        "\\sqldmpr",
                        "\\sam",
                        "\\ntds.dit",
                        "\\security"
                    ]
                }
            },
            "falsepositives": [
                "Transferring sensitive files for legitimate administration work by legitimate administrator"
            ],
            "level": "medium",
            "logsource": {
                "service": "security",
                "product": "windows"
            },
            "modified": "2021/11/30",
            "references": [
                "https://www.slideshare.net/heirhabarov/hunting-for-credentials-dumping-in-windows-environment"
            ],
            "related": [
                {
                    "type": "similar",
                    "id": "2e69f167-47b5-4ae7-a390-47764529eff5"
                }
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1003.002",
                "attack.t1003.001",
                "attack.t1003.003"
            ],
            "title": "Transferring Files with Credential Data via Network Shares"
        },
        {
            "author": "Samir Bousseaden, wagga",
            "date": "2019/04/03",
            "description": "Detect AD credential dumping using impacket secretdump HKTL",
            "detection": {
                "condition": "selection",
                "selection": {
                    "EventID": 5145,
                    "RelativeTargetName|contains|all": [
                        "SYSTEM32\\",
                        ".tmp"
                    ],
                    "ShareName": "\\\\\\\\\\*\\\\ADMIN$"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "252902e3-5830-4cf6-bf21-c22083dfd5cf",
            "level": "high",
            "logsource": {
                "definition": "The advanced audit policy setting \"Object Access > Audit Detailed File Share\" must be configured for Success/Failure",
                "service": "security",
                "product": "windows"
            },
            "modified": "2022/08/11",
            "references": [
                "https://blog.menasec.net/2019/02/threat-huting-10-impacketsecretdump.html"
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1003.002",
                "attack.t1003.004",
                "attack.t1003.003"
            ],
            "title": "Possible Impacket SecretDump Remote Activity"
        },
        {
            "author": "frack113",
            "date": "2022/01/12",
            "description": "Adversaries may attempt to access or create a copy of the Active Directory domain database in order to steal credential information",
            "detection": {
                "condition": "selection",
                "selection": {
                    "ScriptBlockText|contains|all": [
                        "Win32_ShadowCopy",
                        ").Create(",
                        "ClientAccessible"
                    ]
                }
            },
            "falsepositives": [
                "Legitimate PowerShell scripts"
            ],
            "id": "afd12fed-b0ec-45c9-a13d-aa86625dac81",
            "level": "high",
            "logsource": {
                "category": "ps_script",
                "definition": "Requirements: Script Block Logging must be enabled",
                "product": "windows"
            },
            "references": [
                "https://attack.mitre.org/datasources/DS0005/",
                "https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-wmiobject?view=powershell-5.1&viewFallbackFrom=powershell-7"
            ],
            "title": "Create Volume Shadow Copy with Powershell",
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1003.003"
            ]
        },
        {
            "author": "Florian Roth (Nextron Systems)",
            "date": "2022/03/16",
            "description": "Detects suspicious invocation of the Get-ADDBAccount script that reads from a ntds.dit file and may be used to get access to credentials without using any credential dumpers",
            "detection": {
                "condition": "selection",
                "selection": {
                    "Payload|contains|all": [
                        "Get-ADDBAccount",
                        "BootKey ",
                        "DatabasePath "
                    ]
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "b140afd9-474b-4072-958e-2ebb435abd68",
            "level": "high",
            "logsource": {
                "category": "ps_module",
                "definition": "0ad03ef1-f21b-4a79-8ce8-e6900c54b65b",
                "product": "windows"
            },
            "references": [
                "https://www.n00py.io/2022/03/manipulating-user-passwords-without-mimikatz/",
                "https://github.com/MichaelGrafnetter/DSInternals/blob/7ba59c12ee9a1cb430d7dc186a3366842dd612c8/Documentation/PowerShell/Get-ADDBAccount.md"
            ],
            "title": "Suspicious Get-ADDBAccount Usage",
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1003.003"
            ]
        }
    ]
}