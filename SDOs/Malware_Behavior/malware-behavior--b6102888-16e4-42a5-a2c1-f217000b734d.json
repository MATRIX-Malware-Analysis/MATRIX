{
    "type": "malware-behavior",
    "spec_version": "2.1",
    "id": "malware-behavior--b6102888-16e4-42a5-a2c1-f217000b734d",
    "created": "2024-08-13T14:46:37.041279Z",
    "modified": "2024-08-13T14:46:48.556285Z",
    "name": "Event Triggered Execution: AppInit DLLs",
    "description": "Adversaries may establish persistence and/or elevate privileges by executing malicious content triggered by AppInit DLLs loaded into processes. Dynamic-link libraries (DLLs) that are specified in the AppInit_DLLs value in the Registry keys HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Windows or HKEY_LOCAL_MACHINE\\Software\\Wow6432Node\\Microsoft\\Windows NT\\CurrentVersion\\Windows are loaded by user32.dll into every process that loads user32.dll. In practice this is nearly every program, since user32.dll is a very common library. [1]Similar to Process Injection, these values can be abused to obtain elevated privileges by causing a malicious DLL to be loaded and run in the context of separate processes on the computer. [2] Malicious AppInit DLLs may also provide persistence by continuously being triggered by API activity. The AppInit DLL functionality is disabled in Windows 8 and later versions when secure boot is enabled. [3]",
    "object_marking_refs": [
        "marking-definition--613f2e26-407d-48c7-9eca-b8e91df99dc9"
    ],
    "external_references": [
        {
            "source_name": "MITRE ATT&CK",
            "url": "https://attack.mitre.org/techniques/T1546/010",
            "external_id": "T1546/010"
        }
    ],
    "x_mitre_capa_rules": [
        {
            "rule": {
                "features": [
                    {
                        "and": [
                            {
                                "or": [
                                    {
                                        "match": "set registry value"
                                    },
                                    {
                                        "number": "0x80000002 = HKEY_LOCAL_MACHINE"
                                    }
                                ]
                            },
                            {
                                "or": [
                                    {
                                        "string": "/Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows/i"
                                    },
                                    {
                                        "string": "/Software\\\\Wow6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows/i"
                                    }
                                ]
                            },
                            {
                                "string": "/AppInit_DLLs/i"
                            },
                            {
                                "optional": [
                                    {
                                        "description": "enable AppInit DLLs feature",
                                        "string": "/LoadAppInit_DLLs/i"
                                    }
                                ]
                            }
                        ]
                    }
                ],
                "meta": {
                    "att&ck": [
                        "Persistence::Event Triggered Execution::AppInit DLLs [T1546.010]"
                    ],
                    "authors": [
                        "michael.hunhoff@fireye.com"
                    ],
                    "examples": [
                        "Practical Malware Analysis Lab 11-02.dll_:0x1000158b"
                    ],
                    "name": "persist via AppInit_DLLs registry key",
                    "namespace": "persistence/registry/appinitdlls",
                    "references": [
                        "https://docs.microsoft.com/en-us/windows/win32/win7appqual/appinit-dlls-in-windows-7-and-windows-server-2008-r2"
                    ],
                    "scopes": {
                        "dynamic": "thread",
                        "static": "function"
                    }
                }
            }
        },
        {
            "rule": {
                "features": [
                    {
                        "and": [
                            {
                                "description": "disable DLL code signature enforcement",
                                "string": "/RequireSignedAppInit_DLLs/i"
                            },
                            {
                                "number": "0 = state disabled"
                            },
                            {
                                "or": [
                                    {
                                        "match": "set registry value"
                                    },
                                    {
                                        "number": "0x80000002 = HKEY_LOCAL_MACHINE"
                                    }
                                ]
                            },
                            {
                                "or": [
                                    {
                                        "string": "/Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows/i"
                                    },
                                    {
                                        "string": "/Software\\\\Wow6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows/i"
                                    }
                                ]
                            }
                        ]
                    }
                ],
                "meta": {
                    "att&ck": [
                        "Persistence::Event Triggered Execution::AppInit DLLs [T1546.010]",
                        "Defense Evasion::Subvert Trust Controls::Code Signing Policy Modification [T1553.006]"
                    ],
                    "authors": [
                        "william.ballenthin@fireye.com"
                    ],
                    "examples": [
                        "58ADC2E97FBEE01B71073CCD7FF1B9A4:0x401350"
                    ],
                    "name": "disable AppInit_DLLs code signature enforcement",
                    "namespace": "persistence/registry/appinitdlls",
                    "references": [
                        "https://docs.microsoft.com/en-us/windows/win32/win7appqual/appinit-dlls-in-windows-7-and-windows-server-2008-r2"
                    ],
                    "scopes": {
                        "dynamic": "thread",
                        "static": "function"
                    }
                }
            }
        }
    ],
    "x_mitre_detection_rules": [
        {
            "author": "Ilyas Ochkov, oscd.community, Tim Shelton",
            "date": "2019/10/25",
            "description": "DLLs that are specified in the AppInit_DLLs value in the Registry key HKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Windows are loaded by user32.dll into every process that loads user32.dll",
            "detection": {
                "condition": "selection and not filter",
                "filter": {
                    "Details": "(Empty)"
                },
                "selection": [
                    {
                        "TargetObject|endswith": [
                            "\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\AppInit_Dlls",
                            "\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\AppInit_Dlls"
                        ]
                    },
                    {
                        "NewName|endswith": [
                            "\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\AppInit_Dlls",
                            "\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\AppInit_Dlls"
                        ]
                    }
                ]
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "4f84b697-c9ed-4420-8ab5-e09af5b2345d",
            "level": "medium",
            "logsource": {
                "category": "registry_event",
                "product": "windows"
            },
            "modified": "2022/12/25",
            "references": [
                "https://eqllib.readthedocs.io/en/latest/analytics/822dc4c5-b355-4df8-bd37-29c458997b8f.html"
            ],
            "status": "test",
            "tags": [
                "attack.persistence",
                "attack.t1546.010"
            ],
            "title": "New DLL Added to AppInit_DLLs Registry Key"
        }
    ]
}