{
    "type": "malware-behavior",
    "spec_version": "2.1",
    "id": "malware-behavior--cd8d87e2-6ee9-4714-9b00-49b9a660877b",
    "created": "2024-08-13T14:46:36.684307Z",
    "modified": "2024-08-13T14:46:48.672946Z",
    "name": "Event Triggered Execution: Unix Shell Configuration Modification",
    "description": "Adversaries may establish persistence through executing malicious commands triggered by a user\u2019s shell. User Unix Shells execute several configuration scripts at different points throughout the session based on events. For example, when a user opens a command-line interface or remotely logs in (such as via SSH) a login shell is initiated. The login shell executes scripts from the system (/etc) and the user\u2019s home directory (~/) to configure the environment. All login shells on a system use /etc/profile when initiated. These configuration scripts run at the permission level of their directory and are often used to set environment variables, create aliases, and customize the user\u2019s environment. When the shell exits or terminates, additional shell scripts are executed to ensure the shell exits appropriately. Adversaries may attempt to establish persistence by inserting commands into scripts automatically executed by shells. Using bash as an example, the default shell for most GNU/Linux systems, adversaries may add commands that launch malicious binaries into the /etc/profile and /etc/profile.d files.[1][2] These files typically require root permissions to modify and are executed each time any shell on a system launches. For user level permissions, adversaries can insert malicious commands into ~/.bash_profile, ~/.bash_login, or ~/.profile which are sourced when a user opens a command-line interface or connects remotely.[3][4] Since the system only executes the first existing file in the listed order, adversaries have used ~/.bash_profile to ensure execution. Adversaries have also leveraged the ~/.bashrc file which is additionally executed if the connection is established remotely or an additional interactive shell is opened, such as a new tab in the command-line interface.[5][3][6][7] Some malware targets the termination of a program to trigger execution, adversaries can use the ~/.bash_logout file to execute malicious commands at the end of a session. For macOS, the functionality of this technique is similar but may leverage zsh, the default shell for macOS 10.15+. When the Terminal.app is opened, the application launches a zsh login shell and a zsh interactive shell. The login shell configures the system environment using /etc/profile, /etc/zshenv, /etc/zprofile, and /etc/zlogin.[8][9][10][11] The login shell then configures the user environment with ~/.zprofile and ~/.zlogin. The interactive shell uses the ~/.zshrc to configure the user environment. Upon exiting, /etc/zlogout and ~/.zlogout are executed. For legacy programs, macOS executes /etc/bashrc on startup.",
    "object_marking_refs": [
        "marking-definition--613f2e26-407d-48c7-9eca-b8e91df99dc9"
    ],
    "external_references": [
        {
            "source_name": "MITRE ATT&CK",
            "url": "https://attack.mitre.org/techniques/T1546/004",
            "external_id": "T1546/004"
        },
        {
            "source_name": "CAPEC 19",
            "external_id": "malware-behavior--52a108cc-fd05-4833-810d-9fe99133e493"
        }
    ],
    "x_mitre_capa_rules": [
        {
            "rule": {
                "features": [
                    {
                        "and": [
                            {
                                "os": "linux"
                            },
                            {
                                "match": "host-interaction/file-system/write"
                            },
                            {
                                "or": [
                                    {
                                        "substring": "/.bash_profile"
                                    },
                                    {
                                        "substring": "/.bash_login"
                                    },
                                    {
                                        "substring": "/.bashrc"
                                    },
                                    {
                                        "substring": "/.profile"
                                    },
                                    {
                                        "substring": "/etc/profile.d/"
                                    },
                                    {
                                        "string": "/etc/profile"
                                    }
                                ]
                            }
                        ]
                    }
                ],
                "meta": {
                    "att&ck": [
                        "Persistence::Event Triggered Execution::Unix Shell Configuration Modification [T1546.004]"
                    ],
                    "authors": [
                        "joakim@intezer.com"
                    ],
                    "examples": [
                        "7351f8a40c5450557b24622417fc478d:0x407D11"
                    ],
                    "name": "persist via shell profile or rc file",
                    "namespace": "persistence",
                    "scopes": {
                        "dynamic": "thread",
                        "static": "function"
                    }
                }
            }
        }
    ],
    "x_mitre_detection_rules": [
        {
            "author": "Peter Matkovski, IAI",
            "date": "2023/03/06",
            "description": "Detect unix shell configuration modification. Adversaries may establish persistence through executing malicious commands triggered when a new shell is opened.",
            "detection": {
                "condition": "selection",
                "selection": {
                    "name": [
                        "/etc/shells",
                        "/etc/profile",
                        "/etc/profile.d/*",
                        "/etc/bash.bashrc",
                        "/etc/bashrc",
                        "/etc/zsh/zprofile",
                        "/etc/zsh/zshrc",
                        "/etc/zsh/zlogin",
                        "/etc/zsh/zlogout",
                        "/etc/csh.cshrc",
                        "/etc/csh.login",
                        "/root/.bashrc",
                        "/root/.bash_profile",
                        "/root/.profile",
                        "/root/.zshrc",
                        "/root/.zprofile",
                        "/home/*/.bashrc",
                        "/home/*/.zshrc",
                        "/home/*/.bash_profile",
                        "/home/*/.zprofile",
                        "/home/*/.profile",
                        "/home/*/.bash_login",
                        "/home/*/.bash_logout",
                        "/home/*/.zlogin",
                        "/home/*/.zlogout"
                    ],
                    "type": "PATH"
                }
            },
            "falsepositives": [
                "Admin or User activity are expected to generate some false positives"
            ],
            "id": "a94cdd87-6c54-4678-a6cc-2814ffe5a13d",
            "level": "medium",
            "logsource": {
                "product": "linux",
                "service": "auditd"
            },
            "modified": "2023/03/15",
            "references": [
                "https://objective-see.org/blog/blog_0x68.html",
                "https://www.glitch-cat.com/p/green-lambert-and-attack",
                "https://www.anomali.com/blog/pulling-linux-rabbit-rabbot-malware-out-of-a-hat"
            ],
            "related": [
                {
                    "id": "e74e15cc-c4b6-4c80-b7eb-dfe49feb7fe9",
                    "type": "obsoletes"
                }
            ],
            "status": "test",
            "tags": [
                "attack.persistence",
                "attack.t1546.004"
            ],
            "title": "Unix Shell Configuration Modification"
        }
    ]
}