{
    "type": "malware-behavior",
    "spec_version": "2.1",
    "id": "malware-behavior--a8bc2369-a68e-43c5-ac1a-a2a939215ef9",
    "created": "2024-08-13T14:46:36.684307Z",
    "modified": "2024-08-13T14:46:48.355898Z",
    "name": "Query Registry",
    "description": "Adversaries may interact with the Windows Registry to gather information about the system, configuration, and installed software.The Registry contains a significant amount of information about the operating system, configuration, software, and security.[1] Information can easily be queried using the Reg utility, though other means to access the Registry exist. Some of the information may help adversaries to further their operation within a network. Adversaries may use the information from Query Registry during automated discovery to shape follow-on behaviors, including whether or not the adversary fully infects the target and/or attempts specific actions.",
    "object_marking_refs": [
        "marking-definition--613f2e26-407d-48c7-9eca-b8e91df99dc9"
    ],
    "external_references": [
        {
            "source_name": "MITRE ATT&CK",
            "url": "https://attack.mitre.org/techniques/T1012",
            "external_id": "T1012"
        },
        {
            "source_name": "CAPEC 647",
            "external_id": "malware-behavior--0527bb68-b171-4c23-bbfd-e0136c976629"
        },
        {
            "source_name": "mitre-attack",
            "url": "https://attack.mitre.org/techniques/T1012",
            "external_id": "T1012"
        },
        {
            "source_name": "Wikipedia Windows Registry",
            "description": "Wikipedia. (n.d.). Windows Registry. Retrieved February 2, 2015.",
            "url": "https://en.wikipedia.org/wiki/Windows_Registry"
        }
    ],
    "x_mitre_capa_rules": [
        {
            "rule": {
                "features": [
                    {
                        "and": [
                            {
                                "api": "ORGetValue"
                            }
                        ]
                    }
                ],
                "meta": {
                    "att&ck": [
                        "Discovery::Query Registry [T1012]"
                    ],
                    "authors": [
                        "johnk3r"
                    ],
                    "examples": [
                        "5fbbfeed28b258c42e0cfeb16718b31c:0x42388C"
                    ],
                    "mbc": [
                        "Operating System::Registry::Query Registry Value [C0036.006]"
                    ],
                    "name": "query registry key via offline registry library",
                    "namespace": "host-interaction/registry",
                    "scopes": {
                        "dynamic": "call",
                        "static": "function"
                    }
                }
            }
        },
        {
            "rule": {
                "features": [
                    {
                        "and": [
                            {
                                "optional": [
                                    {
                                        "match": "create or open registry key"
                                    }
                                ]
                            },
                            {
                                "or": [
                                    {
                                        "api": "advapi32.RegEnumKey"
                                    },
                                    {
                                        "api": "advapi32.RegEnumKeyEx"
                                    },
                                    {
                                        "api": "advapi32.RegQueryInfoKeyA"
                                    },
                                    {
                                        "api": "ZwQueryKey"
                                    },
                                    {
                                        "api": "ZwEnumerateKey"
                                    },
                                    {
                                        "api": "NtQueryKey"
                                    },
                                    {
                                        "api": "NtEnumerateKey"
                                    },
                                    {
                                        "api": "RtlCheckRegistryKey"
                                    },
                                    {
                                        "api": "SHEnumKeyEx"
                                    },
                                    {
                                        "api": "SHQueryInfoKey"
                                    },
                                    {
                                        "api": "SHRegEnumUSKey"
                                    },
                                    {
                                        "api": "SHRegQueryInfoUSKey"
                                    },
                                    {
                                        "api": "Microsoft.Win32.RegistryKey::GetSubKeyNames"
                                    },
                                    {
                                        "api": "Microsoft.Win32.RegistryKey::OpenBaseKey"
                                    },
                                    {
                                        "api": "Microsoft.Win32.RegistryKey::OpenRemoteBaseKey"
                                    },
                                    {
                                        "api": "Microsoft.Win32.RegistryKey::OpenSubKey"
                                    }
                                ]
                            }
                        ]
                    }
                ],
                "meta": {
                    "att&ck": [
                        "Discovery::Query Registry [T1012]"
                    ],
                    "authors": [
                        "michael.hunhoff@mandiant.com"
                    ],
                    "examples": [
                        "493167E85E45363D09495D0841C30648:0x404930",
                        "B5F85C26D7AA5A1FB4AF5821B6B5AB9B:0x402608"
                    ],
                    "mbc": [
                        "Operating System::Registry::Query Registry Key [C0036.005]"
                    ],
                    "name": "query or enumerate registry key",
                    "namespace": "host-interaction/registry",
                    "scopes": {
                        "dynamic": "thread",
                        "static": "function"
                    }
                }
            }
        },
        {
            "rule": {
                "features": [
                    {
                        "and": [
                            {
                                "optional": [
                                    {
                                        "match": "create or open registry key"
                                    }
                                ]
                            },
                            {
                                "or": [
                                    {
                                        "api": "advapi32.RegGetValue"
                                    },
                                    {
                                        "api": "advapi32.RegEnumValue"
                                    },
                                    {
                                        "api": "advapi32.RegQueryValue"
                                    },
                                    {
                                        "api": "advapi32.RegQueryValueEx"
                                    },
                                    {
                                        "api": "advapi32.RegQueryMultipleValues"
                                    },
                                    {
                                        "api": "ZwQueryValueKey"
                                    },
                                    {
                                        "api": "ZwEnumerateValueKey"
                                    },
                                    {
                                        "api": "NtQueryValueKey"
                                    },
                                    {
                                        "api": "NtEnumerateValueKey"
                                    },
                                    {
                                        "api": "RtlQueryRegistryValues"
                                    },
                                    {
                                        "api": "SHGetValue"
                                    },
                                    {
                                        "api": "SHEnumValue"
                                    },
                                    {
                                        "api": "SHRegGetInt"
                                    },
                                    {
                                        "api": "SHRegGetPath"
                                    },
                                    {
                                        "api": "SHRegGetValue"
                                    },
                                    {
                                        "api": "SHQueryValueEx"
                                    },
                                    {
                                        "api": "SHRegGetUSValue"
                                    },
                                    {
                                        "api": "SHOpenRegStream"
                                    },
                                    {
                                        "api": "SHRegEnumUSValue"
                                    },
                                    {
                                        "api": "SHOpenRegStream2"
                                    },
                                    {
                                        "api": "SHRegQueryUSValue"
                                    },
                                    {
                                        "api": "SHRegGetBoolUSValue"
                                    },
                                    {
                                        "api": "SHRegGetValueFromHKCUHKLM"
                                    },
                                    {
                                        "api": "SHRegGetBoolValueFromHKCUHKLM"
                                    },
                                    {
                                        "api": "Microsoft.Win32.RegistryKey::GetValue"
                                    },
                                    {
                                        "api": "Microsoft.Win32.RegistryKey::GetValueKind"
                                    },
                                    {
                                        "api": "Microsoft.Win32.RegistryKey::GetValueNames"
                                    },
                                    {
                                        "api": "Microsoft.Win32.Registry::GetValue"
                                    }
                                ]
                            }
                        ]
                    }
                ],
                "meta": {
                    "att&ck": [
                        "Discovery::Query Registry [T1012]"
                    ],
                    "authors": [
                        "william.ballenthin@mandiant.com",
                        "michael.hunhoff@mandiant.com",
                        "anushka.virgaonkar@mandiant.com"
                    ],
                    "examples": [
                        "BFB9B5391A13D0AFD787E87AB90F14F5:0x13145B5A",
                        "Practical Malware Analysis Lab 03-02.dll_:0x100047AD"
                    ],
                    "mbc": [
                        "Operating System::Registry::Query Registry Value [C0036.006]"
                    ],
                    "name": "query or enumerate registry value",
                    "namespace": "host-interaction/registry",
                    "scopes": {
                        "dynamic": "thread",
                        "static": "function"
                    }
                }
            }
        }
    ],
    "x_mitre_detection_rules": [
        {
            "author": "Oddvar Moe, Sander Wiebing, oscd.community",
            "date": "2020/10/07",
            "description": "Detects the export of the target Registry key to a file.",
            "detection": {
                "condition": "all of selection_* and not all of filter_*",
                "filter_1": {
                    "CommandLine|contains": [
                        "hklm",
                        "hkey_local_machine"
                    ]
                },
                "filter_2": {
                    "CommandLine|endswith": [
                        "\\system",
                        "\\sam",
                        "\\security"
                    ]
                },
                "selection_cli": {
                    "CommandLine|contains|windash": " -E "
                },
                "selection_img": [
                    {
                        "Image|endswith": "\\regedit.exe"
                    },
                    {
                        "OriginalFileName": "REGEDIT.EXE"
                    }
                ]
            },
            "falsepositives": [
                "Legitimate export of keys"
            ],
            "fields": [
                "ParentImage",
                "CommandLine"
            ],
            "id": "f0e53e89-8d22-46ea-9db5-9d4796ee2f8a",
            "level": "low",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2024/03/13",
            "references": [
                "https://lolbas-project.github.io/lolbas/Binaries/Regedit/",
                "https://gist.github.com/api0cradle/cdd2d0d0ec9abb686f0e89306e277b8f"
            ],
            "related": [
                {
                    "id": "82880171-b475-4201-b811-e9c826cd5eaa",
                    "type": "similar"
                }
            ],
            "status": "test",
            "tags": [
                "attack.exfiltration",
                "attack.t1012"
            ],
            "title": "Exports Registry Key To a File"
        },
        {
            "author": "Timur Zinniatullin, oscd.community",
            "date": "2019/10/21",
            "description": "Detects the usage of \"reg.exe\" in order to query reconnaissance information from the registry. Adversaries may interact with the Windows registry to gather information about credentials, the system, configuration, and installed software.",
            "detection": {
                "condition": "all of selection_*",
                "selection_flag": {
                    "CommandLine|contains": "query"
                },
                "selection_img": [
                    {
                        "Image|endswith": "\\reg.exe"
                    },
                    {
                        "OriginalFileName": "reg.exe"
                    }
                ],
                "selection_key": {
                    "CommandLine|contains": [
                        "currentVersion\\windows",
                        "winlogon\\",
                        "currentVersion\\shellServiceObjectDelayLoad",
                        "currentVersion\\run",
                        "currentVersion\\policies\\explorer\\run",
                        "currentcontrolset\\services"
                    ]
                }
            },
            "falsepositives": [
                "Discord"
            ],
            "id": "970007b7-ce32-49d0-a4a4-fbef016950bd",
            "level": "medium",
            "modified": "2023/02/05",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "references": [
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1012/T1012.md"
            ],
            "tags": [
                "attack.discovery",
                "attack.t1012",
                "attack.t1007"
            ],
            "title": "Potential Configuration And Service Reconnaissance Via Reg.EXE",
            "status": "test"
        },
        {
            "id": "82880171-b475-4201-b811-e9c826cd5eaa",
            "author": "Oddvar Moe, Sander Wiebing, oscd.community",
            "date": "2020/10/12",
            "description": "Detects the export of a crital Registry key to a file.",
            "detection": {
                "condition": "all of selection_*",
                "selection_cli_1": {
                    "CommandLine|contains|windash": " -E "
                },
                "selection_cli_2": {
                    "CommandLine|contains": [
                        "hklm",
                        "hkey_local_machine"
                    ]
                },
                "selection_cli_3": {
                    "CommandLine|endswith": [
                        "\\system",
                        "\\sam",
                        "\\security"
                    ]
                },
                "selection_img": [
                    {
                        "Image|endswith": "\\regedit.exe"
                    },
                    {
                        "OriginalFileName": "REGEDIT.EXE"
                    }
                ]
            },
            "falsepositives": [
                "Dumping hives for legitimate purpouse i.e. backup or forensic investigation"
            ],
            "fields": [
                "ParentImage",
                "CommandLine"
            ],
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2024/03/13",
            "references": [
                "https://lolbas-project.github.io/lolbas/Binaries/Regedit/",
                "https://gist.github.com/api0cradle/cdd2d0d0ec9abb686f0e89306e277b8f"
            ],
            "related": [
                {
                    "type": "similar",
                    "id": "f0e53e89-8d22-46ea-9db5-9d4796ee2f8a"
                }
            ],
            "status": "test",
            "tags": [
                "attack.exfiltration",
                "attack.t1012"
            ],
            "title": "Exports Critical Registry Keys To a File"
        },
        {
            "author": "Florian Roth (Nextron Systems), Nasreddine Bencherchali",
            "date": "2022/10/10",
            "description": "Detects suspicious use of PCHunter, a tool like Process Hacker to view and manipulate processes, kernel options and other low level stuff",
            "detection": {
                "condition": "1 of selection_*",
                "selection_hash_values": [
                    {
                        "md5": [
                            "228dd0c2e6287547e26ffbd973a40f14",
                            "987b65cd9b9f4e9a1afd8f8b48cf64a7"
                        ]
                    },
                    {
                        "sha1": [
                            "5f1cbc3d99558307bc1250d084fa968521482025",
                            "3fb89787cb97d902780da080545584d97fb1c2eb"
                        ]
                    },
                    {
                        "sha256": [
                            "2b214bddaab130c274de6204af6dba5aeec7433da99aa950022fa306421a6d32",
                            "55f041bf4e78e9bfa6d4ee68be40e496ce3a1353e1ca4306598589e19802522c"
                        ]
                    },
                    {
                        "Imphash": [
                            "444d210cea1ff8112f256a4997eed7ff",
                            "0479f44df47cfa2ef1ccc4416a538663"
                        ]
                    }
                ],
                "selection_hashes": {
                    "Hashes|contains": [
                        "SHA1=5F1CBC3D99558307BC1250D084FA968521482025",
                        "MD5=987B65CD9B9F4E9A1AFD8F8B48CF64A7",
                        "SHA256=2B214BDDAAB130C274DE6204AF6DBA5AEEC7433DA99AA950022FA306421A6D32",
                        "IMPHASH=444D210CEA1FF8112F256A4997EED7FF",
                        "SHA1=3FB89787CB97D902780DA080545584D97FB1C2EB",
                        "MD5=228DD0C2E6287547E26FFBD973A40F14",
                        "SHA256=55F041BF4E78E9BFA6D4EE68BE40E496CE3A1353E1CA4306598589E19802522C",
                        "IMPHASH=0479F44DF47CFA2EF1CCC4416A538663"
                    ]
                },
                "selection_image": {
                    "Image|endswith": [
                        "\\PCHunter64.exe",
                        "\\PCHunter32.exe"
                    ]
                },
                "selection_pe": [
                    {
                        "OriginalFileName": "PCHunter.exe"
                    },
                    {
                        "Description": "Epoolsoft Windows Information View Tools"
                    }
                ]
            },
            "falsepositives": [
                "Unlikely"
            ],
            "id": "fca949cc-79ca-446e-8064-01aa7e52ece5",
            "level": "high",
            "modified": "2023/02/13",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "references": [
                "http://www.xuetr.com/",
                "https://www.crowdstrike.com/blog/falcon-overwatch-report-finds-increase-in-ecrime/",
                "https://www.hexacorn.com/blog/2018/04/20/kernel-hacking-tool-you-might-have-never-heard-of-xuetr-pchunter/"
            ],
            "tags": [
                "attack.execution",
                "attack.discovery",
                "attack.t1082",
                "attack.t1057",
                "attack.t1012",
                "attack.t1083",
                "attack.t1007"
            ],
            "title": "HackTool - PCHunter Execution",
            "status": "test"
        },
        {
            "author": "Roberto Rodriguez @Cyb3rWard0g",
            "date": "2019/08/12",
            "description": "Detects handle requests and access operations to specific registry keys to calculate the SysKey",
            "detection": {
                "condition": "selection",
                "selection": {
                    "EventID": [
                        4656,
                        4663
                    ],
                    "ObjectName|endswith": [
                        "lsa\\JD",
                        "lsa\\GBG",
                        "lsa\\Skew1",
                        "lsa\\Data"
                    ],
                    "ObjectType": "key"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "9a4ff3b8-6187-4fd2-8e8b-e0eae1129495",
            "logsource": {
                "product": "windows",
                "service": "security"
            },
            "level": "high",
            "modified": "2021/11/27",
            "references": [
                "https://threathunterplaybook.com/hunts/windows/190625-RegKeyAccessSyskey/notebook.html"
            ],
            "tags": [
                "attack.discovery",
                "attack.t1012"
            ],
            "title": "SysKey Registry Keys Access",
            "status": "test"
        },
        {
            "author": "Roberto Rodriguez (Cyb3rWard0g), OTR (Open Threat Research), MSTIC",
            "date": "2021/08/26",
            "description": "This detection uses Windows security events to detect suspicious access attempts to the registry key values and sub-keys of Azure AD Health service agents (e.g AD FS).\nInformation from AD Health service agents can be used to potentially abuse some of the features provided by those services in the cloud (e.g. Federation).\nThis detection requires an access control entry (ACE) on the system access control list (SACL) of the following securable object: HKLM:\\SOFTWARE\\Microsoft\\ADHealthAgent.\nMake sure you set the SACL to propagate to its sub-keys.\n",
            "detection": {
                "condition": "selection and not filter",
                "filter": {
                    "ProcessName|contains": [
                        "Microsoft.Identity.Health.Adfs.DiagnosticsAgent.exe",
                        "Microsoft.Identity.Health.Adfs.InsightsService.exe",
                        "Microsoft.Identity.Health.Adfs.MonitoringAgent.Startup.exe",
                        "Microsoft.Identity.Health.Adfs.PshSurrogate.exe",
                        "Microsoft.Identity.Health.Common.Clients.ResourceMonitor.exe"
                    ]
                },
                "selection": {
                    "EventID": [
                        4656,
                        4663
                    ],
                    "ObjectName": "\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\ADHealthAgent",
                    "ObjectType": "Key"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "1d2ab8ac-1a01-423b-9c39-001510eae8e8",
            "level": "medium",
            "logsource": {
                "product": "windows",
                "service": "security"
            },
            "modified": "2022/10/09",
            "references": [
                "https://o365blog.com/post/hybridhealthagent/",
                "https://github.com/OTRF/Set-AuditRule/blob/c3dec5443414231714d850565d364ca73475ade5/rules/registry/aad_connect_health_service_agent.yml"
            ],
            "tags": [
                "attack.discovery",
                "attack.t1012"
            ],
            "title": "Azure AD Health Service Agents Registry Keys Access",
            "status": "test"
        },
        {
            "author": "Roberto Rodriguez (Cyb3rWard0g), OTR (Open Threat Research), MSTIC",
            "date": "2021/08/26",
            "description": "This detection uses Windows security events to detect suspicious access attempts to the registry key of Azure AD Health monitoring agent.\nThis detection requires an access control entry (ACE) on the system access control list (SACL) of the following securable object HKLM\\SOFTWARE\\Microsoft\\Microsoft Online\\Reporting\\MonitoringAgent.\n",
            "detection": {
                "condition": "selection and not filter",
                "filter": {
                    "ProcessName|contains": [
                        "Microsoft.Identity.Health.Adfs.DiagnosticsAgent.exe",
                        "Microsoft.Identity.Health.Adfs.InsightsService.exe",
                        "Microsoft.Identity.Health.Adfs.MonitoringAgent.Startup.exe",
                        "Microsoft.Identity.Health.Adfs.PshSurrogate.exe",
                        "Microsoft.Identity.Health.Common.Clients.ResourceMonitor.exe"
                    ]
                },
                "selection": {
                    "EventID": [
                        4656,
                        4663
                    ],
                    "ObjectName": "\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Microsoft Online\\Reporting\\MonitoringAgent",
                    "ObjectType": "Key"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "ff151c33-45fa-475d-af4f-c2f93571f4fe",
            "level": "medium",
            "logsource": {
                "product": "windows",
                "service": "security"
            },
            "modified": "2022/10/09",
            "references": [
                "https://o365blog.com/post/hybridhealthagent/",
                "https://github.com/OTRF/Set-AuditRule/blob/c3dec5443414231714d850565d364ca73475ade5/rules/registry/aad_connect_health_monitoring_agent.yml"
            ],
            "tags": [
                "attack.discovery",
                "attack.t1012"
            ],
            "title": "Azure AD Health Monitoring Agent Registry Keys Access",
            "status": "test"
        },
        {
            "author": "Roberto Rodriguez @Cyb3rWard0g",
            "date": "2019/08/12",
            "description": "Detects handles requested to SAM registry hive",
            "detection": {
                "condition": "selection",
                "selection": {
                    "EventID": 4656,
                    "ObjectName|endswith": "\\SAM",
                    "ObjectType": "Key"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "fields": [
                "ComputerName",
                "SubjectDomainName",
                "SubjectUserName",
                "ProcessName",
                "ObjectName"
            ],
            "id": "f8748f2c-89dc-4d95-afb0-5a2dfdbad332",
            "logsource": {
                "product": "windows",
                "service": "security"
            },
            "level": "high",
            "modified": "2021/11/27",
            "references": [
                "https://threathunterplaybook.com/hunts/windows/190725-SAMRegistryHiveHandleRequest/notebook.html"
            ],
            "status": "test",
            "tags": [
                "attack.discovery",
                "attack.t1012",
                "attack.credential_access",
                "attack.t1552.002"
            ],
            "title": "SAM Registry Hive Handle Request"
        }
    ],
    "x_mitre_platforms": [
        "Windows"
    ],
    "x_mitre_domains": [
        "enterprise-attack"
    ],
    "x_mitre_contributors": [],
    "kill_chain_phases": [
        {
            "kill_chain_name": "mitre-attack",
            "phase_name": "discovery"
        }
    ],
    "x_mitre_detection": "System and network discovery techniques normally occur throughout an operation as an adversary learns the environment. Data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities, such as Lateral Movement, based on the information obtained.\n\nInteraction with the Windows Registry may come from the command line using utilities such as [Reg](https://attack.mitre.org/software/S0075) or through running malware that may interact with the Registry through an API. Command-line invocation of utilities used to query the Registry may be detected through process and command-line monitoring. Remote access tools with built-in features may interact directly with the Windows API to gather information. Information may also be acquired through Windows system management tools such as [Windows Management Instrumentation](https://attack.mitre.org/techniques/T1047) and [PowerShell](https://attack.mitre.org/techniques/T1059/001).",
    "x_mitre_is_subtechnique": false,
    "x_mitre_version": "1.3",
    "x_mitre_modified_by_ref": "identity--c78cb6e5-0c4b-4611-8297-d1b8b55e40b5",
    "x_mitre_data_sources": [
        "Process: OS API Execution",
        "Windows Registry: Windows Registry Key Access",
        "Command: Command Execution",
        "Process: Process Creation"
    ],
    "x_mitre_permissions_required": []
}