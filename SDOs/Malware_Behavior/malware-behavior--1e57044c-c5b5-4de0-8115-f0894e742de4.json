{
    "type": "malware-behavior",
    "spec_version": "2.1",
    "id": "malware-behavior--1e57044c-c5b5-4de0-8115-f0894e742de4",
    "created": "2024-08-13T14:46:37.003262Z",
    "modified": "2024-08-13T14:46:48.507704Z",
    "name": "Office Application Startup: Add-ins",
    "description": "Adversaries may abuse Microsoft Office add-ins to obtain persistence on a compromised system. Office add-ins can be used to add functionality to Office programs. [1] There are different types of add-ins that can be used by the various Office products; including Word/Excel add-in Libraries (WLL/XLL), VBA add-ins, Office Component Object Model (COM) add-ins, automation add-ins, VBA Editor (VBE), Visual Studio Tools for Office (VSTO) add-ins, and Outlook add-ins. [2][3]Add-ins can be used to obtain persistence because they can be set to execute code when an Office application starts.",
    "object_marking_refs": [
        "marking-definition--613f2e26-407d-48c7-9eca-b8e91df99dc9"
    ],
    "external_references": [
        {
            "source_name": "MITRE ATT&CK",
            "url": "https://attack.mitre.org/techniques/T1137/006",
            "external_id": "T1137/006"
        }
    ],
    "x_mitre_capa_rules": [
        {
            "rule": {
                "features": [
                    {
                        "or": [
                            {
                                "export": "wdAutoOpen"
                            }
                        ]
                    }
                ],
                "meta": {
                    "att&ck": [
                        "Persistence::Office Application Startup::Add-ins [T1137.006]"
                    ],
                    "authors": [
                        "jakub.jozwiak@mandiant.com"
                    ],
                    "examples": [
                        "03bb32d43885e83bc56c0b2bcad6f0c5ea40402763b7057056c654990022471b"
                    ],
                    "name": "act as Word WLL add-in",
                    "namespace": "persistence/office",
                    "references": [
                        "https://www.ired.team/offensive-security/persistence/word-library-add-ins"
                    ],
                    "scopes": {
                        "dynamic": "file",
                        "static": "file"
                    }
                }
            }
        },
        {
            "rule": {
                "features": [
                    {
                        "or": [
                            {
                                "export": "xlAutoOpen"
                            }
                        ]
                    }
                ],
                "meta": {
                    "att&ck": [
                        "Persistence::Office Application Startup::Add-ins [T1137.006]"
                    ],
                    "authors": [
                        "jakub.jozwiak@mandiant.com"
                    ],
                    "examples": [
                        "c29513e5a51dd24ca840f7628b872cba921976cba89dcbffd5028ba15481108c"
                    ],
                    "name": "act as Excel XLL add-in",
                    "namespace": "persistence/office",
                    "references": [
                        "https://learn.microsoft.com/en-us/office/client-developer/excel/xlautoopen"
                    ],
                    "scopes": {
                        "dynamic": "file",
                        "static": "file"
                    }
                }
            }
        },
        {
            "rule": {
                "features": [
                    {
                        "and": [
                            {
                                "format": "dotnet"
                            },
                            {
                                "class": "Extensibility.IDTExtensibility2"
                            },
                            {
                                "or": [
                                    {
                                        "string": "OnAddInsUpdate"
                                    },
                                    {
                                        "string": "OnAddInsUpdate"
                                    },
                                    {
                                        "string": "OnBeginShutdown"
                                    },
                                    {
                                        "string": "OnConnection"
                                    },
                                    {
                                        "string": "OnDisconnection"
                                    },
                                    {
                                        "string": "OnStartupComplete"
                                    }
                                ]
                            }
                        ]
                    }
                ],
                "meta": {
                    "att&ck": [
                        "Persistence::Office Application Startup::Add-ins [T1137.006]"
                    ],
                    "authors": [
                        "jakub.jozwiak@mandiant.com"
                    ],
                    "examples": [
                        "0831bb382211a67c57a392955138808526aa15e55531091841706aae2cb89613"
                    ],
                    "name": "act as Office COM add-in",
                    "namespace": "persistence/office",
                    "references": [
                        "https://labs.withsecure.com/publications/add-in-opportunities-for-office-persistence",
                        "https://learn.microsoft.com/en-us/dotnet/api/extensibility.idtextensibility2?view=visualstudiosdk-2022"
                    ],
                    "scopes": {
                        "dynamic": "unsupported",
                        "static": "file"
                    }
                }
            }
        }
    ],
    "x_mitre_detection_rules": [
        {
            "author": "NVISO",
            "date": "2020/05/11",
            "description": "Detects potential persistence activity via startup add-ins that load when Microsoft Office starts (.wll/.xll are simply .dll fit for Word or Excel).",
            "detection": {
                "condition": "1 of selection_*",
                "selection_generic": {
                    "TargetFilename|contains": "\\Microsoft\\Addins\\",
                    "TargetFilename|endswith": [
                        ".xlam",
                        ".xla",
                        ".ppam"
                    ]
                },
                "selection_wlldropped": {
                    "TargetFilename|contains": "\\Microsoft\\Word\\Startup\\",
                    "TargetFilename|endswith": ".wll"
                },
                "selection_xladropped": {
                    "TargetFilename|contains": "Microsoft\\Excel\\XLSTART\\",
                    "TargetFilename|endswith": ".xlam"
                },
                "selection_xlldropped": {
                    "TargetFilename|contains": "\\Microsoft\\Excel\\Startup\\",
                    "TargetFilename|endswith": ".xll"
                }
            },
            "falsepositives": [
                "Legitimate add-ins"
            ],
            "id": "8e1cb247-6cf6-42fa-b440-3f27d57e9936",
            "level": "high",
            "logsource": {
                "category": "file_event",
                "product": "windows"
            },
            "modified": "2023/02/08",
            "references": [
                "Internal Research",
                "https://labs.withsecure.com/publications/add-in-opportunities-for-office-persistence",
                "https://github.com/redcanaryco/atomic-red-team/blob/4ae9580a1a8772db87a1b6cdb0d03e5af231e966/atomics/T1137.006/T1137.006.md"
            ],
            "status": "test",
            "tags": [
                "attack.persistence",
                "attack.t1137.006"
            ],
            "title": "Potential Persistence Via Microsoft Office Add-In"
        },
        {
            "author": "frack113",
            "date": "2021/12/28",
            "description": "Adversaries may abuse Microsoft Office add-ins to obtain persistence on a compromised system.\nOffice add-ins can be used to add functionality to Office programs\n",
            "detection": {
                "condition": "selection",
                "selection": {
                    "ScriptBlockText|contains|all": [
                        "new-object ",
                        "-ComObject ",
                        ".application",
                        ".RegisterXLL"
                    ]
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "36fbec91-fa1b-4d5d-8df1-8d8edcb632ad",
            "level": "high",
            "logsource": {
                "category": "ps_script",
                "product": "windows",
                "definition": "Requirements: Script Block Logging must be enabled"
            },
            "references": [
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1137.006/T1137.006.md"
            ],
            "status": "test",
            "title": "Code Executed Via Office Add-in XLL File",
            "tags": [
                "attack.persistence",
                "attack.t1137.006"
            ]
        },
        {
            "author": "frack113",
            "date": "2023/01/15",
            "description": "Detect potential persistence via the creation of an excel add-in (XLL) file to make it run automatically when Excel is started.",
            "detection": {
                "condition": "selection",
                "selection": {
                    "Details|endswith": ".xll",
                    "Details|startswith": "/R ",
                    "TargetObject|contains": "Software\\Microsoft\\Office\\",
                    "TargetObject|endswith": "\\Excel\\Options"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "961e33d1-4f86-4fcf-80ab-930a708b2f82",
            "level": "high",
            "logsource": {
                "category": "registry_set",
                "product": "windows"
            },
            "modified": "2023/08/17",
            "references": [
                "https://github.com/redcanaryco/atomic-red-team/blob/4ae9580a1a8772db87a1b6cdb0d03e5af231e966/atomics/T1137.006/T1137.006.md",
                "https://labs.withsecure.com/publications/add-in-opportunities-for-office-persistence"
            ],
            "status": "test",
            "tags": [
                "attack.persistence",
                "attack.t1137.006"
            ],
            "title": "Potential Persistence Via Excel Add-in - Registry"
        },
        {
            "author": "Bhabesh Raj",
            "date": "2021/01/10",
            "description": "Detects persistence via Visual Studio Tools for Office (VSTO) add-ins in Office applications.",
            "detection": {
                "condition": "selection and not 1 of filter_*",
                "filter_avg": {
                    "Image": "C:\\Program Files\\AVG\\Antivirus\\RegSvr.exe",
                    "TargetObject|contains": "\\Microsoft\\Office\\Outlook\\Addins\\Antivirus.AsOutExt\\"
                },
                "filter_image": {
                    "Image|endswith": [
                        "\\msiexec.exe",
                        "\\regsvr32.exe"
                    ]
                },
                "filter_office": {
                    "Image|endswith": [
                        "\\excel.exe",
                        "\\integrator.exe",
                        "\\OfficeClickToRun.exe",
                        "\\winword.exe",
                        "\\visio.exe"
                    ]
                },
                "filter_teams": {
                    "Image|endswith": "\\Teams.exe"
                },
                "selection": {
                    "TargetObject|contains": [
                        "\\Software\\Microsoft\\Office\\Outlook\\Addins\\",
                        "\\Software\\Microsoft\\Office\\Word\\Addins\\",
                        "\\Software\\Microsoft\\Office\\Excel\\Addins\\",
                        "\\Software\\Microsoft\\Office\\Powerpoint\\Addins\\",
                        "\\Software\\Microsoft\\VSTO\\Security\\Inclusion\\"
                    ]
                }
            },
            "falsepositives": [
                "Legitimate Addin Installation"
            ],
            "id": "9d15044a-7cfe-4d23-8085-6ebc11df7685",
            "level": "medium",
            "logsource": {
                "category": "registry_set",
                "product": "windows"
            },
            "modified": "2023/08/28",
            "references": [
                "https://twitter.com/_vivami/status/1347925307643355138",
                "https://vanmieghem.io/stealth-outlook-persistence/"
            ],
            "status": "test",
            "tags": [
                "attack.t1137.006",
                "attack.persistence"
            ],
            "title": "Potential Persistence Via Visual Studio Tools for Office"
        }
    ]
}