{
    "type": "malware-behavior",
    "spec_version": "2.1",
    "id": "malware-behavior--9a978dc8-774f-45bb-aad2-43c3858c119f",
    "created": "2024-08-13T14:46:36.684307Z",
    "modified": "2024-08-13T14:46:45.608273Z",
    "name": "Subvert Trust Controls: Install Root Certificate",
    "description": "Adversaries may install a root certificate on a compromised system to avoid warnings when connecting to adversary controlled web servers. Root certificates are used in public key cryptography to identify a root certificate authority (CA). When a root certificate is installed, the system or application will trust certificates in the root's chain of trust that have been signed by the root certificate.[1] Certificates are commonly used for establishing secure TLS/SSL communications within a web browser. When a user attempts to browse a website that presents a certificate that is not trusted an error message will be displayed to warn the user of the security risk. Depending on the security settings, the browser may not allow the user to establish a connection to the website.Installation of a root certificate on a compromised system would give an adversary a way to degrade the security of that system. Adversaries have used this technique to avoid security warnings prompting users when compromised systems connect over HTTPS to adversary controlled web servers that spoof legitimate websites in order to collect login credentials.[2]Atypical root certificates have also been pre-installed on systems by the manufacturer or in the software supply chain and were used in conjunction with malware/adware to provide Adversary-in-the-Middle capability for intercepting information transmitted over secure TLS/SSL communications.[3]Root certificates (and their associated chains) can also be cloned and reinstalled. Cloned certificate chains will carry many of the same metadata characteristics of the source and can be used to sign malicious code that may then bypass signature validation tools (ex: Sysinternals, antivirus, etc.) used to block execution and/or uncover artifacts of Persistence.[4]In macOS, the Ay MaMi malware uses /usr/bin/security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain /path/to/malicious/cert to install a malicious certificate as a trusted root certificate into the system keychain.[5]",
    "object_marking_refs": [
        "marking-definition--613f2e26-407d-48c7-9eca-b8e91df99dc9"
    ],
    "external_references": [
        {
            "source_name": "MITRE ATT&CK",
            "url": "https://attack.mitre.org/techniques/T1553/004",
            "external_id": "T1553/004"
        },
        {
            "source_name": "CAPEC 479",
            "external_id": "malware-behavior--3a801102-7928-4fc1-84b6-dccd4ff813cd"
        }
    ],
    "x_mitre_detection_rules": [
        {
            "author": "Austin Clark",
            "date": "2019/08/12",
            "description": "Show when private keys are being exported from the device, or when new certificates are installed",
            "detection": {
                "condition": "keywords",
                "keywords": [
                    "crypto pki export",
                    "crypto pki import",
                    "crypto pki trustpoint"
                ]
            },
            "falsepositives": [
                "Not commonly run by administrators. Also whitelist your known good certificates"
            ],
            "id": "1f978c6a-4415-47fb-aca5-736a44d7ca3d",
            "level": "high",
            "logsource": {
                "product": "cisco",
                "service": "aaa"
            },
            "modified": "2023/01/04",
            "references": [
                "https://www.cisco.com/c/en/us/td/docs/ios-xml/ios/security/a1/sec-a1-cr-book/sec-a1-cr-book_chapter_0111.html"
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.defense_evasion",
                "attack.t1553.004",
                "attack.t1552.004"
            ],
            "title": "Cisco Crypto Commands"
        },
        {
            "author": "Nasreddine Bencherchali (Nextron Systems)",
            "date": "2022/09/09",
            "description": "Adversaries may install a root certificate on a compromised system to avoid warnings when connecting to adversary controlled web servers.",
            "detection": {
                "condition": "selection",
                "selection": {
                    "CommandLine|contains": [
                        "\\AppData\\Local\\Temp\\",
                        ":\\Windows\\TEMP\\",
                        "\\Desktop\\",
                        "\\Downloads\\",
                        "\\Perflogs\\",
                        ":\\Users\\Public\\"
                    ],
                    "CommandLine|contains|all": [
                        "Import-Certificate",
                        " -FilePath ",
                        "Cert:\\LocalMachine\\Root"
                    ]
                }
            },
            "falsepositives": [
                "Unlikely"
            ],
            "id": "5f6a601c-2ecb-498b-9c33-660362323afa",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/01/16",
            "references": [
                "https://www.microsoft.com/security/blog/2022/09/07/profiling-dev-0270-phosphorus-ransomware-operations/",
                "https://learn.microsoft.com/en-us/powershell/module/pki/import-certificate?view=windowsserver2022-ps"
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.t1553.004"
            ],
            "title": "Root Certificate Installed From Susp Locations"
        },
        {
            "author": "oscd.community, @redcanary, Zach Stanford @svch0st",
            "date": "2023/03/05",
            "description": "Detects execution of \"certmgr\" with the \"add\" flag in order to install a new certificate on the system.\nAdversaries may install a root certificate on a compromised system to avoid warnings when connecting to adversary controlled web servers.\n",
            "detection": {
                "condition": "all of selection_*",
                "selection_cli": {
                    "CommandLine|contains|all": [
                        "/add",
                        "root"
                    ]
                },
                "selection_img": [
                    {
                        "Image|endswith": "\\CertMgr.exe"
                    },
                    {
                        "OriginalFileName": "CERTMGT.EXE"
                    }
                ]
            },
            "falsepositives": [
                "Help Desk or IT may need to manually add a corporate Root CA on occasion. Need to test if GPO push doesn't trigger FP"
            ],
            "id": "ff992eac-6449-4c60-8c1d-91c9722a1d48",
            "level": "medium",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "references": [
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1553.004/T1553.004.md",
                "https://securelist.com/to-crypt-or-to-mine-that-is-the-question/86307/"
            ],
            "related": [
                {
                    "id": "42821614-9264-4761-acfc-5772c3286f76",
                    "type": "derived"
                },
                {
                    "id": "46591fae-7a4c-46ea-aec3-dff5e6d785dc",
                    "type": "obsoletes"
                }
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.t1553.004"
            ],
            "title": "New Root Certificate Installed Via CertMgr.EXE"
        },
        {
            "author": "frack113",
            "date": "2022/12/23",
            "description": "Detect use of X509Enrollment",
            "detection": {
                "condition": "selection",
                "selection": {
                    "CommandLine|contains": [
                        "X509Enrollment.CBinaryConverter",
                        "884e2002-217d-11da-b2a4-000e7bbb2b09"
                    ]
                }
            },
            "falsepositives": [
                "Legitimate administrative script"
            ],
            "id": "114de787-4eb2-48cc-abdb-c0b449f93ea4",
            "level": "medium",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "references": [
                "https://speakerdeck.com/heirhabarov/hunting-for-powershell-abuse?slide=42",
                "https://speakerdeck.com/heirhabarov/hunting-for-powershell-abuse?slide=41",
                "https://learn.microsoft.com/en-us/dotnet/api/microsoft.hpc.scheduler.store.cx509enrollmentwebclassfactoryclass?view=hpc-sdk-5.1.6115"
            ],
            "related": [
                {
                    "id": "504d63cb-0dba-4d02-8531-e72981aace2c",
                    "type": "similar"
                }
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.t1553.004"
            ],
            "title": "Suspicious X509Enrollment - Process Creation"
        },
        {
            "author": "oscd.community, @redcanary, Zach Stanford @svch0st",
            "date": "2023/03/05",
            "description": "Detects execution of \"certutil\" with the \"addstore\" flag in order to install a new certificate on the system.\nAdversaries may install a root certificate on a compromised system to avoid warnings when connecting to adversary controlled web servers.\n",
            "detection": {
                "condition": "all of selection_*",
                "selection_cli_add": {
                    "CommandLine|contains|windash": "-addstore"
                },
                "selection_cli_store": {
                    "CommandLine|contains": "root"
                },
                "selection_img": [
                    {
                        "Image|endswith": "\\certutil.exe"
                    },
                    {
                        "OriginalFileName": "CertUtil.exe"
                    }
                ]
            },
            "falsepositives": [
                "Help Desk or IT may need to manually add a corporate Root CA on occasion. Need to test if GPO push doesn't trigger FP"
            ],
            "id": "d2125259-ddea-4c1c-9c22-977eb5b29cf0",
            "level": "medium",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2024/03/05",
            "related": [
                {
                    "id": "42821614-9264-4761-acfc-5772c3286f76",
                    "type": "derived"
                },
                {
                    "id": "46591fae-7a4c-46ea-aec3-dff5e6d785dc",
                    "type": "obsoletes"
                }
            ],
            "references": [
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1553.004/T1553.004.md"
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.t1553.004"
            ],
            "title": "New Root Certificate Installed Via Certutil.EXE"
        },
        {
            "author": "@SerkinValery",
            "date": "2024/03/07",
            "description": "Detects denied requests by Active Directory Certificate Services.\nExample of these requests denial include issues with permissions on the certificate template or invalid signatures.\n",
            "detection": {
                "condition": "selection",
                "selection": {
                    "EventID": 53,
                    "Provider_Name": "Microsoft-Windows-CertificationAuthority"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "994bfd6d-0a2e-481e-a861-934069fcf5f5",
            "level": "low",
            "logsource": {
                "product": "windows",
                "service": "system"
            },
            "references": [
                "https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/dd299871(v=ws.10)",
                "https://www.gradenegger.eu/en/details-of-the-event-with-id-53-of-the-source-microsoft-windows-certificationauthority/"
            ],
            "status": "experimental",
            "tags": [
                "attack.credential_access",
                "attack.t1553.004"
            ],
            "title": "Active Directory Certificate Services Denied Certificate Enrollment Request"
        },
        {
            "id": "504d63cb-0dba-4d02-8531-e72981aace2c",
            "author": "frack113",
            "date": "2022/12/23",
            "description": "Detect use of X509Enrollment",
            "detection": {
                "condition": "selection",
                "selection": {
                    "ScriptBlockText|contains": [
                        "X509Enrollment.CBinaryConverter",
                        "884e2002-217d-11da-b2a4-000e7bbb2b09"
                    ]
                }
            },
            "falsepositives": [
                "Legitimate administrative script"
            ],
            "level": "medium",
            "logsource": {
                "category": "ps_script",
                "product": "windows",
                "definition": "Requirements: Script Block Logging must be enabled"
            },
            "references": [
                "https://speakerdeck.com/heirhabarov/hunting-for-powershell-abuse?slide=42",
                "https://speakerdeck.com/heirhabarov/hunting-for-powershell-abuse?slide=41",
                "https://learn.microsoft.com/en-us/dotnet/api/microsoft.hpc.scheduler.store.cx509enrollmentwebclassfactoryclass?view=hpc-sdk-5.1.6115"
            ],
            "related": [
                {
                    "type": "similar",
                    "id": "114de787-4eb2-48cc-abdb-c0b449f93ea4"
                }
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.t1553.004"
            ],
            "title": "Suspicious X509Enrollment - Ps Script"
        },
        {
            "id": "42821614-9264-4761-acfc-5772c3286f76",
            "author": "oscd.community, @redcanary, Zach Stanford @svch0st",
            "date": "2020/10/10",
            "description": "Adversaries may install a root certificate on a compromised system to avoid warnings when connecting to adversary controlled web servers.",
            "detection": {
                "condition": "1 of selection*",
                "selection1": {
                    "ScriptBlockText|contains|all": [
                        "Move-Item",
                        "Cert:\\LocalMachine\\Root"
                    ]
                },
                "selection2": {
                    "ScriptBlockText|contains|all": [
                        "Import-Certificate",
                        "Cert:\\LocalMachine\\Root"
                    ]
                }
            },
            "falsepositives": [
                "Help Desk or IT may need to manually add a corporate Root CA on occasion. Need to test if GPO push doesn't trigger FP"
            ],
            "level": "medium",
            "logsource": {
                "category": "ps_script",
                "product": "windows",
                "definition": "Requirements: Script Block Logging must be enabled"
            },
            "modified": "2022/12/02",
            "references": [
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1553.004/T1553.004.md"
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.t1553.004"
            ],
            "title": "Root Certificate Installed - PowerShell"
        },
        {
            "author": "\u00d6mer G\u00fcnal, oscd.community",
            "date": "2020/10/05",
            "description": "Detects installation of new certificate on the system which attackers may use to avoid warnings when connecting to controlled web servers or C2s",
            "detection": {
                "condition": "selection",
                "selection": {
                    "Image|endswith": [
                        "/update-ca-certificates",
                        "/update-ca-trust"
                    ]
                }
            },
            "falsepositives": [
                "Legitimate administration activities"
            ],
            "id": "78a80655-a51e-4669-bc6b-e9d206a462ee",
            "level": "low",
            "logsource": {
                "category": "process_creation",
                "product": "linux"
            },
            "modified": "2022/07/07",
            "references": [
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1553.004/T1553.004.md"
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.t1553.004"
            ],
            "title": "Install Root Certificate"
        },
        {
            "author": "Nasreddine Bencherchali (Nextron Systems)",
            "date": "2023/01/03",
            "description": "Detects installation of suspicious packages using system installation utilities",
            "detection": {
                "condition": "1 of selection_tool_* and selection_keyword",
                "selection_keyword": {
                    "CommandLine|contains": [
                        "nmap",
                        " nc",
                        "netcat",
                        "wireshark",
                        "tshark",
                        "openconnect",
                        "proxychains"
                    ]
                },
                "selection_tool_apt": {
                    "CommandLine|contains": "install",
                    "Image|endswith": [
                        "/apt",
                        "/apt-get"
                    ]
                },
                "selection_tool_dpkg": {
                    "CommandLine|contains": [
                        "--install",
                        "-i"
                    ],
                    "Image|endswith": "/dpkg"
                },
                "selection_tool_rpm": {
                    "CommandLine|contains": "-i",
                    "Image|endswith": "/rpm"
                },
                "selection_tool_yum": {
                    "CommandLine|contains": [
                        "localinstall",
                        "install"
                    ],
                    "Image|endswith": "/yum"
                }
            },
            "falsepositives": [
                "Legitimate administration activities"
            ],
            "id": "700fb7e8-2981-401c-8430-be58e189e741",
            "level": "medium",
            "logsource": {
                "category": "process_creation",
                "product": "linux"
            },
            "references": [
                "https://gist.githubusercontent.com/MichaelKoczwara/12faba9c061c12b5814b711166de8c2f/raw/e2068486692897b620c25fde1ea258c8218fe3d3/history.txt"
            ],
            "status": "test",
            "title": "Suspicious Package Installed - Linux",
            "tags": [
                "attack.defense_evasion",
                "attack.t1553.004"
            ]
        }
    ]
}