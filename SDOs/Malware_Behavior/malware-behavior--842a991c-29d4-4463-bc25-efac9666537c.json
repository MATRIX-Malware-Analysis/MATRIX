{
    "type": "malware-behavior",
    "spec_version": "2.1",
    "id": "malware-behavior--842a991c-29d4-4463-bc25-efac9666537c",
    "created": "2024-08-13T14:46:37.027924Z",
    "modified": "2024-08-13T14:46:45.549047Z",
    "name": "OS Credential Dumping: Cached Domain Credentials",
    "description": "Adversaries may attempt to access cached domain credentials used to allow authentication to occur in the event a domain controller is unavailable.[1]On Windows Vista and newer, the hash format is DCC2 (Domain Cached Credentials version 2) hash, also known as MS-Cache v2 hash.[2] The number of default cached credentials varies and can be altered per system. This hash does not allow pass-the-hash style attacks, and instead requires Password Cracking to recover the plaintext password.[3]On Linux systems, Active Directory credentials can be accessed through caches maintained by software like System Security Services Daemon (SSSD) or Quest Authentication Services (formerly VAS). Cached credential hashes are typically located at /var/lib/sss/db/cache.[domain].ldb for SSSD or /var/opt/quest/vas/authcache/vas_auth.vdb for Quest. Adversaries can use utilities, such as tdbdump, on these database files to dump the cached hashes and use Password Cracking to obtain the plaintext password.[4] With SYSTEM or sudo access, the tools/utilities such as Mimikatz, Reg, and secretsdump.py for Windows or Linikatz for Linux can be used to extract the cached credentials.[4]Note: Cached credentials for Windows Vista are derived using PBKDF2.[2]",
    "object_marking_refs": [
        "marking-definition--613f2e26-407d-48c7-9eca-b8e91df99dc9"
    ],
    "external_references": [
        {
            "source_name": "MITRE ATT&CK",
            "url": "https://attack.mitre.org/techniques/T1003/005",
            "external_id": "T1003/005"
        }
    ],
    "x_mitre_detection_rules": [
        {
            "author": "Teymur Kheirkhabarov, oscd.community",
            "date": "2019/11/01",
            "description": "Files with well-known filenames (parts of credential dump software or files produced by them) creation",
            "detection": {
                "condition": "selection",
                "selection": [
                    {
                        "TargetFilename|contains": [
                            "\\fgdump-log",
                            "\\kirbi",
                            "\\pwdump",
                            "\\pwhashes",
                            "\\wce_ccache",
                            "\\wce_krbtkts"
                        ]
                    },
                    {
                        "TargetFilename|endswith": [
                            "\\cachedump.exe",
                            "\\cachedump64.exe",
                            "\\DumpExt.dll",
                            "\\DumpSvc.exe",
                            "\\Dumpy.exe",
                            "\\fgexec.exe",
                            "\\lsremora.dll",
                            "\\lsremora64.dll",
                            "\\NTDS.out",
                            "\\procdump64.exe",
                            "\\pstgdump.exe",
                            "\\pwdump.exe",
                            "\\SAM.out",
                            "\\SECURITY.out",
                            "\\servpw.exe",
                            "\\servpw64.exe",
                            "\\SYSTEM.out",
                            "\\test.pwd",
                            "\\wceaux.dll"
                        ]
                    }
                ]
            },
            "falsepositives": [
                "Legitimate Administrator using tool for password recovery"
            ],
            "id": "8fbf3271-1ef6-4e94-8210-03c2317947f6",
            "level": "high",
            "logsource": {
                "category": "file_event",
                "product": "windows"
            },
            "modified": "2022/09/21",
            "references": [
                "https://www.slideshare.net/heirhabarov/hunting-for-credentials-dumping-in-windows-environment"
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1003.001",
                "attack.t1003.002",
                "attack.t1003.003",
                "attack.t1003.004",
                "attack.t1003.005"
            ],
            "title": "Cred Dump Tools Dropped Files"
        },
        {
            "author": "Teymur Kheirkhabarov, oscd.community, David ANDRE (additional keywords), Tim Shelton",
            "date": "2019/10/22",
            "description": "Detection well-known mimikatz command line arguments",
            "detection": {
                "condition": "1 of selection_*",
                "selection_function_names": {
                    "CommandLine|contains": [
                        "::aadcookie",
                        "::detours",
                        "::memssp",
                        "::mflt",
                        "::ncroutemon",
                        "::ngcsign",
                        "::printnightmare",
                        "::skeleton",
                        "::preshutdown",
                        "::mstsc",
                        "::multirdp"
                    ]
                },
                "selection_module_names": {
                    "CommandLine|contains": [
                        "rpc::",
                        "token::",
                        "crypto::",
                        "dpapi::",
                        "sekurlsa::",
                        "kerberos::",
                        "lsadump::",
                        "privilege::",
                        "process::",
                        "vault::"
                    ]
                },
                "selection_tools_name": {
                    "CommandLine|contains": [
                        "DumpCreds",
                        "mimikatz"
                    ]
                }
            },
            "falsepositives": [
                "Unlikely"
            ],
            "id": "a642964e-bead-4bed-8910-1bb4d63e3b4d",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/02/21",
            "references": [
                "https://www.slideshare.net/heirhabarov/hunting-for-credentials-dumping-in-windows-environment",
                "https://tools.thehacker.recipes/mimikatz/modules"
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1003.001",
                "attack.t1003.002",
                "attack.t1003.004",
                "attack.t1003.005",
                "attack.t1003.006"
            ],
            "title": "HackTool - Mimikatz Execution"
        },
        {
            "author": "jmallette, Florian Roth (Nextron Systems), Nasreddine Bencherchali (Nextron Systems)",
            "date": "2019/01/16",
            "description": "Detects usage of cmdkey to look for cached credentials on the system",
            "detection": {
                "condition": "all of selection*",
                "selection_cli": {
                    "CommandLine|contains|windash": " -l"
                },
                "selection_img": [
                    {
                        "Image|endswith": "\\cmdkey.exe"
                    },
                    {
                        "OriginalFileName": "cmdkey.exe"
                    }
                ]
            },
            "falsepositives": [
                "Legitimate administrative tasks"
            ],
            "fields": [
                "CommandLine",
                "ParentCommandLine",
                "User"
            ],
            "id": "07f8bdc2-c9b3-472a-9817-5a670b872f53",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2024/03/05",
            "status": "test",
            "references": [
                "https://www.peew.pw/blog/2017/11/26/exploring-cmdkey-an-edge-case-for-privilege-escalation",
                "https://technet.microsoft.com/en-us/library/cc754243(v=ws.11).aspx",
                "https://github.com/redcanaryco/atomic-red-team/blob/b27a3cb25025161d49ac861cb216db68c46a3537/atomics/T1003.005/T1003.005.md#atomic-test-1---cached-credential-dump-via-cmdkey"
            ],
            "tags": [
                "attack.credential_access",
                "attack.t1003.005"
            ],
            "title": "Potential Reconnaissance For Cached Credentials Via Cmdkey.EXE"
        },
        {
            "author": "frack113, Nasreddine Bencherchali (Nextron Systems)",
            "date": "2023/02/03",
            "description": "Detects usage of \"cmdkey.exe\" to add generic credentials.\nAs an example, this can be used before connecting to an RDP session via command line interface.\n",
            "detection": {
                "condition": "all of selection_*",
                "selection_cli_generic": {
                    "CommandLine|contains|windash": " -g"
                },
                "selection_img": [
                    {
                        "Image|endswith": "\\cmdkey.exe"
                    },
                    {
                        "OriginalFileName": "cmdkey.exe"
                    }
                ],
                "selection_cli_password": {
                    "CommandLine|contains|windash": " -p"
                },
                "selection_cli_user": {
                    "CommandLine|contains|windash": " -u"
                }
            },
            "falsepositives": [
                "Legitimate usage for administration purposes"
            ],
            "id": "b1ec66c6-f4d1-4b5c-96dd-af28ccae7727",
            "level": "medium",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "references": [
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1021.001/T1021.001.md#t1021001---remote-desktop-protocol"
            ],
            "modified": "2024/03/05",
            "status": "test",
            "title": "New Generic Credentials Added Via Cmdkey.EXE",
            "tags": [
                "attack.credential_access",
                "attack.t1003.005"
            ]
        },
        {
            "author": "Teymur Kheirkhabarov, Endgame, JHasenbusch, Daniil Yugoslavskiy, oscd.community, frack113",
            "date": "2019/10/22",
            "description": "Detects the usage of \"reg.exe\" in order to dump sensitive registry hives. This includes SAM, SYSTEM and SECURITY hives.",
            "detection": {
                "condition": "all of selection_*",
                "selection_cli_flag": {
                    "CommandLine|contains": [
                        " save ",
                        " export ",
                        " \u02e2ave ",
                        " e\u02e3port "
                    ]
                },
                "selection_cli_hive": {
                    "CommandLine|contains": [
                        "\\system",
                        "\\sam",
                        "\\security",
                        "\\\u02e2ystem",
                        "\\sy\u02e2tem",
                        "\\\u02e2y\u02e2tem",
                        "\\\u02e2am",
                        "\\\u02e2ecurity"
                    ]
                },
                "selection_cli_hklm": {
                    "CommandLine|contains": [
                        "hklm",
                        "hk\u02eam",
                        "hkey_local_machine",
                        "hkey_\u02eaocal_machine",
                        "hkey_loca\u02ea_machine",
                        "hkey_\u02eaoca\u02ea_machine"
                    ]
                },
                "selection_img": [
                    {
                        "Image|endswith": "\\reg.exe"
                    },
                    {
                        "OriginalFileName": "reg.exe"
                    }
                ]
            },
            "falsepositives": [
                "Dumping hives for legitimate purpouse i.e. backup or forensic investigation"
            ],
            "id": "fd877b94-9bb5-4191-bb25-d79cbd93c167",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/12/13",
            "references": [
                "https://www.slideshare.net/heirhabarov/hunting-for-credentials-dumping-in-windows-environment",
                "https://eqllib.readthedocs.io/en/latest/analytics/aed95fc6-5e3f-49dc-8b35-06508613f979.html",
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1003/T1003.md",
                "https://www.wietzebeukema.nl/blog/windows-command-line-obfuscation",
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1003.002/T1003.002.md#atomic-test-1---registry-dump-of-sam-creds-and-secrets"
            ],
            "related": [
                {
                    "id": "038cd51c-3ad8-41c5-ba8f-5d1c92f3cc1e",
                    "type": "obsoletes"
                },
                {
                    "id": "4d6c9da1-318b-4edf-bcea-b6c93fa98fd0",
                    "type": "obsoletes"
                }
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1003.002",
                "attack.t1003.004",
                "attack.t1003.005",
                "car.2013-07-001"
            ],
            "title": "Dumping of Sensitive Hives Via Reg.EXE"
        },
        {
            "author": "Teymur Kheirkhabarov, oscd.community",
            "date": "2019/11/01",
            "description": "Detects well-known credential dumping tools execution via specific named pipe creation",
            "detection": {
                "condition": "selection",
                "selection": {
                    "PipeName|contains": [
                        "\\cachedump",
                        "\\lsadump",
                        "\\wceservicepipe"
                    ]
                }
            },
            "falsepositives": [
                "Legitimate Administrator using tool for password recovery"
            ],
            "id": "961d0ba2-3eea-4303-a930-2cf78bbfcc5e",
            "level": "critical",
            "logsource": {
                "category": "pipe_created",
                "product": "windows",
                "definition": "Note that you have to configure logging for Named Pipe Events in Sysmon config (Event ID 17 and Event ID 18). The basic configuration is in popular sysmon configuration (https://github.com/SwiftOnSecurity/sysmon-config), but it is worth verifying. You can also use other repo, e.g. https://github.com/Neo23x0/sysmon-config, https://github.com/olafhartong/sysmon-modular. How to test detection? You can check powershell script from this site https://svch0st.medium.com/guide-to-named-pipes-and-hunting-for-cobalt-strike-pipes-dc46b2c5f575"
            },
            "modified": "2023/08/07",
            "references": [
                "https://www.slideshare.net/heirhabarov/hunting-for-credentials-dumping-in-windows-environment",
                "https://image.slidesharecdn.com/zeronights2017kheirkhabarov-171118103000/75/hunting-for-credentials-dumping-in-windows-environment-57-2048.jpg?cb=1666035799"
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1003.001",
                "attack.t1003.002",
                "attack.t1003.004",
                "attack.t1003.005"
            ],
            "title": "HackTool - Credential Dumping Tools Named Pipe Created"
        },
        {
            "author": "Florian Roth (Nextron Systems), Teymur Kheirkhabarov, Daniil Yugoslavskiy, oscd.community",
            "date": "2017/03/05",
            "description": "Detects well-known credential dumping tools execution via service execution events",
            "detection": {
                "condition": "selection",
                "selection": {
                    "EventID": 7045,
                    "ImagePath|contains": [
                        "cachedump",
                        "dumpsvc",
                        "fgexec",
                        "gsecdump",
                        "mimidrv",
                        "pwdump",
                        "servpw"
                    ],
                    "Provider_Name": "Service Control Manager"
                }
            },
            "falsepositives": [
                "Legitimate Administrator using credential dumping tool for password recovery"
            ],
            "id": "4976aa50-8f41-45c6-8b15-ab3fc10e79ed",
            "level": "high",
            "logsource": {
                "product": "windows",
                "service": "system"
            },
            "modified": "2022/11/29",
            "references": [
                "https://www.slideshare.net/heirhabarov/hunting-for-credentials-dumping-in-windows-environment"
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.execution",
                "attack.t1003.001",
                "attack.t1003.002",
                "attack.t1003.004",
                "attack.t1003.005",
                "attack.t1003.006",
                "attack.t1569.002",
                "attack.s0005"
            ],
            "title": "Credential Dumping Tools Service Execution - System"
        },
        {
            "author": "Florian Roth (Nextron Systems), Teymur Kheirkhabarov, Daniil Yugoslavskiy, oscd.community",
            "date": "2017/03/05",
            "description": "Detects well-known credential dumping tools execution via service execution events",
            "detection": {
                "condition": "selection",
                "selection": {
                    "EventID": 4697,
                    "ServiceFileName|contains": [
                        "cachedump",
                        "dumpsvc",
                        "fgexec",
                        "gsecdump",
                        "mimidrv",
                        "pwdump",
                        "servpw"
                    ]
                }
            },
            "falsepositives": [
                "Legitimate Administrator using credential dumping tool for password recovery"
            ],
            "id": "f0d1feba-4344-4ca9-8121-a6c97bd6df52",
            "level": "high",
            "logsource": {
                "definition": "The 'System Security Extension' audit subcategory need to be enabled to log the EID 4697",
                "product": "windows",
                "service": "security"
            },
            "modified": "2022/11/29",
            "references": [
                "https://www.slideshare.net/heirhabarov/hunting-for-credentials-dumping-in-windows-environment"
            ],
            "related": [
                {
                    "type": "derived",
                    "id": "4976aa50-8f41-45c6-8b15-ab3fc10e79ed"
                }
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.execution",
                "attack.t1003.001",
                "attack.t1003.002",
                "attack.t1003.004",
                "attack.t1003.005",
                "attack.t1003.006",
                "attack.t1569.002",
                "attack.s0005"
            ],
            "title": "Credential Dumping Tools Service Execution - Security"
        }
    ]
}