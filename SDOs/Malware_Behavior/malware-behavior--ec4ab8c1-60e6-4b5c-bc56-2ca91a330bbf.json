{
    "type": "malware-behavior",
    "spec_version": "2.1",
    "id": "malware-behavior--ec4ab8c1-60e6-4b5c-bc56-2ca91a330bbf",
    "created": "2024-08-13T14:46:36.856573Z",
    "modified": "2024-08-13T14:46:44.591655Z",
    "name": "OS Credential Dumping: LSA Secrets",
    "description": "Adversaries with SYSTEM access to a host may attempt to access Local Security Authority (LSA) secrets, which can contain a variety of different credential materials, such as credentials for service accounts.[1][2][3] LSA secrets are stored in the registry at HKEY_LOCAL_MACHINE\\SECURITY\\Policy\\Secrets. LSA secrets can also be dumped from memory.[4]Reg can be used to extract from the Registry. Mimikatz can be used to extract secrets from memory.[4]",
    "object_marking_refs": [
        "marking-definition--613f2e26-407d-48c7-9eca-b8e91df99dc9"
    ],
    "external_references": [
        {
            "source_name": "MITRE ATT&CK",
            "url": "https://attack.mitre.org/techniques/T1003/004",
            "external_id": "T1003/004"
        }
    ],
    "x_mitre_detection_rules": [
        {
            "author": "Samir Bousseaden, @neu5ron",
            "date": "2020/03/19",
            "description": "Detect AD credential dumping using impacket secretdump HKTL. Based on the SIGMA rules/windows/builtin/win_impacket_secretdump.yml",
            "detection": {
                "condition": "selection",
                "selection": {
                    "name|contains": "SYSTEM32\\",
                    "name|endswith": ".tmp",
                    "path|contains|all": [
                        "\\",
                        "ADMIN$"
                    ]
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "92dae1ed-1c9d-4eff-a567-33acbd95b00e",
            "level": "high",
            "logsource": {
                "product": "zeek",
                "service": "smb_files"
            },
            "modified": "2021/11/27",
            "references": [
                "https://blog.menasec.net/2019/02/threat-huting-10-impacketsecretdump.html"
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1003.002",
                "attack.t1003.004",
                "attack.t1003.003"
            ],
            "title": "Possible Impacket SecretDump Remote Activity - Zeek"
        },
        {
            "author": "Teymur Kheirkhabarov, oscd.community",
            "date": "2019/11/01",
            "description": "Files with well-known filenames (parts of credential dump software or files produced by them) creation",
            "detection": {
                "condition": "selection",
                "selection": [
                    {
                        "TargetFilename|contains": [
                            "\\fgdump-log",
                            "\\kirbi",
                            "\\pwdump",
                            "\\pwhashes",
                            "\\wce_ccache",
                            "\\wce_krbtkts"
                        ]
                    },
                    {
                        "TargetFilename|endswith": [
                            "\\cachedump.exe",
                            "\\cachedump64.exe",
                            "\\DumpExt.dll",
                            "\\DumpSvc.exe",
                            "\\Dumpy.exe",
                            "\\fgexec.exe",
                            "\\lsremora.dll",
                            "\\lsremora64.dll",
                            "\\NTDS.out",
                            "\\procdump64.exe",
                            "\\pstgdump.exe",
                            "\\pwdump.exe",
                            "\\SAM.out",
                            "\\SECURITY.out",
                            "\\servpw.exe",
                            "\\servpw64.exe",
                            "\\SYSTEM.out",
                            "\\test.pwd",
                            "\\wceaux.dll"
                        ]
                    }
                ]
            },
            "falsepositives": [
                "Legitimate Administrator using tool for password recovery"
            ],
            "id": "8fbf3271-1ef6-4e94-8210-03c2317947f6",
            "level": "high",
            "logsource": {
                "category": "file_event",
                "product": "windows"
            },
            "modified": "2022/09/21",
            "references": [
                "https://www.slideshare.net/heirhabarov/hunting-for-credentials-dumping-in-windows-environment"
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1003.001",
                "attack.t1003.002",
                "attack.t1003.003",
                "attack.t1003.004",
                "attack.t1003.005"
            ],
            "title": "Cred Dump Tools Dropped Files"
        },
        {
            "author": "Teymur Kheirkhabarov, oscd.community, David ANDRE (additional keywords), Tim Shelton",
            "date": "2019/10/22",
            "description": "Detection well-known mimikatz command line arguments",
            "detection": {
                "condition": "1 of selection_*",
                "selection_function_names": {
                    "CommandLine|contains": [
                        "::aadcookie",
                        "::detours",
                        "::memssp",
                        "::mflt",
                        "::ncroutemon",
                        "::ngcsign",
                        "::printnightmare",
                        "::skeleton",
                        "::preshutdown",
                        "::mstsc",
                        "::multirdp"
                    ]
                },
                "selection_module_names": {
                    "CommandLine|contains": [
                        "rpc::",
                        "token::",
                        "crypto::",
                        "dpapi::",
                        "sekurlsa::",
                        "kerberos::",
                        "lsadump::",
                        "privilege::",
                        "process::",
                        "vault::"
                    ]
                },
                "selection_tools_name": {
                    "CommandLine|contains": [
                        "DumpCreds",
                        "mimikatz"
                    ]
                }
            },
            "falsepositives": [
                "Unlikely"
            ],
            "id": "a642964e-bead-4bed-8910-1bb4d63e3b4d",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/02/21",
            "references": [
                "https://www.slideshare.net/heirhabarov/hunting-for-credentials-dumping-in-windows-environment",
                "https://tools.thehacker.recipes/mimikatz/modules"
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1003.001",
                "attack.t1003.002",
                "attack.t1003.004",
                "attack.t1003.005",
                "attack.t1003.006"
            ],
            "title": "HackTool - Mimikatz Execution"
        },
        {
            "author": "Teymur Kheirkhabarov, Endgame, JHasenbusch, Daniil Yugoslavskiy, oscd.community, frack113",
            "date": "2019/10/22",
            "description": "Detects the usage of \"reg.exe\" in order to dump sensitive registry hives. This includes SAM, SYSTEM and SECURITY hives.",
            "detection": {
                "condition": "all of selection_*",
                "selection_cli_flag": {
                    "CommandLine|contains": [
                        " save ",
                        " export ",
                        " \u02e2ave ",
                        " e\u02e3port "
                    ]
                },
                "selection_cli_hive": {
                    "CommandLine|contains": [
                        "\\system",
                        "\\sam",
                        "\\security",
                        "\\\u02e2ystem",
                        "\\sy\u02e2tem",
                        "\\\u02e2y\u02e2tem",
                        "\\\u02e2am",
                        "\\\u02e2ecurity"
                    ]
                },
                "selection_cli_hklm": {
                    "CommandLine|contains": [
                        "hklm",
                        "hk\u02eam",
                        "hkey_local_machine",
                        "hkey_\u02eaocal_machine",
                        "hkey_loca\u02ea_machine",
                        "hkey_\u02eaoca\u02ea_machine"
                    ]
                },
                "selection_img": [
                    {
                        "Image|endswith": "\\reg.exe"
                    },
                    {
                        "OriginalFileName": "reg.exe"
                    }
                ]
            },
            "falsepositives": [
                "Dumping hives for legitimate purpouse i.e. backup or forensic investigation"
            ],
            "id": "fd877b94-9bb5-4191-bb25-d79cbd93c167",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/12/13",
            "references": [
                "https://www.slideshare.net/heirhabarov/hunting-for-credentials-dumping-in-windows-environment",
                "https://eqllib.readthedocs.io/en/latest/analytics/aed95fc6-5e3f-49dc-8b35-06508613f979.html",
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1003/T1003.md",
                "https://www.wietzebeukema.nl/blog/windows-command-line-obfuscation",
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1003.002/T1003.002.md#atomic-test-1---registry-dump-of-sam-creds-and-secrets"
            ],
            "related": [
                {
                    "id": "038cd51c-3ad8-41c5-ba8f-5d1c92f3cc1e",
                    "type": "obsoletes"
                },
                {
                    "id": "4d6c9da1-318b-4edf-bcea-b6c93fa98fd0",
                    "type": "obsoletes"
                }
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1003.002",
                "attack.t1003.004",
                "attack.t1003.005",
                "car.2013-07-001"
            ],
            "title": "Dumping of Sensitive Hives Via Reg.EXE"
        },
        {
            "author": "Teymur Kheirkhabarov, oscd.community",
            "date": "2019/11/01",
            "description": "Detects well-known credential dumping tools execution via specific named pipe creation",
            "detection": {
                "condition": "selection",
                "selection": {
                    "PipeName|contains": [
                        "\\cachedump",
                        "\\lsadump",
                        "\\wceservicepipe"
                    ]
                }
            },
            "falsepositives": [
                "Legitimate Administrator using tool for password recovery"
            ],
            "id": "961d0ba2-3eea-4303-a930-2cf78bbfcc5e",
            "level": "critical",
            "logsource": {
                "category": "pipe_created",
                "product": "windows",
                "definition": "Note that you have to configure logging for Named Pipe Events in Sysmon config (Event ID 17 and Event ID 18). The basic configuration is in popular sysmon configuration (https://github.com/SwiftOnSecurity/sysmon-config), but it is worth verifying. You can also use other repo, e.g. https://github.com/Neo23x0/sysmon-config, https://github.com/olafhartong/sysmon-modular. How to test detection? You can check powershell script from this site https://svch0st.medium.com/guide-to-named-pipes-and-hunting-for-cobalt-strike-pipes-dc46b2c5f575"
            },
            "modified": "2023/08/07",
            "references": [
                "https://www.slideshare.net/heirhabarov/hunting-for-credentials-dumping-in-windows-environment",
                "https://image.slidesharecdn.com/zeronights2017kheirkhabarov-171118103000/75/hunting-for-credentials-dumping-in-windows-environment-57-2048.jpg?cb=1666035799"
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1003.001",
                "attack.t1003.002",
                "attack.t1003.004",
                "attack.t1003.005"
            ],
            "title": "HackTool - Credential Dumping Tools Named Pipe Created"
        },
        {
            "author": "Florian Roth (Nextron Systems), David ANDRE (additional keywords)",
            "date": "2017/01/10",
            "description": "This method detects mimikatz keywords in different Eventlogs (some of them only appear in older Mimikatz version that are however still used by different threat groups)",
            "detection": {
                "condition": "keywords and not filter",
                "filter": {
                    "EventID": 15
                },
                "keywords": [
                    "dpapi::masterkey",
                    "eo.oe.kiwi",
                    "event::clear",
                    "event::drop",
                    "gentilkiwi.com",
                    "kerberos::golden",
                    "kerberos::ptc",
                    "kerberos::ptt",
                    "kerberos::tgt",
                    "Kiwi Legit Printer",
                    "lsadump::",
                    "mimidrv.sys",
                    "\\mimilib.dll",
                    "misc::printnightmare",
                    "misc::shadowcopies",
                    "misc::skeleton",
                    "privilege::backup",
                    "privilege::debug",
                    "privilege::driver",
                    "sekurlsa::"
                ]
            },
            "falsepositives": [
                "Naughty administrators",
                "AV Signature updates",
                "Files with Mimikatz in their filename"
            ],
            "id": "06d71506-7beb-4f22-8888-e2e5e2ca7fd8",
            "level": "high",
            "logsource": {
                "product": "windows"
            },
            "modified": "2022/01/05",
            "references": [
                "https://tools.thehacker.recipes/mimikatz/modules"
            ],
            "status": "test",
            "tags": [
                "attack.s0002",
                "attack.lateral_movement",
                "attack.credential_access",
                "car.2013-07-001",
                "car.2019-04-004",
                "attack.t1003.002",
                "attack.t1003.004",
                "attack.t1003.001",
                "attack.t1003.006"
            ],
            "title": "Mimikatz Use"
        },
        {
            "author": "Florian Roth (Nextron Systems), Teymur Kheirkhabarov, Daniil Yugoslavskiy, oscd.community",
            "date": "2017/03/05",
            "description": "Detects well-known credential dumping tools execution via service execution events",
            "detection": {
                "condition": "selection",
                "selection": {
                    "EventID": 7045,
                    "ImagePath|contains": [
                        "cachedump",
                        "dumpsvc",
                        "fgexec",
                        "gsecdump",
                        "mimidrv",
                        "pwdump",
                        "servpw"
                    ],
                    "Provider_Name": "Service Control Manager"
                }
            },
            "falsepositives": [
                "Legitimate Administrator using credential dumping tool for password recovery"
            ],
            "id": "4976aa50-8f41-45c6-8b15-ab3fc10e79ed",
            "level": "high",
            "logsource": {
                "product": "windows",
                "service": "system"
            },
            "modified": "2022/11/29",
            "references": [
                "https://www.slideshare.net/heirhabarov/hunting-for-credentials-dumping-in-windows-environment"
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.execution",
                "attack.t1003.001",
                "attack.t1003.002",
                "attack.t1003.004",
                "attack.t1003.005",
                "attack.t1003.006",
                "attack.t1569.002",
                "attack.s0005"
            ],
            "title": "Credential Dumping Tools Service Execution - System"
        },
        {
            "author": "Roberto Rodriguez @Cyb3rWard0g",
            "date": "2019/08/10",
            "description": "Detects anyone attempting a backup for the DPAPI Master Key. This events gets generated at the source and not the Domain Controller.",
            "detection": {
                "condition": "selection",
                "selection": {
                    "EventID": 4692
                }
            },
            "falsepositives": [
                "If a computer is a member of a domain, DPAPI has a backup mechanism to allow unprotection of the data. Which will trigger this event."
            ],
            "fields": [
                "ComputerName",
                "SubjectDomainName",
                "SubjectUserName"
            ],
            "id": "39a94fd1-8c9a-4ff6-bf22-c058762f8014",
            "level": "medium",
            "logsource": {
                "product": "windows",
                "service": "security"
            },
            "modified": "2023/03/15",
            "status": "test",
            "references": [
                "https://threathunterplaybook.com/hunts/windows/190620-DomainDPAPIBackupKeyExtraction/notebook.html"
            ],
            "tags": [
                "attack.credential_access",
                "attack.t1003.004"
            ],
            "title": "DPAPI Domain Master Key Backup Attempt"
        },
        {
            "author": "Roberto Rodriguez @Cyb3rWard0g",
            "date": "2019/06/20",
            "description": "Detects tools extracting LSA secret DPAPI domain backup key from Domain Controllers",
            "detection": {
                "condition": "selection",
                "selection": {
                    "AccessMask": "0x2",
                    "EventID": 4662,
                    "ObjectName|contains": "BCKUPKEY",
                    "ObjectType": "SecretObject"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "4ac1f50b-3bd0-4968-902d-868b4647937e",
            "level": "high",
            "modified": "2022/02/24",
            "logsource": {
                "product": "windows",
                "service": "security"
            },
            "status": "test",
            "references": [
                "https://threathunterplaybook.com/hunts/windows/190620-DomainDPAPIBackupKeyExtraction/notebook.html"
            ],
            "title": "DPAPI Domain Backup Key Extraction",
            "tags": [
                "attack.credential_access",
                "attack.t1003.004"
            ]
        },
        {
            "author": "Florian Roth (Nextron Systems), Teymur Kheirkhabarov, Daniil Yugoslavskiy, oscd.community",
            "date": "2017/03/05",
            "description": "Detects well-known credential dumping tools execution via service execution events",
            "detection": {
                "condition": "selection",
                "selection": {
                    "EventID": 4697,
                    "ServiceFileName|contains": [
                        "cachedump",
                        "dumpsvc",
                        "fgexec",
                        "gsecdump",
                        "mimidrv",
                        "pwdump",
                        "servpw"
                    ]
                }
            },
            "falsepositives": [
                "Legitimate Administrator using credential dumping tool for password recovery"
            ],
            "id": "f0d1feba-4344-4ca9-8121-a6c97bd6df52",
            "level": "high",
            "logsource": {
                "definition": "The 'System Security Extension' audit subcategory need to be enabled to log the EID 4697",
                "product": "windows",
                "service": "security"
            },
            "modified": "2022/11/29",
            "references": [
                "https://www.slideshare.net/heirhabarov/hunting-for-credentials-dumping-in-windows-environment"
            ],
            "related": [
                {
                    "type": "derived",
                    "id": "4976aa50-8f41-45c6-8b15-ab3fc10e79ed"
                }
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.execution",
                "attack.t1003.001",
                "attack.t1003.002",
                "attack.t1003.004",
                "attack.t1003.005",
                "attack.t1003.006",
                "attack.t1569.002",
                "attack.s0005"
            ],
            "title": "Credential Dumping Tools Service Execution - Security"
        },
        {
            "author": "Samir Bousseaden, wagga",
            "date": "2019/04/03",
            "description": "Detect AD credential dumping using impacket secretdump HKTL",
            "detection": {
                "condition": "selection",
                "selection": {
                    "EventID": 5145,
                    "RelativeTargetName|contains|all": [
                        "SYSTEM32\\",
                        ".tmp"
                    ],
                    "ShareName": "\\\\\\\\\\*\\\\ADMIN$"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "252902e3-5830-4cf6-bf21-c22083dfd5cf",
            "level": "high",
            "logsource": {
                "definition": "The advanced audit policy setting \"Object Access > Audit Detailed File Share\" must be configured for Success/Failure",
                "product": "windows",
                "service": "security"
            },
            "modified": "2022/08/11",
            "references": [
                "https://blog.menasec.net/2019/02/threat-huting-10-impacketsecretdump.html"
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1003.002",
                "attack.t1003.004",
                "attack.t1003.003"
            ],
            "title": "Possible Impacket SecretDump Remote Activity"
        }
    ]
}