{
    "type": "malware-behavior",
    "spec_version": "2.1",
    "id": "malware-behavior--846cb831-ab97-4565-ad75-a3beb678001d",
    "created": "2024-08-13T14:46:37.142636Z",
    "modified": "2024-08-13T14:46:46.271093Z",
    "name": "Event Triggered Execution: Application Shimming",
    "description": "Adversaries may establish persistence and/or elevate privileges by executing malicious content triggered by application shims. The Microsoft Windows Application Compatibility Infrastructure/Framework (Application Shim) was created to allow for backward compatibility of software as the operating system codebase changes over time. For example, the application shimming feature allows developers to apply fixes to applications (without rewriting code) that were created for Windows XP so that it will work with Windows 10. [1]Within the framework, shims are created to act as a buffer between the program (or more specifically, the Import Address Table) and the Windows OS. When a program is executed, the shim cache is referenced to determine if the program requires the use of the shim database (.sdb). If so, the shim database uses hooking to redirect the code as necessary in order to communicate with the OS. A list of all shims currently installed by the default Windows installer (sdbinst.exe) is kept in:%WINDIR%\\AppPatch\\sysmain.sdb andhklm\\software\\microsoft\\windows nt\\currentversion\\appcompatflags\\installedsdbCustom databases are stored in:%WINDIR%\\AppPatch\\custom & %WINDIR%\\AppPatch\\AppPatch64\\Custom andhklm\\software\\microsoft\\windows nt\\currentversion\\appcompatflags\\customTo keep shims secure, Windows designed them to run in user mode so they cannot modify the kernel and you must have administrator privileges to install a shim. However, certain shims can be used to Bypass User Account Control (UAC and RedirectEXE), inject DLLs into processes (InjectDLL), disable Data Execution Prevention (DisableNX) and Structure Exception Handling (DisableSEH), and intercept memory addresses (GetProcAddress).Utilizing these shims may allow an adversary to perform several malicious acts such as elevate privileges, install backdoors, disable defenses like Windows Defender, etc. [2] Shims can also be abused to establish persistence by continuously being invoked by affected programs.",
    "object_marking_refs": [
        "marking-definition--613f2e26-407d-48c7-9eca-b8e91df99dc9"
    ],
    "external_references": [
        {
            "source_name": "MITRE ATT&CK",
            "url": "https://attack.mitre.org/techniques/T1546/011",
            "external_id": "T1546/011"
        }
    ],
    "x_mitre_detection_rules": [
        {
            "author": "Markus Neis",
            "date": "2019/01/16",
            "description": "Detects installation of a new shim using sdbinst.exe.\nAdversaries may establish persistence and/or elevate privileges by executing malicious content triggered by application shims\n",
            "detection": {
                "condition": "all of selection_* and not 1 of filter_optional_*",
                "filter_optional_iis": {
                    "CommandLine|contains": [
                        ":\\Program Files (x86)\\IIS Express\\iisexpressshim.sdb",
                        ":\\Program Files\\IIS Express\\iisexpressshim.sdb"
                    ],
                    "ParentImage|endswith": "\\msiexec.exe"
                },
                "selection_cli": {
                    "CommandLine|contains": ".sdb"
                },
                "selection_img": [
                    {
                        "Image|endswith": "\\sdbinst.exe"
                    },
                    {
                        "OriginalFileName": "sdbinst.exe"
                    }
                ]
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "517490a7-115a-48c6-8862-1a481504d5a8",
            "level": "medium",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/12/06",
            "references": [
                "https://www.mandiant.com/resources/blog/fin7-shim-databases-persistence"
            ],
            "related": [
                {
                    "id": "18ee686c-38a3-4f65-9f44-48a077141f42",
                    "type": "similar"
                }
            ],
            "status": "test",
            "tags": [
                "attack.persistence",
                "attack.privilege_escalation",
                "attack.t1546.011"
            ],
            "title": "Potential Shim Database Persistence via Sdbinst.EXE"
        },
        {
            "id": "18ee686c-38a3-4f65-9f44-48a077141f42",
            "author": "Nasreddine Bencherchali (Nextron Systems)",
            "date": "2023/08/01",
            "description": "Detects installation of a potentially suspicious new shim with an uncommon extension using sdbinst.exe.\nAdversaries may establish persistence and/or elevate privileges by executing malicious content triggered by application shims\n",
            "detection": {
                "condition": "selection and not 1 of filter_main_*",
                "filter_main_empty": {
                    "CommandLine": ""
                },
                "filter_main_legit_ext": {
                    "CommandLine|contains": ".sdb"
                },
                "filter_main_legit_extensions": [
                    {
                        "CommandLine|endswith": [
                            " -c",
                            " -f",
                            " -mm",
                            " -t"
                        ]
                    },
                    {
                        "CommandLine|contains": " -m -bg"
                    }
                ],
                "filter_main_null": {
                    "CommandLine": null
                },
                "selection": [
                    {
                        "Image|endswith": "\\sdbinst.exe"
                    },
                    {
                        "OriginalFileName": "sdbinst.exe"
                    }
                ]
            },
            "falsepositives": [
                "Unknown"
            ],
            "level": "medium",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2024/01/10",
            "references": [
                "https://www.fireeye.com/blog/threat-research/2017/05/fin7-shim-databases-persistence.html",
                "https://github.com/nasbench/Misc-Research/blob/8ee690e43a379cbce8c9d61107442c36bd9be3d3/Other/Undocumented-Flags-Sdbinst.md"
            ],
            "related": [
                {
                    "type": "derived",
                    "id": "517490a7-115a-48c6-8862-1a481504d5a8"
                }
            ],
            "status": "test",
            "tags": [
                "attack.persistence",
                "attack.privilege_escalation",
                "attack.t1546.011"
            ],
            "title": "Uncommon Extension Shim Database Installation Via Sdbinst.EXE"
        },
        {
            "author": "Nasreddine Bencherchali (Nextron Systems)",
            "date": "2023/08/01",
            "description": "Detects the installation of a new shim database where the file is located in a non-default location",
            "detection": {
                "condition": "selection and not 1 of filter_main_*",
                "filter_main_known_locations": {
                    "Details|contains": ":\\Windows\\AppPatch\\Custom"
                },
                "selection": {
                    "TargetObject|contains|all": [
                        "\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\InstalledSDB\\",
                        "\\DatabasePath"
                    ]
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "6b6976a3-b0e6-4723-ac24-ae38a737af41",
            "level": "high",
            "logsource": {
                "category": "registry_set",
                "product": "windows"
            },
            "modified": "2023/08/17",
            "references": [
                "https://www.fireeye.com/blog/threat-research/2017/05/fin7-shim-databases-persistence.html",
                "https://andreafortuna.org/2018/11/12/process-injection-and-persistence-using-application-shimming/",
                "https://www.blackhat.com/docs/asia-14/materials/Erickson/Asia-14-Erickson-Persist-It-Using-And-Abusing-Microsofts-Fix-It-Patches.pdf"
            ],
            "status": "test",
            "tags": [
                "attack.persistence",
                "attack.t1546.011"
            ],
            "title": "Potential Persistence Via Shim Database In Uncommon Location"
        },
        {
            "author": "frack113",
            "date": "2021/12/30",
            "description": "Adversaries may establish persistence and/or elevate privileges by executing malicious content triggered by application shims.\nThe Microsoft Windows Application Compatibility Infrastructure/Framework (Application Shim) was created to allow for backward compatibility of software as the operating system codebase changes over time\n",
            "detection": {
                "condition": "selection and not 1 of filter_main_*",
                "filter_main_empty": {
                    "Details": ""
                },
                "selection": {
                    "TargetObject|contains": [
                        "\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\InstalledSDB\\",
                        "\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\Custom\\"
                    ]
                }
            },
            "falsepositives": [
                "Legitimate custom SHIM installations will also trigger this rule"
            ],
            "id": "dfb5b4e8-91d0-4291-b40a-e3b0d3942c45",
            "level": "medium",
            "logsource": {
                "category": "registry_set",
                "product": "windows"
            },
            "modified": "2023/08/17",
            "references": [
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1546.011/T1546.011.md#atomic-test-3---registry-key-creation-andor-modification-events-for-sdb",
                "https://www.fireeye.com/blog/threat-research/2017/05/fin7-shim-databases-persistence.html",
                "https://andreafortuna.org/2018/11/12/process-injection-and-persistence-using-application-shimming/"
            ],
            "status": "test",
            "tags": [
                "attack.persistence",
                "attack.t1546.011"
            ],
            "title": "Potential Persistence Via Shim Database Modification"
        },
        {
            "author": "Nasreddine Bencherchali (Nextron Systems)",
            "date": "2024/01/01",
            "description": "Detects the setting of the REGISTERAPPRESTART compatibility layer on an application.\nThis compatibility layer allows an application to register for restart using the \"RegisterApplicationRestart\" API.\nThis can be potentially abused as a persistence mechanism.\n",
            "detection": {
                "condition": "selection",
                "selection": {
                    "Details|contains": "REGISTERAPPRESTART",
                    "TargetObject|contains": "\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\Layers\\"
                }
            },
            "falsepositives": [
                "Legitimate applications making use of this feature for compatibility reasons"
            ],
            "id": "b86852fb-4c77-48f9-8519-eb1b2c308b59",
            "level": "medium",
            "logsource": {
                "category": "registry_set",
                "product": "windows"
            },
            "references": [
                "https://github.com/nasbench/Misc-Research/blob/d114d6a5e0a437d3818e492ef9864367152543e7/Other/Persistence-Via-RegisterAppRestart-Shim.md"
            ],
            "status": "experimental",
            "title": "Potential Persistence Via AppCompat RegisterAppRestart Layer",
            "tags": [
                "attack.persistence",
                "attack.t1546.011"
            ]
        },
        {
            "author": "Nasreddine Bencherchali (Nextron Systems)",
            "date": "2023/08/01",
            "description": "Detects installation of new shim databases that try to patch sections of known processes for potential process injection or persistence.",
            "detection": {
                "condition": "selection",
                "selection": {
                    "TargetObject|contains": "\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\Custom\\",
                    "TargetObject|endswith": [
                        "\\csrss.exe",
                        "\\dllhost.exe",
                        "\\explorer.exe",
                        "\\RuntimeBroker.exe",
                        "\\services.exe",
                        "\\sihost.exe",
                        "\\svchost.exe",
                        "\\taskhostw.exe",
                        "\\winlogon.exe",
                        "\\WmiPrvSe.exe"
                    ]
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "bf344fea-d947-4ef4-9192-34d008315d3a",
            "level": "high",
            "logsource": {
                "category": "registry_set",
                "product": "windows"
            },
            "modified": "2023/12/06",
            "status": "experimental",
            "references": [
                "https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/pillowmint-fin7s-monkey-thief/",
                "https://www.fireeye.com/blog/threat-research/2017/05/fin7-shim-databases-persistence.html"
            ],
            "tags": [
                "attack.persistence",
                "attack.t1546.011"
            ],
            "title": "Suspicious Shim Database Patching Activity"
        }
    ]
}