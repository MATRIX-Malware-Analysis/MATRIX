{
    "type": "malware-behavior",
    "spec_version": "2.1",
    "id": "malware-behavior--8b6acb28-6fa5-44ac-a9dd-af83403842b3",
    "created": "2024-08-13T14:46:37.100604Z",
    "modified": "2024-08-13T14:46:48.629519Z",
    "name": "Virtualization/Sandbox Evasion: User Activity Based Checks",
    "description": "Adversaries may employ various user activity checks to detect and avoid virtualization and analysis environments. This may include changing behaviors based on the results of checks for the presence of artifacts indicative of a virtual machine environment (VME) or sandbox. If the adversary detects a VME, they may alter their malware to disengage from the victim or conceal the core functions of the implant. They may also search for VME artifacts before dropping secondary or additional payloads. Adversaries may use the information learned from Virtualization/Sandbox Evasion during automated discovery to shape follow-on behaviors.[1]Adversaries may search for user activity on the host based on variables such as the speed/frequency of mouse movements and clicks [2] , browser history, cache, bookmarks, or number of files in common directories such as home or the desktop. Other methods may rely on specific user interaction with the system before the malicious code is activated, such as waiting for a document to close before activating a macro [3] or waiting for a user to double click on an embedded image to activate.[4]",
    "object_marking_refs": [
        "marking-definition--613f2e26-407d-48c7-9eca-b8e91df99dc9"
    ],
    "external_references": [
        {
            "source_name": "MITRE ATT&CK",
            "url": "https://attack.mitre.org/techniques/T1497/002",
            "external_id": "T1497/002"
        }
    ],
    "x_mitre_capa_rules": [
        {
            "rule": {
                "features": [
                    {
                        "and": [
                            {
                                "count(api(user32.GetCursorPos))": "2 or more"
                            }
                        ]
                    }
                ],
                "meta": {
                    "att&ck": [
                        "Defense Evasion::Virtualization/Sandbox Evasion::User Activity Based Checks [T1497.002]"
                    ],
                    "authors": [
                        "BitsOfBinary"
                    ],
                    "examples": [
                        "d7ff81ff775d4ab50d31ac1e962c8c4dea7ff9f280aa2b42ddd06760a5665002:0x401118"
                    ],
                    "mbc": [
                        "Anti-Behavioral Analysis::Virtual Machine Detection::Human User Check [B0009.012]"
                    ],
                    "name": "check for unmoving mouse cursor",
                    "namespace": "anti-analysis/anti-vm/vm-detection",
                    "references": [
                        "https://www.joesecurity.org/blog/5852460122427342172"
                    ],
                    "scopes": {
                        "dynamic": "thread",
                        "static": "function"
                    }
                }
            }
        },
        {
            "rule": {
                "features": [
                    {
                        "and": [
                            {
                                "count(api(GetForegroundWindow))": "2 or more"
                            },
                            {
                                "api": "Sleep"
                            },
                            {
                                "mnemonic": "cmp"
                            },
                            {
                                "or": [
                                    {
                                        "characteristic": "loop"
                                    },
                                    {
                                        "characteristic": "tight loop"
                                    }
                                ]
                            }
                        ]
                    }
                ],
                "meta": {
                    "att&ck": [
                        "Defense Evasion::Virtualization/Sandbox Evasion::User Activity Based Checks [T1497.002]"
                    ],
                    "authors": [
                        "ervin.ocampo@mandiant.com"
                    ],
                    "description": "Detect usage of GetForegroundWindow and Sleep APIs to check if there is any foreground window switch. Typically, sandboxes do not switch the foreground window like a user would in a normal environment.",
                    "mbc": [
                        "Anti-Behavioral Analysis::Virtual Machine Detection::Human User Check [B0009.012]"
                    ],
                    "examples": [
                        "2855ba06b90e7c64d9bce888e47baf6d:0x4112A3"
                    ],
                    "name": "check for foreground window switch",
                    "namespace": "anti-analysis/anti-vm/vm-detection",
                    "references": [
                        "https://www.trendmicro.com/en_us/research/22/k/earth-preta-spear-phishing-governments-worldwide.html",
                        "https://unprotect.it/technique/getforegroundwindow/"
                    ],
                    "scopes": {
                        "dynamic": "unsupported",
                        "static": "function"
                    }
                }
            }
        }
    ]
}