{
    "type": "malware-behavior",
    "spec_version": "2.1",
    "id": "malware-behavior--a20ed7cd-06de-4bee-80cd-b74af86ed6e1",
    "created": "2024-08-13T14:46:36.684307Z",
    "modified": "2024-08-13T14:46:44.952219Z",
    "name": "Remote Services: SMB/Windows Admin Shares",
    "description": "Adversaries may use Valid Accounts to interact with a remote network share using Server Message Block (SMB). The adversary may then perform actions as the logged-on user.SMB is a file, printer, and serial port sharing protocol for Windows machines on the same network or domain. Adversaries may use SMB to interact with file shares, allowing them to move laterally throughout a network. Linux and macOS implementations of SMB typically use Samba.Windows systems have hidden network shares that are accessible only to administrators and provide the ability for remote file copy and other administrative functions. Example network shares include C$, ADMIN$, and IPC$. Adversaries may use this technique in conjunction with administrator-level Valid Accounts to remotely access a networked system over SMB,[1] to interact with systems using remote procedure calls (RPCs),[2] transfer files, and run transferred binaries through remote Execution. Example execution techniques that rely on authenticated sessions over SMB/RPC are Scheduled Task/Job, Service Execution, and Windows Management Instrumentation. Adversaries can also use NTLM hashes to access administrator shares on systems with Pass the Hash and certain configuration and patch levels.[3]",
    "object_marking_refs": [
        "marking-definition--613f2e26-407d-48c7-9eca-b8e91df99dc9"
    ],
    "external_references": [
        {
            "source_name": "MITRE ATT&CK",
            "url": "https://attack.mitre.org/techniques/T1021/002",
            "external_id": "T1021/002"
        },
        {
            "source_name": "CAPEC 561",
            "external_id": "malware-behavior--69d071c5-3f01-4d83-b34c-2bf533948842"
        }
    ],
    "x_mitre_detection_rules": [
        {
            "author": "OTR (Open Threat Research), @neu5ron",
            "date": "2018/11/28",
            "description": "Detects the use of the spoolss named pipe over SMB. This can be used to trigger the authentication via NTLM of any machine that has the spoolservice enabled.",
            "detection": {
                "condition": "selection",
                "selection": {
                    "name": "spoolss",
                    "path|endswith": "IPC$"
                }
            },
            "falsepositives": [
                "Domain Controllers that are sometimes, commonly although should not be, acting as printer servers too"
            ],
            "id": "bae2865c-5565-470d-b505-9496c87d0c30",
            "level": "medium",
            "logsource": {
                "product": "zeek",
                "service": "smb_files"
            },
            "modified": "2022/10/09",
            "references": [
                "https://posts.specterops.io/hunting-in-active-directory-unconstrained-delegation-forests-trusts-71f2b33688e1",
                "https://dirkjanm.io/a-different-way-of-abusing-zerologon/",
                "https://twitter.com/_dirkjan/status/1309214379003588608"
            ],
            "status": "test",
            "tags": [
                "attack.lateral_movement",
                "attack.t1021.002"
            ],
            "title": "SMB Spoolss Name Piped Usage"
        },
        {
            "author": "Samir Bousseaden, @neu5ron, Tim Shelton",
            "date": "2020/04/02",
            "description": "This detection excludes known namped pipes accessible remotely and notify on newly observed ones, may help to detect lateral movement and remote exec using named pipes",
            "detection": {
                "condition": "selection and not 1 of filter_*",
                "filter_keywords": [
                    "samr",
                    "lsarpc",
                    "winreg",
                    "netlogon",
                    "srvsvc",
                    "protected_storage",
                    "wkssvc",
                    "browser",
                    "netdfs",
                    "svcctl",
                    "spoolss",
                    "ntsvcs",
                    "LSM_API_service",
                    "HydraLsPipe",
                    "TermSrv_API_service",
                    "MsFteWds"
                ],
                "selection": {
                    "path": "\\\\\\\\\\*\\\\IPC$"
                }
            },
            "falsepositives": [
                "Update the excluded named pipe to filter out any newly observed legit named pipe"
            ],
            "id": "021310d9-30a6-480a-84b7-eaa69aeb92bb",
            "level": "high",
            "logsource": {
                "product": "zeek",
                "service": "smb_files"
            },
            "modified": "2022/12/27",
            "references": [
                "https://twitter.com/menasec1/status/1104489274387451904"
            ],
            "related": [
                {
                    "id": "52d8b0c6-53d6-439a-9e41-52ad442ad9ad",
                    "type": "derived"
                }
            ],
            "status": "test",
            "tags": [
                "attack.lateral_movement",
                "attack.t1021.002"
            ],
            "title": "First Time Seen Remote Named Pipe - Zeek"
        },
        {
            "author": "Samir Bousseaden, @neu5ron, Tim Shelton",
            "date": "2020/04/02",
            "description": "detects execution of psexec or paexec with renamed service name, this rule helps to filter out the noise if psexec is used for legit purposes or if attacker uses a different psexec client other than sysinternal one",
            "detection": {
                "condition": "selection and not filter",
                "filter": {
                    "name|startswith": "PSEXESVC"
                },
                "selection": {
                    "name|endswith": [
                        "-stdin",
                        "-stdout",
                        "-stderr"
                    ],
                    "path|contains|all": [
                        "\\\\",
                        "\\IPC$"
                    ]
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "f1b3a22a-45e6-4004-afb5-4291f9c21166",
            "level": "high",
            "logsource": {
                "product": "zeek",
                "service": "smb_files"
            },
            "modified": "2022/12/27",
            "references": [
                "https://blog.menasec.net/2019/02/threat-hunting-3-detecting-psexec.html"
            ],
            "related": [
                {
                    "id": "c462f537-a1e3-41a6-b5fc-b2c2cef9bf82",
                    "type": "derived"
                }
            ],
            "status": "test",
            "tags": [
                "attack.lateral_movement",
                "attack.t1021.002"
            ],
            "title": "Suspicious PsExec Execution - Zeek"
        },
        {
            "author": "Roberto Rodriguez @Cyb3rWard0g, Open Threat Research (OTR), wagga",
            "date": "2020/10/12",
            "description": "Detects potential DLL hijack of \"iertutil.dll\" found in the DCOM InternetExplorer.Application Class",
            "detection": {
                "condition": "selection",
                "selection": {
                    "ImageLoaded|endswith": "\\Internet Explorer\\iertutil.dll",
                    "Image|endswith": "\\Internet Explorer\\iexplore.exe"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "f354eba5-623b-450f-b073-0b5b2773b6aa",
            "level": "critical",
            "logsource": {
                "category": "image_load",
                "product": "windows"
            },
            "modified": "2022/12/18",
            "references": [
                "https://threathunterplaybook.com/hunts/windows/201009-RemoteDCOMIErtUtilDLLHijack/notebook.html"
            ],
            "related": [
                {
                    "id": "e554f142-5cf3-4e55-ace9-a1b59e0def65",
                    "type": "obsoletes"
                },
                {
                    "id": "2f7979ae-f82b-45af-ac1d-2b10e93b0baa",
                    "type": "similar"
                }
            ],
            "status": "test",
            "tags": [
                "attack.lateral_movement",
                "attack.t1021.002",
                "attack.t1021.003"
            ],
            "title": "Potential DCOM InternetExplorer.Application DLL Hijack - Image Load"
        },
        {
            "author": "Roberto Rodriguez (Cyb3rWard0g), OTR (Open Threat Research)",
            "date": "2020/10/12",
            "description": "Detects a threat actor creating a file named `wbemcomn.dll` in the `C:\\Windows\\System32\\wbem\\` directory over the network and loading it for a WMI DLL Hijack scenario.",
            "detection": {
                "condition": "selection",
                "selection": {
                    "ImageLoaded|endswith": "\\wbem\\wbemcomn.dll",
                    "Image|endswith": "\\wmiprvse.exe"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "7707a579-e0d8-4886-a853-ce47e4575aaa",
            "level": "high",
            "logsource": {
                "category": "image_load",
                "product": "windows"
            },
            "modified": "2022/10/09",
            "references": [
                "https://threathunterplaybook.com/hunts/windows/201009-RemoteWMIWbemcomnDLLHijack/notebook.html"
            ],
            "status": "test",
            "tags": [
                "attack.execution",
                "attack.t1047",
                "attack.lateral_movement",
                "attack.t1021.002"
            ],
            "title": "Wmiprvse Wbemcomn DLL Hijack"
        },
        {
            "author": "Roberto Rodriguez (Cyb3rWard0g), OTR (Open Threat Research)",
            "date": "2020/10/12",
            "description": "Detects a threat actor creating a file named `wbemcomn.dll` in the `C:\\Windows\\System32\\wbem\\` directory over the network and loading it for a WMI DLL Hijack scenario.",
            "detection": {
                "condition": "selection",
                "selection": {
                    "Image": "System",
                    "TargetFilename|endswith": "\\wbem\\wbemcomn.dll"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "614a7e17-5643-4d89-b6fe-f9df1a79641c",
            "level": "critical",
            "logsource": {
                "category": "file_event",
                "product": "windows"
            },
            "modified": "2022/12/02",
            "references": [
                "https://threathunterplaybook.com/hunts/windows/201009-RemoteWMIWbemcomnDLLHijack/notebook.html"
            ],
            "status": "test",
            "tags": [
                "attack.execution",
                "attack.t1047",
                "attack.lateral_movement",
                "attack.t1021.002"
            ],
            "title": "Wmiprvse Wbemcomn DLL Hijack - File"
        },
        {
            "id": "2f7979ae-f82b-45af-ac1d-2b10e93b0baa",
            "author": "Roberto Rodriguez @Cyb3rWard0g, Open Threat Research (OTR), wagga",
            "date": "2020/10/12",
            "description": "Detects potential DLL hijack of \"iertutil.dll\" found in the DCOM InternetExplorer.Application Class over the network",
            "detection": {
                "condition": "selection",
                "selection": {
                    "Image": "System",
                    "TargetFilename|endswith": "\\Internet Explorer\\iertutil.dll"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "level": "critical",
            "logsource": {
                "category": "file_event",
                "product": "windows"
            },
            "modified": "2022/12/18",
            "references": [
                "https://threathunterplaybook.com/hunts/windows/201009-RemoteDCOMIErtUtilDLLHijack/notebook.html"
            ],
            "related": [
                {
                    "id": "e554f142-5cf3-4e55-ace9-a1b59e0def65",
                    "type": "obsoletes"
                },
                {
                    "type": "similar",
                    "id": "f354eba5-623b-450f-b073-0b5b2773b6aa"
                }
            ],
            "status": "test",
            "tags": [
                "attack.lateral_movement",
                "attack.t1021.002",
                "attack.t1021.003"
            ],
            "title": "Potential DCOM InternetExplorer.Application DLL Hijack"
        },
        {
            "author": "Florian Roth (Nextron Systems), oscd.community, Teymur Kheirkhabarov @HeirhabarovT, Zach Stanford @svch0st, Nasreddine Bencherchali",
            "date": "2019/12/30",
            "description": "Detects a copy command or a copy utility execution to or from an Admin share or remote",
            "detection": {
                "condition": "selection_target and (selection_other_tools or all of selection_cmd_* or all of selection_pwsh_*)",
                "selection_cmd_cli": {
                    "CommandLine|contains": "copy"
                },
                "selection_cmd_img": [
                    {
                        "Image|endswith": "\\cmd.exe"
                    },
                    {
                        "OriginalFileName": "Cmd.Exe"
                    }
                ],
                "selection_other_tools": [
                    {
                        "Image|endswith": [
                            "\\robocopy.exe",
                            "\\xcopy.exe"
                        ]
                    },
                    {
                        "OriginalFileName": [
                            "robocopy.exe",
                            "XCOPY.EXE"
                        ]
                    }
                ],
                "selection_pwsh_cli": {
                    "CommandLine|contains": [
                        "copy-item",
                        "copy ",
                        "cpi ",
                        " cp ",
                        "move ",
                        "move-item",
                        " mi ",
                        " mv "
                    ]
                },
                "selection_pwsh_img": [
                    {
                        "Image|contains": [
                            "\\powershell.exe",
                            "\\pwsh.exe"
                        ]
                    },
                    {
                        "OriginalFileName": [
                            "PowerShell.EXE",
                            "pwsh.dll"
                        ]
                    }
                ],
                "selection_target": {
                    "CommandLine|contains": [
                        "\\\\\\\\*$",
                        "\\Sysvol\\"
                    ]
                }
            },
            "falsepositives": [
                "Administrative scripts"
            ],
            "id": "855bc8b5-2ae8-402e-a9ed-b889e6df1900",
            "level": "medium",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/11/15",
            "references": [
                "https://twitter.com/SBousseaden/status/1211636381086339073",
                "https://drive.google.com/file/d/1lKya3_mLnR3UQuCoiYruO3qgu052_iS_/view",
                "https://www.elastic.co/guide/en/security/current/remote-file-copy-to-a-hidden-share.html",
                "https://www.microsoft.com/en-us/security/blog/2022/10/18/defenders-beware-a-case-for-post-ransomware-investigations/"
            ],
            "status": "test",
            "tags": [
                "attack.lateral_movement",
                "attack.collection",
                "attack.exfiltration",
                "attack.t1039",
                "attack.t1048",
                "attack.t1021.002"
            ],
            "title": "Copy From Or To Admin Share Or Sysvol Folder"
        },
        {
            "author": "oscd.community, Teymur Kheirkhabarov @HeirhabarovT, Zach Stanford @svch0st, wagga",
            "date": "2020/10/05",
            "description": "Detects when an admin share is mounted using net.exe",
            "detection": {
                "condition": "all of selection_*",
                "selection_cli": {
                    "CommandLine|contains|all": [
                        " use ",
                        " \\\\\\\\*\\\\*$"
                    ]
                },
                "selection_img": [
                    {
                        "Image|endswith": [
                            "\\net.exe",
                            "\\net1.exe"
                        ]
                    },
                    {
                        "OriginalFileName": [
                            "net.exe",
                            "net1.exe"
                        ]
                    }
                ]
            },
            "falsepositives": [
                "Administrators"
            ],
            "id": "3abd6094-7027-475f-9630-8ab9be7b9725",
            "level": "medium",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/02/21",
            "references": [
                "https://drive.google.com/file/d/1lKya3_mLnR3UQuCoiYruO3qgu052_iS_/view"
            ],
            "related": [
                {
                    "id": "f117933c-980c-4f78-b384-e3d838111165",
                    "type": "similar"
                }
            ],
            "status": "test",
            "tags": [
                "attack.lateral_movement",
                "attack.t1021.002"
            ],
            "title": "Windows Admin Share Mount Via Net.EXE"
        },
        {
            "author": "Bartlomiej Czyz, Relativity",
            "date": "2021/01/31",
            "description": "Detects rundll32 execution without parameters as observed when running Metasploit windows/smb/psexec exploit module",
            "detection": {
                "condition": "selection",
                "selection": {
                    "CommandLine": [
                        "rundll32.exe",
                        "rundll32"
                    ]
                }
            },
            "falsepositives": [
                "False positives may occur if a user called rundll32 from CLI with no options"
            ],
            "fields": [
                "ComputerName",
                "SubjectUserName",
                "CommandLine",
                "Image",
                "ParentImage"
            ],
            "id": "5bb68627-3198-40ca-b458-49f973db8752",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/02/28",
            "status": "test",
            "references": [
                "https://bczyz1.github.io/2021/01/30/psexec.html"
            ],
            "tags": [
                "attack.lateral_movement",
                "attack.t1021.002",
                "attack.t1570",
                "attack.execution",
                "attack.t1569.002"
            ],
            "title": "Rundll32 Execution Without Parameters"
        },
        {
            "author": "Nasreddine Bencherchali (Nextron Systems)",
            "date": "2023/02/21",
            "description": "Detects when an internet hosted webdav share is mounted using the \"net.exe\" utility",
            "detection": {
                "condition": "all of selection_*",
                "selection_cli": {
                    "CommandLine|contains|all": [
                        " use ",
                        " http"
                    ]
                },
                "selection_img": [
                    {
                        "Image|endswith": [
                            "\\net.exe",
                            "\\net1.exe"
                        ]
                    },
                    {
                        "OriginalFileName": [
                            "net.exe",
                            "net1.exe"
                        ]
                    }
                ]
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "7e6237fe-3ddb-438f-9381-9bf9de5af8d0",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/07/25",
            "references": [
                "https://drive.google.com/file/d/1lKya3_mLnR3UQuCoiYruO3qgu052_iS_/view"
            ],
            "status": "test",
            "tags": [
                "attack.lateral_movement",
                "attack.t1021.002"
            ],
            "title": "Windows Internet Hosted WebDav Share Mount Via Net.EXE"
        },
        {
            "id": "f117933c-980c-4f78-b384-e3d838111165",
            "author": "Nasreddine Bencherchali (Nextron Systems)",
            "date": "2023/02/02",
            "description": "Detects when a share is mounted using the \"net.exe\" utility",
            "detection": {
                "condition": "all of selection_*",
                "selection_cli": {
                    "CommandLine|contains": [
                        " use ",
                        " \\\\\\\\"
                    ]
                },
                "selection_img": [
                    {
                        "Image|endswith": [
                            "\\net.exe",
                            "\\net1.exe"
                        ]
                    },
                    {
                        "OriginalFileName": [
                            "net.exe",
                            "net1.exe"
                        ]
                    }
                ]
            },
            "falsepositives": [
                "Legitimate activity by administrators and scripts"
            ],
            "level": "low",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/02/21",
            "references": [
                "https://drive.google.com/file/d/1lKya3_mLnR3UQuCoiYruO3qgu052_iS_/view"
            ],
            "related": [
                {
                    "type": "similar",
                    "id": "3abd6094-7027-475f-9630-8ab9be7b9725"
                }
            ],
            "status": "test",
            "tags": [
                "attack.lateral_movement",
                "attack.t1021.002"
            ],
            "title": "Windows Share Mount Via Net.EXE"
        },
        {
            "author": "Tim Shelton (HAWK.IO)",
            "date": "2021/12/09",
            "description": "Detects a when net.exe is called with a password in the command line",
            "detection": {
                "condition": "all of selection_* and not 1 of filter_main_*",
                "filter_main_empty": {
                    "CommandLine|endswith": " "
                },
                "selection_img": [
                    {
                        "Image|endswith": [
                            "\\net.exe",
                            "\\net1.exe"
                        ]
                    },
                    {
                        "OriginalFileName": [
                            "net.exe",
                            "net1.exe"
                        ]
                    }
                ],
                "selection_cli": {
                    "CommandLine|contains|all": [
                        " use ",
                        ":*\\\\",
                        "/USER:* *"
                    ]
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "d4498716-1d52-438f-8084-4a603157d131",
            "level": "medium",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/02/21",
            "references": [
                "Internal Research"
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.initial_access",
                "attack.persistence",
                "attack.privilege_escalation",
                "attack.lateral_movement",
                "attack.t1021.002",
                "attack.t1078"
            ],
            "title": "Password Provided In Command Line Of Net.EXE"
        },
        {
            "author": "Luca Di Bartolomeo (CrimpSec)",
            "date": "2024/01/29",
            "description": "Detects the execution of SharpMove, a .NET utility performing multiple tasks such as \"Task Creation\", \"SCM\" query, VBScript execution using WMI via its PE metadata and command line options.\n",
            "detection": {
                "condition": "selection_img or all of selection_cli_*",
                "selection_cli_actions": {
                    "CommandLine|contains": [
                        "action=create",
                        "action=dcom",
                        "action=executevbs",
                        "action=hijackdcom",
                        "action=modschtask",
                        "action=modsvc",
                        "action=query",
                        "action=scm",
                        "action=startservice",
                        "action=taskscheduler"
                    ]
                },
                "selection_cli_computer": {
                    "CommandLine|contains": "computername="
                },
                "selection_img": [
                    {
                        "Image|endswith": "\\SharpMove.exe"
                    },
                    {
                        "OriginalFileName": "SharpMove.exe"
                    }
                ]
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "055fb54c-a8f4-4aee-bd44-f74cf30a0d9d",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "references": [
                "https://github.com/0xthirteen/SharpMove/",
                "https://pentestlab.blog/tag/sharpmove/"
            ],
            "status": "experimental",
            "title": "HackTool - SharpMove Tool Execution",
            "tags": [
                "attack.lateral_movement",
                "attack.t1021.002"
            ]
        },
        {
            "author": "Nasreddine Bencherchali (Nextron Systems)",
            "date": "2022/08/10",
            "description": "Detects rundll32 execution where the DLL is located on a remote location (share)",
            "detection": {
                "condition": "all of selection_*",
                "selection_cli": {
                    "CommandLine|contains": " \\\\\\\\"
                },
                "selection_img": [
                    {
                        "Image|endswith": "\\rundll32.exe"
                    },
                    {
                        "OriginalFileName": "RUNDLL32.EXE"
                    },
                    {
                        "CommandLine|contains": "rundll32"
                    }
                ]
            },
            "falsepositives": [
                "Unlikely"
            ],
            "id": "5cdb711b-5740-4fb2-ba88-f7945027afac",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "references": [
                "https://www.cybereason.com/blog/rundll32-the-infamous-proxy-for-executing-malicious-code"
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.execution",
                "attack.t1021.002",
                "attack.t1218.011"
            ],
            "title": "Rundll32 UNC Path Execution"
        },
        {
            "author": "Nikita Nazarov, oscd.community, Nasreddine Bencherchali (Nextron Systems)",
            "date": "2023/08/07",
            "description": "Detects default CSExec pipe creation",
            "detection": {
                "condition": "selection",
                "selection": {
                    "PipeName|contains": "\\csexecsvc"
                }
            },
            "falsepositives": [
                "Legitimate Administrator activity"
            ],
            "id": "f318b911-ea88-43f4-9281-0de23ede628e",
            "level": "medium",
            "logsource": {
                "category": "pipe_created",
                "product": "windows",
                "definition": "Note that you have to configure logging for Named Pipe Events in Sysmon config (Event ID 17 and Event ID 18). The basic configuration is in popular sysmon configuration (https://github.com/SwiftOnSecurity/sysmon-config), but it is worth verifying. You can also use other repo, e.g. https://github.com/Neo23x0/sysmon-config, https://github.com/olafhartong/sysmon-modular. How to test detection? You can check powershell script from this site https://svch0st.medium.com/guide-to-named-pipes-and-hunting-for-cobalt-strike-pipes-dc46b2c5f575"
            },
            "modified": "2023/11/30",
            "references": [
                "https://drive.google.com/file/d/1lKya3_mLnR3UQuCoiYruO3qgu052_iS_/view",
                "https://github.com/malcomvetter/CSExec"
            ],
            "related": [
                {
                    "id": "9e77ed63-2ecf-4c7b-b09d-640834882028",
                    "type": "obsoletes"
                }
            ],
            "status": "test",
            "tags": [
                "attack.lateral_movement",
                "attack.t1021.002",
                "attack.execution",
                "attack.t1569.002"
            ],
            "title": "PUA - CSExec Default Named Pipe"
        },
        {
            "author": "Nikita Nazarov, oscd.community, Nasreddine Bencherchali (Nextron Systems)",
            "date": "2023/08/07",
            "description": "Detects default RemCom pipe creation",
            "detection": {
                "condition": "selection",
                "selection": {
                    "PipeName|contains": "\\RemCom"
                }
            },
            "falsepositives": [
                "Legitimate Administrator activity"
            ],
            "id": "d36f87ea-c403-44d2-aa79-1a0ac7c24456",
            "level": "medium",
            "logsource": {
                "category": "pipe_created",
                "product": "windows",
                "definition": "Note that you have to configure logging for Named Pipe Events in Sysmon config (Event ID 17 and Event ID 18). The basic configuration is in popular sysmon configuration (https://github.com/SwiftOnSecurity/sysmon-config), but it is worth verifying. You can also use other repo, e.g. https://github.com/Neo23x0/sysmon-config, https://github.com/olafhartong/sysmon-modular. How to test detection? You can check powershell script from this site https://svch0st.medium.com/guide-to-named-pipes-and-hunting-for-cobalt-strike-pipes-dc46b2c5f575"
            },
            "modified": "2023/11/30",
            "references": [
                "https://drive.google.com/file/d/1lKya3_mLnR3UQuCoiYruO3qgu052_iS_/view",
                "https://github.com/kavika13/RemCom"
            ],
            "related": [
                {
                    "id": "9e77ed63-2ecf-4c7b-b09d-640834882028",
                    "type": "obsoletes"
                }
            ],
            "status": "test",
            "tags": [
                "attack.lateral_movement",
                "attack.t1021.002",
                "attack.execution",
                "attack.t1569.002"
            ],
            "title": "PUA - RemCom Default Named Pipe"
        },
        {
            "author": "Florian Roth (Nextron Systems), Wojciech Lesicki",
            "date": "2021/05/26",
            "description": "Detects known malicious service installs that appear in cases in which a Cobalt Strike beacon elevates privileges or lateral movement",
            "detection": {
                "condition": "selection_id and (selection1 or selection2 or selection3 or selection4)",
                "selection1": {
                    "ImagePath|contains|all": [
                        "ADMIN$",
                        ".exe"
                    ]
                },
                "selection2": {
                    "ImagePath|contains|all": [
                        "%COMSPEC%",
                        "start",
                        "powershell"
                    ]
                },
                "selection3": {
                    "ImagePath|contains": "powershell -nop -w hidden -encodedcommand"
                },
                "selection4": {
                    "ImagePath|base64offset|contains": "IEX (New-Object Net.Webclient).DownloadString('http://127.0.0.1:"
                },
                "selection_id": {
                    "EventID": 7045,
                    "Provider_Name": "Service Control Manager"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "5a105d34-05fc-401e-8553-272b45c1522d",
            "level": "critical",
            "logsource": {
                "product": "windows",
                "service": "system"
            },
            "modified": "2022/11/27",
            "references": [
                "https://www.sans.org/webcasts/119395",
                "https://www.crowdstrike.com/blog/getting-the-bacon-from-cobalt-strike-beacon/",
                "https://thedfirreport.com/2021/08/29/cobalt-strike-a-defenders-guide/"
            ],
            "status": "test",
            "tags": [
                "attack.execution",
                "attack.privilege_escalation",
                "attack.lateral_movement",
                "attack.t1021.002",
                "attack.t1543.003",
                "attack.t1569.002"
            ],
            "title": "CobaltStrike Service Installations - System"
        },
        {
            "author": "Omer Faruk Celik",
            "date": "2018/03/20",
            "description": "Detects the use of smbexec.py tool by detecting a specific service installation",
            "detection": {
                "condition": "selection_eid and 1 of selection_service_*",
                "selection_eid": {
                    "EventID": 7045,
                    "Provider_Name": "Service Control Manager"
                },
                "selection_service_image": {
                    "ImagePath|contains": [
                        ".bat & del ",
                        "__output 2^>^&1 >"
                    ]
                },
                "selection_service_name": {
                    "ServiceName": "BTOBTO"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "52a85084-6989-40c3-8f32-091e12e13f09",
            "level": "high",
            "logsource": {
                "product": "windows",
                "service": "system"
            },
            "modified": "2023/11/09",
            "references": [
                "https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-2-psexec-and-services/",
                "https://github.com/fortra/impacket/blob/33058eb2fde6976ea62e04bc7d6b629d64d44712/examples/smbexec.py#L286-L296",
                "https://github.com/fortra/impacket/blob/edef71f17bc1240f9f8c957bbda98662951ac3ec/examples/smbexec.py#L60"
            ],
            "status": "test",
            "tags": [
                "attack.lateral_movement",
                "attack.execution",
                "attack.t1021.002",
                "attack.t1569.002"
            ],
            "title": "smbexec.py Service Installation"
        },
        {
            "author": "Roberto Rodriguez @Cyb3rWard0g, Open Threat Research (OTR)",
            "date": "2020/10/12",
            "description": "Detects a threat actor creating a file named `iertutil.dll` in the `C:\\Program Files\\Internet Explorer\\` directory over the network for a DCOM InternetExplorer DLL Hijack scenario.",
            "detection": {
                "condition": "selection and not filter",
                "filter": {
                    "SubjectUserName|endswith": "$"
                },
                "selection": {
                    "EventID": 5145,
                    "RelativeTargetName|endswith": "\\Internet Explorer\\iertutil.dll"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "c39f0c81-7348-4965-ab27-2fde35a1b641",
            "level": "high",
            "logsource": {
                "product": "windows",
                "service": "security"
            },
            "modified": "2022/11/26",
            "references": [
                "https://threathunterplaybook.com/hunts/windows/201009-RemoteDCOMIErtUtilDLLHijack/notebook.html"
            ],
            "status": "test",
            "title": "DCOM InternetExplorer.Application Iertutil DLL Hijack - Security",
            "tags": [
                "attack.lateral_movement",
                "attack.t1021.002",
                "attack.t1021.003"
            ]
        },
        {
            "author": "Roberto Rodriguez @Cyb3rWard0g, Open Threat Research (OTR)",
            "date": "2020/10/12",
            "description": "Detects a threat actor creating a file named `wbemcomn.dll` in the `C:\\Windows\\System32\\wbem\\` directory over the network for a WMI DLL Hijack scenario.",
            "detection": {
                "condition": "selection and not filter",
                "filter": {
                    "SubjectUserName|endswith": "$"
                },
                "selection": {
                    "EventID": 5145,
                    "RelativeTargetName|endswith": "\\wbem\\wbemcomn.dll"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "f6c68d5f-e101-4b86-8c84-7d96851fd65c",
            "level": "high",
            "logsource": {
                "product": "windows",
                "service": "security"
            },
            "modified": "2022/02/24",
            "references": [
                "https://threathunterplaybook.com/hunts/windows/201009-RemoteWMIWbemcomnDLLHijack/notebook.html"
            ],
            "status": "test",
            "tags": [
                "attack.execution",
                "attack.t1047",
                "attack.lateral_movement",
                "attack.t1021.002"
            ],
            "title": "T1047 Wmiprvse Wbemcomn DLL Hijack"
        },
        {
            "author": "Bartlomiej Czyz, Relativity",
            "date": "2021/01/21",
            "description": "Detects usage of Metasploit SMB PsExec (exploit/windows/smb/psexec) and Impacket psexec.py by triggering on specific service installation",
            "detection": {
                "condition": "selection and not filter",
                "filter": {
                    "ServiceName": "PSEXESVC"
                },
                "selection": {
                    "EventID": 4697,
                    "ServiceFileName|re": "^%systemroot%\\\\[a-zA-Z]{8}\\.exe$",
                    "ServiceName|re": "(^[a-zA-Z]{4}$)|(^[a-zA-Z]{8}$)|(^[a-zA-Z]{16}$)",
                    "ServiceStartType": 3,
                    "ServiceType": "0x10"
                }
            },
            "falsepositives": [
                "Possible, different agents with a 8 character binary and a 4, 8 or 16 character service name"
            ],
            "fields": [
                "ComputerName",
                "SubjectDomainName",
                "SubjectUserName",
                "ServiceName",
                "ServiceFileName"
            ],
            "id": "6fb63b40-e02a-403e-9ffd-3bcc1d749442",
            "level": "high",
            "logsource": {
                "definition": "The 'System Security Extension' audit subcategory need to be enabled to log the EID 4697",
                "product": "windows",
                "service": "security"
            },
            "modified": "2022/10/05",
            "status": "test",
            "references": [
                "https://bczyz1.github.io/2021/01/30/psexec.html"
            ],
            "related": [
                {
                    "id": "1a17ce75-ff0d-4f02-9709-2b7bb5618cf0",
                    "type": "derived"
                }
            ],
            "tags": [
                "attack.lateral_movement",
                "attack.t1021.002",
                "attack.t1570",
                "attack.execution",
                "attack.t1569.002"
            ],
            "title": "Metasploit Or Impacket Service Installation Via SMB PsExec"
        },
        {
            "author": "Florian Roth (Nextron Systems)",
            "date": "2017/03/04",
            "description": "Detects access to ADMIN$ network share",
            "detection": {
                "condition": "selection and not 1 of filter_*",
                "filter_main_computer_account": {
                    "SubjectUserName|endswith": "$"
                },
                "selection": {
                    "EventID": 5140,
                    "ShareName": "Admin$"
                }
            },
            "falsepositives": [
                "Legitimate administrative activity"
            ],
            "id": "098d7118-55bc-4912-a836-dc6483a8d150",
            "level": "low",
            "logsource": {
                "definition": "Requirements: The advanced audit policy setting \"Object Access > Audit File Share\" must be configured for Success/Failure",
                "product": "windows",
                "service": "security"
            },
            "modified": "2024/01/16",
            "references": [
                "https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-5140"
            ],
            "status": "test",
            "tags": [
                "attack.lateral_movement",
                "attack.t1021.002"
            ],
            "title": "Access To ADMIN$ Network Share"
        },
        {
            "id": "52d8b0c6-53d6-439a-9e41-52ad442ad9ad",
            "author": "Samir Bousseaden",
            "date": "2019/04/03",
            "description": "This detection excludes known namped pipes accessible remotely and notify on newly observed ones, may help to detect lateral movement and remote exec using named pipes",
            "detection": {
                "condition": "selection1 and not false_positives",
                "false_positives": {
                    "RelativeTargetName": [
                        "atsvc",
                        "samr",
                        "lsarpc",
                        "lsass",
                        "winreg",
                        "netlogon",
                        "srvsvc",
                        "protected_storage",
                        "wkssvc",
                        "browser",
                        "netdfs",
                        "svcctl",
                        "spoolss",
                        "ntsvcs",
                        "LSM_API_service",
                        "HydraLsPipe",
                        "TermSrv_API_service",
                        "MsFteWds",
                        "sql\\query",
                        "eventlog"
                    ]
                },
                "selection1": {
                    "EventID": 5145,
                    "ShareName": "\\\\\\\\\\*\\\\IPC$"
                }
            },
            "falsepositives": [
                "Update the excluded named pipe to filter out any newly observed legit named pipe"
            ],
            "level": "high",
            "logsource": {
                "definition": "The advanced audit policy setting \"Object Access > Audit Detailed File Share\" must be configured for Success/Failure",
                "product": "windows",
                "service": "security"
            },
            "modified": "2023/03/14",
            "references": [
                "https://twitter.com/menasec1/status/1104489274387451904"
            ],
            "status": "test",
            "tags": [
                "attack.lateral_movement",
                "attack.t1021.002"
            ],
            "title": "First Time Seen Remote Named Pipe"
        },
        {
            "author": "Samir Bousseaden",
            "date": "2019/04/03",
            "description": "Detects remote service activity via remote access to the svcctl named pipe",
            "detection": {
                "condition": "selection",
                "selection": {
                    "EventID": 5145,
                    "Accesses|contains": "WriteData",
                    "ShareName": "\\\\\\\\\\*\\\\IPC$",
                    "RelativeTargetName": "svcctl"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "586a8d6b-6bfe-4ad9-9d78-888cd2fe50c3",
            "level": "medium",
            "logsource": {
                "definition": "The advanced audit policy setting \"Object Access > Audit Detailed File Share\" must be configured for Success/Failure",
                "product": "windows",
                "service": "security"
            },
            "modified": "2022/08/11",
            "references": [
                "https://blog.menasec.net/2019/03/threat-hunting-26-remote-windows.html"
            ],
            "status": "test",
            "tags": [
                "attack.lateral_movement",
                "attack.persistence",
                "attack.t1021.002"
            ],
            "title": "Remote Service Activity via SVCCTL Named Pipe"
        },
        {
            "author": "Bhabesh Raj",
            "date": "2020/12/14",
            "description": "Detects execution of Impacket's psexec.py.",
            "detection": {
                "condition": "selection1",
                "selection1": {
                    "EventID": 5145,
                    "ShareName": "\\\\\\\\\\*\\\\IPC$",
                    "RelativeTargetName|contains": [
                        "RemCom_stdin",
                        "RemCom_stdout",
                        "RemCom_stderr"
                    ]
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "32d56ea1-417f-44ff-822b-882873f5f43b",
            "level": "high",
            "logsource": {
                "definition": "The advanced audit policy setting \"Object Access > Audit Detailed File Share\" must be configured for Success/Failure",
                "product": "windows",
                "service": "security"
            },
            "modified": "2022/09/22",
            "references": [
                "https://blog.menasec.net/2019/02/threat-hunting-3-detecting-psexec.html"
            ],
            "status": "test",
            "tags": [
                "attack.lateral_movement",
                "attack.t1021.002"
            ],
            "title": "Impacket PsExec Execution"
        },
        {
            "id": "c462f537-a1e3-41a6-b5fc-b2c2cef9bf82",
            "author": "Samir Bousseaden",
            "date": "2019/04/03",
            "description": "detects execution of psexec or paexec with renamed service name, this rule helps to filter out the noise if psexec is used for legit purposes or if attacker uses a different psexec client other than sysinternal one",
            "detection": {
                "condition": "selection1 and not filter",
                "filter": {
                    "RelativeTargetName|startswith": "PSEXESVC"
                },
                "selection1": {
                    "EventID": 5145,
                    "ShareName": "\\\\\\\\\\*\\\\IPC$",
                    "RelativeTargetName|endswith": [
                        "-stdin",
                        "-stdout",
                        "-stderr"
                    ]
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "level": "high",
            "logsource": {
                "definition": "The advanced audit policy setting \"Object Access > Audit Detailed File Share\" must be configured for Success/Failure",
                "product": "windows",
                "service": "security"
            },
            "modified": "2022/08/11",
            "references": [
                "https://blog.menasec.net/2019/02/threat-hunting-3-detecting-psexec.html"
            ],
            "status": "test",
            "tags": [
                "attack.lateral_movement",
                "attack.t1021.002"
            ],
            "title": "Suspicious PsExec Execution"
        },
        {
            "author": "Roberto Rodriguez @Cyb3rWard0g",
            "date": "2019/08/10",
            "description": "Detects access to a protected_storage service over the network. Potential abuse of DPAPI to extract domain backup keys from Domain Controllers",
            "detection": {
                "condition": "selection",
                "selection": {
                    "EventID": 5145,
                    "RelativeTargetName": "protected_storage",
                    "ShareName|contains": "IPC"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "45545954-4016-43c6-855e-eae8f1c369dc",
            "level": "high",
            "logsource": {
                "product": "windows",
                "service": "security"
            },
            "modified": "2021/11/27",
            "references": [
                "https://threathunterplaybook.com/hunts/windows/190620-DomainDPAPIBackupKeyExtraction/notebook.html"
            ],
            "status": "test",
            "tags": [
                "attack.lateral_movement",
                "attack.t1021.002"
            ],
            "title": "Protected Storage Service Access"
        },
        {
            "author": "Florian Roth (Nextron Systems), Wojciech Lesicki",
            "date": "2021/05/26",
            "description": "Detects known malicious service installs that appear in cases in which a Cobalt Strike beacon elevates privileges or lateral movement",
            "detection": {
                "condition": "event_id and 1 of selection*",
                "event_id": {
                    "EventID": 4697
                },
                "selection1": {
                    "ServiceFileName|contains|all": [
                        "ADMIN$",
                        ".exe"
                    ]
                },
                "selection2": {
                    "ServiceFileName|contains|all": [
                        "%COMSPEC%",
                        "start",
                        "powershell"
                    ]
                },
                "selection3": {
                    "ServiceFileName|contains": "powershell -nop -w hidden -encodedcommand"
                },
                "selection4": {
                    "ServiceFileName|base64offset|contains": "IEX (New-Object Net.Webclient).DownloadString('http://127.0.0.1:"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "d7a95147-145f-4678-b85d-d1ff4a3bb3f6",
            "level": "high",
            "modified": "2022/11/27",
            "logsource": {
                "definition": "The 'System Security Extension' audit subcategory need to be enabled to log the EID 4697",
                "product": "windows",
                "service": "security"
            },
            "references": [
                "https://www.sans.org/webcasts/119395",
                "https://www.crowdstrike.com/blog/getting-the-bacon-from-cobalt-strike-beacon/",
                "https://thedfirreport.com/2021/08/29/cobalt-strike-a-defenders-guide/"
            ],
            "related": [
                {
                    "type": "derived",
                    "id": "5a105d34-05fc-401e-8553-272b45c1522d"
                }
            ],
            "status": "test",
            "tags": [
                "attack.execution",
                "attack.privilege_escalation",
                "attack.lateral_movement",
                "attack.t1021.002",
                "attack.t1543.003",
                "attack.t1569.002"
            ],
            "title": "CobaltStrike Service Installations - Security"
        },
        {
            "author": "Jose Rodriguez (@Cyb3rPandaH), OTR (Open Threat Research)",
            "date": "2020/08/06",
            "description": "Look for non-system accounts SMB accessing a file with write (0x2) access mask via administrative share (i.e C$).",
            "detection": {
                "condition": "selection and not filter",
                "filter": {
                    "SubjectUserName|endswith": "$"
                },
                "selection": {
                    "EventID": 5145,
                    "AccessMask": "0x2",
                    "ShareName|endswith": "C$"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "b210394c-ba12-4f89-9117-44a2464b9511",
            "level": "high",
            "logsource": {
                "product": "windows",
                "service": "security"
            },
            "modified": "2021/11/27",
            "references": [
                "https://github.com/OTRF/ThreatHunter-Playbook/blob/f7a58156dbfc9b019f17f638b8c62d22e557d350/playbooks/WIN-201012004336.yaml",
                "https://securitydatasets.com/notebooks/atomic/windows/lateral_movement/SDWIN-200806015757.html?highlight=create%20file"
            ],
            "status": "test",
            "tags": [
                "attack.lateral_movement",
                "attack.t1021.002"
            ],
            "title": "SMB Create Remote File Admin Share"
        },
        {
            "author": "OTR (Open Threat Research)",
            "date": "2018/11/28",
            "description": "Detects the use of the spoolss named pipe over SMB. This can be used to trigger the authentication via NTLM of any machine that has the spoolservice enabled.",
            "detection": {
                "condition": "selection",
                "selection": {
                    "EventID": 5145,
                    "ShareName": "\\\\\\\\\\*\\\\IPC$",
                    "RelativeTargetName": "spoolss"
                }
            },
            "falsepositives": [
                "Domain Controllers acting as printer servers too? :)"
            ],
            "id": "214e8f95-100a-4e04-bb31-ef6cba8ce07e",
            "level": "medium",
            "logsource": {
                "product": "windows",
                "service": "security"
            },
            "modified": "2022/08/11",
            "references": [
                "https://posts.specterops.io/hunting-in-active-directory-unconstrained-delegation-forests-trusts-71f2b33688e1",
                "https://dirkjanm.io/a-different-way-of-abusing-zerologon/",
                "https://twitter.com/_dirkjan/status/1309214379003588608"
            ],
            "status": "test",
            "tags": [
                "attack.lateral_movement",
                "attack.t1021.002"
            ],
            "title": "DCERPC SMB Spoolss Named Pipe"
        },
        {
            "author": "Chakib Gzenayi (@Chak092), Hosni Mribah",
            "date": "2020/05/06",
            "description": "Alerts on Metasploit host's authentications on the domain.",
            "detection": {
                "condition": "1 of selection*",
                "selection1": {
                    "AuthenticationPackageName": "NTLM",
                    "EventID": [
                        4625,
                        4624
                    ],
                    "LogonType": 3,
                    "WorkstationName|re": "^[A-Za-z0-9]{16}$"
                },
                "selection2": {
                    "EventID": 4776,
                    "Workstation|re": "^[A-Za-z0-9]{16}$"
                }
            },
            "falsepositives": [
                "Linux hostnames composed of 16 characters."
            ],
            "id": "72124974-a68b-4366-b990-d30e0b2a190d",
            "level": "high",
            "logsource": {
                "product": "windows",
                "service": "security"
            },
            "modified": "2024/01/25",
            "references": [
                "https://github.com/rapid7/metasploit-framework/blob/1416b5776d963f21b7b5b45d19f3e961201e0aed/lib/rex/proto/smb/client.rb"
            ],
            "status": "test",
            "tags": [
                "attack.lateral_movement",
                "attack.t1021.002"
            ],
            "title": "Metasploit SMB Authentication"
        },
        {
            "author": "frack113",
            "date": "2022/08/13",
            "description": "Adversaries may use to interact with a remote network share using Server Message Block (SMB). The adversary may then perform actions as the logged-on user.",
            "detection": {
                "condition": "selection",
                "selection": {
                    "ScriptBlockText|contains|all": [
                        "New-PSDrive",
                        "-psprovider ",
                        "filesystem",
                        "-root ",
                        "\\\\\\\\",
                        "$"
                    ]
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "1c563233-030e-4a07-af8c-ee0490a66d3a",
            "level": "medium",
            "logsource": {
                "category": "ps_script",
                "product": "windows",
                "definition": "Requirements: Script Block Logging must be enabled"
            },
            "references": [
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1021.002/T1021.002.md#atomic-test-2---map-admin-share-powershell",
                "https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.management/new-psdrive?view=powershell-7.2"
            ],
            "status": "test",
            "title": "Suspicious New-PSDrive to Admin Share",
            "tags": [
                "attack.lateral_movement",
                "attack.t1021.002"
            ]
        },
        {
            "author": "Wojciech Lesicki",
            "date": "2021/06/29",
            "description": "Detects known malicious service installs that appear in cases in which a Cobalt Strike beacon elevates privileges or lateral movement.\n",
            "detection": {
                "condition": "all of selection_*",
                "selection_details": [
                    {
                        "Details|contains|all": [
                            "ADMIN$",
                            ".exe"
                        ]
                    },
                    {
                        "Details|contains|all": [
                            "%COMSPEC%",
                            "start",
                            "powershell"
                        ]
                    }
                ],
                "selection_key": [
                    {
                        "TargetObject|contains": "\\System\\CurrentControlSet\\Services"
                    },
                    {
                        "TargetObject|contains|all": [
                            "\\System\\ControlSet",
                            "\\Services"
                        ]
                    }
                ]
            },
            "falsepositives": [
                "Unlikely"
            ],
            "id": "61a7697c-cb79-42a8-a2ff-5f0cdfae0130",
            "level": "high",
            "logsource": {
                "category": "registry_set",
                "product": "windows"
            },
            "modified": "2024/03/25",
            "references": [
                "https://www.sans.org/webcasts/tech-tuesday-workshop-cobalt-strike-detection-log-analysis-119395"
            ],
            "status": "test",
            "tags": [
                "attack.execution",
                "attack.privilege_escalation",
                "attack.lateral_movement",
                "attack.t1021.002",
                "attack.t1543.003",
                "attack.t1569.002"
            ],
            "title": "Potential CobaltStrike Service Installations - Registry"
        }
    ]
}