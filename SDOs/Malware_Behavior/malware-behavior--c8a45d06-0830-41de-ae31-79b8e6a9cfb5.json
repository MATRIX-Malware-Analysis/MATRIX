{
    "type": "malware-behavior",
    "spec_version": "2.1",
    "id": "malware-behavior--c8a45d06-0830-41de-ae31-79b8e6a9cfb5",
    "created": "2024-08-13T14:46:36.684307Z",
    "modified": "2024-08-13T14:46:45.517772Z",
    "name": "Steal or Forge Kerberos Tickets: Kerberoasting",
    "description": "Adversaries may abuse a valid Kerberos ticket-granting ticket (TGT) or sniff network traffic to obtain a ticket-granting service (TGS) ticket that may be vulnerable to Brute Force.[1][2] Service principal names (SPNs) are used to uniquely identify each instance of a Windows service. To enable authentication, Kerberos requires that SPNs be associated with at least one service logon account (an account specifically tasked with running a service[3]).[4][5][6][7]Adversaries possessing a valid Kerberos ticket-granting ticket (TGT) may request one or more Kerberos ticket-granting service (TGS) service tickets for any SPN from a domain controller (DC).[1][2] Portions of these tickets may be encrypted with the RC4 algorithm, meaning the Kerberos 5 TGS-REP etype 23 hash of the service account associated with the SPN is used as the private key and is thus vulnerable to offline Brute Force attacks that may expose plaintext credentials.[2][1] [7]This same behavior could be executed using service tickets captured from network traffic.[2]Cracked hashes may enable Persistence, Privilege Escalation, and Lateral Movement via access to Valid Accounts.[6]",
    "object_marking_refs": [
        "marking-definition--613f2e26-407d-48c7-9eca-b8e91df99dc9"
    ],
    "external_references": [
        {
            "source_name": "MITRE ATT&CK",
            "url": "https://attack.mitre.org/techniques/T1558/003",
            "external_id": "T1558/003"
        },
        {
            "source_name": "CAPEC 509",
            "external_id": "malware-behavior--e0450dea-5218-4e1e-9627-1e5b514ef7ff"
        }
    ],
    "x_mitre_detection_rules": [
        {
            "author": "sigma",
            "date": "2020/02/12",
            "description": "Detects kerberos TGS request using RC4 encryption which may be indicative of kerberoasting",
            "detection": {
                "computer_acct": {
                    "service|startswith": "$"
                },
                "condition": "selection and not computer_acct",
                "selection": {
                    "cipher": "rc4-hmac",
                    "request_type": "TGS"
                }
            },
            "falsepositives": [
                "Normal enterprise SPN requests activity"
            ],
            "id": "503fe26e-b5f2-4944-a126-eab405cc06e5",
            "level": "medium",
            "logsource": {
                "product": "zeek",
                "service": "kerberos"
            },
            "modified": "2021/11/27",
            "references": [
                "https://adsecurity.org/?p=3458"
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1558.003"
            ],
            "title": "Kerberos Network Traffic RC4 Ticket Encryption"
        },
        {
            "author": "Florian Roth (Nextron Systems)",
            "date": "2022/04/27",
            "description": "Detects the use of KrbRelay, a Kerberos relaying tool",
            "detection": {
                "condition": "1 of selection_*",
                "selection_cli_1": {
                    "CommandLine|contains|all": [
                        " -spn ",
                        " -clsid ",
                        " -rbcd "
                    ]
                },
                "selection_cli_2": {
                    "CommandLine|contains|all": [
                        "shadowcred",
                        "clsid",
                        "spn"
                    ]
                },
                "selection_cli_3": {
                    "CommandLine|contains|all": [
                        "spn ",
                        "session ",
                        "clsid "
                    ]
                },
                "selection_img": [
                    {
                        "Image|endswith": "\\KrbRelay.exe"
                    },
                    {
                        "OriginalFileName": "KrbRelay.exe"
                    }
                ]
            },
            "falsepositives": [
                "Unlikely"
            ],
            "id": "e96253b8-6b3b-4f90-9e59-3b24b99cf9b4",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/02/04",
            "references": [
                "https://github.com/cube0x0/KrbRelay"
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1558.003"
            ],
            "title": "HackTool - KrbRelay Execution"
        },
        {
            "author": "Markus Neis, keepwatch",
            "date": "2018/11/14",
            "description": "Detects service principal name (SPN) enumeration used for Kerberoasting",
            "detection": {
                "condition": "all of selection_*",
                "selection_cli": {
                    "CommandLine|contains": [
                        " -q ",
                        " /q "
                    ]
                },
                "selection_pe": [
                    {
                        "Image|endswith": "\\setspn.exe"
                    },
                    {
                        "OriginalFileName": "setspn.exe"
                    },
                    {
                        "Description|contains|all": [
                            "Query or reset the computer",
                            "SPN attribute"
                        ]
                    }
                ]
            },
            "falsepositives": [
                "Administration activity"
            ],
            "id": "1eeed653-dbc8-4187-ad0c-eeebb20e6599",
            "level": "medium",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/10/23",
            "references": [
                "https://web.archive.org/web/20200329173843/https://p16.praetorian.com/blog/how-to-use-kerberoasting-t1208-for-privilege-escalation",
                "https://www.praetorian.com/blog/how-to-use-kerberoasting-t1208-for-privilege-escalation/?edition=2019"
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1558.003"
            ],
            "title": "Potential SPN Enumeration Via Setspn.EXE"
        },
        {
            "author": "Florian Roth (Nextron Systems)",
            "date": "2018/12/19",
            "description": "Detects the execution of the hacktool Rubeus via PE information of command line parameters",
            "detection": {
                "condition": "selection",
                "selection": [
                    {
                        "Image|endswith": "\\Rubeus.exe"
                    },
                    {
                        "OriginalFileName": "Rubeus.exe"
                    },
                    {
                        "Description": "Rubeus"
                    },
                    {
                        "CommandLine|contains": [
                            "asreproast ",
                            "dump /service:krbtgt ",
                            "dump /luid:0x",
                            "kerberoast ",
                            "createnetonly /program:",
                            "ptt /ticket:",
                            "/impersonateuser:",
                            "renew /ticket:",
                            "asktgt /user:",
                            "harvest /interval:",
                            "s4u /user:",
                            "s4u /ticket:",
                            "hash /password:",
                            "golden /aes256:",
                            "silver /user:"
                        ]
                    }
                ]
            },
            "falsepositives": [
                "Unlikely"
            ],
            "id": "7ec2c172-dceb-4c10-92c9-87c1881b7e18",
            "level": "critical",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/04/20",
            "references": [
                "https://blog.harmj0y.net/redteaming/from-kekeo-to-rubeus",
                "https://m0chan.github.io/2019/07/31/How-To-Attack-Kerberos-101.html",
                "https://github.com/GhostPack/Rubeus"
            ],
            "related": [
                {
                    "type": "similar",
                    "id": "7ec2c172-dceb-4c10-92c9-87c1881b7e18"
                }
            ],
            "status": "stable",
            "tags": [
                "attack.credential_access",
                "attack.t1003",
                "attack.t1558.003",
                "attack.lateral_movement",
                "attack.t1550.003"
            ],
            "title": "HackTool - Rubeus Execution"
        },
        {
            "author": "Florian Roth (Nextron Systems)",
            "date": "2022/04/26",
            "description": "Detects KrbRelayUp used to perform a universal no-fix local privilege escalation in Windows domain environments where LDAP signing is not enforced",
            "detection": {
                "condition": "1 of selection_*",
                "selection_cli_1": {
                    "CommandLine|contains|all": [
                        " relay ",
                        " -Domain ",
                        " -ComputerName "
                    ]
                },
                "selection_cli_2": {
                    "CommandLine|contains|all": [
                        " krbscm ",
                        " -sc "
                    ]
                },
                "selection_cli_3": {
                    "CommandLine|contains|all": [
                        " spawn ",
                        " -d ",
                        " -cn ",
                        " -cp "
                    ]
                },
                "selection_img": [
                    {
                        "Image|endswith": "\\KrbRelayUp.exe"
                    },
                    {
                        "OriginalFileName": "KrbRelayUp.exe"
                    }
                ]
            },
            "falsepositives": [
                "Unlikely"
            ],
            "id": "12827a56-61a4-476a-a9cb-f3068f191073",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/02/04",
            "references": [
                "https://github.com/Dec0ne/KrbRelayUp"
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1558.003",
                "attack.lateral_movement",
                "attack.t1550.003"
            ],
            "title": "HackTool - KrbRelayUp Execution"
        },
        {
            "author": "Nasreddine Bencherchali (Nextron Systems)",
            "date": "2024/06/27",
            "description": "Detects the use of RemoteKrbRelay, a Kerberos relaying tool via CommandLine flags and PE metadata.\n",
            "detection": {
                "condition": "selection_img or selection_cli_required or all of selection_cli_attack_rbcd_* or selection_cli_attack_changepass or selection_cli_attack_addgrpname or selection_cli_attack_smb",
                "selection_cli_attack_addgrpname": {
                    "CommandLine|contains|all": [
                        "-addgroupmember ",
                        "-group ",
                        "-groupuser "
                    ]
                },
                "selection_cli_attack_changepass": {
                    "CommandLine|contains": "-chp ",
                    "CommandLine|contains|all": [
                        "-chpPass ",
                        "-chpUser "
                    ]
                },
                "selection_cli_attack_rbcd_main": {
                    "CommandLine|contains": "-rbcd "
                },
                "selection_cli_attack_rbcd_options": {
                    "CommandLine|contains": [
                        "-cn ",
                        "--computername "
                    ]
                },
                "selection_cli_attack_smb": {
                    "CommandLine|contains": [
                        "interactive",
                        "secrets",
                        "service-add"
                    ],
                    "CommandLine|contains|all": [
                        "-smb ",
                        "--smbkeyword "
                    ]
                },
                "selection_cli_required": {
                    "CommandLine|contains|all": [
                        " -clsid ",
                        " -target ",
                        " -victim "
                    ]
                },
                "selection_img": [
                    {
                        "Image|endswith": "\\RemoteKrbRelay.exe"
                    },
                    {
                        "OriginalFileName": "RemoteKrbRelay.exe"
                    }
                ]
            },
            "falsepositives": [
                "Unlikely"
            ],
            "id": "a7664b14-75fb-4a50-a223-cb9bc0afbacf",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "references": [
                "https://github.com/CICADA8-Research/RemoteKrbRelay"
            ],
            "status": "experimental",
            "title": "HackTool - RemoteKrbRelay Execution",
            "tags": [
                "attack.credential_access",
                "attack.t1558.003"
            ]
        },
        {
            "author": "frack113",
            "date": "2021/12/15",
            "description": "The attacker creates a computer object using those permissions with a password known to her.\nAfter that she clears the attribute ServicePrincipalName on the computer object.\nBecause she created the object (CREATOR OWNER), she gets granted additional permissions and can do many changes to the object.\n",
            "detection": {
                "condition": "selection",
                "selection": {
                    "EventID": [
                        16990,
                        16991
                    ],
                    "Provider_Name": "Microsoft-Windows-Directory-Services-SAM"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "fields": [
                "samAccountName"
            ],
            "id": "e80a0fee-1a62-4419-b31e-0d0db6e6013a",
            "level": "medium",
            "logsource": {
                "product": "windows",
                "service": "system"
            },
            "modified": "2023/04/14",
            "status": "test",
            "references": [
                "https://cloudbrothers.info/en/exploit-kerberos-samaccountname-spoofing/"
            ],
            "related": [
                {
                    "id": "44bbff3e-4ca3-452d-a49a-6efa4cafa06f",
                    "type": "similar"
                }
            ],
            "tags": [
                "attack.credential_access",
                "attack.t1558.003"
            ],
            "title": "Potential CVE-2021-42287 Exploitation Attempt"
        },
        {
            "author": "@SerkinValery",
            "date": "2024/03/07",
            "description": "Detects errors when a target server doesn't have suitable keys for generating kerberos tickets.\nThis issue can occur for example when a service uses a user account or a computer account that is configured for only DES encryption on a computer that is running Windows 7 which has DES encryption for Kerberos authentication disabled.\n",
            "detection": {
                "condition": "selection",
                "selection": {
                    "EventID": [
                        16,
                        27
                    ],
                    "Provider_Name": "Microsoft-Windows-Kerberos-Key-Distribution-Center"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "b1e0b3f5-b62e-41be-886a-daffde446ad4",
            "level": "low",
            "references": [
                "https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/dd348773(v=ws.10)",
                "https://learn.microsoft.com/en-us/troubleshoot/windows-server/windows-security/kdc-event-16-27-des-encryption-disabled"
            ],
            "logsource": {
                "product": "windows",
                "service": "system"
            },
            "status": "experimental",
            "title": "No Suitable Encryption Key Found For Generating Kerberos Ticket",
            "tags": [
                "attack.credential_access",
                "attack.t1558.003"
            ]
        },
        {
            "author": "Florian Roth (Nextron Systems)",
            "date": "2017/02/06",
            "description": "Detects service ticket requests using RC4 encryption type",
            "detection": {
                "condition": "selection and not reduction",
                "reduction": {
                    "ServiceName|endswith": "$"
                },
                "selection": {
                    "EventID": 4769,
                    "TicketEncryptionType": "0x17",
                    "TicketOptions": "0x40810000"
                }
            },
            "falsepositives": [
                "Service accounts used on legacy systems (e.g. NetApp)",
                "Windows Domains with DFL 2003 and legacy systems"
            ],
            "id": "496a0e47-0a33-4dca-b009-9e6ca3591f39",
            "level": "medium",
            "logsource": {
                "product": "windows",
                "service": "security"
            },
            "modified": "2022/06/19",
            "references": [
                "https://adsecurity.org/?p=3458",
                "https://www.trimarcsecurity.com/single-post/TrimarcResearch/Detecting-Kerberoasting-Activity"
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1558.003"
            ],
            "title": "Suspicious Kerberos RC4 Ticket Encryption"
        },
        {
            "author": "Ilyas Ochkov, oscd.community",
            "date": "2019/10/24",
            "description": "Detects uncommon outbound network activity via Kerberos default port indicating possible lateral movement or first stage PrivEsc via delegation.\n",
            "detection": {
                "condition": "selection and not 1 of filter_main_* and not 1 of filter_optional_*",
                "filter_main_lsass": {
                    "Application|endswith": "\\Windows\\System32\\lsass.exe",
                    "Application|startswith": [
                        "\\device\\harddiskvolume",
                        "C:"
                    ]
                },
                "filter_optional_chrome": {
                    "Application|endswith": [
                        "\\Program Files (x86)\\Google\\Chrome\\Application\\chrome.exe",
                        "\\Program Files\\Google\\Chrome\\Application\\chrome.exe"
                    ],
                    "Application|startswith": [
                        "\\device\\harddiskvolume",
                        "C:"
                    ]
                },
                "filter_optional_firefox": {
                    "Application|endswith": [
                        "\\Program Files (x86)\\Mozilla Firefox\\firefox.exe",
                        "\\Program Files\\Mozilla Firefox\\firefox.exe"
                    ],
                    "Application|startswith": [
                        "\\device\\harddiskvolume",
                        "C:"
                    ]
                },
                "filter_optional_tomcat": {
                    "Application|endswith": "\\tomcat\\bin\\tomcat8.exe"
                },
                "selection": {
                    "DestPort": 88,
                    "EventID": 5156
                }
            },
            "falsepositives": [
                "Web Browsers and third party application might generate similar activity. An initial baseline is required."
            ],
            "id": "eca91c7c-9214-47b9-b4c5-cb1d7e4f2350",
            "level": "medium",
            "logsource": {
                "product": "windows",
                "service": "security"
            },
            "modified": "2024/03/15",
            "references": [
                "https://github.com/GhostPack/Rubeus"
            ],
            "related": [
                {
                    "id": "e54979bd-c5f9-4d6c-967b-a04b19ac4c74",
                    "type": "similar"
                }
            ],
            "status": "test",
            "tags": [
                "attack.lateral_movement",
                "attack.t1558.003"
            ],
            "title": "Uncommon Outbound Kerberos Connection - Security"
        },
        {
            "author": "Roberto Rodriguez (source), Ilyas Ochkov (rule), oscd.community",
            "date": "2019/10/24",
            "description": "The 'LsaRegisterLogonProcess' function verifies that the application making the function call is a logon process by checking that it has the SeTcbPrivilege privilege set. Possible Rubeus tries to get a handle to LSA.",
            "detection": {
                "condition": "selection",
                "selection": {
                    "EventID": 4673,
                    "Keywords": "0x8010000000000000",
                    "Service": "LsaRegisterLogonProcess()"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "6daac7fc-77d1-449a-a71a-e6b4d59a0e54",
            "level": "high",
            "logsource": {
                "product": "windows",
                "service": "security"
            },
            "modified": "2022/12/25",
            "references": [
                "https://posts.specterops.io/hunting-in-active-directory-unconstrained-delegation-forests-trusts-71f2b33688e1"
            ],
            "status": "test",
            "tags": [
                "attack.lateral_movement",
                "attack.privilege_escalation",
                "attack.t1558.003"
            ],
            "title": "User Couldn't Call a Privileged Service 'LsaRegisterLogonProcess'"
        },
        {
            "author": "Roberto Rodriguez (source), Ilyas Ochkov (rule), oscd.community",
            "date": "2019/10/24",
            "description": "Detects potential use of Rubeus via registered new trusted logon process",
            "detection": {
                "condition": "selection",
                "selection": {
                    "EventID": 4611,
                    "LogonProcessName": "User32LogonProcesss"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "12e6d621-194f-4f59-90cc-1959e21e69f7",
            "level": "high",
            "logsource": {
                "product": "windows",
                "service": "security"
            },
            "modified": "2022/10/09",
            "references": [
                "https://posts.specterops.io/hunting-in-active-directory-unconstrained-delegation-forests-trusts-71f2b33688e1"
            ],
            "status": "test",
            "tags": [
                "attack.lateral_movement",
                "attack.privilege_escalation",
                "attack.t1558.003"
            ],
            "title": "Register new Logon Process by Rubeus"
        },
        {
            "author": "Christian Burkard (Nextron Systems), Florian Roth (Nextron Systems)",
            "date": "2023/04/27",
            "description": "Detects the execution of the hacktool Rubeus using specific command line flags",
            "detection": {
                "condition": "selection",
                "selection": {
                    "ScriptBlockText|contains": [
                        "asreproast ",
                        "dump /service:krbtgt ",
                        "dump /luid:0x",
                        "kerberoast ",
                        "createnetonly /program:",
                        "ptt /ticket:",
                        "/impersonateuser:",
                        "renew /ticket:",
                        "asktgt /user:",
                        "harvest /interval:",
                        "s4u /user:",
                        "s4u /ticket:",
                        "hash /password:",
                        "golden /aes256:",
                        "silver /user:"
                    ]
                }
            },
            "falsepositives": [
                "Unlikely"
            ],
            "id": "3245cd30-e015-40ff-a31d-5cadd5f377ec",
            "level": "high",
            "logsource": {
                "category": "ps_script",
                "product": "windows",
                "definition": "Requirements: Script Block Logging must be enabled"
            },
            "references": [
                "https://blog.harmj0y.net/redteaming/from-kekeo-to-rubeus",
                "https://m0chan.github.io/2019/07/31/How-To-Attack-Kerberos-101.html",
                "https://github.com/GhostPack/Rubeus"
            ],
            "related": [
                {
                    "type": "similar",
                    "id": "7ec2c172-dceb-4c10-92c9-87c1881b7e18"
                }
            ],
            "status": "test",
            "title": "HackTool - Rubeus Execution - ScriptBlock",
            "tags": [
                "attack.credential_access",
                "attack.t1003",
                "attack.t1558.003",
                "attack.lateral_movement",
                "attack.t1550.003"
            ]
        },
        {
            "author": "frack113",
            "date": "2021/12/28",
            "description": "utilize native PowerShell Identity modules to query the domain to extract the Service Principal Names for a single computer.\nThis behavior is typically used during a kerberos or silver ticket attack.\nA successful execution will output the SPNs for the endpoint in question.\n",
            "detection": {
                "condition": "selection",
                "selection": {
                    "ScriptBlockText|contains": "System.IdentityModel.Tokens.KerberosRequestorSecurityToken"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "a861d835-af37-4930-bcd6-5b178bfb54df",
            "level": "high",
            "logsource": {
                "category": "ps_script",
                "product": "windows",
                "definition": "Requirements: Script Block Logging must be enabled"
            },
            "references": [
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1558.003/T1558.003.md#atomic-test-4---request-a-single-ticket-via-powershell"
            ],
            "status": "test",
            "title": "Request A Single Ticket via PowerShell",
            "tags": [
                "attack.credential_access",
                "attack.t1558.003"
            ]
        }
    ]
}