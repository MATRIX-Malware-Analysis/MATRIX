{
    "type": "malware-behavior",
    "spec_version": "2.1",
    "id": "malware-behavior--b17e4df5-3201-41fa-b6b7-7aabfb25c882",
    "created": "2024-08-13T14:46:36.684307Z",
    "modified": "2024-08-13T14:46:45.670268Z",
    "name": "Access Token Manipulation: Make and Impersonate Token",
    "description": "Adversaries may make new tokens and impersonate users to escalate privileges and bypass access controls. For example, if an adversary has a username and password but the user is not logged onto the system the adversary can then create a logon session for the user using the LogonUser function.[1] The function will return a copy of the new session's access token and the adversary can use SetThreadToken to assign the token to a thread.This behavior is distinct from Token Impersonation/Theft in that this refers to creating a new user token instead of stealing or duplicating an existing one.",
    "object_marking_refs": [
        "marking-definition--613f2e26-407d-48c7-9eca-b8e91df99dc9"
    ],
    "external_references": [
        {
            "source_name": "MITRE ATT&CK",
            "url": "https://attack.mitre.org/techniques/T1134/003",
            "external_id": "T1134/003"
        },
        {
            "source_name": "CAPEC 196",
            "external_id": "malware-behavior--4e8738fb-b639-4109-b421-428e5f849410"
        }
    ],
    "x_mitre_detection_rules": [
        {
            "author": "Nasreddine Bencherchali (Nextron Systems)",
            "date": "2024/06/26",
            "description": "Detects the execution of the SharpDPAPI tool based on CommandLine flags and PE metadata.\nSharpDPAPI is a C# port of some DPAPI functionality from the Mimikatz project.\n",
            "detection": {
                "condition": "selection_img or (selection_other_cli and 1 of selection_other_options_*)",
                "selection_img": [
                    {
                        "Image|endswith": "\\SharpDPAPI.exe"
                    },
                    {
                        "OriginalFileName": "SharpDPAPI.exe"
                    }
                ],
                "selection_other_cli": {
                    "CommandLine|contains": [
                        " backupkey ",
                        " blob ",
                        " certificates ",
                        " credentials ",
                        " keepass ",
                        " masterkeys ",
                        " rdg ",
                        " vaults "
                    ]
                },
                "selection_other_options_flags": {
                    "CommandLine|contains": [
                        " /file:",
                        " /machine",
                        " /mkfile:",
                        " /password:",
                        " /pvk:",
                        " /server:",
                        " /target:",
                        " /unprotect"
                    ]
                },
                "selection_other_options_guid": {
                    "CommandLine|contains|all": [
                        " {",
                        "}:"
                    ]
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "c7d33b50-f690-4b51-8cfb-0fb912a31e57",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "references": [
                "https://github.com/GhostPack/SharpDPAPI"
            ],
            "status": "experimental",
            "tags": [
                "attack.privilege_escalation",
                "attack.defense_evasion",
                "attack.t1134.001",
                "attack.t1134.003"
            ],
            "title": "HackTool - SharpDPAPI Execution"
        },
        {
            "author": "Sai Prashanth Pulisetti @pulisettis, Nasreddine Bencherchali (Nextron Systems)",
            "date": "2022/12/27",
            "description": "Detects execution of the SharpImpersonation tool. Which can be used to manipulate tokens on a Windows computers remotely (PsExec/WmiExec) or interactively",
            "detection": {
                "condition": "1 of selection_*",
                "selection_cli": [
                    {
                        "CommandLine|contains|all": [
                            " user:",
                            " binary:"
                        ]
                    },
                    {
                        "CommandLine|contains|all": [
                            " user:",
                            " shellcode:"
                        ]
                    },
                    {
                        "CommandLine|contains": [
                            " technique:CreateProcessAsUserW",
                            " technique:ImpersonateLoggedOnuser"
                        ]
                    }
                ],
                "selection_img": [
                    {
                        "Image|endswith": "\\SharpImpersonation.exe"
                    },
                    {
                        "OriginalFileName": "SharpImpersonation.exe"
                    }
                ]
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "f89b08d0-77ad-4728-817b-9b16c5a69c7a",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/02/13",
            "references": [
                "https://s3cur3th1ssh1t.github.io/SharpImpersonation-Introduction/",
                "https://github.com/S3cur3Th1sSh1t/SharpImpersonation"
            ],
            "related": [
                {
                    "id": "cf0c254b-22f1-4b2b-8221-e137b3c0af94",
                    "type": "similar"
                }
            ],
            "tags": [
                "attack.privilege_escalation",
                "attack.defense_evasion",
                "attack.t1134.001",
                "attack.t1134.003"
            ],
            "status": "test",
            "title": "HackTool - SharpImpersonation Execution"
        },
        {
            "id": "cf0c254b-22f1-4b2b-8221-e137b3c0af94",
            "author": "Sai Prashanth Pulisetti @pulisettis",
            "date": "2022/12/21",
            "description": "Detects execution of the Impersonate tool. Which can be used to manipulate tokens on a Windows computers remotely (PsExec/WmiExec) or interactively",
            "detection": {
                "condition": "all of selection_commandline_* or 1 of selection_hash_*",
                "selection_commandline_exe": {
                    "CommandLine|contains": "impersonate.exe"
                },
                "selection_commandline_opt": {
                    "CommandLine|contains": [
                        " list ",
                        " exec ",
                        " adduser "
                    ]
                },
                "selection_hash_ext": [
                    {
                        "md5": "9520714AB576B0ED01D1513691377D01"
                    },
                    {
                        "sha256": "E81CC96E2118DC4FBFE5BAD1604E0AC7681960143E2101E1A024D52264BB0A8A"
                    },
                    {
                        "Imphash": "0A358FFC1697B7A07D0E817AC740DF62"
                    }
                ],
                "selection_hash_plain": {
                    "Hashes|contains": [
                        "MD5=9520714AB576B0ED01D1513691377D01",
                        "SHA256=E81CC96E2118DC4FBFE5BAD1604E0AC7681960143E2101E1A024D52264BB0A8A",
                        "IMPHASH=0A358FFC1697B7A07D0E817AC740DF62"
                    ]
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "level": "medium",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/02/08",
            "references": [
                "https://sensepost.com/blog/2022/abusing-windows-tokens-to-compromise-active-directory-without-touching-lsass/",
                "https://github.com/sensepost/impersonate"
            ],
            "tags": [
                "attack.privilege_escalation",
                "attack.defense_evasion",
                "attack.t1134.001",
                "attack.t1134.003"
            ],
            "status": "test",
            "title": "HackTool - Impersonate Execution"
        }
    ]
}