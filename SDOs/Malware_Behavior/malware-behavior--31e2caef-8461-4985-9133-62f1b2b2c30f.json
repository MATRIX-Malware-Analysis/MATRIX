{
    "type": "malware-behavior",
    "spec_version": "2.1",
    "id": "malware-behavior--31e2caef-8461-4985-9133-62f1b2b2c30f",
    "created": "2024-08-13T14:46:37.139825Z",
    "modified": "2024-08-13T14:46:46.253904Z",
    "name": "Indicator Removal: Clear Command History",
    "description": "In addition to clearing system logs, an adversary may clear the command history of a compromised account to conceal the actions undertaken during an intrusion. Various command interpreters keep track of the commands users type in their terminal so that users can retrace what they've done.On Linux and macOS, these command histories can be accessed in a few different ways. While logged in, this command history is tracked in a file pointed to by the environment variable HISTFILE. When a user logs off a system, this information is flushed to a file in the user's home directory called ~/.bash_history. The benefit of this is that it allows users to go back to commands they've used before in different sessions.Adversaries may delete their commands from these logs by manually clearing the history (history -c) or deleting the bash history file rm ~/.bash_history.  Adversaries may also leverage a Network Device CLI on network devices to clear command history data (clear logging and/or clear history).[1]On Windows hosts, PowerShell has two different command history providers: the built-in history and the command history managed by the PSReadLine module. The built-in history only tracks the commands used in the current session. This command history is not available to other sessions and is deleted when the session ends.The PSReadLine command history tracks the commands used in all PowerShell sessions and writes them to a file ($env:APPDATA\\Microsoft\\Windows\\PowerShell\\PSReadLine\\ConsoleHost_history.txt by default). This history file is available to all sessions and contains all past history since the file is not deleted when the session ends.[2]Adversaries may run the PowerShell command Clear-History to flush the entire command history from a current PowerShell session. This, however, will not delete/flush the ConsoleHost_history.txt file. Adversaries may also delete the ConsoleHost_history.txt file or edit its contents to hide PowerShell commands they have run.[3][4]",
    "object_marking_refs": [
        "marking-definition--613f2e26-407d-48c7-9eca-b8e91df99dc9"
    ],
    "external_references": [
        {
            "source_name": "MITRE ATT&CK",
            "url": "https://attack.mitre.org/techniques/T1070/003",
            "external_id": "T1070/003"
        }
    ],
    "x_mitre_detection_rules": [
        {
            "author": "Austin Clark",
            "date": "2019/08/12",
            "description": "Clear command history in network OS which is used for defense evasion",
            "detection": {
                "condition": "keywords",
                "keywords": [
                    "clear logging",
                    "clear archive"
                ]
            },
            "falsepositives": [
                "Legitimate administrators may run these commands"
            ],
            "id": "ceb407f6-8277-439b-951f-e4210e3ed956",
            "level": "high",
            "logsource": {
                "product": "cisco",
                "service": "aaa"
            },
            "modified": "2023/05/26",
            "references": [
                "https://www.cisco.com/c/en/us/td/docs/switches/datacenter/nexus5000/sw/command/reference/sysmgmt/n5k-sysmgmt-cr/n5k-sm_cmds_c.html",
                "https://www.cisco.com/c/en/us/td/docs/ios/12_2sr/12_2sra/feature/guide/srmgtint.html#wp1127609"
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.t1070.003"
            ],
            "title": "Cisco Clear Logs"
        },
        {
            "author": "Ali Alwashali",
            "date": "2022/08/21",
            "description": "Detects scripts or commands that disabled the Powershell command history by removing psreadline module",
            "detection": {
                "condition": "selection",
                "selection": {
                    "ScriptBlockText|contains|all": [
                        "Remove-Module",
                        "psreadline"
                    ]
                }
            },
            "falsepositives": [
                "Legitimate script that disables the command history"
            ],
            "id": "602f5669-6927-4688-84db-0d4b7afb2150",
            "level": "high",
            "logsource": {
                "category": "ps_script",
                "definition": "Requirements: Script Block Logging must be enabled",
                "product": "windows"
            },
            "references": [
                "https://twitter.com/DissectMalware/status/1062879286749773824"
            ],
            "status": "test",
            "title": "Disable Powershell Command History",
            "tags": [
                "attack.defense_evasion",
                "attack.t1070.003"
            ]
        },
        {
            "author": "Austin Songer @austinsonger",
            "date": "2021/11/25",
            "description": "Identifies when a user attempts to clear console history. An adversary may clear the command history of a compromised account to conceal the actions undertaken during an intrusion.",
            "detection": {
                "condition": "selection1 or selection2a and selection2b",
                "selection1": {
                    "ScriptBlockText|contains": "Clear-History"
                },
                "selection2a": {
                    "ScriptBlockText|contains": [
                        "Remove-Item",
                        "rm"
                    ]
                },
                "selection2b": {
                    "ScriptBlockText|contains": [
                        "ConsoleHost_history.txt",
                        "(Get-PSReadlineOption).HistorySavePath"
                    ]
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "bde47d4b-9987-405c-94c7-b080410e8ea7",
            "level": "high",
            "logsource": {
                "category": "ps_script",
                "definition": "Requirements: Script Block Logging must be enabled",
                "product": "windows"
            },
            "modified": "2022/12/25",
            "references": [
                "https://stefanos.cloud/blog/kb/how-to-clear-the-powershell-command-history/",
                "https://www.shellhacks.com/clear-history-powershell/",
                "https://community.sophos.com/sophos-labs/b/blog/posts/powershell-command-history-forensics"
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.t1070",
                "attack.t1070.003"
            ],
            "title": "Clearing Windows Console History"
        },
        {
            "author": "Ilyas Ochkov, Jonhnathan Ribeiro, Daniil Yugoslavskiy, oscd.community",
            "date": "2022/01/25",
            "description": "Detects keywords that could indicate clearing PowerShell history",
            "detection": {
                "condition": "1 of selection_* or all of selection1*",
                "selection1a": {
                    "ScriptBlockText|contains": [
                        "del",
                        "Remove-Item",
                        "rm"
                    ]
                },
                "selection1b": {
                    "ScriptBlockText|contains": "(Get-PSReadlineOption).HistorySavePath"
                },
                "selection_2": {
                    "ScriptBlockText|contains|all": [
                        "Set-PSReadlineOption",
                        "\u2013HistorySaveStyle",
                        "SaveNothing"
                    ]
                },
                "selection_3": {
                    "ScriptBlockText|contains|all": [
                        "Set-PSReadlineOption",
                        "-HistorySaveStyle",
                        "SaveNothing"
                    ]
                }
            },
            "falsepositives": [
                "Legitimate PowerShell scripts"
            ],
            "id": "26b692dc-1722-49b2-b496-a8258aa6371d",
            "level": "medium",
            "logsource": {
                "category": "ps_script",
                "definition": "Requirements: Script Block Logging must be enabled",
                "product": "windows"
            },
            "modified": "2022/12/02",
            "references": [
                "https://gist.github.com/hook-s3c/7363a856c3cdbadeb71085147f042c1a"
            ],
            "related": [
                {
                    "id": "dfba4ce1-e0ea-495f-986e-97140f31af2d",
                    "type": "derived"
                }
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.t1070.003"
            ],
            "title": "Clear PowerShell History - PowerShell"
        },
        {
            "author": "frack113",
            "date": "2022/01/09",
            "description": "Open a handle on the drive volume via the \\\\.\\ DOS device path specifier and perform direct access read of the first few bytes of the volume.",
            "detection": {
                "condition": "selection",
                "selection": {
                    "ScriptBlockText|contains|all": [
                        "New-Object",
                        "IO.FileStream",
                        "\\\\\\\\.\\\\"
                    ]
                }
            },
            "falsepositives": [
                "Legitimate PowerShell scripts"
            ],
            "id": "70ad982f-67c8-40e0-a955-b920c2fa05cb",
            "level": "medium",
            "logsource": {
                "category": "ps_script",
                "definition": "Requirements: Script Block Logging must be enabled",
                "product": "windows"
            },
            "modified": "2022/03/05",
            "references": [
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1006/T1006.md"
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.t1070.003"
            ],
            "title": "Suspicious IO.FileStream"
        },
        {
            "author": "Ilyas Ochkov, Jonhnathan Ribeiro, Daniil Yugoslavskiy, oscd.community",
            "date": "2019/10/25",
            "description": "Detects keywords that could indicate clearing PowerShell history",
            "detection": {
                "condition": "1 of selection_payload_* or all of selection_1*",
                "selection_1a_payload": {
                    "Payload|contains": [
                        "del",
                        "Remove-Item",
                        "rm"
                    ]
                },
                "selection_1b_payload": {
                    "Payload|contains": "(Get-PSReadlineOption).HistorySavePath"
                },
                "selection_payload_2": {
                    "Payload|contains|all": [
                        "Set-PSReadlineOption",
                        "\u2013HistorySaveStyle",
                        "SaveNothing"
                    ]
                },
                "selection_payload_3": {
                    "Payload|contains|all": [
                        "Set-PSReadlineOption",
                        "-HistorySaveStyle",
                        "SaveNothing"
                    ]
                }
            },
            "falsepositives": [
                "Legitimate PowerShell scripts"
            ],
            "id": "f99276ad-d122-4989-a09a-d00904a5f9d2",
            "level": "medium",
            "logsource": {
                "category": "ps_module",
                "definition": "0ad03ef1-f21b-4a79-8ce8-e6900c54b65b",
                "product": "windows"
            },
            "modified": "2022/12/02",
            "references": [
                "https://gist.github.com/hook-s3c/7363a856c3cdbadeb71085147f042c1a"
            ],
            "related": [
                {
                    "id": "dfba4ce1-e0ea-495f-986e-97140f31af2d",
                    "type": "derived"
                }
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.t1070.003"
            ],
            "title": "Clear PowerShell History - PowerShell Module"
        },
        {
            "author": "Patrick Bareiss",
            "date": "2019/03/24",
            "description": "Detects commands that try to clear or tamper with the Linux command history.\nThis technique is used by threat actors in order to evade defenses and execute commands without them being recorded in files such as \"bash_history\" or \"zsh_history\".\n",
            "detection": {
                "condition": "keywords",
                "keywords": [
                    "cat /dev/null >*sh_history",
                    "cat /dev/zero >*sh_history",
                    "chattr +i*sh_history",
                    "echo \"\" >*sh_history",
                    "empty_bash_history",
                    "export HISTFILESIZE=0",
                    "history -c",
                    "history -w",
                    "ln -sf /dev/null *sh_history",
                    "ln -sf /dev/zero *sh_history",
                    "rm *sh_history",
                    "shopt -ou history",
                    "shopt -uo history",
                    "shred *sh_history",
                    "truncate -s0 *sh_history"
                ]
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "fdc88d25-96fb-4b7c-9633-c0e417fdbd4e",
            "level": "high",
            "logsource": {
                "product": "linux"
            },
            "modified": "2024/04/17",
            "references": [
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1070.003/T1070.003.md",
                "https://www.hackers-arise.com/post/2016/06/20/covering-your-bash-shell-tracks-antiforensics",
                "https://www.cadosecurity.com/spinning-yarn-a-new-linux-malware-campaign-targets-docker-apache-hadoop-redis-and-confluence/"
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.t1070.003"
            ],
            "title": "Linux Command History Tampering"
        }
    ]
}