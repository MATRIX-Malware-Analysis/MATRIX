{
    "type": "malware-behavior",
    "spec_version": "2.1",
    "id": "malware-behavior--ddc35916-1758-4dc2-82cf-faec945e64fd",
    "created": "2024-08-13T14:46:36.684307Z",
    "modified": "2024-08-13T14:46:45.114299Z",
    "name": "Access Token Manipulation: Create Process with Token",
    "description": "Adversaries may create a new process with an existing token to escalate privileges and bypass access controls. Processes can be created with the token and resulting security context of another user using features such as CreateProcessWithTokenW and runas.[1]Creating processes with a token not associated with the current user may require the credentials of the target user, specific privileges to impersonate that user, or access to the token to be used. For example, the token could be duplicated via Token Impersonation/Theft or created via Make and Impersonate Token before being used to create a process.While this technique is distinct from Token Impersonation/Theft, the techniques can be used in conjunction where a token is duplicated and then used to create a new process.",
    "object_marking_refs": [
        "marking-definition--613f2e26-407d-48c7-9eca-b8e91df99dc9"
    ],
    "external_references": [
        {
            "source_name": "MITRE ATT&CK",
            "url": "https://attack.mitre.org/techniques/T1134/002",
            "external_id": "T1134/002"
        },
        {
            "source_name": "CAPEC 196",
            "external_id": "malware-behavior--4e8738fb-b639-4109-b421-428e5f849410"
        }
    ],
    "x_mitre_detection_rules": [
        {
            "author": "Florian Roth (Nextron Systems)",
            "date": "2022/01/20",
            "description": "Detects the execution of AdvancedRun utility",
            "detection": {
                "condition": "selection",
                "selection": [
                    {
                        "OriginalFileName": "AdvancedRun.exe"
                    },
                    {
                        "CommandLine|contains|all": [
                            " /EXEFilename ",
                            " /Run"
                        ]
                    },
                    {
                        "CommandLine|contains|all": [
                            " /WindowState 0",
                            " /RunAs ",
                            " /CommandLine "
                        ]
                    }
                ]
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "d2b749ee-4225-417e-b20e-a8d2193cbb84",
            "level": "medium",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/02/21",
            "references": [
                "https://twitter.com/splinter_code/status/1483815103279603714",
                "https://medium.com/s2wblog/analysis-of-destructive-malware-whispergate-targeting-ukraine-9d5d158f19f3",
                "https://elastic.github.io/security-research/malware/2022/01/01.operation-bleeding-bear/article/",
                "https://www.winhelponline.com/blog/run-program-as-system-localsystem-account-windows/"
            ],
            "related": [
                {
                    "id": "fa00b701-44c6-4679-994d-5a18afa8a707",
                    "type": "similar"
                }
            ],
            "status": "test",
            "tags": [
                "attack.execution",
                "attack.defense_evasion",
                "attack.privilege_escalation",
                "attack.t1564.003",
                "attack.t1134.002",
                "attack.t1059.003"
            ],
            "title": "PUA - AdvancedRun Execution"
        },
        {
            "author": "Teymur Kheirkhabarov, Roberto Rodriguez (@Cyb3rWard0g), Open Threat Research (OTR)",
            "date": "2019/10/26",
            "description": "Detection of child processes spawned with SYSTEM privileges by parents with LOCAL SERVICE or NETWORK SERVICE accounts",
            "detection": {
                "condition": "selection and not 1 of filter_*",
                "filter_rundll32": {
                    "CommandLine|contains": "DavSetCookie",
                    "Image|endswith": "\\rundll32.exe"
                },
                "selection": {
                    "IntegrityLevel": "System",
                    "ParentUser|contains": [
                        "AUTHORI",
                        "AUTORI"
                    ],
                    "ParentUser|endswith": [
                        "\\NETWORK SERVICE",
                        "\\LOCAL SERVICE"
                    ],
                    "User|contains": [
                        "AUTHORI",
                        "AUTORI"
                    ],
                    "User|endswith": [
                        "\\SYSTEM",
                        "\\Syst\u00e8me",
                        "\\\u0421\u0418\u0421\u0422\u0415\u041c\u0410"
                    ]
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "590a5f4c-6c8c-4f10-8307-89afe9453a9d",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows",
                "definition": "Requirements: ParentUser field needs sysmon >= 13.30"
            },
            "modified": "2022/12/15",
            "references": [
                "https://speakerdeck.com/heirhabarov/hunting-for-privilege-escalation-in-windows-environment",
                "https://foxglovesecurity.com/2016/09/26/rotten-potato-privilege-escalation-from-service-accounts-to-system/",
                "https://github.com/antonioCoco/RogueWinRM",
                "https://twitter.com/Cyb3rWard0g/status/1453123054243024897"
            ],
            "status": "test",
            "tags": [
                "attack.privilege_escalation",
                "attack.t1134.002"
            ],
            "title": "Suspicious Child Process Created as System"
        },
        {
            "author": "Teymur Kheirkhabarov, Ecco, Florian Roth",
            "date": "2019/10/26",
            "description": "Detects the use of getsystem Meterpreter/Cobalt Strike command by detecting a specific service starting",
            "detection": {
                "condition": "selection_img and 1 of selection_technique_* and not 1 of filter_*",
                "filter_defender": {
                    "CommandLine|contains": "MpCmdRun"
                },
                "selection_img": {
                    "ParentImage|endswith": "\\services.exe"
                },
                "selection_technique_1": {
                    "CommandLine|contains": [
                        "cmd",
                        "%COMSPEC%"
                    ],
                    "CommandLine|contains|all": [
                        "/c",
                        "echo",
                        "\\pipe\\"
                    ]
                },
                "selection_technique_2": {
                    "CommandLine|contains|all": [
                        "rundll32",
                        ".dll,a",
                        "/p:"
                    ]
                }
            },
            "falsepositives": [
                "Commandlines containing components like cmd accidentally",
                "Jobs and services started with cmd"
            ],
            "fields": [
                "ComputerName",
                "User",
                "CommandLine"
            ],
            "id": "15619216-e993-4721-b590-4c520615a67d",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/02/05",
            "references": [
                "https://speakerdeck.com/heirhabarov/hunting-for-privilege-escalation-in-windows-environment",
                "https://blog.cobaltstrike.com/2014/04/02/what-happens-when-i-type-getsystem/"
            ],
            "status": "test",
            "tags": [
                "attack.privilege_escalation",
                "attack.t1134.001",
                "attack.t1134.002"
            ],
            "title": "Potential Meterpreter/CobaltStrike Activity"
        },
        {
            "id": "fa00b701-44c6-4679-994d-5a18afa8a707",
            "author": "Florian Roth (Nextron Systems)",
            "date": "2022/01/20",
            "description": "Detects the execution of AdvancedRun utility in the context of the TrustedInstaller, SYSTEM, Local Service or Network Service accounts",
            "detection": {
                "condition": "all of selection*",
                "selection": {
                    "CommandLine|contains": [
                        "/EXEFilename",
                        "/CommandLine"
                    ]
                },
                "selection_runas": [
                    {
                        "CommandLine|contains": [
                            " /RunAs 8 ",
                            " /RunAs 4 ",
                            " /RunAs 10 ",
                            " /RunAs 11 "
                        ]
                    },
                    {
                        "CommandLine|endswith": [
                            "/RunAs 8",
                            "/RunAs 4",
                            "/RunAs 10",
                            "/RunAs 11"
                        ]
                    }
                ]
            },
            "falsepositives": [
                "Unknown"
            ],
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/02/21",
            "references": [
                "https://twitter.com/splinter_code/status/1483815103279603714",
                "https://medium.com/s2wblog/analysis-of-destructive-malware-whispergate-targeting-ukraine-9d5d158f19f3",
                "https://elastic.github.io/security-research/malware/2022/01/01.operation-bleeding-bear/article/",
                "https://www.winhelponline.com/blog/run-program-as-system-localsystem-account-windows/"
            ],
            "related": [
                {
                    "type": "similar",
                    "id": "d2b749ee-4225-417e-b20e-a8d2193cbb84"
                }
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.privilege_escalation",
                "attack.t1134.002"
            ],
            "title": "PUA - AdvancedRun Suspicious Execution"
        },
        {
            "author": "Teymur Kheirkhabarov, Ecco, Florian Roth (Nextron Systems)",
            "date": "2019/10/26",
            "description": "Detects the use of getsystem Meterpreter/Cobalt Strike command by detecting a specific service installation",
            "detection": {
                "condition": "selection_id and 1 of selection_cli_*",
                "selection_cli_cmd": {
                    "ImagePath|contains": [
                        "cmd",
                        "%COMSPEC%"
                    ],
                    "ImagePath|contains|all": [
                        "/c",
                        "echo",
                        "\\pipe\\"
                    ]
                },
                "selection_cli_rundll": {
                    "ImagePath|contains|all": [
                        "rundll32",
                        ".dll,a",
                        "/p:"
                    ]
                },
                "selection_cli_share": {
                    "ImagePath|startswith": "\\\\\\\\127.0.0.1\\\\ADMIN$\\"
                },
                "selection_id": {
                    "EventID": 7045,
                    "Provider_Name": "Service Control Manager"
                }
            },
            "falsepositives": [
                "Unlikely"
            ],
            "id": "843544a7-56e0-4dcc-a44f-5cc266dd97d6",
            "level": "high",
            "logsource": {
                "product": "windows",
                "service": "system"
            },
            "modified": "2023/11/15",
            "references": [
                "https://speakerdeck.com/heirhabarov/hunting-for-privilege-escalation-in-windows-environment",
                "https://blog.cobaltstrike.com/2014/04/02/what-happens-when-i-type-getsystem/"
            ],
            "status": "test",
            "title": "Meterpreter or Cobalt Strike Getsystem Service Installation - System",
            "tags": [
                "attack.privilege_escalation",
                "attack.t1134.001",
                "attack.t1134.002"
            ]
        },
        {
            "author": "Teymur Kheirkhabarov, Ecco, Florian Roth (Nextron Systems)",
            "date": "2019/10/26",
            "description": "Detects the use of getsystem Meterpreter/Cobalt Strike command by detecting a specific service installation",
            "detection": {
                "condition": "selection_eid and 1 of selection_cli_*",
                "selection_cli_cmd": {
                    "ServiceFileName|contains": [
                        "cmd",
                        "%COMSPEC%"
                    ],
                    "ServiceFileName|contains|all": [
                        "/c",
                        "echo",
                        "\\pipe\\"
                    ]
                },
                "selection_cli_rundll": {
                    "ServiceFileName|contains|all": [
                        "rundll32",
                        ".dll,a",
                        "/p:"
                    ]
                },
                "selection_cli_share": {
                    "ServiceFileName|startswith": "\\\\\\\\127.0.0.1\\\\ADMIN$\\"
                },
                "selection_eid": {
                    "EventID": 4697
                }
            },
            "falsepositives": [
                "Unlikely"
            ],
            "id": "ecbc5e16-58e0-4521-9c60-eb9a7ea4ad34",
            "level": "high",
            "logsource": {
                "definition": "The 'System Security Extension' audit subcategory need to be enabled to log the EID 4697",
                "product": "windows",
                "service": "security"
            },
            "modified": "2023/11/15",
            "related": [
                {
                    "type": "derived",
                    "id": "843544a7-56e0-4dcc-a44f-5cc266dd97d6"
                }
            ],
            "references": [
                "https://speakerdeck.com/heirhabarov/hunting-for-privilege-escalation-in-windows-environment",
                "https://blog.cobaltstrike.com/2014/04/02/what-happens-when-i-type-getsystem/"
            ],
            "status": "test",
            "tags": [
                "attack.privilege_escalation",
                "attack.t1134.001",
                "attack.t1134.002"
            ],
            "title": "Meterpreter or Cobalt Strike Getsystem Service Installation - Security"
        }
    ]
}