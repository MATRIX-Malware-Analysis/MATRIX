{
    "type": "malware-behavior",
    "spec_version": "2.1",
    "id": "malware-behavior--d09dd330-dc13-4481-b6de-6d12adf46c5b",
    "created": "2024-08-13T14:46:37.109546Z",
    "modified": "2024-08-13T14:46:48.639514Z",
    "name": "System Language Discovery: ",
    "description": "Adversaries may attempt to gather information about the system language of a victim in order to infer the geographical location of that host. This information may be used to shape follow-on behaviors, including whether the adversary infects the target and/or attempts specific actions. This decision may be employed by malware developers and operators to reduce their risk of attracting the attention of specific law enforcement agencies or prosecution/scrutiny from other entities.[1]There are various sources of data an adversary could use to infer system language, such as system defaults and keyboard layouts. Specific checks will vary based on the target and/or adversary, but may involve behaviors such as Query Registry and calls to Native API functions.[2] For example, on a Windows system adversaries may attempt to infer the language of a system by querying the registry key HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Nls\\Language or parsing the outputs of Windows API functions GetUserDefaultUILanguage, GetSystemDefaultUILanguage, GetKeyboardLayoutList and GetUserDefaultLangID.[3][4][5]On a macOS or Linux system, adversaries may query locale to retrieve the value of the $LANG environment variable.",
    "object_marking_refs": [
        "marking-definition--613f2e26-407d-48c7-9eca-b8e91df99dc9"
    ],
    "external_references": [
        {
            "source_name": "MITRE ATT&CK",
            "url": "https://attack.mitre.org/techniques/T1614/001",
            "external_id": "T1614/001"
        }
    ],
    "x_mitre_capa_rules": [
        {
            "rule": {
                "features": [
                    {
                        "and": [
                            {
                                "os": "windows"
                            },
                            {
                                "or": [
                                    {
                                        "api": "GetUserDefaultUILanguage"
                                    },
                                    {
                                        "api": "GetSystemDefaultUILanguage"
                                    },
                                    {
                                        "api": "GetUserDefaultLangID"
                                    }
                                ]
                            }
                        ]
                    }
                ],
                "meta": {
                    "att&ck": [
                        "Discovery::System Location Discovery::System Language Discovery [T1614.001]"
                    ],
                    "authors": [
                        "william.ballenthin@mandiant.com"
                    ],
                    "examples": [
                        "9b7ccaa2ae6a5b96e3110ebcbc4311f6:0x10001F96"
                    ],
                    "name": "identify system language via API",
                    "namespace": "targeting/language",
                    "scopes": {
                        "dynamic": "thread",
                        "static": "function"
                    }
                }
            }
        },
        {
            "rule": {
                "features": [
                    {
                        "and": [
                            {
                                "or": [
                                    {
                                        "api": "user32.GetKeyboardLayoutList"
                                    },
                                    {
                                        "api": "user32.GetKeyboardLayout"
                                    },
                                    {
                                        "api": "user32.GetKeyboardLayoutName"
                                    }
                                ]
                            },
                            {
                                "optional": [
                                    {
                                        "api": "kernel32.GetLocaleInfo"
                                    }
                                ]
                            }
                        ]
                    }
                ],
                "meta": {
                    "att&ck": [
                        "Discovery::System Location Discovery::System Language Discovery [T1614.001]"
                    ],
                    "authors": [
                        "michael.hunhoff@mandiant.com"
                    ],
                    "examples": [
                        "6F99A2C8944CB02FF28C6F9CED59B161:0x4193C0",
                        "C91887D861D9BD4A5872249B641BC9F9:0x4015FD"
                    ],
                    "name": "get keyboard layout",
                    "namespace": "host-interaction/hardware/keyboard",
                    "scopes": {
                        "dynamic": "thread",
                        "static": "function"
                    }
                }
            }
        }
    ],
    "x_mitre_detection_rules": [
        {
            "author": "_pete_0, TheDFIRReport",
            "date": "2022/02/21",
            "description": "Detects use of chcp to look up the system locale value as part of host discovery",
            "detection": {
                "condition": "selection",
                "selection": {
                    "CommandLine|endswith": [
                        "chcp",
                        "chcp ",
                        "chcp  "
                    ],
                    "Image|endswith": "\\chcp.com",
                    "ParentCommandLine|contains|windash": [
                        " -c ",
                        " -r ",
                        " -k "
                    ],
                    "ParentImage|endswith": "\\cmd.exe"
                }
            },
            "falsepositives": [
                "During Anaconda update the 'conda.exe' process will eventually execution the 'chcp' command.",
                "Discord was seen using chcp to look up code pages"
            ],
            "id": "7090adee-82e2-4269-bd59-80691e7c6338",
            "level": "medium",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2024/03/05",
            "references": [
                "https://thedfirreport.com/2022/04/04/stolen-images-campaign-ends-in-conti-ransomware/",
                "https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/chcp"
            ],
            "status": "experimental",
            "tags": [
                "attack.discovery",
                "attack.t1614.001"
            ],
            "title": "Console CodePage Lookup Via CHCP"
        }
    ]
}