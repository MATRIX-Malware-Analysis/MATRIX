{
    "type": "malware-behavior",
    "spec_version": "2.1",
    "id": "malware-behavior--7e24cb95-ffd6-4a52-9d35-ed8dea47824c",
    "created": "2024-08-13T14:46:36.968916Z",
    "modified": "2024-08-13T14:46:48.441567Z",
    "name": "Debugger Evasion",
    "description": "Adversaries may employ various means to detect and avoid debuggers. Debuggers are typically used by defenders to trace and/or analyze the execution of potential malware payloads.[1]Debugger evasion may include changing behaviors based on the results of the checks for the presence of artifacts indicative of a debugged environment. Similar to Virtualization/Sandbox Evasion, if the adversary detects a debugger, they may alter their malware to disengage from the victim or conceal the core functions of the implant. They may also search for debugger artifacts before dropping secondary or additional payloads.Specific checks will vary based on the target and/or adversary, but may involve Native API function calls such as IsDebuggerPresent() and  NtQueryInformationProcess(), or manually checking the BeingDebugged flag of the Process Environment Block (PEB). Other checks for debugging artifacts may also seek to enumerate hardware breakpoints, interrupt assembly opcodes, time checks, or measurements if exceptions are raised in the current process (assuming a present debugger would 'swallow' or handle the potential error).[2][3][4]Adversaries may use the information learned from these debugger checks during automated discovery to shape follow-on behaviors. Debuggers can also be evaded by detaching the process or flooding debug logs with meaningless data via messages produced by looping Native API function calls such as OutputDebugStringW().[5][6]",
    "object_marking_refs": [
        "marking-definition--613f2e26-407d-48c7-9eca-b8e91df99dc9"
    ],
    "external_references": [
        {
            "source_name": "MITRE ATT&CK",
            "url": "https://attack.mitre.org/techniques/T1622",
            "external_id": "T1622"
        },
        {
            "source_name": "mitre-attack",
            "external_id": "T1622",
            "url": "https://attack.mitre.org/techniques/T1622"
        },
        {
            "source_name": "Checkpoint Dridex Jan 2021",
            "url": "https://research.checkpoint.com/2021/stopping-serial-killer-catching-the-next-strike/",
            "description": "Check Point Research. (2021, January 4). Stopping Serial Killer: Catching the Next Strike. Retrieved September 7, 2021."
        },
        {
            "source_name": "hasherezade debug",
            "url": "https://github.com/hasherezade/malware_training_vol1/blob/main/slides/module3/Module3_2_fingerprinting.pdf",
            "description": "hasherezade. (2021, June 30). Module 3 - Understanding and countering malware's evasion and self-defence. Retrieved April 1, 2022."
        },
        {
            "source_name": "AlKhaser Debug",
            "url": "https://github.com/LordNoteworthy/al-khaser/tree/master/al-khaser/AntiDebug",
            "description": "Noteworthy. (2019, January 6). Al-Khaser. Retrieved April 1, 2022."
        },
        {
            "source_name": "wardle evilquest partii",
            "url": "https://objective-see.com/blog/blog_0x60.html",
            "description": "Patrick Wardle. (2020, July 3). OSX.EvilQuest Uncovered part ii: insidious capabilities. Retrieved March 21, 2021."
        },
        {
            "source_name": "ProcessHacker Github",
            "url": "https://github.com/processhacker/processhacker",
            "description": "ProcessHacker. (2009, October 27). Process Hacker. Retrieved April 11, 2022."
        },
        {
            "source_name": "vxunderground debug",
            "url": "https://github.com/vxunderground/VX-API/tree/main/Anti%20Debug",
            "description": "vxunderground. (2021, June 30). VX-API. Retrieved April 1, 2022."
        }
    ],
    "x_mitre_capa_rules": [
        {
            "rule": {
                "features": [
                    {
                        "or": [
                            {
                                "basic block": [
                                    {
                                        "and": [
                                            {
                                                "or": [
                                                    {
                                                        "api": "NtSetInformationThread"
                                                    },
                                                    {
                                                        "api": "ZwSetInformationThread"
                                                    }
                                                ]
                                            },
                                            {
                                                "number": "0x11 = ThreadHideFromDebugger"
                                            }
                                        ]
                                    }
                                ]
                            },
                            {
                                "call": [
                                    {
                                        "and": [
                                            {
                                                "or": [
                                                    {
                                                        "api": "NtSetInformationThread"
                                                    },
                                                    {
                                                        "api": "ZwSetInformationThread"
                                                    }
                                                ]
                                            },
                                            {
                                                "number": "0x11 = ThreadHideFromDebugger"
                                            }
                                        ]
                                    }
                                ]
                            },
                            {
                                "and": [
                                    {
                                        "or": [
                                            {
                                                "string": "NtSetInformationThread"
                                            },
                                            {
                                                "string": "ZwSetInformationThread"
                                            }
                                        ]
                                    },
                                    {
                                        "match": "link function at runtime on Windows"
                                    },
                                    {
                                        "api": "GetCurrentThread"
                                    },
                                    {
                                        "number": "0x11 = ThreadHideFromDebugger"
                                    }
                                ]
                            }
                        ]
                    }
                ],
                "meta": {
                    "att&ck": [
                        "Defense Evasion::Debugger Evasion [T1622]"
                    ],
                    "authors": [
                        "michael.hunhoff@mandiant.com",
                        "jakub.jozwiak@mandiant.com"
                    ],
                    "examples": [
                        "26beba7352a32b803aa19e0782011a383a1df19549910e7b2f2f244e49678524:0x10001670"
                    ],
                    "mbc": [
                        "Anti-Behavioral Analysis::Debugger Evasion [B0002]"
                    ],
                    "name": "hide thread from debugger",
                    "namespace": "anti-analysis/anti-debugging/debugger-evasion",
                    "references": [
                        "https://anti-debug.checkpoint.com/techniques/interactive.html#ntsetinformationthread",
                        "https://github.com/LordNoteworthy/al-khaser/blob/master/al-khaser/AntiDebug/NtSetInformationThread_ThreadHideFromDebugger.cpp",
                        "https://github.com/jaeyung1001/Anti-Debugging/blob/master/Code/NtSetInformationThread.cpp"
                    ],
                    "scopes": {
                        "dynamic": "thread",
                        "static": "function"
                    }
                }
            }
        },
        {
            "rule": {
                "features": [
                    {
                        "and": [
                            {
                                "api": "user32.CreateDesktop"
                            },
                            {
                                "api": "user32.SwitchDesktop"
                            }
                        ]
                    }
                ],
                "meta": {
                    "att&ck": [
                        "Defense Evasion::Debugger Evasion [T1622]"
                    ],
                    "authors": [
                        "jakub.jozwiak@mandiant.com"
                    ],
                    "examples": [
                        "26beba7352a32b803aa19e0782011a383a1df19549910e7b2f2f244e49678524:0x10001670"
                    ],
                    "mbc": [
                        "Anti-Behavioral Analysis::Debugger Evasion [B0002]"
                    ],
                    "name": "switch active desktop",
                    "namespace": "host-interaction/gui",
                    "references": [
                        "https://anti-debug.checkpoint.com/techniques/interactive.html#switchdesktop"
                    ],
                    "scopes": {
                        "dynamic": "thread",
                        "static": "function"
                    }
                }
            }
        }
    ],
    "x_mitre_detection_rules": [
        {
            "author": "Florian Roth (Nextron Systems)",
            "date": "2022/10/10",
            "description": "Detects the execution of Process Hacker based on binary metadata information (Image, Hash, Imphash, etc).\nProcess Hacker is a tool to view and manipulate processes, kernel options and other low level options.\nThreat actors abused older vulnerable versions to manipulate system processes.\n",
            "detection": {
                "condition": "1 of selection_*",
                "selection_hash_values": [
                    {
                        "md5": [
                            "68f9b52895f4d34e74112f3129b3b00d",
                            "b365af317ae730a67c936f21432b9c71"
                        ]
                    },
                    {
                        "sha1": [
                            "c5e2018bf7c0f314fed4fd7fe7e69fa2e648359e",
                            "a0bdfac3ce1880b32ff9b696458327ce352e3b1d"
                        ]
                    },
                    {
                        "sha256": [
                            "d4a0fe56316a2c45b9ba9ac1005363309a3edc7acf9e4df64d326a0ff273e80f",
                            "bd2c2cf0631d881ed382817afcce2b093f4e412ffb170a719e2762f250abfea4"
                        ]
                    },
                    {
                        "Imphash": [
                            "04de0ad9c37eb7bd52043d2ecac958df",
                            "3695333c60dedecdcaff1590409aa462"
                        ]
                    }
                ],
                "selection_hashes": {
                    "Hashes|contains": [
                        "MD5=68F9B52895F4D34E74112F3129B3B00D",
                        "MD5=B365AF317AE730A67C936F21432B9C71",
                        "SHA1=A0BDFAC3CE1880B32FF9B696458327CE352E3B1D",
                        "SHA1=C5E2018BF7C0F314FED4FD7FE7E69FA2E648359E",
                        "SHA256=D4A0FE56316A2C45B9BA9AC1005363309A3EDC7ACF9E4DF64D326A0FF273E80F",
                        "SHA256=BD2C2CF0631D881ED382817AFCCE2B093F4E412FFB170A719E2762F250ABFEA4",
                        "IMPHASH=3695333C60DEDECDCAFF1590409AA462",
                        "IMPHASH=04DE0AD9C37EB7BD52043D2ECAC958DF"
                    ]
                },
                "selection_image": [
                    {
                        "Image|contains": "\\ProcessHacker_"
                    },
                    {
                        "Image|endswith": "\\ProcessHacker.exe"
                    },
                    {
                        "OriginalFileName": [
                            "ProcessHacker.exe",
                            "Process Hacker"
                        ]
                    },
                    {
                        "Description": "Process Hacker"
                    },
                    {
                        "Product": "Process Hacker"
                    }
                ]
            },
            "falsepositives": [
                "While sometimes 'Process Hacker is used by legitimate administrators, the execution of Process Hacker must be investigated and allowed on a case by case basis"
            ],
            "id": "811e0002-b13b-4a15-9d00-a613fce66e42",
            "level": "medium",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/12/11",
            "references": [
                "https://processhacker.sourceforge.io/",
                "https://www.crowdstrike.com/blog/falcon-overwatch-report-finds-increase-in-ecrime/"
            ],
            "related": [
                {
                    "id": "5722dff1-4bdd-4949-86ab-fbaf707e767a",
                    "type": "similar"
                }
            ],
            "status": "experimental",
            "tags": [
                "attack.defense_evasion",
                "attack.discovery",
                "attack.persistence",
                "attack.privilege_escalation",
                "attack.t1622",
                "attack.t1564",
                "attack.t1543"
            ],
            "title": "PUA - Process Hacker Execution"
        }
    ],
    "x_mitre_platforms": [
        "Windows",
        "Linux",
        "macOS"
    ],
    "x_mitre_domains": [
        "enterprise-attack"
    ],
    "x_mitre_contributors": [
        "TruKno"
    ],
    "kill_chain_phases": [
        {
            "kill_chain_name": "mitre-attack",
            "phase_name": "defense-evasion"
        },
        {
            "kill_chain_name": "mitre-attack",
            "phase_name": "discovery"
        }
    ],
    "x_mitre_detection": "Debugger related system checks will likely occur in the first steps of an operation but may also occur throughout as an adversary learns the environment. Data and events should not be viewed in isolation, but as part of a chain of behavior that could lead to other activities, such as lateral movement, based on the information obtained. Detecting actions related to debugger identification may be difficult depending on the adversary's implementation and monitoring required. Monitoring for suspicious [Native API](https://attack.mitre.org/techniques/T1106) function calls as well as processes being spawned that gather a variety of system information or perform other forms of Discovery, especially in a short period of time, may aid in detection.\n\nMonitor debugger logs for signs of abnormal and potentially malicious activity.",
    "x_mitre_is_subtechnique": false,
    "x_mitre_version": "1.0",
    "x_mitre_modified_by_ref": "identity--c78cb6e5-0c4b-4611-8297-d1b8b55e40b5",
    "x_mitre_data_sources": [
        "Process: Process Creation",
        "Process: OS API Execution",
        "Application Log: Application Log Content",
        "Command: Command Execution"
    ],
    "x_mitre_permissions_required": []
}