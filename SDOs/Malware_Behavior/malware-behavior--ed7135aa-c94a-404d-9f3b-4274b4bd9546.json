{
    "type": "malware-behavior",
    "spec_version": "2.1",
    "id": "malware-behavior--ed7135aa-c94a-404d-9f3b-4274b4bd9546",
    "created": "2024-08-13T14:46:36.858961Z",
    "modified": "2024-08-13T14:46:44.60878Z",
    "name": "Steal or Forge Authentication Certificates",
    "description": "Adversaries may steal or forge certificates used for authentication to access remote systems or resources. Digital certificates are often used to sign and encrypt messages and/or files. Certificates are also used as authentication material. For example, Azure AD device certificates and Active Directory Certificate Services (AD CS) certificates bind to an identity and can be used as credentials for domain accounts.[1][2]Authentication certificates can be both stolen and forged. For example, AD CS certificates can be stolen from encrypted storage (in the Registry or files)[3], misplaced certificate files (i.e. Unsecured Credentials), or directly from the Windows certificate store via various crypto APIs.[4][5][6] With appropriate enrollment rights, users and/or machines within a domain can also request and/or manually renew certificates from enterprise certificate authorities (CA). This enrollment process defines various settings and permissions associated with the certificate. Of note, the certificate\u2019s extended key usage (EKU) values define signing, encryption, and authentication use cases, while the certificate\u2019s subject alternative name (SAN) values define the certificate owner\u2019s alternate names.[7]Abusing certificates for authentication credentials may enable other behaviors such as Lateral Movement. Certificate-related misconfigurations may also enable opportunities for Privilege Escalation, by way of allowing users to impersonate or assume privileged accounts or permissions via the identities (SANs) associated with a certificate. These abuses may also enable Persistence via stealing or forging certificates that can be used as Valid Accounts for the duration of the certificate's validity, despite user password resets. Authentication certificates can also be stolen and forged for machine accounts.Adversaries who have access to root (or subordinate) CA certificate private keys (or mechanisms protecting/managing these keys) may also establish Persistence by forging arbitrary authentication certificates for the victim domain (known as 'golden' certificates).[7] Adversaries may also target certificates and related services in order to access other forms of credentials, such as Golden Ticket ticket-granting tickets (TGT) or NTLM plaintext.[7]",
    "object_marking_refs": [
        "marking-definition--613f2e26-407d-48c7-9eca-b8e91df99dc9"
    ],
    "external_references": [
        {
            "source_name": "MITRE ATT&CK",
            "url": "https://attack.mitre.org/techniques/T1649",
            "external_id": "T1649"
        },
        {
            "source_name": "mitre-attack",
            "url": "https://attack.mitre.org/techniques/T1649",
            "external_id": "T1649"
        },
        {
            "source_name": "GitHub GhostPack Certificates",
            "description": "HarmJ0y. (2018, August 22). SharpDPAPI - Certificates. Retrieved August 2, 2022.",
            "url": "https://github.com/GhostPack/SharpDPAPI#certificates"
        },
        {
            "source_name": "Microsoft AD CS Overview",
            "description": "Microsoft. (2016, August 31). Active Directory Certificate Services Overview. Retrieved August 2, 2022.",
            "url": "https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/hh831740(v=ws.11)"
        },
        {
            "source_name": "Medium Certified Pre Owned",
            "description": "Schroeder, W. (2021, June 17). Certified Pre-Owned. Retrieved August 2, 2022.",
            "url": "https://posts.specterops.io/certified-pre-owned-d95910965cd2"
        },
        {
            "source_name": "SpecterOps Certified Pre Owned",
            "description": "Schroeder, W. & Christensen, L. (2021, June 22). Certified Pre-Owned - Abusing Active Directory Certificate Services. Retrieved August 2, 2022.",
            "url": "https://web.archive.org/web/20220818094600/https://specterops.io/assets/resources/Certified_Pre-Owned.pdf"
        },
        {
            "source_name": "O365 Blog Azure AD Device IDs",
            "description": "Syynimaa, N. (2022, February 15). Stealing and faking Azure AD device identities. Retrieved August 3, 2022.",
            "url": "https://o365blog.com/post/deviceidentity/"
        },
        {
            "source_name": "GitHub CertStealer",
            "description": "TheWover. (2021, April 21). CertStealer. Retrieved August 2, 2022.",
            "url": "https://github.com/TheWover/CertStealer"
        },
        {
            "source_name": "APT29 Deep Look at Credential Roaming",
            "description": "Thibault Van Geluwe De Berlaere. (2022, November 8). They See Me Roaming: Following APT29 by Taking a Deeper Look at Windows Credential Roaming. Retrieved November 9, 2022.",
            "url": "https://www.mandiant.com/resources/blog/apt29-windows-credential-roaming"
        }
    ],
    "x_mitre_detection_rules": [
        {
            "author": "pH-T (Nextron Systems)",
            "date": "2023/04/17",
            "description": "Detects Certify a tool for Active Directory certificate abuse based on PE metadata characteristics and common command line arguments.",
            "detection": {
                "condition": "selection_img or all of selection_cli_*",
                "selection_cli_commands": {
                    "CommandLine|contains": [
                        ".exe cas ",
                        ".exe find ",
                        ".exe pkiobjects ",
                        ".exe request ",
                        ".exe download "
                    ]
                },
                "selection_cli_options": {
                    "CommandLine|contains": [
                        " /vulnerable",
                        " /template:",
                        " /altname:",
                        " /domain:",
                        " /path:",
                        " /ca:"
                    ]
                },
                "selection_img": [
                    {
                        "Image|endswith": "\\Certify.exe"
                    },
                    {
                        "OriginalFileName": "Certify.exe"
                    },
                    {
                        "Description|contains": "Certify"
                    }
                ]
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "762f2482-ff21-4970-8939-0aa317a886bb",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/04/25",
            "references": [
                "https://github.com/GhostPack/Certify"
            ],
            "status": "test",
            "tags": [
                "attack.discovery",
                "attack.credential_access",
                "attack.t1649"
            ],
            "title": "HackTool - Certify Execution"
        },
        {
            "author": "pH-T (Nextron Systems)",
            "date": "2023/04/17",
            "description": "Detects Certipy a tool for Active Directory Certificate Services enumeration and abuse based on PE metadata characteristics and common command line arguments.",
            "detection": {
                "condition": "selection_img or all of selection_cli_*",
                "selection_cli_commands": {
                    "CommandLine|contains": [
                        " auth ",
                        " find ",
                        " forge ",
                        " relay ",
                        " req ",
                        " shadow "
                    ]
                },
                "selection_cli_flags": {
                    "CommandLine|contains": [
                        " -bloodhound",
                        " -ca-pfx ",
                        " -dc-ip ",
                        " -kirbi",
                        " -old-bloodhound",
                        " -pfx ",
                        " -target",
                        " -username ",
                        " -vulnerable",
                        "auth -pfx",
                        "shadow auto",
                        "shadow list"
                    ]
                },
                "selection_img": [
                    {
                        "Image|endswith": "\\Certipy.exe"
                    },
                    {
                        "OriginalFileName": "Certipy.exe"
                    },
                    {
                        "Description|contains": "Certipy"
                    }
                ]
            },
            "falsepositives": [
                "Unlikely"
            ],
            "id": "6938366d-8954-4ddc-baff-c830b3ba8fcd",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "references": [
                "https://github.com/ly4k/Certipy"
            ],
            "status": "test",
            "title": "HackTool - Certipy Execution",
            "tags": [
                "attack.discovery",
                "attack.credential_access",
                "attack.t1649"
            ]
        },
        {
            "author": "Zach Mathis",
            "date": "2023/05/13",
            "description": "Detects when an application acquires a certificate private key",
            "detection": {
                "condition": "selection",
                "selection": {
                    "EventID": 70
                }
            },
            "falsepositives": [
                "Legitimate application requesting certificate exports will trigger this. Apply additional filters as needed"
            ],
            "id": "e2b5163d-7deb-4566-9af3-40afea6858c3",
            "level": "medium",
            "logsource": {
                "definition": "Requirements: The CAPI2 Operational log needs to be enabled",
                "product": "windows",
                "service": "capi2"
            },
            "references": [
                "https://www.splunk.com/en_us/blog/security/breaking-the-chain-defending-against-certificate-services-abuse.html"
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1649"
            ],
            "title": "Certificate Private Key Acquired"
        },
        {
            "author": "Zach Mathis",
            "date": "2023/05/13",
            "description": "Detects when an application exports a certificate (and potentially the private key as well) from the local Windows certificate store.",
            "detection": {
                "condition": "selection",
                "selection": {
                    "EventID": 1007
                }
            },
            "falsepositives": [
                "Legitimate application requesting certificate exports will trigger this. Apply additional filters as needed"
            ],
            "id": "58c0bff0-40a0-46e8-b5e8-b734b84d2017",
            "level": "medium",
            "logsource": {
                "product": "windows",
                "service": "certificateservicesclient-lifecycle-system"
            },
            "references": [
                "https://www.splunk.com/en_us/blog/security/breaking-the-chain-defending-against-certificate-services-abuse.html"
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1649"
            ],
            "title": "Certificate Exported From Local Certificate Store"
        }
    ],
    "x_mitre_platforms": [
        "Windows",
        "Linux",
        "macOS",
        "Azure AD"
    ],
    "x_mitre_domains": [
        "enterprise-attack"
    ],
    "x_mitre_contributors": [
        "Tristan Bennett, Seamless Intelligence",
        "Lee Christensen, SpecterOps",
        "Thirumalai Natarajan, Mandiant"
    ],
    "kill_chain_phases": [
        {
            "kill_chain_name": "mitre-attack",
            "phase_name": "credential-access"
        }
    ],
    "x_mitre_detection": "",
    "x_mitre_is_subtechnique": false,
    "x_mitre_version": "1.1",
    "x_mitre_modified_by_ref": "identity--c78cb6e5-0c4b-4611-8297-d1b8b55e40b5",
    "x_mitre_data_sources": [
        "Command: Command Execution",
        "Application Log: Application Log Content",
        "Active Directory: Active Directory Credential Request",
        "Active Directory: Active Directory Object Modification",
        "Windows Registry: Windows Registry Key Access",
        "File: File Access",
        "Logon Session: Logon Session Creation"
    ],
    "x_mitre_permissions_required": []
}