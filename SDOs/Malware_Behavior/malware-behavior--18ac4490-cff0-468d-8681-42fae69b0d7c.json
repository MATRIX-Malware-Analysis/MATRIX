{
    "type": "malware-behavior",
    "spec_version": "2.1",
    "id": "malware-behavior--18ac4490-cff0-468d-8681-42fae69b0d7c",
    "created": "2024-08-13T14:46:36.878014Z",
    "modified": "2024-08-13T14:46:44.72955Z",
    "name": "Event Triggered Execution: Windows Management Instrumentation Event Subscription",
    "description": "Adversaries may establish persistence and elevate privileges by executing malicious content triggered by a Windows Management Instrumentation (WMI) event subscription. WMI can be used to install event filters, providers, consumers, and bindings that execute code when a defined event occurs. Examples of events that may be subscribed to are the wall clock time, user login, or the computer's uptime.[1]Adversaries may use the capabilities of WMI to subscribe to an event and execute arbitrary code when that event occurs, providing persistence on a system.[2][3] Adversaries may also compile WMI scripts \u2013 using mofcomp.exe  \u2013into Windows Management Object (MOF) files (.mof extension) that can be used to create a malicious subscription.[4][5]WMI subscription execution is proxied by the WMI Provider Host process (WmiPrvSe.exe) and thus may result in elevated SYSTEM privileges.",
    "object_marking_refs": [
        "marking-definition--613f2e26-407d-48c7-9eca-b8e91df99dc9"
    ],
    "external_references": [
        {
            "source_name": "MITRE ATT&CK",
            "url": "https://attack.mitre.org/techniques/T1546/003",
            "external_id": "T1546/003"
        }
    ],
    "x_mitre_detection_rules": [
        {
            "author": "Thomas Patzke",
            "date": "2018/03/07",
            "description": "Detects WMI command line event consumers",
            "detection": {
                "condition": "selection",
                "selection": {
                    "Image": "C:\\Windows\\System32\\wbem\\WmiPrvSE.exe",
                    "ImageLoaded|endswith": "\\wbemcons.dll"
                }
            },
            "falsepositives": [
                "Unknown (data set is too small; further testing needed)"
            ],
            "id": "05936ce2-ee05-4dae-9d03-9a391cf2d2c6",
            "level": "high",
            "logsource": {
                "category": "image_load",
                "product": "windows"
            },
            "modified": "2021/11/27",
            "references": [
                "https://www.eideon.com/2018-03-02-THL03-WMIBackdoors/"
            ],
            "status": "test",
            "tags": [
                "attack.t1546.003",
                "attack.persistence"
            ],
            "title": "WMI Persistence - Command Line Event Consumer"
        },
        {
            "author": "Roberto Rodriguez (Cyb3rWard0g), OTR (Open Threat Research)",
            "date": "2020/09/02",
            "description": "Detects signs of the WMI script host process \"scrcons.exe\" loading scripting DLLs which could indicates WMI ActiveScriptEventConsumers EventConsumers activity.",
            "detection": {
                "condition": "selection",
                "selection": {
                    "ImageLoaded|endswith": [
                        "\\vbscript.dll",
                        "\\wbemdisp.dll",
                        "\\wshom.ocx",
                        "\\scrrun.dll"
                    ],
                    "Image|endswith": "\\scrcons.exe"
                }
            },
            "falsepositives": [
                "Legitimate event consumers",
                "Dell computers on some versions register an event consumer that is known to cause false positives when brightness is changed by the corresponding keyboard button"
            ],
            "id": "b439f47d-ef52-4b29-9a2f-57d8a96cb6b8",
            "level": "medium",
            "logsource": {
                "category": "image_load",
                "product": "windows"
            },
            "modified": "2023/02/22",
            "references": [
                "https://twitter.com/HunterPlaybook/status/1301207718355759107",
                "https://www.mdsec.co.uk/2020/09/i-like-to-move-it-windows-lateral-movement-part-1-wmi-event-subscription/",
                "https://threathunterplaybook.com/hunts/windows/200902-RemoteWMIActiveScriptEventConsumers/notebook.html"
            ],
            "status": "test",
            "tags": [
                "attack.lateral_movement",
                "attack.privilege_escalation",
                "attack.persistence",
                "attack.t1546.003"
            ],
            "title": "WMI ActiveScriptEventConsumers Activity Via Scrcons.EXE DLL Load"
        },
        {
            "author": "Florian Roth (Nextron Systems)",
            "date": "2021/09/01",
            "description": "Detects suspicious encoded payloads in WMI Event Consumers",
            "detection": {
                "condition": "selection_destination",
                "selection_destination": {
                    "Destination|base64offset|contains": [
                        "WriteProcessMemory",
                        "This program cannot be run in DOS mode",
                        "This program must be run under Win32"
                    ]
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "fields": [
                "User",
                "Operation"
            ],
            "id": "83844185-1c5b-45bc-bcf3-b5bf3084ca5b",
            "level": "high",
            "logsource": {
                "category": "wmi_event",
                "product": "windows"
            },
            "modified": "2022/10/09",
            "status": "test",
            "references": [
                "https://github.com/RiccardoAncarani/LiquidSnake"
            ],
            "tags": [
                "attack.execution",
                "attack.t1047",
                "attack.persistence",
                "attack.t1546.003"
            ],
            "title": "Suspicious Encoded Scripts in a WMI Consumer"
        },
        {
            "author": "Tom Ueltschi (@c_APT_ure)",
            "date": "2019/01/12",
            "description": "Detects creation of WMI event subscription persistence method",
            "detection": {
                "condition": "selection",
                "selection": {
                    "EventID": [
                        19,
                        20,
                        21
                    ]
                }
            },
            "falsepositives": [
                "Exclude legitimate (vetted) use of WMI event subscription in your network"
            ],
            "id": "0f06a3a5-6a09-413f-8743-e6cf35561297",
            "level": "medium",
            "modified": "2021/11/27",
            "logsource": {
                "category": "wmi_event",
                "product": "windows"
            },
            "references": [
                "https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon#event-id-19-wmievent-wmieventfilter-activity-detected",
                "https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon#event-id-20-wmievent-wmieventconsumer-activity-detected",
                "https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon#event-id-21-wmievent-wmieventconsumertofilter-activity-detected"
            ],
            "status": "test",
            "tags": [
                "attack.persistence",
                "attack.t1546.003"
            ],
            "title": "WMI Event Subscription"
        },
        {
            "author": "Thomas Patzke",
            "date": "2018/03/07",
            "description": "Detects file writes of WMI script event consumer",
            "detection": {
                "condition": "selection",
                "selection": {
                    "Image": "C:\\WINDOWS\\system32\\wbem\\scrcons.exe"
                }
            },
            "falsepositives": [
                "Dell Power Manager (C:\\Program Files\\Dell\\PowerManager\\DpmPowerPlanSetup.exe)"
            ],
            "id": "33f41cdd-35ac-4ba8-814b-c6a4244a1ad4",
            "level": "high",
            "logsource": {
                "category": "file_event",
                "product": "windows"
            },
            "modified": "2021/11/27",
            "references": [
                "https://www.eideon.com/2018-03-02-THL03-WMIBackdoors/"
            ],
            "status": "test",
            "tags": [
                "attack.t1546.003",
                "attack.persistence"
            ],
            "title": "WMI Persistence - Script Event Consumer File Write"
        },
        {
            "author": "Thomas Patzke",
            "date": "2018/03/07",
            "description": "Detects WMI script event consumers",
            "detection": {
                "condition": "selection",
                "selection": {
                    "Image": "C:\\WINDOWS\\system32\\wbem\\scrcons.exe",
                    "ParentImage": "C:\\Windows\\System32\\svchost.exe"
                }
            },
            "falsepositives": [
                "Legitimate event consumers",
                "Dell computers on some versions register an event consumer that is known to cause false positives when brightness is changed by the corresponding keyboard button"
            ],
            "id": "ec1d5e28-8f3b-4188-a6f8-6e8df81dc28e",
            "level": "medium",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2022/10/11",
            "references": [
                "https://www.eideon.com/2018-03-02-THL03-WMIBackdoors/"
            ],
            "status": "test",
            "tags": [
                "attack.persistence",
                "attack.privilege_escalation",
                "attack.t1546.003"
            ],
            "title": "WMI Persistence - Script Event Consumer"
        },
        {
            "author": "Florian Roth (Nextron Systems)",
            "date": "2019/10/11",
            "description": "Detects a WMI backdoor in Exchange Transport Agents via WMI event filters",
            "detection": {
                "condition": "selection and not 1 of filter_*",
                "filter_conhost": {
                    "Image": "C:\\Windows\\System32\\conhost.exe"
                },
                "filter_oleconverter": {
                    "Image|endswith": "\\Bin\\OleConverter.exe",
                    "Image|startswith": "C:\\Program Files\\Microsoft\\Exchange Server\\"
                },
                "selection": {
                    "ParentImage|endswith": "\\EdgeTransport.exe"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "797011dc-44f4-4e6f-9f10-a8ceefbe566b",
            "level": "critical",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/02/08",
            "references": [
                "https://twitter.com/cglyer/status/1182389676876980224",
                "https://twitter.com/cglyer/status/1182391019633029120"
            ],
            "status": "test",
            "tags": [
                "attack.persistence",
                "attack.t1546.003"
            ],
            "title": "WMI Backdoor Exchange Transport Agent"
        },
        {
            "author": "Florian Roth (Nextron Systems)",
            "date": "2021/06/25",
            "description": "Detects WMIC executions in which an event consumer gets created. This could be used to establish persistence",
            "detection": {
                "condition": "selection",
                "selection": {
                    "CommandLine|contains|all": [
                        "ActiveScriptEventConsumer",
                        " CREATE "
                    ]
                }
            },
            "falsepositives": [
                "Legitimate software creating script event consumers"
            ],
            "fields": [
                "CommandLine",
                "ParentCommandLine"
            ],
            "id": "ebef4391-1a81-4761-a40a-1db446c0e625",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/02/14",
            "status": "test",
            "references": [
                "https://twitter.com/johnlatwc/status/1408062131321270282?s=12",
                "https://www.fireeye.com/content/dam/fireeye-www/global/en/current-threats/pdfs/wp-windows-management-instrumentation.pdf"
            ],
            "tags": [
                "attack.persistence",
                "attack.t1546.003"
            ],
            "title": "New ActiveScriptEventConsumer Created Via Wmic.EXE"
        },
        {
            "author": "Florian Roth (Nextron Systems), Gleb Sukhodolskiy, Timur Zinniatullin oscd.community",
            "date": "2017/08/22",
            "description": "Detects suspicious WMI event filter and command line event consumer based on WMI and Security Logs.",
            "detection": {
                "condition": "( (wmi_filter_to_consumer_binding and consumer_keywords) or (wmi_filter_registration) ) and not filter_scmevent",
                "consumer_keywords": [
                    "ActiveScriptEventConsumer",
                    "CommandLineEventConsumer",
                    "CommandLineTemplate"
                ],
                "filter_scmevent": {
                    "PossibleCause": "Permanent",
                    "Provider": "SCM Event Provider",
                    "Query": "select * from MSFT_SCMEventLogEvent",
                    "User": "S-1-5-32-544"
                },
                "wmi_filter_registration": {
                    "EventID": 5859
                },
                "wmi_filter_to_consumer_binding": {
                    "EventID": 5861
                }
            },
            "falsepositives": [
                "Unknown (data set is too small; further testing needed)"
            ],
            "id": "0b7889b4-5577-4521-a60a-3376ee7f9f7b",
            "level": "medium",
            "logsource": {
                "definition": "WMI Namespaces Auditing and SACL should be configured, EventID 5861 and 5859 detection requires Windows 10, 2012 and higher",
                "product": "windows",
                "service": "wmi"
            },
            "modified": "2022/02/10",
            "references": [
                "https://twitter.com/mattifestation/status/899646620148539397",
                "https://www.eideon.com/2018-03-02-THL03-WMIBackdoors/"
            ],
            "status": "test",
            "tags": [
                "attack.persistence",
                "attack.privilege_escalation",
                "attack.t1546.003"
            ],
            "title": "WMI Persistence"
        },
        {
            "author": "Florian Roth (Nextron Systems), Gleb Sukhodolskiy, Timur Zinniatullin oscd.community",
            "date": "2017/08/22",
            "description": "Detects suspicious WMI event filter and command line event consumer based on WMI and Security Logs.",
            "detection": {
                "condition": "selection",
                "selection": {
                    "EventID": 4662,
                    "ObjectName|contains": "subscription",
                    "ObjectType": "WMI Namespace"
                }
            },
            "falsepositives": [
                "Unknown (data set is too small; further testing needed)"
            ],
            "id": "f033f3f3-fd24-4995-97d8-a3bb17550a88",
            "level": "medium",
            "logsource": {
                "product": "windows",
                "service": "security"
            },
            "modified": "2022/11/29",
            "references": [
                "https://twitter.com/mattifestation/status/899646620148539397",
                "https://www.eideon.com/2018-03-02-THL03-WMIBackdoors/"
            ],
            "related": [
                {
                    "type": "derived",
                    "id": "0b7889b4-5577-4521-a60a-3376ee7f9f7b"
                }
            ],
            "status": "test",
            "tags": [
                "attack.persistence",
                "attack.privilege_escalation",
                "attack.t1546.003"
            ],
            "title": "WMI Persistence - Security"
        },
        {
            "author": "Roberto Rodriguez (Cyb3rWard0g), OTR (Open Threat Research)",
            "date": "2020/09/02",
            "description": "Detect potential adversaries leveraging WMI ActiveScriptEventConsumers remotely to move laterally in a network",
            "detection": {
                "condition": "selection and not filter",
                "filter": {
                    "TargetLogonId": "0x3e7"
                },
                "selection": {
                    "EventID": 4624,
                    "LogonType": 3,
                    "ProcessName|endswith": "scrcons.exe"
                }
            },
            "falsepositives": [
                "SCCM"
            ],
            "id": "9599c180-e3a8-4743-8f92-7fb96d3be648",
            "level": "high",
            "logsource": {
                "product": "windows",
                "service": "security"
            },
            "modified": "2021/11/27",
            "references": [
                "https://threathunterplaybook.com/hunts/windows/200902-RemoteWMIActiveScriptEventConsumers/notebook.html"
            ],
            "status": "test",
            "tags": [
                "attack.lateral_movement",
                "attack.privilege_escalation",
                "attack.persistence",
                "attack.t1546.003"
            ],
            "title": "Remote WMI ActiveScriptEventConsumers"
        },
        {
            "author": "frack113",
            "date": "2021/08/19",
            "description": "Adversaries may establish persistence and elevate privileges by executing malicious content triggered by a Windows Management Instrumentation (WMI) event subscription.",
            "detection": {
                "condition": "selection_ioc",
                "selection_ioc": [
                    {
                        "ScriptBlockText|contains|all": [
                            "New-CimInstance ",
                            "-Namespace root/subscription ",
                            "-ClassName __EventFilter ",
                            "-Property "
                        ]
                    },
                    {
                        "ScriptBlockText|contains|all": [
                            "New-CimInstance ",
                            "-Namespace root/subscription ",
                            "-ClassName CommandLineEventConsumer ",
                            "-Property "
                        ]
                    }
                ]
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "9e07f6e7-83aa-45c6-998e-0af26efd0a85",
            "level": "medium",
            "logsource": {
                "category": "ps_script",
                "product": "windows",
                "definition": "Requirements: Script Block Logging must be enabled"
            },
            "modified": "2022/12/25",
            "references": [
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1546.003/T1546.003.md",
                "https://github.com/EmpireProject/Empire/blob/08cbd274bef78243d7a8ed6443b8364acd1fc48b/data/module_source/persistence/Persistence.psm1#L545"
            ],
            "status": "test",
            "tags": [
                "attack.privilege_escalation",
                "attack.t1546.003"
            ],
            "title": "Powershell WMI Persistence"
        }
    ]
}