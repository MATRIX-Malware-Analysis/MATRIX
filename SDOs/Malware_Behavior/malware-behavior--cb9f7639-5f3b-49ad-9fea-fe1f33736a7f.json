{
    "type": "malware-behavior",
    "spec_version": "2.1",
    "id": "malware-behavior--cb9f7639-5f3b-49ad-9fea-fe1f33736a7f",
    "created": "2024-08-13T14:46:37.050752Z",
    "modified": "2024-08-13T14:46:45.694302Z",
    "name": "Remote Services: Windows Remote Management",
    "description": "Adversaries may use Valid Accounts to interact with remote systems using Windows Remote Management (WinRM). The adversary may then perform actions as the logged-on user.WinRM is the name of both a Windows service and a protocol that allows a user to interact with a remote system (e.g., run an executable, modify the Registry, modify services).[1] It may be called with the winrm command or by any number of programs such as PowerShell.[2] WinRM  can be used as a method of remotely interacting with Windows Management Instrumentation.[3]",
    "object_marking_refs": [
        "marking-definition--613f2e26-407d-48c7-9eca-b8e91df99dc9"
    ],
    "external_references": [
        {
            "source_name": "MITRE ATT&CK",
            "url": "https://attack.mitre.org/techniques/T1021/006",
            "external_id": "T1021/006"
        }
    ],
    "x_mitre_detection_rules": [
        {
            "author": "Nate Guagenti (neu5ron)",
            "date": "2021/09/20",
            "description": "Detects the exploitation of OMIGOD (CVE-2021-38647) which allows remote execute (RCE) commands as root with just a single unauthenticated HTTP request.\nVerify, successful, exploitation by viewing the HTTP client (request) body to see what was passed to the server (using PCAP).\nWithin the client body is where the code execution would occur. Additionally, check the endpoint logs to see if suspicious commands or activity occurred within the timeframe of this HTTP request.\n",
            "detection": {
                "auth_header": {
                    "client_header_names|contains": "AUTHORIZATION"
                },
                "condition": "selection and not auth_header and not too_small_http_client_body",
                "selection": {
                    "method": "POST",
                    "status_code": 200,
                    "uri": "/wsman"
                },
                "too_small_http_client_body": {
                    "request_body_len": 0
                }
            },
            "falsepositives": [
                "Exploits that were attempted but unsuccessful.",
                "Scanning attempts with the abnormal use of the HTTP POST method with no indication of code execution within the HTTP Client (Request) body. An example would be vulnerability scanners trying to identify unpatched versions while not actually exploiting the vulnerability. See description for investigation tips."
            ],
            "fields": [
                "id.orig_h",
                "id.resp_h",
                "id.resp_p",
                "status_code",
                "method",
                "uri",
                "request_body_len",
                "response_body_len",
                "user_agent"
            ],
            "id": "ab6b1a39-a9ee-4ab4-b075-e83acf6e346b",
            "level": "high",
            "logsource": {
                "definition": "Enable the builtin Zeek script that logs all HTTP header names by adding \"@load policy/protocols/http/header-names\" to your local.zeek config file. The script can be seen here for reference https://github.com/zeek/zeek/blob/d957f883df242ef159cfd846884e673addeea7a5/scripts/policy/protocols/http/header-names.zeek",
                "product": "zeek",
                "service": "http"
            },
            "modified": "2019/09/20",
            "references": [
                "https://www.wiz.io/blog/omigod-critical-vulnerabilities-in-omi-azure",
                "https://twitter.com/neu5ron/status/1438987292971053057?s=20"
            ],
            "status": "stable",
            "tags": [
                "attack.privilege_escalation",
                "attack.initial_access",
                "attack.execution",
                "attack.lateral_movement",
                "attack.t1068",
                "attack.t1190",
                "attack.t1203",
                "attack.t1021.006",
                "attack.t1210"
            ],
            "title": "OMIGOD HTTP No Authentication RCE"
        },
        {
            "author": "Patryk Prauze - ING Tech",
            "date": "2019/05/20",
            "description": "Detects remote access to the LSASS process via WinRM. This could be a sign of credential dumping from tools like mimikatz.",
            "detection": {
                "condition": "selection and not 1 of filter_main_*",
                "filter_main_access": {
                    "GrantedAccess": "0x80000000"
                },
                "selection": {
                    "SourceImage|endswith": ":\\Windows\\system32\\wsmprovhost.exe",
                    "TargetImage|endswith": "\\lsass.exe"
                }
            },
            "falsepositives": [
                "Unlikely"
            ],
            "id": "aa35a627-33fb-4d04-a165-d33b4afca3e8",
            "logsource": {
                "category": "process_access",
                "product": "windows"
            },
            "level": "high",
            "modified": "2023/11/29",
            "references": [
                "https://pentestlab.blog/2018/05/15/lateral-movement-winrm/"
            ],
            "status": "stable",
            "tags": [
                "attack.credential_access",
                "attack.execution",
                "attack.t1003.001",
                "attack.t1059.001",
                "attack.lateral_movement",
                "attack.t1021.006",
                "attack.s0002"
            ],
            "title": "Remote LSASS Process Access Through Windows Remote Management"
        },
        {
            "author": "Roberto Rodriguez @Cyb3rWard0g",
            "date": "2019/09/12",
            "description": "Detects a process that initiated a network connection over ports 5985 or 5986 from a non-network service account.\nThis could potentially indicates a remote PowerShell connection.\n",
            "detection": {
                "condition": "selection and not 1 of filter_main_* and not 1 of filter_optional_*",
                "filter_main_localhost": {
                    "DestinationIp": [
                        "::1",
                        "127.0.0.1"
                    ],
                    "SourceIp": [
                        "::1",
                        "127.0.0.1"
                    ]
                },
                "filter_main_service_users": [
                    {
                        "User|contains": [
                            "NETWORK SERVICE",
                            "NETZWERKDIENST",
                            "SERVICIO DE RED",
                            "SERVIZIO DI RETE"
                        ]
                    },
                    {
                        "User|contains|all": [
                            "SERVICE R",
                            "SEAU"
                        ]
                    }
                ],
                "filter_optional_avast": {
                    "Image": [
                        "C:\\Program Files\\Avast Software\\Avast\\AvastSvc.exe",
                        "C:\\Program Files (x86)\\Avast Software\\Avast\\AvastSvc.exe"
                    ]
                },
                "selection": {
                    "DestinationPort": [
                        5985,
                        5986
                    ],
                    "Initiated": "true",
                    "SourceIsIpv6": "false"
                }
            },
            "falsepositives": [
                "Legitimate usage of remote PowerShell, e.g. remote administration and monitoring.",
                "Network Service user name of a not-covered localization"
            ],
            "id": "c539afac-c12a-46ed-b1bd-5a5567c9f045",
            "logsource": {
                "category": "network_connection",
                "product": "windows"
            },
            "level": "high",
            "modified": "2024/02/02",
            "references": [
                "https://threathunterplaybook.com/hunts/windows/190511-RemotePwshExecution/notebook.html"
            ],
            "status": "test",
            "tags": [
                "attack.execution",
                "attack.t1059.001",
                "attack.lateral_movement",
                "attack.t1021.006"
            ],
            "title": "Potential Remote PowerShell Session Initiated"
        },
        {
            "author": "Roberto Rodriguez @Cyb3rWard0g",
            "date": "2019/09/12",
            "description": "Detects remote PowerShell sections by monitoring for wsmprovhost (WinRM host process) as a parent or child process (sign of an active PowerShell remote session).",
            "detection": {
                "condition": "selection",
                "selection": [
                    {
                        "Image|endswith": "\\wsmprovhost.exe"
                    },
                    {
                        "ParentImage|endswith": "\\wsmprovhost.exe"
                    }
                ]
            },
            "falsepositives": [
                "Legitimate usage of remote Powershell, e.g. for monitoring purposes."
            ],
            "fields": [
                "ComputerName",
                "User",
                "CommandLine"
            ],
            "id": "734f8d9b-42b8-41b2-bcf5-abaf49d5a3c8",
            "level": "medium",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "references": [
                "https://threathunterplaybook.com/hunts/windows/190511-RemotePwshExecution/notebook.html"
            ],
            "modified": "2022/10/09",
            "status": "test",
            "tags": [
                "attack.execution",
                "attack.t1059.001",
                "attack.t1021.006"
            ],
            "title": "Remote PowerShell Session Host Process (WinRM)"
        },
        {
            "author": "frack113",
            "date": "2022/01/07",
            "description": "Adversaries may use Valid Accounts to log into a computer using the Remote Desktop Protocol (RDP). The adversary may then perform actions as the logged-on user.",
            "detection": {
                "condition": "selection",
                "selection": {
                    "CommandLine|contains|all": [
                        "-i ",
                        "-u ",
                        "-p "
                    ],
                    "Image|endswith": "\\ruby.exe"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "a197e378-d31b-41c0-9635-cfdf1c1bb423",
            "level": "medium",
            "modified": "2023/02/13",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "references": [
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1021.006/T1021.006.md#atomic-test-3---winrm-access-with-evil-winrm",
                "https://github.com/Hackplayers/evil-winrm"
            ],
            "status": "test",
            "tags": [
                "attack.lateral_movement",
                "attack.t1021.006"
            ],
            "title": "HackTool - WinRM Access Via Evil-WinRM"
        },
        {
            "author": "Roberto Rodriguez @Cyb3rWard0g",
            "date": "2019/08/10",
            "description": "Detects remote PowerShell sessions",
            "detection": {
                "condition": "selection",
                "selection": {
                    "Data|contains|all": [
                        "HostName=ServerRemoteHost",
                        "wsmprovhost.exe"
                    ]
                }
            },
            "falsepositives": [
                "Legitimate use remote PowerShell sessions"
            ],
            "id": "60167e5c-84b2-4c95-a7ac-86281f27c445",
            "level": "low",
            "logsource": {
                "category": "ps_classic_start",
                "product": "windows"
            },
            "modified": "2024/01/03",
            "references": [
                "https://threathunterplaybook.com/hunts/windows/190511-RemotePwshExecution/notebook.html"
            ],
            "related": [
                {
                    "id": "96b9f619-aa91-478f-bacb-c3e50f8df575",
                    "type": "derived"
                }
            ],
            "status": "test",
            "tags": [
                "attack.execution",
                "attack.t1059.001",
                "attack.lateral_movement",
                "attack.t1021.006"
            ],
            "title": "Remote PowerShell Session (PS Classic)"
        },
        {
            "author": "frack113",
            "date": "2022/01/07",
            "description": "Adversaries may use Valid Accounts to interact with remote systems using Windows Remote Management (WinRM). The adversary may then perform actions as the logged-on user.",
            "detection": {
                "condition": "selection_cmdlet",
                "selection_cmdlet": {
                    "ScriptBlockText|contains": "Enable-PSRemoting "
                }
            },
            "falsepositives": [
                "Legitimate script"
            ],
            "id": "991a9744-f2f0-44f2-bd33-9092eba17dc3",
            "logsource": {
                "category": "ps_script",
                "product": "windows",
                "definition": "Requirements: Script Block Logging must be enabled"
            },
            "level": "medium",
            "references": [
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1021.006/T1021.006.md#atomic-test-1---enable-windows-remote-management",
                "https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/enable-psremoting?view=powershell-7.2"
            ],
            "status": "test",
            "title": "Enable Windows Remote Management",
            "tags": [
                "attack.lateral_movement",
                "attack.t1021.006"
            ]
        },
        {
            "author": "frack113",
            "date": "2022/01/07",
            "description": "Adversaries may use Valid Accounts to interact with remote systems using Windows Remote Management (WinRM). The adversary may then perform actions as the logged-on user.",
            "detection": {
                "condition": "selection_cmdlet",
                "selection_cmdlet": {
                    "ScriptBlockText|contains|all": [
                        "invoke-command ",
                        " -ComputerName "
                    ]
                }
            },
            "falsepositives": [
                "Legitimate script"
            ],
            "id": "7b836d7f-179c-4ba4-90a7-a7e60afb48e6",
            "logsource": {
                "category": "ps_script",
                "product": "windows",
                "definition": "Requirements: Script Block Logging must be enabled"
            },
            "level": "medium",
            "references": [
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1021.006/T1021.006.md#atomic-test-2---invoke-command",
                "https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/invoke-command?view=powershell-7.4"
            ],
            "status": "test",
            "title": "Execute Invoke-command on Remote Host",
            "tags": [
                "attack.lateral_movement",
                "attack.t1021.006"
            ]
        },
        {
            "id": "96b9f619-aa91-478f-bacb-c3e50f8df575",
            "author": "Roberto Rodriguez @Cyb3rWard0g, Tim Shelton",
            "date": "2019/08/10",
            "description": "Detects remote PowerShell sessions",
            "detection": {
                "condition": "selection and not 1 of filter_*",
                "filter_pwsh_archive": {
                    "ContextInfo|contains": "\\Windows\\system32\\WindowsPowerShell\\v1.0\\Modules\\Microsoft.PowerShell.Archive\\Microsoft.PowerShell.Archive.psm1"
                },
                "selection": {
                    "ContextInfo|contains|all": [
                        " = ServerRemoteHost ",
                        "wsmprovhost.exe"
                    ]
                }
            },
            "falsepositives": [
                "Legitimate use remote PowerShell sessions"
            ],
            "logsource": {
                "category": "ps_module",
                "product": "windows",
                "definition": "0ad03ef1-f21b-4a79-8ce8-e6900c54b65b"
            },
            "level": "high",
            "modified": "2023/01/20",
            "references": [
                "https://threathunterplaybook.com/hunts/windows/190511-RemotePwshExecution/notebook.html"
            ],
            "status": "test",
            "tags": [
                "attack.execution",
                "attack.t1059.001",
                "attack.lateral_movement",
                "attack.t1021.006"
            ],
            "title": "Remote PowerShell Session (PS Module)"
        }
    ]
}