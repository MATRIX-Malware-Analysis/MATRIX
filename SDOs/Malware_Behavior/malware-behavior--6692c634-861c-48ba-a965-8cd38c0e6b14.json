{
    "type": "malware-behavior",
    "spec_version": "2.1",
    "id": "malware-behavior--6692c634-861c-48ba-a965-8cd38c0e6b14",
    "created": "2024-08-13T14:46:36.885464Z",
    "modified": "2024-08-13T14:46:44.774821Z",
    "name": "Event Triggered Execution: Component Object Model Hijacking",
    "description": "Adversaries may establish persistence by executing malicious content triggered by hijacked references to Component Object Model (COM) objects. COM is a system within Windows to enable interaction between software components through the operating system.[1]  References to various COM objects are stored in the Registry. Adversaries can use the COM system to insert malicious code that can be executed in place of legitimate software through hijacking the COM references and relationships as a means for persistence. Hijacking a COM object requires a change in the Registry to replace a reference to a legitimate system component which may cause that component to not work when executed. When that system component is executed through normal system operation the adversary's code will be executed instead.[2] An adversary is likely to hijack objects that are used frequently enough to maintain a consistent level of persistence, but are unlikely to break noticeable functionality within the system as to avoid system instability that could lead to detection.",
    "object_marking_refs": [
        "marking-definition--613f2e26-407d-48c7-9eca-b8e91df99dc9"
    ],
    "external_references": [
        {
            "source_name": "MITRE ATT&CK",
            "url": "https://attack.mitre.org/techniques/T1546/015",
            "external_id": "T1546/015"
        }
    ],
    "x_mitre_detection_rules": [
        {
            "author": "frack113",
            "date": "2022/02/13",
            "description": "load malicious registered COM objects",
            "detection": {
                "condition": "all of selection_*",
                "selection_cli": {
                    "CommandLine|contains": [
                        "-sta ",
                        "-localserver "
                    ],
                    "CommandLine|contains|all": [
                        "{",
                        "}"
                    ]
                },
                "selection_img": [
                    {
                        "Image|endswith": "\\rundll32.exe"
                    },
                    {
                        "OriginalFileName": "RUNDLL32.EXE"
                    }
                ]
            },
            "falsepositives": [
                "Legitimate use"
            ],
            "id": "f1edd233-30b5-4823-9e6a-c4171b24d316",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/02/09",
            "references": [
                "https://nasbench.medium.com/a-deep-dive-into-rundll32-exe-642344b41e90",
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1546.015/T1546.015.md"
            ],
            "status": "test",
            "tags": [
                "attack.privilege_escalation",
                "attack.persistence",
                "attack.t1546.015"
            ],
            "title": "Rundll32 Registered COM Objects"
        },
        {
            "author": "frack113",
            "date": "2022/04/02",
            "description": "Detects suspicious Powershell code that execute COM Objects",
            "detection": {
                "condition": "selection",
                "selection": {
                    "ScriptBlockText|contains|all": [
                        "::GetTypeFromCLSID(",
                        ".ShellExecute("
                    ]
                }
            },
            "falsepositives": [
                "Legitimate PowerShell scripts"
            ],
            "id": "8bc063d5-3a3a-4f01-a140-bc15e55e8437",
            "level": "medium",
            "logsource": {
                "category": "ps_script",
                "product": "windows",
                "definition": "Requirements: Script Block Logging must be enabled"
            },
            "references": [
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1546.015/T1546.015.md#atomic-test-2---powershell-execute-com-object"
            ],
            "status": "test",
            "title": "Suspicious GetTypeFromCLSID ShellExecute",
            "tags": [
                "attack.privilege_escalation",
                "attack.persistence",
                "attack.t1546.015"
            ]
        },
        {
            "author": "Kutepov Anton, oscd.community",
            "date": "2019/10/23",
            "description": "Detects COM object hijacking via TreatAs subkey",
            "detection": {
                "condition": "selection and not 1 of filter_*",
                "filter_svchost": {
                    "Image": "C:\\WINDOWS\\system32\\svchost.exe"
                },
                "selection": {
                    "EventType": "CreateKey",
                    "TargetObject|contains|all": [
                        "HKU\\",
                        "Classes\\CLSID\\",
                        "\\TreatAs"
                    ]
                }
            },
            "falsepositives": [
                "Maybe some system utilities in rare cases use linking keys for backward compatibility"
            ],
            "id": "9b0f8a61-91b2-464f-aceb-0527e0a45020",
            "level": "medium",
            "logsource": {
                "category": "registry_add",
                "product": "windows"
            },
            "modified": "2023/02/07",
            "references": [
                "https://bohops.com/2018/08/18/abusing-the-com-registry-structure-part-2-loading-techniques-for-evasion-and-persistence/"
            ],
            "status": "test",
            "tags": [
                "attack.persistence",
                "attack.t1546.015"
            ],
            "title": "Potential COM Object Hijacking Via TreatAs Subkey - Registry"
        },
        {
            "author": "BlackBerry Threat Research and Intelligence Team - @Joseliyo_Jstnk",
            "date": "2023/06/07",
            "description": "Detects changes to the PSFactory COM InProcServer32 registry. This technique was used by RomCom to create persistence storing a malicious DLL.",
            "detection": {
                "condition": "selection and not filter_main",
                "filter_main": {
                    "Details": [
                        "%windir%\\System32\\ActXPrxy.dll",
                        "C:\\Windows\\System32\\ActXPrxy.dll"
                    ]
                },
                "selection": {
                    "TargetObject|endswith": "\\CLSID\\{c90250f3-4d7d-4991-9b69-a5c5bc1c2ae6}\\InProcServer32\\(Default)"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "243380fa-11eb-4141-af92-e14925e77c1b",
            "level": "high",
            "logsource": {
                "category": "registry_set",
                "product": "windows"
            },
            "modified": "2023/08/17",
            "references": [
                "https://blogs.blackberry.com/en/2023/06/romcom-resurfaces-targeting-ukraine",
                "https://strontic.github.io/xcyclopedia/library/clsid_C90250F3-4D7D-4991-9B69-A5C5BC1C2AE6.html",
                "https://www.virustotal.com/gui/file/6d3ab9e729bb03ae8ae3fcd824474c5052a165de6cb4c27334969a542c7b261d/detection",
                "https://www.trendmicro.com/en_us/research/23/e/void-rabisu-s-use-of-romcom-backdoor-shows-a-growing-shift-in-th.html"
            ],
            "status": "test",
            "tags": [
                "attack.persistence",
                "attack.t1546.015"
            ],
            "title": "Potential PSFactoryBuffer COM Hijacking"
        },
        {
            "author": "Nasreddine Bencherchali (Nextron Systems)",
            "date": "2024/07/16",
            "description": "Detects potential COM object hijacking via modification of default system CLSID.",
            "detection": {
                "condition": "all of selection_*",
                "selection_builtin_clsid": {
                    "TargetObject|contains": [
                        "\\{ddc05a5a-351a-4e06-8eaf-54ec1bc2dcea}\\",
                        "\\{1f486a52-3cb1-48fd-8f50-b8dc300d9f9d}\\",
                        "\\{4590f811-1d3a-11d0-891f-00aa004b2e24}\\",
                        "\\{4de225bf-cf59-4cfc-85f7-68b90f185355}\\",
                        "\\{F56F6FDD-AA9D-4618-A949-C1B91AF43B1A}\\"
                    ]
                },
                "selection_locations": {
                    "Details|contains": [
                        "\\AppData\\Local\\Temp\\",
                        "\\Desktop\\",
                        "\\Downloads\\",
                        "\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\",
                        "\\System32\\spool\\drivers\\color\\",
                        "\\Users\\Public\\",
                        "\\Windows\\Temp\\",
                        "%appdata%",
                        "%temp%",
                        "%tmp%"
                    ]
                },
                "selection_target": {
                    "TargetObject|contains": "\\CLSID\\",
                    "TargetObject|endswith": [
                        "\\InprocServer32\\(Default)",
                        "\\LocalServer32\\(Default)"
                    ]
                }
            },
            "falsepositives": [
                "Unlikely"
            ],
            "id": "790317c0-0a36-4a6a-a105-6e576bf99a14",
            "level": "high",
            "logsource": {
                "category": "registry_set",
                "product": "windows"
            },
            "references": [
                "https://www.microsoft.com/security/blog/2022/07/27/untangling-knotweed-european-private-sector-offensive-actor-using-0-day-exploits/ (idea)"
            ],
            "status": "experimental",
            "title": "COM Object Hijacking Via Modification Of Default System CLSID Default Value",
            "tags": [
                "attack.persistence",
                "attack.t1546.015"
            ]
        },
        {
            "author": "frack113",
            "date": "2022/08/28",
            "description": "Detect modification of TreatAs key to enable \"rundll32.exe -sta\" command",
            "detection": {
                "condition": "selection and not 1 of filter_*",
                "filter_misexec": {
                    "Image": [
                        "C:\\Windows\\system32\\msiexec.exe",
                        "C:\\Windows\\SysWOW64\\msiexec.exe"
                    ]
                },
                "filter_office": {
                    "Image|endswith": "\\OfficeClickToRun.exe",
                    "Image|startswith": "C:\\Program Files\\Common Files\\Microsoft Shared\\ClickToRun\\"
                },
                "filter_office2": {
                    "Image": "C:\\Program Files (x86)\\Microsoft Office\\root\\integration\\integrator.exe"
                },
                "filter_svchost": {
                    "Image": "C:\\Windows\\system32\\svchost.exe"
                },
                "selection": {
                    "TargetObject|endswith": "TreatAs\\(Default)"
                }
            },
            "falsepositives": [
                "Legitimate use"
            ],
            "id": "dc5c24af-6995-49b2-86eb-a9ff62199e82",
            "level": "medium",
            "logsource": {
                "category": "registry_set",
                "product": "windows"
            },
            "modified": "2023/08/17",
            "references": [
                "https://github.com/redcanaryco/atomic-red-team/blob/40b77d63808dd4f4eafb83949805636735a1fd15/atomics/T1546.015/T1546.015.md",
                "https://www.youtube.com/watch?v=3gz1QmiMhss&t=1251s"
            ],
            "status": "test",
            "tags": [
                "attack.persistence",
                "attack.t1546.015"
            ],
            "title": "COM Hijacking via TreatAs"
        },
        {
            "author": "Maxime Thiebaut (@0xThiebaut), oscd.community, C\u00e9dric Hien",
            "date": "2020/04/14",
            "description": "Detects potential COM object hijacking leveraging the COM Search Order",
            "detection": {
                "condition": "selection and not 1 of filter_main_*",
                "filter_main_bonjourlib": {
                    "Details|endswith": [
                        ":\\Windows\\system32\\dnssdX.dll",
                        ":\\Windows\\SysWOW64\\dnssdX.dll"
                    ]
                },
                "filter_main_defender": {
                    "Image|contains": [
                        ":\\ProgramData\\Microsoft\\Windows Defender\\Platform\\",
                        ":\\Program Files\\Windows Defender\\"
                    ],
                    "Image|endswith": "\\MsMpEng.exe"
                },
                "filter_main_dropbox": {
                    "Details|contains|all": [
                        "\\AppData\\Roaming\\Dropbox\\",
                        "\\DropboxExt64.*.dll"
                    ]
                },
                "filter_main_dx": {
                    "Image|endswith": ":\\WINDOWS\\SYSTEM32\\dxdiag.exe"
                },
                "filter_main_edge": {
                    "Image|endswith": "\\MicrosoftEdgeUpdateComRegisterShell64.exe"
                },
                "filter_main_gameservice": {
                    "Details|contains": ":\\WINDOWS\\system32\\GamingServicesProxy.dll"
                },
                "filter_main_generic": {
                    "Details|contains": [
                        "%%systemroot%%\\system32\\",
                        "%%systemroot%%\\SysWow64\\"
                    ]
                },
                "filter_main_health_service": {
                    "Image|endswith": ":\\WINDOWS\\system32\\SecurityHealthService.exe"
                },
                "filter_main_inprocserver": {
                    "Image|endswith": [
                        ":\\Windows\\System32\\poqexec.exe",
                        ":\\Windows\\System32\\regsvr32.exe"
                    ],
                    "TargetObject|endswith": "\\InProcServer32\\(Default)"
                },
                "filter_main_nvidia": {
                    "Details|contains": "\\FileRepository\\nvmdi.inf"
                },
                "filter_main_onedrive": {
                    "Details|contains": [
                        "\\AppData\\Local\\Microsoft\\OneDrive\\",
                        "\\FileCoAuthLib64.dll",
                        "\\FileSyncShell64.dll",
                        "\\FileSyncApi64.dll"
                    ]
                },
                "filter_main_poqexec": {
                    "Details|contains": ":\\Windows\\System32\\Autopilot.dll",
                    "Image|endswith": ":\\Windows\\System32\\poqexec.exe"
                },
                "filter_main_printextensionmanager": {
                    "Details|endswith": ":\\Windows\\system32\\spool\\drivers\\x64\\3\\PrintConfig.dll"
                },
                "filter_main_programdata": {
                    "Details|contains": ":\\ProgramData\\Microsoft\\"
                },
                "filter_main_programfiles": {
                    "Details|contains": [
                        ":\\Program Files\\",
                        ":\\Program Files (x86)\\"
                    ]
                },
                "filter_main_python": {
                    "Details|endswith": [
                        ":\\Windows\\pyshellext.amd64.dll",
                        ":\\Windows\\pyshellext.dll"
                    ]
                },
                "filter_main_sec_health_svc": {
                    "Details|contains": ":\\Windows\\System32\\SecurityHealth",
                    "Image|endswith": ":\\Windows\\system32\\SecurityHealthService.exe"
                },
                "filter_main_teams": {
                    "Details|contains|all": [
                        "\\AppData\\Local\\Microsoft\\TeamsMeetingAddin\\",
                        "\\Microsoft.Teams.AddinLoader.dll"
                    ]
                },
                "filter_main_trend_micro": {
                    "Details|endswith": "TmopIEPlg.dll"
                },
                "filter_main_update": {
                    "Image|endswith": [
                        ":\\WINDOWS\\system32\\wuauclt.exe",
                        ":\\WINDOWS\\system32\\svchost.exe"
                    ]
                },
                "selection": {
                    "TargetObject|contains": "\\CLSID\\",
                    "TargetObject|endswith": "\\InprocServer32\\(Default)"
                }
            },
            "falsepositives": [
                "Some installed utilities (i.e. OneDrive) may serve new COM objects at user-level"
            ],
            "id": "a0ff33d8-79e4-4cef-b4f3-9dc4133ccd12",
            "level": "medium",
            "logsource": {
                "category": "registry_set",
                "product": "windows"
            },
            "modified": "2023/09/28",
            "status": "experimental",
            "references": [
                "https://www.cyberbit.com/blog/endpoint-security/com-hijacking-windows-overlooked-security-vulnerability/"
            ],
            "tags": [
                "attack.persistence",
                "attack.t1546.015"
            ],
            "title": "Potential Persistence Via COM Search Order Hijacking"
        },
        {
            "author": "frack113",
            "date": "2022/07/27",
            "description": "Detects potential persistence using Appx DebugPath",
            "detection": {
                "condition": "1 of selection_*",
                "selection_debug": {
                    "TargetObject|contains": "Classes\\ActivatableClasses\\Package\\Microsoft.",
                    "TargetObject|endswith": "\\DebugPath"
                },
                "selection_default": {
                    "TargetObject|contains": "\\Software\\Microsoft\\Windows\\CurrentVersion\\PackagedAppXDebug\\Microsoft.",
                    "TargetObject|endswith": "\\(Default)"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "df4dc653-1029-47ba-8231-3c44238cc0ae",
            "level": "medium",
            "logsource": {
                "category": "registry_set",
                "product": "windows"
            },
            "modified": "2023/08/17",
            "references": [
                "https://oddvar.moe/2018/09/06/persistence-using-universal-windows-platform-apps-appx/",
                "https://github.com/rootm0s/WinPwnage"
            ],
            "status": "test",
            "tags": [
                "attack.persistence",
                "attack.t1546.015"
            ],
            "title": "Potential Persistence Using DebugPath"
        },
        {
            "author": "frack113",
            "date": "2022/08/20",
            "description": "Detect use of scrobj.dll as this DLL looks for the ScriptletURL key to get the location of the script to execute",
            "detection": {
                "condition": "selection",
                "selection": {
                    "Details": "C:\\WINDOWS\\system32\\scrobj.dll",
                    "TargetObject|endswith": "InprocServer32\\(Default)"
                }
            },
            "falsepositives": [
                "Legitimate use of the dll."
            ],
            "id": "fe20dda1-6f37-4379-bbe0-a98d400cae90",
            "level": "medium",
            "logsource": {
                "category": "registry_set",
                "product": "windows"
            },
            "modified": "2023/08/17",
            "references": [
                "https://github.com/redcanaryco/atomic-red-team/blob/40b77d63808dd4f4eafb83949805636735a1fd15/atomics/T1546.015/T1546.015.md"
            ],
            "status": "test",
            "tags": [
                "attack.persistence",
                "attack.t1546.015"
            ],
            "title": "Potential Persistence Via Scrobj.dll COM Hijacking"
        }
    ]
}