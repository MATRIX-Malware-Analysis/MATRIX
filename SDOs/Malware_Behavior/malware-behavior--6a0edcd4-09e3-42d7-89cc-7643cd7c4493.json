{
    "type": "malware-behavior",
    "spec_version": "2.1",
    "id": "malware-behavior--6a0edcd4-09e3-42d7-89cc-7643cd7c4493",
    "created": "2024-08-13T14:46:36.971649Z",
    "modified": "2024-08-13T14:46:45.194307Z",
    "name": "Boot or Logon Initialization Scripts: Logon Script (Windows)",
    "description": "Adversaries may use Windows logon scripts automatically executed at logon initialization to establish persistence. Windows allows logon scripts to be run whenever a specific user or group of users log into a system.[1] This is done via adding a path to a script to the HKCU\\Environment\\UserInitMprLogonScript Registry key.[2]Adversaries may use these scripts to maintain persistence on a single system. Depending on the access configuration of the logon scripts, either local credentials or an administrator account may be necessary.",
    "object_marking_refs": [
        "marking-definition--613f2e26-407d-48c7-9eca-b8e91df99dc9"
    ],
    "external_references": [
        {
            "source_name": "MITRE ATT&CK",
            "url": "https://attack.mitre.org/techniques/T1037/001",
            "external_id": "T1037/001"
        }
    ],
    "x_mitre_detection_rules": [
        {
            "author": "Tom Ueltschi (@c_APT_ure)",
            "date": "2019/01/12",
            "description": "Detects the addition of a new LogonScript to the registry value \"UserInitMprLogonScript\" for potential persistence",
            "detection": {
                "condition": "selection",
                "selection": {
                    "CommandLine|contains": "UserInitMprLogonScript"
                }
            },
            "falsepositives": [
                "Legitimate addition of Logon Scripts via the command line by administrators or third party tools"
            ],
            "id": "21d856f9-9281-4ded-9377-51a1a6e2a432",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/06/09",
            "references": [
                "https://cocomelonc.github.io/persistence/2022/12/09/malware-pers-20.html"
            ],
            "related": [
                {
                    "id": "0a98a10c-685d-4ab0-bddc-b6bdd1d48458",
                    "type": "derived"
                }
            ],
            "status": "test",
            "tags": [
                "attack.persistence",
                "attack.t1037.001"
            ],
            "title": "Potential Persistence Via Logon Scripts - CommandLine"
        },
        {
            "id": "0a98a10c-685d-4ab0-bddc-b6bdd1d48458",
            "author": "Tom Ueltschi (@c_APT_ure), Tim Shelton",
            "date": "2019/01/12",
            "description": "Detects uncommon \"userinit.exe\" child processes, which could be a sign of uncommon shells or login scripts used for persistence.",
            "detection": {
                "condition": "selection and not 1 of filter_main_* and not 1 of filter_optional_*",
                "filter_main_explorer": {
                    "Image|endswith": ":\\WINDOWS\\explorer.exe"
                },
                "filter_optional_citrix": {
                    "Image|endswith": [
                        ":\\Program Files (x86)\\Citrix\\HDX\\bin\\cmstart.exe",
                        ":\\Program Files (x86)\\Citrix\\HDX\\bin\\icast.exe",
                        ":\\Program Files (x86)\\Citrix\\System32\\icast.exe",
                        ":\\Program Files\\Citrix\\HDX\\bin\\cmstart.exe",
                        ":\\Program Files\\Citrix\\HDX\\bin\\icast.exe",
                        ":\\Program Files\\Citrix\\System32\\icast.exe"
                    ]
                },
                "filter_optional_image_null": {
                    "Image": null
                },
                "filter_optional_logonscripts": {
                    "CommandLine|contains": [
                        "netlogon.bat",
                        "UsrLogon.cmd"
                    ]
                },
                "filter_optional_proquota": {
                    "Image|endswith": [
                        ":\\Windows\\System32\\proquota.exe",
                        ":\\Windows\\SysWOW64\\proquota.exe"
                    ]
                },
                "filter_optional_windows_core": {
                    "CommandLine": "PowerShell.exe"
                },
                "selection": {
                    "ParentImage|endswith": "\\userinit.exe"
                }
            },
            "falsepositives": [
                "Legitimate logon scripts or custom shells may trigger false positives. Apply additional filters accordingly."
            ],
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/11/14",
            "references": [
                "https://cocomelonc.github.io/persistence/2022/12/09/malware-pers-20.html",
                "https://learn.microsoft.com/en-us/windows-server/administration/server-core/server-core-sconfig#powershell-is-the-default-shell-on-server-core"
            ],
            "related": [
                {
                    "type": "similar",
                    "id": "21d856f9-9281-4ded-9377-51a1a6e2a432"
                }
            ],
            "status": "test",
            "tags": [
                "attack.t1037.001",
                "attack.persistence"
            ],
            "title": "Uncommon Userinit Child Process"
        },
        {
            "author": "Tom Ueltschi (@c_APT_ure)",
            "date": "2019/01/12",
            "description": "Detects creation of \"UserInitMprLogonScript\" registry value which can be used as a persistence method by malicious actors",
            "detection": {
                "condition": "selection",
                "selection": {
                    "EventType": "CreateKey",
                    "TargetObject|contains": "UserInitMprLogonScript"
                }
            },
            "falsepositives": [
                "Investigate the contents of the \"UserInitMprLogonScript\" value to determine of the added script is legitimate"
            ],
            "id": "9ace0707-b560-49b8-b6ca-5148b42f39fb",
            "level": "medium",
            "logsource": {
                "category": "registry_add",
                "product": "windows"
            },
            "modified": "2023/06/09",
            "references": [
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1037.001/T1037.001.md"
            ],
            "status": "test",
            "tags": [
                "attack.t1037.001",
                "attack.persistence",
                "attack.lateral_movement"
            ],
            "title": "Potential Persistence Via Logon Scripts - Registry"
        }
    ]
}