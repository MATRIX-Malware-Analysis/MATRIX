{
    "type": "malware-behavior",
    "spec_version": "2.1",
    "id": "malware-behavior--6e365a94-1238-4afa-8bba-b5c60a9a5358",
    "created": "2024-08-13T14:46:36.886056Z",
    "modified": "2024-08-13T14:46:48.352439Z",
    "name": "Indicator Removal: File Deletion",
    "description": "Adversaries may delete files left behind by the actions of their intrusion activity. Malware, tools, or other non-native files dropped or created on a system by an adversary (ex: Ingress Tool Transfer) may leave traces to indicate to what was done within a network and how. Removal of these files can occur during an intrusion, or as part of a post-intrusion process to minimize the adversary's footprint.There are tools available from the host operating system to perform cleanup, but adversaries may use other tools as well.[1] Examples of built-in Command and Scripting Interpreter functions include del on Windows and rm or unlink on Linux and macOS.",
    "object_marking_refs": [
        "marking-definition--613f2e26-407d-48c7-9eca-b8e91df99dc9"
    ],
    "external_references": [
        {
            "source_name": "MITRE ATT&CK",
            "url": "https://attack.mitre.org/techniques/T1070/004",
            "external_id": "T1070/004"
        }
    ],
    "x_mitre_capa_rules": [
        {
            "rule": {
                "features": [
                    {
                        "and": [
                            {
                                "or": [
                                    {
                                        "match": "get COMSPEC environment variable"
                                    },
                                    {
                                        "string": "cmd.exe"
                                    },
                                    {
                                        "match": "host-interaction/process/create"
                                    }
                                ]
                            },
                            {
                                "or": [
                                    {
                                        "description": "/c del",
                                        "string": "/\\/c\\s*del\\s*/"
                                    },
                                    {
                                        "description": "del \"%s\"",
                                        "string": "/del\\s*\\S/"
                                    }
                                ]
                            },
                            {
                                "optional": [
                                    {
                                        "description": "> nul",
                                        "string": "/\\s*>\\s*nul\\s*/i"
                                    }
                                ]
                            }
                        ]
                    }
                ],
                "meta": {
                    "att&ck": [
                        "Defense Evasion::Indicator Removal::File Deletion [T1070.004]"
                    ],
                    "authors": [
                        "michael.hunhoff@mandiant.com",
                        "@mr-tz"
                    ],
                    "examples": [
                        "Practical Malware Analysis Lab 14-02.exe_:0x401880"
                    ],
                    "mbc": [
                        "Defense Evasion::Self Deletion::COMSPEC Environment Variable [F0007.001]"
                    ],
                    "name": "self delete",
                    "namespace": "anti-analysis/anti-forensic/self-deletion",
                    "scopes": {
                        "dynamic": "thread",
                        "static": "function"
                    }
                }
            }
        },
        {
            "rule": {
                "features": [
                    {
                        "and": [
                            {
                                "count(api(kernel32.SetFileInformationByHandle))": 2
                            },
                            {
                                "or": [
                                    {
                                        "basic block": [
                                            {
                                                "and": [
                                                    {
                                                        "api": "kernel32.SetFileInformationByHandle"
                                                    },
                                                    {
                                                        "optional": [
                                                            {
                                                                "number": "3 = FileRenameInfo"
                                                            }
                                                        ]
                                                    }
                                                ]
                                            }
                                        ]
                                    },
                                    {
                                        "call": [
                                            {
                                                "and": [
                                                    {
                                                        "api": "SetFileInformationByHandle"
                                                    },
                                                    {
                                                        "number": "3 = FileRenameInfo"
                                                    }
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            },
                            {
                                "or": [
                                    {
                                        "basic block": [
                                            {
                                                "and": [
                                                    {
                                                        "api": "kernel32.SetFileInformationByHandle"
                                                    },
                                                    {
                                                        "number": "4 = FileDispositionInfo"
                                                    },
                                                    {
                                                        "number": "1 = TRUE // fDelete.DeleteFile = TRUE;"
                                                    }
                                                ]
                                            }
                                        ]
                                    },
                                    {
                                        "call": [
                                            {
                                                "and": [
                                                    {
                                                        "api": "SetFileInformationByHandle"
                                                    },
                                                    {
                                                        "number": "4 = FileDispositionInfo"
                                                    },
                                                    {
                                                        "number": "1 = TRUE // fDelete.DeleteFile = TRUE;"
                                                    }
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            },
                            {
                                "and": [
                                    {
                                        "count(api(kernel32.CreateFile))": 2
                                    },
                                    {
                                        "number": "0x10000 = DELETE"
                                    }
                                ]
                            }
                        ]
                    }
                ],
                "meta": {
                    "att&ck": [
                        "Defense Evasion::Indicator Removal::File Deletion [T1070.004]"
                    ],
                    "authors": [
                        "daniel.stepanic@elastic.co"
                    ],
                    "examples": [
                        "c2d46d256b8f9490c9599eea11ecef19fde7d4fdd2dea93604cee3cea8e172ac:0x1400019C0",
                        "388021747b85453adff2680c8a0e13e230f4eeada1a1055e3fb8e09800d4fb79:0x180003A24"
                    ],
                    "mbc": [
                        "Defense Evasion::Self Deletion [F0007]"
                    ],
                    "name": "self delete using alternate data streams",
                    "namespace": "anti-analysis/anti-forensic/self-deletion",
                    "scopes": {
                        "dynamic": "thread",
                        "static": "function"
                    },
                    "references": [
                        "https://github.com/LloydLabs/delete-self-poc"
                    ]
                }
            }
        },
        {
            "rule": {
                "features": [
                    {
                        "or": [
                            {
                                "string": "/vssadmin.* delete shadows/i"
                            },
                            {
                                "string": "/vssadmin.* resize shadowstorage/i"
                            },
                            {
                                "string": "/wmic.* shadowcopy delete/i"
                            }
                        ]
                    }
                ],
                "meta": {
                    "att&ck": [
                        "Impact::Inhibit System Recovery [T1490]",
                        "Defense Evasion::Indicator Removal::File Deletion [T1070.004]"
                    ],
                    "authors": [
                        "moritz.raabe@mandiant.com"
                    ],
                    "examples": [
                        "B87E9DD18A5533A09D3E48A7A1EFBCF6:0x140006AF0"
                    ],
                    "mbc": [
                        "Impact::Data Destruction::Delete Shadow Copies [E1485.m04]"
                    ],
                    "name": "delete volume shadow copies",
                    "namespace": "impact/inhibit-system-recovery",
                    "scopes": {
                        "dynamic": "thread",
                        "static": "function"
                    }
                }
            }
        }
    ],
    "x_mitre_detection_rules": [
        {
            "author": "Austin Clark",
            "date": "2019/08/12",
            "description": "See what files are being deleted from flash file systems",
            "detection": {
                "condition": "keywords",
                "keywords": [
                    "erase",
                    "delete",
                    "format"
                ]
            },
            "falsepositives": [
                "Will be used sometimes by admins to clean up local flash space"
            ],
            "fields": [
                "CmdSet"
            ],
            "id": "71d65515-c436-43c0-841b-236b1f32c21e",
            "level": "medium",
            "logsource": {
                "product": "cisco",
                "service": "aaa"
            },
            "modified": "2023/01/04",
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.impact",
                "attack.t1070.004",
                "attack.t1561.001",
                "attack.t1561.002"
            ],
            "title": "Cisco File Deletion"
        },
        {
            "author": "frack113",
            "date": "2022/01/16",
            "description": "Detects the deletion of the TeamViewer log files which may indicate an attempt to destroy forensic evidence",
            "detection": {
                "condition": "selection and not filter",
                "filter": {
                    "Image": "C:\\Windows\\system32\\svchost.exe"
                },
                "selection": {
                    "TargetFilename|contains": "\\TeamViewer_",
                    "TargetFilename|endswith": ".log"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "b1decb61-ed83-4339-8e95-53ea51901720",
            "level": "low",
            "logsource": {
                "category": "file_delete",
                "product": "windows"
            },
            "modified": "2023/02/15",
            "references": [
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1070.004/T1070.004.md"
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.t1070.004"
            ],
            "title": "TeamViewer Log File Deleted"
        },
        {
            "author": "Nasreddine Bencherchali (Nextron Systems)",
            "date": "2023/09/04",
            "description": "Detects the deletion of the \"Zone.Identifier\" ADS by an uncommon process. Attackers can leverage this in order to bypass security restrictions that make use of the ADS such as Microsoft Office apps.",
            "detection": {
                "condition": "selection and not 1 of filter_main_* and not 1 of filter_optional_*",
                "filter_main_generic": {
                    "Image": [
                        "C:\\Program Files\\PowerShell\\7-preview\\pwsh.exe",
                        "C:\\Program Files\\PowerShell\\7\\pwsh.exe",
                        "C:\\Windows\\explorer.exe",
                        "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe",
                        "C:\\Windows\\SysWOW64\\explorer.exe",
                        "C:\\Windows\\SysWOW64\\WindowsPowerShell\\v1.0\\powershell.exe"
                    ]
                },
                "filter_optional_browsers_chrome": {
                    "Image": [
                        "C:\\Program Files (x86)\\Google\\Chrome\\Application\\chrome.exe",
                        "C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe"
                    ]
                },
                "filter_optional_browsers_firefox": {
                    "Image": [
                        "C:\\Program Files (x86)\\Mozilla Firefox\\firefox.exe",
                        "C:\\Program Files\\Mozilla Firefox\\firefox.exe"
                    ]
                },
                "selection": {
                    "TargetFilename|endswith": ":Zone.Identifier"
                }
            },
            "falsepositives": [
                "Other third party applications not listed."
            ],
            "id": "3109530e-ab47-4cc6-a953-cac5ebcc93ae",
            "logsource": {
                "category": "file_delete",
                "product": "windows"
            },
            "level": "medium",
            "modified": "2024/04/26",
            "references": [
                "https://securityliterate.com/how-malware-abuses-the-zone-identifier-to-circumvent-detection-and-analysis/",
                "Internal Research"
            ],
            "related": [
                {
                    "id": "7eac0a16-5832-4e81-865f-0268a6d19e4b",
                    "type": "similar"
                }
            ],
            "status": "experimental",
            "tags": [
                "attack.defense_evasion",
                "attack.t1070.004"
            ],
            "title": "ADS Zone.Identifier Deleted By Uncommon Application"
        },
        {
            "author": "Cedric MAURUGEON",
            "date": "2021/09/29",
            "description": "Detects the deletion of a prefetch file which may indicate an attempt to destroy forensic evidence",
            "detection": {
                "condition": "selection and not 1 of filter_main_*",
                "filter_main_svchost": {
                    "Image|endswith": ":\\windows\\system32\\svchost.exe",
                    "User|contains": [
                        "AUTHORI",
                        "AUTORI"
                    ]
                },
                "selection": {
                    "TargetFilename|contains": ":\\Windows\\Prefetch\\",
                    "TargetFilename|endswith": ".pf"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "0a1f9d29-6465-4776-b091-7f43b26e4c89",
            "level": "high",
            "logsource": {
                "category": "file_delete",
                "product": "windows"
            },
            "modified": "2024/01/25",
            "references": [
                "Internal Research",
                "https://www.group-ib.com/blog/hunting-for-ttps-with-prefetch-files/"
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.t1070.004"
            ],
            "title": "Prefetch File Deleted"
        },
        {
            "author": "Roberto Rodriguez (Cyb3rWard0g), OTR (Open Threat Research)",
            "date": "2020/05/02",
            "description": "Detects the deletion of files by the Sysinternals SDelete utility. It looks for the common name pattern used to rename files.",
            "detection": {
                "condition": "selection and not 1 of filter_*",
                "filter_wireshark": {
                    "TargetFilename|endswith": "\\Wireshark\\radius\\dictionary.alcatel-lucent.aaa"
                },
                "selection": {
                    "TargetFilename|endswith": [
                        ".AAA",
                        ".ZZZ"
                    ]
                }
            },
            "falsepositives": [
                "Legitime usage of SDelete"
            ],
            "id": "6ddab845-b1b8-49c2-bbf7-1a11967f64bc",
            "logsource": {
                "category": "file_delete",
                "product": "windows"
            },
            "level": "medium",
            "modified": "2023/02/15",
            "references": [
                "https://github.com/OTRF/detection-hackathon-apt29/issues/9",
                "https://github.com/OTRF/ThreatHunter-Playbook/blob/2d4257f630f4c9770f78d0c1df059f891ffc3fec/docs/evals/apt29/detections/4.B.4_83D62033-105A-4A02-8B75-DAB52D8D51EC.md"
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.t1070.004"
            ],
            "title": "File Deleted Via Sysinternals SDelete"
        },
        {
            "author": "X__Junior (Nextron Systems)",
            "date": "2023/07/18",
            "description": "Detects uncommon and potentially suspicious one-liner command containing both \"ping\" and \"copy\" at the same time, which is usually used by malware.\n",
            "detection": {
                "condition": "all of selection_*",
                "selection_action": {
                    "CommandLine|contains|all": [
                        "ping",
                        "copy "
                    ]
                },
                "selection_cli_1": {
                    "CommandLine|contains|windash": " -n "
                },
                "selection_cli_2": {
                    "CommandLine|contains|windash": " -y "
                },
                "selection_cmd": [
                    {
                        "Image|endswith": "\\cmd.exe"
                    },
                    {
                        "OriginalFileName": "Cmd.Exe"
                    }
                ]
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "ded2b07a-d12f-4284-9b76-653e37b6c8b0",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "level": "medium",
            "modified": "2024/03/06",
            "references": [
                "Internal Research"
            ],
            "status": "experimental",
            "tags": [
                "attack.defense_evasion",
                "attack.t1070.004"
            ],
            "title": "Potentially Suspicious Ping/Copy Command Combination"
        },
        {
            "author": "Ilya Krestinichev",
            "date": "2022/11/03",
            "description": "Detects a method often used by ransomware. Which combines the \"ping\" to wait a couple of seconds and then \"del\" to delete the file in question. Its used to hide the file responsible for the initial infection for example",
            "detection": {
                "condition": "all of selection_*",
                "selection_all": {
                    "CommandLine|contains|all": [
                        "ping",
                        "del "
                    ]
                },
                "selection_count": {
                    "CommandLine|contains|windash": " -n "
                },
                "selection_del_param": {
                    "CommandLine|contains|windash": [
                        " -f ",
                        " -q "
                    ]
                },
                "selection_nul": {
                    "CommandLine|contains": "Nul"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "54786ddc-5b8a-11ed-9b6a-0242ac120002",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2024/03/05",
            "references": [
                "https://blog.sygnia.co/kaseya-ransomware-supply-chain-attack",
                "https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2022/06/23093553/Common-TTPs-of-the-modern-ransomware_low-res.pdf",
                "https://www.acronis.com/en-us/blog/posts/lockbit-ransomware/",
                "https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/blackbyte-exbyte-ransomware"
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.t1070.004"
            ],
            "title": "Suspicious Ping/Del Command Combination"
        },
        {
            "author": "frack113",
            "date": "2022/01/15",
            "description": "Detects execution of the builtin \"rmdir\" command in order to delete directories.\nAdversaries may delete files left behind by the actions of their intrusion activity.\nMalware, tools, or other non-native files dropped or created on a system by an adversary may leave traces to indicate to what was done within a network and how.\nRemoval of these files can occur during an intrusion, or as part of a post-intrusion process to minimize the adversary's footprint.\n",
            "detection": {
                "condition": "all of selection_*",
                "selection_flags": {
                    "CommandLine|contains": [
                        "/s",
                        "/q"
                    ]
                },
                "selection_img": [
                    {
                        "Image|endswith": "\\cmd.exe"
                    },
                    {
                        "OriginalFileName": "Cmd.Exe"
                    }
                ],
                "selection_rmdir": {
                    "CommandLine|contains": "rmdir"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "41ca393d-538c-408a-ac27-cf1e038be80c",
            "level": "low",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/03/07",
            "references": [
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1070.004/T1070.004.md",
                "https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/erase"
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.t1070.004"
            ],
            "title": "Directory Removal Via Rmdir"
        },
        {
            "author": "frack113",
            "date": "2022/01/15",
            "description": "Detects execution of the builtin \"del\"/\"erase\" commands in order to delete files.\nAdversaries may delete files left behind by the actions of their intrusion activity.\nMalware, tools, or other non-native files dropped or created on a system by an adversary may leave traces to indicate to what was done within a network and how.\nRemoval of these files can occur during an intrusion, or as part of a post-intrusion process to minimize the adversary's footprint.\n",
            "detection": {
                "condition": "all of selection_*",
                "selection_del": {
                    "CommandLine|contains": [
                        "del ",
                        "erase "
                    ]
                },
                "selection_img": [
                    {
                        "Image|endswith": "\\cmd.exe"
                    },
                    {
                        "OriginalFileName": "Cmd.Exe"
                    }
                ],
                "selection_flags": {
                    "CommandLine|contains|windash": [
                        " -f",
                        " -s",
                        " -q"
                    ]
                }
            },
            "falsepositives": [
                "False positives levels will differ Depending on the environment. You can use a combination of ParentImage and other keywords from the CommandLine field to filter legitimate activity"
            ],
            "id": "379fa130-190e-4c3f-b7bc-6c8e834485f3",
            "level": "low",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2024/03/05",
            "references": [
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1070.004/T1070.004.md",
                "https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/erase"
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.t1070.004"
            ],
            "title": "File Deletion Via Del"
        },
        {
            "author": "frack113 , X__Junior (Nextron Systems)",
            "date": "2021/12/02",
            "description": "Detects execution of the \"del\" builtin command to remove files using greedy/wildcard expression. This is often used by malware to delete content of folders that perhaps contains the initial malware infection or to delete evidence.",
            "detection": {
                "condition": "all of selection_*",
                "selection_del": {
                    "CommandLine|contains": [
                        "del ",
                        "erase "
                    ]
                },
                "selection_img": [
                    {
                        "Image|endswith": "\\cmd.exe"
                    },
                    {
                        "OriginalFileName": "Cmd.Exe"
                    }
                ],
                "selection_extensions": {
                    "CommandLine|contains": [
                        "\\\\\\*.au3",
                        "\\\\\\*.dll",
                        "\\\\\\*.exe",
                        "\\\\\\*.js"
                    ]
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "204b17ae-4007-471b-917b-b917b315c5db",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "level": "medium",
            "modified": "2023/09/11",
            "references": [
                "https://www.joesandbox.com/analysis/509330/0/html#1044F3BDBE3BB6F734E357235F4D5898582D",
                "https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/erase"
            ],
            "status": "experimental",
            "tags": [
                "attack.defense_evasion",
                "attack.t1070.004"
            ],
            "title": "Greedy File Deletion Using Del"
        },
        {
            "author": "Florian Roth (Nextron Systems), Tom U. @c_APT_ure (collection)",
            "date": "2017/05/12",
            "description": "Detects backup catalog deletions",
            "detection": {
                "condition": "selection",
                "selection": {
                    "EventID": 524,
                    "Provider_Name": "Microsoft-Windows-Backup"
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "9703792d-fd9a-456d-a672-ff92efe4806a",
            "logsource": {
                "product": "windows",
                "service": "application"
            },
            "level": "medium",
            "modified": "2022/12/25",
            "references": [
                "https://technet.microsoft.com/en-us/library/cc742154(v=ws.11).aspx",
                "https://www.hybrid-analysis.com/sample/ed01ebfbc9eb5bbea545af4d01bf5f1071661840480439c6e5babe8e080e41aa?environmentId=100"
            ],
            "status": "test",
            "tags": [
                "attack.defense_evasion",
                "attack.t1070.004"
            ],
            "title": "Backup Catalog Deleted"
        },
        {
            "author": "Thomas Patzke",
            "date": "2017/06/14",
            "description": "Detects renaming of file while deletion with SDelete tool.",
            "detection": {
                "condition": "selection",
                "selection": {
                    "EventID": [
                        4656,
                        4663,
                        4658
                    ],
                    "ObjectName|endswith": [
                        ".AAA",
                        ".ZZZ"
                    ]
                }
            },
            "falsepositives": [
                "Legitimate usage of SDelete"
            ],
            "id": "39a80702-d7ca-4a83-b776-525b1f86a36d",
            "logsource": {
                "product": "windows",
                "service": "security"
            },
            "level": "medium",
            "modified": "2021/11/27",
            "references": [
                "https://jpcertcc.github.io/ToolAnalysisResultSheet/details/sdelete.htm",
                "https://www.jpcert.or.jp/english/pub/sr/ir_research.html",
                "https://learn.microsoft.com/en-gb/sysinternals/downloads/sdelete"
            ],
            "status": "test",
            "tags": [
                "attack.impact",
                "attack.defense_evasion",
                "attack.t1070.004",
                "attack.t1027.005",
                "attack.t1485",
                "attack.t1553.002",
                "attack.s0195"
            ],
            "title": "Secure Deletion with SDelete"
        },
        {
            "author": "\u00d6mer G\u00fcnal, oscd.community",
            "date": "2020/10/07",
            "description": "Detects file deletion using \"rm\", \"shred\" or \"unlink\" commands which are used often by adversaries to delete files left behind by the actions of their intrusion activity",
            "detection": {
                "condition": "selection",
                "selection": {
                    "Image|endswith": [
                        "/rm",
                        "/shred",
                        "/unlink"
                    ]
                }
            },
            "falsepositives": [
                "Legitimate administration activities"
            ],
            "id": "30aed7b6-d2c1-4eaf-9382-b6bc43e50c57",
            "level": "informational",
            "logsource": {
                "category": "process_creation",
                "product": "linux"
            },
            "modified": "2022/09/15",
            "references": [
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1070.004/T1070.004.md"
            ],
            "status": "stable",
            "tags": [
                "attack.defense_evasion",
                "attack.t1070.004"
            ],
            "title": "File Deletion"
        }
    ]
}