{
    "type": "malware-behavior",
    "spec_version": "2.1",
    "id": "malware-behavior--22d064dd-442c-4fc6-a227-e3908652c99b",
    "created": "2024-08-13T14:46:36.684307Z",
    "modified": "2024-08-13T14:46:48.311904Z",
    "name": "Unsecured Credentials: Private Keys",
    "description": "Adversaries may search for private key certificate files on compromised systems for insecurely stored credentials. Private cryptographic keys and certificates are used for authentication, encryption/decryption, and digital signatures.[1] Common key and certificate file extensions include: .key, .pgp, .gpg, .ppk., .p12, .pem, .pfx, .cer, .p7b, .asc. Adversaries may also look in common key directories, such as ~/.ssh for SSH keys on * nix-based systems or C:\\Users\\(username)\\.ssh\\ on Windows. Adversary tools may also search compromised systems for file extensions relating to cryptographic keys and certificates.[2][3]When a device is registered to Azure AD, a device key and a transport key are generated and used to verify the device\u2019s identity.[4] An adversary with access to the device may be able to export the keys in order to impersonate the device.[5]On network devices, private keys may be exported via Network Device CLI commands such as crypto pki export.[6] Some private keys require a password or passphrase for operation, so an adversary may also use Input Capture for keylogging or attempt to Brute Force the passphrase off-line. These private keys can be used to authenticate to Remote Services like SSH or for use in decrypting other collected files such as email.",
    "object_marking_refs": [
        "marking-definition--613f2e26-407d-48c7-9eca-b8e91df99dc9"
    ],
    "external_references": [
        {
            "source_name": "MITRE ATT&CK",
            "url": "https://attack.mitre.org/techniques/T1552/004",
            "external_id": "T1552/004"
        },
        {
            "source_name": "CAPEC 37",
            "external_id": "malware-behavior--c6dba731-d14c-4661-ae44-a3af1e542b0b"
        },
        {
            "source_name": "CAPEC 474",
            "external_id": "malware-behavior--309915d7-fb65-43a9-b166-8ac73268f8f6"
        },
        {
            "source_name": "CAPEC 485",
            "external_id": "malware-behavior--e4651053-e624-4e97-886b-1b07906a85e8"
        },
        {
            "source_name": "CAPEC 639",
            "external_id": "malware-behavior--efd72166-96bf-49d1-b3c6-934f26b4f578"
        }
    ],
    "x_mitre_capa_rules": [
        {
            "rule": {
                "features": [
                    {
                        "and": [
                            {
                                "match": "host-interaction/file-system/read"
                            },
                            {
                                "or": [
                                    {
                                        "substring": "/.ssh/id_rsa"
                                    }
                                ]
                            }
                        ]
                    }
                ],
                "meta": {
                    "att&ck": [
                        "Credential Access::Unsecured Credentials::Private Keys [T1552.004]"
                    ],
                    "authors": [
                        "joakim@intezer.com"
                    ],
                    "name": "collect ssh keys",
                    "namespace": "collection",
                    "scopes": {
                        "dynamic": "thread",
                        "static": "function"
                    }
                }
            }
        }
    ],
    "x_mitre_detection_rules": [
        {
            "author": "Austin Clark",
            "date": "2019/08/12",
            "description": "Show when private keys are being exported from the device, or when new certificates are installed",
            "detection": {
                "condition": "keywords",
                "keywords": [
                    "crypto pki export",
                    "crypto pki import",
                    "crypto pki trustpoint"
                ]
            },
            "falsepositives": [
                "Not commonly run by administrators. Also whitelist your known good certificates"
            ],
            "id": "1f978c6a-4415-47fb-aca5-736a44d7ca3d",
            "level": "high",
            "logsource": {
                "product": "cisco",
                "service": "aaa"
            },
            "modified": "2023/01/04",
            "references": [
                "https://www.cisco.com/c/en/us/td/docs/ios-xml/ios/security/a1/sec-a1-cr-book/sec-a1-cr-book_chapter_0111.html"
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.defense_evasion",
                "attack.t1553.004",
                "attack.t1552.004"
            ],
            "title": "Cisco Crypto Commands"
        },
        {
            "author": "Nounou Mbeiri, Nasreddine Bencherchali (Nextron Systems)",
            "date": "2024/06/26",
            "description": "Detects file names with specific patterns seen generated and used by tools such as Mimikatz and DSInternals related to exported or stolen DPAPI backup keys and certificates.\n",
            "detection": {
                "condition": "selection",
                "selection": {
                    "TargetFilename|contains": [
                        "ntds_capi_",
                        "ntds_legacy_",
                        "ntds_unknown_"
                    ],
                    "TargetFilename|endswith": [
                        ".cer",
                        ".key",
                        ".pfx",
                        ".pvk"
                    ]
                }
            },
            "falsepositives": [
                "Unlikely"
            ],
            "id": "7892ec59-c5bb-496d-8968-e5d210ca3ac4",
            "level": "high",
            "logsource": {
                "category": "file_event",
                "product": "windows"
            },
            "references": [
                "https://www.dsinternals.com/en/dpapi-backup-key-theft-auditing/",
                "https://github.com/MichaelGrafnetter/DSInternals/blob/39ee8a69bbdc1cfd12c9afdd7513b4788c4895d4/Src/DSInternals.Common/Data/DPAPI/DPAPIBackupKey.cs#L28-L32"
            ],
            "status": "experimental",
            "tags": [
                "attack.t1555",
                "attack.t1552.004"
            ],
            "title": "DPAPI Backup Keys And Certificate Export Activity IOC"
        },
        {
            "author": "Roberto Rodriguez (Cyb3rWard0g), OTR (Open Threat Research)",
            "date": "2020/05/02",
            "description": "A general detection for processes creating PFX files. This could be an indicator of an adversary exporting a local certificate to a PFX file.",
            "detection": {
                "condition": "selection and not 1 of filter_main_*",
                "filter_main_windows_tmp_key": {
                    "TargetFilename|contains|all": [
                        "\\Templates\\Windows\\Windows_TemporaryKey.pfx",
                        "\\CMake\\"
                    ]
                },
                "selection": {
                    "TargetFilename|endswith": ".pfx"
                }
            },
            "falsepositives": [
                "System administrators managing certificates."
            ],
            "id": "dca1b3e8-e043-4ec8-85d7-867f334b5724",
            "level": "medium",
            "logsource": {
                "category": "file_event",
                "product": "windows"
            },
            "modified": "2022/07/07",
            "references": [
                "https://github.com/OTRF/detection-hackathon-apt29/issues/14",
                "https://github.com/OTRF/ThreatHunter-Playbook/blob/2d4257f630f4c9770f78d0c1df059f891ffc3fec/docs/evals/apt29/detections/6.B.1_6392C9F1-D975-4F75-8A70-433DEDD7F622.md"
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1552.004"
            ],
            "title": "Suspicious PFX File Creation"
        },
        {
            "author": "Florian Roth (Nextron Systems)",
            "date": "2021/04/23",
            "description": "Detects a \"Get-Process\" cmdlet and it's aliases on lsass process, which is in almost all cases a sign of malicious activity",
            "detection": {
                "condition": "selection",
                "selection": {
                    "CommandLine|contains": [
                        "Get-Process lsas",
                        "ps lsas",
                        "gps lsas"
                    ]
                }
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "b2815d0d-7481-4bf0-9b6c-a4c48a94b349",
            "level": "high",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/01/05",
            "references": [
                "https://twitter.com/PythonResponder/status/1385064506049630211"
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1552.004"
            ],
            "title": "PowerShell Get-Process LSASS"
        },
        {
            "author": "frack113, Nasreddine Bencherchali (Nextron Systems)",
            "date": "2021/07/20",
            "description": "Adversaries may search for private key certificate files on compromised systems for insecurely stored credential",
            "detection": {
                "condition": "selection_ext and (all of selection_cmd_* or all of selection_pwsh_* or selection_findstr)",
                "selection_cmd_cli": {
                    "CommandLine|contains": "dir "
                },
                "selection_cmd_img": [
                    {
                        "Image|endswith": "\\cmd.exe"
                    },
                    {
                        "OriginalFileName": "Cmd.Exe"
                    }
                ],
                "selection_ext": {
                    "CommandLine|contains": [
                        ".key",
                        ".pgp",
                        ".gpg",
                        ".ppk",
                        ".p12",
                        ".pem",
                        ".pfx",
                        ".cer",
                        ".p7b",
                        ".asc"
                    ]
                },
                "selection_findstr": [
                    {
                        "Image|endswith": "\\findstr.exe"
                    },
                    {
                        "OriginalFileName": "FINDSTR.EXE"
                    }
                ],
                "selection_pwsh_cli": {
                    "CommandLine|contains": "Get-ChildItem "
                },
                "selection_pwsh_img": [
                    {
                        "Image|endswith": [
                            "\\powershell.exe",
                            "\\pwsh.exe"
                        ]
                    },
                    {
                        "OriginalFileName": [
                            "PowerShell.EXE",
                            "pwsh.dll"
                        ]
                    }
                ]
            },
            "falsepositives": [
                "Unknown"
            ],
            "id": "213d6a77-3d55-4ce8-ba74-fcfef741974e",
            "level": "medium",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "modified": "2023/03/06",
            "references": [
                "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1552.004/T1552.004.md"
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1552.004"
            ],
            "title": "Private Keys Reconnaissance Via CommandLine Tools"
        },
        {
            "author": "Nasreddine Bencherchali (Nextron Systems)",
            "date": "2023/05/18",
            "description": "Detects calls to cmdlets that are used to export certificates from the local certificate store. Threat actors were seen abusing this to steal private keys from compromised machines.",
            "detection": {
                "condition": "selection",
                "selection": {
                    "CommandLine|contains": [
                        "Export-PfxCertificate ",
                        "Export-Certificate "
                    ]
                }
            },
            "falsepositives": [
                "Legitimate certificate exports by administrators. Additional filters might be required."
            ],
            "id": "9e716b33-63b2-46da-86a4-bd3c3b9b5dfb",
            "level": "medium",
            "logsource": {
                "category": "process_creation",
                "product": "windows"
            },
            "references": [
                "https://us-cert.cisa.gov/ncas/analysis-reports/ar21-112a",
                "https://learn.microsoft.com/en-us/powershell/module/pki/export-pfxcertificate?view=windowsserver2022-ps",
                "https://www.splunk.com/en_us/blog/security/breaking-the-chain-defending-against-certificate-services-abuse.html"
            ],
            "related": [
                {
                    "id": "aa7a3fce-bef5-4311-9cc1-5f04bb8c308c",
                    "type": "similar"
                }
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.execution",
                "attack.t1552.004",
                "attack.t1059.001"
            ],
            "title": "Certificate Exported Via PowerShell"
        },
        {
            "id": "aa7a3fce-bef5-4311-9cc1-5f04bb8c308c",
            "author": "Florian Roth (Nextron Systems)",
            "date": "2021/04/23",
            "description": "Detects calls to cmdlets inside of PowerShell scripts that are used to export certificates from the local certificate store. Threat actors were seen abusing this to steal private keys from compromised machines.",
            "detection": {
                "condition": "selection and not 1 of filter_optional_*",
                "filter_optional_module_export": {
                    "ScriptBlockText|contains": "CmdletsToExport = @("
                },
                "selection": {
                    "ScriptBlockText|contains": [
                        "Export-PfxCertificate",
                        "Export-Certificate"
                    ]
                }
            },
            "falsepositives": [
                "Legitimate certificate exports by administrators. Additional filters might be required."
            ],
            "level": "medium",
            "logsource": {
                "category": "ps_script",
                "product": "windows",
                "definition": "Requirements: Script Block Logging must be enabled"
            },
            "references": [
                "https://us-cert.cisa.gov/ncas/analysis-reports/ar21-112a",
                "https://learn.microsoft.com/en-us/powershell/module/pki/export-pfxcertificate?view=windowsserver2022-ps",
                "https://www.splunk.com/en_us/blog/security/breaking-the-chain-defending-against-certificate-services-abuse.html"
            ],
            "modified": "2023/05/18",
            "related": [
                {
                    "type": "similar",
                    "id": "9e716b33-63b2-46da-86a4-bd3c3b9b5dfb"
                }
            ],
            "status": "test",
            "tags": [
                "attack.credential_access",
                "attack.t1552.004"
            ],
            "title": "Certificate Exported Via PowerShell - ScriptBlock"
        }
    ]
}